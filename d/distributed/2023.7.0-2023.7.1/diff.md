# Comparing `tmp/distributed-2023.7.0.tar.gz` & `tmp/distributed-2023.7.1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2023.7.0.tar", last modified: Fri Jul  7 17:35:34 2023, max compression
+gzip compressed data, was "distributed-2023.7.1.tar", last modified: Thu Jul 20 21:06:45 2023, max compression
```

## Comparing `distributed-2023.7.0.tar` & `distributed-2023.7.1.tar`

### file list

```diff
@@ -1,299 +1,299 @@
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.890477 distributed-2023.7.0/
--rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.7.0/AUTHORS.md
--rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.7.0/LICENSE.txt
--rw-r--r--   0 james      (501) staff       (20)      633 2023-06-02 19:58:01.000000 distributed-2023.7.0/MANIFEST.in
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-07-07 17:35:34.889581 distributed-2023.7.0/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.7.0/README.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.892338 distributed-2023.7.0/distributed/
--rw-r--r--   0 james      (501) staff       (20)     4266 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/_signals.py
--rw-r--r--   0 james      (501) staff       (20)     1399 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/_stories.py
--rw-r--r--   0 james      (501) staff       (20)      500 2023-07-07 17:35:34.893739 distributed-2023.7.0/distributed/_version.py
--rw-r--r--   0 james      (501) staff       (20)    29198 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/active_memory_manager.py
--rw-r--r--   0 james      (501) staff       (20)     9576 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/actor.py
--rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/batched.py
--rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/bokeh.py
--rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/cfexecutor.py
--rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/chaos.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.655296 distributed-2023.7.0/distributed/cli/
--rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.7.0/distributed/cli/__init__.py
--rwxr-xr-x   0 james      (501) staff       (20)     7077 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/cli/dask_scheduler.py
--rw-r--r--   0 james      (501) staff       (20)     1269 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/cli/dask_spec.py
--rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 james      (501) staff       (20)    15948 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/cli/dask_worker.py
--rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/cli/utils.py
--rw-r--r--   0 james      (501) staff       (20)   204405 2023-07-07 17:19:56.000000 distributed-2023.7.0/distributed/client.py
--rw-r--r--   0 james      (501) staff       (20)    10960 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     7099 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/collections.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.667735 distributed-2023.7.0/distributed/comm/
--rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/comm/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/comm/addressing.py
--rw-r--r--   0 james      (501) staff       (20)    37259 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/asyncio_tcp.py
--rw-r--r--   0 james      (501) staff       (20)    13918 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/core.py
--rw-r--r--   0 james      (501) staff       (20)    10356 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/inproc.py
--rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.7.0/distributed/comm/registry.py
--rw-r--r--   0 james      (501) staff       (20)    24089 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/tcp.py
--rw-r--r--   0 james      (501) staff       (20)    22997 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/ucx.py
--rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/comm/utils.py
--rw-r--r--   0 james      (501) staff       (20)    14903 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/comm/ws.py
--rw-r--r--   0 james      (501) staff       (20)     7416 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/compatibility.py
--rw-r--r--   0 james      (501) staff       (20)     7357 2023-06-07 19:11:17.000000 distributed-2023.7.0/distributed/config.py
--rw-r--r--   0 james      (501) staff       (20)    59865 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/core.py
--rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/counter.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.676716 distributed-2023.7.0/distributed/dashboard/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.7.0/distributed/dashboard/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.684151 distributed-2023.7.0/distributed/dashboard/components/
--rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/dashboard/components/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.7.0/distributed/dashboard/components/nvml.py
--rw-r--r--   0 james      (501) staff       (20)     7055 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/dashboard/components/rmm.py
--rw-r--r--   0 james      (501) staff       (20)   164091 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/dashboard/components/shared.py
--rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/dashboard/components/worker.py
--rw-r--r--   0 james      (501) staff       (20)     1786 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/dashboard/core.py
--rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.7.0/distributed/dashboard/export_tool.js
--rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/dashboard/export_tool.py
--rw-r--r--   0 james      (501) staff       (20)     5834 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.685435 distributed-2023.7.0/distributed/dashboard/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.7.0/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/dashboard/theme.yaml
--rw-r--r--   0 james      (501) staff       (20)     1732 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/dashboard/utils.py
--rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/dashboard/worker.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.694468 distributed-2023.7.0/distributed/deploy/
--rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/deploy/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/deploy/adaptive.py
--rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/deploy/adaptive_core.py
--rw-r--r--   0 james      (501) staff       (20)    21643 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/deploy/cluster.py
--rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/deploy/local.py
--rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/deploy/old_ssh.py
--rw-r--r--   0 james      (501) staff       (20)    23602 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/deploy/spec.py
--rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.7.0/distributed/deploy/ssh.py
--rw-r--r--   0 james      (501) staff       (20)     7656 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/deploy/subprocess.py
--rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/deploy/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.703253 distributed-2023.7.0/distributed/diagnostics/
--rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diagnostics/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diagnostics/eventstream.py
--rw-r--r--   0 james      (501) staff       (20)     4994 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 james      (501) staff       (20)     6913 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/diagnostics/nvml.py
--rw-r--r--   0 james      (501) staff       (20)    28291 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/diagnostics/plugin.py
--rw-r--r--   0 james      (501) staff       (20)    12565 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/diagnostics/progress.py
--rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.7.0/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 james      (501) staff       (20)    14665 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diagnostics/progressbar.py
--rw-r--r--   0 james      (501) staff       (20)     1124 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/diagnostics/rmm.py
--rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diagnostics/task_stream.py
--rw-r--r--   0 james      (501) staff       (20)     2434 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/diagnostics/websocket.py
--rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/diskutils.py
--rw-r--r--   0 james      (501) staff       (20)    46226 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/distributed-schema.yaml
--rw-r--r--   0 james      (501) staff       (20)    14146 2023-07-07 01:03:22.000000 distributed-2023.7.0/distributed/distributed.yaml
--rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/event.py
--rw-r--r--   0 james      (501) staff       (20)      586 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/exceptions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.706905 distributed-2023.7.0/distributed/http/
--rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/__init__.py
--rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/http/health.py
--rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.7.0/distributed/http/prometheus.py
--rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/proxy.py
--rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/routing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.709819 distributed-2023.7.0/distributed/http/scheduler/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/scheduler/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2899 2023-06-07 19:06:41.000000 distributed-2023.7.0/distributed/http/scheduler/api.py
--rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/scheduler/info.py
--rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/scheduler/json.py
--rw-r--r--   0 james      (501) staff       (20)      625 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.712122 distributed-2023.7.0/distributed/http/scheduler/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.7.0/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:06:41.000000 distributed-2023.7.0/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.713412 distributed-2023.7.0/distributed/http/static/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/http/static/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.721209 distributed-2023.7.0/distributed/http/static/css/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/http/static/css/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/http/static/css/base.css
--rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.7.0/distributed/http/static/css/gpu.css
--rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/http/static/css/status.css
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.734021 distributed-2023.7.0/distributed/http/static/images/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/http/static/images/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/static/images/favicon.ico
--rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/http/static/images/numpy.png
--rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/http/static/images/pandas.png
--rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/http/static/images/python.png
--rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.742921 distributed-2023.7.0/distributed/http/static/js/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/http/static/js/__init__.py
--rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/js/anime.min.js
--rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/statics.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.756312 distributed-2023.7.0/distributed/http/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/http/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/http/templates/base.html
--rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/call-stack.html
--rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/templates/exceptions.html
--rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.7.0/distributed/http/templates/gpu.html
--rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/json-index.html
--rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/logs.html
--rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/main.html
--rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/simple.html
--rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.7.0/distributed/http/templates/status.html
--rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/templates/task.html
--rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/worker-table.html
--rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/templates/worker.html
--rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/templates/workers.html
--rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/http/utils.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.757462 distributed-2023.7.0/distributed/http/worker/
--rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.7.0/distributed/http/worker/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.758816 distributed-2023.7.0/distributed/http/worker/prometheus/
--rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.7.0/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     9973 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 james      (501) staff       (20)     1170 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/itertools.py
--rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/lock.py
--rwxr-xr-x   0 james      (501) staff       (20)    13233 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/metrics.py
--rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/multi_lock.py
--rw-r--r--   0 james      (501) staff       (20)    33721 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/nanny.py
--rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/node.py
--rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/objects.py
--rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/preloading.py
--rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/process.py
--rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/proctitle.py
--rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/profile.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.769094 distributed-2023.7.0/distributed/protocol/
--rw-r--r--   0 james      (501) staff       (20)     3363 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/protocol/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/arrow.py
--rw-r--r--   0 james      (501) staff       (20)     6671 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/protocol/compression.py
--rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/core.py
--rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/cuda.py
--rw-r--r--   0 james      (501) staff       (20)     2931 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/protocol/cupy.py
--rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/h5py.py
--rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/keras.py
--rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/netcdf4.py
--rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/numba.py
--rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/protocol/numpy.py
--rw-r--r--   0 james      (501) staff       (20)     3043 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/protocol/pickle.py
--rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/rmm.py
--rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/scipy.py
--rw-r--r--   0 james      (501) staff       (20)    29121 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/protocol/serialize.py
--rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/protocol/sparse.py
--rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/torch.py
--rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/protocol/utils.py
--rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/publish.py
--rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/pubsub.py
--rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/py.typed
--rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/queues.py
--rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/recreate_tasks.py
--rw-r--r--   0 james      (501) staff       (20)   305478 2023-07-07 01:03:22.000000 distributed-2023.7.0/distributed/scheduler.py
--rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/security.py
--rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/semaphore.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.775639 distributed-2023.7.0/distributed/shuffle/
--rw-r--r--   0 james      (501) staff       (20)      692 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/shuffle/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     3114 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/shuffle/_arrow.py
--rw-r--r--   0 james      (501) staff       (20)     9206 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/shuffle/_buffer.py
--rw-r--r--   0 james      (501) staff       (20)     2526 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/shuffle/_comms.py
--rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/shuffle/_disk.py
--rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/shuffle/_limiter.py
--rw-r--r--   0 james      (501) staff       (20)    12505 2023-06-12 20:29:06.000000 distributed-2023.7.0/distributed/shuffle/_merge.py
--rw-r--r--   0 james      (501) staff       (20)     5594 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/shuffle/_rechunk.py
--rw-r--r--   0 james      (501) staff       (20)    12899 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/shuffle/_scheduler_extension.py
--rw-r--r--   0 james      (501) staff       (20)     8459 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/shuffle/_shuffle.py
--rw-r--r--   0 james      (501) staff       (20)    33639 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/shuffle/_worker_extension.py
--rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/sizeof.py
--rw-r--r--   0 james      (501) staff       (20)    22920 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/spans.py
--rw-r--r--   0 james      (501) staff       (20)    13519 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/spill.py
--rw-r--r--   0 james      (501) staff       (20)    19859 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/stealing.py
--rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.7.0/distributed/system.py
--rw-r--r--   0 james      (501) staff       (20)     8532 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/system_monitor.py
--rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/threadpoolexecutor.py
--rw-r--r--   0 james      (501) staff       (20)    56496 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/utils.py
--rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/utils_comm.py
--rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.7.0/distributed/utils_perf.py
--rw-r--r--   0 james      (501) staff       (20)    80956 2023-06-26 20:17:29.000000 distributed-2023.7.0/distributed/utils_test.py
--rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.7.0/distributed/variable.py
--rw-r--r--   0 james      (501) staff       (20)     5165 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/versions.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.776228 distributed-2023.7.0/distributed/widgets/
--rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/widgets/__init__.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.792354 distributed-2023.7.0/distributed/widgets/templates/
--rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/widgets/templates/__init__.py
--rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.7.0/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1270 2023-06-02 19:58:01.000000 distributed-2023.7.0/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.7.0/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.7.0/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 james      (501) staff       (20)   127037 2023-07-06 15:44:25.000000 distributed-2023.7.0/distributed/worker.py
--rw-r--r--   0 james      (501) staff       (20)     2568 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/worker_client.py
--rw-r--r--   0 james      (501) staff       (20)    21215 2023-06-07 19:29:49.000000 distributed-2023.7.0/distributed/worker_memory.py
--rw-r--r--   0 james      (501) staff       (20)   142673 2023-07-07 17:19:56.000000 distributed-2023.7.0/distributed/worker_state_machine.py
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.649319 distributed-2023.7.0/distributed.egg-info/
--rw-r--r--   0 james      (501) staff       (20)     2832 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/PKG-INFO
--rw-r--r--   0 james      (501) staff       (20)     8682 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 james      (501) staff       (20)      335 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/entry_points.txt
--rw-r--r--   0 james      (501) staff       (20)        1 2023-07-07 17:35:32.000000 distributed-2023.7.0/distributed.egg-info/not-zip-safe
--rw-r--r--   0 james      (501) staff       (20)      227 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/requires.txt
--rw-r--r--   0 james      (501) staff       (20)       12 2023-07-07 17:35:34.000000 distributed-2023.7.0/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.538265 distributed-2023.7.0/docs/
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.881480 distributed-2023.7.0/docs/source/
--rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.7.0/docs/source/active_memory_manager.rst
--rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.7.0/docs/source/actors.rst
--rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/api.rst
--rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.7.0/docs/source/asynchronous.rst
--rw-r--r--   0 james      (501) staff       (20)   261562 2023-07-07 17:28:55.000000 distributed-2023.7.0/docs/source/changelog.rst
--rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.7.0/docs/source/client.rst
--rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.7.0/docs/source/communications.rst
--rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:29:49.000000 distributed-2023.7.0/docs/source/develop.rst
--rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/diagnosing-performance.rst
--rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/efficiency.rst
-drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-07 17:35:34.884744 distributed-2023.7.0/docs/source/examples/
--rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/examples/word-count.rst
--rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.7.0/docs/source/examples-overview.rst
--rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/faq.rst
--rw-r--r--   0 james      (501) staff       (20)     9303 2023-07-06 15:44:25.000000 distributed-2023.7.0/docs/source/fine-performance-metrics.rst
--rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/foundations.rst
--rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/http_services.rst
--rw-r--r--   0 james      (501) staff       (20)     4460 2023-07-06 15:44:25.000000 distributed-2023.7.0/docs/source/index.rst
--rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.7.0/docs/source/install.rst
--rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.7.0/docs/source/journey.rst
--rw-r--r--   0 james      (501) staff       (20)     6470 2023-06-02 19:58:01.000000 distributed-2023.7.0/docs/source/killed.rst
--rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/limitations.rst
--rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/locality.rst
--rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.7.0/docs/source/logging.rst
--rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.7.0/docs/source/manage-computation.rst
--rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/memory.rst
--rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.7.0/docs/source/plugins.rst
--rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.7.0/docs/source/priority.rst
--rw-r--r--   0 james      (501) staff       (20)     7481 2023-06-07 19:06:41.000000 distributed-2023.7.0/docs/source/prometheus.rst
--rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/protocol.rst
--rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.7.0/docs/source/publish.rst
--rw-r--r--   0 james      (501) staff       (20)      402 2023-06-02 19:58:01.000000 distributed-2023.7.0/docs/source/queues.rst
--rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/quickstart.rst
--rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/related-work.rst
--rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/resilience.rst
--rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.7.0/docs/source/resources.rst
--rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.7.0/docs/source/scheduling-policies.rst
--rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.7.0/docs/source/scheduling-state.rst
--rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.7.0/docs/source/serialization.rst
--rw-r--r--   0 james      (501) staff       (20)     4449 2023-07-06 15:44:25.000000 distributed-2023.7.0/docs/source/spans.rst
--rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.7.0/docs/source/task-launch.rst
--rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/tls.rst
--rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.7.0/docs/source/work-stealing.rst
--rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.7.0/docs/source/worker-memory.rst
--rw-r--r--   0 james      (501) staff       (20)    22542 2023-06-02 19:58:01.000000 distributed-2023.7.0/docs/source/worker-state.rst
--rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.7.0/docs/source/worker.rst
--rw-r--r--   0 james      (501) staff       (20)     8950 2023-07-07 17:30:18.000000 distributed-2023.7.0/pyproject.toml
--rw-r--r--   0 james      (501) staff       (20)       38 2023-07-07 17:35:34.890673 distributed-2023.7.0/setup.cfg
--rw-r--r--   0 james      (501) staff       (20)      171 2023-06-02 19:58:01.000000 distributed-2023.7.0/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.311726 distributed-2023.7.1/
+-rw-r--r--   0 james      (501) staff       (20)      104 2020-06-30 15:19:20.000000 distributed-2023.7.1/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2022-10-21 17:45:03.000000 distributed-2023.7.1/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-06-02 19:58:01.000000 distributed-2023.7.1/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-07-20 21:06:45.311070 distributed-2023.7.1/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2022-10-21 17:45:03.000000 distributed-2023.7.1/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.312362 distributed-2023.7.1/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4266 2023-07-06 15:44:25.000000 distributed-2023.7.1/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1297 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1399 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2023-07-20 21:06:45.312489 distributed-2023.7.1/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29198 2023-07-06 15:44:25.000000 distributed-2023.7.1/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)     9576 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7347 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.024479 distributed-2023.7.1/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2020-06-30 15:19:20.000000 distributed-2023.7.1/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7208 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     1400 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    16079 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   204405 2023-07-07 17:19:56.000000 distributed-2023.7.1/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10960 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     7099 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.058791 distributed-2023.7.1/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)     1285 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    37259 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/asyncio_tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    13918 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10356 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2022-11-15 16:22:42.000000 distributed-2023.7.1/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    24089 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    22997 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     4220 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14903 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)    10114 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7319 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    59866 2023-07-12 16:36:21.000000 distributed-2023.7.1/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2146 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.066295 distributed-2023.7.1/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:03.000000 distributed-2023.7.1/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.070816 distributed-2023.7.1/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5818 2022-11-15 18:24:05.000000 distributed-2023.7.1/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7055 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   164091 2023-07-06 15:44:25.000000 distributed-2023.7.1/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19467 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1786 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2021-07-06 20:52:40.000000 distributed-2023.7.1/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5834 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.072029 distributed-2023.7.1/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2022-06-06 20:36:46.000000 distributed-2023.7.1/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1732 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.083535 distributed-2023.7.1/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7802 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21643 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10434 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23602 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2022-11-15 18:24:05.000000 distributed-2023.7.1/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     7656 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.094550 distributed-2023.7.1/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     5207 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     6913 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    28432 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    13932 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2022-11-07 19:30:53.000000 distributed-2023.7.1/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    15800 2023-07-12 16:36:21.000000 distributed-2023.7.1/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2513 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9172 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    46226 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    14162 2023-07-12 16:36:21.000000 distributed-2023.7.1/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.099885 distributed-2023.7.1/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      258 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2022-11-15 18:24:05.000000 distributed-2023.7.1/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4377 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.104178 distributed-2023.7.1/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2899 2023-06-07 19:06:41.000000 distributed-2023.7.1/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     6926 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.112375 distributed-2023.7.1/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2022-11-15 18:24:05.000000 distributed-2023.7.1/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:06:41.000000 distributed-2023.7.1/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.113844 distributed-2023.7.1/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.121658 distributed-2023.7.1/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2021-11-11 21:43:12.000000 distributed-2023.7.1/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.156834 distributed-2023.7.1/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.167901 distributed-2023.7.1/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.197708 distributed-2023.7.1/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2021-11-11 21:43:12.000000 distributed-2023.7.1/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      369 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2022-11-15 16:22:42.000000 distributed-2023.7.1/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5672 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1405 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2024 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.199533 distributed-2023.7.1/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2021-11-11 17:33:04.000000 distributed-2023.7.1/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.200600 distributed-2023.7.1/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2022-11-15 18:24:05.000000 distributed-2023.7.1/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     9973 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1170 2023-06-26 20:17:29.000000 distributed-2023.7.1/distributed/itertools.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    13233 2023-07-06 15:44:25.000000 distributed-2023.7.1/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    33852 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     7513 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16141 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.217247 distributed-2023.7.1/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3363 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     5964 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2931 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     6664 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3043 2023-07-13 14:36:40.000000 distributed-2023.7.1/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      800 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    29121 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     6102 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15652 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10082 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7620 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   306624 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13825 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.228560 distributed-2023.7.1/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      674 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     3078 2023-07-12 16:36:21.000000 distributed-2023.7.1/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9206 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2526 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)     3550 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)     2361 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)    12499 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     9268 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    13716 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/_scheduler_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)     8439 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    33918 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/shuffle/_worker_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)      607 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    22920 2023-07-06 15:44:25.000000 distributed-2023.7.1/distributed/spans.py
+-rw-r--r--   0 james      (501) staff       (20)    13519 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19892 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1883 2022-10-27 14:20:24.000000 distributed-2023.7.1/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8532 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    57536 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    13992 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-04-25 18:34:44.000000 distributed-2023.7.1/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    81020 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8463 2023-05-23 17:15:54.000000 distributed-2023.7.1/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.229881 distributed-2023.7.1/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.250283 distributed-2023.7.1/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2022-11-10 20:28:41.000000 distributed-2023.7.1/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-06-02 19:58:01.000000 distributed-2023.7.1/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2022-10-21 17:45:03.000000 distributed-2023.7.1/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2022-08-08 21:17:38.000000 distributed-2023.7.1/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   127299 2023-07-20 20:42:01.000000 distributed-2023.7.1/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2568 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21215 2023-06-07 19:29:49.000000 distributed-2023.7.1/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   142673 2023-07-07 17:19:56.000000 distributed-2023.7.1/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.020665 distributed-2023.7.1/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     2832 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8676 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2023-07-20 21:06:43.000000 distributed-2023.7.1/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2023-07-20 21:06:44.000000 distributed-2023.7.1/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:44.952576 distributed-2023.7.1/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.307009 distributed-2023.7.1/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2022-10-27 14:20:24.000000 distributed-2023.7.1/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2022-11-15 18:24:05.000000 distributed-2023.7.1/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4113 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2022-11-15 18:24:05.000000 distributed-2023.7.1/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   263272 2023-07-20 20:52:14.000000 distributed-2023.7.1/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7084 2021-11-11 21:43:12.000000 distributed-2023.7.1/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2021-11-11 17:33:04.000000 distributed-2023.7.1/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-06-07 19:29:49.000000 distributed-2023.7.1/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2023-07-20 21:06:45.308662 distributed-2023.7.1/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2020-06-30 15:19:20.000000 distributed-2023.7.1/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     9303 2023-07-06 15:44:25.000000 distributed-2023.7.1/docs/source/fine-performance-metrics.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4460 2023-07-06 15:44:25.000000 distributed-2023.7.1/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2022-08-08 21:17:38.000000 distributed-2023.7.1/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2021-11-11 17:33:04.000000 distributed-2023.7.1/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-06-02 19:58:01.000000 distributed-2023.7.1/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2021-11-11 17:33:04.000000 distributed-2023.7.1/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2021-07-06 20:52:40.000000 distributed-2023.7.1/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4100 2023-02-14 16:13:20.000000 distributed-2023.7.1/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2021-11-11 21:43:12.000000 distributed-2023.7.1/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7481 2023-06-07 19:06:41.000000 distributed-2023.7.1/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2020-12-18 22:54:04.000000 distributed-2023.7.1/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-06-02 19:58:01.000000 distributed-2023.7.1/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     6049 2022-11-15 18:24:05.000000 distributed-2023.7.1/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-04-25 18:34:44.000000 distributed-2023.7.1/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16901 2022-11-15 18:24:05.000000 distributed-2023.7.1/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2021-11-11 17:33:04.000000 distributed-2023.7.1/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     4449 2023-07-06 15:44:25.000000 distributed-2023.7.1/docs/source/spans.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2022-08-08 21:17:38.000000 distributed-2023.7.1/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2021-11-11 17:33:04.000000 distributed-2023.7.1/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-04-25 18:34:44.000000 distributed-2023.7.1/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-06-02 19:58:01.000000 distributed-2023.7.1/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2022-10-21 17:45:03.000000 distributed-2023.7.1/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)     8950 2023-07-20 20:45:51.000000 distributed-2023.7.1/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2023-07-20 21:06:45.311907 distributed-2023.7.1/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-06-02 19:58:01.000000 distributed-2023.7.1/setup.py
```

### Comparing `distributed-2023.7.0/LICENSE.txt` & `distributed-2023.7.1/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/MANIFEST.in` & `distributed-2023.7.1/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/PKG-INFO` & `distributed-2023.7.1/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.7.0
+Version: 2023.7.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.7.0/README.rst` & `distributed-2023.7.1/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/__init__.py` & `distributed-2023.7.1/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/_concurrent_futures_thread.py` & `distributed-2023.7.1/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/_signals.py` & `distributed-2023.7.1/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/_stories.py` & `distributed-2023.7.1/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/active_memory_manager.py` & `distributed-2023.7.1/distributed/active_memory_manager.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/actor.py` & `distributed-2023.7.1/distributed/actor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/batched.py` & `distributed-2023.7.1/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/cfexecutor.py` & `distributed-2023.7.1/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/chaos.py` & `distributed-2023.7.1/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/cli/dask_scheduler.py` & `distributed-2023.7.1/distributed/cli/dask_scheduler.py`

 * *Files 2% similar despite different names*

```diff
@@ -9,14 +9,16 @@
 import sys
 import warnings
 
 import click
 
 from distributed import Scheduler
 from distributed._signals import wait_for_signals
+from distributed.compatibility import asyncio_run
+from distributed.config import get_loop_factory
 from distributed.preloading import validate_preload_argv
 from distributed.proctitle import (
     enable_proctitle_on_children,
     enable_proctitle_on_current,
 )
 
 logger = logging.getLogger("distributed.scheduler")
@@ -242,14 +244,14 @@
             return_when=asyncio.FIRST_COMPLETED,
         )
         # Re-raise exceptions from done tasks
         [task.result() for task in done]
         logger.info("Stopped scheduler at %r", scheduler.address)
 
     try:
-        asyncio.run(run())
+        asyncio_run(run(), loop_factory=get_loop_factory())
     finally:
         logger.info("End scheduler")
 
 
 if __name__ == "__main__":
     main()  # pragma: no cover
```

### Comparing `distributed-2023.7.0/distributed/cli/dask_spec.py` & `distributed-2023.7.1/distributed/cli/dask_spec.py`

 * *Files 17% similar despite different names*

```diff
@@ -3,14 +3,16 @@
 import asyncio
 import json
 import sys
 
 import click
 import yaml
 
+from distributed.compatibility import asyncio_run
+from distributed.config import get_loop_factory
 from distributed.deploy.spec import run_spec
 
 
 @click.command(name="spec", context_settings=dict(ignore_unknown_options=True))
 @click.argument("args", nargs=-1)
 @click.option("--spec", type=str, default="", help="")
 @click.option("--spec-file", type=str, default=None, help="")
@@ -35,12 +37,12 @@
     async def run():
         servers = await run_spec(_spec, *args)
         try:
             await asyncio.gather(*(w.finished() for w in servers.values()))
         except KeyboardInterrupt:
             await asyncio.gather(*(w.close() for w in servers.values()))
 
-    asyncio.run(run())
+    asyncio_run(run(), loop_factory=get_loop_factory())
 
 
 if __name__ == "__main__":
     main()
```

### Comparing `distributed-2023.7.0/distributed/cli/dask_ssh.py` & `distributed-2023.7.1/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/cli/dask_worker.py` & `distributed-2023.7.1/distributed/cli/dask_worker.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,14 +17,16 @@
 
 import dask
 from dask.system import CPU_COUNT
 
 from distributed import Nanny
 from distributed._signals import wait_for_signals
 from distributed.comm import get_address_host_port
+from distributed.compatibility import asyncio_run
+from distributed.config import get_loop_factory
 from distributed.deploy.utils import nprocesses_nthreads
 from distributed.preloading import validate_preload_argv
 from distributed.proctitle import (
     enable_proctitle_on_children,
     enable_proctitle_on_current,
 )
 from distributed.utils import import_term, parse_ports
@@ -439,15 +441,15 @@
             [wait_for_signals_and_close_task, wait_for_nannies_to_finish_task],
             return_when=asyncio.FIRST_COMPLETED,
         )
         # Re-raise exceptions from done tasks
         [task.result() for task in done]
 
     try:
-        asyncio.run(run())
+        asyncio_run(run(), loop_factory=get_loop_factory())
     except (TimeoutError, asyncio.TimeoutError):
         # We already log the exception in nanny / worker. Don't do it again.
         if not signal_fired:
             logger.info("Timed out starting worker")
         sys.exit(1)
     finally:
         logger.info("End worker")
```

### Comparing `distributed-2023.7.0/distributed/cli/utils.py` & `distributed-2023.7.1/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/client.py` & `distributed-2023.7.1/distributed/client.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/cluster_dump.py` & `distributed-2023.7.1/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/collections.py` & `distributed-2023.7.1/distributed/collections.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/__init__.py` & `distributed-2023.7.1/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/addressing.py` & `distributed-2023.7.1/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/asyncio_tcp.py` & `distributed-2023.7.1/distributed/comm/asyncio_tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/core.py` & `distributed-2023.7.1/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/inproc.py` & `distributed-2023.7.1/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/registry.py` & `distributed-2023.7.1/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/tcp.py` & `distributed-2023.7.1/distributed/comm/tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/ucx.py` & `distributed-2023.7.1/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/utils.py` & `distributed-2023.7.1/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/comm/ws.py` & `distributed-2023.7.1/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/compatibility.py` & `distributed-2023.7.1/distributed/compatibility.py`

 * *Files 27% similar despite different names*

```diff
@@ -1,14 +1,16 @@
 from __future__ import annotations
 
 import asyncio
 import logging
 import random
 import sys
 import warnings
+from collections.abc import Callable, Coroutine
+from typing import Any, TypeVar
 
 import tornado
 
 __all__ = ["logging_names", "PeriodicCallback", "to_thread", "randbytes"]
 
 logging_names: dict[str | int, int | str] = {}
 logging_names.update(logging._levelToName)  # type: ignore
@@ -44,15 +46,15 @@
     # License https://github.com/tornadoweb/tornado/blob/v6.2.0/LICENSE
     # Includes minor modifications to source code to pass linting
 
     # This backport ensures that async callbacks are not overlapping if a run
     # takes longer than the interval
     import datetime
     import math
-    from collections.abc import Awaitable, Callable
+    from collections.abc import Awaitable
     from inspect import isawaitable
 
     from tornado.ioloop import IOLoop
     from tornado.log import app_log
 
     class PeriodicCallback:  # type: ignore[no-redef]
         """Schedules the given callback to be called periodically.
@@ -178,7 +180,88 @@
                 # than time.monotonic() (most common on windows), we
                 # effectively experience a small backwards time jump on
                 # every iteration because PeriodicCallback uses
                 # time.time() while asyncio schedules callbacks using
                 # time.monotonic().
                 # https://github.com/tornadoweb/tornado/issues/2333
                 self._next_timeout += callback_time_sec
+
+
+_T = TypeVar("_T")
+
+if sys.version_info >= (3, 12):
+    asyncio_run = asyncio.run
+elif sys.version_info >= (3, 11):
+
+    def asyncio_run(
+        main: Coroutine[Any, Any, _T],
+        *,
+        debug: bool = False,
+        loop_factory: Callable[[], asyncio.AbstractEventLoop] | None = None,
+    ) -> _T:
+        # asyncio.run from Python 3.12
+        # https://docs.python.org/3/license.html#psf-license
+        with asyncio.Runner(debug=debug, loop_factory=loop_factory) as runner:
+            return runner.run(main)
+
+else:
+    # modified version of asyncio.run from Python 3.10 to add loop_factory kwarg
+    # https://docs.python.org/3/license.html#psf-license
+    def asyncio_run(
+        main: Coroutine[Any, Any, _T],
+        *,
+        debug: bool = False,
+        loop_factory: Callable[[], asyncio.AbstractEventLoop] | None = None,
+    ) -> _T:
+        try:
+            asyncio.get_running_loop()
+        except RuntimeError:
+            pass
+        else:
+            raise RuntimeError(
+                "asyncio.run() cannot be called from a running event loop"
+            )
+
+        if not asyncio.iscoroutine(main):
+            raise ValueError(f"a coroutine was expected, got {main!r}")
+
+        if loop_factory is None:
+            loop = asyncio.new_event_loop()
+        else:
+            loop = loop_factory()
+        try:
+            if loop_factory is None:
+                asyncio.set_event_loop(loop)
+            if debug is not None:
+                loop.set_debug(debug)
+            return loop.run_until_complete(main)
+        finally:
+            try:
+                _cancel_all_tasks(loop)
+                loop.run_until_complete(loop.shutdown_asyncgens())
+                loop.run_until_complete(loop.shutdown_default_executor())
+            finally:
+                if loop_factory is None:
+                    asyncio.set_event_loop(None)
+                loop.close()
+
+    def _cancel_all_tasks(loop: asyncio.AbstractEventLoop) -> None:
+        to_cancel = asyncio.all_tasks(loop)
+        if not to_cancel:
+            return
+
+        for task in to_cancel:
+            task.cancel()
+
+        loop.run_until_complete(asyncio.gather(*to_cancel, return_exceptions=True))
+
+        for task in to_cancel:
+            if task.cancelled():
+                continue
+            if task.exception() is not None:
+                loop.call_exception_handler(
+                    {
+                        "message": "unhandled exception during asyncio.run() shutdown",
+                        "exception": task.exception(),
+                        "task": task,
+                    }
+                )
```

### Comparing `distributed-2023.7.0/distributed/config.py` & `distributed-2023.7.1/distributed/config.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 from __future__ import annotations
 
 import asyncio
 import logging.config
 import os
 import sys
+from collections.abc import Callable
 from typing import Any
 
 import yaml
 
 import dask
 from dask.utils import import_required
 
@@ -173,35 +174,34 @@
             # logging module mandates version to be an int
             log_config["version"] = int(log_config["version"])
             _initialize_logging_new_style(config)
         else:
             _initialize_logging_old_style(config)
 
 
-def initialize_event_loop(config: dict[Any, Any]) -> None:
+def get_loop_factory() -> Callable[[], asyncio.AbstractEventLoop] | None:
     event_loop = dask.config.get("distributed.admin.event-loop")
     if event_loop == "uvloop":
         uvloop = import_required(
             "uvloop",
             "The distributed.admin.event-loop configuration value "
             "is set to 'uvloop' but the uvloop module is not installed"
             "\n\n"
             "Please either change the config value or install one of the following\n"
             "    conda install uvloop\n"
             "    pip install uvloop",
         )
-        uvloop.install()
-    elif event_loop in {"asyncio", "tornado"}:
+        return uvloop.new_event_loop
+    if event_loop in {"asyncio", "tornado"}:
         if sys.platform == "win32":
-            # WindowsProactorEventLoopPolicy is not compatible with tornado 6
+            # ProactorEventLoop is not compatible with tornado 6
             # fallback to the pre-3.8 default of Selector
             # https://github.com/tornadoweb/tornado/issues/2608
-            asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
-    else:
-        raise ValueError(
-            "Expected distributed.admin.event-loop to be in ('asyncio', 'tornado', 'uvloop'), got %s"
-            % dask.config.get("distributed.admin.event-loop")
-        )
+            return asyncio.SelectorEventLoop
+        return None
+    raise ValueError(
+        "Expected distributed.admin.event-loop to be in ('asyncio', 'tornado', 'uvloop'), got %s"
+        % dask.config.get("distributed.admin.event-loop")
+    )
 
 
 initialize_logging(dask.config.config)
-initialize_event_loop(dask.config.config)
```

### Comparing `distributed-2023.7.0/distributed/core.py` & `distributed-2023.7.1/distributed/core.py`

 * *Files 0% similar despite different names*

```diff
@@ -1654,15 +1654,15 @@
                 self.semaphore.release()
             comms.clear()
 
     def remove(self, addr: str, *, reason: str = "Address removed.") -> None:
         """
         Remove all Comms to a given address.
         """
-        logger.info("Removing comms to %s", addr)
+        logger.debug("Removing comms to %s", addr)
         if addr in self.available:
             comms = self.available.pop(addr)
             for comm in comms:
                 IOLoop.current().add_callback(comm.close)
                 self.semaphore.release()
         if addr in self.occupied:
             comms = self.occupied.pop(addr)
```

### Comparing `distributed-2023.7.0/distributed/counter.py` & `distributed-2023.7.1/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/__init__.py` & `distributed-2023.7.1/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/nvml.py` & `distributed-2023.7.1/distributed/dashboard/components/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/rmm.py` & `distributed-2023.7.1/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/scheduler.py` & `distributed-2023.7.1/distributed/dashboard/components/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/shared.py` & `distributed-2023.7.1/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/components/worker.py` & `distributed-2023.7.1/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/core.py` & `distributed-2023.7.1/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/export_tool.js` & `distributed-2023.7.1/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/export_tool.py` & `distributed-2023.7.1/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/scheduler.py` & `distributed-2023.7.1/distributed/dashboard/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/utils.py` & `distributed-2023.7.1/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/dashboard/worker.py` & `distributed-2023.7.1/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/adaptive.py` & `distributed-2023.7.1/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/adaptive_core.py` & `distributed-2023.7.1/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/cluster.py` & `distributed-2023.7.1/distributed/deploy/cluster.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/local.py` & `distributed-2023.7.1/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/old_ssh.py` & `distributed-2023.7.1/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/spec.py` & `distributed-2023.7.1/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/ssh.py` & `distributed-2023.7.1/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/subprocess.py` & `distributed-2023.7.1/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/deploy/utils.py` & `distributed-2023.7.1/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/cluster_dump.py` & `distributed-2023.7.1/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/eventstream.py` & `distributed-2023.7.1/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/graph_layout.py` & `distributed-2023.7.1/distributed/diagnostics/graph_layout.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,12 +1,13 @@
 from __future__ import annotations
 
 import uuid
 
 from distributed.diagnostics.plugin import SchedulerPlugin
+from distributed.utils import TupleComparable
 
 
 class GraphLayout(SchedulerPlugin):
     """Dynamic graph layout during computation
 
     This assigns (x, y) locations to all tasks quickly and dynamically as new
     tasks are added.  This scales to a few thousand nodes.
@@ -44,25 +45,31 @@
                 dependencies=dependencies,
                 priority=priority,
             )
 
     def update_graph(
         self, scheduler, *, dependencies=None, priority=None, tasks=None, **kwargs
     ):
-        stack = sorted(tasks, key=lambda k: priority.get(k, 0), reverse=True)
+        stack = sorted(
+            tasks, key=lambda k: TupleComparable(priority.get(k, 0)), reverse=True
+        )
         while stack:
             key = stack.pop()
             if key in self.x or key not in scheduler.tasks:
                 continue
             deps = dependencies.get(key, ())
             if deps:
                 if not all(dep in self.y for dep in deps):
                     stack.append(key)
                     stack.extend(
-                        sorted(deps, key=lambda k: priority.get(k, 0), reverse=True)
+                        sorted(
+                            deps,
+                            key=lambda k: TupleComparable(priority.get(k, 0)),
+                            reverse=True,
+                        )
                     )
                     continue
                 else:
                     total_deps = sum(
                         len(scheduler.tasks[dep].dependents) for dep in deps
                     )
                     y = sum(
```

### Comparing `distributed-2023.7.0/distributed/diagnostics/memory_sampler.py` & `distributed-2023.7.1/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/nvml.py` & `distributed-2023.7.1/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/plugin.py` & `distributed-2023.7.1/distributed/diagnostics/plugin.py`

 * *Files 1% similar despite different names*

```diff
@@ -119,14 +119,15 @@
 
     def transition(
         self,
         key: str,
         start: TaskStateState,
         finish: TaskStateState,
         *args: Any,
+        stimulus_id: str,
         **kwargs: Any,
     ) -> None:
         """Run whenever a task changes state
 
         For a description of the transition mechanism and the available states,
         see :ref:`Scheduler task states <scheduler-task-state>`.
 
@@ -139,14 +140,16 @@
         ----------
         key : string
         start : string
             Start state of the transition.
             One of released, waiting, processing, memory, error.
         finish : string
             Final state of the transition.
+        stimulus_id: string
+            ID of stimulus causing the transition.
         *args, **kwargs :
             More options passed when transitioning
             This may include worker ID, compute time, etc.
         """
 
     def add_worker(self, scheduler: Scheduler, worker: str) -> None | Awaitable[None]:
         """Run when a new worker enters the cluster
@@ -160,15 +163,15 @@
 
             There are no guarantees about the execution order between individual
             ``SchedulerPlugin.add_worker`` hooks and the ordering may be subject
             to change without deprecation cycle.
         """
 
     def remove_worker(
-        self, scheduler: Scheduler, worker: str
+        self, scheduler: Scheduler, worker: str, *, stimulus_id: str, **kwargs: Any
     ) -> None | Awaitable[None]:
         """Run when a worker leaves the cluster
 
         If this method is synchronous, it is immediately and synchronously executed
         without ``Scheduler.remove_worker`` ever yielding to the event loop.
         If it is asynchronous, it will be awaited after all synchronous
         ``SchedulerPlugin.remove_worker`` hooks have executed.
```

### Comparing `distributed-2023.7.0/distributed/diagnostics/progress.py` & `distributed-2023.7.1/distributed/diagnostics/progress.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,11 +1,12 @@
 from __future__ import annotations
 
 import asyncio
 import logging
+import warnings
 from collections import defaultdict
 from timeit import default_timer
 from typing import ClassVar
 
 from tlz import groupby, valmap
 
 from dask.base import tokenize
@@ -99,15 +100,17 @@
 
         if not self.keys:
             self.stop(exception=None, key=None)
 
         logger.debug("Set up Progress keys")
 
         for k in errors:
-            self.transition(k, None, "erred", exception=True)
+            self.transition(
+                k, None, "erred", stimulus_id="progress-setup", exception=True
+            )
 
     def transition(self, key, start, finish, *args, **kwargs):
         if key in self.keys and start == "processing" and finish == "memory":
             logger.debug("Progress sees key %s", key)
             self.keys.remove(key)
 
             if not self.keys:
@@ -136,17 +139,27 @@
             self.status = "finished"
         logger.debug("Remove Progress plugin")
 
 
 class MultiProgress(Progress):
     """Progress variant that keeps track of different groups of keys
 
-    See Progress for most details.  This only adds a function ``func=``
-    that splits keys.  This defaults to ``key_split`` which aligns with naming
-    conventions chosen in the dask project (tuples, hyphens, etc..)
+    See Progress for most details.
+
+    Parameters
+    ----------
+
+    func : Callable (deprecated)
+        Function that splits keys. This defaults to ``key_split`` which
+        aligns with naming conventions chosen in the dask project (tuples,
+        hyphens, etc..)
+
+    group_by : Callable | Literal["spans"] | Literal["prefix"], default: "prefix"
+        How to group keys to display multiple bars. Defaults to "prefix",
+        which uses ``key_split`` from dask project
 
     State
     -----
     keys: dict
         Maps group name to set of not-yet-complete keys for that group
     all_keys: dict
         Maps group name to set of all keys for that group
@@ -157,18 +170,32 @@
     >>> p = MultiProgress(['y-2'], func=split)  # doctest: +SKIP
     >>> p.keys   # doctest: +SKIP
     {'x': {'x-1', 'x-2', 'x-3'},
      'y': {'y-1', 'y-2'}}
     """
 
     def __init__(
-        self, keys, scheduler=None, func=key_split, minimum=0, dt=0.1, complete=False
+        self,
+        keys,
+        scheduler=None,
+        *,
+        func=None,
+        group_by="prefix",
+        minimum=0,
+        dt=0.1,
+        complete=False,
     ):
-        self.func = func
-        name = f"multi-progress-{tokenize(keys, func, minimum, dt, complete)}"
+        if func is not None:
+            warnings.warn(
+                "`func` is deprecated, use `group_by`", category=DeprecationWarning
+            )
+            group_by = func
+        self.group_by = key_split if group_by in (None, "prefix") else group_by
+        self.func = None
+        name = f"multi-progress-{tokenize(keys, group_by, minimum, dt, complete)}"
         super().__init__(
             keys, scheduler, minimum=minimum, dt=dt, complete=complete, name=name
         )
 
     async def setup(self):
         keys = self.keys
 
@@ -187,23 +214,41 @@
             self.keys, _ = dependent_keys(tasks, complete=False)
         self.all_keys.update(keys)
         self.keys |= errors & self.all_keys
 
         if not self.keys:
             self.stop(exception=None, key=None)
 
+        if self.group_by == "spans":
+            spans_ext = self.scheduler.extensions["spans"]
+            span_defs = spans_ext.spans if spans_ext else None
+
+            def group_key(k):
+                span_id = self.scheduler.tasks[k].group.span_id
+                span_name = ", ".join(span_defs[span_id].name) if span_defs else span_id
+                return span_name, span_id
+
+            group_keys = {k: group_key(k) for k in self.all_keys}
+            self.func = group_keys.get
+        elif self.group_by == "prefix":
+            self.func = key_split
+        else:
+            self.func = self.group_by
+
         # Group keys by func name
         self.keys = valmap(set, groupby(self.func, self.keys))
         self.all_keys = valmap(set, groupby(self.func, self.all_keys))
         for k in self.all_keys:
             if k not in self.keys:
                 self.keys[k] = set()
 
         for k in errors:
-            self.transition(k, None, "erred", exception=True)
+            self.transition(
+                k, None, "erred", stimulus_id="multiprogress-setup", exception=True
+            )
         logger.debug("Set up Progress keys")
 
     def transition(self, key, start, finish, *args, **kwargs):
         if start == "processing" and finish == "memory":
             s = self.keys.get(self.func(key), None)
             if s and key in s:
                 s.remove(key)
```

### Comparing `distributed-2023.7.0/distributed/diagnostics/progress_stream.py` & `distributed-2023.7.1/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/progressbar.py` & `distributed-2023.7.1/distributed/diagnostics/progressbar.py`

 * *Files 4% similar despite different names*

```diff
@@ -3,14 +3,15 @@
 import html
 import logging
 import sys
 import warnings
 import weakref
 from contextlib import suppress
 from timeit import default_timer
+from typing import Callable
 
 from tlz import valmap
 from tornado.ioloop import IOLoop
 
 import dask
 from dask.utils import key_split
 
@@ -239,44 +240,60 @@
 
 
 class MultiProgressBar:
     def __init__(
         self,
         keys,
         scheduler=None,
-        func=key_split,
+        *,
+        func=None,
+        group_by="prefix",
         interval="100ms",
         complete=False,
         **kwargs,
     ):
         self.scheduler = get_scheduler(scheduler)
 
         self.client = None
         for key in keys:
             if hasattr(key, "client"):
                 self.client = weakref.ref(key.client)
                 break
 
+        if func is not None:
+            warnings.warn(
+                "`func` is deprecated, use `group_by` instead",
+                category=DeprecationWarning,
+            )
+            group_by = func
+        elif group_by in (None, "prefix"):
+            group_by = key_split
+
         self.keys = {k.key if hasattr(k, "key") else k for k in keys}
-        self.func = func
+        self.group_by = group_by
         self.interval = interval
         self.complete = complete
         self._start_time = default_timer()
 
     @property
     def elapsed(self):
         return default_timer() - self._start_time
 
     async def listen(self):
         complete = self.complete
         keys = self.keys
-        func = self.func
+        group_by = self.group_by
 
         async def setup(scheduler):
-            p = MultiProgress(keys, scheduler, complete=complete, func=func)
+            p = MultiProgress(
+                keys,
+                scheduler,
+                complete=complete,
+                group_by=group_by,
+            )
             await p.setup()
             return p
 
         def function(scheduler, p):
             result = {
                 "all": valmap(len, p.all_keys),
                 "remaining": valmap(len, p.keys),
@@ -335,37 +352,39 @@
     """
 
     def __init__(
         self,
         keys,
         scheduler=None,
         minimum=0,
-        interval=0.1,
-        func=key_split,
-        complete=False,
         **kwargs,
     ):
-        super().__init__(keys, scheduler, func, interval, complete)
+        super().__init__(keys, scheduler, **kwargs)
         from ipywidgets import VBox
 
         self.widget = VBox([])
 
     def make_widget(self, all):
         from ipywidgets import HTML, FloatProgress, HBox, VBox
 
+        def make_label(key):
+            if isinstance(key, tuple):
+                # tuple of (group_name, group_id)
+                key = key[0]
+            key = key.decode() if isinstance(key, bytes) else key
+            return html.escape(key)
+
         self.elapsed_time = HTML("")
         self.bars = {key: FloatProgress(min=0, max=1, description="") for key in all}
         self.bar_texts = {key: HTML("") for key in all}
         self.bar_labels = {
             key: HTML(
                 '<div style="padding: 0px 10px 0px 10px;'
                 " text-align:left; word-wrap: "
-                'break-word;">'
-                + html.escape(key.decode() if isinstance(key, bytes) else key)
-                + "</div>"
+                'break-word;">' + make_label(key) + "</div>"
             )
             for key in all
         }
 
         def keyfunc(kv):
             """Order keys by most numerous, then by string name"""
             return kv[::-1]
@@ -425,15 +444,17 @@
             self.bars[k].value = ndone / ntasks if ntasks else 1.0
             self.bar_texts[k].value = (
                 '<div style="padding: 0px 10px 0px 10px; text-align: right">%d / %d</div>'
                 % (ndone, ntasks)
             )
 
 
-def progress(*futures, notebook=None, multi=True, complete=True, **kwargs):
+def progress(
+    *futures, notebook=None, multi=True, complete=True, group_by="prefix", **kwargs
+):
     """Track progress of futures
 
     This operates differently in the notebook and the console
 
     *  Notebook:  This returns immediately, leaving an IPython widget on screen
     *  Console:  This blocks until the computation completes
 
@@ -444,14 +465,17 @@
     notebook : bool (optional)
         Running in the notebook or not (defaults to guess)
     multi : bool (optional)
         Track different functions independently (defaults to True)
     complete : bool (optional)
         Track all keys (True) or only keys that have not yet run (False)
         (defaults to True)
+    group_by : Callable | Literal["spans"] | Literal["prefix"]
+        Use spans instead of task key names for grouping tasks
+        (defaults to "prefix")
 
     Notes
     -----
     In the notebook, the output of `progress` must be the last statement
     in the cell. Typically, this means calling `progress` at the end of a
     cell.
 
@@ -461,15 +485,24 @@
     [########################################] | 100% Completed |  1.7s
     """
     futures = futures_of(futures)
     if not isinstance(futures, (set, list)):
         futures = [futures]
     if notebook is None:
         notebook = is_kernel()  # often but not always correct assumption
+    if kwargs.get("func", None) is not None:
+        warnings.warn(
+            "`func` is deprecated, use `group_by` instead", category=DeprecationWarning
+        )
+        group_by = kwargs.pop("func")
+    if group_by not in ("spans", "prefix") and not isinstance(group_by, Callable):
+        raise ValueError("`group_by` should be 'spans', 'prefix', or a Callable")
     if notebook:
         if multi:
-            bar = MultiProgressWidget(futures, complete=complete, **kwargs)
+            bar = MultiProgressWidget(
+                futures, complete=complete, group_by=group_by, **kwargs
+            )
         else:
             bar = ProgressWidget(futures, complete=complete, **kwargs)
         return bar
     else:
         TextProgressBar(futures, complete=complete, **kwargs)
```

### Comparing `distributed-2023.7.0/distributed/diagnostics/rmm.py` & `distributed-2023.7.1/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/task_stream.py` & `distributed-2023.7.1/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/diagnostics/websocket.py` & `distributed-2023.7.1/distributed/diagnostics/websocket.py`

 * *Files 12% similar despite different names*

```diff
@@ -44,14 +44,16 @@
         ----------
         key : string
         start : string
             Start state of the transition.
             One of released, waiting, processing, memory, error.
         finish : string
             Final state of the transition.
+        stimulus_id: string
+            ID of stimulus causing the transition.
         *args, **kwargs : More options passed when transitioning
             This may include worker ID, compute time, etc.
         """
         if key not in self.scheduler.tasks:
             return
         kwargs["key"] = key
         startstops = kwargs.get("startstops", [])
```

### Comparing `distributed-2023.7.0/distributed/diskutils.py` & `distributed-2023.7.1/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/distributed-schema.yaml` & `distributed-2023.7.1/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/distributed.yaml` & `distributed-2023.7.1/distributed/distributed.yaml`

 * *Files 0% similar despite different names*

```diff
@@ -277,14 +277,15 @@
         - distributed
         - dask
         - xarray
         - cudf
         - cuml
         - prefect
         - xgboost
+        - coiled
     erred-tasks:
       max-history: 100
 
   ###################
   # Bokeh dashboard #
   ###################
 
@@ -309,13 +310,13 @@
     log-length: 10000  # default length of logs to keep in memory
     log-format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
     pdb-on-err: False       # enter debug mode on scheduling error
     system-monitor:
       interval: 500ms
       disk: true  # Monitor host-wide disk I/O
       host-cpu: false  # Monitor host-wide CPU usage, with very granular breakdown
-      gil: 
+      gil:
         enabled: true  # Monitor GIL contention
         interval: "1ms"  # Frequency to poll GIL
     event-loop: tornado
   rmm:
     pool-size: null
```

### Comparing `distributed-2023.7.0/distributed/event.py` & `distributed-2023.7.1/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/exceptions.py` & `distributed-2023.7.1/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/prometheus.py` & `distributed-2023.7.1/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/proxy.py` & `distributed-2023.7.1/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/routing.py` & `distributed-2023.7.1/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/api.py` & `distributed-2023.7.1/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/info.py` & `distributed-2023.7.1/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/json.py` & `distributed-2023.7.1/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/missing_bokeh.py` & `distributed-2023.7.1/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/prometheus/core.py` & `distributed-2023.7.1/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2023.7.1/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2023.7.1/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/css/base.css` & `distributed-2023.7.1/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/css/individual-cluster-map.css` & `distributed-2023.7.1/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/css/status.css` & `distributed-2023.7.1/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/dask-logo.svg` & `distributed-2023.7.1/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/fa-bars.svg` & `distributed-2023.7.1/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/favicon.ico` & `distributed-2023.7.1/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/jupyter.svg` & `distributed-2023.7.1/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/numpy.png` & `distributed-2023.7.1/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/pandas.png` & `distributed-2023.7.1/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/images/python.png` & `distributed-2023.7.1/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/individual-cluster-map.html` & `distributed-2023.7.1/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/js/anime.min.js` & `distributed-2023.7.1/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/js/individual-cluster-map.js` & `distributed-2023.7.1/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2023.7.1/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/base.html` & `distributed-2023.7.1/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/exceptions.html` & `distributed-2023.7.1/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/status.html` & `distributed-2023.7.1/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/task.html` & `distributed-2023.7.1/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/worker-table.html` & `distributed-2023.7.1/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/templates/worker.html` & `distributed-2023.7.1/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/utils.py` & `distributed-2023.7.1/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/http/worker/prometheus/core.py` & `distributed-2023.7.1/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/itertools.py` & `distributed-2023.7.1/distributed/itertools.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/lock.py` & `distributed-2023.7.1/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/metrics.py` & `distributed-2023.7.1/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/multi_lock.py` & `distributed-2023.7.1/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/nanny.py` & `distributed-2023.7.1/distributed/nanny.py`

 * *Files 0% similar despite different names*

```diff
@@ -24,14 +24,16 @@
 import dask
 from dask.system import CPU_COUNT
 from dask.utils import parse_timedelta
 
 from distributed import preloading
 from distributed.comm import get_address_host
 from distributed.comm.addressing import address_from_user_args
+from distributed.compatibility import asyncio_run
+from distributed.config import get_loop_factory
 from distributed.core import (
     AsyncTaskGroupClosedError,
     CommClosedError,
     ErrorMessage,
     RPCClosed,
     Status,
     coerce_to_address,
@@ -992,15 +994,15 @@
             from dask.multiprocessing import default_initializer
 
             default_initializer()
 
             if silence_logs:
                 logger.setLevel(silence_logs)
 
-            asyncio.run(run())
+            asyncio_run(run(), loop_factory=get_loop_factory())
 
 
 def _get_env_variables(config_key: str) -> dict[str, str]:
     cfg = dask.config.get(config_key)
     if not isinstance(cfg, dict):
         raise TypeError(  # pragma: nocover
             f"{config_key} configuration must be of type dict. Instead got {type(cfg)}"
```

### Comparing `distributed-2023.7.0/distributed/node.py` & `distributed-2023.7.1/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/objects.py` & `distributed-2023.7.1/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/preloading.py` & `distributed-2023.7.1/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/process.py` & `distributed-2023.7.1/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/proctitle.py` & `distributed-2023.7.1/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/profile.py` & `distributed-2023.7.1/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/__init__.py` & `distributed-2023.7.1/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/arrow.py` & `distributed-2023.7.1/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/compression.py` & `distributed-2023.7.1/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/core.py` & `distributed-2023.7.1/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/cuda.py` & `distributed-2023.7.1/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/cupy.py` & `distributed-2023.7.1/distributed/protocol/cupy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/h5py.py` & `distributed-2023.7.1/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/keras.py` & `distributed-2023.7.1/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/netcdf4.py` & `distributed-2023.7.1/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/numba.py` & `distributed-2023.7.1/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/numpy.py` & `distributed-2023.7.1/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/pickle.py` & `distributed-2023.7.1/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/rmm.py` & `distributed-2023.7.1/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/scipy.py` & `distributed-2023.7.1/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/serialize.py` & `distributed-2023.7.1/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/sparse.py` & `distributed-2023.7.1/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/torch.py` & `distributed-2023.7.1/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/protocol/utils.py` & `distributed-2023.7.1/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/publish.py` & `distributed-2023.7.1/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/pubsub.py` & `distributed-2023.7.1/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/queues.py` & `distributed-2023.7.1/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/recreate_tasks.py` & `distributed-2023.7.1/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/scheduler.py` & `distributed-2023.7.1/distributed/scheduler.py`

 * *Files 0% similar despite different names*

```diff
@@ -169,18925 +169,18996 @@
 00000a80: 6974 7920 696d 706f 7274 2053 6563 7572  ity import Secur
 00000a90: 6974 790a 6672 6f6d 2064 6973 7472 6962  ity.from distrib
 00000aa0: 7574 6564 2e73 656d 6170 686f 7265 2069  uted.semaphore i
 00000ab0: 6d70 6f72 7420 5365 6d61 7068 6f72 6545  mport SemaphoreE
 00000ac0: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
 00000ad0: 7374 7269 6275 7465 642e 7368 7566 666c  stributed.shuffl
 00000ae0: 6520 696d 706f 7274 2053 6875 6666 6c65  e import Shuffle
-00000af0: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
-00000b00: 6f6e 0a66 726f 6d20 6469 7374 7269 6275  on.from distribu
-00000b10: 7465 642e 7370 616e 7320 696d 706f 7274  ted.spans import
-00000b20: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
-00000b30: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
-00000b40: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
-00000b50: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
-00000b60: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
-00000b70: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
-00000b80: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
-00000b90: 2020 2020 5469 6d65 6f75 7445 7272 6f72      TimeoutError
-00000ba0: 2c0a 2020 2020 656d 7074 795f 636f 6e74  ,.    empty_cont
-00000bb0: 6578 742c 0a20 2020 2066 6f72 6d61 745f  ext,.    format_
-00000bc0: 6461 7368 626f 6172 645f 6c69 6e6b 2c0a  dashboard_link,.
-00000bd0: 2020 2020 6765 745f 6669 6c65 6e6f 5f6c      get_fileno_l
-00000be0: 696d 6974 2c0a 2020 2020 6b65 795f 7370  imit,.    key_sp
-00000bf0: 6c69 745f 6772 6f75 702c 0a20 2020 206c  lit_group,.    l
-00000c00: 6f67 5f65 7272 6f72 732c 0a20 2020 206e  og_errors,.    n
-00000c10: 6f5f 6465 6661 756c 742c 0a20 2020 2072  o_default,.    r
-00000c20: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
-00000c30: 2c0a 2020 2020 7661 6c69 6461 7465 5f6b  ,.    validate_k
-00000c40: 6579 2c0a 2020 2020 7761 6974 5f66 6f72  ey,.    wait_for
-00000c50: 2c0a 290a 6672 6f6d 2064 6973 7472 6962  ,.).from distrib
-00000c60: 7574 6564 2e75 7469 6c73 5f63 6f6d 6d20  uted.utils_comm 
-00000c70: 696d 706f 7274 2028 0a20 2020 2067 6174  import (.    gat
-00000c80: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
-00000c90: 2c0a 2020 2020 7265 7472 795f 6f70 6572  ,.    retry_oper
-00000ca0: 6174 696f 6e2c 0a20 2020 2073 6361 7474  ation,.    scatt
-00000cb0: 6572 5f74 6f5f 776f 726b 6572 732c 0a20  er_to_workers,. 
-00000cc0: 2020 2075 6e70 6163 6b5f 7265 6d6f 7465     unpack_remote
-00000cd0: 6461 7461 2c0a 290a 6672 6f6d 2064 6973  data,.).from dis
-00000ce0: 7472 6962 7574 6564 2e75 7469 6c73 5f70  tributed.utils_p
-00000cf0: 6572 6620 696d 706f 7274 2064 6973 6162  erf import disab
-00000d00: 6c65 5f67 635f 6469 6167 6e6f 7369 732c  le_gc_diagnosis,
-00000d10: 2065 6e61 626c 655f 6763 5f64 6961 676e   enable_gc_diagn
-00000d20: 6f73 6973 0a66 726f 6d20 6469 7374 7269  osis.from distri
-00000d30: 6275 7465 642e 7661 7269 6162 6c65 2069  buted.variable i
-00000d40: 6d70 6f72 7420 5661 7269 6162 6c65 4578  mport VariableEx
-00000d50: 7465 6e73 696f 6e0a 0a69 6620 5459 5045  tension..if TYPE
-00000d60: 5f43 4845 434b 494e 473a 0a20 2020 2023  _CHECKING:.    #
-00000d70: 2054 4f44 4f20 696d 706f 7274 2066 726f   TODO import fro
-00000d80: 6d20 7479 7069 6e67 2028 7265 7175 6972  m typing (requir
-00000d90: 6573 2050 7974 686f 6e20 3e3d 332e 3130  es Python >=3.10
-00000da0: 290a 2020 2020 6672 6f6d 2074 7970 696e  ).    from typin
-00000db0: 675f 6578 7465 6e73 696f 6e73 2069 6d70  g_extensions imp
-00000dc0: 6f72 7420 5479 7065 416c 6961 730a 0a20  ort TypeAlias.. 
-00000dd0: 2020 2066 726f 6d20 6461 736b 2e68 6967     from dask.hig
-00000de0: 686c 6576 656c 6772 6170 6820 696d 706f  hlevelgraph impo
-00000df0: 7274 2048 6967 684c 6576 656c 4772 6170  rt HighLevelGrap
-00000e00: 680a 0a23 204e 6f74 2074 6f20 6265 2063  h..# Not to be c
-00000e10: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
-00000e20: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-00000e30: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
-00000e40: 736b 5374 6174 6553 7461 7465 0a54 6173  skStateState.Tas
-00000e50: 6b53 7461 7465 5374 6174 653a 2054 7970  kStateState: Typ
-00000e60: 6541 6c69 6173 203d 204c 6974 6572 616c  eAlias = Literal
-00000e70: 5b0a 2020 2020 2272 656c 6561 7365 6422  [.    "released"
-00000e80: 2c0a 2020 2020 2277 6169 7469 6e67 222c  ,.    "waiting",
-00000e90: 0a20 2020 2022 6e6f 2d77 6f72 6b65 7222  .    "no-worker"
-00000ea0: 2c0a 2020 2020 2271 7565 7565 6422 2c0a  ,.    "queued",.
-00000eb0: 2020 2020 2270 726f 6365 7373 696e 6722      "processing"
-00000ec0: 2c0a 2020 2020 226d 656d 6f72 7922 2c0a  ,.    "memory",.
-00000ed0: 2020 2020 2265 7272 6564 222c 0a20 2020      "erred",.   
-00000ee0: 2022 666f 7267 6f74 7465 6e22 2c0a 5d0a   "forgotten",.].
-00000ef0: 0a41 4c4c 5f54 4153 4b5f 5354 4154 4553  .ALL_TASK_STATES
-00000f00: 3a20 5365 745b 5461 736b 5374 6174 6553  : Set[TaskStateS
-00000f10: 7461 7465 5d20 3d20 7365 7428 5461 736b  tate] = set(Task
-00000f20: 5374 6174 6553 7461 7465 2e5f 5f61 7267  StateState.__arg
-00000f30: 735f 5f29 2020 2320 7479 7065 3a20 6967  s__)  # type: ig
-00000f40: 6e6f 7265 0a0a 2320 7b74 6173 6b20 6b65  nore..# {task ke
-00000f50: 7920 2d3e 2066 696e 6973 6820 7374 6174  y -> finish stat
-00000f60: 657d 0a23 204e 6f74 2074 6f20 6265 2063  e}.# Not to be c
-00000f70: 6f6e 6675 7365 6420 7769 7468 2064 6973  onfused with dis
-00000f80: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-00000f90: 7374 6174 655f 6d61 6368 696e 652e 5265  state_machine.Re
-00000fa0: 6373 0a52 6563 733a 2054 7970 6541 6c69  cs.Recs: TypeAli
-00000fb0: 6173 203d 2064 6963 745b 7374 722c 2054  as = dict[str, T
-00000fc0: 6173 6b53 7461 7465 5374 6174 655d 0a23  askStateState].#
-00000fd0: 207b 636c 6965 6e74 206f 7220 776f 726b   {client or work
-00000fe0: 6572 2061 6464 7265 7373 3a20 5b7b 6f70  er address: [{op
-00000ff0: 3a20 3c6b 6579 3e2c 202e 2e2e 7d2c 202e  : <key>, ...}, .
-00001000: 2e2e 5d7d 0a4d 7367 733a 2054 7970 6541  ..]}.Msgs: TypeA
-00001010: 6c69 6173 203d 2064 6963 745b 7374 722c  lias = dict[str,
-00001020: 206c 6973 745b 6469 6374 5b73 7472 2c20   list[dict[str, 
-00001030: 416e 795d 5d5d 0a23 2028 7265 636f 6d6d  Any]]].# (recomm
-00001040: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-00001050: 7420 6d65 7373 6167 6573 2c20 776f 726b  t messages, work
-00001060: 6572 206d 6573 7361 6765 7329 0a52 6563  er messages).Rec
-00001070: 734d 7367 733a 2054 7970 6541 6c69 6173  sMsgs: TypeAlias
-00001080: 203d 2074 7570 6c65 5b52 6563 732c 204d   = tuple[Recs, M
-00001090: 7367 732c 204d 7367 735d 0a0a 6c6f 6767  sgs, Msgs]..logg
-000010a0: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
-000010b0: 4c6f 6767 6572 285f 5f6e 616d 655f 5f29  Logger(__name__)
-000010c0: 0a4c 4f47 5f50 4442 203d 2064 6173 6b2e  .LOG_PDB = dask.
-000010d0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-000010e0: 7269 6275 7465 642e 6164 6d69 6e2e 7064  ributed.admin.pd
-000010f0: 622d 6f6e 2d65 7272 2229 0a44 4546 4155  b-on-err").DEFAU
-00001100: 4c54 5f44 4154 415f 5349 5a45 203d 2070  LT_DATA_SIZE = p
-00001110: 6172 7365 5f62 7974 6573 280a 2020 2020  arse_bytes(.    
-00001120: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-00001130: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-00001140: 6564 756c 6572 2e64 6566 6175 6c74 2d64  eduler.default-d
-00001150: 6174 612d 7369 7a65 2229 0a29 0a53 5449  ata-size").).STI
-00001160: 4d55 4c55 535f 4944 5f55 4e53 4554 203d  MULUS_ID_UNSET =
-00001170: 2022 3c73 7469 6d75 6c75 735f 6964 2075   "<stimulus_id u
-00001180: 6e73 6574 3e22 0a0a 4445 4641 554c 545f  nset>"..DEFAULT_
-00001190: 4558 5445 4e53 494f 4e53 203d 207b 0a20  EXTENSIONS = {. 
-000011a0: 2020 2022 6c6f 636b 7322 3a20 4c6f 636b     "locks": Lock
-000011b0: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
-000011c0: 6d75 6c74 695f 6c6f 636b 7322 3a20 4d75  multi_locks": Mu
-000011d0: 6c74 694c 6f63 6b45 7874 656e 7369 6f6e  ltiLockExtension
-000011e0: 2c0a 2020 2020 2270 7562 6c69 7368 223a  ,.    "publish":
-000011f0: 2050 7562 6c69 7368 4578 7465 6e73 696f   PublishExtensio
-00001200: 6e2c 0a20 2020 2022 7265 706c 6179 2d74  n,.    "replay-t
-00001210: 6173 6b73 223a 2052 6570 6c61 7954 6173  asks": ReplayTas
-00001220: 6b53 6368 6564 756c 6572 2c0a 2020 2020  kScheduler,.    
-00001230: 2271 7565 7565 7322 3a20 5175 6575 6545  "queues": QueueE
-00001240: 7874 656e 7369 6f6e 2c0a 2020 2020 2276  xtension,.    "v
-00001250: 6172 6961 626c 6573 223a 2056 6172 6961  ariables": Varia
-00001260: 626c 6545 7874 656e 7369 6f6e 2c0a 2020  bleExtension,.  
-00001270: 2020 2270 7562 7375 6222 3a20 5075 6253    "pubsub": PubS
-00001280: 7562 5363 6865 6475 6c65 7245 7874 656e  ubSchedulerExten
-00001290: 7369 6f6e 2c0a 2020 2020 2273 656d 6170  sion,.    "semap
-000012a0: 686f 7265 7322 3a20 5365 6d61 7068 6f72  hores": Semaphor
-000012b0: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
-000012c0: 2265 7665 6e74 7322 3a20 4576 656e 7445  "events": EventE
-000012d0: 7874 656e 7369 6f6e 2c0a 2020 2020 2261  xtension,.    "a
-000012e0: 6d6d 223a 2041 6374 6976 654d 656d 6f72  mm": ActiveMemor
-000012f0: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
-00001300: 6e2c 0a20 2020 2022 6d65 6d6f 7279 5f73  n,.    "memory_s
-00001310: 616d 706c 6572 223a 204d 656d 6f72 7953  ampler": MemoryS
-00001320: 616d 706c 6572 4578 7465 6e73 696f 6e2c  amplerExtension,
-00001330: 0a20 2020 2022 7368 7566 666c 6522 3a20  .    "shuffle": 
-00001340: 5368 7566 666c 6553 6368 6564 756c 6572  ShuffleScheduler
-00001350: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
-00001360: 7370 616e 7322 3a20 5370 616e 7353 6368  spans": SpansSch
-00001370: 6564 756c 6572 4578 7465 6e73 696f 6e2c  edulerExtension,
-00001380: 0a20 2020 2022 7374 6561 6c69 6e67 223a  .    "stealing":
-00001390: 2057 6f72 6b53 7465 616c 696e 672c 0a7d   WorkStealing,.}
-000013a0: 0a0a 0a63 6c61 7373 2043 6c69 656e 7453  ...class ClientS
-000013b0: 7461 7465 3a0a 2020 2020 2222 2241 2073  tate:.    """A s
-000013c0: 696d 706c 6520 6f62 6a65 6374 2068 6f6c  imple object hol
-000013d0: 6469 6e67 2069 6e66 6f72 6d61 7469 6f6e  ding information
-000013e0: 2061 626f 7574 2061 2063 6c69 656e 742e   about a client.
-000013f0: 2222 220a 0a20 2020 2023 3a20 4120 756e  """..    #: A un
-00001400: 6971 7565 2069 6465 6e74 6966 6965 7220  ique identifier 
-00001410: 666f 7220 7468 6973 2063 6c69 656e 742e  for this client.
-00001420: 2054 6869 7320 6973 2067 656e 6572 616c   This is general
-00001430: 6c79 2061 6e20 6f70 6171 7565 0a20 2020  ly an opaque.   
-00001440: 2023 3a20 7374 7269 6e67 2067 656e 6572   #: string gener
-00001450: 6174 6564 2062 7920 7468 6520 636c 6965  ated by the clie
-00001460: 6e74 2069 7473 656c 662e 0a20 2020 2063  nt itself..    c
-00001470: 6c69 656e 745f 6b65 793a 2073 7472 0a0a  lient_key: str..
-00001480: 2020 2020 233a 2043 6163 6865 6420 6861      #: Cached ha
-00001490: 7368 206f 6620 3a61 7474 723a 607e 436c  sh of :attr:`~Cl
-000014a0: 6965 6e74 5374 6174 652e 636c 6965 6e74  ientState.client
-000014b0: 5f6b 6579 600a 2020 2020 5f68 6173 683a  _key`.    _hash:
-000014c0: 2069 6e74 0a0a 2020 2020 233a 2041 2073   int..    #: A s
-000014d0: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
-000014e0: 2063 6c69 656e 7420 7761 6e74 7320 746f   client wants to
-000014f0: 2062 6520 6b65 7074 2069 6e20 6d65 6d6f   be kept in memo
-00001500: 7279 2c20 736f 2074 6861 7420 6974 2063  ry, so that it c
-00001510: 616e 2064 6f77 6e6c 6f61 640a 2020 2020  an download.    
-00001520: 233a 2069 7473 2072 6573 756c 7420 7768  #: its result wh
-00001530: 656e 2064 6573 6972 6564 2e20 5468 6973  en desired. This
-00001540: 2069 7320 7468 6520 7265 7665 7273 6520   is the reverse 
-00001550: 6d61 7070 696e 6720 6f66 0a20 2020 2023  mapping of.    #
-00001560: 3a20 3a63 6c61 7373 3a60 5461 736b 5374  : :class:`TaskSt
-00001570: 6174 652e 7768 6f5f 7761 6e74 7360 2e20  ate.who_wants`. 
-00001580: 5461 736b 7320 6172 6520 7479 7069 6361  Tasks are typica
-00001590: 6c6c 7920 7265 6d6f 7665 6420 6672 6f6d  lly removed from
-000015a0: 2074 6869 7320 7365 7420 7768 656e 2074   this set when t
-000015b0: 6865 0a20 2020 2023 3a20 636f 7272 6573  he.    #: corres
-000015c0: 706f 6e64 696e 6720 6f62 6a65 6374 2069  ponding object i
-000015d0: 6e20 7468 6520 636c 6965 6e74 2773 2073  n the client's s
-000015e0: 7061 6365 2028 666f 7220 6578 616d 706c  pace (for exampl
-000015f0: 6520 6120 6060 4675 7475 7265 6060 206f  e a ``Future`` o
-00001600: 7220 6120 4461 736b 0a20 2020 2023 3a20  r a Dask.    #: 
-00001610: 636f 6c6c 6563 7469 6f6e 2920 6765 7473  collection) gets
-00001620: 2067 6172 6261 6765 2d63 6f6c 6c65 6374   garbage-collect
-00001630: 6564 2e0a 2020 2020 7761 6e74 735f 7768  ed..    wants_wh
-00001640: 6174 3a20 7365 745b 5461 736b 5374 6174  at: set[TaskStat
-00001650: 655d 0a0a 2020 2020 233a 2054 6865 206c  e]..    #: The l
-00001660: 6173 7420 7469 6d65 2077 6520 7265 6365  ast time we rece
-00001670: 6976 6564 2061 2068 6561 7274 6265 6174  ived a heartbeat
-00001680: 2066 726f 6d20 7468 6973 2063 6c69 656e   from this clien
-00001690: 742c 2069 6e20 6c6f 6361 6c20 7363 6865  t, in local sche
-000016a0: 6475 6c65 7220 7469 6d65 2e0a 2020 2020  duler time..    
-000016b0: 6c61 7374 5f73 6565 6e3a 2066 6c6f 6174  last_seen: float
-000016c0: 0a0a 2020 2020 233a 204f 7574 7075 7420  ..    #: Output 
-000016d0: 6f66 203a 6675 6e63 3a60 6469 7374 7269  of :func:`distri
-000016e0: 6275 7465 642e 7665 7273 696f 6e73 2e67  buted.versions.g
-000016f0: 6574 5f76 6572 7369 6f6e 7360 206f 6e20  et_versions` on 
-00001700: 7468 6520 636c 6965 6e74 0a20 2020 2076  the client.    v
-00001710: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
-00001720: 722c 2041 6e79 5d0a 0a20 2020 205f 5f73  r, Any]..    __s
-00001730: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-00001740: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-00001750: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00001760: 5f28 7365 6c66 2c20 636c 6965 6e74 3a20  _(self, client: 
-00001770: 7374 722c 202a 2c20 7665 7273 696f 6e73  str, *, versions
-00001780: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-00001790: 207c 204e 6f6e 6520 3d20 4e6f 6e65 293a   | None = None):
-000017a0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-000017b0: 6965 6e74 5f6b 6579 203d 2063 6c69 656e  ient_key = clien
-000017c0: 740a 2020 2020 2020 2020 7365 6c66 2e5f  t.        self._
-000017d0: 6861 7368 203d 2068 6173 6828 636c 6965  hash = hash(clie
-000017e0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
-000017f0: 2e77 616e 7473 5f77 6861 7420 3d20 7365  .wants_what = se
-00001800: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-00001810: 2e6c 6173 745f 7365 656e 203d 2074 696d  .last_seen = tim
-00001820: 6528 290a 2020 2020 2020 2020 7365 6c66  e().        self
-00001830: 2e76 6572 7369 6f6e 7320 3d20 7665 7273  .versions = vers
-00001840: 696f 6e73 206f 7220 7b7d 0a0a 2020 2020  ions or {}..    
-00001850: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
-00001860: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-00001870: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00001880: 6861 7368 0a0a 2020 2020 6465 6620 5f5f  hash..    def __
-00001890: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
-000018a0: 3a20 6f62 6a65 6374 2920 2d3e 2062 6f6f  : object) -> boo
-000018b0: 6c3a 0a20 2020 2020 2020 2069 6620 6e6f  l:.        if no
-000018c0: 7420 6973 696e 7374 616e 6365 286f 7468  t isinstance(oth
-000018d0: 6572 2c20 436c 6965 6e74 5374 6174 6529  er, ClientState)
-000018e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000018f0: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-00001900: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
-00001910: 6c69 656e 745f 6b65 7920 3d3d 206f 7468  lient_key == oth
-00001920: 6572 2e63 6c69 656e 745f 6b65 790a 0a20  er.client_key.. 
-00001930: 2020 2064 6566 205f 5f72 6570 725f 5f28     def __repr__(
-00001940: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00001950: 2020 2020 2020 7265 7475 726e 2066 223c        return f"<
-00001960: 436c 6965 6e74 207b 7365 6c66 2e63 6c69  Client {self.cli
-00001970: 656e 745f 6b65 7921 727d 3e22 0a0a 2020  ent_key!r}>"..  
-00001980: 2020 6465 6620 5f5f 7374 725f 5f28 7365    def __str__(se
-00001990: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-000019a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-000019b0: 636c 6965 6e74 5f6b 6579 0a0a 2020 2020  client_key..    
-000019c0: 6465 6620 5f74 6f5f 6469 6374 5f6e 6f5f  def _to_dict_no_
-000019d0: 6e65 7374 2873 656c 662c 202a 2c20 6578  nest(self, *, ex
-000019e0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
-000019f0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
-00001a00: 6963 743a 0a20 2020 2020 2020 2022 2222  ict:.        """
-00001a10: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
-00001a20: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
-00001a30: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
-00001a40: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
-00001a50: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
-00001a60: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
-00001a70: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
-00001a80: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-00001a90: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-00001aa0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
-00001ab0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
-00001ac0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-00001ad0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
-00001ae0: 6976 655f 746f 5f64 6963 740a 2020 2020  ive_to_dict.    
-00001af0: 2020 2020 5461 736b 5374 6174 652e 5f74      TaskState._t
-00001b00: 6f5f 6469 6374 0a20 2020 2020 2020 2022  o_dict.        "
-00001b10: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00001b20: 6e20 7265 6375 7273 6976 655f 746f 5f64  n recursive_to_d
-00001b30: 6963 7428 0a20 2020 2020 2020 2020 2020  ict(.           
-00001b40: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-00001b50: 2020 2065 7863 6c75 6465 3d73 6574 2865     exclude=set(e
-00001b60: 7863 6c75 6465 2920 7c20 7b22 7665 7273  xclude) | {"vers
-00001b70: 696f 6e73 227d 2c20 2023 2074 7970 653a  ions"},  # type:
-00001b80: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
-00001b90: 2020 2020 6d65 6d62 6572 733d 5472 7565      members=True
-00001ba0: 2c0a 2020 2020 2020 2020 290a 0a0a 636c  ,.        )...cl
-00001bb0: 6173 7320 4d65 6d6f 7279 5374 6174 653a  ass MemoryState:
-00001bc0: 0a20 2020 2022 2222 4d65 6d6f 7279 2072  .    """Memory r
-00001bd0: 6561 6469 6e67 7320 6f6e 2061 2077 6f72  eadings on a wor
-00001be0: 6b65 7220 6f72 206f 6e20 7468 6520 7768  ker or on the wh
-00001bf0: 6f6c 6520 636c 7573 7465 722e 0a0a 2020  ole cluster...  
-00001c00: 2020 5365 6520 3a64 6f63 3a60 776f 726b    See :doc:`work
-00001c10: 6572 2d6d 656d 6f72 7960 2e0a 0a20 2020  er-memory`...   
-00001c20: 2041 7474 7269 6275 7465 7320 2f20 7072   Attributes / pr
-00001c30: 6f70 6572 7469 6573 3a0a 0a20 2020 206d  operties:..    m
-00001c40: 616e 6167 6564 5f74 6f74 616c 0a20 2020  anaged_total.   
-00001c50: 2020 2020 2053 756d 206f 6620 7468 6520       Sum of the 
-00001c60: 6f75 7470 7574 206f 6620 7369 7a65 6f66  output of sizeof
-00001c70: 2829 2066 6f72 2061 6c6c 2064 6173 6b20  () for all dask 
-00001c80: 6b65 7973 2068 656c 6420 6279 2074 6865  keys held by the
-00001c90: 2077 6f72 6b65 7220 696e 206d 656d 6f72   worker in memor
-00001ca0: 792c 0a20 2020 2020 2020 2070 6c75 7320  y,.        plus 
-00001cb0: 6e75 6d62 6572 206f 6620 6279 7465 7320  number of bytes 
-00001cc0: 7370 696c 6c65 6420 746f 2064 6973 6b0a  spilled to disk.
-00001cd0: 0a20 2020 206d 616e 6167 6564 0a20 2020  .    managed.   
-00001ce0: 2020 2020 2053 756d 206f 6620 7468 6520       Sum of the 
-00001cf0: 6f75 7470 7574 206f 6620 7369 7a65 6f66  output of sizeof
-00001d00: 2829 2066 6f72 2074 6865 2064 6173 6b20  () for the dask 
-00001d10: 6b65 7973 2068 656c 6420 696e 2052 414d  keys held in RAM
-00001d20: 2e20 4e6f 7465 2074 6861 7420 7468 6973  . Note that this
-00001d30: 206d 6179 0a20 2020 2020 2020 2062 6520   may.        be 
-00001d40: 696e 6163 6375 7261 7465 2c20 7768 6963  inaccurate, whic
-00001d50: 6820 6d61 7920 6361 7573 6520 696e 6163  h may cause inac
-00001d60: 6375 7261 7465 2075 6e6d 616e 6167 6564  curate unmanaged
-00001d70: 206d 656d 6f72 7920 2873 6565 2062 656c   memory (see bel
-00001d80: 6f77 292e 0a0a 2020 2020 7370 696c 6c65  ow)...    spille
-00001d90: 640a 2020 2020 2020 2020 4e75 6d62 6572  d.        Number
-00001da0: 206f 6620 6279 7465 7320 2066 6f72 2074   of bytes  for t
-00001db0: 6865 2064 6173 6b20 6b65 7973 2073 7069  he dask keys spi
-00001dc0: 6c6c 6564 2074 6f20 7468 6520 6861 7264  lled to the hard
-00001dd0: 2064 7269 7665 2e0a 2020 2020 2020 2020   drive..        
-00001de0: 4e6f 7465 2074 6861 7420 7468 6973 2069  Note that this i
-00001df0: 7320 7468 6520 7369 7a65 206f 6e20 6469  s the size on di
-00001e00: 736b 3b20 7369 7a65 2069 6e20 6d65 6d6f  sk; size in memo
-00001e10: 7279 206d 6179 2062 6520 6469 6666 6572  ry may be differ
-00001e20: 656e 7420 6475 6520 746f 0a20 2020 2020  ent due to.     
-00001e30: 2020 2063 6f6d 7072 6573 7369 6f6e 2061     compression a
-00001e40: 6e64 2069 6e61 6363 7572 6163 6965 7320  nd inaccuracies 
-00001e50: 696e 2073 697a 656f 6628 292e 2049 6e20  in sizeof(). In 
-00001e60: 6f74 6865 7220 776f 7264 732c 2067 6976  other words, giv
-00001e70: 656e 2074 6865 2073 616d 6520 6b65 7973  en the same keys
-00001e80: 2c0a 2020 2020 2020 2020 276d 616e 6167  ,.        'manag
-00001e90: 6564 2720 7769 6c6c 2063 6861 6e67 6520  ed' will change 
-00001ea0: 6465 7065 6e64 696e 6720 6f6e 2074 6865  depending on the
-00001eb0: 206b 6579 7320 6265 696e 6720 696e 206d   keys being in m
-00001ec0: 656d 6f72 7920 6f72 2073 7069 6c6c 6564  emory or spilled
-00001ed0: 2e0a 0a20 2020 2070 726f 6365 7373 0a20  ...    process. 
-00001ee0: 2020 2020 2020 2054 6f74 616c 2052 5353         Total RSS
-00001ef0: 206d 656d 6f72 7920 6d65 6173 7572 6564   memory measured
-00001f00: 2062 7920 7468 6520 4f53 206f 6e20 7468   by the OS on th
-00001f10: 6520 776f 726b 6572 2070 726f 6365 7373  e worker process
-00001f20: 2e0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
-00001f30: 7320 616c 7761 7973 2065 7861 6374 6c79  s always exactly
-00001f40: 2065 7175 616c 2074 6f20 6d61 6e61 6765   equal to manage
-00001f50: 6420 2b20 756e 6d61 6e61 6765 642e 0a0a  d + unmanaged...
-00001f60: 2020 2020 756e 6d61 6e61 6765 640a 2020      unmanaged.  
-00001f70: 2020 2020 2020 7072 6f63 6573 7320 2d20        process - 
-00001f80: 6d61 6e61 6765 642e 2054 6869 7320 6973  managed. This is
-00001f90: 2074 6865 2073 756d 206f 660a 0a20 2020   the sum of..   
-00001fa0: 2020 2020 202d 2050 7974 686f 6e20 696e       - Python in
-00001fb0: 7465 7270 7265 7465 7220 616e 6420 6d6f  terpreter and mo
-00001fc0: 6475 6c65 730a 2020 2020 2020 2020 2d20  dules.        - 
-00001fd0: 676c 6f62 616c 2076 6172 6961 626c 6573  global variables
-00001fe0: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
-00001ff0: 7920 7465 6d70 6f72 6172 696c 7920 616c  y temporarily al
-00002000: 6c6f 6361 7465 6420 6279 2074 6865 2064  located by the d
-00002010: 6173 6b20 7461 736b 7320 7468 6174 2061  ask tasks that a
-00002020: 7265 2063 7572 7265 6e74 6c79 2072 756e  re currently run
-00002030: 6e69 6e67 0a20 2020 2020 2020 202d 206d  ning.        - m
-00002040: 656d 6f72 7920 6672 6167 6d65 6e74 6174  emory fragmentat
-00002050: 696f 6e0a 2020 2020 2020 2020 2d20 6d65  ion.        - me
-00002060: 6d6f 7279 206c 6561 6b73 0a20 2020 2020  mory leaks.     
-00002070: 2020 202d 206d 656d 6f72 7920 6e6f 7420     - memory not 
-00002080: 7965 7420 6761 7262 6167 6520 636f 6c6c  yet garbage coll
-00002090: 6563 7465 640a 2020 2020 2020 2020 2d20  ected.        - 
-000020a0: 6d65 6d6f 7279 206e 6f74 2079 6574 2066  memory not yet f
-000020b0: 7265 6528 2927 6420 6279 2074 6865 2050  ree()'d by the P
-000020c0: 7974 686f 6e20 6d65 6d6f 7279 206d 616e  ython memory man
-000020d0: 6167 6572 2074 6f20 7468 6520 4f53 0a0a  ager to the OS..
-000020e0: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
-000020f0: 640a 2020 2020 2020 2020 4d69 6e69 6d75  d.        Minimu
-00002100: 6d20 6f66 2074 6865 2027 756e 6d61 6e61  m of the 'unmana
-00002110: 6765 6427 206d 6561 7375 7265 7320 6f76  ged' measures ov
-00002120: 6572 2074 6865 206c 6173 740a 2020 2020  er the last.    
-00002130: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
-00002140: 642e 6d65 6d6f 7279 2e72 6563 656e 742d  d.memory.recent-
-00002150: 746f 2d6f 6c64 2d74 696d 6560 6020 7365  to-old-time`` se
-00002160: 636f 6e64 730a 0a20 2020 2075 6e6d 616e  conds..    unman
-00002170: 6167 6564 5f72 6563 656e 740a 2020 2020  aged_recent.    
-00002180: 2020 2020 756e 6d61 6e61 6765 6420 2d20      unmanaged - 
-00002190: 756e 6d61 6e61 6765 645f 6f6c 643b 2069  unmanaged_old; i
-000021a0: 6e20 6f74 6865 7220 776f 7264 7320 7072  n other words pr
-000021b0: 6f63 6573 7320 6d65 6d6f 7279 2074 6861  ocess memory tha
-000021c0: 7420 6861 7320 6265 656e 2072 6563 656e  t has been recen
-000021d0: 746c 790a 2020 2020 2020 2020 616c 6c6f  tly.        allo
-000021e0: 6361 7465 6420 6275 7420 6973 206e 6f74  cated but is not
-000021f0: 2061 6363 6f75 6e74 6564 2066 6f72 2062   accounted for b
-00002200: 7920 6461 736b 3b20 686f 7065 6675 6c6c  y dask; hopefull
-00002210: 7920 6974 2773 206d 6f73 746c 7920 6120  y it's mostly a 
-00002220: 7465 6d70 6f72 6172 790a 2020 2020 2020  temporary.      
-00002230: 2020 7370 696b 652e 0a0a 2020 2020 6f70    spike...    op
-00002240: 7469 6d69 7374 6963 0a20 2020 2020 2020  timistic.       
-00002250: 206d 616e 6167 6564 202b 2075 6e6d 616e   managed + unman
-00002260: 6167 6564 5f6f 6c64 3b20 696e 206f 7468  aged_old; in oth
-00002270: 6572 2077 6f72 6473 2074 6865 206d 656d  er words the mem
-00002280: 6f72 7920 6865 6c64 206c 6f6e 672d 7465  ory held long-te
-00002290: 726d 2062 790a 2020 2020 2020 2020 7468  rm by.        th
-000022a0: 6520 7072 6f63 6573 7320 756e 6465 7220  e process under 
-000022b0: 7468 6520 686f 7065 6675 6c20 6173 7375  the hopeful assu
-000022c0: 6d70 7469 6f6e 2074 6861 7420 616c 6c20  mption that all 
-000022d0: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-000022e0: 206d 656d 6f72 7920 6973 2061 0a20 2020   memory is a.   
-000022f0: 2020 2020 2074 656d 706f 7261 7279 2073       temporary s
-00002300: 7069 6b65 0a20 2020 2022 2222 0a0a 2020  pike.    """..  
-00002310: 2020 7072 6f63 6573 733a 2069 6e74 0a20    process: int. 
-00002320: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
-00002330: 3a20 696e 740a 2020 2020 6d61 6e61 6765  : int.    manage
-00002340: 643a 2069 6e74 0a20 2020 2073 7069 6c6c  d: int.    spill
-00002350: 6564 3a20 696e 740a 0a20 2020 205f 5f73  ed: int..    __s
-00002360: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-00002370: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-00002380: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00002390: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-000023a0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-000023b0: 2020 2020 7072 6f63 6573 733a 2069 6e74      process: int
-000023c0: 2c0a 2020 2020 2020 2020 756e 6d61 6e61  ,.        unmana
-000023d0: 6765 645f 6f6c 643a 2069 6e74 2c0a 2020  ged_old: int,.  
-000023e0: 2020 2020 2020 6d61 6e61 6765 643a 2069        managed: i
-000023f0: 6e74 2c0a 2020 2020 2020 2020 7370 696c  nt,.        spil
-00002400: 6c65 643a 2069 6e74 2c0a 2020 2020 293a  led: int,.    ):
-00002410: 0a20 2020 2020 2020 2023 2053 6f6d 6520  .        # Some 
-00002420: 6461 7461 2061 7272 6976 6573 2077 6974  data arrives wit
-00002430: 6820 7468 6520 6865 6172 7462 6561 742c  h the heartbeat,
-00002440: 2073 6f6d 6520 6f74 6865 7220 6172 7269   some other arri
-00002450: 7665 7320 696e 2072 6561 6c74 696d 6520  ves in realtime 
-00002460: 6173 2074 6865 0a20 2020 2020 2020 2023  as the.        #
-00002470: 2074 6173 6b73 2070 726f 6772 6573 732e   tasks progress.
-00002480: 2041 6c73 6f2c 2073 697a 656f 6628 2920   Also, sizeof() 
-00002490: 6973 206e 6f74 2067 7561 7261 6e74 6565  is not guarantee
-000024a0: 6420 746f 2072 6574 7572 6e20 636f 7272  d to return corr
-000024b0: 6563 7420 7265 7375 6c74 732e 0a20 2020  ect results..   
-000024c0: 2020 2020 2023 2054 6869 7320 6361 6e20       # This can 
-000024d0: 6361 7573 6520 676c 6974 6368 6573 2077  cause glitches w
-000024e0: 6865 7265 2061 2070 6172 7469 616c 206d  here a partial m
-000024f0: 6561 7375 7265 2069 7320 6c61 7267 6572  easure is larger
-00002500: 2074 6861 6e20 7468 6520 7768 6f6c 652c   than the whole,
-00002510: 2073 6f0a 2020 2020 2020 2020 2320 7765   so.        # we
-00002520: 206e 6565 6420 746f 2066 6f72 6365 2061   need to force a
-00002530: 6c6c 206e 756d 6265 7273 2074 6f20 6164  ll numbers to ad
-00002540: 6420 7570 2065 7861 6374 6c79 2062 7920  d up exactly by 
-00002550: 6465 6669 6e69 7469 6f6e 2e0a 2020 2020  definition..    
-00002560: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
-00002570: 203d 2070 726f 6365 7373 0a20 2020 2020   = process.     
-00002580: 2020 2073 656c 662e 6d61 6e61 6765 6420     self.managed 
-00002590: 3d20 6d69 6e28 7365 6c66 2e70 726f 6365  = min(self.proce
-000025a0: 7373 2c20 6d61 6e61 6765 6429 0a20 2020  ss, managed).   
-000025b0: 2020 2020 2073 656c 662e 7370 696c 6c65       self.spille
-000025c0: 6420 3d20 7370 696c 6c65 640a 2020 2020  d = spilled.    
-000025d0: 2020 2020 2320 5375 6274 7261 6374 696f      # Subtractio
-000025e0: 6e73 2062 6574 7765 656e 2075 6e73 6967  ns between unsig
-000025f0: 6e65 6420 696e 7473 2067 7561 7261 6e74  ned ints guarant
-00002600: 6565 6420 6279 2063 6f6e 7374 7275 6374  eed by construct
-00002610: 696f 6e20 746f 2062 6520 3e3d 2030 0a20  ion to be >= 0. 
-00002620: 2020 2020 2020 2073 656c 662e 756e 6d61         self.unma
-00002630: 6e61 6765 645f 6f6c 6420 3d20 6d69 6e28  naged_old = min(
-00002640: 756e 6d61 6e61 6765 645f 6f6c 642c 2070  unmanaged_old, p
-00002650: 726f 6365 7373 202d 2073 656c 662e 6d61  rocess - self.ma
-00002660: 6e61 6765 6429 0a0a 2020 2020 4073 7461  naged)..    @sta
-00002670: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00002680: 6620 7375 6d28 2a69 6e66 6f73 3a20 4d65  f sum(*infos: Me
-00002690: 6d6f 7279 5374 6174 6529 202d 3e20 4d65  moryState) -> Me
-000026a0: 6d6f 7279 5374 6174 653a 0a20 2020 2020  moryState:.     
-000026b0: 2020 2070 726f 6365 7373 203d 2030 0a20     process = 0. 
-000026c0: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-000026d0: 5f6f 6c64 203d 2030 0a20 2020 2020 2020  _old = 0.       
-000026e0: 206d 616e 6167 6564 203d 2030 0a20 2020   managed = 0.   
-000026f0: 2020 2020 2073 7069 6c6c 6564 203d 2030       spilled = 0
-00002700: 0a20 2020 2020 2020 2066 6f72 206d 7320  .        for ms 
-00002710: 696e 2069 6e66 6f73 3a0a 2020 2020 2020  in infos:.      
-00002720: 2020 2020 2020 7072 6f63 6573 7320 2b3d        process +=
-00002730: 206d 732e 7072 6f63 6573 730a 2020 2020   ms.process.    
-00002740: 2020 2020 2020 2020 756e 6d61 6e61 6765          unmanage
-00002750: 645f 6f6c 6420 2b3d 206d 732e 756e 6d61  d_old += ms.unma
-00002760: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
-00002770: 2020 2020 2020 7370 696c 6c65 6420 2b3d        spilled +=
-00002780: 206d 732e 7370 696c 6c65 640a 2020 2020   ms.spilled.    
-00002790: 2020 2020 2020 2020 6d61 6e61 6765 6420          managed 
-000027a0: 2b3d 206d 732e 6d61 6e61 6765 640a 2020  += ms.managed.  
-000027b0: 2020 2020 2020 7265 7475 726e 204d 656d        return Mem
-000027c0: 6f72 7953 7461 7465 280a 2020 2020 2020  oryState(.      
-000027d0: 2020 2020 2020 7072 6f63 6573 733d 7072        process=pr
-000027e0: 6f63 6573 732c 0a20 2020 2020 2020 2020  ocess,.         
-000027f0: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
-00002800: 3d75 6e6d 616e 6167 6564 5f6f 6c64 2c0a  =unmanaged_old,.
-00002810: 2020 2020 2020 2020 2020 2020 6d61 6e61              mana
-00002820: 6765 643d 6d61 6e61 6765 642c 0a20 2020  ged=managed,.   
-00002830: 2020 2020 2020 2020 2073 7069 6c6c 6564           spilled
-00002840: 3d73 7069 6c6c 6564 2c0a 2020 2020 2020  =spilled,.      
-00002850: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
-00002860: 7479 0a20 2020 2064 6566 206d 616e 6167  ty.    def manag
-00002870: 6564 5f74 6f74 616c 2873 656c 6629 202d  ed_total(self) -
-00002880: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
-00002890: 6574 7572 6e20 7365 6c66 2e6d 616e 6167  eturn self.manag
-000028a0: 6564 202b 2073 656c 662e 7370 696c 6c65  ed + self.spille
-000028b0: 640a 0a20 2020 2040 7072 6f70 6572 7479  d..    @property
-000028c0: 0a20 2020 2064 6566 2075 6e6d 616e 6167  .    def unmanag
-000028d0: 6564 2873 656c 6629 202d 3e20 696e 743a  ed(self) -> int:
-000028e0: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
-000028f0: 6973 206e 6576 6572 206e 6567 6174 6976  is never negativ
-00002900: 6520 7468 616e 6b73 2074 6f20 5f5f 696e  e thanks to __in
-00002910: 6974 5f5f 0a20 2020 2020 2020 2072 6574  it__.        ret
-00002920: 7572 6e20 7365 6c66 2e70 726f 6365 7373  urn self.process
-00002930: 202d 2073 656c 662e 6d61 6e61 6765 640a   - self.managed.
-00002940: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00002950: 2020 2064 6566 2075 6e6d 616e 6167 6564     def unmanaged
-00002960: 5f72 6563 656e 7428 7365 6c66 2920 2d3e  _recent(self) ->
-00002970: 2069 6e74 3a0a 2020 2020 2020 2020 2320   int:.        # 
-00002980: 5468 6973 2069 7320 6e65 7665 7220 6e65  This is never ne
-00002990: 6761 7469 7665 2074 6861 6e6b 7320 746f  gative thanks to
-000029a0: 205f 5f69 6e69 745f 5f0a 2020 2020 2020   __init__.      
-000029b0: 2020 7265 7475 726e 2073 656c 662e 7072    return self.pr
-000029c0: 6f63 6573 7320 2d20 7365 6c66 2e6d 616e  ocess - self.man
-000029d0: 6167 6564 202d 2073 656c 662e 756e 6d61  aged - self.unma
-000029e0: 6e61 6765 645f 6f6c 640a 0a20 2020 2040  naged_old..    @
-000029f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00002a00: 206f 7074 696d 6973 7469 6328 7365 6c66   optimistic(self
-00002a10: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-00002a20: 2020 7265 7475 726e 2073 656c 662e 6d61    return self.ma
-00002a30: 6e61 6765 6420 2b20 7365 6c66 2e75 6e6d  naged + self.unm
-00002a40: 616e 6167 6564 5f6f 6c64 0a0a 2020 2020  anaged_old..    
-00002a50: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
-00002a60: 6620 6d61 6e61 6765 645f 696e 5f6d 656d  f managed_in_mem
-00002a70: 6f72 7928 7365 6c66 2920 2d3e 2069 6e74  ory(self) -> int
-00002a80: 3a0a 2020 2020 2020 2020 7761 726e 696e  :.        warnin
-00002a90: 6773 2e77 6172 6e28 226d 616e 6167 6564  gs.warn("managed
-00002aa0: 5f69 6e5f 6d65 6d6f 7279 2068 6173 2062  _in_memory has b
-00002ab0: 6565 6e20 7265 6e61 6d65 6420 746f 206d  een renamed to m
-00002ac0: 616e 6167 6564 222c 2046 7574 7572 6557  anaged", FutureW
-00002ad0: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
-00002ae0: 7265 7475 726e 2073 656c 662e 6d61 6e61  return self.mana
-00002af0: 6765 640a 0a20 2020 2040 7072 6f70 6572  ged..    @proper
-00002b00: 7479 0a20 2020 2064 6566 206d 616e 6167  ty.    def manag
-00002b10: 6564 5f73 7069 6c6c 6564 2873 656c 6629  ed_spilled(self)
-00002b20: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-00002b30: 2077 6172 6e69 6e67 732e 7761 726e 2822   warnings.warn("
-00002b40: 6d61 6e61 6765 645f 7370 696c 6c65 6420  managed_spilled 
-00002b50: 6861 7320 6265 656e 2072 656e 616d 6564  has been renamed
-00002b60: 2074 6f20 7370 696c 6c65 6422 2c20 4675   to spilled", Fu
-00002b70: 7475 7265 5761 726e 696e 6729 0a20 2020  tureWarning).   
-00002b80: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00002b90: 2e73 7069 6c6c 6564 0a0a 2020 2020 6465  .spilled..    de
-00002ba0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
-00002bb0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00002bc0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00002bd0: 2020 2020 2020 6622 5072 6f63 6573 7320        f"Process 
-00002be0: 6d65 6d6f 7279 2028 5253 5329 2020 3a20  memory (RSS)  : 
-00002bf0: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
-00002c00: 6c66 2e70 726f 6365 7373 297d 5c6e 220a  lf.process)}\n".
-00002c10: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
-00002c20: 2d20 6d61 6e61 6765 6420 6279 2044 6173  - managed by Das
-00002c30: 6b20 2020 3a20 7b66 6f72 6d61 745f 6279  k   : {format_by
-00002c40: 7465 7328 7365 6c66 2e6d 616e 6167 6564  tes(self.managed
-00002c50: 297d 5c6e 220a 2020 2020 2020 2020 2020  )}\n".          
-00002c60: 2020 6622 2020 2d20 756e 6d61 6e61 6765    f"  - unmanage
-00002c70: 6420 286f 6c64 2920 2020 3a20 7b66 6f72  d (old)   : {for
-00002c80: 6d61 745f 6279 7465 7328 7365 6c66 2e75  mat_bytes(self.u
-00002c90: 6e6d 616e 6167 6564 5f6f 6c64 297d 5c6e  nmanaged_old)}\n
-00002ca0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00002cb0: 2020 2d20 756e 6d61 6e61 6765 6420 2872    - unmanaged (r
-00002cc0: 6563 656e 7429 3a20 7b66 6f72 6d61 745f  ecent): {format_
-00002cd0: 6279 7465 7328 7365 6c66 2e75 6e6d 616e  bytes(self.unman
-00002ce0: 6167 6564 5f72 6563 656e 7429 7d5c 6e22  aged_recent)}\n"
-00002cf0: 0a20 2020 2020 2020 2020 2020 2066 2253  .            f"S
-00002d00: 7069 6c6c 6564 2074 6f20 6469 736b 2020  pilled to disk  
-00002d10: 2020 2020 203a 207b 666f 726d 6174 5f62       : {format_b
-00002d20: 7974 6573 2873 656c 662e 7370 696c 6c65  ytes(self.spille
-00002d30: 6429 7d5c 6e22 0a20 2020 2020 2020 2029  d)}\n".        )
-00002d40: 0a0a 2020 2020 6465 6620 5f74 6f5f 6469  ..    def _to_di
-00002d50: 6374 2873 656c 662c 202a 2c20 6578 636c  ct(self, *, excl
-00002d60: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
-00002d70: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
-00002d80: 743a 0a20 2020 2020 2020 2022 2222 4469  t:.        """Di
-00002d90: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
-00002da0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
-00002db0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
-00002dc0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-00002dd0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-00002de0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
-00002df0: 742e 6475 6d70 5f63 6c75 7374 6572 5f73  t.dump_cluster_s
-00002e00: 7461 7465 0a20 2020 2020 2020 2064 6973  tate.        dis
-00002e10: 7472 6962 7574 6564 2e75 7469 6c73 2e72  tributed.utils.r
-00002e20: 6563 7572 7369 7665 5f74 6f5f 6469 6374  ecursive_to_dict
-00002e30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00002e40: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
-00002e50: 2020 2020 2020 2020 2020 6b3a 2067 6574            k: get
-00002e60: 6174 7472 2873 656c 662c 206b 290a 2020  attr(self, k).  
-00002e70: 2020 2020 2020 2020 2020 666f 7220 6b20            for k 
-00002e80: 696e 2064 6972 2873 656c 6629 0a20 2020  in dir(self).   
-00002e90: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00002ea0: 6b2e 7374 6172 7473 7769 7468 2822 5f22  k.startswith("_"
-00002eb0: 290a 2020 2020 2020 2020 2020 2020 616e  ).            an
-00002ec0: 6420 6b20 6e6f 7420 696e 207b 2273 756d  d k not in {"sum
-00002ed0: 222c 2022 6d61 6e61 6765 645f 696e 5f6d  ", "managed_in_m
-00002ee0: 656d 6f72 7922 2c20 226d 616e 6167 6564  emory", "managed
-00002ef0: 5f73 7069 6c6c 6564 227d 0a20 2020 2020  _spilled"}.     
-00002f00: 2020 207d 0a0a 0a63 6c61 7373 2057 6f72     }...class Wor
-00002f10: 6b65 7253 7461 7465 3a0a 2020 2020 2222  kerState:.    ""
-00002f20: 2241 2073 696d 706c 6520 6f62 6a65 6374  "A simple object
-00002f30: 2068 6f6c 6469 6e67 2069 6e66 6f72 6d61   holding informa
-00002f40: 7469 6f6e 2061 626f 7574 2061 2077 6f72  tion about a wor
-00002f50: 6b65 722e 0a0a 2020 2020 4e6f 7420 746f  ker...    Not to
-00002f60: 2062 6520 636f 6e66 7573 6564 2077 6974   be confused wit
-00002f70: 6820 3a63 6c61 7373 3a60 6469 7374 7269  h :class:`distri
-00002f80: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
-00002f90: 7465 5f6d 6163 6869 6e65 2e57 6f72 6b65  te_machine.Worke
-00002fa0: 7253 7461 7465 602e 0a20 2020 2022 2222  rState`..    """
-00002fb0: 0a0a 2020 2020 233a 2054 6869 7320 776f  ..    #: This wo
-00002fc0: 726b 6572 2773 2075 6e69 7175 6520 6b65  rker's unique ke
-00002fd0: 792e 2054 6869 7320 6361 6e20 6265 2069  y. This can be i
-00002fe0: 7473 2063 6f6e 6e65 6374 6564 2061 6464  ts connected add
-00002ff0: 7265 7373 0a20 2020 2023 3a20 2873 7563  ress.    #: (suc
-00003000: 6820 6173 2060 6022 7463 703a 2f2f 3132  h as ``"tcp://12
-00003010: 372e 302e 302e 313a 3838 3931 2260 6029  7.0.0.1:8891"``)
-00003020: 206f 7220 616e 2061 6c69 6173 2028 7375   or an alias (su
-00003030: 6368 2061 7320 6060 2261 6c69 6365 2260  ch as ``"alice"`
-00003040: 6029 2e0a 2020 2020 6164 6472 6573 733a  `)..    address:
-00003050: 2073 7472 0a0a 2020 2020 7069 643a 2069   str..    pid: i
-00003060: 6e74 0a20 2020 206e 616d 653a 2048 6173  nt.    name: Has
-00003070: 6861 626c 650a 0a20 2020 2023 3a20 5468  hable..    #: Th
-00003080: 6520 6e75 6d62 6572 206f 6620 4350 5520  e number of CPU 
-00003090: 7468 7265 6164 7320 6d61 6465 2061 7661  threads made ava
-000030a0: 696c 6162 6c65 206f 6e20 7468 6973 2077  ilable on this w
-000030b0: 6f72 6b65 720a 2020 2020 6e74 6872 6561  orker.    nthrea
-000030c0: 6473 3a20 696e 740a 0a20 2020 2023 3a20  ds: int..    #: 
-000030d0: 4d65 6d6f 7279 2061 7661 696c 6162 6c65  Memory available
-000030e0: 2074 6f20 7468 6520 776f 726b 6572 2c20   to the worker, 
-000030f0: 696e 2062 7974 6573 0a20 2020 206d 656d  in bytes.    mem
-00003100: 6f72 795f 6c69 6d69 743a 2069 6e74 0a0a  ory_limit: int..
-00003110: 2020 2020 6c6f 6361 6c5f 6469 7265 6374      local_direct
-00003120: 6f72 793a 2073 7472 0a20 2020 2073 6572  ory: str.    ser
-00003130: 7669 6365 733a 2064 6963 745b 7374 722c  vices: dict[str,
-00003140: 2069 6e74 5d0a 0a20 2020 2023 3a20 4f75   int]..    #: Ou
-00003150: 7470 7574 206f 6620 3a6d 6574 683a 6064  tput of :meth:`d
-00003160: 6973 7472 6962 7574 6564 2e76 6572 7369  istributed.versi
-00003170: 6f6e 732e 6765 745f 7665 7273 696f 6e73  ons.get_versions
-00003180: 6020 6f6e 2074 6865 2077 6f72 6b65 720a  ` on the worker.
-00003190: 2020 2020 7665 7273 696f 6e73 3a20 6469      versions: di
-000031a0: 6374 5b73 7472 2c20 416e 795d 0a0a 2020  ct[str, Any]..  
-000031b0: 2020 233a 2041 6464 7265 7373 206f 6620    #: Address of 
-000031c0: 7468 6520 6173 736f 6369 6174 6564 203a  the associated :
-000031d0: 636c 6173 733a 607e 6469 7374 7269 6275  class:`~distribu
-000031e0: 7465 642e 6e61 6e6e 792e 4e61 6e6e 7960  ted.nanny.Nanny`
-000031f0: 2c20 6966 2070 7265 7365 6e74 0a20 2020  , if present.   
-00003200: 206e 616e 6e79 3a20 7374 720a 0a20 2020   nanny: str..   
-00003210: 2023 3a20 5265 6164 2d6f 6e6c 7920 776f   #: Read-only wo
-00003220: 726b 6572 2073 7461 7475 732c 2073 796e  rker status, syn
-00003230: 6365 6420 6f6e 6520 7761 7920 6672 6f6d  ced one way from
-00003240: 2074 6865 2072 656d 6f74 6520 576f 726b   the remote Work
-00003250: 6572 206f 626a 6563 740a 2020 2020 7374  er object.    st
-00003260: 6174 7573 3a20 5374 6174 7573 0a0a 2020  atus: Status..  
-00003270: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
-00003280: 206f 6620 3a61 7474 723a 607e 576f 726b   of :attr:`~Work
-00003290: 6572 5374 6174 652e 6164 6472 6573 7360  erState.address`
-000032a0: 0a20 2020 205f 6861 7368 3a20 696e 740a  .    _hash: int.
-000032b0: 0a20 2020 2023 3a20 5468 6520 746f 7461  .    #: The tota
-000032c0: 6c20 6d65 6d6f 7279 2073 697a 652c 2069  l memory size, i
-000032d0: 6e20 6279 7465 732c 2075 7365 6420 6279  n bytes, used by
-000032e0: 2074 6865 2074 6173 6b73 2074 6869 7320   the tasks this 
-000032f0: 776f 726b 6572 2068 6f6c 6473 2069 6e20  worker holds in 
-00003300: 6d65 6d6f 7279 0a20 2020 2023 3a20 2869  memory.    #: (i
-00003310: 2e65 2e20 7468 6520 7461 736b 7320 696e  .e. the tasks in
-00003320: 2074 6869 7320 776f 726b 6572 2773 203a   this worker's :
-00003330: 6174 7472 3a60 7e57 6f72 6b65 7253 7461  attr:`~WorkerSta
-00003340: 7465 2e68 6173 5f77 6861 7460 292e 0a20  te.has_what`).. 
-00003350: 2020 206e 6279 7465 733a 2069 6e74 0a0a     nbytes: int..
-00003360: 2020 2020 233a 2057 6f72 6b65 7220 6d65      #: Worker me
-00003370: 6d6f 7279 2075 6e6b 6e6f 776e 2074 6f20  mory unknown to 
-00003380: 7468 6520 776f 726b 6572 2c20 696e 2062  the worker, in b
-00003390: 7974 6573 2c20 7768 6963 6820 6861 7320  ytes, which has 
-000033a0: 6265 656e 2074 6865 7265 2066 6f72 206d  been there for m
-000033b0: 6f72 6520 7468 616e 0a20 2020 2023 3a20  ore than.    #: 
-000033c0: 3330 2073 6563 6f6e 6473 2e20 5365 6520  30 seconds. See 
-000033d0: 3a63 6c61 7373 3a60 4d65 6d6f 7279 5374  :class:`MemorySt
-000033e0: 6174 6560 2e0a 2020 2020 5f6d 656d 6f72  ate`..    _memor
-000033f0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
-00003400: 2069 6e74 0a0a 2020 2020 233a 2048 6973   int..    #: His
-00003410: 746f 7279 206f 6620 7468 6520 6c61 7374  tory of the last
-00003420: 2033 3020 7365 636f 6e64 7327 2077 6f72   30 seconds' wor
-00003430: 7468 206f 6620 756e 6d61 6e61 6765 6420  th of unmanaged 
-00003440: 6d65 6d6f 7279 2e20 5573 6564 2074 6f20  memory. Used to 
-00003450: 6469 6666 6572 656e 7469 6174 650a 2020  differentiate.  
-00003460: 2020 233a 2062 6574 7765 656e 2022 6f6c    #: between "ol
-00003470: 6422 2061 6e64 2022 6e65 7722 2075 6e6d  d" and "new" unm
-00003480: 616e 6167 6564 206d 656d 6f72 792e 0a20  anaged memory.. 
-00003490: 2020 2023 3a20 466f 726d 6174 3a20 6060     #: Format: ``
-000034a0: 5b28 7469 6d65 7374 616d 702c 2062 7974  [(timestamp, byt
-000034b0: 6573 292c 2028 7469 6d65 7374 616d 702c  es), (timestamp,
-000034c0: 2062 7974 6573 292c 202e 2e2e 5d60 600a   bytes), ...]``.
-000034d0: 2020 2020 5f6d 656d 6f72 795f 756e 6d61      _memory_unma
-000034e0: 6e61 6765 645f 6869 7374 6f72 793a 2064  naged_history: d
-000034f0: 6571 7565 5b74 7570 6c65 5b66 6c6f 6174  eque[tuple[float
-00003500: 2c20 696e 745d 5d0a 0a20 2020 206d 6574  , int]]..    met
-00003510: 7269 6373 3a20 6469 6374 5b73 7472 2c20  rics: dict[str, 
-00003520: 416e 795d 0a0a 2020 2020 233a 2054 6865  Any]..    #: The
-00003530: 206c 6173 7420 7469 6d65 2077 6520 7265   last time we re
-00003540: 6365 6976 6564 2061 2068 6561 7274 6265  ceived a heartbe
-00003550: 6174 2066 726f 6d20 7468 6973 2077 6f72  at from this wor
-00003560: 6b65 722c 2069 6e20 6c6f 6361 6c20 7363  ker, in local sc
-00003570: 6865 6475 6c65 7220 7469 6d65 2e0a 2020  heduler time..  
-00003580: 2020 6c61 7374 5f73 6565 6e3a 2066 6c6f    last_seen: flo
-00003590: 6174 0a0a 2020 2020 7469 6d65 5f64 656c  at..    time_del
-000035a0: 6179 3a20 666c 6f61 740a 2020 2020 6261  ay: float.    ba
-000035b0: 6e64 7769 6474 683a 2066 6c6f 6174 0a0a  ndwidth: float..
-000035c0: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
-000035d0: 616c 6c20 5461 736b 5374 6174 6573 206f  all TaskStates o
-000035e0: 6e20 7468 6973 2077 6f72 6b65 7220 7468  n this worker th
-000035f0: 6174 2061 7265 2061 6374 6f72 732e 2054  at are actors. T
-00003600: 6869 7320 6f6e 6c79 2069 6e63 6c75 6465  his only include
-00003610: 7320 7468 6f73 650a 2020 2020 233a 2061  s those.    #: a
-00003620: 6374 6f72 7320 7768 6f73 6520 7374 6174  ctors whose stat
-00003630: 6520 6163 7475 616c 6c79 206c 6976 6573  e actually lives
-00003640: 206f 6e20 7468 6973 2077 6f72 6b65 722c   on this worker,
-00003650: 206e 6f74 2061 6374 6f72 7320 746f 2077   not actors to w
-00003660: 6869 6368 2074 6869 7320 776f 726b 6572  hich this worker
-00003670: 0a20 2020 2023 3a20 6861 7320 6120 7265  .    #: has a re
-00003680: 6665 7265 6e63 652e 0a20 2020 2061 6374  ference..    act
-00003690: 6f72 733a 2073 6574 5b54 6173 6b53 7461  ors: set[TaskSta
-000036a0: 7465 5d0a 0a20 2020 2023 3a20 556e 6465  te]..    #: Unde
-000036b0: 726c 7969 6e67 2064 6174 6120 6f66 203a  rlying data of :
-000036c0: 6d65 7468 3a60 576f 726b 6572 5374 6174  meth:`WorkerStat
-000036d0: 652e 6861 735f 7768 6174 600a 2020 2020  e.has_what`.    
-000036e0: 5f68 6173 5f77 6861 743a 2064 6963 745b  _has_what: dict[
-000036f0: 5461 736b 5374 6174 652c 204e 6f6e 655d  TaskState, None]
-00003700: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
-00003710: 6620 7461 736b 7320 7468 6174 2068 6176  f tasks that hav
-00003720: 6520 6265 656e 2073 7562 6d69 7474 6564  e been submitted
-00003730: 2074 6f20 7468 6973 2077 6f72 6b65 722e   to this worker.
-00003740: 204d 756c 7469 706c 6520 7461 736b 7320   Multiple tasks 
-00003750: 6d61 7920 6265 0a20 2020 2023 2073 7562  may be.    # sub
-00003760: 6d69 7474 6564 2074 6f20 6120 776f 726b  mitted to a work
-00003770: 6572 2069 6e20 6164 7661 6e63 6520 616e  er in advance an
-00003780: 6420 7468 6520 776f 726b 6572 2077 696c  d the worker wil
-00003790: 6c20 7275 6e20 7468 656d 2065 7665 6e74  l run them event
-000037a0: 7561 6c6c 792c 0a20 2020 2023 2064 6570  ually,.    # dep
-000037b0: 656e 6469 6e67 206f 6e20 6974 7320 6578  ending on its ex
-000037c0: 6563 7574 696f 6e20 7265 736f 7572 6365  ecution resource
-000037d0: 7320 2862 7574 2073 6565 203a 646f 633a  s (but see :doc:
-000037e0: 6077 6f72 6b2d 7374 6561 6c69 6e67 6029  `work-stealing`)
-000037f0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-00003800: 416c 6c20 7468 6520 7461 736b 7320 6865  All the tasks he
-00003810: 7265 2061 7265 2069 6e20 7468 6520 2270  re are in the "p
-00003820: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
-00003830: 2e0a 2020 2020 233a 2054 6869 7320 6174  ..    #: This at
-00003840: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
-00003850: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
-00003860: 7472 3a60 5461 736b 5374 6174 652e 7072  tr:`TaskState.pr
-00003870: 6f63 6573 7369 6e67 5f6f 6e60 2e0a 2020  ocessing_on`..  
-00003880: 2020 7072 6f63 6573 7369 6e67 3a20 7365    processing: se
-00003890: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-000038a0: 2020 233a 2052 756e 6e69 6e67 2074 6173    #: Running tas
-000038b0: 6b73 2074 6861 7420 696e 766f 6b65 6420  ks that invoked 
-000038c0: 3a66 756e 633a 6064 6973 7472 6962 7574  :func:`distribut
-000038d0: 6564 2e73 6563 6564 6560 0a20 2020 206c  ed.secede`.    l
-000038e0: 6f6e 675f 7275 6e6e 696e 673a 2073 6574  ong_running: set
-000038f0: 5b54 6173 6b53 7461 7465 5d0a 0a20 2020  [TaskState]..   
-00003900: 2023 3a20 4120 6469 6374 696f 6e61 7279   #: A dictionary
-00003910: 206f 6620 7461 736b 7320 7468 6174 2061   of tasks that a
-00003920: 7265 2063 7572 7265 6e74 6c79 2062 6569  re currently bei
-00003930: 6e67 2072 756e 206f 6e20 7468 6973 2077  ng run on this w
-00003940: 6f72 6b65 722e 0a20 2020 2023 3a20 4561  orker..    #: Ea
-00003950: 6368 2074 6173 6b20 7374 6174 6520 6973  ch task state is
-00003960: 2061 7373 6f63 6961 7465 6420 7769 7468   associated with
-00003970: 2074 6865 2064 7572 6174 696f 6e20 696e   the duration in
-00003980: 2073 6563 6f6e 6473 2077 6869 6368 2074   seconds which t
-00003990: 6865 2074 6173 6b20 6861 730a 2020 2020  he task has.    
-000039a0: 233a 2062 6565 6e20 7275 6e6e 696e 672e  #: been running.
-000039b0: 0a20 2020 2065 7865 6375 7469 6e67 3a20  .    executing: 
-000039c0: 6469 6374 5b54 6173 6b53 7461 7465 2c20  dict[TaskState, 
-000039d0: 666c 6f61 745d 0a0a 2020 2020 233a 2054  float]..    #: T
-000039e0: 6865 2061 7661 696c 6162 6c65 2072 6573  he available res
-000039f0: 6f75 7263 6573 206f 6e20 7468 6973 2077  ources on this w
-00003a00: 6f72 6b65 722c 2065 2e67 2e20 6060 7b22  orker, e.g. ``{"
-00003a10: 4750 5522 3a20 327d 6060 2e0a 2020 2020  GPU": 2}``..    
-00003a20: 233a 2054 6865 7365 2061 7265 2061 6273  #: These are abs
-00003a30: 7472 6163 7420 7175 616e 7469 7469 6573  tract quantities
-00003a40: 2074 6861 7420 636f 6e73 7472 6169 6e20   that constrain 
-00003a50: 6365 7274 6169 6e20 7461 736b 7320 6672  certain tasks fr
-00003a60: 6f6d 2072 756e 6e69 6e67 2061 7420 7468  om running at th
-00003a70: 650a 2020 2020 233a 2073 616d 6520 7469  e.    #: same ti
-00003a80: 6d65 206f 6e20 7468 6973 2077 6f72 6b65  me on this worke
-00003a90: 722e 0a20 2020 2072 6573 6f75 7263 6573  r..    resources
-00003aa0: 3a20 6469 6374 5b73 7472 2c20 666c 6f61  : dict[str, floa
-00003ab0: 745d 0a0a 2020 2020 233a 2054 6865 2073  t]..    #: The s
-00003ac0: 756d 206f 6620 6561 6368 2072 6573 6f75  um of each resou
-00003ad0: 7263 6520 7573 6564 2062 7920 616c 6c20  rce used by all 
-00003ae0: 7461 736b 7320 616c 6c6f 6361 7465 6420  tasks allocated 
-00003af0: 746f 2074 6869 7320 776f 726b 6572 2e0a  to this worker..
-00003b00: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
-00003b10: 7273 2069 6e20 7468 6973 2064 6963 7469  rs in this dicti
-00003b20: 6f6e 6172 7920 6361 6e20 6f6e 6c79 2062  onary can only b
-00003b30: 6520 6c65 7373 206f 7220 6571 7561 6c20  e less or equal 
-00003b40: 7468 616e 2074 686f 7365 2069 6e20 7468  than those in th
-00003b50: 6973 0a20 2020 2023 3a20 776f 726b 6572  is.    #: worker
-00003b60: 2773 203a 6174 7472 3a60 7e57 6f72 6b65  's :attr:`~Worke
-00003b70: 7253 7461 7465 2e72 6573 6f75 7263 6573  rState.resources
-00003b80: 602e 0a20 2020 2075 7365 645f 7265 736f  `..    used_reso
-00003b90: 7572 6365 733a 2064 6963 745b 7374 722c  urces: dict[str,
-00003ba0: 2066 6c6f 6174 5d0a 0a20 2020 2023 3a20   float]..    #: 
-00003bb0: 4172 6269 7472 6172 7920 6164 6469 7469  Arbitrary additi
-00003bc0: 6f6e 616c 206d 6574 6164 6174 6120 746f  onal metadata to
-00003bd0: 2062 6520 6164 6465 6420 746f 203a 6d65   be added to :me
-00003be0: 7468 3a60 7e57 6f72 6b65 7253 7461 7465  th:`~WorkerState
-00003bf0: 2e69 6465 6e74 6974 7960 0a20 2020 2065  .identity`.    e
-00003c00: 7874 7261 3a20 6469 6374 5b73 7472 2c20  xtra: dict[str, 
-00003c10: 416e 795d 0a0a 2020 2020 2320 5468 6520  Any]..    # The 
-00003c20: 756e 6971 7565 2073 6572 7665 7220 4944  unique server ID
-00003c30: 2074 6869 7320 576f 726b 6572 5374 6174   this WorkerStat
-00003c40: 6520 6973 2072 6566 6572 656e 6369 6e67  e is referencing
-00003c50: 0a20 2020 2073 6572 7665 725f 6964 3a20  .    server_id: 
-00003c60: 7374 720a 0a20 2020 2023 2052 6566 6572  str..    # Refer
-00003c70: 656e 6365 2074 6f20 7363 6865 6475 6c65  ence to schedule
-00003c80: 7220 7461 736b 5f67 726f 7570 730a 2020  r task_groups.  
-00003c90: 2020 7363 6865 6475 6c65 725f 7265 663a    scheduler_ref:
-00003ca0: 2077 6561 6b72 6566 2e72 6566 5b53 6368   weakref.ref[Sch
-00003cb0: 6564 756c 6572 5374 6174 655d 207c 204e  edulerState] | N
-00003cc0: 6f6e 650a 2020 2020 7461 736b 5f70 7265  one.    task_pre
-00003cd0: 6669 785f 636f 756e 743a 2064 6566 6175  fix_count: defau
-00003ce0: 6c74 6469 6374 5b73 7472 2c20 696e 745d  ltdict[str, int]
-00003cf0: 0a20 2020 205f 6e65 7477 6f72 6b5f 6f63  .    _network_oc
-00003d00: 633a 2066 6c6f 6174 0a20 2020 205f 6f63  c: float.    _oc
-00003d10: 6375 7061 6e63 795f 6361 6368 653a 2066  cupancy_cache: f
-00003d20: 6c6f 6174 207c 204e 6f6e 650a 0a20 2020  loat | None..   
-00003d30: 2023 3a20 4b65 7973 2074 6861 7420 6d61   #: Keys that ma
-00003d40: 7920 6e65 6564 2074 6f20 6265 2066 6574  y need to be fet
-00003d50: 6368 6564 2074 6f20 7468 6973 2077 6f72  ched to this wor
-00003d60: 6b65 722c 2061 6e64 2074 6865 206e 756d  ker, and the num
-00003d70: 6265 7220 6f66 2074 6173 6b73 2074 6861  ber of tasks tha
-00003d80: 7420 6e65 6564 2074 6865 6d2e 0a20 2020  t need them..   
-00003d90: 2023 3a20 416c 6c20 7461 736b 7320 6172   #: All tasks ar
-00003da0: 6520 6375 7272 656e 746c 7920 696e 2060  e currently in `
-00003db0: 6d65 6d6f 7279 6020 6f6e 2061 2077 6f72  memory` on a wor
-00003dc0: 6b65 7220 6f74 6865 7220 7468 616e 2074  ker other than t
-00003dd0: 6869 7320 6f6e 652e 0a20 2020 2023 3a20  his one..    #: 
-00003de0: 4d75 6368 206c 696b 6520 6070 726f 6365  Much like `proce
-00003df0: 7373 696e 6760 2c20 7468 6973 2064 6f65  ssing`, this doe
-00003e00: 7320 6e6f 7420 6578 6163 746c 7920 7265  s not exactly re
-00003e10: 666c 6563 7420 776f 726b 6572 2073 7461  flect worker sta
-00003e20: 7465 3a0a 2020 2020 233a 206b 6579 7320  te:.    #: keys 
-00003e30: 6865 7265 206d 6179 2062 6520 7175 6575  here may be queu
-00003e40: 6564 2074 6f20 6665 7463 682c 2069 6e20  ed to fetch, in 
-00003e50: 666c 6967 6874 2c20 6f72 2061 6c72 6561  flight, or alrea
-00003e60: 6479 2069 6e20 6d65 6d6f 7279 0a20 2020  dy in memory.   
-00003e70: 2023 3a20 6f6e 2074 6865 2077 6f72 6b65   #: on the worke
-00003e80: 722e 0a20 2020 206e 6565 6473 5f77 6861  r..    needs_wha
-00003e90: 743a 2064 6963 745b 5461 736b 5374 6174  t: dict[TaskStat
-00003ea0: 652c 2069 6e74 5d0a 0a20 2020 205f 5f73  e, int]..    __s
-00003eb0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-00003ec0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-00003ed0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00003ee0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-00003ef0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00003f00: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
-00003f10: 2c0a 2020 2020 2020 2020 7374 6174 7573  ,.        status
-00003f20: 3a20 5374 6174 7573 2c0a 2020 2020 2020  : Status,.      
-00003f30: 2020 7069 643a 2069 6e74 2c0a 2020 2020    pid: int,.    
-00003f40: 2020 2020 6e61 6d65 3a20 6f62 6a65 6374      name: object
-00003f50: 2c0a 2020 2020 2020 2020 6e74 6872 6561  ,.        nthrea
-00003f60: 6473 3a20 696e 7420 3d20 302c 0a20 2020  ds: int = 0,.   
-00003f70: 2020 2020 206d 656d 6f72 795f 6c69 6d69       memory_limi
-00003f80: 743a 2069 6e74 2c0a 2020 2020 2020 2020  t: int,.        
-00003f90: 6c6f 6361 6c5f 6469 7265 6374 6f72 793a  local_directory:
-00003fa0: 2073 7472 2c0a 2020 2020 2020 2020 6e61   str,.        na
-00003fb0: 6e6e 793a 2073 7472 2c0a 2020 2020 2020  nny: str,.      
-00003fc0: 2020 7365 7276 6572 5f69 643a 2073 7472    server_id: str
-00003fd0: 2c0a 2020 2020 2020 2020 7365 7276 6963  ,.        servic
-00003fe0: 6573 3a20 6469 6374 5b73 7472 2c20 696e  es: dict[str, in
-00003ff0: 745d 207c 204e 6f6e 6520 3d20 4e6f 6e65  t] | None = None
-00004000: 2c0a 2020 2020 2020 2020 7665 7273 696f  ,.        versio
-00004010: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
-00004020: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
-00004030: 2c0a 2020 2020 2020 2020 6578 7472 613a  ,.        extra:
-00004040: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-00004050: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00004060: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
-00004070: 3a20 5363 6865 6475 6c65 7253 7461 7465  : SchedulerState
-00004080: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00004090: 2020 2020 293a 0a20 2020 2020 2020 2073      ):.        s
-000040a0: 656c 662e 7365 7276 6572 5f69 6420 3d20  elf.server_id = 
-000040b0: 7365 7276 6572 5f69 640a 2020 2020 2020  server_id.      
-000040c0: 2020 7365 6c66 2e61 6464 7265 7373 203d    self.address =
-000040d0: 2061 6464 7265 7373 0a20 2020 2020 2020   address.       
-000040e0: 2073 656c 662e 7069 6420 3d20 7069 640a   self.pid = pid.
-000040f0: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-00004100: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-00004110: 2073 656c 662e 6e74 6872 6561 6473 203d   self.nthreads =
-00004120: 206e 7468 7265 6164 730a 2020 2020 2020   nthreads.      
-00004130: 2020 7365 6c66 2e6d 656d 6f72 795f 6c69    self.memory_li
-00004140: 6d69 7420 3d20 6d65 6d6f 7279 5f6c 696d  mit = memory_lim
-00004150: 6974 0a20 2020 2020 2020 2073 656c 662e  it.        self.
-00004160: 6c6f 6361 6c5f 6469 7265 6374 6f72 7920  local_directory 
-00004170: 3d20 6c6f 6361 6c5f 6469 7265 6374 6f72  = local_director
-00004180: 790a 2020 2020 2020 2020 7365 6c66 2e73  y.        self.s
-00004190: 6572 7669 6365 7320 3d20 7365 7276 6963  ervices = servic
-000041a0: 6573 206f 7220 7b7d 0a20 2020 2020 2020  es or {}.       
-000041b0: 2073 656c 662e 7665 7273 696f 6e73 203d   self.versions =
-000041c0: 2076 6572 7369 6f6e 7320 6f72 207b 7d0a   versions or {}.
-000041d0: 2020 2020 2020 2020 7365 6c66 2e6e 616e          self.nan
-000041e0: 6e79 203d 206e 616e 6e79 0a20 2020 2020  ny = nanny.     
-000041f0: 2020 2073 656c 662e 7374 6174 7573 203d     self.status =
-00004200: 2073 7461 7475 730a 2020 2020 2020 2020   status.        
-00004210: 7365 6c66 2e5f 6861 7368 203d 2068 6173  self._hash = has
-00004220: 6828 7365 6c66 2e73 6572 7665 725f 6964  h(self.server_id
-00004230: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
-00004240: 6279 7465 7320 3d20 300a 2020 2020 2020  bytes = 0.      
-00004250: 2020 7365 6c66 2e5f 6d65 6d6f 7279 5f75    self._memory_u
-00004260: 6e6d 616e 6167 6564 5f6f 6c64 203d 2030  nmanaged_old = 0
-00004270: 0a20 2020 2020 2020 2073 656c 662e 5f6d  .        self._m
-00004280: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00004290: 6869 7374 6f72 7920 3d20 6465 7175 6528  history = deque(
-000042a0: 290a 2020 2020 2020 2020 7365 6c66 2e6d  ).        self.m
-000042b0: 6574 7269 6373 203d 207b 7d0a 2020 2020  etrics = {}.    
-000042c0: 2020 2020 7365 6c66 2e6c 6173 745f 7365      self.last_se
-000042d0: 656e 203d 2030 0a20 2020 2020 2020 2073  en = 0.        s
-000042e0: 656c 662e 7469 6d65 5f64 656c 6179 203d  elf.time_delay =
-000042f0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-00004300: 6261 6e64 7769 6474 6820 3d20 7061 7273  bandwidth = pars
-00004310: 655f 6279 7465 7328 6461 736b 2e63 6f6e  e_bytes(dask.con
-00004320: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-00004330: 7574 6564 2e73 6368 6564 756c 6572 2e62  uted.scheduler.b
-00004340: 616e 6477 6964 7468 2229 290a 2020 2020  andwidth")).    
-00004350: 2020 2020 7365 6c66 2e61 6374 6f72 7320      self.actors 
-00004360: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00004370: 7365 6c66 2e5f 6861 735f 7768 6174 203d  self._has_what =
-00004380: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-00004390: 2e70 726f 6365 7373 696e 6720 3d20 7365  .processing = se
-000043a0: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-000043b0: 2e6c 6f6e 675f 7275 6e6e 696e 6720 3d20  .long_running = 
-000043c0: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
-000043d0: 6c66 2e65 7865 6375 7469 6e67 203d 207b  lf.executing = {
-000043e0: 7d0a 2020 2020 2020 2020 7365 6c66 2e72  }.        self.r
-000043f0: 6573 6f75 7263 6573 203d 207b 7d0a 2020  esources = {}.  
-00004400: 2020 2020 2020 7365 6c66 2e75 7365 645f        self.used_
-00004410: 7265 736f 7572 6365 7320 3d20 7b7d 0a20  resources = {}. 
-00004420: 2020 2020 2020 2073 656c 662e 6578 7472         self.extr
-00004430: 6120 3d20 6578 7472 6120 6f72 207b 7d0a  a = extra or {}.
-00004440: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00004450: 6564 756c 6572 5f72 6566 203d 2077 6561  eduler_ref = wea
-00004460: 6b72 6566 2e72 6566 2873 6368 6564 756c  kref.ref(schedul
-00004470: 6572 2920 6966 2073 6368 6564 756c 6572  er) if scheduler
-00004480: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-00004490: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
-000044a0: 6669 785f 636f 756e 7420 3d20 6465 6661  fix_count = defa
-000044b0: 756c 7464 6963 7428 696e 7429 0a20 2020  ultdict(int).   
-000044c0: 2020 2020 2073 656c 662e 6e65 6564 735f       self.needs_
-000044d0: 7768 6174 203d 207b 7d0a 2020 2020 2020  what = {}.      
-000044e0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-000044f0: 6f63 6320 3d20 300a 2020 2020 2020 2020  occ = 0.        
-00004500: 7365 6c66 2e5f 6f63 6375 7061 6e63 795f  self._occupancy_
-00004510: 6361 6368 6520 3d20 4e6f 6e65 0a0a 2020  cache = None..  
-00004520: 2020 6465 6620 5f5f 6861 7368 5f5f 2873    def __hash__(s
-00004530: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-00004540: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00004550: 2e5f 6861 7368 0a0a 2020 2020 6465 6620  ._hash..    def 
-00004560: 5f5f 6571 5f5f 2873 656c 662c 206f 7468  __eq__(self, oth
-00004570: 6572 3a20 6f62 6a65 6374 2920 2d3e 2062  er: object) -> b
-00004580: 6f6f 6c3a 0a20 2020 2020 2020 2072 6574  ool:.        ret
-00004590: 7572 6e20 6973 696e 7374 616e 6365 286f  urn isinstance(o
-000045a0: 7468 6572 2c20 576f 726b 6572 5374 6174  ther, WorkerStat
-000045b0: 6529 2061 6e64 206f 7468 6572 2e73 6572  e) and other.ser
-000045c0: 7665 725f 6964 203d 3d20 7365 6c66 2e73  ver_id == self.s
-000045d0: 6572 7665 725f 6964 0a0a 2020 2020 4070  erver_id..    @p
-000045e0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-000045f0: 6861 735f 7768 6174 2873 656c 6629 202d  has_what(self) -
-00004600: 3e20 5365 745b 5461 736b 5374 6174 655d  > Set[TaskState]
-00004610: 3a0a 2020 2020 2020 2020 2222 2241 6e20  :.        """An 
-00004620: 696e 7365 7274 696f 6e2d 736f 7274 6564  insertion-sorted
-00004630: 2073 6574 2d6c 696b 6520 6f66 2074 6173   set-like of tas
-00004640: 6b73 2077 6869 6368 2063 7572 7265 6e74  ks which current
-00004650: 6c79 2072 6573 6964 6520 6f6e 2074 6869  ly reside on thi
-00004660: 7320 776f 726b 6572 2e0a 2020 2020 2020  s worker..      
-00004670: 2020 416c 6c20 7468 6520 7461 736b 7320    All the tasks 
-00004680: 6865 7265 2061 7265 2069 6e20 7468 6520  here are in the 
-00004690: 226d 656d 6f72 7922 2073 7461 7465 2e0a  "memory" state..
-000046a0: 2020 2020 2020 2020 5468 6973 2069 7320          This is 
-000046b0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
-000046c0: 696e 6720 6f66 203a 6174 7472 3a60 5461  ing of :attr:`Ta
-000046d0: 736b 5374 6174 652e 7768 6f5f 6861 7360  skState.who_has`
-000046e0: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-000046f0: 6973 2061 2072 6561 642d 6f6e 6c79 2070  is a read-only p
-00004700: 7562 6c69 6320 6163 6365 7373 6f72 2e20  ublic accessor. 
-00004710: 5468 6520 6461 7461 2069 7320 696d 706c  The data is impl
-00004720: 656d 656e 7465 6420 6173 2061 2064 6963  emented as a dic
-00004730: 7420 7769 7468 6f75 740a 2020 2020 2020  t without.      
-00004740: 2020 7661 6c75 6573 2c20 6265 6361 7573    values, becaus
-00004750: 6520 7265 6261 6c61 6e63 6528 2920 7265  e rebalance() re
-00004760: 6c69 6573 206f 6e20 6469 6374 7320 6265  lies on dicts be
-00004770: 696e 6720 696e 7365 7274 696f 6e2d 736f  ing insertion-so
-00004780: 7274 6564 2e0a 2020 2020 2020 2020 2222  rted..        ""
-00004790: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-000047a0: 2073 656c 662e 5f68 6173 5f77 6861 742e   self._has_what.
-000047b0: 6b65 7973 2829 0a0a 2020 2020 4070 726f  keys()..    @pro
-000047c0: 7065 7274 790a 2020 2020 6465 6620 686f  perty.    def ho
-000047d0: 7374 2873 656c 6629 202d 3e20 7374 723a  st(self) -> str:
-000047e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000047f0: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
-00004800: 2873 656c 662e 6164 6472 6573 7329 0a0a  (self.address)..
-00004810: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00004820: 2020 6465 6620 6d65 6d6f 7279 2873 656c    def memory(sel
-00004830: 6629 202d 3e20 4d65 6d6f 7279 5374 6174  f) -> MemoryStat
-00004840: 653a 0a20 2020 2020 2020 2022 2222 506f  e:.        """Po
-00004850: 6c69 7368 6564 206d 656d 6f72 7920 6d65  lished memory me
-00004860: 7472 6963 7320 666f 7220 7468 6520 776f  trics for the wo
-00004870: 726b 6572 2e0a 0a20 2020 2020 2020 202a  rker...        *
-00004880: 2a44 6573 6967 6e20 6e6f 7465 206f 6e20  *Design note on 
-00004890: 6d61 6e61 6765 6420 6d65 6d6f 7279 2a2a  managed memory**
-000048a0: 0a0a 2020 2020 2020 2020 5468 6572 6520  ..        There 
-000048b0: 6172 6520 7477 6f20 6d65 6173 7572 6573  are two measures
-000048c0: 2061 7661 696c 6162 6c65 2066 6f72 206d   available for m
-000048d0: 616e 6167 6564 206d 656d 6f72 793a 0a0a  anaged memory:..
-000048e0: 2020 2020 2020 2020 2d20 6060 7365 6c66          - ``self
-000048f0: 2e6e 6279 7465 7360 600a 2020 2020 2020  .nbytes``.      
-00004900: 2020 2d20 6060 7365 6c66 2e6d 6574 7269    - ``self.metri
-00004910: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
-00004920: 7322 5d60 600a 0a20 2020 2020 2020 2041  s"]``..        A
-00004930: 7420 7265 7374 2c20 7468 6520 7477 6f20  t rest, the two 
-00004940: 6e75 6d62 6572 7320 6d75 7374 2062 6520  numbers must be 
-00004950: 6964 656e 7469 6361 6c2e 2048 6f77 6576  identical. Howev
-00004960: 6572 2c20 6060 7365 6c66 2e6e 6279 7465  er, ``self.nbyte
-00004970: 7360 6020 6973 0a20 2020 2020 2020 2069  s`` is.        i
-00004980: 6d6d 6564 6961 7465 6c79 2075 7064 6174  mmediately updat
-00004990: 6564 2074 6872 6f75 6768 2074 6865 2062  ed through the b
-000049a0: 6174 6368 6564 2063 6f6d 6d73 2061 7320  atched comms as 
-000049b0: 736f 6f6e 2061 7320 6561 6368 2074 6173  soon as each tas
-000049c0: 6b20 6c61 6e64 7320 696e 0a20 2020 2020  k lands in.     
-000049d0: 2020 206d 656d 6f72 7920 6f6e 2074 6865     memory on the
-000049e0: 2077 6f72 6b65 723b 2060 6073 656c 662e   worker; ``self.
-000049f0: 6d65 7472 6963 735b 226d 616e 6167 6564  metrics["managed
-00004a00: 5f62 7974 6573 225d 6060 2069 6e73 7465  _bytes"]`` inste
-00004a10: 6164 2069 7320 7570 6461 7465 6420 6279  ad is updated by
-00004a20: 0a20 2020 2020 2020 2074 6865 2068 6561  .        the hea
-00004a30: 7274 6265 6174 2c20 7768 6963 6820 6361  rtbeat, which ca
-00004a40: 6e20 6c61 6720 7365 7665 7261 6c20 7365  n lag several se
-00004a50: 636f 6e64 7320 6265 6869 6e64 2e0a 0a20  conds behind... 
-00004a60: 2020 2020 2020 2042 656c 6f77 2077 6520         Below we 
-00004a70: 6172 6520 6d69 7869 6e67 206c 696b 656c  are mixing likel
-00004a80: 7920 6e65 7765 7220 6d61 6e61 6765 6420  y newer managed 
-00004a90: 6d65 6d6f 7279 2069 6e66 6f20 6672 6f6d  memory info from
-00004aa0: 2060 6073 656c 662e 6e62 7974 6573 6060   ``self.nbytes``
-00004ab0: 2077 6974 680a 2020 2020 2020 2020 7072   with.        pr
-00004ac0: 6f63 6573 7320 616e 6420 7370 696c 6c65  ocess and spille
-00004ad0: 6420 6d65 6d6f 7279 2066 726f 6d20 7468  d memory from th
-00004ae0: 6520 6865 6172 7462 6561 742e 2054 6869  e heartbeat. Thi
-00004af0: 7320 6973 2064 656c 6962 6572 6174 652c  s is deliberate,
-00004b00: 2073 6f20 7468 6174 0a20 2020 2020 2020   so that.       
-00004b10: 206d 616e 6167 6564 206d 656d 6f72 7920   managed memory 
-00004b20: 746f 7461 6c20 6973 2075 7064 6174 6564  total is updated
-00004b30: 206d 6f72 6520 6672 6571 7565 6e74 6c79   more frequently
-00004b40: 2e0a 0a20 2020 2020 2020 204d 616e 6167  ...        Manag
-00004b50: 6564 206d 656d 6f72 7920 6469 7265 6374  ed memory direct
-00004b60: 6c79 2061 6e64 2069 6d6d 6564 6961 7465  ly and immediate
-00004b70: 6c79 2063 6f6e 7472 6962 7574 6573 2074  ly contributes t
-00004b80: 6f20 6f70 7469 6d69 7374 6963 206d 656d  o optimistic mem
-00004b90: 6f72 792c 2077 6869 6368 0a20 2020 2020  ory, which.     
-00004ba0: 2020 2069 7320 696e 2074 7572 6e20 7573     is in turn us
-00004bb0: 6564 2069 6e20 4163 7469 7665 204d 656d  ed in Active Mem
-00004bc0: 6f72 7920 4d61 6e61 6765 7220 6865 7572  ory Manager heur
-00004bd0: 6973 7469 6373 2028 6174 2074 6865 206d  istics (at the m
-00004be0: 6f6d 656e 7420 6f66 2077 7269 7469 6e67  oment of writing
-00004bf0: 3b0a 2020 2020 2020 2020 6d6f 7265 2075  ;.        more u
-00004c00: 7365 7320 7769 6c6c 206c 696b 656c 7920  ses will likely 
-00004c10: 6265 2061 6464 6564 2069 6e20 7468 6520  be added in the 
-00004c20: 6675 7475 7265 292e 2053 6f20 6974 2773  future). So it's
-00004c30: 2069 6d70 6f72 7461 6e74 2074 6f20 6861   important to ha
-00004c40: 7665 2069 740a 2020 2020 2020 2020 7570  ve it.        up
-00004c50: 2074 6f20 6461 7465 3b20 6d75 6368 206d   to date; much m
-00004c60: 6f72 6520 7468 616e 2069 7420 6973 2066  ore than it is f
-00004c70: 6f72 2070 726f 6365 7373 206d 656d 6f72  or process memor
-00004c80: 792e 0a0a 2020 2020 2020 2020 4861 7669  y...        Havi
-00004c90: 6e67 2075 702d 746f 2d64 6174 6520 6d61  ng up-to-date ma
-00004ca0: 6e61 6765 6420 6d65 6d6f 7279 2069 6e66  naged memory inf
-00004cb0: 6f20 6173 2073 6f6f 6e20 6173 2074 6865  o as soon as the
-00004cc0: 2073 6368 6564 756c 6572 206c 6561 726e   scheduler learn
-00004cd0: 7320 6162 6f75 740a 2020 2020 2020 2020  s about.        
-00004ce0: 7461 736b 2063 6f6d 706c 6574 696f 6e20  task completion 
-00004cf0: 616c 736f 2073 7562 7374 616e 7469 616c  also substantial
-00004d00: 6c79 2073 696d 706c 6966 6965 7320 756e  ly simplifies un
-00004d10: 6974 2074 6573 7473 2e0a 0a20 2020 2020  it tests...     
-00004d20: 2020 2054 6865 2066 6c69 7020 7369 6465     The flip side
-00004d30: 206f 6620 7468 6973 2064 6573 6967 6e20   of this design 
-00004d40: 6973 2074 6861 7420 6974 206d 6179 2063  is that it may c
-00004d50: 6175 7365 2073 6f6d 6520 6e6f 6973 6520  ause some noise 
-00004d60: 696e 2074 6865 0a20 2020 2020 2020 2075  in the.        u
-00004d70: 6e6d 616e 6167 6564 5f72 6563 656e 7420  nmanaged_recent 
-00004d80: 6d65 6173 7572 652e 2065 2e67 2e3a 0a0a  measure. e.g.:..
-00004d90: 2020 2020 2020 2020 312e 2044 656c 6574          1. Delet
-00004da0: 6520 3130 304d 4220 6f66 206d 616e 6167  e 100MB of manag
-00004db0: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-00004dc0: 322e 2054 6865 2075 7064 6174 6564 206d  2. The updated m
-00004dd0: 616e 6167 6564 206d 656d 6f72 7920 7265  anaged memory re
-00004de0: 6163 6865 7320 7468 6520 7363 6865 6475  aches the schedu
-00004df0: 6c65 7220 6661 7374 6572 2074 6861 6e20  ler faster than 
-00004e00: 7468 650a 2020 2020 2020 2020 2020 2075  the.           u
-00004e10: 7064 6174 6564 2070 726f 6365 7373 206d  pdated process m
-00004e20: 656d 6f72 790a 2020 2020 2020 2020 332e  emory.        3.
-00004e30: 2054 6865 7265 2773 2061 2062 6c69 7020   There's a blip 
-00004e40: 7768 6572 6520 7468 6520 7363 6865 6475  where the schedu
-00004e50: 6c65 7220 7468 696e 6b73 2074 6861 7420  ler thinks that 
-00004e60: 7468 6572 6527 7320 6120 7375 6464 656e  there's a sudden
-00004e70: 2031 3030 4d42 0a20 2020 2020 2020 2020   100MB.         
-00004e80: 2020 696e 6372 6561 7365 2069 6e20 756e    increase in un
-00004e90: 6d61 6e61 6765 645f 7265 6365 6e74 2c20  managed_recent, 
-00004ea0: 7369 6e63 6520 7072 6f63 6573 7320 6d65  since process me
-00004eb0: 6d6f 7279 2068 6173 6e27 7420 6368 616e  mory hasn't chan
-00004ec0: 6765 6420 6275 7420 6d61 6e61 6765 640a  ged but managed.
-00004ed0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-00004ee0: 7920 6861 7320 6465 6372 6561 7365 6420  y has decreased 
-00004ef0: 6279 2031 3030 4d42 0a20 2020 2020 2020  by 100MB.       
-00004f00: 2034 2e20 5768 656e 2074 6865 2068 6561   4. When the hea
-00004f10: 7274 6265 6174 2061 7272 6976 6573 2c20  rtbeat arrives, 
-00004f20: 7072 6f63 6573 7320 6d65 6d6f 7279 2067  process memory g
-00004f30: 6f65 7320 646f 776e 2061 6e64 2073 6f20  oes down and so 
-00004f40: 646f 6573 2074 6865 0a20 2020 2020 2020  does the.       
-00004f50: 2020 2020 756e 6d61 6e61 6765 645f 7265      unmanaged_re
-00004f60: 6365 6e74 2e0a 0a20 2020 2020 2020 2054  cent...        T
-00004f70: 6869 7320 6973 204f 4b20 2d20 6f6e 6520  his is OK - one 
-00004f80: 6f66 2074 6865 206d 6169 6e20 7265 6173  of the main reas
-00004f90: 6f6e 7320 666f 7220 7468 6520 756e 6d61  ons for the unma
-00004fa0: 6e61 6765 645f 7265 6365 6e74 202f 2075  naged_recent / u
-00004fb0: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
-00004fc0: 2020 2020 2073 706c 6974 2069 7320 6578       split is ex
-00004fd0: 6163 746c 7920 746f 2063 6f6e 6365 6e74  actly to concent
-00004fe0: 7261 7465 2061 6c6c 2074 6865 206e 6f69  rate all the noi
-00004ff0: 7365 2069 6e20 756e 6d61 6e61 6765 645f  se in unmanaged_
-00005000: 7265 6365 6e74 2061 6e64 2065 7863 6c75  recent and exclu
-00005010: 6465 2069 740a 2020 2020 2020 2020 6672  de it.        fr
-00005020: 6f6d 206f 7074 696d 6973 7469 6320 6d65  om optimistic me
-00005030: 6d6f 7279 2c20 7768 6963 6820 6973 2075  mory, which is u
-00005040: 7365 6420 666f 7220 6865 7572 6973 7469  sed for heuristi
-00005050: 6373 2e0a 0a20 2020 2020 2020 2053 6f6d  cs...        Som
-00005060: 6574 6869 6e67 2074 6861 7420 6973 206c  ething that is l
-00005070: 6573 7320 4f4b 2c20 6275 7420 616c 736f  ess OK, but also
-00005080: 206c 6573 7320 6672 6571 7565 6e74 2c20   less frequent, 
-00005090: 6973 2074 6861 7420 7468 6520 7375 6464  is that the sudd
-000050a0: 656e 2064 656c 6574 696f 6e0a 2020 2020  en deletion.    
-000050b0: 2020 2020 6f66 2073 7069 6c6c 6564 206b      of spilled k
-000050c0: 6579 7320 7769 6c6c 2063 6175 7365 2061  eys will cause a
-000050d0: 206e 6567 6174 6976 6520 626c 6970 2069   negative blip i
-000050e0: 6e20 6d61 6e61 6765 6420 6d65 6d6f 7279  n managed memory
-000050f0: 3a0a 0a20 2020 2020 2020 2031 2e20 4465  :..        1. De
-00005100: 6c65 7465 2031 3030 4d42 206f 6620 7370  lete 100MB of sp
-00005110: 696c 6c65 6420 6461 7461 0a20 2020 2020  illed data.     
-00005120: 2020 2032 2e20 5468 6520 7570 6461 7465     2. The update
-00005130: 6420 6d61 6e61 6765 6420 6d65 6d6f 7279  d managed memory
-00005140: 202a 746f 7461 6c2a 2072 6561 6368 6573   *total* reaches
-00005150: 2074 6865 2073 6368 6564 756c 6572 2066   the scheduler f
-00005160: 6173 7465 7220 7468 616e 2074 6865 0a20  aster than the. 
-00005170: 2020 2020 2020 2020 2020 7570 6461 7465            update
-00005180: 6420 7370 696c 6c65 6420 706f 7274 696f  d spilled portio
-00005190: 6e0a 2020 2020 2020 2020 332e 2054 6869  n.        3. Thi
-000051a0: 7320 6361 7573 6573 2074 6865 206d 616e  s causes the man
-000051b0: 6167 6564 206d 656d 6f72 7920 746f 2074  aged memory to t
-000051c0: 656d 706f 7261 7269 6c79 2070 6c75 6d6d  emporarily plumm
-000051d0: 6574 2061 6e64 2062 6520 7265 706c 6163  et and be replac
-000051e0: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
-000051f0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
-00005200: 742c 2077 6869 6c65 2073 7069 6c6c 6564  t, while spilled
-00005210: 206d 656d 6f72 7920 7265 6d61 696e 7320   memory remains 
-00005220: 756e 616c 7465 7265 640a 2020 2020 2020  unaltered.      
-00005230: 2020 342e 2057 6865 6e20 7468 6520 6865    4. When the he
-00005240: 6172 7462 6561 7420 6172 7269 7665 732c  artbeat arrives,
-00005250: 206d 616e 6167 6564 2067 6f65 7320 6261   managed goes ba
-00005260: 636b 2075 702c 2075 6e6d 616e 6167 6564  ck up, unmanaged
-00005270: 5f72 6563 656e 740a 2020 2020 2020 2020  _recent.        
-00005280: 2020 2067 6f65 7320 6261 636b 2064 6f77     goes back dow
-00005290: 6e2c 2061 6e64 2073 7069 6c6c 6564 2067  n, and spilled g
-000052a0: 6f65 7320 646f 776e 2062 7920 3130 304d  oes down by 100M
-000052b0: 4220 6173 2069 7420 7368 6f75 6c64 2068  B as it should h
-000052c0: 6176 6520 746f 0a20 2020 2020 2020 2020  ave to.         
-000052d0: 2020 6265 6769 6e20 7769 7468 2e0a 0a20    begin with... 
-000052e0: 2020 2020 2020 203a 6973 7375 653a 6036         :issue:`6
-000052f0: 3030 3260 2077 696c 6c20 6c65 7420 7573  002` will let us
-00005300: 2073 6f6c 7665 2074 6869 732e 0a20 2020   solve this..   
-00005310: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00005320: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
-00005330: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
-00005340: 2070 726f 6365 7373 3d73 656c 662e 6d65   process=self.me
-00005350: 7472 6963 735b 226d 656d 6f72 7922 5d2c  trics["memory"],
-00005360: 0a20 2020 2020 2020 2020 2020 206d 616e  .            man
-00005370: 6167 6564 3d6d 6178 2830 2c20 7365 6c66  aged=max(0, self
-00005380: 2e6e 6279 7465 7320 2d20 7365 6c66 2e6d  .nbytes - self.m
-00005390: 6574 7269 6373 5b22 7370 696c 6c65 645f  etrics["spilled_
-000053a0: 6279 7465 7322 5d5b 226d 656d 6f72 7922  bytes"]["memory"
-000053b0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000053c0: 7370 696c 6c65 643d 7365 6c66 2e6d 6574  spilled=self.met
-000053d0: 7269 6373 5b22 7370 696c 6c65 645f 6279  rics["spilled_by
-000053e0: 7465 7322 5d5b 2264 6973 6b22 5d2c 0a20  tes"]["disk"],. 
-000053f0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-00005400: 6167 6564 5f6f 6c64 3d73 656c 662e 5f6d  aged_old=self._m
-00005410: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00005420: 6f6c 642c 0a20 2020 2020 2020 2029 0a0a  old,.        )..
-00005430: 2020 2020 6465 6620 636c 6561 6e28 7365      def clean(se
-00005440: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
-00005450: 7465 3a0a 2020 2020 2020 2020 2222 2252  te:.        """R
-00005460: 6574 7572 6e20 6120 7665 7273 696f 6e20  eturn a version 
-00005470: 6f66 2074 6869 7320 6f62 6a65 6374 2074  of this object t
-00005480: 6861 7420 6973 2061 7070 726f 7072 6961  hat is appropria
-00005490: 7465 2066 6f72 2073 6572 6961 6c69 7a61  te for serializa
-000054a0: 7469 6f6e 2222 220a 2020 2020 2020 2020  tion""".        
-000054b0: 7773 203d 2057 6f72 6b65 7253 7461 7465  ws = WorkerState
-000054c0: 280a 2020 2020 2020 2020 2020 2020 6164  (.            ad
-000054d0: 6472 6573 733d 7365 6c66 2e61 6464 7265  dress=self.addre
-000054e0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-000054f0: 7374 6174 7573 3d73 656c 662e 7374 6174  status=self.stat
-00005500: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-00005510: 7069 643d 7365 6c66 2e70 6964 2c0a 2020  pid=self.pid,.  
-00005520: 2020 2020 2020 2020 2020 6e61 6d65 3d73            name=s
-00005530: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
-00005540: 2020 2020 2020 6e74 6872 6561 6473 3d73        nthreads=s
-00005550: 656c 662e 6e74 6872 6561 6473 2c0a 2020  elf.nthreads,.  
-00005560: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
-00005570: 5f6c 696d 6974 3d73 656c 662e 6d65 6d6f  _limit=self.memo
-00005580: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
-00005590: 2020 2020 2020 6c6f 6361 6c5f 6469 7265        local_dire
-000055a0: 6374 6f72 793d 7365 6c66 2e6c 6f63 616c  ctory=self.local
-000055b0: 5f64 6972 6563 746f 7279 2c0a 2020 2020  _directory,.    
-000055c0: 2020 2020 2020 2020 7365 7276 6963 6573          services
-000055d0: 3d73 656c 662e 7365 7276 6963 6573 2c0a  =self.services,.
-000055e0: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
-000055f0: 793d 7365 6c66 2e6e 616e 6e79 2c0a 2020  y=self.nanny,.  
-00005600: 2020 2020 2020 2020 2020 6578 7472 613d            extra=
-00005610: 7365 6c66 2e65 7874 7261 2c0a 2020 2020  self.extra,.    
-00005620: 2020 2020 2020 2020 7365 7276 6572 5f69          server_i
-00005630: 643d 7365 6c66 2e73 6572 7665 725f 6964  d=self.server_id
-00005640: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00005650: 2020 2020 7773 2e5f 6f63 6375 7061 6e63      ws._occupanc
-00005660: 795f 6361 6368 6520 3d20 7365 6c66 2e6f  y_cache = self.o
-00005670: 6363 7570 616e 6379 0a0a 2020 2020 2020  ccupancy..      
-00005680: 2020 7773 2e65 7865 6375 7469 6e67 203d    ws.executing =
-00005690: 207b 0a20 2020 2020 2020 2020 2020 2074   {.            t
-000056a0: 732e 6b65 793a 2064 7572 6174 696f 6e20  s.key: duration 
-000056b0: 666f 7220 7473 2c20 6475 7261 7469 6f6e  for ts, duration
-000056c0: 2069 6e20 7365 6c66 2e65 7865 6375 7469   in self.executi
-000056d0: 6e67 2e69 7465 6d73 2829 2020 2320 7479  ng.items()  # ty
-000056e0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-000056f0: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-00005700: 7572 6e20 7773 0a0a 2020 2020 6465 6620  urn ws..    def 
-00005710: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-00005720: 3e20 7374 723a 0a20 2020 2020 2020 206e  > str:.        n
-00005730: 616d 6520 3d20 6622 2c20 6e61 6d65 3a20  ame = f", name: 
-00005740: 7b73 656c 662e 6e61 6d65 7d22 2069 6620  {self.name}" if 
-00005750: 7365 6c66 2e6e 616d 6520 213d 2073 656c  self.name != sel
-00005760: 662e 6164 6472 6573 7320 656c 7365 2022  f.address else "
-00005770: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00005780: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-00005790: 223c 576f 726b 6572 5374 6174 6520 7b73  "<WorkerState {s
-000057a0: 656c 662e 6164 6472 6573 7321 727d 7b6e  elf.address!r}{n
-000057b0: 616d 657d 2c20 220a 2020 2020 2020 2020  ame}, ".        
-000057c0: 2020 2020 6622 7374 6174 7573 3a20 7b73      f"status: {s
-000057d0: 656c 662e 7374 6174 7573 2e6e 616d 657d  elf.status.name}
-000057e0: 2c20 220a 2020 2020 2020 2020 2020 2020  , ".            
-000057f0: 6622 6d65 6d6f 7279 3a20 7b6c 656e 2873  f"memory: {len(s
-00005800: 656c 662e 6861 735f 7768 6174 297d 2c20  elf.has_what)}, 
-00005810: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00005820: 7072 6f63 6573 7369 6e67 3a20 7b6c 656e  processing: {len
-00005830: 2873 656c 662e 7072 6f63 6573 7369 6e67  (self.processing
-00005840: 297d 3e22 0a20 2020 2020 2020 2029 0a0a  )}>".        )..
-00005850: 2020 2020 6465 6620 5f72 6570 725f 6874      def _repr_ht
-00005860: 6d6c 5f28 7365 6c66 2920 2d3e 2073 7472  ml_(self) -> str
-00005870: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00005880: 2067 6574 5f74 656d 706c 6174 6528 2277   get_template("w
-00005890: 6f72 6b65 725f 7374 6174 652e 6874 6d6c  orker_state.html
-000058a0: 2e6a 3222 292e 7265 6e64 6572 280a 2020  .j2").render(.  
-000058b0: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-000058c0: 733d 7365 6c66 2e61 6464 7265 7373 2c0a  s=self.address,.
-000058d0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-000058e0: 3d73 656c 662e 6e61 6d65 2c0a 2020 2020  =self.name,.    
-000058f0: 2020 2020 2020 2020 7374 6174 7573 3d73          status=s
-00005900: 656c 662e 7374 6174 7573 2e6e 616d 652c  elf.status.name,
-00005910: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
-00005920: 5f77 6861 743d 7365 6c66 2e68 6173 5f77  _what=self.has_w
-00005930: 6861 742c 0a20 2020 2020 2020 2020 2020  hat,.           
-00005940: 2070 726f 6365 7373 696e 673d 7365 6c66   processing=self
-00005950: 2e70 726f 6365 7373 696e 672c 0a20 2020  .processing,.   
-00005960: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00005970: 6964 656e 7469 7479 2873 656c 6629 202d  identity(self) -
-00005980: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
-00005990: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000059a0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-000059b0: 7479 7065 223a 2022 576f 726b 6572 222c  type": "Worker",
-000059c0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
-000059d0: 223a 2073 656c 662e 6e61 6d65 2c0a 2020  ": self.name,.  
-000059e0: 2020 2020 2020 2020 2020 2268 6f73 7422            "host"
-000059f0: 3a20 7365 6c66 2e68 6f73 742c 0a20 2020  : self.host,.   
-00005a00: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
-00005a10: 6365 7322 3a20 7365 6c66 2e72 6573 6f75  ces": self.resou
-00005a20: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
-00005a30: 2020 226c 6f63 616c 5f64 6972 6563 746f    "local_directo
-00005a40: 7279 223a 2073 656c 662e 6c6f 6361 6c5f  ry": self.local_
-00005a50: 6469 7265 6374 6f72 792c 0a20 2020 2020  directory,.     
-00005a60: 2020 2020 2020 2022 6e61 6d65 223a 2073         "name": s
-00005a70: 656c 662e 6e61 6d65 2c0a 2020 2020 2020  elf.name,.      
-00005a80: 2020 2020 2020 226e 7468 7265 6164 7322        "nthreads"
-00005a90: 3a20 7365 6c66 2e6e 7468 7265 6164 732c  : self.nthreads,
-00005aa0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00005ab0: 6d6f 7279 5f6c 696d 6974 223a 2073 656c  mory_limit": sel
-00005ac0: 662e 6d65 6d6f 7279 5f6c 696d 6974 2c0a  f.memory_limit,.
-00005ad0: 2020 2020 2020 2020 2020 2020 226c 6173              "las
-00005ae0: 745f 7365 656e 223a 2073 656c 662e 6c61  t_seen": self.la
-00005af0: 7374 5f73 6565 6e2c 0a20 2020 2020 2020  st_seen,.       
-00005b00: 2020 2020 2022 7365 7276 6963 6573 223a       "services":
-00005b10: 2073 656c 662e 7365 7276 6963 6573 2c0a   self.services,.
-00005b20: 2020 2020 2020 2020 2020 2020 226d 6574              "met
-00005b30: 7269 6373 223a 2073 656c 662e 6d65 7472  rics": self.metr
-00005b40: 6963 732c 0a20 2020 2020 2020 2020 2020  ics,.           
-00005b50: 2022 7374 6174 7573 223a 2073 656c 662e   "status": self.
-00005b60: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
-00005b70: 2020 2020 2020 2020 2022 6e61 6e6e 7922           "nanny"
-00005b80: 3a20 7365 6c66 2e6e 616e 6e79 2c0a 2020  : self.nanny,.  
-00005b90: 2020 2020 2020 2020 2020 2a2a 7365 6c66            **self
-00005ba0: 2e65 7874 7261 2c0a 2020 2020 2020 2020  .extra,.        
-00005bb0: 7d0a 0a20 2020 2064 6566 205f 746f 5f64  }..    def _to_d
-00005bc0: 6963 745f 6e6f 5f6e 6573 7428 7365 6c66  ict_no_nest(self
-00005bd0: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
-00005be0: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
-00005bf0: 2929 202d 3e20 6469 6374 5b73 7472 2c20  )) -> dict[str, 
-00005c00: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-00005c10: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
-00005c20: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
-00005c30: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
-00005c40: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
-00005c50: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
-00005c60: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
-00005c70: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
-00005c80: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-00005c90: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00005ca0: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
-00005cb0: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-00005cc0: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
-00005cd0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
-00005ce0: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
-00005cf0: 2020 2020 2054 6173 6b53 7461 7465 2e5f       TaskState._
-00005d00: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
-00005d10: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00005d20: 726e 2072 6563 7572 7369 7665 5f74 6f5f  rn recursive_to_
-00005d30: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-00005d40: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-00005d50: 2020 2020 6578 636c 7564 653d 7365 7428      exclude=set(
-00005d60: 6578 636c 7564 6529 207c 207b 2276 6572  exclude) | {"ver
-00005d70: 7369 6f6e 7322 7d2c 2020 2320 7479 7065  sions"},  # type
-00005d80: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
-00005d90: 2020 2020 206d 656d 6265 7273 3d54 7275       members=Tru
-00005da0: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-00005db0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00005dc0: 6465 6620 7363 6865 6475 6c65 7228 7365  def scheduler(se
-00005dd0: 6c66 2920 2d3e 2053 6368 6564 756c 6572  lf) -> Scheduler
-00005de0: 5374 6174 653a 0a20 2020 2020 2020 2061  State:.        a
-00005df0: 7373 6572 7420 7365 6c66 2e73 6368 6564  ssert self.sched
-00005e00: 756c 6572 5f72 6566 0a20 2020 2020 2020  uler_ref.       
-00005e10: 2073 203d 2073 656c 662e 7363 6865 6475   s = self.schedu
-00005e20: 6c65 725f 7265 6628 290a 2020 2020 2020  ler_ref().      
-00005e30: 2020 6173 7365 7274 2073 0a20 2020 2020    assert s.     
-00005e40: 2020 2072 6574 7572 6e20 730a 0a20 2020     return s..   
-00005e50: 2064 6566 2061 6464 5f74 6f5f 7072 6f63   def add_to_proc
-00005e60: 6573 7369 6e67 2873 656c 662c 2074 733a  essing(self, ts:
-00005e70: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-00005e80: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00005e90: 4173 7369 676e 2061 2074 6173 6b20 746f  Assign a task to
-00005ea0: 2074 6869 7320 776f 726b 6572 2066 6f72   this worker for
-00005eb0: 2063 6f6d 7075 7465 2e22 2222 0a20 2020   compute.""".   
-00005ec0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-00005ed0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-00005ee0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00005ef0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-00005f00: 6c66 2e70 726f 6365 7373 696e 670a 0a20  lf.processing.. 
-00005f10: 2020 2020 2020 2074 7020 3d20 7473 2e70         tp = ts.p
-00005f20: 7265 6669 780a 2020 2020 2020 2020 7365  refix.        se
-00005f30: 6c66 2e74 6173 6b5f 7072 6566 6978 5f63  lf.task_prefix_c
-00005f40: 6f75 6e74 5b74 702e 6e61 6d65 5d20 2b3d  ount[tp.name] +=
-00005f50: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
-00005f60: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
-00005f70: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
-00005f80: 6261 6c5b 7470 2e6e 616d 655d 202b 3d20  bal[tp.name] += 
-00005f90: 310a 2020 2020 2020 2020 7365 6c66 2e70  1.        self.p
-00005fa0: 726f 6365 7373 696e 672e 6164 6428 7473  rocessing.add(ts
-00005fb0: 290a 2020 2020 2020 2020 666f 7220 6474  ).        for dt
-00005fc0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00005fd0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00005fe0: 2020 6966 2073 656c 6620 6e6f 7420 696e    if self not in
-00005ff0: 2064 7473 2e77 686f 5f68 6173 3a0a 2020   dts.who_has:.  
-00006000: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00006010: 6c66 2e5f 696e 635f 6e65 6564 735f 7265  lf._inc_needs_re
-00006020: 706c 6963 6128 6474 7329 0a0a 2020 2020  plica(dts)..    
-00006030: 6465 6620 6164 645f 746f 5f6c 6f6e 675f  def add_to_long_
-00006040: 7275 6e6e 696e 6728 7365 6c66 2c20 7473  running(self, ts
-00006050: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00006060: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
-00006070: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00006080: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00006090: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-000060a0: 696e 2073 656c 662e 7072 6f63 6573 7369  in self.processi
-000060b0: 6e67 0a20 2020 2020 2020 2020 2020 2061  ng.            a
-000060c0: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-000060d0: 7365 6c66 2e6c 6f6e 675f 7275 6e6e 696e  self.long_runnin
-000060e0: 670a 0a20 2020 2020 2020 2073 656c 662e  g..        self.
-000060f0: 5f72 656d 6f76 655f 6672 6f6d 5f74 6173  _remove_from_tas
-00006100: 6b5f 7072 6566 6978 5f63 6f75 6e74 2874  k_prefix_count(t
-00006110: 7329 0a20 2020 2020 2020 2023 2043 616e  s).        # Can
-00006120: 6e6f 7420 7265 6d6f 7665 2066 726f 6d20  not remove from 
-00006130: 7072 6f63 6573 7369 6e67 2073 696e 6365  processing since
-00006140: 2077 6527 7265 2075 7369 6e67 2074 6869   we're using thi
-00006150: 7320 666f 7220 7468 696e 6773 206c 696b  s for things lik
-00006160: 650a 2020 2020 2020 2020 2320 6964 6c65  e.        # idle
-00006170: 6e65 7373 2064 6574 6563 7469 6f6e 2e20  ness detection. 
-00006180: 4964 6c65 2077 6f72 6b65 7273 2061 7265  Idle workers are
-00006190: 2074 7970 6963 616c 6c79 2074 6172 6765   typically targe
-000061a0: 7465 6420 666f 720a 2020 2020 2020 2020  ted for.        
-000061b0: 2320 646f 776e 7363 616c 696e 6720 6275  # downscaling bu
-000061c0: 7420 7765 2073 686f 756c 6420 6e6f 7420  t we should not 
-000061d0: 646f 776e 7363 616c 6520 776f 726b 6572  downscale worker
-000061e0: 7320 7769 7468 206c 6f6e 6720 7275 6e6e  s with long runn
-000061f0: 696e 670a 2020 2020 2020 2020 2320 7461  ing.        # ta
-00006200: 736b 730a 2020 2020 2020 2020 7365 6c66  sks.        self
-00006210: 2e6c 6f6e 675f 7275 6e6e 696e 672e 6164  .long_running.ad
-00006220: 6428 7473 290a 0a20 2020 2064 6566 2072  d(ts)..    def r
-00006230: 656d 6f76 655f 6672 6f6d 5f70 726f 6365  emove_from_proce
-00006240: 7373 696e 6728 7365 6c66 2c20 7473 3a20  ssing(self, ts: 
-00006250: 5461 736b 5374 6174 6529 202d 3e20 4e6f  TaskState) -> No
-00006260: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
-00006270: 656d 6f76 6520 6120 7461 736b 2066 726f  emove a task fro
-00006280: 6d20 6120 776f 726b 6572 7320 7072 6f63  m a workers proc
-00006290: 6573 7369 6e67 2222 220a 2020 2020 2020  essing""".      
-000062a0: 2020 6966 2073 656c 662e 7363 6865 6475    if self.schedu
-000062b0: 6c65 722e 7661 6c69 6461 7465 3a0a 2020  ler.validate:.  
-000062c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000062d0: 2074 7320 696e 2073 656c 662e 7072 6f63   ts in self.proc
-000062e0: 6573 7369 6e67 0a0a 2020 2020 2020 2020  essing..        
-000062f0: 6966 2074 7320 696e 2073 656c 662e 6c6f  if ts in self.lo
-00006300: 6e67 5f72 756e 6e69 6e67 3a0a 2020 2020  ng_running:.    
-00006310: 2020 2020 2020 2020 7365 6c66 2e6c 6f6e          self.lon
-00006320: 675f 7275 6e6e 696e 672e 6469 7363 6172  g_running.discar
-00006330: 6428 7473 290a 2020 2020 2020 2020 656c  d(ts).        el
-00006340: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00006350: 7365 6c66 2e5f 7265 6d6f 7665 5f66 726f  self._remove_fro
-00006360: 6d5f 7461 736b 5f70 7265 6669 785f 636f  m_task_prefix_co
-00006370: 756e 7428 7473 290a 2020 2020 2020 2020  unt(ts).        
-00006380: 7365 6c66 2e70 726f 6365 7373 696e 672e  self.processing.
-00006390: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
-000063a0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-000063b0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-000063c0: 2020 2020 2020 2020 2020 2069 6620 6474             if dt
-000063d0: 7320 696e 2073 656c 662e 6e65 6564 735f  s in self.needs_
-000063e0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-000063f0: 2020 2020 2020 7365 6c66 2e5f 6465 635f        self._dec_
-00006400: 6e65 6564 735f 7265 706c 6963 6128 6474  needs_replica(dt
-00006410: 7329 0a0a 2020 2020 6465 6620 5f72 656d  s)..    def _rem
-00006420: 6f76 655f 6672 6f6d 5f74 6173 6b5f 7072  ove_from_task_pr
-00006430: 6566 6978 5f63 6f75 6e74 2873 656c 662c  efix_count(self,
-00006440: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
-00006450: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00006460: 2063 6f75 6e74 203d 2073 656c 662e 7461   count = self.ta
-00006470: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
-00006480: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
-00006490: 2d20 310a 2020 2020 2020 2020 6966 2063  - 1.        if c
-000064a0: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
-000064b0: 2020 7365 6c66 2e74 6173 6b5f 7072 6566    self.task_pref
-000064c0: 6978 5f63 6f75 6e74 5b74 732e 7072 6566  ix_count[ts.pref
-000064d0: 6978 2e6e 616d 655d 203d 2063 6f75 6e74  ix.name] = count
-000064e0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000064f0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-00006500: 656c 662e 7461 736b 5f70 7265 6669 785f  elf.task_prefix_
-00006510: 636f 756e 745b 7473 2e70 7265 6669 782e  count[ts.prefix.
-00006520: 6e61 6d65 5d0a 0a20 2020 2020 2020 2063  name]..        c
-00006530: 6f75 6e74 203d 2073 656c 662e 7363 6865  ount = self.sche
-00006540: 6475 6c65 722e 5f74 6173 6b5f 7072 6566  duler._task_pref
-00006550: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c5b  ix_count_global[
-00006560: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
-00006570: 2d20 310a 2020 2020 2020 2020 6966 2063  - 1.        if c
-00006580: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
-00006590: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-000065a0: 2e5f 7461 736b 5f70 7265 6669 785f 636f  ._task_prefix_co
-000065b0: 756e 745f 676c 6f62 616c 5b74 732e 7072  unt_global[ts.pr
-000065c0: 6566 6978 2e6e 616d 655d 203d 2063 6f75  efix.name] = cou
-000065d0: 6e74 0a20 2020 2020 2020 2065 6c73 653a  nt.        else:
-000065e0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-000065f0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00006600: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-00006610: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
-00006620: 6669 782e 6e61 6d65 5d0a 0a20 2020 2064  fix.name]..    d
-00006630: 6566 2072 656d 6f76 655f 7265 706c 6963  ef remove_replic
-00006640: 6128 7365 6c66 2c20 7473 3a20 5461 736b  a(self, ts: Task
-00006650: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00006660: 2020 2020 2020 2020 2222 2254 6865 2077          """The w
-00006670: 6f72 6b65 7220 6e6f 206c 6f6e 6765 7220  orker no longer 
-00006680: 6861 7320 6120 7461 736b 2069 6e20 6d65  has a task in me
-00006690: 6d6f 7279 2222 220a 2020 2020 2020 2020  mory""".        
-000066a0: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
-000066b0: 722e 7661 6c69 6461 7465 3a0a 2020 2020  r.validate:.    
-000066c0: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-000066d0: 656c 6620 696e 2074 732e 7768 6f5f 6861  elf in ts.who_ha
-000066e0: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-000066f0: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
-00006700: 6861 735f 7768 6174 0a20 2020 2020 2020  has_what.       
-00006710: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-00006720: 6f74 2069 6e20 7365 6c66 2e6e 6565 6473  ot in self.needs
-00006730: 5f77 6861 740a 0a20 2020 2020 2020 2073  _what..        s
-00006740: 656c 662e 6e62 7974 6573 202d 3d20 7473  elf.nbytes -= ts
-00006750: 2e67 6574 5f6e 6279 7465 7328 290a 2020  .get_nbytes().  
-00006760: 2020 2020 2020 6465 6c20 7365 6c66 2e5f        del self._
-00006770: 6861 735f 7768 6174 5b74 735d 0a20 2020  has_what[ts].   
-00006780: 2020 2020 2074 732e 7768 6f5f 6861 732e       ts.who_has.
-00006790: 7265 6d6f 7665 2873 656c 6629 0a0a 2020  remove(self)..  
-000067a0: 2020 6465 6620 5f69 6e63 5f6e 6565 6473    def _inc_needs
-000067b0: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
-000067c0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-000067d0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-000067e0: 2222 4173 7369 676e 2061 2074 6173 6b20  ""Assign a task 
-000067f0: 6665 7463 6820 746f 2074 6869 7320 776f  fetch to this wo
-00006800: 726b 6572 2061 6e64 2075 7064 6174 6520  rker and update 
-00006810: 6e65 7477 6f72 6b20 6f63 6375 7061 6e63  network occupanc
-00006820: 6965 7322 2222 0a20 2020 2020 2020 2069  ies""".        i
-00006830: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
-00006840: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00006850: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
-00006860: 6c66 206e 6f74 2069 6e20 7473 2e77 686f  lf not in ts.who
-00006870: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00006880: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-00006890: 6e20 7365 6c66 2e68 6173 5f77 6861 740a  n self.has_what.
-000068a0: 2020 2020 2020 2020 6966 2074 7320 6e6f          if ts no
-000068b0: 7420 696e 2073 656c 662e 6e65 6564 735f  t in self.needs_
-000068c0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
-000068d0: 2020 7365 6c66 2e6e 6565 6473 5f77 6861    self.needs_wha
-000068e0: 745b 7473 5d20 3d20 310a 2020 2020 2020  t[ts] = 1.      
-000068f0: 2020 2020 2020 6e62 7974 6573 203d 2074        nbytes = t
-00006900: 732e 6765 745f 6e62 7974 6573 2829 0a20  s.get_nbytes(). 
-00006910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006920: 5f6e 6574 776f 726b 5f6f 6363 202b 3d20  _network_occ += 
-00006930: 6e62 7974 6573 0a20 2020 2020 2020 2020  nbytes.         
-00006940: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-00006950: 722e 5f6e 6574 776f 726b 5f6f 6363 5f67  r._network_occ_g
-00006960: 6c6f 6261 6c20 2b3d 206e 6279 7465 730a  lobal += nbytes.
-00006970: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00006980: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-00006990: 6565 6473 5f77 6861 745b 7473 5d20 2b3d  eeds_what[ts] +=
-000069a0: 2031 0a0a 2020 2020 6465 6620 5f64 6563   1..    def _dec
-000069b0: 5f6e 6565 6473 5f72 6570 6c69 6361 2873  _needs_replica(s
-000069c0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-000069d0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-000069e0: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-000069f0: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-00006a00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006a10: 6572 7420 7473 2069 6e20 7365 6c66 2e6e  ert ts in self.n
-00006a20: 6565 6473 5f77 6861 740a 0a20 2020 2020  eeds_what..     
-00006a30: 2020 2073 656c 662e 6e65 6564 735f 7768     self.needs_wh
-00006a40: 6174 5b74 735d 202d 3d20 310a 2020 2020  at[ts] -= 1.    
-00006a50: 2020 2020 6966 2073 656c 662e 6e65 6564      if self.need
-00006a60: 735f 7768 6174 5b74 735d 203d 3d20 303a  s_what[ts] == 0:
-00006a70: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00006a80: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
-00006a90: 5b74 735d 0a20 2020 2020 2020 2020 2020  [ts].           
-00006aa0: 206e 6279 7465 7320 3d20 7473 2e67 6574   nbytes = ts.get
-00006ab0: 5f6e 6279 7465 7328 290a 2020 2020 2020  _nbytes().      
-00006ac0: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
-00006ad0: 6f72 6b5f 6f63 6320 2d3d 206e 6279 7465  ork_occ -= nbyte
-00006ae0: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
-00006af0: 6c66 2e73 6368 6564 756c 6572 2e5f 6e65  lf.scheduler._ne
-00006b00: 7477 6f72 6b5f 6f63 635f 676c 6f62 616c  twork_occ_global
-00006b10: 202d 3d20 6e62 7974 6573 0a0a 2020 2020   -= nbytes..    
-00006b20: 6465 6620 6164 645f 7265 706c 6963 6128  def add_replica(
-00006b30: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-00006b40: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-00006b50: 2020 2020 2020 2222 2254 6865 2077 6f72        """The wor
-00006b60: 6b65 7220 6163 7175 6972 6564 2061 2072  ker acquired a r
-00006b70: 6570 6c69 6361 206f 6620 7461 736b 2222  eplica of task""
-00006b80: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-00006b90: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
-00006ba0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00006bb0: 2020 6173 7365 7274 2073 656c 6620 6e6f    assert self no
-00006bc0: 7420 696e 2074 732e 7768 6f5f 6861 730a  t in ts.who_has.
-00006bd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00006be0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
-00006bf0: 662e 6861 735f 7768 6174 0a0a 2020 2020  f.has_what..    
-00006c00: 2020 2020 6e62 7974 6573 203d 2074 732e      nbytes = ts.
-00006c10: 6765 745f 6e62 7974 6573 2829 0a20 2020  get_nbytes().   
-00006c20: 2020 2020 2069 6620 7473 2069 6e20 7365       if ts in se
-00006c30: 6c66 2e6e 6565 6473 5f77 6861 743a 0a20  lf.needs_what:. 
-00006c40: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-00006c50: 656c 662e 6e65 6564 735f 7768 6174 5b74  elf.needs_what[t
-00006c60: 735d 0a20 2020 2020 2020 2020 2020 2073  s].            s
-00006c70: 656c 662e 5f6e 6574 776f 726b 5f6f 6363  elf._network_occ
-00006c80: 202d 3d20 6e62 7974 6573 0a20 2020 2020   -= nbytes.     
-00006c90: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00006ca0: 6475 6c65 722e 5f6e 6574 776f 726b 5f6f  duler._network_o
-00006cb0: 6363 5f67 6c6f 6261 6c20 2d3d 206e 6279  cc_global -= nby
-00006cc0: 7465 730a 2020 2020 2020 2020 7473 2e77  tes.        ts.w
-00006cd0: 686f 5f68 6173 2e61 6464 2873 656c 6629  ho_has.add(self)
-00006ce0: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
-00006cf0: 7974 6573 202b 3d20 6e62 7974 6573 0a20  ytes += nbytes. 
-00006d00: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
-00006d10: 5f77 6861 745b 7473 5d20 3d20 4e6f 6e65  _what[ts] = None
-00006d20: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00006d30: 2020 2020 6465 6620 6f63 6375 7061 6e63      def occupanc
-00006d40: 7928 7365 6c66 2920 2d3e 2066 6c6f 6174  y(self) -> float
-00006d50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00006d60: 2073 656c 662e 5f6f 6363 7570 616e 6379   self._occupancy
-00006d70: 5f63 6163 6865 206f 7220 7365 6c66 2e73  _cache or self.s
-00006d80: 6368 6564 756c 6572 2e5f 6361 6c63 5f6f  cheduler._calc_o
-00006d90: 6363 7570 616e 6379 280a 2020 2020 2020  ccupancy(.      
-00006da0: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-00006db0: 7072 6566 6978 5f63 6f75 6e74 2c20 7365  prefix_count, se
-00006dc0: 6c66 2e5f 6e65 7477 6f72 6b5f 6f63 630a  lf._network_occ.
-00006dd0: 2020 2020 2020 2020 290a 0a0a 4064 6174          )...@dat
-00006de0: 6163 6c61 7373 6573 2e64 6174 6163 6c61  aclasses.datacla
-00006df0: 7373 0a63 6c61 7373 2045 7272 6564 5461  ss.class ErredTa
-00006e00: 736b 3a0a 2020 2020 2222 224c 6967 6874  sk:.    """Light
-00006e10: 7765 6967 6874 2072 6570 7265 7365 6e74  weight represent
-00006e20: 6174 696f 6e20 6f66 2061 6e20 6572 7265  ation of an erre
-00006e30: 6420 7461 736b 2077 6974 686f 7574 2061  d task without a
-00006e40: 6e79 2064 6570 656e 6465 6e63 7920 696e  ny dependency in
-00006e50: 666f 726d 6174 696f 6e0a 2020 2020 6f72  formation.    or
-00006e60: 2072 756e 7370 6563 2e0a 0a20 2020 2053   runspec...    S
-00006e70: 6565 2061 6c73 6f0a 2020 2020 2d2d 2d2d  ee also.    ----
-00006e80: 2d2d 2d2d 0a20 2020 2054 6173 6b53 7461  ----.    TaskSta
-00006e90: 7465 0a20 2020 2022 2222 0a0a 2020 2020  te.    """..    
-00006ea0: 6b65 793a 2048 6173 6861 626c 650a 2020  key: Hashable.  
-00006eb0: 2020 7469 6d65 7374 616d 703a 2066 6c6f    timestamp: flo
-00006ec0: 6174 0a20 2020 2065 7272 6564 5f6f 6e3a  at.    erred_on:
-00006ed0: 2073 6574 5b73 7472 5d0a 2020 2020 6578   set[str].    ex
-00006ee0: 6365 7074 696f 6e5f 7465 7874 3a20 7374  ception_text: st
-00006ef0: 720a 2020 2020 7472 6163 6562 6163 6b5f  r.    traceback_
-00006f00: 7465 7874 3a20 7374 720a 0a0a 636c 6173  text: str...clas
-00006f10: 7320 436f 6d70 7574 6174 696f 6e3a 0a20  s Computation:. 
-00006f20: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
-00006f30: 2074 7261 636b 696e 6720 6120 7369 6e67   tracking a sing
-00006f40: 6c65 2063 6f6d 7075 7465 206f 7220 7065  le compute or pe
-00006f50: 7273 6973 7420 6361 6c6c 0a0a 2020 2020  rsist call..    
-00006f60: 4445 5052 4543 4154 4544 3a20 706c 6561  DEPRECATED: plea
-00006f70: 7365 2075 7365 2073 7061 6e73 2069 6e73  se use spans ins
-00006f80: 7465 6164 0a0a 2020 2020 5365 6520 616c  tead..    See al
-00006f90: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
-00006fa0: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
-00006fb0: 2020 2054 6173 6b47 726f 7570 0a20 2020     TaskGroup.   
-00006fc0: 2054 6173 6b53 7461 7465 0a20 2020 2022   TaskState.    "
-00006fd0: 2222 0a0a 2020 2020 7374 6172 743a 2066  ""..    start: f
-00006fe0: 6c6f 6174 0a20 2020 2067 726f 7570 733a  loat.    groups:
-00006ff0: 2073 6574 5b54 6173 6b47 726f 7570 5d0a   set[TaskGroup].
-00007000: 2020 2020 636f 6465 3a20 536f 7274 6564      code: Sorted
-00007010: 5365 745b 7475 706c 655b 536f 7572 6365  Set[tuple[Source
-00007020: 436f 6465 2c20 2e2e 2e5d 5d0a 2020 2020  Code, ...]].    
-00007030: 6964 3a20 7575 6964 2e55 5549 440a 2020  id: uuid.UUID.  
-00007040: 2020 616e 6e6f 7461 7469 6f6e 733a 2064    annotations: d
-00007050: 6963 740a 0a20 2020 205f 5f73 6c6f 7473  ict..    __slots
-00007060: 5f5f 203d 2074 7570 6c65 285f 5f61 6e6e  __ = tuple(__ann
-00007070: 6f74 6174 696f 6e73 5f5f 290a 0a20 2020  otations__)..   
-00007080: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00007090: 6c66 293a 0a20 2020 2020 2020 2073 656c  lf):.        sel
-000070a0: 662e 7374 6172 7420 3d20 7469 6d65 2829  f.start = time()
-000070b0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
-000070c0: 6f75 7073 203d 2073 6574 2829 0a20 2020  oups = set().   
-000070d0: 2020 2020 2073 656c 662e 636f 6465 203d       self.code =
-000070e0: 2053 6f72 7465 6453 6574 2829 0a20 2020   SortedSet().   
-000070f0: 2020 2020 2073 656c 662e 6964 203d 2075       self.id = u
-00007100: 7569 642e 7575 6964 3428 290a 2020 2020  uid.uuid4().    
-00007110: 2020 2020 7365 6c66 2e61 6e6e 6f74 6174      self.annotat
-00007120: 696f 6e73 203d 207b 7d0a 0a20 2020 2040  ions = {}..    @
-00007130: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00007140: 2073 746f 7028 7365 6c66 2920 2d3e 2066   stop(self) -> f
-00007150: 6c6f 6174 3a0a 2020 2020 2020 2020 6966  loat:.        if
-00007160: 2073 656c 662e 6772 6f75 7073 3a0a 2020   self.groups:.  
-00007170: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00007180: 206d 6178 2874 672e 7374 6f70 2066 6f72   max(tg.stop for
-00007190: 2074 6720 696e 2073 656c 662e 6772 6f75   tg in self.grou
-000071a0: 7073 290a 2020 2020 2020 2020 656c 7365  ps).        else
-000071b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000071c0: 7475 726e 202d 310a 0a20 2020 2040 7072  turn -1..    @pr
-000071d0: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
-000071e0: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
-000071f0: 6963 745b 5461 736b 5374 6174 6553 7461  ict[TaskStateSta
-00007200: 7465 2c20 696e 745d 3a0a 2020 2020 2020  te, int]:.      
-00007210: 2020 7265 7475 726e 206d 6572 6765 5f77    return merge_w
-00007220: 6974 6828 7375 6d2c 2028 7467 2e73 7461  ith(sum, (tg.sta
-00007230: 7465 7320 666f 7220 7467 2069 6e20 7365  tes for tg in se
-00007240: 6c66 2e67 726f 7570 7329 290a 0a20 2020  lf.groups))..   
-00007250: 2064 6566 205f 5f72 6570 725f 5f28 7365   def __repr__(se
-00007260: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
-00007270: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
-00007280: 2020 2020 2020 2020 2066 223c 436f 6d70           f"<Comp
-00007290: 7574 6174 696f 6e20 7b73 656c 662e 6964  utation {self.id
-000072a0: 7d3a 2022 0a20 2020 2020 2020 2020 2020  }: ".           
-000072b0: 202b 2022 5461 736b 733a 2022 0a20 2020   + "Tasks: ".   
-000072c0: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
-000072d0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-000072e0: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
-000072f0: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
-00007300: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
-00007310: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
-00007320: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
-00007330: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00007340: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
-00007350: 0a0a 2020 2020 6465 6620 5f72 6570 725f  ..    def _repr_
-00007360: 6874 6d6c 5f28 7365 6c66 2920 2d3e 2073  html_(self) -> s
-00007370: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00007380: 726e 2067 6574 5f74 656d 706c 6174 6528  rn get_template(
-00007390: 2263 6f6d 7075 7461 7469 6f6e 2e68 746d  "computation.htm
-000073a0: 6c2e 6a32 2229 2e72 656e 6465 7228 0a20  l.j2").render(. 
-000073b0: 2020 2020 2020 2020 2020 2069 643d 7365             id=se
-000073c0: 6c66 2e69 642c 0a20 2020 2020 2020 2020  lf.id,.         
-000073d0: 2020 2073 7461 7274 3d73 656c 662e 7374     start=self.st
-000073e0: 6172 742c 0a20 2020 2020 2020 2020 2020  art,.           
-000073f0: 2073 746f 703d 7365 6c66 2e73 746f 702c   stop=self.stop,
-00007400: 0a20 2020 2020 2020 2020 2020 2067 726f  .            gro
-00007410: 7570 733d 7365 6c66 2e67 726f 7570 732c  ups=self.groups,
-00007420: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00007430: 7465 733d 7365 6c66 2e73 7461 7465 732c  tes=self.states,
-00007440: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
-00007450: 653d 7365 6c66 2e63 6f64 652c 0a20 2020  e=self.code,.   
-00007460: 2020 2020 2029 0a0a 0a63 6c61 7373 2054       )...class T
-00007470: 6173 6b50 7265 6669 783a 0a20 2020 2022  askPrefix:.    "
-00007480: 2222 436f 6c6c 6563 7469 6f6e 2074 7261  ""Collection tra
-00007490: 636b 696e 6720 616c 6c20 7461 736b 7320  cking all tasks 
-000074a0: 7769 7468 696e 2061 2067 726f 7570 0a0a  within a group..
-000074b0: 2020 2020 4b65 7973 206f 6674 656e 2068      Keys often h
-000074c0: 6176 6520 6120 7374 7275 6374 7572 6520  ave a structure 
-000074d0: 6c69 6b65 2060 6028 2278 2d31 3233 222c  like ``("x-123",
-000074e0: 2030 2960 600a 2020 2020 4120 6772 6f75   0)``.    A grou
-000074f0: 7020 7461 6b65 7320 7468 6520 6669 7273  p takes the firs
-00007500: 7420 7365 6374 696f 6e2c 206c 696b 6520  t section, like 
-00007510: 6060 2278 2260 600a 0a20 2020 2053 6565  ``"x"``..    See
-00007520: 2041 6c73 6f0a 2020 2020 2d2d 2d2d 2d2d   Also.    ------
-00007530: 2d2d 0a20 2020 2054 6173 6b47 726f 7570  --.    TaskGroup
-00007540: 0a20 2020 2022 2222 0a0a 2020 2020 233a  .    """..    #:
-00007550: 2054 6865 206e 616d 6520 6f66 2061 2067   The name of a g
-00007560: 726f 7570 206f 6620 7461 736b 732e 0a20  roup of tasks.. 
-00007570: 2020 2023 3a20 466f 7220 6120 7461 736b     #: For a task
-00007580: 206c 696b 6520 6060 2822 782d 3132 3322   like ``("x-123"
-00007590: 2c20 3029 6060 2074 6869 7320 6973 2074  , 0)`` this is t
-000075a0: 6865 2074 6578 7420 6060 2278 2260 600a  he text ``"x"``.
-000075b0: 2020 2020 6e61 6d65 3a20 7374 720a 0a20      name: str.. 
-000075c0: 2020 2023 3a20 416e 2065 7870 6f6e 656e     #: An exponen
-000075d0: 7469 616c 6c79 2077 6569 6768 7465 6420  tially weighted 
-000075e0: 6d6f 7669 6e67 2061 7665 7261 6765 2064  moving average d
-000075f0: 7572 6174 696f 6e20 6f66 2061 6c6c 2074  uration of all t
-00007600: 6173 6b73 2077 6974 6820 7468 6973 2070  asks with this p
-00007610: 7265 6669 780a 2020 2020 6475 7261 7469  refix.    durati
-00007620: 6f6e 5f61 7665 7261 6765 3a20 666c 6f61  on_average: floa
-00007630: 740a 0a20 2020 2023 3a20 4e75 6d62 6572  t..    #: Number
-00007640: 7320 6f66 2074 696d 6573 2061 2074 6173  s of times a tas
-00007650: 6b20 7761 7320 6d61 726b 6564 2061 7320  k was marked as 
-00007660: 7375 7370 6963 696f 7573 2077 6974 6820  suspicious with 
-00007670: 7468 6973 2070 7265 6669 780a 2020 2020  this prefix.    
-00007680: 7375 7370 6963 696f 7573 3a20 696e 740a  suspicious: int.
-00007690: 0a20 2020 2023 3a20 5374 6f72 6520 7469  .    #: Store ti
-000076a0: 6d69 6e67 7320 666f 7220 6561 6368 2070  mings for each p
-000076b0: 7265 6669 782d 6163 7469 6f6e 0a20 2020  refix-action.   
-000076c0: 2061 6c6c 5f64 7572 6174 696f 6e73 3a20   all_durations: 
-000076d0: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
-000076e0: 2066 6c6f 6174 5d0a 0a20 2020 2023 3a20   float]..    #: 
-000076f0: 5468 6973 206d 6561 7375 7265 7320 7468  This measures th
-00007700: 6520 6d61 7869 6d75 6d20 7265 636f 7264  e maximum record
-00007710: 6564 206c 6976 6520 6578 6563 7574 696f  ed live executio
-00007720: 6e20 7469 6d65 2061 6e64 2063 616e 2062  n time and can b
-00007730: 6520 7573 6564 2074 6f0a 2020 2020 233a  e used to.    #:
-00007740: 2064 6574 6563 7420 6f75 746c 6965 7273   detect outliers
-00007750: 0a20 2020 206d 6178 5f65 7865 635f 7469  .    max_exec_ti
-00007760: 6d65 3a20 666c 6f61 740a 0a20 2020 2023  me: float..    #
-00007770: 3a20 5461 736b 2067 726f 7570 7320 6173  : Task groups as
-00007780: 736f 6369 6174 6564 2074 6f20 7468 6973  sociated to this
-00007790: 2070 7265 6669 780a 2020 2020 6772 6f75   prefix.    grou
-000077a0: 7073 3a20 6c69 7374 5b54 6173 6b47 726f  ps: list[TaskGro
-000077b0: 7570 5d0a 0a20 2020 2023 3a20 4163 6375  up]..    #: Accu
-000077c0: 6d75 6c61 7465 2063 6f75 6e74 206f 6620  mulate count of 
-000077d0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-000077e0: 696e 2065 6163 6820 7374 6174 650a 2020  in each state.  
-000077f0: 2020 7374 6174 655f 636f 756e 7473 3a20    state_counts: 
-00007800: 6465 6661 756c 7464 6963 745b 5461 736b  defaultdict[Task
-00007810: 5374 6174 6553 7461 7465 2c20 696e 745d  StateState, int]
-00007820: 0a0a 2020 2020 5f5f 736c 6f74 735f 5f20  ..    __slots__ 
-00007830: 3d20 7475 706c 6528 5f5f 616e 6e6f 7461  = tuple(__annota
-00007840: 7469 6f6e 735f 5f29 0a0a 2020 2020 6465  tions__)..    de
-00007850: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-00007860: 206e 616d 653a 2073 7472 293a 0a20 2020   name: str):.   
-00007870: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
-00007880: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
-00007890: 6c66 2e67 726f 7570 7320 3d20 5b5d 0a20  lf.groups = []. 
-000078a0: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
-000078b0: 6475 7261 7469 6f6e 7320 3d20 6465 6661  durations = defa
-000078c0: 756c 7464 6963 7428 666c 6f61 7429 0a20  ultdict(float). 
-000078d0: 2020 2020 2020 2073 656c 662e 7374 6174         self.stat
-000078e0: 655f 636f 756e 7473 203d 2064 6566 6175  e_counts = defau
-000078f0: 6c74 6469 6374 2869 6e74 290a 2020 2020  ltdict(int).    
-00007900: 2020 2020 7461 736b 5f64 7572 6174 696f      task_duratio
-00007910: 6e73 203d 2064 6173 6b2e 636f 6e66 6967  ns = dask.config
-00007920: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-00007930: 642e 7363 6865 6475 6c65 722e 6465 6661  d.scheduler.defa
-00007940: 756c 742d 7461 736b 2d64 7572 6174 696f  ult-task-duratio
-00007950: 6e73 2229 0a20 2020 2020 2020 2069 6620  ns").        if 
-00007960: 7365 6c66 2e6e 616d 6520 696e 2074 6173  self.name in tas
-00007970: 6b5f 6475 7261 7469 6f6e 733a 0a20 2020  k_durations:.   
-00007980: 2020 2020 2020 2020 2073 656c 662e 6475           self.du
-00007990: 7261 7469 6f6e 5f61 7665 7261 6765 203d  ration_average =
-000079a0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
-000079b0: 2874 6173 6b5f 6475 7261 7469 6f6e 735b  (task_durations[
-000079c0: 7365 6c66 2e6e 616d 655d 290a 2020 2020  self.name]).    
-000079d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000079e0: 2020 2020 2020 7365 6c66 2e64 7572 6174        self.durat
-000079f0: 696f 6e5f 6176 6572 6167 6520 3d20 2d31  ion_average = -1
-00007a00: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
-00007a10: 785f 6578 6563 5f74 696d 6520 3d20 2d31  x_exec_time = -1
-00007a20: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
-00007a30: 7370 6963 696f 7573 203d 2030 0a0a 2020  spicious = 0..  
-00007a40: 2020 6465 6620 6164 645f 6578 6563 5f74    def add_exec_t
-00007a50: 696d 6528 7365 6c66 2c20 6475 7261 7469  ime(self, durati
-00007a60: 6f6e 3a20 666c 6f61 7429 202d 3e20 4e6f  on: float) -> No
-00007a70: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
-00007a80: 2e6d 6178 5f65 7865 635f 7469 6d65 203d  .max_exec_time =
-00007a90: 206d 6178 2864 7572 6174 696f 6e2c 2073   max(duration, s
-00007aa0: 656c 662e 6d61 785f 6578 6563 5f74 696d  elf.max_exec_tim
-00007ab0: 6529 0a20 2020 2020 2020 2069 6620 6475  e).        if du
-00007ac0: 7261 7469 6f6e 203e 2032 202a 2073 656c  ration > 2 * sel
-00007ad0: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
-00007ae0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
-00007af0: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
-00007b00: 6572 6167 6520 3d20 2d31 0a0a 2020 2020  erage = -1..    
-00007b10: 6465 6620 6164 645f 6475 7261 7469 6f6e  def add_duration
-00007b20: 2873 656c 662c 2061 6374 696f 6e3a 2073  (self, action: s
-00007b30: 7472 2c20 7374 6172 743a 2066 6c6f 6174  tr, start: float
-00007b40: 2c20 7374 6f70 3a20 666c 6f61 7429 202d  , stop: float) -
-00007b50: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00007b60: 6475 7261 7469 6f6e 203d 2073 746f 7020  duration = stop 
-00007b70: 2d20 7374 6172 740a 2020 2020 2020 2020  - start.        
-00007b80: 7365 6c66 2e61 6c6c 5f64 7572 6174 696f  self.all_duratio
-00007b90: 6e73 5b61 6374 696f 6e5d 202b 3d20 6475  ns[action] += du
-00007ba0: 7261 7469 6f6e 0a20 2020 2020 2020 2069  ration.        i
-00007bb0: 6620 6163 7469 6f6e 203d 3d20 2263 6f6d  f action == "com
-00007bc0: 7075 7465 223a 0a20 2020 2020 2020 2020  pute":.         
-00007bd0: 2020 206f 6c64 203d 2073 656c 662e 6475     old = self.du
-00007be0: 7261 7469 6f6e 5f61 7665 7261 6765 0a20  ration_average. 
-00007bf0: 2020 2020 2020 2020 2020 2069 6620 6f6c             if ol
-00007c00: 6420 3c20 303a 0a20 2020 2020 2020 2020  d < 0:.         
-00007c10: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
-00007c20: 7469 6f6e 5f61 7665 7261 6765 203d 2064  tion_average = d
-00007c30: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
-00007c40: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00007c50: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00007c60: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
-00007c70: 3d20 302e 3520 2a20 6475 7261 7469 6f6e  = 0.5 * duration
-00007c80: 202b 2030 2e35 202a 206f 6c64 0a0a 2020   + 0.5 * old..  
-00007c90: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00007ca0: 6465 6620 7374 6174 6573 2873 656c 6629  def states(self)
-00007cb0: 202d 3e20 6469 6374 5b73 7472 2c20 696e   -> dict[str, in
-00007cc0: 745d 3a0a 2020 2020 2020 2020 2222 2254  t]:.        """T
-00007cd0: 6865 206e 756d 6265 7220 6f66 2074 6173  he number of tas
-00007ce0: 6b73 2069 6e20 6561 6368 2073 7461 7465  ks in each state
-00007cf0: 2c0a 2020 2020 2020 2020 6c69 6b65 2060  ,.        like `
-00007d00: 607b 226d 656d 6f72 7922 3a20 3130 2c20  `{"memory": 10, 
-00007d10: 2270 726f 6365 7373 696e 6722 3a20 332c  "processing": 3,
-00007d20: 2022 7265 6c65 6173 6564 223a 2034 2c20   "released": 4, 
-00007d30: 2e2e 2e7d 6060 0a20 2020 2020 2020 2022  ...}``.        "
-00007d40: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-00007d50: 6e20 6d65 7267 655f 7769 7468 2873 756d  n merge_with(sum
-00007d60: 2c20 5b74 672e 7374 6174 6573 2066 6f72  , [tg.states for
-00007d70: 2074 6720 696e 2073 656c 662e 6772 6f75   tg in self.grou
-00007d80: 7073 5d29 0a0a 2020 2020 4070 726f 7065  ps])..    @prope
-00007d90: 7274 790a 2020 2020 6465 6620 6163 7469  rty.    def acti
-00007da0: 7665 2873 656c 6629 202d 3e20 6c69 7374  ve(self) -> list
-00007db0: 5b54 6173 6b47 726f 7570 5d3a 0a20 2020  [TaskGroup]:.   
-00007dc0: 2020 2020 2072 6574 7572 6e20 5b0a 2020       return [.  
-00007dd0: 2020 2020 2020 2020 2020 7467 0a20 2020            tg.   
-00007de0: 2020 2020 2020 2020 2066 6f72 2074 6720           for tg 
-00007df0: 696e 2073 656c 662e 6772 6f75 7073 0a20  in self.groups. 
-00007e00: 2020 2020 2020 2020 2020 2069 6620 616e             if an
-00007e10: 7928 6b20 213d 2022 666f 7267 6f74 7465  y(k != "forgotte
-00007e20: 6e22 2061 6e64 2076 2021 3d20 3020 666f  n" and v != 0 fo
-00007e30: 7220 6b2c 2076 2069 6e20 7467 2e73 7461  r k, v in tg.sta
-00007e40: 7465 732e 6974 656d 7328 2929 0a20 2020  tes.items()).   
-00007e50: 2020 2020 205d 0a0a 2020 2020 4070 726f       ]..    @pro
-00007e60: 7065 7274 790a 2020 2020 6465 6620 6163  perty.    def ac
-00007e70: 7469 7665 5f73 7461 7465 7328 7365 6c66  tive_states(self
-00007e80: 2920 2d3e 2064 6963 745b 7374 722c 2069  ) -> dict[str, i
-00007e90: 6e74 5d3a 0a20 2020 2020 2020 2072 6574  nt]:.        ret
-00007ea0: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
-00007eb0: 756d 2c20 5b74 672e 7374 6174 6573 2066  um, [tg.states f
-00007ec0: 6f72 2074 6720 696e 2073 656c 662e 6163  or tg in self.ac
-00007ed0: 7469 7665 5d29 0a0a 2020 2020 6465 6620  tive])..    def 
-00007ee0: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-00007ef0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-00007f00: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-00007f10: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
-00007f20: 2020 2020 2b20 7365 6c66 2e6e 616d 650a      + self.name.
-00007f30: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
-00007f40: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
-00007f50: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
-00007f60: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
-00007f70: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
-00007f80: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
-00007f90: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
-00007fa0: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
-00007fb0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00007fc0: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
-00007fd0: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
-00007fe0: 7065 7274 790a 2020 2020 6465 6620 6e62  perty.    def nb
-00007ff0: 7974 6573 5f74 6f74 616c 2873 656c 6629  ytes_total(self)
-00008000: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-00008010: 2072 6574 7572 6e20 7375 6d28 7467 2e6e   return sum(tg.n
-00008020: 6279 7465 735f 746f 7461 6c20 666f 7220  bytes_total for 
-00008030: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
-00008040: 7329 0a0a 2020 2020 6465 6620 5f5f 6c65  s)..    def __le
-00008050: 6e5f 5f28 7365 6c66 2920 2d3e 2069 6e74  n__(self) -> int
-00008060: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00008070: 2073 756d 286d 6170 286c 656e 2c20 7365   sum(map(len, se
-00008080: 6c66 2e67 726f 7570 7329 290a 0a20 2020  lf.groups))..   
-00008090: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-000080a0: 6566 2064 7572 6174 696f 6e28 7365 6c66  ef duration(self
-000080b0: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-000080c0: 2020 2020 7265 7475 726e 2073 756d 2874      return sum(t
-000080d0: 672e 6475 7261 7469 6f6e 2066 6f72 2074  g.duration for t
-000080e0: 6720 696e 2073 656c 662e 6772 6f75 7073  g in self.groups
-000080f0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-00008100: 0a20 2020 2064 6566 2074 7970 6573 2873  .    def types(s
-00008110: 656c 6629 202d 3e20 7365 745b 7374 725d  elf) -> set[str]
-00008120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00008130: 207b 7479 7020 666f 7220 7467 2069 6e20   {typ for tg in 
-00008140: 7365 6c66 2e67 726f 7570 7320 666f 7220  self.groups for 
-00008150: 7479 7020 696e 2074 672e 7479 7065 737d  typ in tg.types}
-00008160: 0a0a 0a63 6c61 7373 2054 6173 6b47 726f  ...class TaskGro
-00008170: 7570 3a0a 2020 2020 2222 2243 6f6c 6c65  up:.    """Colle
-00008180: 6374 696f 6e20 7472 6163 6b69 6e67 2061  ction tracking a
-00008190: 6c6c 2074 6173 6b73 2077 6974 6869 6e20  ll tasks within 
-000081a0: 6120 6772 6f75 700a 0a20 2020 204b 6579  a group..    Key
-000081b0: 7320 6f66 7465 6e20 6861 7665 2061 2073  s often have a s
-000081c0: 7472 7563 7475 7265 206c 696b 6520 6060  tructure like ``
-000081d0: 2822 782d 3132 3322 2c20 3029 6060 0a20  ("x-123", 0)``. 
-000081e0: 2020 2041 2067 726f 7570 2074 616b 6573     A group takes
-000081f0: 2074 6865 2066 6972 7374 2073 6563 7469   the first secti
-00008200: 6f6e 2c20 6c69 6b65 2060 6022 782d 3132  on, like ``"x-12
-00008210: 3322 6060 0a0a 2020 2020 5365 6520 616c  3"``..    See al
-00008220: 736f 0a20 2020 202d 2d2d 2d2d 2d2d 2d0a  so.    --------.
-00008230: 2020 2020 5461 736b 5072 6566 6978 0a20      TaskPrefix. 
-00008240: 2020 2022 2222 0a0a 2020 2020 233a 2054     """..    #: T
-00008250: 6865 206e 616d 6520 6f66 2061 2067 726f  he name of a gro
-00008260: 7570 206f 6620 7461 736b 732e 0a20 2020  up of tasks..   
-00008270: 2023 3a20 466f 7220 6120 7461 736b 206c   #: For a task l
-00008280: 696b 6520 6060 2822 782d 3132 3322 2c20  ike ``("x-123", 
-00008290: 3029 6060 2074 6869 7320 6973 2074 6865  0)`` this is the
-000082a0: 2074 6578 7420 6060 2278 2d31 3233 2260   text ``"x-123"`
-000082b0: 600a 2020 2020 6e61 6d65 3a20 7374 720a  `.    name: str.
-000082c0: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
-000082d0: 6572 206f 6620 7461 736b 7320 696e 2065  er of tasks in e
-000082e0: 6163 6820 7374 6174 652c 0a20 2020 2023  ach state,.    #
-000082f0: 3a20 6c69 6b65 2060 607b 226d 656d 6f72  : like ``{"memor
-00008300: 7922 3a20 3130 2c20 2270 726f 6365 7373  y": 10, "process
-00008310: 696e 6722 3a20 332c 2022 7265 6c65 6173  ing": 3, "releas
-00008320: 6564 223a 2034 2c20 2e2e 2e7d 6060 0a20  ed": 4, ...}``. 
-00008330: 2020 2073 7461 7465 733a 2064 6963 745b     states: dict[
-00008340: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
-00008350: 696e 745d 0a0a 2020 2020 233a 2054 6865  int]..    #: The
-00008360: 206f 7468 6572 2054 6173 6b47 726f 7570   other TaskGroup
-00008370: 7320 6f6e 2077 6869 6368 2074 6869 7320  s on which this 
-00008380: 6f6e 6520 6465 7065 6e64 730a 2020 2020  one depends.    
-00008390: 6465 7065 6e64 656e 6369 6573 3a20 7365  dependencies: se
-000083a0: 745b 5461 736b 4772 6f75 705d 0a0a 2020  t[TaskGroup]..  
-000083b0: 2020 233a 2054 6865 2074 6f74 616c 206e    #: The total n
-000083c0: 756d 6265 7220 6f66 2062 7974 6573 2074  umber of bytes t
-000083d0: 6861 7420 7468 6973 2074 6173 6b20 6772  hat this task gr
-000083e0: 6f75 7020 6861 7320 7072 6f64 7563 6564  oup has produced
-000083f0: 0a20 2020 206e 6279 7465 735f 746f 7461  .    nbytes_tota
-00008400: 6c3a 2069 6e74 0a0a 2020 2020 233a 2054  l: int..    #: T
-00008410: 6865 2074 6f74 616c 2061 6d6f 756e 7420  he total amount 
-00008420: 6f66 2074 696d 6520 7370 656e 7420 6f6e  of time spent on
-00008430: 2061 6c6c 2074 6173 6b73 2069 6e20 7468   all tasks in th
-00008440: 6973 2054 6173 6b47 726f 7570 0a20 2020  is TaskGroup.   
-00008450: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
-00008460: 0a0a 2020 2020 233a 2054 6865 2072 6573  ..    #: The res
-00008470: 756c 7420 7479 7065 7320 6f66 2074 6869  ult types of thi
-00008480: 7320 5461 736b 4772 6f75 700a 2020 2020  s TaskGroup.    
-00008490: 7479 7065 733a 2073 6574 5b73 7472 5d0a  types: set[str].
-000084a0: 0a20 2020 2023 3a20 5468 6520 776f 726b  .    #: The work
-000084b0: 6572 206d 6f73 7420 7265 6365 6e74 6c79  er most recently
-000084c0: 2061 7373 6967 6e65 6420 6120 7461 736b   assigned a task
-000084d0: 2066 726f 6d20 7468 6973 2067 726f 7570   from this group
-000084e0: 2c20 6f72 204e 6f6e 6520 7768 656e 2074  , or None when t
-000084f0: 6865 2067 726f 7570 0a20 2020 2023 3a20  he group.    #: 
-00008500: 6973 206e 6f74 2069 6465 6e74 6966 6965  is not identifie
-00008510: 6420 746f 2062 6520 726f 6f74 2d6c 696b  d to be root-lik
-00008520: 6520 6279 2060 5363 6865 6475 6c65 7253  e by `SchedulerS
-00008530: 7461 7465 2e64 6563 6964 655f 776f 726b  tate.decide_work
-00008540: 6572 602e 0a20 2020 206c 6173 745f 776f  er`..    last_wo
-00008550: 726b 6572 3a20 576f 726b 6572 5374 6174  rker: WorkerStat
-00008560: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
-00008570: 2049 6620 606c 6173 745f 776f 726b 6572   If `last_worker
-00008580: 6020 6973 206e 6f74 204e 6f6e 652c 2074  ` is not None, t
-00008590: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
-000085a0: 6573 2074 6861 7420 776f 726b 6572 2073  es that worker s
-000085b0: 686f 756c 6420 6265 2061 7373 6967 6e65  hould be assigne
-000085c0: 640a 2020 2020 233a 2073 7562 7365 7175  d.    #: subsequ
-000085d0: 656e 7420 7461 736b 7320 756e 7469 6c20  ent tasks until 
-000085e0: 6120 6e65 7720 776f 726b 6572 2069 7320  a new worker is 
-000085f0: 6368 6f73 656e 2e0a 2020 2020 6c61 7374  chosen..    last
-00008600: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
-00008610: 6674 3a20 696e 740a 0a20 2020 2070 7265  ft: int..    pre
-00008620: 6669 783a 2054 6173 6b50 7265 6669 7820  fix: TaskPrefix 
-00008630: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2045  | None..    #: E
-00008640: 6172 6c69 6573 7420 7469 6d65 2077 6865  arliest time whe
-00008650: 6e20 6120 7461 736b 2062 656c 6f6e 6769  n a task belongi
-00008660: 6e67 2074 6f20 7468 6973 2067 726f 7570  ng to this group
-00008670: 2073 7461 7274 6564 2063 6f6d 7075 7469   started computi
-00008680: 6e67 3b0a 2020 2020 233a 2030 2069 6620  ng;.    #: 0 if 
-00008690: 6e6f 2074 6173 6b20 6861 7320 2a66 696e  no task has *fin
-000086a0: 6973 6865 642a 2063 6f6d 7075 7469 6e67  ished* computing
-000086b0: 2079 6574 0a20 2020 2023 3a0a 2020 2020   yet.    #:.    
-000086c0: 233a 204e 6f74 6573 0a20 2020 2023 3a20  #: Notes.    #: 
-000086d0: 2d2d 2d2d 2d0a 2020 2020 233a 2054 6869  -----.    #: Thi
-000086e0: 7320 6973 206e 6f74 2075 7064 6174 6564  s is not updated
-000086f0: 2075 6e74 696c 2061 7420 6c65 6173 7420   until at least 
-00008700: 6f6e 6520 7461 736b 2068 6173 202a 6669  one task has *fi
-00008710: 6e69 7368 6564 2a20 636f 6d70 7574 696e  nished* computin
-00008720: 672e 0a20 2020 2023 3a20 4974 2063 6f75  g..    #: It cou
-00008730: 6c64 206d 6f76 6520 6261 636b 7761 7264  ld move backward
-00008740: 7320 6173 2074 6173 6b73 2063 6f6d 706c  s as tasks compl
-00008750: 6574 652e 0a20 2020 2073 7461 7274 3a20  ete..    start: 
-00008760: 666c 6f61 740a 0a20 2020 2023 3a20 4c61  float..    #: La
-00008770: 7465 7374 2074 696d 6520 7768 656e 2061  test time when a
-00008780: 2074 6173 6b20 6265 6c6f 6e67 696e 6720   task belonging 
-00008790: 746f 2074 6869 7320 6772 6f75 7020 6669  to this group fi
-000087a0: 6e69 7368 6564 2063 6f6d 7075 7469 6e67  nished computing
-000087b0: 2c0a 2020 2020 233a 2030 2069 6620 6e6f  ,.    #: 0 if no
-000087c0: 2074 6173 6b20 6861 7320 6669 6e69 7368   task has finish
-000087d0: 6564 2063 6f6d 7075 7469 6e67 2079 6574  ed computing yet
-000087e0: 0a20 2020 2073 746f 703a 2066 6c6f 6174  .    stop: float
-000087f0: 0a0a 2020 2020 233a 2043 756d 756c 6174  ..    #: Cumulat
-00008800: 6976 6520 6475 7261 7469 6f6e 206f 6620  ive duration of 
-00008810: 616c 6c20 636f 6d70 6c65 7465 6420 6163  all completed ac
-00008820: 7469 6f6e 732c 2062 7920 6163 7469 6f6e  tions, by action
-00008830: 0a20 2020 2061 6c6c 5f64 7572 6174 696f  .    all_duratio
-00008840: 6e73 3a20 6465 6661 756c 7464 6963 745b  ns: defaultdict[
-00008850: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
-00008860: 2023 3a20 5370 616e 2049 4420 2873 6565   #: Span ID (see
-00008870: 2060 6064 6973 7472 6962 7574 6564 2e73   ``distributed.s
-00008880: 7061 6e73 6060 292e 0a20 2020 2023 3a20  pans``)..    #: 
-00008890: 4d61 7463 6865 7320 6060 6469 7374 7269  Matches ``distri
-000088a0: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
-000088b0: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
-000088c0: 7461 7465 2e73 7061 6e5f 6964 6060 2e0a  tate.span_id``..
-000088d0: 2020 2020 233a 2049 7420 6973 2070 6f73      #: It is pos
-000088e0: 7369 626c 6520 746f 2065 6e64 2075 7020  sible to end up 
-000088f0: 696e 2073 6974 7561 7469 6f6e 2077 6865  in situation whe
-00008900: 7265 2064 6966 6665 7265 6e74 2074 6173  re different tas
-00008910: 6b73 206f 6620 7468 6520 7361 6d65 2054  ks of the same T
-00008920: 6173 6b47 726f 7570 0a20 2020 2023 3a20  askGroup.    #: 
-00008930: 6265 6c6f 6e67 2074 6f20 6469 6666 6572  belong to differ
-00008940: 656e 7420 7370 616e 733b 2074 6865 2070  ent spans; the p
-00008950: 7572 706f 7365 206f 6620 7468 6973 2061  urpose of this a
-00008960: 7474 7269 6275 7465 2069 7320 746f 2061  ttribute is to a
-00008970: 7262 6974 7261 7269 6c79 2066 6f72 6365  rbitrarily force
-00008980: 0a20 2020 2023 3a20 6576 6572 7974 6869  .    #: everythi
-00008990: 6e67 206f 6e74 6f20 7468 6520 6561 726c  ng onto the earl
-000089a0: 6965 7374 2065 6e63 6f75 6e74 6572 6564  iest encountered
-000089b0: 206f 6e65 2e0a 2020 2020 7370 616e 5f69   one..    span_i
-000089c0: 643a 2073 7472 207c 204e 6f6e 650a 0a20  d: str | None.. 
-000089d0: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
-000089e0: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
-000089f0: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
-00008a00: 5f69 6e69 745f 5f28 7365 6c66 2c20 6e61  _init__(self, na
-00008a10: 6d65 3a20 7374 7229 3a0a 2020 2020 2020  me: str):.      
-00008a20: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
-00008a30: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
-00008a40: 7072 6566 6978 203d 204e 6f6e 650a 2020  prefix = None.  
-00008a50: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-00008a60: 7320 3d20 6469 6374 2e66 726f 6d6b 6579  s = dict.fromkey
-00008a70: 7328 414c 4c5f 5441 534b 5f53 5441 5445  s(ALL_TASK_STATE
-00008a80: 532c 2030 290a 2020 2020 2020 2020 7365  S, 0).        se
-00008a90: 6c66 2e64 6570 656e 6465 6e63 6965 7320  lf.dependencies 
-00008aa0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00008ab0: 7365 6c66 2e6e 6279 7465 735f 746f 7461  self.nbytes_tota
-00008ac0: 6c20 3d20 300a 2020 2020 2020 2020 7365  l = 0.        se
-00008ad0: 6c66 2e64 7572 6174 696f 6e20 3d20 300a  lf.duration = 0.
-00008ae0: 2020 2020 2020 2020 7365 6c66 2e74 7970          self.typ
-00008af0: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
-00008b00: 2020 2073 656c 662e 7374 6172 7420 3d20     self.start = 
-00008b10: 302e 300a 2020 2020 2020 2020 7365 6c66  0.0.        self
-00008b20: 2e73 746f 7020 3d20 302e 300a 2020 2020  .stop = 0.0.    
-00008b30: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
-00008b40: 6174 696f 6e73 203d 2064 6566 6175 6c74  ations = default
-00008b50: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
-00008b60: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
-00008b70: 726b 6572 203d 204e 6f6e 650a 2020 2020  rker = None.    
-00008b80: 2020 2020 7365 6c66 2e6c 6173 745f 776f      self.last_wo
-00008b90: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
-00008ba0: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-00008bb0: 2e73 7061 6e5f 6964 203d 204e 6f6e 650a  .span_id = None.
-00008bc0: 0a20 2020 2064 6566 2061 6464 5f64 7572  .    def add_dur
-00008bd0: 6174 696f 6e28 7365 6c66 2c20 6163 7469  ation(self, acti
-00008be0: 6f6e 3a20 7374 722c 2073 7461 7274 3a20  on: str, start: 
-00008bf0: 666c 6f61 742c 2073 746f 703a 2066 6c6f  float, stop: flo
-00008c00: 6174 2920 2d3e 204e 6f6e 653a 0a20 2020  at) -> None:.   
-00008c10: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
-00008c20: 7374 6f70 202d 2073 7461 7274 0a20 2020  stop - start.   
-00008c30: 2020 2020 2073 656c 662e 6475 7261 7469       self.durati
-00008c40: 6f6e 202b 3d20 6475 7261 7469 6f6e 0a20  on += duration. 
-00008c50: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
-00008c60: 6475 7261 7469 6f6e 735b 6163 7469 6f6e  durations[action
-00008c70: 5d20 2b3d 2064 7572 6174 696f 6e0a 2020  ] += duration.  
-00008c80: 2020 2020 2020 6966 2061 6374 696f 6e20        if action 
-00008c90: 3d3d 2022 636f 6d70 7574 6522 3a0a 2020  == "compute":.  
-00008ca0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00008cb0: 662e 7374 6f70 203c 2073 746f 703a 0a20  f.stop < stop:. 
-00008cc0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00008cd0: 656c 662e 7374 6f70 203d 2073 746f 700a  elf.stop = stop.
-00008ce0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00008cf0: 656c 662e 7374 6172 7420 3d3d 2030 2e30  elf.start == 0.0
-00008d00: 206f 7220 7365 6c66 2e73 7461 7274 203e   or self.start >
-00008d10: 2073 7461 7274 3a0a 2020 2020 2020 2020   start:.        
-00008d20: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00008d30: 7274 203d 2073 7461 7274 0a20 2020 2020  rt = start.     
-00008d40: 2020 2061 7373 6572 7420 7365 6c66 2e70     assert self.p
-00008d50: 7265 6669 7820 6973 206e 6f74 204e 6f6e  refix is not Non
-00008d60: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
-00008d70: 7265 6669 782e 6164 645f 6475 7261 7469  refix.add_durati
-00008d80: 6f6e 2861 6374 696f 6e2c 2073 7461 7274  on(action, start
-00008d90: 2c20 7374 6f70 290a 0a20 2020 2064 6566  , stop)..    def
-00008da0: 2061 6464 2873 656c 662c 206f 7468 6572   add(self, other
-00008db0: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00008dc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
-00008dd0: 6c66 2e73 7461 7465 735b 6f74 6865 722e  lf.states[other.
-00008de0: 7374 6174 655d 202b 3d20 310a 2020 2020  state] += 1.    
-00008df0: 2020 2020 6f74 6865 722e 6772 6f75 7020      other.group 
-00008e00: 3d20 7365 6c66 0a0a 2020 2020 6465 6620  = self..    def 
-00008e10: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-00008e20: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-00008e30: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
-00008e40: 2020 2020 223c 220a 2020 2020 2020 2020      "<".        
-00008e50: 2020 2020 2b20 2873 656c 662e 6e61 6d65      + (self.name
-00008e60: 206f 7220 226e 6f2d 6772 6f75 7022 290a   or "no-group").
-00008e70: 2020 2020 2020 2020 2020 2020 2b20 223a              + ":
-00008e80: 2022 0a20 2020 2020 2020 2020 2020 202b   ".            +
-00008e90: 2022 2c20 222e 6a6f 696e 280a 2020 2020   ", ".join(.    
-00008ea0: 2020 2020 2020 2020 2020 2020 2225 733a              "%s:
-00008eb0: 2025 6422 2025 2028 6b2c 2076 2920 666f   %d" % (k, v) fo
-00008ec0: 7220 286b 2c20 7629 2069 6e20 736f 7274  r (k, v) in sort
-00008ed0: 6564 2873 656c 662e 7374 6174 6573 2e69  ed(self.states.i
-00008ee0: 7465 6d73 2829 2920 6966 2076 0a20 2020  tems()) if v.   
-00008ef0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00008f00: 2020 2020 2020 202b 2022 3e22 0a20 2020         + ">".   
-00008f10: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00008f20: 5f5f 6c65 6e5f 5f28 7365 6c66 2920 2d3e  __len__(self) ->
-00008f30: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
-00008f40: 7475 726e 2073 756d 2873 656c 662e 7374  turn sum(self.st
-00008f50: 6174 6573 2e76 616c 7565 7328 2929 0a0a  ates.values())..
-00008f60: 2020 2020 6465 6620 5f74 6f5f 6469 6374      def _to_dict
-00008f70: 5f6e 6f5f 6e65 7374 2873 656c 662c 202a  _no_nest(self, *
-00008f80: 2c20 6578 636c 7564 653a 2043 6f6e 7461  , exclude: Conta
-00008f90: 696e 6572 5b73 7472 5d20 3d20 2829 2920  iner[str] = ()) 
-00008fa0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
-00008fb0: 5d3a 0a20 2020 2020 2020 2022 2222 4469  ]:.        """Di
-00008fc0: 6374 696f 6e61 7279 2072 6570 7265 7365  ctionary represe
-00008fd0: 6e74 6174 696f 6e20 666f 7220 6465 6275  ntation for debu
-00008fe0: 6767 696e 6720 7075 7270 6f73 6573 2e0a  gging purposes..
-00008ff0: 2020 2020 2020 2020 4e6f 7420 7479 7065          Not type
-00009000: 2073 7461 626c 6520 616e 6420 6e6f 7420   stable and not 
-00009010: 696e 7465 6e64 6564 2066 6f72 2072 6f75  intended for rou
-00009020: 6e64 7472 6970 732e 0a0a 2020 2020 2020  ndtrips...      
-00009030: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-00009040: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-00009050: 2020 2020 436c 6965 6e74 2e64 756d 705f      Client.dump_
-00009060: 636c 7573 7465 725f 7374 6174 650a 2020  cluster_state.  
-00009070: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-00009080: 642e 7574 696c 732e 7265 6375 7273 6976  d.utils.recursiv
-00009090: 655f 746f 5f64 6963 740a 2020 2020 2020  e_to_dict.      
-000090a0: 2020 5461 736b 5374 6174 652e 5f74 6f5f    TaskState._to_
-000090b0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
-000090c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000090d0: 7265 6375 7273 6976 655f 746f 5f64 6963  recursive_to_dic
-000090e0: 7428 7365 6c66 2c20 6578 636c 7564 653d  t(self, exclude=
-000090f0: 6578 636c 7564 652c 206d 656d 6265 7273  exclude, members
-00009100: 3d54 7275 6529 0a0a 2020 2020 4070 726f  =True)..    @pro
-00009110: 7065 7274 790a 2020 2020 6465 6620 646f  perty.    def do
-00009120: 6e65 2873 656c 6629 202d 3e20 626f 6f6c  ne(self) -> bool
-00009130: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-00009140: 7572 6e20 5472 7565 2069 6620 616c 6c20  urn True if all 
-00009150: 636f 6d70 7574 6174 696f 6e73 2066 6f72  computations for
-00009160: 2074 6869 7320 6772 6f75 7020 6861 7665   this group have
-00009170: 2063 6f6d 706c 6574 6564 3b20 4661 6c73   completed; Fals
-00009180: 650a 2020 2020 2020 2020 6f74 6865 7277  e.        otherw
-00009190: 6973 652e 0a0a 2020 2020 2020 2020 4e6f  ise...        No
-000091a0: 7465 730a 2020 2020 2020 2020 2d2d 2d2d  tes.        ----
-000091b0: 2d0a 2020 2020 2020 2020 5468 6973 2070  -.        This p
-000091c0: 726f 7065 7274 7920 6d61 7920 7472 616e  roperty may tran
-000091d0: 7369 7469 6f6e 2066 726f 6d20 5472 7565  sition from True
-000091e0: 2074 6f20 4661 6c73 652c 2065 2e67 2e20   to False, e.g. 
-000091f0: 7768 656e 2061 2077 6f72 6b65 7220 7468  when a worker th
-00009200: 6174 0a20 2020 2020 2020 2063 6f6e 7461  at.        conta
-00009210: 696e 6564 2074 6865 206f 6e6c 7920 7265  ined the only re
-00009220: 706c 6963 6120 6f66 2061 2074 6173 6b20  plica of a task 
-00009230: 696e 206d 656d 6f72 7920 6372 6173 6865  in memory crashe
-00009240: 7320 616e 6420 7468 6520 7461 736b 206e  s and the task n
-00009250: 6565 6420 746f 2062 650a 2020 2020 2020  eed to be.      
-00009260: 2020 7265 636f 6d70 7574 6564 2e0a 2020    recomputed..  
-00009270: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00009280: 2020 7265 7475 726e 2061 6c6c 280a 2020    return all(.  
-00009290: 2020 2020 2020 2020 2020 636f 756e 7420            count 
-000092a0: 3d3d 2030 206f 7220 7374 6174 6520 696e  == 0 or state in
-000092b0: 207b 226d 656d 6f72 7922 2c20 2265 7272   {"memory", "err
-000092c0: 6564 222c 2022 7265 6c65 6173 6564 222c  ed", "released",
-000092d0: 2022 666f 7267 6f74 7465 6e22 7d0a 2020   "forgotten"}.  
-000092e0: 2020 2020 2020 2020 2020 666f 7220 7374            for st
-000092f0: 6174 652c 2063 6f75 6e74 2069 6e20 7365  ate, count in se
-00009300: 6c66 2e73 7461 7465 732e 6974 656d 7328  lf.states.items(
-00009310: 290a 2020 2020 2020 2020 290a 0a0a 636c  ).        )...cl
-00009320: 6173 7320 5461 736b 5374 6174 653a 0a20  ass TaskState:. 
-00009330: 2020 2022 2222 4120 7369 6d70 6c65 206f     """A simple o
-00009340: 626a 6563 7420 686f 6c64 696e 6720 696e  bject holding in
-00009350: 666f 726d 6174 696f 6e20 6162 6f75 7420  formation about 
-00009360: 6120 7461 736b 2e0a 0a20 2020 204e 6f74  a task...    Not
-00009370: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
-00009380: 7769 7468 203a 636c 6173 733a 6064 6973  with :class:`dis
-00009390: 7472 6962 7574 6564 2e77 6f72 6b65 725f  tributed.worker_
-000093a0: 7374 6174 655f 6d61 6368 696e 652e 5461  state_machine.Ta
-000093b0: 736b 5374 6174 6560 2c20 7768 6963 680a  skState`, which.
-000093c0: 2020 2020 686f 6c64 7320 7369 6d69 6c61      holds simila
-000093d0: 7220 696e 666f 726d 6174 696f 6e20 6f6e  r information on
-000093e0: 2074 6865 2057 6f72 6b65 7220 7369 6465   the Worker side
-000093f0: 2e0a 2020 2020 2222 220a 0a20 2020 2023  ..    """..    #
-00009400: 3a20 5468 6520 6b65 7920 6973 2074 6865  : The key is the
-00009410: 2075 6e69 7175 6520 6964 656e 7469 6669   unique identifi
-00009420: 6572 206f 6620 6120 7461 736b 2c20 6765  er of a task, ge
-00009430: 6e65 7261 6c6c 7920 666f 726d 6564 2066  nerally formed f
-00009440: 726f 6d20 7468 6520 6e61 6d65 206f 6620  rom the name of 
-00009450: 7468 650a 2020 2020 233a 2066 756e 6374  the.    #: funct
-00009460: 696f 6e2c 2066 6f6c 6c6f 7765 6420 6279  ion, followed by
-00009470: 2061 2068 6173 6820 6f66 2074 6865 2066   a hash of the f
-00009480: 756e 6374 696f 6e20 616e 6420 6172 6775  unction and argu
-00009490: 6d65 6e74 732c 206c 696b 650a 2020 2020  ments, like.    
-000094a0: 233a 2060 6027 696e 632d 6162 3331 6330  #: ``'inc-ab31c0
-000094b0: 3130 3434 3439 3737 3030 3464 3635 3636  10444977004d6566
-000094c0: 3130 6432 6434 3231 6563 2760 602e 0a20  10d2d421ec'``.. 
-000094d0: 2020 206b 6579 3a20 7374 720a 0a20 2020     key: str..   
-000094e0: 2023 3a20 5468 6520 6272 6f61 6420 636c   #: The broad cl
-000094f0: 6173 7320 6f66 2074 6173 6b73 2074 6f20  ass of tasks to 
-00009500: 7768 6963 6820 7468 6973 2074 6173 6b20  which this task 
-00009510: 6265 6c6f 6e67 7320 6c69 6b65 2022 696e  belongs like "in
-00009520: 6322 206f 7220 2272 6561 645f 6373 7622  c" or "read_csv"
-00009530: 0a20 2020 2070 7265 6669 783a 2054 6173  .    prefix: Tas
-00009540: 6b50 7265 6669 780a 0a20 2020 2023 3a20  kPrefix..    #: 
-00009550: 4120 7370 6563 6966 6963 6174 696f 6e20  A specification 
-00009560: 6f66 2068 6f77 2074 6f20 7275 6e20 7468  of how to run th
-00009570: 6520 7461 736b 2e20 2054 6865 2074 7970  e task.  The typ
-00009580: 6520 616e 6420 6d65 616e 696e 6720 6f66  e and meaning of
-00009590: 2074 6869 7320 7661 6c75 6520 6973 0a20   this value is. 
-000095a0: 2020 2023 3a20 6f70 6171 7565 2074 6f20     #: opaque to 
-000095b0: 7468 6520 7363 6865 6475 6c65 722c 2061  the scheduler, a
-000095c0: 7320 6974 2069 7320 6f6e 6c79 2069 6e74  s it is only int
-000095d0: 6572 7072 6574 6564 2062 7920 7468 6520  erpreted by the 
-000095e0: 776f 726b 6572 2074 6f20 7768 6963 6820  worker to which 
-000095f0: 7468 650a 2020 2020 233a 2074 6173 6b20  the.    #: task 
-00009600: 6973 2073 656e 7420 666f 7220 6578 6563  is sent for exec
-00009610: 7574 696e 672e 0a20 2020 2023 3a0a 2020  uting..    #:.  
-00009620: 2020 233a 2041 7320 6120 7370 6563 6961    #: As a specia
-00009630: 6c20 6361 7365 2c20 7468 6973 2061 7474  l case, this att
-00009640: 7269 6275 7465 206d 6179 2061 6c73 6f20  ribute may also 
-00009650: 6265 2060 604e 6f6e 6560 602c 2069 6e20  be ``None``, in 
-00009660: 7768 6963 6820 6361 7365 2074 6865 2074  which case the t
-00009670: 6173 6b20 6973 0a20 2020 2023 3a20 2270  ask is.    #: "p
-00009680: 7572 6520 6461 7461 2220 2873 7563 6820  ure data" (such 
-00009690: 6173 2c20 666f 7220 6578 616d 706c 652c  as, for example,
-000096a0: 2061 2070 6965 6365 206f 6620 6461 7461   a piece of data
-000096b0: 206c 6f61 6465 6420 696e 2074 6865 2073   loaded in the s
-000096c0: 6368 6564 756c 6572 2075 7369 6e67 0a20  cheduler using. 
-000096d0: 2020 2023 3a20 3a6d 6574 683a 6043 6c69     #: :meth:`Cli
-000096e0: 656e 742e 7363 6174 7465 7260 292e 2020  ent.scatter`).  
-000096f0: 4120 2270 7572 6520 6461 7461 2220 7461  A "pure data" ta
-00009700: 736b 2063 616e 6e6f 7420 6265 2063 6f6d  sk cannot be com
-00009710: 7075 7465 6420 6167 6169 6e20 6966 2069  puted again if i
-00009720: 7473 0a20 2020 2023 3a20 7661 6c75 6520  ts.    #: value 
-00009730: 6973 206c 6f73 742e 0a20 2020 2072 756e  is lost..    run
-00009740: 5f73 7065 633a 206f 626a 6563 740a 0a20  _spec: object.. 
-00009750: 2020 2023 3a20 5468 6520 7072 696f 7269     #: The priori
-00009760: 7479 2070 726f 7669 6465 7320 6561 6368  ty provides each
-00009770: 2074 6173 6b20 7769 7468 2061 2072 656c   task with a rel
-00009780: 6174 6976 6520 7261 6e6b 696e 6720 7768  ative ranking wh
-00009790: 6963 6820 6973 2075 7365 6420 746f 2062  ich is used to b
-000097a0: 7265 616b 0a20 2020 2023 3a20 7469 6573  reak.    #: ties
-000097b0: 2077 6865 6e20 6d61 6e79 2074 6173 6b73   when many tasks
-000097c0: 2061 7265 2062 6569 6e67 2063 6f6e 7369   are being consi
-000097d0: 6465 7265 6420 666f 7220 6578 6563 7574  dered for execut
-000097e0: 696f 6e2e 0a20 2020 2023 3a0a 2020 2020  ion..    #:.    
-000097f0: 233a 2054 6869 7320 7261 6e6b 696e 6720  #: This ranking 
-00009800: 6973 2067 656e 6572 616c 6c79 2061 2032  is generally a 2
-00009810: 2d69 7465 6d20 7475 706c 652e 2020 5468  -item tuple.  Th
-00009820: 6520 6669 7273 7420 2861 6e64 2064 6f6d  e first (and dom
-00009830: 696e 616e 7429 2069 7465 6d0a 2020 2020  inant) item.    
-00009840: 233a 2063 6f72 7265 7370 6f6e 6473 2074  #: corresponds t
-00009850: 6f20 7768 656e 2069 7420 7761 7320 7375  o when it was su
-00009860: 626d 6974 7465 642e 2020 4765 6e65 7261  bmitted.  Genera
-00009870: 6c6c 792c 2065 6172 6c69 6572 2074 6173  lly, earlier tas
-00009880: 6b73 2074 616b 6520 7072 6563 6564 656e  ks take preceden
-00009890: 6365 2e0a 2020 2020 233a 2054 6865 2073  ce..    #: The s
-000098a0: 6563 6f6e 6420 6974 656d 2069 7320 6465  econd item is de
-000098b0: 7465 726d 696e 6564 2062 7920 7468 6520  termined by the 
-000098c0: 636c 6965 6e74 2c20 616e 6420 6973 2061  client, and is a
-000098d0: 2077 6179 2074 6f20 7072 696f 7269 7469   way to prioriti
-000098e0: 7a65 2074 6173 6b73 0a20 2020 2023 3a20  ze tasks.    #: 
-000098f0: 7769 7468 696e 2061 206c 6172 6765 2067  within a large g
-00009900: 7261 7068 2074 6861 7420 6d61 7920 6265  raph that may be
-00009910: 2069 6d70 6f72 7461 6e74 2c20 7375 6368   important, such
-00009920: 2061 7320 6966 2074 6865 7920 6172 6520   as if they are 
-00009930: 6f6e 2074 6865 2063 7269 7469 6361 6c0a  on the critical.
-00009940: 2020 2020 233a 2070 6174 682c 206f 7220      #: path, or 
-00009950: 676f 6f64 2074 6f20 7275 6e20 696e 206f  good to run in o
-00009960: 7264 6572 2074 6f20 7265 6c65 6173 6520  rder to release 
-00009970: 6d61 6e79 2064 6570 656e 6465 6e63 6965  many dependencie
-00009980: 732e 2020 5468 6973 2069 7320 6578 706c  s.  This is expl
-00009990: 6169 6e65 640a 2020 2020 233a 2066 7572  ained.    #: fur
-000099a0: 7468 6572 2069 6e20 3a64 6f63 3a60 5363  ther in :doc:`Sc
-000099b0: 6865 6475 6c69 6e67 2050 6f6c 6963 7920  heduling Policy 
-000099c0: 3c73 6368 6564 756c 696e 672d 706f 6c69  <scheduling-poli
-000099d0: 6369 6573 3e60 2e0a 2020 2020 7072 696f  cies>`..    prio
-000099e0: 7269 7479 3a20 7475 706c 655b 666c 6f61  rity: tuple[floa
-000099f0: 742c 202e 2e2e 5d20 7c20 4e6f 6e65 0a0a  t, ...] | None..
-00009a00: 2020 2020 2320 4174 7472 6962 7574 6520      # Attribute 
-00009a10: 756e 6465 726c 7969 6e67 2074 6865 2073  underlying the s
-00009a20: 7461 7465 2070 726f 7065 7274 790a 2020  tate property.  
-00009a30: 2020 5f73 7461 7465 3a20 5461 736b 5374    _state: TaskSt
-00009a40: 6174 6553 7461 7465 0a0a 2020 2020 233a  ateState..    #:
-00009a50: 2054 6865 2073 6574 206f 6620 7461 736b   The set of task
-00009a60: 7320 7468 6973 2074 6173 6b20 6465 7065  s this task depe
-00009a70: 6e64 7320 6f6e 2066 6f72 2070 726f 7065  nds on for prope
-00009a80: 7220 6578 6563 7574 696f 6e2e 204f 6e6c  r execution. Onl
-00009a90: 7920 7461 736b 7320 7374 696c 6c0a 2020  y tasks still.  
-00009aa0: 2020 233a 2061 6c69 7665 2061 7265 206c    #: alive are l
-00009ab0: 6973 7465 6420 696e 2074 6869 7320 7365  isted in this se
-00009ac0: 742e 2049 662c 2066 6f72 2077 6861 7465  t. If, for whate
-00009ad0: 7665 7220 7265 6173 6f6e 2c20 7468 6973  ver reason, this
-00009ae0: 2074 6173 6b20 616c 736f 2064 6570 656e   task also depen
-00009af0: 6473 206f 6e0a 2020 2020 233a 2061 2066  ds on.    #: a f
-00009b00: 6f72 676f 7474 656e 2074 6173 6b2c 2074  orgotten task, t
-00009b10: 6865 203a 6174 7472 3a60 6861 735f 6c6f  he :attr:`has_lo
-00009b20: 7374 5f64 6570 656e 6465 6e63 6965 7360  st_dependencies`
-00009b30: 2066 6c61 6720 6973 2073 6574 2e0a 2020   flag is set..  
-00009b40: 2020 233a 0a20 2020 2023 3a20 4120 7461    #:.    #: A ta
-00009b50: 736b 2063 616e 206f 6e6c 7920 6265 2065  sk can only be e
-00009b60: 7865 6375 7465 6420 6f6e 6365 2061 6c6c  xecuted once all
-00009b70: 2069 7473 2064 6570 656e 6465 6e63 6965   its dependencie
-00009b80: 7320 6861 7665 2061 6c72 6561 6479 2062  s have already b
-00009b90: 6565 6e0a 2020 2020 233a 2073 7563 6365  een.    #: succe
-00009ba0: 7373 6675 6c6c 7920 6578 6563 7574 6564  ssfully executed
-00009bb0: 2061 6e64 2068 6176 6520 7468 6569 7220   and have their 
-00009bc0: 7265 7375 6c74 2073 746f 7265 6420 6f6e  result stored on
-00009bd0: 2061 7420 6c65 6173 7420 6f6e 6520 776f   at least one wo
-00009be0: 726b 6572 2e20 5468 6973 0a20 2020 2023  rker. This.    #
-00009bf0: 3a20 6973 2074 7261 636b 6564 2062 7920  : is tracked by 
-00009c00: 7072 6f67 7265 7373 6976 656c 7920 6472  progressively dr
-00009c10: 6169 6e69 6e67 2074 6865 203a 6174 7472  aining the :attr
-00009c20: 3a60 7761 6974 696e 675f 6f6e 6020 7365  :`waiting_on` se
-00009c30: 742e 0a20 2020 2064 6570 656e 6465 6e63  t..    dependenc
-00009c40: 6965 733a 2073 6574 5b54 6173 6b53 7461  ies: set[TaskSta
-00009c50: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
-00009c60: 7365 7420 6f66 2074 6173 6b73 2077 6869  set of tasks whi
-00009c70: 6368 2064 6570 656e 6420 6f6e 2074 6869  ch depend on thi
-00009c80: 7320 7461 736b 2e20 204f 6e6c 7920 7461  s task.  Only ta
-00009c90: 736b 7320 7374 696c 6c20 616c 6976 6520  sks still alive 
-00009ca0: 6172 6520 6c69 7374 6564 2069 6e0a 2020  are listed in.  
-00009cb0: 2020 233a 2074 6869 7320 7365 742e 2054    #: this set. T
-00009cc0: 6869 7320 6973 2074 6865 2072 6576 6572  his is the rever
-00009cd0: 7365 206d 6170 7069 6e67 206f 6620 3a61  se mapping of :a
-00009ce0: 7474 723a 6064 6570 656e 6465 6e63 6965  ttr:`dependencie
-00009cf0: 7360 2e0a 2020 2020 6465 7065 6e64 656e  s`..    dependen
-00009d00: 7473 3a20 7365 745b 5461 736b 5374 6174  ts: set[TaskStat
-00009d10: 655d 0a0a 2020 2020 233a 2057 6865 7468  e]..    #: Wheth
-00009d20: 6572 2061 6e79 206f 6620 7468 6520 6465  er any of the de
-00009d30: 7065 6e64 656e 6369 6573 206f 6620 7468  pendencies of th
-00009d40: 6973 2074 6173 6b20 6861 7320 6265 656e  is task has been
-00009d50: 2066 6f72 676f 7474 656e 2e20 466f 7220   forgotten. For 
-00009d60: 6d65 6d6f 7279 0a20 2020 2023 3a20 636f  memory.    #: co
-00009d70: 6e73 756d 7074 696f 6e20 7265 6173 6f6e  nsumption reason
-00009d80: 732c 2066 6f72 676f 7474 656e 2074 6173  s, forgotten tas
-00009d90: 6b73 2061 7265 206e 6f74 206b 6570 7420  ks are not kept 
-00009da0: 696e 206d 656d 6f72 7920 6576 656e 2074  in memory even t
-00009db0: 686f 7567 6820 7468 6579 206d 6179 0a20  hough they may. 
-00009dc0: 2020 2023 3a20 6861 7665 2064 6570 656e     #: have depen
-00009dd0: 6465 6e74 2074 6173 6b73 2e20 2057 6865  dent tasks.  Whe
-00009de0: 6e20 6120 7461 736b 2069 7320 666f 7267  n a task is forg
-00009df0: 6f74 7465 6e2c 2074 6865 7265 666f 7265  otten, therefore
-00009e00: 2c20 6561 6368 206f 6620 6974 730a 2020  , each of its.  
-00009e10: 2020 233a 2064 6570 656e 6465 6e74 7320    #: dependents 
-00009e20: 6861 7320 7468 6569 7220 3a61 7474 723a  has their :attr:
-00009e30: 6068 6173 5f6c 6f73 745f 6465 7065 6e64  `has_lost_depend
-00009e40: 656e 6369 6573 6020 6174 7472 6962 7574  encies` attribut
-00009e50: 6520 7365 7420 746f 2060 6054 7275 6560  e set to ``True`
-00009e60: 602e 0a20 2020 2023 3a0a 2020 2020 233a  `..    #:.    #:
-00009e70: 2049 6620 3a61 7474 723a 6068 6173 5f6c   If :attr:`has_l
-00009e80: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-00009e90: 6020 6973 2074 7275 652c 2074 6869 7320  ` is true, this 
-00009ea0: 7461 736b 2063 616e 6e6f 7420 676f 2069  task cannot go i
-00009eb0: 6e74 6f20 7468 650a 2020 2020 233a 2022  nto the.    #: "
-00009ec0: 7072 6f63 6573 7369 6e67 2220 7374 6174  processing" stat
-00009ed0: 6520 616e 796d 6f72 652e 0a20 2020 2068  e anymore..    h
-00009ee0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-00009ef0: 6369 6573 3a20 626f 6f6c 0a0a 2020 2020  cies: bool..    
-00009f00: 233a 2054 6865 2073 6574 206f 6620 7461  #: The set of ta
-00009f10: 736b 7320 7468 6973 2074 6173 6b20 6973  sks this task is
-00009f20: 2077 6169 7469 6e67 206f 6e20 2a62 6566   waiting on *bef
-00009f30: 6f72 652a 2069 7420 6361 6e20 6265 2065  ore* it can be e
-00009f40: 7865 6375 7465 642e 2054 6869 7320 6973  xecuted. This is
-00009f50: 0a20 2020 2023 3a20 616c 7761 7973 2061  .    #: always a
-00009f60: 2073 7562 7365 7420 6f66 203a 6174 7472   subset of :attr
-00009f70: 3a60 6465 7065 6e64 656e 6369 6573 602e  :`dependencies`.
-00009f80: 2020 4561 6368 2074 696d 6520 6f6e 6520    Each time one 
-00009f90: 6f66 2074 6865 2064 6570 656e 6465 6e63  of the dependenc
-00009fa0: 6965 7320 6861 730a 2020 2020 233a 2066  ies has.    #: f
-00009fb0: 696e 6973 6865 6420 7072 6f63 6573 7369  inished processi
-00009fc0: 6e67 2c20 6974 2069 7320 7265 6d6f 7665  ng, it is remove
-00009fd0: 6420 6672 6f6d 2074 6865 203a 6174 7472  d from the :attr
-00009fe0: 3a60 7761 6974 696e 675f 6f6e 6020 7365  :`waiting_on` se
-00009ff0: 742e 0a20 2020 2023 3a0a 2020 2020 233a  t..    #:.    #:
-0000a000: 204f 6e63 6520 3a61 7474 723a 6077 6169   Once :attr:`wai
-0000a010: 7469 6e67 5f6f 6e60 2062 6563 6f6d 6573  ting_on` becomes
-0000a020: 2065 6d70 7479 2c20 7468 6973 2074 6173   empty, this tas
-0000a030: 6b20 6361 6e20 6d6f 7665 2066 726f 6d20  k can move from 
-0000a040: 7468 6520 2277 6169 7469 6e67 220a 2020  the "waiting".  
-0000a050: 2020 233a 2073 7461 7465 2074 6f20 7468    #: state to th
-0000a060: 6520 2270 726f 6365 7373 696e 6722 2073  e "processing" s
-0000a070: 7461 7465 2028 756e 6c65 7373 206f 6e65  tate (unless one
-0000a080: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
-0000a090: 6369 6573 2065 7272 6f72 6564 206f 7574  cies errored out
-0000a0a0: 2c20 696e 0a20 2020 2023 3a20 7768 6963  , in.    #: whic
-0000a0b0: 6820 6361 7365 2074 6869 7320 7461 736b  h case this task
-0000a0c0: 2069 7320 696e 7374 6561 6420 6d61 726b   is instead mark
-0000a0d0: 6564 2022 6572 7265 6422 292e 0a20 2020  ed "erred")..   
-0000a0e0: 2077 6169 7469 6e67 5f6f 6e3a 2073 6574   waiting_on: set
-0000a0f0: 5b54 6173 6b53 7461 7465 5d0a 0a20 2020  [TaskState]..   
-0000a100: 2023 3a20 5468 6520 7365 7420 6f66 2074   #: The set of t
-0000a110: 6173 6b73 2077 6869 6368 206e 6565 6420  asks which need 
-0000a120: 7468 6973 2074 6173 6b20 746f 2072 656d  this task to rem
-0000a130: 6169 6e20 616c 6976 652e 2020 5468 6973  ain alive.  This
-0000a140: 2069 7320 616c 7761 7973 2061 2073 7562   is always a sub
-0000a150: 7365 740a 2020 2020 233a 206f 6620 3a61  set.    #: of :a
-0000a160: 7474 723a 6064 6570 656e 6465 6e74 7360  ttr:`dependents`
-0000a170: 2e20 2045 6163 6820 7469 6d65 206f 6e65  .  Each time one
-0000a180: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
-0000a190: 7473 2068 6173 2066 696e 6973 6865 6420  ts has finished 
-0000a1a0: 7072 6f63 6573 7369 6e67 2c0a 2020 2020  processing,.    
-0000a1b0: 233a 2069 7420 6973 2072 656d 6f76 6564  #: it is removed
-0000a1c0: 2066 726f 6d20 7468 6520 3a61 7474 723a   from the :attr:
-0000a1d0: 6077 6169 7465 7273 6020 7365 742e 0a20  `waiters` set.. 
-0000a1e0: 2020 2023 3a0a 2020 2020 233a 204f 6e63     #:.    #: Onc
-0000a1f0: 6520 626f 7468 203a 6174 7472 3a60 7761  e both :attr:`wa
-0000a200: 6974 6572 7360 2061 6e64 203a 6174 7472  iters` and :attr
-0000a210: 3a60 7768 6f5f 7761 6e74 7360 2062 6563  :`who_wants` bec
-0000a220: 6f6d 6520 656d 7074 792c 2074 6869 7320  ome empty, this 
-0000a230: 7461 736b 2063 616e 2062 650a 2020 2020  task can be.    
-0000a240: 233a 2072 656c 6561 7365 6420 2869 6620  #: released (if 
-0000a250: 6974 2068 6173 2061 206e 6f6e 2d65 6d70  it has a non-emp
-0000a260: 7479 203a 6174 7472 3a60 7275 6e5f 7370  ty :attr:`run_sp
-0000a270: 6563 6029 206f 7220 666f 7267 6f74 7465  ec`) or forgotte
-0000a280: 6e20 286f 7468 6572 7769 7365 2920 6279  n (otherwise) by
-0000a290: 2074 6865 0a20 2020 2023 3a20 7363 6865   the.    #: sche
-0000a2a0: 6475 6c65 722c 2061 6e64 2062 7920 616e  duler, and by an
-0000a2b0: 7920 776f 726b 6572 7320 696e 203a 6174  y workers in :at
-0000a2c0: 7472 3a60 7768 6f5f 6861 7360 2e0a 2020  tr:`who_has`..  
-0000a2d0: 2020 233a 0a20 2020 2023 3a20 2e2e 206e    #:.    #: .. n
-0000a2e0: 6f74 653a 3a0a 2020 2020 233a 2020 2020  ote::.    #:    
-0000a2f0: 436f 756e 7465 722d 696e 7475 6974 6976  Counter-intuitiv
-0000a300: 656c 792c 203a 6174 7472 3a60 7761 6974  ely, :attr:`wait
-0000a310: 696e 675f 6f6e 6020 616e 6420 3a61 7474  ing_on` and :att
-0000a320: 723a 6077 6169 7465 7273 6020 6172 6520  r:`waiters` are 
-0000a330: 6e6f 7420 7265 7665 7273 650a 2020 2020  not reverse.    
-0000a340: 233a 2020 2020 6d61 7070 696e 6773 206f  #:    mappings o
-0000a350: 6620 6561 6368 206f 7468 6572 2e0a 2020  f each other..  
-0000a360: 2020 7761 6974 6572 733a 2073 6574 5b54    waiters: set[T
-0000a370: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
-0000a380: 3a20 5468 6520 7365 7420 6f66 2063 6c69  : The set of cli
-0000a390: 656e 7473 2077 686f 2077 616e 7420 7468  ents who want th
-0000a3a0: 6520 7265 7375 6c74 206f 6620 7468 6973  e result of this
-0000a3b0: 2074 6173 6b20 746f 2072 656d 6169 6e20   task to remain 
-0000a3c0: 616c 6976 652e 0a20 2020 2023 3a20 5468  alive..    #: Th
-0000a3d0: 6973 2069 7320 7468 6520 7265 7665 7273  is is the revers
-0000a3e0: 6520 6d61 7070 696e 6720 6f66 203a 6174  e mapping of :at
-0000a3f0: 7472 3a60 436c 6965 6e74 5374 6174 652e  tr:`ClientState.
-0000a400: 7761 6e74 735f 7768 6174 602e 0a20 2020  wants_what`..   
-0000a410: 2023 3a0a 2020 2020 233a 2057 6865 6e20   #:.    #: When 
-0000a420: 6120 636c 6965 6e74 2073 7562 6d69 7473  a client submits
-0000a430: 2061 2067 7261 7068 2074 6f20 7468 6520   a graph to the 
-0000a440: 7363 6865 6475 6c65 7220 6974 2061 6c73  scheduler it als
-0000a450: 6f20 7370 6563 6966 6965 7320 7768 6963  o specifies whic
-0000a460: 6820 6f75 7470 7574 0a20 2020 2023 3a20  h output.    #: 
-0000a470: 7461 736b 7320 6974 2064 6573 6972 6573  tasks it desires
-0000a480: 2c20 7375 6368 2074 6861 7420 7468 6569  , such that thei
-0000a490: 7220 7265 7375 6c74 7320 6172 6520 6e6f  r results are no
-0000a4a0: 7420 7265 6c65 6173 6564 2066 726f 6d20  t released from 
-0000a4b0: 6d65 6d6f 7279 2e0a 2020 2020 233a 0a20  memory..    #:. 
-0000a4c0: 2020 2023 3a20 4f6e 6365 2061 2074 6173     #: Once a tas
-0000a4d0: 6b20 6861 7320 6669 6e69 7368 6564 2065  k has finished e
-0000a4e0: 7865 6375 7469 6e67 2028 692e 652e 206d  xecuting (i.e. m
-0000a4f0: 6f76 6573 2069 6e74 6f20 7468 6520 226d  oves into the "m
-0000a500: 656d 6f72 7922 206f 7220 2265 7272 6564  emory" or "erred
-0000a510: 220a 2020 2020 233a 2073 7461 7465 292c  ".    #: state),
-0000a520: 2074 6865 2063 6c69 656e 7473 2069 6e20   the clients in 
-0000a530: 3a61 7474 723a 6077 686f 5f77 616e 7473  :attr:`who_wants
-0000a540: 6020 6172 6520 6e6f 7469 6669 6564 2e0a  ` are notified..
-0000a550: 2020 2020 233a 0a20 2020 2023 3a20 4f6e      #:.    #: On
-0000a560: 6365 2062 6f74 6820 3a61 7474 723a 6077  ce both :attr:`w
-0000a570: 6169 7465 7273 6020 616e 6420 3a61 7474  aiters` and :att
-0000a580: 723a 6077 686f 5f77 616e 7473 6020 6265  r:`who_wants` be
-0000a590: 636f 6d65 2065 6d70 7479 2c20 7468 6973  come empty, this
-0000a5a0: 2074 6173 6b20 6361 6e20 6265 0a20 2020   task can be.   
-0000a5b0: 2023 3a20 7265 6c65 6173 6564 2028 6966   #: released (if
-0000a5c0: 2069 7420 6861 7320 6120 6e6f 6e2d 656d   it has a non-em
-0000a5d0: 7074 7920 3a61 7474 723a 6072 756e 5f73  pty :attr:`run_s
-0000a5e0: 7065 6360 2920 6f72 2066 6f72 676f 7474  pec`) or forgott
-0000a5f0: 656e 2028 6f74 6865 7277 6973 6529 2062  en (otherwise) b
-0000a600: 7920 7468 650a 2020 2020 233a 2073 6368  y the.    #: sch
-0000a610: 6564 756c 6572 2c20 616e 6420 6279 2061  eduler, and by a
-0000a620: 6e79 2077 6f72 6b65 7273 2069 6e20 3a61  ny workers in :a
-0000a630: 7474 723a 6077 686f 5f68 6173 602e 0a20  ttr:`who_has`.. 
-0000a640: 2020 2077 686f 5f77 616e 7473 3a20 7365     who_wants: se
-0000a650: 745b 436c 6965 6e74 5374 6174 655d 0a0a  t[ClientState]..
-0000a660: 2020 2020 233a 2054 6865 2073 6574 206f      #: The set o
-0000a670: 6620 776f 726b 6572 7320 7768 6f20 6861  f workers who ha
-0000a680: 7665 2074 6869 7320 7461 736b 2773 2072  ve this task's r
-0000a690: 6573 756c 7420 696e 206d 656d 6f72 792e  esult in memory.
-0000a6a0: 2049 7420 6973 206e 6f6e 2d65 6d70 7479   It is non-empty
-0000a6b0: 2069 6666 2074 6865 0a20 2020 2023 3a20   iff the.    #: 
-0000a6c0: 7461 736b 2069 7320 696e 2074 6865 2022  task is in the "
-0000a6d0: 6d65 6d6f 7279 2220 7374 6174 652e 2020  memory" state.  
-0000a6e0: 5468 6572 6520 6361 6e20 6265 206d 6f72  There can be mor
-0000a6f0: 6520 7468 616e 206f 6e65 2077 6f72 6b65  e than one worke
-0000a700: 7220 696e 2074 6869 7320 7365 7420 6966  r in this set if
-0000a710: 2c0a 2020 2020 233a 2066 6f72 2065 7861  ,.    #: for exa
-0000a720: 6d70 6c65 2c20 3a6d 6574 683a 6043 6c69  mple, :meth:`Cli
-0000a730: 656e 742e 7363 6174 7465 7260 206f 7220  ent.scatter` or 
-0000a740: 3a6d 6574 683a 6043 6c69 656e 742e 7265  :meth:`Client.re
-0000a750: 706c 6963 6174 6560 2077 6173 2075 7365  plicate` was use
-0000a760: 642e 0a20 2020 2023 3a0a 2020 2020 233a  d..    #:.    #:
-0000a770: 2054 6869 7320 6973 2074 6865 2072 6576   This is the rev
-0000a780: 6572 7365 206d 6170 7069 6e67 206f 6620  erse mapping of 
-0000a790: 3a61 7474 723a 6057 6f72 6b65 7253 7461  :attr:`WorkerSta
-0000a7a0: 7465 2e68 6173 5f77 6861 7460 2e0a 2020  te.has_what`..  
-0000a7b0: 2020 7768 6f5f 6861 733a 2073 6574 5b57    who_has: set[W
-0000a7c0: 6f72 6b65 7253 7461 7465 5d0a 0a20 2020  orkerState]..   
-0000a7d0: 2023 3a20 4966 2074 6869 7320 7461 736b   #: If this task
-0000a7e0: 2069 7320 696e 2074 6865 2022 7072 6f63   is in the "proc
-0000a7f0: 6573 7369 6e67 2220 7374 6174 652c 2077  essing" state, w
-0000a800: 6869 6368 2077 6f72 6b65 7220 6973 2063  hich worker is c
-0000a810: 7572 7265 6e74 6c79 2070 726f 6365 7373  urrently process
-0000a820: 696e 670a 2020 2020 233a 2069 742e 2054  ing.    #: it. T
-0000a830: 6869 7320 6174 7472 6962 7574 6520 6973  his attribute is
-0000a840: 206b 6570 7420 696e 2073 796e 6320 7769   kept in sync wi
-0000a850: 7468 203a 6174 7472 3a60 576f 726b 6572  th :attr:`Worker
-0000a860: 5374 6174 652e 7072 6f63 6573 7369 6e67  State.processing
-0000a870: 602e 0a20 2020 2070 726f 6365 7373 696e  `..    processin
-0000a880: 675f 6f6e 3a20 576f 726b 6572 5374 6174  g_on: WorkerStat
-0000a890: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
-0000a8a0: 2054 6865 206e 756d 6265 7220 6f66 2074   The number of t
-0000a8b0: 696d 6573 2074 6869 7320 7461 736b 2063  imes this task c
-0000a8c0: 616e 2061 7574 6f6d 6174 6963 616c 6c79  an automatically
-0000a8d0: 2062 6520 7265 7472 6965 6420 696e 2063   be retried in c
-0000a8e0: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
-0000a8f0: 2020 2020 233a 2049 6620 6120 7461 736b      #: If a task
-0000a900: 2066 6169 6c73 2065 7865 6375 7469 6e67   fails executing
-0000a910: 2028 7468 6520 776f 726b 6572 2072 6574   (the worker ret
-0000a920: 7572 6e73 2077 6974 6820 616e 2065 7272  urns with an err
-0000a930: 6f72 292c 2069 7473 203a 6174 7472 3a60  or), its :attr:`
-0000a940: 7265 7472 6965 7360 0a20 2020 2023 3a20  retries`.    #: 
-0000a950: 6174 7472 6962 7574 6520 6973 2063 6865  attribute is che
-0000a960: 636b 6564 2e20 4966 2069 7420 6973 2065  cked. If it is e
-0000a970: 7175 616c 2074 6f20 302c 2074 6865 2074  qual to 0, the t
-0000a980: 6173 6b20 6973 206d 6172 6b65 6420 2265  ask is marked "e
-0000a990: 7272 6564 222e 2049 6620 6974 2069 730a  rred". If it is.
-0000a9a0: 2020 2020 233a 2067 7265 6174 6572 2074      #: greater t
-0000a9b0: 6861 6e20 302c 2074 6865 203a 6174 7472  han 0, the :attr
-0000a9c0: 3a60 7265 7472 6965 7360 2061 7474 7269  :`retries` attri
-0000a9d0: 6275 7465 2069 7320 6465 6372 656d 656e  bute is decremen
-0000a9e0: 7465 6420 616e 6420 6578 6563 7574 696f  ted and executio
-0000a9f0: 6e20 6973 0a20 2020 2023 3a20 6174 7465  n is.    #: atte
-0000aa00: 6d70 7465 6420 6167 6169 6e2e 0a20 2020  mpted again..   
-0000aa10: 2072 6574 7269 6573 3a20 696e 740a 0a20   retries: int.. 
-0000aa20: 2020 2023 3a20 5468 6520 6e75 6d62 6572     #: The number
-0000aa30: 206f 6620 6279 7465 732c 2061 7320 6465   of bytes, as de
-0000aa40: 7465 726d 696e 6564 2062 7920 6060 7369  termined by ``si
-0000aa50: 7a65 6f66 6060 2c20 6f66 2074 6865 2072  zeof``, of the r
-0000aa60: 6573 756c 7420 6f66 2061 2066 696e 6973  esult of a finis
-0000aa70: 6865 640a 2020 2020 233a 2074 6173 6b2e  hed.    #: task.
-0000aa80: 2054 6869 7320 6e75 6d62 6572 2069 7320   This number is 
-0000aa90: 7573 6564 2066 6f72 2064 6961 676e 6f73  used for diagnos
-0000aaa0: 7469 6373 2061 6e64 2074 6f20 6865 6c70  tics and to help
-0000aab0: 2070 7269 6f72 6974 697a 6520 776f 726b   prioritize work
-0000aac0: 2e0a 2020 2020 233a 2053 6574 2074 6f20  ..    #: Set to 
-0000aad0: 2d31 2066 6f72 2075 6e66 696e 6973 6865  -1 for unfinishe
-0000aae0: 6420 7461 736b 732e 0a20 2020 206e 6279  d tasks..    nby
-0000aaf0: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
-0000ab00: 2054 6865 2074 7970 6520 6f66 2074 6865   The type of the
-0000ab10: 206f 626a 6563 7420 6173 2061 2073 7472   object as a str
-0000ab20: 696e 672e 204f 6e6c 7920 7072 6573 656e  ing. Only presen
-0000ab30: 7420 666f 7220 7461 736b 7320 7468 6174  t for tasks that
-0000ab40: 2068 6176 6520 6265 656e 0a20 2020 2023   have been.    #
-0000ab50: 3a20 636f 6d70 7574 6564 2e0a 2020 2020  : computed..    
-0000ab60: 7479 7065 3a20 7374 720a 0a20 2020 2023  type: str..    #
-0000ab70: 3a20 4966 2074 6869 7320 7461 736b 2066  : If this task f
-0000ab80: 6169 6c65 6420 6578 6563 7574 696e 672c  ailed executing,
-0000ab90: 2074 6865 2065 7863 6570 7469 6f6e 206f   the exception o
-0000aba0: 626a 6563 7420 6973 2073 746f 7265 6420  bject is stored 
-0000abb0: 6865 7265 2e0a 2020 2020 6578 6365 7074  here..    except
-0000abc0: 696f 6e3a 2053 6572 6961 6c69 7a65 6420  ion: Serialized 
-0000abd0: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2049  | None..    #: I
-0000abe0: 6620 7468 6973 2074 6173 6b20 6661 696c  f this task fail
-0000abf0: 6564 2065 7865 6375 7469 6e67 2c20 7468  ed executing, th
-0000ac00: 6520 7472 6163 6562 6163 6b20 6f62 6a65  e traceback obje
-0000ac10: 6374 2069 7320 7374 6f72 6564 2068 6572  ct is stored her
-0000ac20: 652e 0a20 2020 2074 7261 6365 6261 636b  e..    traceback
-0000ac30: 3a20 5365 7269 616c 697a 6564 207c 204e  : Serialized | N
-0000ac40: 6f6e 650a 0a20 2020 2023 3a20 7374 7269  one..    #: stri
-0000ac50: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
-0000ac60: 6e20 6f66 2065 7863 6570 7469 6f6e 0a20  n of exception. 
-0000ac70: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-0000ac80: 743a 2073 7472 0a0a 2020 2020 233a 2073  t: str..    #: s
-0000ac90: 7472 696e 6720 7265 7072 6573 656e 7461  tring representa
-0000aca0: 7469 6f6e 206f 6620 7472 6163 6562 6163  tion of tracebac
-0000acb0: 6b0a 2020 2020 7472 6163 6562 6163 6b5f  k.    traceback_
-0000acc0: 7465 7874 3a20 7374 720a 0a20 2020 2023  text: str..    #
-0000acd0: 3a20 4966 2074 6869 7320 7461 736b 206f  : If this task o
-0000ace0: 7220 6f6e 6520 6f66 2069 7473 2064 6570  r one of its dep
-0000acf0: 656e 6465 6e63 6965 7320 6661 696c 6564  endencies failed
-0000ad00: 2065 7865 6375 7469 6e67 2c20 7468 6520   executing, the 
-0000ad10: 6661 696c 6564 2074 6173 6b20 6973 0a20  failed task is. 
-0000ad20: 2020 2023 3a20 7374 6f72 6564 2068 6572     #: stored her
-0000ad30: 6520 2870 6f73 7369 626c 7920 6974 7365  e (possibly itse
-0000ad40: 6c66 292e 0a20 2020 2065 7863 6570 7469  lf)..    excepti
-0000ad50: 6f6e 5f62 6c61 6d65 3a20 5461 736b 5374  on_blame: TaskSt
-0000ad60: 6174 6520 7c20 4e6f 6e65 0a0a 2020 2020  ate | None..    
-0000ad70: 233a 2057 6f72 6b65 7220 6164 6472 6573  #: Worker addres
-0000ad80: 7365 7320 6f6e 2077 6869 6368 2065 7272  ses on which err
-0000ad90: 6f72 7320 6170 7065 6172 6564 2c20 6361  ors appeared, ca
-0000ada0: 7573 696e 6720 7468 6973 2074 6173 6b20  using this task 
-0000adb0: 746f 2062 6520 696e 2061 6e20 6572 726f  to be in an erro
-0000adc0: 720a 2020 2020 233a 2073 7461 7465 2e0a  r.    #: state..
-0000add0: 2020 2020 6572 7265 645f 6f6e 3a20 7365      erred_on: se
-0000ade0: 745b 7374 725d 0a0a 2020 2020 233a 2054  t[str]..    #: T
-0000adf0: 6865 206e 756d 6265 7220 6f66 2074 696d  he number of tim
-0000ae00: 6573 2074 6869 7320 7461 736b 2068 6173  es this task has
-0000ae10: 2062 6565 6e20 696e 766f 6c76 6564 2069   been involved i
-0000ae20: 6e20 6120 776f 726b 6572 2064 6561 7468  n a worker death
-0000ae30: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-0000ae40: 536f 6d65 2074 6173 6b73 206d 6179 2063  Some tasks may c
-0000ae50: 6175 7365 2077 6f72 6b65 7273 2074 6f20  ause workers to 
-0000ae60: 6469 6520 2873 7563 6820 6173 2063 616c  die (such as cal
-0000ae70: 6c69 6e67 2060 606f 732e 5f65 7869 7428  ling ``os._exit(
-0000ae80: 3029 6060 292e 2057 6865 6e20 610a 2020  0)``). When a.  
-0000ae90: 2020 233a 2077 6f72 6b65 7220 6469 6573    #: worker dies
-0000aea0: 2c20 616c 6c20 6f66 2074 6865 2074 6173  , all of the tas
-0000aeb0: 6b73 206f 6e20 7468 6174 2077 6f72 6b65  ks on that worke
-0000aec0: 7220 6172 6520 7265 6173 7369 676e 6564  r are reassigned
-0000aed0: 2074 6f20 6f74 6865 7273 2e20 5468 6973   to others. This
-0000aee0: 0a20 2020 2023 3a20 636f 6d62 696e 6174  .    #: combinat
-0000aef0: 696f 6e20 6f66 2062 6568 6176 696f 7273  ion of behaviors
-0000af00: 2063 616e 2063 6175 7365 2061 2062 6164   can cause a bad
-0000af10: 2074 6173 6b20 746f 2063 6174 6173 7472   task to catastr
-0000af20: 6f70 6869 6361 6c6c 7920 6465 7374 726f  ophically destro
-0000af30: 7920 616c 6c0a 2020 2020 233a 2077 6f72  y all.    #: wor
-0000af40: 6b65 7273 206f 6e20 7468 6520 636c 7573  kers on the clus
-0000af50: 7465 722c 206f 6e65 2061 6674 6572 2061  ter, one after a
-0000af60: 6e6f 7468 6572 2e20 5768 656e 6576 6572  nother. Whenever
-0000af70: 2061 2077 6f72 6b65 7220 6469 6573 2c20   a worker dies, 
-0000af80: 7765 206d 6172 6b20 6561 6368 0a20 2020  we mark each.   
-0000af90: 2023 3a20 7461 736b 2063 7572 7265 6e74   #: task current
-0000afa0: 6c79 2070 726f 6365 7373 696e 6720 6f6e  ly processing on
-0000afb0: 2074 6861 7420 776f 726b 6572 2028 6173   that worker (as
-0000afc0: 2072 6563 6f72 6465 6420 6279 0a20 2020   recorded by.   
-0000afd0: 2023 3a20 3a61 7474 723a 6057 6f72 6b65   #: :attr:`Worke
-0000afe0: 7253 7461 7465 2e70 726f 6365 7373 696e  rState.processin
-0000aff0: 6760 2920 6173 2073 7573 7069 6369 6f75  g`) as suspiciou
-0000b000: 732e 2049 6620 6120 7461 736b 2069 7320  s. If a task is 
-0000b010: 696e 766f 6c76 6564 2069 6e20 7468 7265  involved in thre
-0000b020: 650a 2020 2020 233a 2064 6561 7468 7320  e.    #: deaths 
-0000b030: 286f 7220 736f 6d65 206f 7468 6572 2066  (or some other f
-0000b040: 6978 6564 2063 6f6e 7374 616e 7429 2074  ixed constant) t
-0000b050: 6865 6e20 7765 206d 6172 6b20 7468 6520  hen we mark the 
-0000b060: 7461 736b 2061 7320 6060 6572 7265 6460  task as ``erred`
-0000b070: 602e 0a20 2020 2073 7573 7069 6369 6f75  `..    suspiciou
-0000b080: 733a 2069 6e74 0a0a 2020 2020 233a 2041  s: int..    #: A
-0000b090: 2073 6574 206f 6620 686f 7374 6e61 6d65   set of hostname
-0000b0a0: 7320 7768 6572 6520 7468 6973 2074 6173  s where this tas
-0000b0b0: 6b20 6361 6e20 6265 2072 756e 2028 6f72  k can be run (or
-0000b0c0: 2060 604e 6f6e 6560 6020 6966 2065 6d70   ``None`` if emp
-0000b0d0: 7479 292e 2055 7375 616c 6c79 0a20 2020  ty). Usually.   
-0000b0e0: 2023 3a20 7468 6973 2069 7320 656d 7074   #: this is empt
-0000b0f0: 7920 756e 6c65 7373 2074 6865 2074 6173  y unless the tas
-0000b100: 6b20 6861 7320 6265 656e 2073 7065 6369  k has been speci
-0000b110: 6669 6361 6c6c 7920 7265 7374 7269 6374  fically restrict
-0000b120: 6564 2074 6f20 6f6e 6c79 2072 756e 206f  ed to only run o
-0000b130: 6e0a 2020 2020 233a 2063 6572 7461 696e  n.    #: certain
-0000b140: 2068 6f73 7473 2e20 4120 686f 7374 6e61   hosts. A hostna
-0000b150: 6d65 206d 6179 2063 6f72 7265 7370 6f6e  me may correspon
-0000b160: 6420 746f 206f 6e65 206f 7220 7365 7665  d to one or seve
-0000b170: 7261 6c20 636f 6e6e 6563 7465 6420 776f  ral connected wo
-0000b180: 726b 6572 732e 0a20 2020 2068 6f73 745f  rkers..    host_
-0000b190: 7265 7374 7269 6374 696f 6e73 3a20 7365  restrictions: se
-0000b1a0: 745b 7374 725d 0a0a 2020 2020 233a 2041  t[str]..    #: A
-0000b1b0: 2073 6574 206f 6620 636f 6d70 6c65 7465   set of complete
-0000b1c0: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
-0000b1d0: 7320 7768 6572 6520 7468 6973 2063 616e  s where this can
-0000b1e0: 2062 6520 7275 6e20 286f 7220 6060 4e6f   be run (or ``No
-0000b1f0: 6e65 6060 2069 6620 656d 7074 7929 2e0a  ne`` if empty)..
-0000b200: 2020 2020 233a 2055 7375 616c 6c79 2074      #: Usually t
-0000b210: 6869 7320 6973 2065 6d70 7479 2075 6e6c  his is empty unl
-0000b220: 6573 7320 7468 6520 7461 736b 2068 6173  ess the task has
-0000b230: 2062 6565 6e20 7370 6563 6966 6963 616c   been specifical
-0000b240: 6c79 2072 6573 7472 6963 7465 6420 746f  ly restricted to
-0000b250: 206f 6e6c 790a 2020 2020 233a 2072 756e   only.    #: run
-0000b260: 206f 6e20 6365 7274 6169 6e20 776f 726b   on certain work
-0000b270: 6572 732e 0a20 2020 2023 3a20 4e6f 7465  ers..    #: Note
-0000b280: 2074 6869 7320 6973 2074 7261 636b 696e   this is trackin
-0000b290: 6720 776f 726b 6572 2061 6464 7265 7373  g worker address
-0000b2a0: 6573 2c20 6e6f 7420 776f 726b 6572 2073  es, not worker s
-0000b2b0: 7461 7465 732c 2073 696e 6365 2074 6865  tates, since the
-0000b2c0: 2073 7065 6369 6669 630a 2020 2020 233a   specific.    #:
-0000b2d0: 2077 6f72 6b65 7273 206d 6179 206e 6f74   workers may not
-0000b2e0: 2062 6520 636f 6e6e 6563 7465 6420 6174   be connected at
-0000b2f0: 2074 6869 7320 7469 6d65 2e0a 2020 2020   this time..    
-0000b300: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
-0000b310: 6f6e 733a 2073 6574 5b73 7472 5d0a 0a20  ons: set[str].. 
-0000b320: 2020 2023 3a20 5265 736f 7572 6365 7320     #: Resources 
-0000b330: 7265 7175 6972 6564 2062 7920 7468 6973  required by this
-0000b340: 2074 6173 6b2c 2073 7563 6820 6173 2060   task, such as `
-0000b350: 607b 2767 7075 273a 2031 7d60 6020 6f72  `{'gpu': 1}`` or
-0000b360: 2060 607b 276d 656d 6f72 7927 3a20 3165   ``{'memory': 1e
-0000b370: 397d 6060 0a20 2020 2023 3a20 5468 6573  9}``.    #: Thes
-0000b380: 6520 6172 6520 7573 6572 2d64 6566 696e  e are user-defin
-0000b390: 6564 206e 616d 6573 2061 6e64 2061 7265  ed names and are
-0000b3a0: 206d 6174 6368 6564 2061 6761 696e 7374   matched against
-0000b3b0: 2074 6865 203a 2063 6f6e 7465 6e74 7320   the : contents 
-0000b3c0: 6f66 2065 6163 680a 2020 2020 233a 203a  of each.    #: :
-0000b3d0: 6174 7472 3a60 576f 726b 6572 5374 6174  attr:`WorkerStat
-0000b3e0: 652e 7265 736f 7572 6365 7360 2064 6963  e.resources` dic
-0000b3f0: 7469 6f6e 6172 792e 0a20 2020 2072 6573  tionary..    res
-0000b400: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0000b410: 6e73 3a20 6469 6374 5b73 7472 2c20 666c  ns: dict[str, fl
-0000b420: 6f61 745d 0a0a 2020 2020 233a 2046 616c  oat]..    #: Fal
-0000b430: 7365 0a20 2020 2023 3a20 2020 2020 4561  se.    #:     Ea
-0000b440: 6368 206f 6620 3a61 7474 723a 6068 6f73  ch of :attr:`hos
-0000b450: 745f 7265 7374 7269 6374 696f 6e73 602c  t_restrictions`,
-0000b460: 203a 6174 7472 3a60 776f 726b 6572 5f72   :attr:`worker_r
-0000b470: 6573 7472 6963 7469 6f6e 7360 2061 6e64  estrictions` and
-0000b480: 0a20 2020 2023 3a20 2020 2020 3a61 7474  .    #:     :att
-0000b490: 723a 6072 6573 6f75 7263 655f 7265 7374  r:`resource_rest
-0000b4a0: 7269 6374 696f 6e73 6020 6973 2061 2068  rictions` is a h
-0000b4b0: 6172 6420 636f 6e73 7472 6169 6e74 3a20  ard constraint: 
-0000b4c0: 6966 206e 6f20 776f 726b 6572 2069 7320  if no worker is 
-0000b4d0: 6176 6169 6c61 626c 650a 2020 2020 233a  available.    #:
-0000b4e0: 2020 2020 2073 6174 6973 6679 696e 6720       satisfying 
-0000b4f0: 7468 6f73 6520 7265 7374 7269 6374 696f  those restrictio
-0000b500: 6e73 2c20 7468 6520 7461 736b 2063 616e  ns, the task can
-0000b510: 6e6f 7420 676f 2069 6e74 6f20 7468 6520  not go into the 
-0000b520: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
-0000b530: 7465 0a20 2020 2023 3a20 2020 2020 616e  te.    #:     an
-0000b540: 6420 7769 6c6c 2069 6e73 7465 6164 2067  d will instead g
-0000b550: 6f20 696e 746f 2074 6865 2022 6e6f 2d77  o into the "no-w
-0000b560: 6f72 6b65 7222 2073 7461 7465 2e0a 2020  orker" state..  
-0000b570: 2020 233a 2054 7275 650a 2020 2020 233a    #: True.    #:
-0000b580: 2020 2020 2054 6865 2061 626f 7665 2072       The above r
-0000b590: 6573 7472 6963 7469 6f6e 7320 6172 6520  estrictions are 
-0000b5a0: 6d65 7265 2070 7265 6665 7265 6e63 6573  mere preferences
-0000b5b0: 3a20 6966 206e 6f20 776f 726b 6572 2069  : if no worker i
-0000b5c0: 7320 6176 6169 6c61 626c 650a 2020 2020  s available.    
-0000b5d0: 233a 2020 2020 2073 6174 6973 6679 696e  #:     satisfyin
-0000b5e0: 6720 7468 6f73 6520 7265 7374 7269 6374  g those restrict
-0000b5f0: 696f 6e73 2c20 7468 6520 7461 736b 2063  ions, the task c
-0000b600: 616e 2073 7469 6c6c 2067 6f20 696e 746f  an still go into
-0000b610: 2074 6865 0a20 2020 2023 3a20 2020 2020   the.    #:     
-0000b620: 2270 726f 6365 7373 696e 6722 2073 7461  "processing" sta
-0000b630: 7465 2061 6e64 2062 6520 7365 6e74 2066  te and be sent f
-0000b640: 6f72 2065 7865 6375 7469 6f6e 2074 6f20  or execution to 
-0000b650: 616e 6f74 6865 7220 636f 6e6e 6563 7465  another connecte
-0000b660: 6420 776f 726b 6572 2e0a 2020 2020 6c6f  d worker..    lo
-0000b670: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
-0000b680: 3a20 626f 6f6c 0a0a 2020 2020 233a 2057  : bool..    #: W
-0000b690: 6865 7468 6572 2074 6869 7320 7461 736b  hether this task
-0000b6a0: 2069 7320 616e 2041 6374 6f72 0a20 2020   is an Actor.   
-0000b6b0: 2061 6374 6f72 3a20 626f 6f6c 0a0a 2020   actor: bool..  
-0000b6c0: 2020 233a 2054 6865 2067 726f 7570 206f    #: The group o
-0000b6d0: 6620 7461 736b 7320 746f 2077 6869 6368  f tasks to which
-0000b6e0: 2074 6869 7320 6f6e 6520 6265 6c6f 6e67   this one belong
-0000b6f0: 730a 2020 2020 6772 6f75 703a 2054 6173  s.    group: Tas
-0000b700: 6b47 726f 7570 0a0a 2020 2020 233a 2053  kGroup..    #: S
-0000b710: 616d 6520 6173 206f 6620 6772 6f75 702e  ame as of group.
-0000b720: 6e61 6d65 0a20 2020 2067 726f 7570 5f6b  name.    group_k
-0000b730: 6579 3a20 7374 720a 0a20 2020 2023 3a20  ey: str..    #: 
-0000b740: 4d65 7461 6461 7461 2072 656c 6174 6564  Metadata related
-0000b750: 2074 6f20 7461 736b 0a20 2020 206d 6574   to task.    met
-0000b760: 6164 6174 613a 2064 6963 745b 7374 722c  adata: dict[str,
-0000b770: 2041 6e79 5d0a 0a20 2020 2023 3a20 5461   Any]..    #: Ta
-0000b780: 736b 2061 6e6e 6f74 6174 696f 6e73 0a20  sk annotations. 
-0000b790: 2020 2061 6e6e 6f74 6174 696f 6e73 3a20     annotations: 
-0000b7a0: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
-0000b7b0: 2020 2020 233a 2054 6865 2075 6e69 7175      #: The uniqu
-0000b7c0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
-0000b7d0: 6120 7370 6563 6966 6963 2065 7865 6375  a specific execu
-0000b7e0: 7469 6f6e 206f 6620 6120 7461 736b 2e20  tion of a task. 
-0000b7f0: 5468 6973 2069 6465 6e74 6966 6965 720a  This identifier.
-0000b800: 2020 2020 233a 2069 7320 7573 6564 2074      #: is used t
-0000b810: 6f20 7369 676e 2061 2074 6173 6b20 7375  o sign a task su
-0000b820: 6368 2074 6861 7420 7468 6520 6173 7369  ch that the assi
-0000b830: 676e 6564 2077 6f72 6b65 7220 6973 2065  gned worker is e
-0000b840: 7870 6563 7465 6420 746f 2072 6574 7572  xpected to retur
-0000b850: 6e0a 2020 2020 233a 2074 6865 2073 616d  n.    #: the sam
-0000b860: 6520 6964 656e 7469 6669 6572 2069 6e20  e identifier in 
-0000b870: 7468 6520 7461 736b 2d66 696e 6973 6865  the task-finishe
-0000b880: 6420 6d65 7373 6167 652e 2054 6869 7320  d message. This 
-0000b890: 6973 2075 7365 6420 746f 2063 6f72 7265  is used to corre
-0000b8a0: 6c61 7465 0a20 2020 2023 3a20 7265 7370  late.    #: resp
-0000b8b0: 6f6e 7365 732e 0a20 2020 2023 3a20 4f6e  onses..    #: On
-0000b8c0: 6c79 2074 6865 206d 6f73 7420 7265 6365  ly the most rece
-0000b8d0: 6e74 6c79 2061 7373 6967 6e65 6420 776f  ntly assigned wo
-0000b8e0: 726b 6572 2069 7320 7472 7573 7465 642e  rker is trusted.
-0000b8f0: 2041 6c6c 206f 7468 6572 2072 6573 756c   All other resul
-0000b900: 7473 2077 696c 6c0a 2020 2020 233a 2062  ts will.    #: b
-0000b910: 6520 7265 6a65 6374 6564 2e0a 2020 2020  e rejected..    
-0000b920: 7275 6e5f 6964 3a20 696e 7420 7c20 4e6f  run_id: int | No
-0000b930: 6e65 0a0a 2020 2020 233a 2043 6163 6865  ne..    #: Cache
-0000b940: 6420 6861 7368 206f 6620 3a61 7474 723a  d hash of :attr:
-0000b950: 607e 5461 736b 5374 6174 652e 636c 6965  `~TaskState.clie
-0000b960: 6e74 5f6b 6579 600a 2020 2020 5f68 6173  nt_key`.    _has
-0000b970: 683a 2069 6e74 0a0a 2020 2020 2320 5375  h: int..    # Su
-0000b980: 7070 6f72 7420 666f 7220 7765 616b 7265  pport for weakre
-0000b990: 6673 2074 6f20 6120 636c 6173 7320 7769  fs to a class wi
-0000b9a0: 7468 205f 5f73 6c6f 7473 5f5f 0a20 2020  th __slots__.   
-0000b9b0: 205f 5f77 6561 6b72 6566 5f5f 3a20 416e   __weakref__: An
-0000b9c0: 7920 3d20 4e6f 6e65 0a20 2020 205f 5f73  y = None.    __s
-0000b9d0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-0000b9e0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-0000b9f0: 0a20 2020 2023 3a20 476c 6f62 616c 2069  .    #: Global i
-0000ba00: 7465 7261 746f 7220 7573 6564 2074 6f20  terator used to 
-0000ba10: 6372 6561 7465 2075 6e69 7175 6520 7461  create unique ta
-0000ba20: 736b 2072 756e 2049 4473 0a20 2020 205f  sk run IDs.    _
-0000ba30: 7275 6e5f 6964 5f69 7465 7261 746f 723a  run_id_iterator:
-0000ba40: 2043 6c61 7373 5661 725b 6974 6572 746f   ClassVar[iterto
-0000ba50: 6f6c 732e 636f 756e 745d 203d 2069 7465  ols.count] = ite
-0000ba60: 7274 6f6f 6c73 2e63 6f75 6e74 2829 0a0a  rtools.count()..
-0000ba70: 2020 2020 2320 496e 7374 616e 6365 7320      # Instances 
-0000ba80: 6e6f 7420 7061 7274 206f 6620 736c 6f74  not part of slot
-0000ba90: 7320 7369 6e63 6520 636c 6173 7320 7661  s since class va
-0000baa0: 7269 6162 6c65 0a20 2020 205f 696e 7374  riable.    _inst
-0000bab0: 616e 6365 733a 2043 6c61 7373 5661 725b  ances: ClassVar[
-0000bac0: 7765 616b 7265 662e 5765 616b 5365 745b  weakref.WeakSet[
-0000bad0: 5461 736b 5374 6174 655d 5d20 3d20 7765  TaskState]] = we
-0000bae0: 616b 7265 662e 5765 616b 5365 7428 290a  akref.WeakSet().
-0000baf0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-0000bb00: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
-0000bb10: 0a20 2020 2020 2020 206b 6579 3a20 7374  .        key: st
-0000bb20: 722c 0a20 2020 2020 2020 2072 756e 5f73  r,.        run_s
-0000bb30: 7065 633a 206f 626a 6563 742c 0a20 2020  pec: object,.   
-0000bb40: 2020 2020 2073 7461 7465 3a20 5461 736b       state: Task
-0000bb50: 5374 6174 6553 7461 7465 2c0a 2020 2020  StateState,.    
-0000bb60: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000bb70: 6b65 7920 3d20 6b65 790a 2020 2020 2020  key = key.      
-0000bb80: 2020 7365 6c66 2e5f 6861 7368 203d 2068    self._hash = h
-0000bb90: 6173 6828 6b65 7929 0a20 2020 2020 2020  ash(key).       
-0000bba0: 2073 656c 662e 7275 6e5f 7370 6563 203d   self.run_spec =
-0000bbb0: 2072 756e 5f73 7065 630a 2020 2020 2020   run_spec.      
-0000bbc0: 2020 7365 6c66 2e5f 7374 6174 6520 3d20    self._state = 
-0000bbd0: 7374 6174 650a 2020 2020 2020 2020 7365  state.        se
-0000bbe0: 6c66 2e65 7863 6570 7469 6f6e 203d 204e  lf.exception = N
-0000bbf0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000bc00: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-0000bc10: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000bc20: 7365 6c66 2e74 7261 6365 6261 636b 203d  self.traceback =
-0000bc30: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000bc40: 6c66 2e65 7863 6570 7469 6f6e 5f74 6578  lf.exception_tex
-0000bc50: 7420 3d20 2222 0a20 2020 2020 2020 2073  t = "".        s
-0000bc60: 656c 662e 7472 6163 6562 6163 6b5f 7465  elf.traceback_te
-0000bc70: 7874 203d 2022 220a 2020 2020 2020 2020  xt = "".        
-0000bc80: 7365 6c66 2e73 7573 7069 6369 6f75 7320  self.suspicious 
-0000bc90: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
-0000bca0: 2e72 6574 7269 6573 203d 2030 0a20 2020  .retries = 0.   
-0000bcb0: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
-0000bcc0: 203d 202d 310a 2020 2020 2020 2020 7365   = -1.        se
-0000bcd0: 6c66 2e70 7269 6f72 6974 7920 3d20 4e6f  lf.priority = No
-0000bce0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0000bcf0: 7768 6f5f 7761 6e74 7320 3d20 7365 7428  who_wants = set(
-0000bd00: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
-0000bd10: 6570 656e 6465 6e63 6965 7320 3d20 7365  ependencies = se
-0000bd20: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000bd30: 2e64 6570 656e 6465 6e74 7320 3d20 7365  .dependents = se
-0000bd40: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000bd50: 2e77 6169 7469 6e67 5f6f 6e20 3d20 7365  .waiting_on = se
-0000bd60: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
-0000bd70: 2e77 6169 7465 7273 203d 2073 6574 2829  .waiters = set()
-0000bd80: 0a20 2020 2020 2020 2073 656c 662e 7768  .        self.wh
-0000bd90: 6f5f 6861 7320 3d20 7365 7428 290a 2020  o_has = set().  
-0000bda0: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
-0000bdb0: 7373 696e 675f 6f6e 203d 204e 6f6e 650a  ssing_on = None.
-0000bdc0: 2020 2020 2020 2020 7365 6c66 2e68 6173          self.has
-0000bdd0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
-0000bde0: 6573 203d 2046 616c 7365 0a20 2020 2020  es = False.     
-0000bdf0: 2020 2073 656c 662e 686f 7374 5f72 6573     self.host_res
-0000be00: 7472 6963 7469 6f6e 7320 3d20 7365 7428  trictions = set(
-0000be10: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
-0000be20: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
-0000be30: 6e73 203d 2073 6574 2829 0a20 2020 2020  ns = set().     
-0000be40: 2020 2073 656c 662e 7265 736f 7572 6365     self.resource
-0000be50: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
-0000be60: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0000be70: 6c6f 6f73 655f 7265 7374 7269 6374 696f  loose_restrictio
-0000be80: 6e73 203d 2046 616c 7365 0a20 2020 2020  ns = False.     
-0000be90: 2020 2073 656c 662e 6163 746f 7220 3d20     self.actor = 
-0000bea0: 4661 6c73 650a 2020 2020 2020 2020 7365  False.        se
-0000beb0: 6c66 2e70 7265 6669 7820 3d20 4e6f 6e65  lf.prefix = None
-0000bec0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-0000bed0: 0a20 2020 2020 2020 2073 656c 662e 7479  .        self.ty
-0000bee0: 7065 203d 204e 6f6e 6520 2023 2074 7970  pe = None  # typ
-0000bef0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-0000bf00: 2020 7365 6c66 2e67 726f 7570 5f6b 6579    self.group_key
-0000bf10: 203d 206b 6579 5f73 706c 6974 5f67 726f   = key_split_gro
-0000bf20: 7570 286b 6579 290a 2020 2020 2020 2020  up(key).        
-0000bf30: 7365 6c66 2e67 726f 7570 203d 204e 6f6e  self.group = Non
-0000bf40: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
-0000bf50: 650a 2020 2020 2020 2020 7365 6c66 2e6d  e.        self.m
-0000bf60: 6574 6164 6174 6120 3d20 7b7d 0a20 2020  etadata = {}.   
-0000bf70: 2020 2020 2073 656c 662e 616e 6e6f 7461       self.annota
-0000bf80: 7469 6f6e 7320 3d20 7b7d 0a20 2020 2020  tions = {}.     
-0000bf90: 2020 2073 656c 662e 6572 7265 645f 6f6e     self.erred_on
-0000bfa0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0000bfb0: 2073 656c 662e 7275 6e5f 6964 203d 204e   self.run_id = N
-0000bfc0: 6f6e 650a 2020 2020 2020 2020 5461 736b  one.        Task
-0000bfd0: 5374 6174 652e 5f69 6e73 7461 6e63 6573  State._instances
-0000bfe0: 2e61 6464 2873 656c 6629 0a0a 2020 2020  .add(self)..    
-0000bff0: 6465 6620 5f5f 6861 7368 5f5f 2873 656c  def __hash__(sel
-0000c000: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
-0000c010: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-0000c020: 6861 7368 0a0a 2020 2020 6465 6620 5f5f  hash..    def __
-0000c030: 6571 5f5f 2873 656c 662c 206f 7468 6572  eq__(self, other
-0000c040: 3a20 6f62 6a65 6374 2920 2d3e 2062 6f6f  : object) -> boo
-0000c050: 6c3a 0a20 2020 2020 2020 2072 6574 7572  l:.        retur
-0000c060: 6e20 6973 696e 7374 616e 6365 286f 7468  n isinstance(oth
-0000c070: 6572 2c20 5461 736b 5374 6174 6529 2061  er, TaskState) a
-0000c080: 6e64 2073 656c 662e 6b65 7920 3d3d 206f  nd self.key == o
-0000c090: 7468 6572 2e6b 6579 0a0a 2020 2020 4070  ther.key..    @p
-0000c0a0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0000c0b0: 7374 6174 6528 7365 6c66 2920 2d3e 2054  state(self) -> T
-0000c0c0: 6173 6b53 7461 7465 5374 6174 653a 0a20  askStateState:. 
-0000c0d0: 2020 2020 2020 2022 2222 5468 6973 2074         """This t
-0000c0e0: 6173 6b27 7320 6375 7272 656e 7420 7374  ask's current st
-0000c0f0: 6174 652e 2020 5661 6c69 6420 7374 6174  ate.  Valid stat
-0000c100: 6573 2061 7265 2060 6072 656c 6561 7365  es are ``release
-0000c110: 6460 602c 2060 6077 6169 7469 6e67 6060  d``, ``waiting``
-0000c120: 2c0a 2020 2020 2020 2020 6060 6e6f 2d77  ,.        ``no-w
-0000c130: 6f72 6b65 7260 602c 2060 6070 726f 6365  orker``, ``proce
-0000c140: 7373 696e 6760 602c 2060 606d 656d 6f72  ssing``, ``memor
-0000c150: 7960 602c 2060 6065 7272 6564 6060 2061  y``, ``erred`` a
-0000c160: 6e64 2060 6066 6f72 676f 7474 656e 6060  nd ``forgotten``
-0000c170: 2e20 2049 6620 6974 0a20 2020 2020 2020  .  If it.       
-0000c180: 2069 7320 6060 666f 7267 6f74 7465 6e60   is ``forgotten`
-0000c190: 602c 2074 6865 2074 6173 6b20 6973 6e27  `, the task isn'
-0000c1a0: 7420 7374 6f72 6564 2069 6e20 7468 6520  t stored in the 
-0000c1b0: 6060 7461 736b 7360 6020 6469 6374 696f  ``tasks`` dictio
-0000c1c0: 6e61 7279 2061 6e79 6d6f 7265 2061 6e64  nary anymore and
-0000c1d0: 0a20 2020 2020 2020 2077 696c 6c20 7072  .        will pr
-0000c1e0: 6f62 6162 6c79 2064 6973 6170 7065 6172  obably disappear
-0000c1f0: 2073 6f6f 6e20 6672 6f6d 206d 656d 6f72   soon from memor
-0000c200: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
-0000c210: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0000c220: 6c66 2e5f 7374 6174 650a 0a20 2020 2040  lf._state..    @
-0000c230: 7374 6174 652e 7365 7474 6572 0a20 2020  state.setter.   
-0000c240: 2064 6566 2073 7461 7465 2873 656c 662c   def state(self,
-0000c250: 2076 616c 7565 3a20 5461 736b 5374 6174   value: TaskStat
-0000c260: 6553 7461 7465 2920 2d3e 204e 6f6e 653a  eState) -> None:
-0000c270: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
-0000c280: 6f75 702e 7374 6174 6573 5b73 656c 662e  oup.states[self.
-0000c290: 5f73 7461 7465 5d20 2d3d 2031 0a20 2020  _state] -= 1.   
-0000c2a0: 2020 2020 2073 656c 662e 6772 6f75 702e       self.group.
-0000c2b0: 7374 6174 6573 5b76 616c 7565 5d20 2b3d  states[value] +=
-0000c2c0: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
-0000c2d0: 5f73 7461 7465 203d 2076 616c 7565 0a20  _state = value. 
-0000c2e0: 2020 2020 2020 2073 656c 662e 7072 6566         self.pref
-0000c2f0: 6978 2e73 7461 7465 5f63 6f75 6e74 735b  ix.state_counts[
-0000c300: 7661 6c75 655d 202b 3d20 310a 0a20 2020  value] += 1..   
-0000c310: 2064 6566 2061 6464 5f64 6570 656e 6465   def add_depende
-0000c320: 6e63 7928 7365 6c66 2c20 6f74 6865 723a  ncy(self, other:
-0000c330: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-0000c340: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0000c350: 4164 6420 616e 6f74 6865 7220 7461 736b  Add another task
-0000c360: 2061 7320 6120 6465 7065 6e64 656e 6379   as a dependency
-0000c370: 206f 6620 7468 6973 2074 6173 6b22 2222   of this task"""
-0000c380: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
-0000c390: 7065 6e64 656e 6369 6573 2e61 6464 286f  pendencies.add(o
-0000c3a0: 7468 6572 290a 2020 2020 2020 2020 7365  ther).        se
-0000c3b0: 6c66 2e67 726f 7570 2e64 6570 656e 6465  lf.group.depende
-0000c3c0: 6e63 6965 732e 6164 6428 6f74 6865 722e  ncies.add(other.
-0000c3d0: 6772 6f75 7029 0a20 2020 2020 2020 206f  group).        o
-0000c3e0: 7468 6572 2e64 6570 656e 6465 6e74 732e  ther.dependents.
-0000c3f0: 6164 6428 7365 6c66 290a 0a20 2020 2064  add(self)..    d
-0000c400: 6566 2067 6574 5f6e 6279 7465 7328 7365  ef get_nbytes(se
-0000c410: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-0000c420: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
-0000c430: 6e62 7974 6573 2069 6620 7365 6c66 2e6e  nbytes if self.n
-0000c440: 6279 7465 7320 3e3d 2030 2065 6c73 6520  bytes >= 0 else 
-0000c450: 4445 4641 554c 545f 4441 5441 5f53 495a  DEFAULT_DATA_SIZ
-0000c460: 450a 0a20 2020 2064 6566 2073 6574 5f6e  E..    def set_n
-0000c470: 6279 7465 7328 7365 6c66 2c20 6e62 7974  bytes(self, nbyt
-0000c480: 6573 3a20 696e 7429 202d 3e20 4e6f 6e65  es: int) -> None
-0000c490: 3a0a 2020 2020 2020 2020 6469 6666 203d  :.        diff =
-0000c4a0: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
-0000c4b0: 6f6c 645f 6e62 7974 6573 203d 2073 656c  old_nbytes = sel
-0000c4c0: 662e 6e62 7974 6573 0a20 2020 2020 2020  f.nbytes.       
-0000c4d0: 2069 6620 6f6c 645f 6e62 7974 6573 203e   if old_nbytes >
-0000c4e0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0000c4f0: 2064 6966 6620 2d3d 206f 6c64 5f6e 6279   diff -= old_nby
-0000c500: 7465 730a 2020 2020 2020 2020 7365 6c66  tes.        self
-0000c510: 2e67 726f 7570 2e6e 6279 7465 735f 746f  .group.nbytes_to
-0000c520: 7461 6c20 2b3d 2064 6966 660a 2020 2020  tal += diff.    
-0000c530: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-0000c540: 6c66 2e77 686f 5f68 6173 3a0a 2020 2020  lf.who_has:.    
-0000c550: 2020 2020 2020 2020 7773 2e6e 6279 7465          ws.nbyte
-0000c560: 7320 2b3d 2064 6966 660a 2020 2020 2020  s += diff.      
-0000c570: 2020 7365 6c66 2e6e 6279 7465 7320 3d20    self.nbytes = 
-0000c580: 6e62 7974 6573 0a0a 2020 2020 6465 6620  nbytes..    def 
-0000c590: 5f5f 7265 7072 5f5f 2873 656c 6629 202d  __repr__(self) -
-0000c5a0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-0000c5b0: 6574 7572 6e20 6622 3c54 6173 6b53 7461  eturn f"<TaskSta
-0000c5c0: 7465 207b 7365 6c66 2e6b 6579 2172 7d20  te {self.key!r} 
-0000c5d0: 7b73 656c 662e 5f73 7461 7465 7d3e 220a  {self._state}>".
-0000c5e0: 0a20 2020 2064 6566 205f 7265 7072 5f68  .    def _repr_h
-0000c5f0: 746d 6c5f 2873 656c 6629 202d 3e20 7374  tml_(self) -> st
-0000c600: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
-0000c610: 6e20 6765 745f 7465 6d70 6c61 7465 2822  n get_template("
-0000c620: 7461 736b 5f73 7461 7465 2e68 746d 6c2e  task_state.html.
-0000c630: 6a32 2229 2e72 656e 6465 7228 0a20 2020  j2").render(.   
-0000c640: 2020 2020 2020 2020 2073 7461 7465 3d73           state=s
-0000c650: 656c 662e 7374 6174 652c 0a20 2020 2020  elf.state,.     
-0000c660: 2020 2020 2020 206e 6279 7465 733d 7365         nbytes=se
-0000c670: 6c66 2e6e 6279 7465 732c 0a20 2020 2020  lf.nbytes,.     
-0000c680: 2020 2020 2020 206b 6579 3d73 656c 662e         key=self.
-0000c690: 6b65 792c 0a20 2020 2020 2020 2029 0a0a  key,.        )..
-0000c6a0: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0000c6b0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-0000c6c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000c6d0: 2020 2020 2020 2020 2066 6f72 2063 7320           for cs 
-0000c6e0: 696e 2073 656c 662e 7768 6f5f 7761 6e74  in self.who_want
-0000c6f0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000c700: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0000c710: 616e 6365 2863 732c 2043 6c69 656e 7453  ance(cs, ClientS
-0000c720: 7461 7465 292c 2028 7265 7072 2863 7329  tate), (repr(cs)
-0000c730: 2c20 7365 6c66 2e77 686f 5f77 616e 7473  , self.who_wants
-0000c740: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-0000c750: 7220 7773 2069 6e20 7365 6c66 2e77 686f  r ws in self.who
-0000c760: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-0000c770: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0000c780: 6e73 7461 6e63 6528 7773 2c20 576f 726b  nstance(ws, Work
-0000c790: 6572 5374 6174 6529 2c20 2872 6570 7228  erState), (repr(
-0000c7a0: 7773 292c 2073 656c 662e 7768 6f5f 6861  ws), self.who_ha
-0000c7b0: 7329 0a20 2020 2020 2020 2020 2020 2066  s).            f
-0000c7c0: 6f72 2074 7320 696e 2073 656c 662e 6465  or ts in self.de
-0000c7d0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-0000c7e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0000c7f0: 7274 2069 7369 6e73 7461 6e63 6528 7473  rt isinstance(ts
-0000c800: 2c20 5461 736b 5374 6174 6529 2c20 2872  , TaskState), (r
-0000c810: 6570 7228 7473 292c 2073 656c 662e 6465  epr(ts), self.de
-0000c820: 7065 6e64 656e 6369 6573 290a 2020 2020  pendencies).    
-0000c830: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
-0000c840: 6e20 7365 6c66 2e64 6570 656e 6465 6e74  n self.dependent
-0000c850: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0000c860: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0000c870: 616e 6365 2874 732c 2054 6173 6b53 7461  ance(ts, TaskSta
-0000c880: 7465 292c 2028 7265 7072 2874 7329 2c20  te), (repr(ts), 
-0000c890: 7365 6c66 2e64 6570 656e 6465 6e74 7329  self.dependents)
-0000c8a0: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
-0000c8b0: 6964 6174 655f 7461 736b 5f73 7461 7465  idate_task_state
-0000c8c0: 2873 656c 6629 0a20 2020 2020 2020 2065  (self).        e
-0000c8d0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
-0000c8e0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
-0000c8f0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-0000c900: 6f6e 2865 290a 2020 2020 2020 2020 2020  on(e).          
-0000c910: 2020 6966 204c 4f47 5f50 4442 3a0a 2020    if LOG_PDB:.  
-0000c920: 2020 2020 2020 2020 2020 2020 2020 696d                im
-0000c930: 706f 7274 2070 6462 0a0a 2020 2020 2020  port pdb..      
-0000c940: 2020 2020 2020 2020 2020 7064 622e 7365            pdb.se
-0000c950: 745f 7472 6163 6528 290a 0a20 2020 2064  t_trace()..    d
-0000c960: 6566 2067 6574 5f6e 6279 7465 735f 6465  ef get_nbytes_de
-0000c970: 7073 2873 656c 6629 202d 3e20 696e 743a  ps(self) -> int:
-0000c980: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000c990: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
-0000c9a0: 7328 2920 666f 7220 7473 2069 6e20 7365  s() for ts in se
-0000c9b0: 6c66 2e64 6570 656e 6465 6e63 6965 7329  lf.dependencies)
-0000c9c0: 0a0a 2020 2020 6465 6620 5f74 6f5f 6469  ..    def _to_di
-0000c9d0: 6374 5f6e 6f5f 6e65 7374 2873 656c 662c  ct_no_nest(self,
-0000c9e0: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
-0000c9f0: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
-0000ca00: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
-0000ca10: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
-0000ca20: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
-0000ca30: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
-0000ca40: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
-0000ca50: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
-0000ca60: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
-0000ca70: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
-0000ca80: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
-0000ca90: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-0000caa0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-0000cab0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
-0000cac0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
-0000cad0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
-0000cae0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
-0000caf0: 6976 655f 746f 5f64 6963 740a 0a20 2020  ive_to_dict..   
-0000cb00: 2020 2020 204e 6f74 6573 0a20 2020 2020       Notes.     
-0000cb10: 2020 202d 2d2d 2d2d 0a20 2020 2020 2020     -----.       
-0000cb20: 2054 6869 7320 636c 6173 7320 7573 6573   This class uses
-0000cb30: 2060 605f 746f 5f64 6963 745f 6e6f 5f6e   ``_to_dict_no_n
-0000cb40: 6573 7460 6020 696e 7374 6561 6420 6f66  est`` instead of
-0000cb50: 2060 605f 746f 5f64 6963 7460 602e 0a20   ``_to_dict``.. 
-0000cb60: 2020 2020 2020 2057 6865 6e20 6120 7461         When a ta
-0000cb70: 736b 2072 6566 6572 656e 6365 7320 616e  sk references an
-0000cb80: 6f74 6865 7220 7461 736b 2c20 6f72 2077  other task, or w
-0000cb90: 6865 6e20 6120 576f 726b 6572 5374 6174  hen a WorkerStat
-0000cba0: 652e 7461 736b 7320 636f 6e74 6169 6e73  e.tasks contains
-0000cbb0: 2074 6173 6b73 2c0a 2020 2020 2020 2020   tasks,.        
-0000cbc0: 7468 6973 206d 6574 686f 6420 6973 206e  this method is n
-0000cbd0: 6f74 2065 7865 6375 7465 6420 666f 7220  ot executed for 
-0000cbe0: 7468 6520 696e 6e65 7220 7461 736b 2c20  the inner task, 
-0000cbf0: 6576 656e 2069 6620 7468 6520 696e 6e65  even if the inne
-0000cc00: 7220 7461 736b 2077 6173 206e 6576 6572  r task was never
-0000cc10: 0a20 2020 2020 2020 2073 6565 6e20 6265  .        seen be
-0000cc20: 666f 7265 3b20 796f 7520 6765 7420 6120  fore; you get a 
-0000cc30: 7265 7072 2069 6e73 7465 6164 2e20 416c  repr instead. Al
-0000cc40: 6c20 7461 736b 7320 7368 6f75 6c64 206e  l tasks should n
-0000cc50: 6561 746c 7920 6170 7065 6172 2075 6e64  eatly appear und
-0000cc60: 6572 0a20 2020 2020 2020 2053 6368 6564  er.        Sched
-0000cc70: 756c 6572 2e74 6173 6b73 2e20 5468 6973  uler.tasks. This
-0000cc80: 2061 6c73 6f20 7072 6576 656e 7473 2061   also prevents a
-0000cc90: 2052 6563 7572 7369 6f6e 4572 726f 7220   RecursionError 
-0000cca0: 6475 7269 6e67 2070 6172 7469 6375 6c61  during particula
-0000ccb0: 726c 7920 6865 6176 790a 2020 2020 2020  rly heavy.      
-0000ccc0: 2020 6c6f 6164 732c 2077 6869 6368 2068    loads, which h
-0000ccd0: 6176 6520 6265 656e 206f 6273 6572 7665  ave been observe
-0000cce0: 6420 746f 2068 6170 7065 6e20 7768 656e  d to happen when
-0000ccf0: 6576 6572 2074 6865 7265 2773 2061 6e20  ever there's an 
-0000cd00: 6163 7963 6c69 6320 6465 7065 6e64 656e  acyclic dependen
-0000cd10: 6379 0a20 2020 2020 2020 2063 6861 696e  cy.        chain
-0000cd20: 206f 6620 7e32 3030 2b20 7461 736b 732e   of ~200+ tasks.
-0000cd30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0000cd40: 2020 2020 2072 6574 7572 6e20 7265 6375       return recu
-0000cd50: 7273 6976 655f 746f 5f64 6963 7428 7365  rsive_to_dict(se
-0000cd60: 6c66 2c20 6578 636c 7564 653d 6578 636c  lf, exclude=excl
-0000cd70: 7564 652c 206d 656d 6265 7273 3d54 7275  ude, members=Tru
-0000cd80: 6529 0a0a 0a63 6c61 7373 2054 7261 6e73  e)...class Trans
-0000cd90: 6974 696f 6e28 4e61 6d65 6454 7570 6c65  ition(NamedTuple
-0000cda0: 293a 0a20 2020 2022 2222 416e 2065 6e74  ):.    """An ent
-0000cdb0: 7279 2069 6e20 3a61 7474 723a 6053 6368  ry in :attr:`Sch
-0000cdc0: 6564 756c 6572 5374 6174 652e 7472 616e  edulerState.tran
-0000cdd0: 7369 7469 6f6e 5f6c 6f67 6022 2222 0a0a  sition_log`"""..
-0000cde0: 2020 2020 6b65 793a 2073 7472 0a20 2020      key: str.   
-0000cdf0: 2073 7461 7274 3a20 5461 736b 5374 6174   start: TaskStat
-0000ce00: 6553 7461 7465 0a20 2020 2066 696e 6973  eState.    finis
-0000ce10: 683a 2054 6173 6b53 7461 7465 5374 6174  h: TaskStateStat
-0000ce20: 650a 2020 2020 7265 636f 6d6d 656e 6461  e.    recommenda
-0000ce30: 7469 6f6e 733a 2052 6563 730a 2020 2020  tions: Recs.    
-0000ce40: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-0000ce50: 0a20 2020 2074 696d 6573 7461 6d70 3a20  .    timestamp: 
-0000ce60: 666c 6f61 740a 0a0a 636c 6173 7320 5363  float...class Sc
-0000ce70: 6865 6475 6c65 7253 7461 7465 3a0a 2020  hedulerState:.  
-0000ce80: 2020 2222 2255 6e64 6572 6c79 696e 6720    """Underlying 
-0000ce90: 7461 736b 2073 7461 7465 206f 6620 6479  task state of dy
-0000cea0: 6e61 6d69 6320 7363 6865 6475 6c65 720a  namic scheduler.
-0000ceb0: 0a20 2020 2054 7261 636b 7320 7468 6520  .    Tracks the 
-0000cec0: 6375 7272 656e 7420 7374 6174 6520 6f66  current state of
-0000ced0: 2077 6f72 6b65 7273 2c20 6461 7461 2c20   workers, data, 
-0000cee0: 616e 6420 636f 6d70 7574 6174 696f 6e73  and computations
-0000cef0: 2e0a 0a20 2020 2048 616e 646c 6573 2074  ...    Handles t
-0000cf00: 7261 6e73 6974 696f 6e73 2062 6574 7765  ransitions betwe
-0000cf10: 656e 2064 6966 6665 7265 6e74 2074 6173  en different tas
-0000cf20: 6b20 7374 6174 6573 2e20 4e6f 7469 6669  k states. Notifi
-0000cf30: 6573 2074 6865 0a20 2020 2053 6368 6564  es the.    Sched
-0000cf40: 756c 6572 206f 6620 6368 616e 6765 7320  uler of changes 
-0000cf50: 6279 206d 6573 7361 6769 6e67 2070 6173  by messaging pas
-0000cf60: 7369 6e67 2074 6872 6f75 6768 2051 7565  sing through Que
-0000cf70: 7565 732c 2077 6869 6368 2074 6865 0a20  ues, which the. 
-0000cf80: 2020 2053 6368 6564 756c 6572 206c 6973     Scheduler lis
-0000cf90: 7465 6e73 2074 6f20 7265 7370 6f6e 6473  tens to responds
-0000cfa0: 2061 6363 6f72 6469 6e67 6c79 2e0a 0a20   accordingly... 
-0000cfb0: 2020 2041 6c6c 2065 7665 6e74 7320 6172     All events ar
-0000cfc0: 6520 6861 6e64 6c65 6420 7175 6963 6b6c  e handled quickl
-0000cfd0: 792c 2069 6e20 6c69 6e65 6172 2074 696d  y, in linear tim
-0000cfe0: 6520 7769 7468 2072 6573 7065 6374 2074  e with respect t
-0000cff0: 6f20 7468 6569 720a 2020 2020 696e 7075  o their.    inpu
-0000d000: 7420 2877 6869 6368 2069 7320 6f66 7465  t (which is ofte
-0000d010: 6e20 6f66 2063 6f6e 7374 616e 7420 7369  n of constant si
-0000d020: 7a65 2920 616e 6420 6765 6e65 7261 6c6c  ze) and generall
-0000d030: 7920 7769 7468 696e 2061 0a20 2020 206d  y within a.    m
-0000d040: 696c 6c69 7365 636f 6e64 2e0a 0a20 2020  illisecond...   
-0000d050: 2055 7365 7273 2074 7970 6963 616c 6c79   Users typically
-0000d060: 2064 6f20 6e6f 7420 696e 7465 7261 6374   do not interact
-0000d070: 2077 6974 6820 6060 5472 616e 7369 7469   with ``Transiti
-0000d080: 6f6e 7360 6020 6469 7265 6374 6c79 2e20  ons`` directly. 
-0000d090: 496e 7374 6561 640a 2020 2020 7573 6572  Instead.    user
-0000d0a0: 7320 696e 7465 7261 6374 2077 6974 6820  s interact with 
-0000d0b0: 7468 6520 6060 436c 6965 6e74 6060 2c20  the ``Client``, 
-0000d0c0: 7768 6963 6820 696e 2074 7572 6e20 656e  which in turn en
-0000d0d0: 6761 6765 7320 7468 650a 2020 2020 6060  gages the.    ``
-0000d0e0: 5363 6865 6475 6c65 7260 6020 6166 6665  Scheduler`` affe
-0000d0f0: 6374 696e 6720 6469 6666 6572 656e 7420  cting different 
-0000d100: 7472 616e 7369 7469 6f6e 7320 6865 7265  transitions here
-0000d110: 2075 6e64 6572 2d74 6865 2d68 6f6f 642e   under-the-hood.
-0000d120: 2049 6e0a 2020 2020 7468 6520 6261 636b   In.    the back
-0000d130: 6772 6f75 6e64 2060 6057 6f72 6b65 7260  ground ``Worker`
-0000d140: 6073 2061 6c73 6f20 656e 6761 6765 2077  `s also engage w
-0000d150: 6974 6820 7468 6520 6060 5363 6865 6475  ith the ``Schedu
-0000d160: 6c65 7260 600a 2020 2020 6166 6665 6374  ler``.    affect
-0000d170: 696e 6720 7468 6573 6520 7374 6174 6520  ing these state 
-0000d180: 7472 616e 7369 7469 6f6e 7320 6173 2077  transitions as w
-0000d190: 656c 6c2e 0a20 2020 2022 2222 0a0a 2020  ell..    """..  
-0000d1a0: 2020 6261 6e64 7769 6474 683a 2069 6e74    bandwidth: int
-0000d1b0: 0a0a 2020 2020 233a 2043 6c69 656e 7473  ..    #: Clients
-0000d1c0: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
-0000d1d0: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
-0000d1e0: 6475 6c65 720a 2020 2020 636c 6965 6e74  duler.    client
-0000d1f0: 733a 2064 6963 745b 7374 722c 2043 6c69  s: dict[str, Cli
-0000d200: 656e 7453 7461 7465 5d0a 0a20 2020 2065  entState]..    e
-0000d210: 7874 656e 7369 6f6e 733a 2064 6963 745b  xtensions: dict[
-0000d220: 7374 722c 2041 6e79 5d20 2023 2054 4f44  str, Any]  # TOD
-0000d230: 4f20 7772 6974 6520 6120 7363 6865 6475  O write a schedu
-0000d240: 6c65 7220 6578 7465 6e73 696f 6e20 5072  ler extension Pr
-0000d250: 6f74 6f63 6f6c 0a20 2020 2070 6c75 6769  otocol.    plugi
-0000d260: 6e73 3a20 6469 6374 5b73 7472 2c20 5363  ns: dict[str, Sc
-0000d270: 6865 6475 6c65 7250 6c75 6769 6e5d 0a20  hedulerPlugin]. 
-0000d280: 2020 2068 6f73 745f 696e 666f 3a20 6469     host_info: di
-0000d290: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
-0000d2a0: 2c20 416e 795d 5d0a 0a20 2020 2023 3a20  , Any]]..    #: 
-0000d2b0: 4966 2054 7275 652c 2065 6e61 626c 6520  If True, enable 
-0000d2c0: 6578 7065 6e73 6976 6520 696e 7465 726e  expensive intern
-0000d2d0: 616c 2063 6f6e 7369 7374 656e 6379 2063  al consistency c
-0000d2e0: 6865 636b 2e0a 2020 2020 233a 2054 7970  heck..    #: Typ
-0000d2f0: 6963 616c 6c79 2064 6973 6162 6c65 6420  ically disabled 
-0000d300: 696e 2070 726f 6475 6374 696f 6e2e 0a20  in production.. 
-0000d310: 2020 2076 616c 6964 6174 653a 2062 6f6f     validate: boo
-0000d320: 6c0a 0a20 2020 2023 2323 2323 2323 2323  l..    #########
-0000d330: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
-0000d340: 2020 2023 2057 6f72 6b65 7273 2d72 656c     # Workers-rel
-0000d350: 6174 6564 2073 7461 7465 0a20 2020 2023  ated state.    #
+00000af0: 5363 6865 6475 6c65 7250 6c75 6769 6e0a  SchedulerPlugin.
+00000b00: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00000b10: 2e73 7061 6e73 2069 6d70 6f72 7420 5370  .spans import Sp
+00000b20: 616e 7353 6368 6564 756c 6572 4578 7465  ansSchedulerExte
+00000b30: 6e73 696f 6e0a 6672 6f6d 2064 6973 7472  nsion.from distr
+00000b40: 6962 7574 6564 2e73 7465 616c 696e 6720  ibuted.stealing 
+00000b50: 696d 706f 7274 2057 6f72 6b53 7465 616c  import WorkSteal
+00000b60: 696e 670a 6672 6f6d 2064 6973 7472 6962  ing.from distrib
+00000b70: 7574 6564 2e75 7469 6c73 2069 6d70 6f72  uted.utils impor
+00000b80: 7420 280a 2020 2020 416c 6c2c 0a20 2020  t (.    All,.   
+00000b90: 2054 696d 656f 7574 4572 726f 722c 0a20   TimeoutError,. 
+00000ba0: 2020 2065 6d70 7479 5f63 6f6e 7465 7874     empty_context
+00000bb0: 2c0a 2020 2020 666f 726d 6174 5f64 6173  ,.    format_das
+00000bc0: 6862 6f61 7264 5f6c 696e 6b2c 0a20 2020  hboard_link,.   
+00000bd0: 2067 6574 5f66 696c 656e 6f5f 6c69 6d69   get_fileno_limi
+00000be0: 742c 0a20 2020 206b 6579 5f73 706c 6974  t,.    key_split
+00000bf0: 5f67 726f 7570 2c0a 2020 2020 6c6f 675f  _group,.    log_
+00000c00: 6572 726f 7273 2c0a 2020 2020 6e6f 5f64  errors,.    no_d
+00000c10: 6566 6175 6c74 2c0a 2020 2020 7265 6375  efault,.    recu
+00000c20: 7273 6976 655f 746f 5f64 6963 742c 0a20  rsive_to_dict,. 
+00000c30: 2020 2076 616c 6964 6174 655f 6b65 792c     validate_key,
+00000c40: 0a20 2020 2077 6169 745f 666f 722c 0a29  .    wait_for,.)
+00000c50: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000c60: 642e 7574 696c 735f 636f 6d6d 2069 6d70  d.utils_comm imp
+00000c70: 6f72 7420 280a 2020 2020 6761 7468 6572  ort (.    gather
+00000c80: 5f66 726f 6d5f 776f 726b 6572 732c 0a20  _from_workers,. 
+00000c90: 2020 2072 6574 7279 5f6f 7065 7261 7469     retry_operati
+00000ca0: 6f6e 2c0a 2020 2020 7363 6174 7465 725f  on,.    scatter_
+00000cb0: 746f 5f77 6f72 6b65 7273 2c0a 2020 2020  to_workers,.    
+00000cc0: 756e 7061 636b 5f72 656d 6f74 6564 6174  unpack_remotedat
+00000cd0: 612c 0a29 0a66 726f 6d20 6469 7374 7269  a,.).from distri
+00000ce0: 6275 7465 642e 7574 696c 735f 7065 7266  buted.utils_perf
+00000cf0: 2069 6d70 6f72 7420 6469 7361 626c 655f   import disable_
+00000d00: 6763 5f64 6961 676e 6f73 6973 2c20 656e  gc_diagnosis, en
+00000d10: 6162 6c65 5f67 635f 6469 6167 6e6f 7369  able_gc_diagnosi
+00000d20: 730a 6672 6f6d 2064 6973 7472 6962 7574  s.from distribut
+00000d30: 6564 2e76 6172 6961 626c 6520 696d 706f  ed.variable impo
+00000d40: 7274 2056 6172 6961 626c 6545 7874 656e  rt VariableExten
+00000d50: 7369 6f6e 0a0a 6966 2054 5950 455f 4348  sion..if TYPE_CH
+00000d60: 4543 4b49 4e47 3a0a 2020 2020 2320 544f  ECKING:.    # TO
+00000d70: 444f 2069 6d70 6f72 7420 6672 6f6d 2074  DO import from t
+00000d80: 7970 696e 6720 2872 6571 7569 7265 7320  yping (requires 
+00000d90: 5079 7468 6f6e 203e 3d33 2e31 3029 0a20  Python >=3.10). 
+00000da0: 2020 2066 726f 6d20 7479 7069 6e67 5f65     from typing_e
+00000db0: 7874 656e 7369 6f6e 7320 696d 706f 7274  xtensions import
+00000dc0: 2054 7970 6541 6c69 6173 0a0a 2020 2020   TypeAlias..    
+00000dd0: 6672 6f6d 2064 6173 6b2e 6869 6768 6c65  from dask.highle
+00000de0: 7665 6c67 7261 7068 2069 6d70 6f72 7420  velgraph import 
+00000df0: 4869 6768 4c65 7665 6c47 7261 7068 0a0a  HighLevelGraph..
+00000e00: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
+00000e10: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
+00000e20: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00000e30: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
+00000e40: 7461 7465 5374 6174 650a 5461 736b 5374  tateState.TaskSt
+00000e50: 6174 6553 7461 7465 3a20 5479 7065 416c  ateState: TypeAl
+00000e60: 6961 7320 3d20 4c69 7465 7261 6c5b 0a20  ias = Literal[. 
+00000e70: 2020 2022 7265 6c65 6173 6564 222c 0a20     "released",. 
+00000e80: 2020 2022 7761 6974 696e 6722 2c0a 2020     "waiting",.  
+00000e90: 2020 226e 6f2d 776f 726b 6572 222c 0a20    "no-worker",. 
+00000ea0: 2020 2022 7175 6575 6564 222c 0a20 2020     "queued",.   
+00000eb0: 2022 7072 6f63 6573 7369 6e67 222c 0a20   "processing",. 
+00000ec0: 2020 2022 6d65 6d6f 7279 222c 0a20 2020     "memory",.   
+00000ed0: 2022 6572 7265 6422 2c0a 2020 2020 2266   "erred",.    "f
+00000ee0: 6f72 676f 7474 656e 222c 0a5d 0a0a 414c  orgotten",.]..AL
+00000ef0: 4c5f 5441 534b 5f53 5441 5445 533a 2053  L_TASK_STATES: S
+00000f00: 6574 5b54 6173 6b53 7461 7465 5374 6174  et[TaskStateStat
+00000f10: 655d 203d 2073 6574 2854 6173 6b53 7461  e] = set(TaskSta
+00000f20: 7465 5374 6174 652e 5f5f 6172 6773 5f5f  teState.__args__
+00000f30: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
+00000f40: 650a 0a23 207b 7461 736b 206b 6579 202d  e..# {task key -
+00000f50: 3e20 6669 6e69 7368 2073 7461 7465 7d0a  > finish state}.
+00000f60: 2320 4e6f 7420 746f 2062 6520 636f 6e66  # Not to be conf
+00000f70: 7573 6564 2077 6974 6820 6469 7374 7269  used with distri
+00000f80: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00000f90: 7465 5f6d 6163 6869 6e65 2e52 6563 730a  te_machine.Recs.
+00000fa0: 5265 6373 3a20 5479 7065 416c 6961 7320  Recs: TypeAlias 
+00000fb0: 3d20 6469 6374 5b73 7472 2c20 5461 736b  = dict[str, Task
+00000fc0: 5374 6174 6553 7461 7465 5d0a 2320 7b63  StateState].# {c
+00000fd0: 6c69 656e 7420 6f72 2077 6f72 6b65 7220  lient or worker 
+00000fe0: 6164 6472 6573 733a 205b 7b6f 703a 203c  address: [{op: <
+00000ff0: 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e 2e5d  key>, ...}, ...]
+00001000: 7d0a 4d73 6773 3a20 5479 7065 416c 6961  }.Msgs: TypeAlia
+00001010: 7320 3d20 6469 6374 5b73 7472 2c20 6c69  s = dict[str, li
+00001020: 7374 5b64 6963 745b 7374 722c 2041 6e79  st[dict[str, Any
+00001030: 5d5d 5d0a 2320 2872 6563 6f6d 6d65 6e64  ]]].# (recommend
+00001040: 6174 696f 6e73 2c20 636c 6965 6e74 206d  ations, client m
+00001050: 6573 7361 6765 732c 2077 6f72 6b65 7220  essages, worker 
+00001060: 6d65 7373 6167 6573 290a 5265 6373 4d73  messages).RecsMs
+00001070: 6773 3a20 5479 7065 416c 6961 7320 3d20  gs: TypeAlias = 
+00001080: 7475 706c 655b 5265 6373 2c20 4d73 6773  tuple[Recs, Msgs
+00001090: 2c20 4d73 6773 5d0a 0a6c 6f67 6765 7220  , Msgs]..logger 
+000010a0: 3d20 6c6f 6767 696e 672e 6765 744c 6f67  = logging.getLog
+000010b0: 6765 7228 5f5f 6e61 6d65 5f5f 290a 4c4f  ger(__name__).LO
+000010c0: 475f 5044 4220 3d20 6461 736b 2e63 6f6e  G_PDB = dask.con
+000010d0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+000010e0: 7574 6564 2e61 646d 696e 2e70 6462 2d6f  uted.admin.pdb-o
+000010f0: 6e2d 6572 7222 290a 4445 4641 554c 545f  n-err").DEFAULT_
+00001100: 4441 5441 5f53 495a 4520 3d20 7061 7273  DATA_SIZE = pars
+00001110: 655f 6279 7465 7328 0a20 2020 2064 6173  e_bytes(.    das
+00001120: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+00001130: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00001140: 6c65 722e 6465 6661 756c 742d 6461 7461  ler.default-data
+00001150: 2d73 697a 6522 290a 290a 5354 494d 554c  -size").).STIMUL
+00001160: 5553 5f49 445f 554e 5345 5420 3d20 223c  US_ID_UNSET = "<
+00001170: 7374 696d 756c 7573 5f69 6420 756e 7365  stimulus_id unse
+00001180: 743e 220a 0a44 4546 4155 4c54 5f45 5854  t>"..DEFAULT_EXT
+00001190: 454e 5349 4f4e 5320 3d20 7b0a 2020 2020  ENSIONS = {.    
+000011a0: 226c 6f63 6b73 223a 204c 6f63 6b45 7874  "locks": LockExt
+000011b0: 656e 7369 6f6e 2c0a 2020 2020 226d 756c  ension,.    "mul
+000011c0: 7469 5f6c 6f63 6b73 223a 204d 756c 7469  ti_locks": Multi
+000011d0: 4c6f 636b 4578 7465 6e73 696f 6e2c 0a20  LockExtension,. 
+000011e0: 2020 2022 7075 626c 6973 6822 3a20 5075     "publish": Pu
+000011f0: 626c 6973 6845 7874 656e 7369 6f6e 2c0a  blishExtension,.
+00001200: 2020 2020 2272 6570 6c61 792d 7461 736b      "replay-task
+00001210: 7322 3a20 5265 706c 6179 5461 736b 5363  s": ReplayTaskSc
+00001220: 6865 6475 6c65 722c 0a20 2020 2022 7175  heduler,.    "qu
+00001230: 6575 6573 223a 2051 7565 7565 4578 7465  eues": QueueExte
+00001240: 6e73 696f 6e2c 0a20 2020 2022 7661 7269  nsion,.    "vari
+00001250: 6162 6c65 7322 3a20 5661 7269 6162 6c65  ables": Variable
+00001260: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+00001270: 7075 6273 7562 223a 2050 7562 5375 6253  pubsub": PubSubS
+00001280: 6368 6564 756c 6572 4578 7465 6e73 696f  chedulerExtensio
+00001290: 6e2c 0a20 2020 2022 7365 6d61 7068 6f72  n,.    "semaphor
+000012a0: 6573 223a 2053 656d 6170 686f 7265 4578  es": SemaphoreEx
+000012b0: 7465 6e73 696f 6e2c 0a20 2020 2022 6576  tension,.    "ev
+000012c0: 656e 7473 223a 2045 7665 6e74 4578 7465  ents": EventExte
+000012d0: 6e73 696f 6e2c 0a20 2020 2022 616d 6d22  nsion,.    "amm"
+000012e0: 3a20 4163 7469 7665 4d65 6d6f 7279 4d61  : ActiveMemoryMa
+000012f0: 6e61 6765 7245 7874 656e 7369 6f6e 2c0a  nagerExtension,.
+00001300: 2020 2020 226d 656d 6f72 795f 7361 6d70      "memory_samp
+00001310: 6c65 7222 3a20 4d65 6d6f 7279 5361 6d70  ler": MemorySamp
+00001320: 6c65 7245 7874 656e 7369 6f6e 2c0a 2020  lerExtension,.  
+00001330: 2020 2273 6875 6666 6c65 223a 2053 6875    "shuffle": Shu
+00001340: 6666 6c65 5363 6865 6475 6c65 7250 6c75  ffleSchedulerPlu
+00001350: 6769 6e2c 0a20 2020 2022 7370 616e 7322  gin,.    "spans"
+00001360: 3a20 5370 616e 7353 6368 6564 756c 6572  : SpansScheduler
+00001370: 4578 7465 6e73 696f 6e2c 0a20 2020 2022  Extension,.    "
+00001380: 7374 6561 6c69 6e67 223a 2057 6f72 6b53  stealing": WorkS
+00001390: 7465 616c 696e 672c 0a7d 0a0a 0a63 6c61  tealing,.}...cla
+000013a0: 7373 2043 6c69 656e 7453 7461 7465 3a0a  ss ClientState:.
+000013b0: 2020 2020 2222 2241 2073 696d 706c 6520      """A simple 
+000013c0: 6f62 6a65 6374 2068 6f6c 6469 6e67 2069  object holding i
+000013d0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+000013e0: 2061 2063 6c69 656e 742e 2222 220a 0a20   a client.""".. 
+000013f0: 2020 2023 3a20 4120 756e 6971 7565 2069     #: A unique i
+00001400: 6465 6e74 6966 6965 7220 666f 7220 7468  dentifier for th
+00001410: 6973 2063 6c69 656e 742e 2054 6869 7320  is client. This 
+00001420: 6973 2067 656e 6572 616c 6c79 2061 6e20  is generally an 
+00001430: 6f70 6171 7565 0a20 2020 2023 3a20 7374  opaque.    #: st
+00001440: 7269 6e67 2067 656e 6572 6174 6564 2062  ring generated b
+00001450: 7920 7468 6520 636c 6965 6e74 2069 7473  y the client its
+00001460: 656c 662e 0a20 2020 2063 6c69 656e 745f  elf..    client_
+00001470: 6b65 793a 2073 7472 0a0a 2020 2020 233a  key: str..    #:
+00001480: 2043 6163 6865 6420 6861 7368 206f 6620   Cached hash of 
+00001490: 3a61 7474 723a 607e 436c 6965 6e74 5374  :attr:`~ClientSt
+000014a0: 6174 652e 636c 6965 6e74 5f6b 6579 600a  ate.client_key`.
+000014b0: 2020 2020 5f68 6173 683a 2069 6e74 0a0a      _hash: int..
+000014c0: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
+000014d0: 7461 736b 7320 7468 6973 2063 6c69 656e  tasks this clien
+000014e0: 7420 7761 6e74 7320 746f 2062 6520 6b65  t wants to be ke
+000014f0: 7074 2069 6e20 6d65 6d6f 7279 2c20 736f  pt in memory, so
+00001500: 2074 6861 7420 6974 2063 616e 2064 6f77   that it can dow
+00001510: 6e6c 6f61 640a 2020 2020 233a 2069 7473  nload.    #: its
+00001520: 2072 6573 756c 7420 7768 656e 2064 6573   result when des
+00001530: 6972 6564 2e20 5468 6973 2069 7320 7468  ired. This is th
+00001540: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
+00001550: 6720 6f66 0a20 2020 2023 3a20 3a63 6c61  g of.    #: :cla
+00001560: 7373 3a60 5461 736b 5374 6174 652e 7768  ss:`TaskState.wh
+00001570: 6f5f 7761 6e74 7360 2e20 5461 736b 7320  o_wants`. Tasks 
+00001580: 6172 6520 7479 7069 6361 6c6c 7920 7265  are typically re
+00001590: 6d6f 7665 6420 6672 6f6d 2074 6869 7320  moved from this 
+000015a0: 7365 7420 7768 656e 2074 6865 0a20 2020  set when the.   
+000015b0: 2023 3a20 636f 7272 6573 706f 6e64 696e   #: correspondin
+000015c0: 6720 6f62 6a65 6374 2069 6e20 7468 6520  g object in the 
+000015d0: 636c 6965 6e74 2773 2073 7061 6365 2028  client's space (
+000015e0: 666f 7220 6578 616d 706c 6520 6120 6060  for example a ``
+000015f0: 4675 7475 7265 6060 206f 7220 6120 4461  Future`` or a Da
+00001600: 736b 0a20 2020 2023 3a20 636f 6c6c 6563  sk.    #: collec
+00001610: 7469 6f6e 2920 6765 7473 2067 6172 6261  tion) gets garba
+00001620: 6765 2d63 6f6c 6c65 6374 6564 2e0a 2020  ge-collected..  
+00001630: 2020 7761 6e74 735f 7768 6174 3a20 7365    wants_what: se
+00001640: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+00001650: 2020 233a 2054 6865 206c 6173 7420 7469    #: The last ti
+00001660: 6d65 2077 6520 7265 6365 6976 6564 2061  me we received a
+00001670: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
+00001680: 7468 6973 2063 6c69 656e 742c 2069 6e20  this client, in 
+00001690: 6c6f 6361 6c20 7363 6865 6475 6c65 7220  local scheduler 
+000016a0: 7469 6d65 2e0a 2020 2020 6c61 7374 5f73  time..    last_s
+000016b0: 6565 6e3a 2066 6c6f 6174 0a0a 2020 2020  een: float..    
+000016c0: 233a 204f 7574 7075 7420 6f66 203a 6675  #: Output of :fu
+000016d0: 6e63 3a60 6469 7374 7269 6275 7465 642e  nc:`distributed.
+000016e0: 7665 7273 696f 6e73 2e67 6574 5f76 6572  versions.get_ver
+000016f0: 7369 6f6e 7360 206f 6e20 7468 6520 636c  sions` on the cl
+00001700: 6965 6e74 0a20 2020 2076 6572 7369 6f6e  ient.    version
+00001710: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+00001720: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
+00001730: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+00001740: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+00001750: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00001760: 2c20 636c 6965 6e74 3a20 7374 722c 202a  , client: str, *
+00001770: 2c20 7665 7273 696f 6e73 3a20 6469 6374  , versions: dict
+00001780: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
+00001790: 6520 3d20 4e6f 6e65 293a 0a20 2020 2020  e = None):.     
+000017a0: 2020 2073 656c 662e 636c 6965 6e74 5f6b     self.client_k
+000017b0: 6579 203d 2063 6c69 656e 740a 2020 2020  ey = client.    
+000017c0: 2020 2020 7365 6c66 2e5f 6861 7368 203d      self._hash =
+000017d0: 2068 6173 6828 636c 6965 6e74 290a 2020   hash(client).  
+000017e0: 2020 2020 2020 7365 6c66 2e77 616e 7473        self.wants
+000017f0: 5f77 6861 7420 3d20 7365 7428 290a 2020  _what = set().  
+00001800: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
+00001810: 7365 656e 203d 2074 696d 6528 290a 2020  seen = time().  
+00001820: 2020 2020 2020 7365 6c66 2e76 6572 7369        self.versi
+00001830: 6f6e 7320 3d20 7665 7273 696f 6e73 206f  ons = versions o
+00001840: 7220 7b7d 0a0a 2020 2020 6465 6620 5f5f  r {}..    def __
+00001850: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
+00001860: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
+00001870: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
+00001880: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
+00001890: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
+000018a0: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
+000018b0: 2020 2020 2069 6620 6e6f 7420 6973 696e       if not isin
+000018c0: 7374 616e 6365 286f 7468 6572 2c20 436c  stance(other, Cl
+000018d0: 6965 6e74 5374 6174 6529 3a0a 2020 2020  ientState):.    
+000018e0: 2020 2020 2020 2020 7265 7475 726e 2046          return F
+000018f0: 616c 7365 0a20 2020 2020 2020 2072 6574  alse.        ret
+00001900: 7572 6e20 7365 6c66 2e63 6c69 656e 745f  urn self.client_
+00001910: 6b65 7920 3d3d 206f 7468 6572 2e63 6c69  key == other.cli
+00001920: 656e 745f 6b65 790a 0a20 2020 2064 6566  ent_key..    def
+00001930: 205f 5f72 6570 725f 5f28 7365 6c66 2920   __repr__(self) 
+00001940: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00001950: 7265 7475 726e 2066 223c 436c 6965 6e74  return f"<Client
+00001960: 207b 7365 6c66 2e63 6c69 656e 745f 6b65   {self.client_ke
+00001970: 7921 727d 3e22 0a0a 2020 2020 6465 6620  y!r}>"..    def 
+00001980: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
+00001990: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+000019a0: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
+000019b0: 5f6b 6579 0a0a 2020 2020 6465 6620 5f74  _key..    def _t
+000019c0: 6f5f 6469 6374 5f6e 6f5f 6e65 7374 2873  o_dict_no_nest(s
+000019d0: 656c 662c 202a 2c20 6578 636c 7564 653a  elf, *, exclude:
+000019e0: 2043 6f6e 7461 696e 6572 5b73 7472 5d20   Container[str] 
+000019f0: 3d20 2829 2920 2d3e 2064 6963 743a 0a20  = ()) -> dict:. 
+00001a00: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
+00001a10: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
+00001a20: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
+00001a30: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
+00001a40: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
+00001a50: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
+00001a60: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
+00001a70: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
+00001a80: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+00001a90: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00001aa0: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
+00001ab0: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
+00001ac0: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
+00001ad0: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
+00001ae0: 5f64 6963 740a 2020 2020 2020 2020 5461  _dict.        Ta
+00001af0: 736b 5374 6174 652e 5f74 6f5f 6469 6374  skState._to_dict
+00001b00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00001b10: 2020 2020 2072 6574 7572 6e20 7265 6375       return recu
+00001b20: 7273 6976 655f 746f 5f64 6963 7428 0a20  rsive_to_dict(. 
+00001b30: 2020 2020 2020 2020 2020 2073 656c 662c             self,
+00001b40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00001b50: 6c75 6465 3d73 6574 2865 7863 6c75 6465  lude=set(exclude
+00001b60: 2920 7c20 7b22 7665 7273 696f 6e73 227d  ) | {"versions"}
+00001b70: 2c20 2023 2074 7970 653a 2069 676e 6f72  ,  # type: ignor
+00001b80: 650a 2020 2020 2020 2020 2020 2020 6d65  e.            me
+00001b90: 6d62 6572 733d 5472 7565 2c0a 2020 2020  mbers=True,.    
+00001ba0: 2020 2020 290a 0a0a 636c 6173 7320 4d65      )...class Me
+00001bb0: 6d6f 7279 5374 6174 653a 0a20 2020 2022  moryState:.    "
+00001bc0: 2222 4d65 6d6f 7279 2072 6561 6469 6e67  ""Memory reading
+00001bd0: 7320 6f6e 2061 2077 6f72 6b65 7220 6f72  s on a worker or
+00001be0: 206f 6e20 7468 6520 7768 6f6c 6520 636c   on the whole cl
+00001bf0: 7573 7465 722e 0a0a 2020 2020 5365 6520  uster...    See 
+00001c00: 3a64 6f63 3a60 776f 726b 6572 2d6d 656d  :doc:`worker-mem
+00001c10: 6f72 7960 2e0a 0a20 2020 2041 7474 7269  ory`...    Attri
+00001c20: 6275 7465 7320 2f20 7072 6f70 6572 7469  butes / properti
+00001c30: 6573 3a0a 0a20 2020 206d 616e 6167 6564  es:..    managed
+00001c40: 5f74 6f74 616c 0a20 2020 2020 2020 2053  _total.        S
+00001c50: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
+00001c60: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
+00001c70: 2061 6c6c 2064 6173 6b20 6b65 7973 2068   all dask keys h
+00001c80: 656c 6420 6279 2074 6865 2077 6f72 6b65  eld by the worke
+00001c90: 7220 696e 206d 656d 6f72 792c 0a20 2020  r in memory,.   
+00001ca0: 2020 2020 2070 6c75 7320 6e75 6d62 6572       plus number
+00001cb0: 206f 6620 6279 7465 7320 7370 696c 6c65   of bytes spille
+00001cc0: 6420 746f 2064 6973 6b0a 0a20 2020 206d  d to disk..    m
+00001cd0: 616e 6167 6564 0a20 2020 2020 2020 2053  anaged.        S
+00001ce0: 756d 206f 6620 7468 6520 6f75 7470 7574  um of the output
+00001cf0: 206f 6620 7369 7a65 6f66 2829 2066 6f72   of sizeof() for
+00001d00: 2074 6865 2064 6173 6b20 6b65 7973 2068   the dask keys h
+00001d10: 656c 6420 696e 2052 414d 2e20 4e6f 7465  eld in RAM. Note
+00001d20: 2074 6861 7420 7468 6973 206d 6179 0a20   that this may. 
+00001d30: 2020 2020 2020 2062 6520 696e 6163 6375         be inaccu
+00001d40: 7261 7465 2c20 7768 6963 6820 6d61 7920  rate, which may 
+00001d50: 6361 7573 6520 696e 6163 6375 7261 7465  cause inaccurate
+00001d60: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
+00001d70: 7920 2873 6565 2062 656c 6f77 292e 0a0a  y (see below)...
+00001d80: 2020 2020 7370 696c 6c65 640a 2020 2020      spilled.    
+00001d90: 2020 2020 4e75 6d62 6572 206f 6620 6279      Number of by
+00001da0: 7465 7320 2066 6f72 2074 6865 2064 6173  tes  for the das
+00001db0: 6b20 6b65 7973 2073 7069 6c6c 6564 2074  k keys spilled t
+00001dc0: 6f20 7468 6520 6861 7264 2064 7269 7665  o the hard drive
+00001dd0: 2e0a 2020 2020 2020 2020 4e6f 7465 2074  ..        Note t
+00001de0: 6861 7420 7468 6973 2069 7320 7468 6520  hat this is the 
+00001df0: 7369 7a65 206f 6e20 6469 736b 3b20 7369  size on disk; si
+00001e00: 7a65 2069 6e20 6d65 6d6f 7279 206d 6179  ze in memory may
+00001e10: 2062 6520 6469 6666 6572 656e 7420 6475   be different du
+00001e20: 6520 746f 0a20 2020 2020 2020 2063 6f6d  e to.        com
+00001e30: 7072 6573 7369 6f6e 2061 6e64 2069 6e61  pression and ina
+00001e40: 6363 7572 6163 6965 7320 696e 2073 697a  ccuracies in siz
+00001e50: 656f 6628 292e 2049 6e20 6f74 6865 7220  eof(). In other 
+00001e60: 776f 7264 732c 2067 6976 656e 2074 6865  words, given the
+00001e70: 2073 616d 6520 6b65 7973 2c0a 2020 2020   same keys,.    
+00001e80: 2020 2020 276d 616e 6167 6564 2720 7769      'managed' wi
+00001e90: 6c6c 2063 6861 6e67 6520 6465 7065 6e64  ll change depend
+00001ea0: 696e 6720 6f6e 2074 6865 206b 6579 7320  ing on the keys 
+00001eb0: 6265 696e 6720 696e 206d 656d 6f72 7920  being in memory 
+00001ec0: 6f72 2073 7069 6c6c 6564 2e0a 0a20 2020  or spilled...   
+00001ed0: 2070 726f 6365 7373 0a20 2020 2020 2020   process.       
+00001ee0: 2054 6f74 616c 2052 5353 206d 656d 6f72   Total RSS memor
+00001ef0: 7920 6d65 6173 7572 6564 2062 7920 7468  y measured by th
+00001f00: 6520 4f53 206f 6e20 7468 6520 776f 726b  e OS on the work
+00001f10: 6572 2070 726f 6365 7373 2e0a 2020 2020  er process..    
+00001f20: 2020 2020 5468 6973 2069 7320 616c 7761      This is alwa
+00001f30: 7973 2065 7861 6374 6c79 2065 7175 616c  ys exactly equal
+00001f40: 2074 6f20 6d61 6e61 6765 6420 2b20 756e   to managed + un
+00001f50: 6d61 6e61 6765 642e 0a0a 2020 2020 756e  managed...    un
+00001f60: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
+00001f70: 7072 6f63 6573 7320 2d20 6d61 6e61 6765  process - manage
+00001f80: 642e 2054 6869 7320 6973 2074 6865 2073  d. This is the s
+00001f90: 756d 206f 660a 0a20 2020 2020 2020 202d  um of..        -
+00001fa0: 2050 7974 686f 6e20 696e 7465 7270 7265   Python interpre
+00001fb0: 7465 7220 616e 6420 6d6f 6475 6c65 730a  ter and modules.
+00001fc0: 2020 2020 2020 2020 2d20 676c 6f62 616c          - global
+00001fd0: 2076 6172 6961 626c 6573 0a20 2020 2020   variables.     
+00001fe0: 2020 202d 206d 656d 6f72 7920 7465 6d70     - memory temp
+00001ff0: 6f72 6172 696c 7920 616c 6c6f 6361 7465  orarily allocate
+00002000: 6420 6279 2074 6865 2064 6173 6b20 7461  d by the dask ta
+00002010: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
+00002020: 7265 6e74 6c79 2072 756e 6e69 6e67 0a20  rently running. 
+00002030: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
+00002040: 6672 6167 6d65 6e74 6174 696f 6e0a 2020  fragmentation.  
+00002050: 2020 2020 2020 2d20 6d65 6d6f 7279 206c        - memory l
+00002060: 6561 6b73 0a20 2020 2020 2020 202d 206d  eaks.        - m
+00002070: 656d 6f72 7920 6e6f 7420 7965 7420 6761  emory not yet ga
+00002080: 7262 6167 6520 636f 6c6c 6563 7465 640a  rbage collected.
+00002090: 2020 2020 2020 2020 2d20 6d65 6d6f 7279          - memory
+000020a0: 206e 6f74 2079 6574 2066 7265 6528 2927   not yet free()'
+000020b0: 6420 6279 2074 6865 2050 7974 686f 6e20  d by the Python 
+000020c0: 6d65 6d6f 7279 206d 616e 6167 6572 2074  memory manager t
+000020d0: 6f20 7468 6520 4f53 0a0a 2020 2020 756e  o the OS..    un
+000020e0: 6d61 6e61 6765 645f 6f6c 640a 2020 2020  managed_old.    
+000020f0: 2020 2020 4d69 6e69 6d75 6d20 6f66 2074      Minimum of t
+00002100: 6865 2027 756e 6d61 6e61 6765 6427 206d  he 'unmanaged' m
+00002110: 6561 7375 7265 7320 6f76 6572 2074 6865  easures over the
+00002120: 206c 6173 740a 2020 2020 2020 2020 6060   last.        ``
+00002130: 6469 7374 7269 6275 7465 642e 6d65 6d6f  distributed.memo
+00002140: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
+00002150: 2d74 696d 6560 6020 7365 636f 6e64 730a  -time`` seconds.
+00002160: 0a20 2020 2075 6e6d 616e 6167 6564 5f72  .    unmanaged_r
+00002170: 6563 656e 740a 2020 2020 2020 2020 756e  ecent.        un
+00002180: 6d61 6e61 6765 6420 2d20 756e 6d61 6e61  managed - unmana
+00002190: 6765 645f 6f6c 643b 2069 6e20 6f74 6865  ged_old; in othe
+000021a0: 7220 776f 7264 7320 7072 6f63 6573 7320  r words process 
+000021b0: 6d65 6d6f 7279 2074 6861 7420 6861 7320  memory that has 
+000021c0: 6265 656e 2072 6563 656e 746c 790a 2020  been recently.  
+000021d0: 2020 2020 2020 616c 6c6f 6361 7465 6420        allocated 
+000021e0: 6275 7420 6973 206e 6f74 2061 6363 6f75  but is not accou
+000021f0: 6e74 6564 2066 6f72 2062 7920 6461 736b  nted for by dask
+00002200: 3b20 686f 7065 6675 6c6c 7920 6974 2773  ; hopefully it's
+00002210: 206d 6f73 746c 7920 6120 7465 6d70 6f72   mostly a tempor
+00002220: 6172 790a 2020 2020 2020 2020 7370 696b  ary.        spik
+00002230: 652e 0a0a 2020 2020 6f70 7469 6d69 7374  e...    optimist
+00002240: 6963 0a20 2020 2020 2020 206d 616e 6167  ic.        manag
+00002250: 6564 202b 2075 6e6d 616e 6167 6564 5f6f  ed + unmanaged_o
+00002260: 6c64 3b20 696e 206f 7468 6572 2077 6f72  ld; in other wor
+00002270: 6473 2074 6865 206d 656d 6f72 7920 6865  ds the memory he
+00002280: 6c64 206c 6f6e 672d 7465 726d 2062 790a  ld long-term by.
+00002290: 2020 2020 2020 2020 7468 6520 7072 6f63          the proc
+000022a0: 6573 7320 756e 6465 7220 7468 6520 686f  ess under the ho
+000022b0: 7065 6675 6c20 6173 7375 6d70 7469 6f6e  peful assumption
+000022c0: 2074 6861 7420 616c 6c20 756e 6d61 6e61   that all unmana
+000022d0: 6765 645f 7265 6365 6e74 206d 656d 6f72  ged_recent memor
+000022e0: 7920 6973 2061 0a20 2020 2020 2020 2074  y is a.        t
+000022f0: 656d 706f 7261 7279 2073 7069 6b65 0a20  emporary spike. 
+00002300: 2020 2022 2222 0a0a 2020 2020 7072 6f63     """..    proc
+00002310: 6573 733a 2069 6e74 0a20 2020 2075 6e6d  ess: int.    unm
+00002320: 616e 6167 6564 5f6f 6c64 3a20 696e 740a  anaged_old: int.
+00002330: 2020 2020 6d61 6e61 6765 643a 2069 6e74      managed: int
+00002340: 0a20 2020 2073 7069 6c6c 6564 3a20 696e  .    spilled: in
+00002350: 740a 0a20 2020 205f 5f73 6c6f 7473 5f5f  t..    __slots__
+00002360: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+00002370: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+00002380: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00002390: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000023a0: 2020 202a 2c0a 2020 2020 2020 2020 7072     *,.        pr
+000023b0: 6f63 6573 733a 2069 6e74 2c0a 2020 2020  ocess: int,.    
+000023c0: 2020 2020 756e 6d61 6e61 6765 645f 6f6c      unmanaged_ol
+000023d0: 643a 2069 6e74 2c0a 2020 2020 2020 2020  d: int,.        
+000023e0: 6d61 6e61 6765 643a 2069 6e74 2c0a 2020  managed: int,.  
+000023f0: 2020 2020 2020 7370 696c 6c65 643a 2069        spilled: i
+00002400: 6e74 2c0a 2020 2020 293a 0a20 2020 2020  nt,.    ):.     
+00002410: 2020 2023 2053 6f6d 6520 6461 7461 2061     # Some data a
+00002420: 7272 6976 6573 2077 6974 6820 7468 6520  rrives with the 
+00002430: 6865 6172 7462 6561 742c 2073 6f6d 6520  heartbeat, some 
+00002440: 6f74 6865 7220 6172 7269 7665 7320 696e  other arrives in
+00002450: 2072 6561 6c74 696d 6520 6173 2074 6865   realtime as the
+00002460: 0a20 2020 2020 2020 2023 2074 6173 6b73  .        # tasks
+00002470: 2070 726f 6772 6573 732e 2041 6c73 6f2c   progress. Also,
+00002480: 2073 697a 656f 6628 2920 6973 206e 6f74   sizeof() is not
+00002490: 2067 7561 7261 6e74 6565 6420 746f 2072   guaranteed to r
+000024a0: 6574 7572 6e20 636f 7272 6563 7420 7265  eturn correct re
+000024b0: 7375 6c74 732e 0a20 2020 2020 2020 2023  sults..        #
+000024c0: 2054 6869 7320 6361 6e20 6361 7573 6520   This can cause 
+000024d0: 676c 6974 6368 6573 2077 6865 7265 2061  glitches where a
+000024e0: 2070 6172 7469 616c 206d 6561 7375 7265   partial measure
+000024f0: 2069 7320 6c61 7267 6572 2074 6861 6e20   is larger than 
+00002500: 7468 6520 7768 6f6c 652c 2073 6f0a 2020  the whole, so.  
+00002510: 2020 2020 2020 2320 7765 206e 6565 6420        # we need 
+00002520: 746f 2066 6f72 6365 2061 6c6c 206e 756d  to force all num
+00002530: 6265 7273 2074 6f20 6164 6420 7570 2065  bers to add up e
+00002540: 7861 6374 6c79 2062 7920 6465 6669 6e69  xactly by defini
+00002550: 7469 6f6e 2e0a 2020 2020 2020 2020 7365  tion..        se
+00002560: 6c66 2e70 726f 6365 7373 203d 2070 726f  lf.process = pro
+00002570: 6365 7373 0a20 2020 2020 2020 2073 656c  cess.        sel
+00002580: 662e 6d61 6e61 6765 6420 3d20 6d69 6e28  f.managed = min(
+00002590: 7365 6c66 2e70 726f 6365 7373 2c20 6d61  self.process, ma
+000025a0: 6e61 6765 6429 0a20 2020 2020 2020 2073  naged).        s
+000025b0: 656c 662e 7370 696c 6c65 6420 3d20 7370  elf.spilled = sp
+000025c0: 696c 6c65 640a 2020 2020 2020 2020 2320  illed.        # 
+000025d0: 5375 6274 7261 6374 696f 6e73 2062 6574  Subtractions bet
+000025e0: 7765 656e 2075 6e73 6967 6e65 6420 696e  ween unsigned in
+000025f0: 7473 2067 7561 7261 6e74 6565 6420 6279  ts guaranteed by
+00002600: 2063 6f6e 7374 7275 6374 696f 6e20 746f   construction to
+00002610: 2062 6520 3e3d 2030 0a20 2020 2020 2020   be >= 0.       
+00002620: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
+00002630: 6f6c 6420 3d20 6d69 6e28 756e 6d61 6e61  old = min(unmana
+00002640: 6765 645f 6f6c 642c 2070 726f 6365 7373  ged_old, process
+00002650: 202d 2073 656c 662e 6d61 6e61 6765 6429   - self.managed)
+00002660: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00002670: 686f 640a 2020 2020 6465 6620 7375 6d28  hod.    def sum(
+00002680: 2a69 6e66 6f73 3a20 4d65 6d6f 7279 5374  *infos: MemorySt
+00002690: 6174 6529 202d 3e20 4d65 6d6f 7279 5374  ate) -> MemorySt
+000026a0: 6174 653a 0a20 2020 2020 2020 2070 726f  ate:.        pro
+000026b0: 6365 7373 203d 2030 0a20 2020 2020 2020  cess = 0.       
+000026c0: 2075 6e6d 616e 6167 6564 5f6f 6c64 203d   unmanaged_old =
+000026d0: 2030 0a20 2020 2020 2020 206d 616e 6167   0.        manag
+000026e0: 6564 203d 2030 0a20 2020 2020 2020 2073  ed = 0.        s
+000026f0: 7069 6c6c 6564 203d 2030 0a20 2020 2020  pilled = 0.     
+00002700: 2020 2066 6f72 206d 7320 696e 2069 6e66     for ms in inf
+00002710: 6f73 3a0a 2020 2020 2020 2020 2020 2020  os:.            
+00002720: 7072 6f63 6573 7320 2b3d 206d 732e 7072  process += ms.pr
+00002730: 6f63 6573 730a 2020 2020 2020 2020 2020  ocess.          
+00002740: 2020 756e 6d61 6e61 6765 645f 6f6c 6420    unmanaged_old 
+00002750: 2b3d 206d 732e 756e 6d61 6e61 6765 645f  += ms.unmanaged_
+00002760: 6f6c 640a 2020 2020 2020 2020 2020 2020  old.            
+00002770: 7370 696c 6c65 6420 2b3d 206d 732e 7370  spilled += ms.sp
+00002780: 696c 6c65 640a 2020 2020 2020 2020 2020  illed.          
+00002790: 2020 6d61 6e61 6765 6420 2b3d 206d 732e    managed += ms.
+000027a0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
+000027b0: 7265 7475 726e 204d 656d 6f72 7953 7461  return MemorySta
+000027c0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+000027d0: 7072 6f63 6573 733d 7072 6f63 6573 732c  process=process,
+000027e0: 0a20 2020 2020 2020 2020 2020 2075 6e6d  .            unm
+000027f0: 616e 6167 6564 5f6f 6c64 3d75 6e6d 616e  anaged_old=unman
+00002800: 6167 6564 5f6f 6c64 2c0a 2020 2020 2020  aged_old,.      
+00002810: 2020 2020 2020 6d61 6e61 6765 643d 6d61        managed=ma
+00002820: 6e61 6765 642c 0a20 2020 2020 2020 2020  naged,.         
+00002830: 2020 2073 7069 6c6c 6564 3d73 7069 6c6c     spilled=spill
+00002840: 6564 2c0a 2020 2020 2020 2020 290a 0a20  ed,.        ).. 
+00002850: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00002860: 2064 6566 206d 616e 6167 6564 5f74 6f74   def managed_tot
+00002870: 616c 2873 656c 6629 202d 3e20 696e 743a  al(self) -> int:
+00002880: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002890: 7365 6c66 2e6d 616e 6167 6564 202b 2073  self.managed + s
+000028a0: 656c 662e 7370 696c 6c65 640a 0a20 2020  elf.spilled..   
+000028b0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000028c0: 6566 2075 6e6d 616e 6167 6564 2873 656c  ef unmanaged(sel
+000028d0: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+000028e0: 2020 2023 2054 6869 7320 6973 206e 6576     # This is nev
+000028f0: 6572 206e 6567 6174 6976 6520 7468 616e  er negative than
+00002900: 6b73 2074 6f20 5f5f 696e 6974 5f5f 0a20  ks to __init__. 
+00002910: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00002920: 6c66 2e70 726f 6365 7373 202d 2073 656c  lf.process - sel
+00002930: 662e 6d61 6e61 6765 640a 0a20 2020 2040  f.managed..    @
+00002940: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00002950: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+00002960: 7428 7365 6c66 2920 2d3e 2069 6e74 3a0a  t(self) -> int:.
+00002970: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
+00002980: 7320 6e65 7665 7220 6e65 6761 7469 7665  s never negative
+00002990: 2074 6861 6e6b 7320 746f 205f 5f69 6e69   thanks to __ini
+000029a0: 745f 5f0a 2020 2020 2020 2020 7265 7475  t__.        retu
+000029b0: 726e 2073 656c 662e 7072 6f63 6573 7320  rn self.process 
+000029c0: 2d20 7365 6c66 2e6d 616e 6167 6564 202d  - self.managed -
+000029d0: 2073 656c 662e 756e 6d61 6e61 6765 645f   self.unmanaged_
+000029e0: 6f6c 640a 0a20 2020 2040 7072 6f70 6572  old..    @proper
+000029f0: 7479 0a20 2020 2064 6566 206f 7074 696d  ty.    def optim
+00002a00: 6973 7469 6328 7365 6c66 2920 2d3e 2069  istic(self) -> i
+00002a10: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+00002a20: 726e 2073 656c 662e 6d61 6e61 6765 6420  rn self.managed 
+00002a30: 2b20 7365 6c66 2e75 6e6d 616e 6167 6564  + self.unmanaged
+00002a40: 5f6f 6c64 0a0a 2020 2020 4070 726f 7065  _old..    @prope
+00002a50: 7274 790a 2020 2020 6465 6620 6d61 6e61  rty.    def mana
+00002a60: 6765 645f 696e 5f6d 656d 6f72 7928 7365  ged_in_memory(se
+00002a70: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00002a80: 2020 2020 7761 726e 696e 6773 2e77 6172      warnings.war
+00002a90: 6e28 226d 616e 6167 6564 5f69 6e5f 6d65  n("managed_in_me
+00002aa0: 6d6f 7279 2068 6173 2062 6565 6e20 7265  mory has been re
+00002ab0: 6e61 6d65 6420 746f 206d 616e 6167 6564  named to managed
+00002ac0: 222c 2046 7574 7572 6557 6172 6e69 6e67  ", FutureWarning
+00002ad0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00002ae0: 2073 656c 662e 6d61 6e61 6765 640a 0a20   self.managed.. 
+00002af0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+00002b00: 2064 6566 206d 616e 6167 6564 5f73 7069   def managed_spi
+00002b10: 6c6c 6564 2873 656c 6629 202d 3e20 696e  lled(self) -> in
+00002b20: 743a 0a20 2020 2020 2020 2077 6172 6e69  t:.        warni
+00002b30: 6e67 732e 7761 726e 2822 6d61 6e61 6765  ngs.warn("manage
+00002b40: 645f 7370 696c 6c65 6420 6861 7320 6265  d_spilled has be
+00002b50: 656e 2072 656e 616d 6564 2074 6f20 7370  en renamed to sp
+00002b60: 696c 6c65 6422 2c20 4675 7475 7265 5761  illed", FutureWa
+00002b70: 726e 696e 6729 0a20 2020 2020 2020 2072  rning).        r
+00002b80: 6574 7572 6e20 7365 6c66 2e73 7069 6c6c  eturn self.spill
+00002b90: 6564 0a0a 2020 2020 6465 6620 5f5f 7265  ed..    def __re
+00002ba0: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
+00002bb0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+00002bc0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00002bd0: 6622 5072 6f63 6573 7320 6d65 6d6f 7279  f"Process memory
+00002be0: 2028 5253 5329 2020 3a20 7b66 6f72 6d61   (RSS)  : {forma
+00002bf0: 745f 6279 7465 7328 7365 6c66 2e70 726f  t_bytes(self.pro
+00002c00: 6365 7373 297d 5c6e 220a 2020 2020 2020  cess)}\n".      
+00002c10: 2020 2020 2020 6622 2020 2d20 6d61 6e61        f"  - mana
+00002c20: 6765 6420 6279 2044 6173 6b20 2020 3a20  ged by Dask   : 
+00002c30: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
+00002c40: 6c66 2e6d 616e 6167 6564 297d 5c6e 220a  lf.managed)}\n".
+00002c50: 2020 2020 2020 2020 2020 2020 6622 2020              f"  
+00002c60: 2d20 756e 6d61 6e61 6765 6420 286f 6c64  - unmanaged (old
+00002c70: 2920 2020 3a20 7b66 6f72 6d61 745f 6279  )   : {format_by
+00002c80: 7465 7328 7365 6c66 2e75 6e6d 616e 6167  tes(self.unmanag
+00002c90: 6564 5f6f 6c64 297d 5c6e 220a 2020 2020  ed_old)}\n".    
+00002ca0: 2020 2020 2020 2020 6622 2020 2d20 756e          f"  - un
+00002cb0: 6d61 6e61 6765 6420 2872 6563 656e 7429  managed (recent)
+00002cc0: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
+00002cd0: 7365 6c66 2e75 6e6d 616e 6167 6564 5f72  self.unmanaged_r
+00002ce0: 6563 656e 7429 7d5c 6e22 0a20 2020 2020  ecent)}\n".     
+00002cf0: 2020 2020 2020 2066 2253 7069 6c6c 6564         f"Spilled
+00002d00: 2074 6f20 6469 736b 2020 2020 2020 203a   to disk       :
+00002d10: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
+00002d20: 656c 662e 7370 696c 6c65 6429 7d5c 6e22  elf.spilled)}\n"
+00002d30: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00002d40: 6465 6620 5f74 6f5f 6469 6374 2873 656c  def _to_dict(sel
+00002d50: 662c 202a 2c20 6578 636c 7564 653a 2043  f, *, exclude: C
+00002d60: 6f6e 7461 696e 6572 5b73 7472 5d20 3d20  ontainer[str] = 
+00002d70: 2829 2920 2d3e 2064 6963 743a 0a20 2020  ()) -> dict:.   
+00002d80: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
+00002d90: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
+00002da0: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
+00002db0: 7075 7270 6f73 6573 2e0a 0a20 2020 2020  purposes...     
+00002dc0: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+00002dd0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00002de0: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
+00002df0: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
+00002e00: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
+00002e10: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
+00002e20: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
+00002e30: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00002e40: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00002e50: 2020 2020 6b3a 2067 6574 6174 7472 2873      k: getattr(s
+00002e60: 656c 662c 206b 290a 2020 2020 2020 2020  elf, k).        
+00002e70: 2020 2020 666f 7220 6b20 696e 2064 6972      for k in dir
+00002e80: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
+00002e90: 2020 2069 6620 6e6f 7420 6b2e 7374 6172     if not k.star
+00002ea0: 7473 7769 7468 2822 5f22 290a 2020 2020  tswith("_").    
+00002eb0: 2020 2020 2020 2020 616e 6420 6b20 6e6f          and k no
+00002ec0: 7420 696e 207b 2273 756d 222c 2022 6d61  t in {"sum", "ma
+00002ed0: 6e61 6765 645f 696e 5f6d 656d 6f72 7922  naged_in_memory"
+00002ee0: 2c20 226d 616e 6167 6564 5f73 7069 6c6c  , "managed_spill
+00002ef0: 6564 227d 0a20 2020 2020 2020 207d 0a0a  ed"}.        }..
+00002f00: 0a63 6c61 7373 2057 6f72 6b65 7253 7461  .class WorkerSta
+00002f10: 7465 3a0a 2020 2020 2222 2241 2073 696d  te:.    """A sim
+00002f20: 706c 6520 6f62 6a65 6374 2068 6f6c 6469  ple object holdi
+00002f30: 6e67 2069 6e66 6f72 6d61 7469 6f6e 2061  ng information a
+00002f40: 626f 7574 2061 2077 6f72 6b65 722e 0a0a  bout a worker...
+00002f50: 2020 2020 4e6f 7420 746f 2062 6520 636f      Not to be co
+00002f60: 6e66 7573 6564 2077 6974 6820 3a63 6c61  nfused with :cla
+00002f70: 7373 3a60 6469 7374 7269 6275 7465 642e  ss:`distributed.
+00002f80: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
+00002f90: 6869 6e65 2e57 6f72 6b65 7253 7461 7465  hine.WorkerState
+00002fa0: 602e 0a20 2020 2022 2222 0a0a 2020 2020  `..    """..    
+00002fb0: 233a 2054 6869 7320 776f 726b 6572 2773  #: This worker's
+00002fc0: 2075 6e69 7175 6520 6b65 792e 2054 6869   unique key. Thi
+00002fd0: 7320 6361 6e20 6265 2069 7473 2063 6f6e  s can be its con
+00002fe0: 6e65 6374 6564 2061 6464 7265 7373 0a20  nected address. 
+00002ff0: 2020 2023 3a20 2873 7563 6820 6173 2060     #: (such as `
+00003000: 6022 7463 703a 2f2f 3132 372e 302e 302e  `"tcp://127.0.0.
+00003010: 313a 3838 3931 2260 6029 206f 7220 616e  1:8891"``) or an
+00003020: 2061 6c69 6173 2028 7375 6368 2061 7320   alias (such as 
+00003030: 6060 2261 6c69 6365 2260 6029 2e0a 2020  ``"alice"``)..  
+00003040: 2020 6164 6472 6573 733a 2073 7472 0a0a    address: str..
+00003050: 2020 2020 7069 643a 2069 6e74 0a20 2020      pid: int.   
+00003060: 206e 616d 653a 2048 6173 6861 626c 650a   name: Hashable.
+00003070: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
+00003080: 6572 206f 6620 4350 5520 7468 7265 6164  er of CPU thread
+00003090: 7320 6d61 6465 2061 7661 696c 6162 6c65  s made available
+000030a0: 206f 6e20 7468 6973 2077 6f72 6b65 720a   on this worker.
+000030b0: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
+000030c0: 740a 0a20 2020 2023 3a20 4d65 6d6f 7279  t..    #: Memory
+000030d0: 2061 7661 696c 6162 6c65 2074 6f20 7468   available to th
+000030e0: 6520 776f 726b 6572 2c20 696e 2062 7974  e worker, in byt
+000030f0: 6573 0a20 2020 206d 656d 6f72 795f 6c69  es.    memory_li
+00003100: 6d69 743a 2069 6e74 0a0a 2020 2020 6c6f  mit: int..    lo
+00003110: 6361 6c5f 6469 7265 6374 6f72 793a 2073  cal_directory: s
+00003120: 7472 0a20 2020 2073 6572 7669 6365 733a  tr.    services:
+00003130: 2064 6963 745b 7374 722c 2069 6e74 5d0a   dict[str, int].
+00003140: 0a20 2020 2023 3a20 4f75 7470 7574 206f  .    #: Output o
+00003150: 6620 3a6d 6574 683a 6064 6973 7472 6962  f :meth:`distrib
+00003160: 7574 6564 2e76 6572 7369 6f6e 732e 6765  uted.versions.ge
+00003170: 745f 7665 7273 696f 6e73 6020 6f6e 2074  t_versions` on t
+00003180: 6865 2077 6f72 6b65 720a 2020 2020 7665  he worker.    ve
+00003190: 7273 696f 6e73 3a20 6469 6374 5b73 7472  rsions: dict[str
+000031a0: 2c20 416e 795d 0a0a 2020 2020 233a 2041  , Any]..    #: A
+000031b0: 6464 7265 7373 206f 6620 7468 6520 6173  ddress of the as
+000031c0: 736f 6369 6174 6564 203a 636c 6173 733a  sociated :class:
+000031d0: 607e 6469 7374 7269 6275 7465 642e 6e61  `~distributed.na
+000031e0: 6e6e 792e 4e61 6e6e 7960 2c20 6966 2070  nny.Nanny`, if p
+000031f0: 7265 7365 6e74 0a20 2020 206e 616e 6e79  resent.    nanny
+00003200: 3a20 7374 720a 0a20 2020 2023 3a20 5265  : str..    #: Re
+00003210: 6164 2d6f 6e6c 7920 776f 726b 6572 2073  ad-only worker s
+00003220: 7461 7475 732c 2073 796e 6365 6420 6f6e  tatus, synced on
+00003230: 6520 7761 7920 6672 6f6d 2074 6865 2072  e way from the r
+00003240: 656d 6f74 6520 576f 726b 6572 206f 626a  emote Worker obj
+00003250: 6563 740a 2020 2020 7374 6174 7573 3a20  ect.    status: 
+00003260: 5374 6174 7573 0a0a 2020 2020 233a 2043  Status..    #: C
+00003270: 6163 6865 6420 6861 7368 206f 6620 3a61  ached hash of :a
+00003280: 7474 723a 607e 576f 726b 6572 5374 6174  ttr:`~WorkerStat
+00003290: 652e 6164 6472 6573 7360 0a20 2020 205f  e.address`.    _
+000032a0: 6861 7368 3a20 696e 740a 0a20 2020 2023  hash: int..    #
+000032b0: 3a20 5468 6520 746f 7461 6c20 6d65 6d6f  : The total memo
+000032c0: 7279 2073 697a 652c 2069 6e20 6279 7465  ry size, in byte
+000032d0: 732c 2075 7365 6420 6279 2074 6865 2074  s, used by the t
+000032e0: 6173 6b73 2074 6869 7320 776f 726b 6572  asks this worker
+000032f0: 2068 6f6c 6473 2069 6e20 6d65 6d6f 7279   holds in memory
+00003300: 0a20 2020 2023 3a20 2869 2e65 2e20 7468  .    #: (i.e. th
+00003310: 6520 7461 736b 7320 696e 2074 6869 7320  e tasks in this 
+00003320: 776f 726b 6572 2773 203a 6174 7472 3a60  worker's :attr:`
+00003330: 7e57 6f72 6b65 7253 7461 7465 2e68 6173  ~WorkerState.has
+00003340: 5f77 6861 7460 292e 0a20 2020 206e 6279  _what`)..    nby
+00003350: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
+00003360: 2057 6f72 6b65 7220 6d65 6d6f 7279 2075   Worker memory u
+00003370: 6e6b 6e6f 776e 2074 6f20 7468 6520 776f  nknown to the wo
+00003380: 726b 6572 2c20 696e 2062 7974 6573 2c20  rker, in bytes, 
+00003390: 7768 6963 6820 6861 7320 6265 656e 2074  which has been t
+000033a0: 6865 7265 2066 6f72 206d 6f72 6520 7468  here for more th
+000033b0: 616e 0a20 2020 2023 3a20 3330 2073 6563  an.    #: 30 sec
+000033c0: 6f6e 6473 2e20 5365 6520 3a63 6c61 7373  onds. See :class
+000033d0: 3a60 4d65 6d6f 7279 5374 6174 6560 2e0a  :`MemoryState`..
+000033e0: 2020 2020 5f6d 656d 6f72 795f 756e 6d61      _memory_unma
+000033f0: 6e61 6765 645f 6f6c 643a 2069 6e74 0a0a  naged_old: int..
+00003400: 2020 2020 233a 2048 6973 746f 7279 206f      #: History o
+00003410: 6620 7468 6520 6c61 7374 2033 3020 7365  f the last 30 se
+00003420: 636f 6e64 7327 2077 6f72 7468 206f 6620  conds' worth of 
+00003430: 756e 6d61 6e61 6765 6420 6d65 6d6f 7279  unmanaged memory
+00003440: 2e20 5573 6564 2074 6f20 6469 6666 6572  . Used to differ
+00003450: 656e 7469 6174 650a 2020 2020 233a 2062  entiate.    #: b
+00003460: 6574 7765 656e 2022 6f6c 6422 2061 6e64  etween "old" and
+00003470: 2022 6e65 7722 2075 6e6d 616e 6167 6564   "new" unmanaged
+00003480: 206d 656d 6f72 792e 0a20 2020 2023 3a20   memory..    #: 
+00003490: 466f 726d 6174 3a20 6060 5b28 7469 6d65  Format: ``[(time
+000034a0: 7374 616d 702c 2062 7974 6573 292c 2028  stamp, bytes), (
+000034b0: 7469 6d65 7374 616d 702c 2062 7974 6573  timestamp, bytes
+000034c0: 292c 202e 2e2e 5d60 600a 2020 2020 5f6d  ), ...]``.    _m
+000034d0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+000034e0: 6869 7374 6f72 793a 2064 6571 7565 5b74  history: deque[t
+000034f0: 7570 6c65 5b66 6c6f 6174 2c20 696e 745d  uple[float, int]
+00003500: 5d0a 0a20 2020 206d 6574 7269 6373 3a20  ]..    metrics: 
+00003510: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
+00003520: 2020 2020 233a 2054 6865 206c 6173 7420      #: The last 
+00003530: 7469 6d65 2077 6520 7265 6365 6976 6564  time we received
+00003540: 2061 2068 6561 7274 6265 6174 2066 726f   a heartbeat fro
+00003550: 6d20 7468 6973 2077 6f72 6b65 722c 2069  m this worker, i
+00003560: 6e20 6c6f 6361 6c20 7363 6865 6475 6c65  n local schedule
+00003570: 7220 7469 6d65 2e0a 2020 2020 6c61 7374  r time..    last
+00003580: 5f73 6565 6e3a 2066 6c6f 6174 0a0a 2020  _seen: float..  
+00003590: 2020 7469 6d65 5f64 656c 6179 3a20 666c    time_delay: fl
+000035a0: 6f61 740a 2020 2020 6261 6e64 7769 6474  oat.    bandwidt
+000035b0: 683a 2066 6c6f 6174 0a0a 2020 2020 233a  h: float..    #:
+000035c0: 2041 2073 6574 206f 6620 616c 6c20 5461   A set of all Ta
+000035d0: 736b 5374 6174 6573 206f 6e20 7468 6973  skStates on this
+000035e0: 2077 6f72 6b65 7220 7468 6174 2061 7265   worker that are
+000035f0: 2061 6374 6f72 732e 2054 6869 7320 6f6e   actors. This on
+00003600: 6c79 2069 6e63 6c75 6465 7320 7468 6f73  ly includes thos
+00003610: 650a 2020 2020 233a 2061 6374 6f72 7320  e.    #: actors 
+00003620: 7768 6f73 6520 7374 6174 6520 6163 7475  whose state actu
+00003630: 616c 6c79 206c 6976 6573 206f 6e20 7468  ally lives on th
+00003640: 6973 2077 6f72 6b65 722c 206e 6f74 2061  is worker, not a
+00003650: 6374 6f72 7320 746f 2077 6869 6368 2074  ctors to which t
+00003660: 6869 7320 776f 726b 6572 0a20 2020 2023  his worker.    #
+00003670: 3a20 6861 7320 6120 7265 6665 7265 6e63  : has a referenc
+00003680: 652e 0a20 2020 2061 6374 6f72 733a 2073  e..    actors: s
+00003690: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+000036a0: 2020 2023 3a20 556e 6465 726c 7969 6e67     #: Underlying
+000036b0: 2064 6174 6120 6f66 203a 6d65 7468 3a60   data of :meth:`
+000036c0: 576f 726b 6572 5374 6174 652e 6861 735f  WorkerState.has_
+000036d0: 7768 6174 600a 2020 2020 5f68 6173 5f77  what`.    _has_w
+000036e0: 6861 743a 2064 6963 745b 5461 736b 5374  hat: dict[TaskSt
+000036f0: 6174 652c 204e 6f6e 655d 0a0a 2020 2020  ate, None]..    
+00003700: 233a 2041 2073 6574 206f 6620 7461 736b  #: A set of task
+00003710: 7320 7468 6174 2068 6176 6520 6265 656e  s that have been
+00003720: 2073 7562 6d69 7474 6564 2074 6f20 7468   submitted to th
+00003730: 6973 2077 6f72 6b65 722e 204d 756c 7469  is worker. Multi
+00003740: 706c 6520 7461 736b 7320 6d61 7920 6265  ple tasks may be
+00003750: 0a20 2020 2023 2073 7562 6d69 7474 6564  .    # submitted
+00003760: 2074 6f20 6120 776f 726b 6572 2069 6e20   to a worker in 
+00003770: 6164 7661 6e63 6520 616e 6420 7468 6520  advance and the 
+00003780: 776f 726b 6572 2077 696c 6c20 7275 6e20  worker will run 
+00003790: 7468 656d 2065 7665 6e74 7561 6c6c 792c  them eventually,
+000037a0: 0a20 2020 2023 2064 6570 656e 6469 6e67  .    # depending
+000037b0: 206f 6e20 6974 7320 6578 6563 7574 696f   on its executio
+000037c0: 6e20 7265 736f 7572 6365 7320 2862 7574  n resources (but
+000037d0: 2073 6565 203a 646f 633a 6077 6f72 6b2d   see :doc:`work-
+000037e0: 7374 6561 6c69 6e67 6029 2e0a 2020 2020  stealing`)..    
+000037f0: 233a 0a20 2020 2023 3a20 416c 6c20 7468  #:.    #: All th
+00003800: 6520 7461 736b 7320 6865 7265 2061 7265  e tasks here are
+00003810: 2069 6e20 7468 6520 2270 726f 6365 7373   in the "process
+00003820: 696e 6722 2073 7461 7465 2e0a 2020 2020  ing" state..    
+00003830: 233a 2054 6869 7320 6174 7472 6962 7574  #: This attribut
+00003840: 6520 6973 206b 6570 7420 696e 2073 796e  e is kept in syn
+00003850: 6320 7769 7468 203a 6174 7472 3a60 5461  c with :attr:`Ta
+00003860: 736b 5374 6174 652e 7072 6f63 6573 7369  skState.processi
+00003870: 6e67 5f6f 6e60 2e0a 2020 2020 7072 6f63  ng_on`..    proc
+00003880: 6573 7369 6e67 3a20 7365 745b 5461 736b  essing: set[Task
+00003890: 5374 6174 655d 0a0a 2020 2020 233a 2052  State]..    #: R
+000038a0: 756e 6e69 6e67 2074 6173 6b73 2074 6861  unning tasks tha
+000038b0: 7420 696e 766f 6b65 6420 3a66 756e 633a  t invoked :func:
+000038c0: 6064 6973 7472 6962 7574 6564 2e73 6563  `distributed.sec
+000038d0: 6564 6560 0a20 2020 206c 6f6e 675f 7275  ede`.    long_ru
+000038e0: 6e6e 696e 673a 2073 6574 5b54 6173 6b53  nning: set[TaskS
+000038f0: 7461 7465 5d0a 0a20 2020 2023 3a20 4120  tate]..    #: A 
+00003900: 6469 6374 696f 6e61 7279 206f 6620 7461  dictionary of ta
+00003910: 736b 7320 7468 6174 2061 7265 2063 7572  sks that are cur
+00003920: 7265 6e74 6c79 2062 6569 6e67 2072 756e  rently being run
+00003930: 206f 6e20 7468 6973 2077 6f72 6b65 722e   on this worker.
+00003940: 0a20 2020 2023 3a20 4561 6368 2074 6173  .    #: Each tas
+00003950: 6b20 7374 6174 6520 6973 2061 7373 6f63  k state is assoc
+00003960: 6961 7465 6420 7769 7468 2074 6865 2064  iated with the d
+00003970: 7572 6174 696f 6e20 696e 2073 6563 6f6e  uration in secon
+00003980: 6473 2077 6869 6368 2074 6865 2074 6173  ds which the tas
+00003990: 6b20 6861 730a 2020 2020 233a 2062 6565  k has.    #: bee
+000039a0: 6e20 7275 6e6e 696e 672e 0a20 2020 2065  n running..    e
+000039b0: 7865 6375 7469 6e67 3a20 6469 6374 5b54  xecuting: dict[T
+000039c0: 6173 6b53 7461 7465 2c20 666c 6f61 745d  askState, float]
+000039d0: 0a0a 2020 2020 233a 2054 6865 2061 7661  ..    #: The ava
+000039e0: 696c 6162 6c65 2072 6573 6f75 7263 6573  ilable resources
+000039f0: 206f 6e20 7468 6973 2077 6f72 6b65 722c   on this worker,
+00003a00: 2065 2e67 2e20 6060 7b22 4750 5522 3a20   e.g. ``{"GPU": 
+00003a10: 327d 6060 2e0a 2020 2020 233a 2054 6865  2}``..    #: The
+00003a20: 7365 2061 7265 2061 6273 7472 6163 7420  se are abstract 
+00003a30: 7175 616e 7469 7469 6573 2074 6861 7420  quantities that 
+00003a40: 636f 6e73 7472 6169 6e20 6365 7274 6169  constrain certai
+00003a50: 6e20 7461 736b 7320 6672 6f6d 2072 756e  n tasks from run
+00003a60: 6e69 6e67 2061 7420 7468 650a 2020 2020  ning at the.    
+00003a70: 233a 2073 616d 6520 7469 6d65 206f 6e20  #: same time on 
+00003a80: 7468 6973 2077 6f72 6b65 722e 0a20 2020  this worker..   
+00003a90: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
+00003aa0: 5b73 7472 2c20 666c 6f61 745d 0a0a 2020  [str, float]..  
+00003ab0: 2020 233a 2054 6865 2073 756d 206f 6620    #: The sum of 
+00003ac0: 6561 6368 2072 6573 6f75 7263 6520 7573  each resource us
+00003ad0: 6564 2062 7920 616c 6c20 7461 736b 7320  ed by all tasks 
+00003ae0: 616c 6c6f 6361 7465 6420 746f 2074 6869  allocated to thi
+00003af0: 7320 776f 726b 6572 2e0a 2020 2020 233a  s worker..    #:
+00003b00: 2054 6865 206e 756d 6265 7273 2069 6e20   The numbers in 
+00003b10: 7468 6973 2064 6963 7469 6f6e 6172 7920  this dictionary 
+00003b20: 6361 6e20 6f6e 6c79 2062 6520 6c65 7373  can only be less
+00003b30: 206f 7220 6571 7561 6c20 7468 616e 2074   or equal than t
+00003b40: 686f 7365 2069 6e20 7468 6973 0a20 2020  hose in this.   
+00003b50: 2023 3a20 776f 726b 6572 2773 203a 6174   #: worker's :at
+00003b60: 7472 3a60 7e57 6f72 6b65 7253 7461 7465  tr:`~WorkerState
+00003b70: 2e72 6573 6f75 7263 6573 602e 0a20 2020  .resources`..   
+00003b80: 2075 7365 645f 7265 736f 7572 6365 733a   used_resources:
+00003b90: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
+00003ba0: 5d0a 0a20 2020 2023 3a20 4172 6269 7472  ]..    #: Arbitr
+00003bb0: 6172 7920 6164 6469 7469 6f6e 616c 206d  ary additional m
+00003bc0: 6574 6164 6174 6120 746f 2062 6520 6164  etadata to be ad
+00003bd0: 6465 6420 746f 203a 6d65 7468 3a60 7e57  ded to :meth:`~W
+00003be0: 6f72 6b65 7253 7461 7465 2e69 6465 6e74  orkerState.ident
+00003bf0: 6974 7960 0a20 2020 2065 7874 7261 3a20  ity`.    extra: 
+00003c00: 6469 6374 5b73 7472 2c20 416e 795d 0a0a  dict[str, Any]..
+00003c10: 2020 2020 2320 5468 6520 756e 6971 7565      # The unique
+00003c20: 2073 6572 7665 7220 4944 2074 6869 7320   server ID this 
+00003c30: 576f 726b 6572 5374 6174 6520 6973 2072  WorkerState is r
+00003c40: 6566 6572 656e 6369 6e67 0a20 2020 2073  eferencing.    s
+00003c50: 6572 7665 725f 6964 3a20 7374 720a 0a20  erver_id: str.. 
+00003c60: 2020 2023 2052 6566 6572 656e 6365 2074     # Reference t
+00003c70: 6f20 7363 6865 6475 6c65 7220 7461 736b  o scheduler task
+00003c80: 5f67 726f 7570 730a 2020 2020 7363 6865  _groups.    sche
+00003c90: 6475 6c65 725f 7265 663a 2077 6561 6b72  duler_ref: weakr
+00003ca0: 6566 2e72 6566 5b53 6368 6564 756c 6572  ef.ref[Scheduler
+00003cb0: 5374 6174 655d 207c 204e 6f6e 650a 2020  State] | None.  
+00003cc0: 2020 7461 736b 5f70 7265 6669 785f 636f    task_prefix_co
+00003cd0: 756e 743a 2064 6566 6175 6c74 6469 6374  unt: defaultdict
+00003ce0: 5b73 7472 2c20 696e 745d 0a20 2020 205f  [str, int].    _
+00003cf0: 6e65 7477 6f72 6b5f 6f63 633a 2066 6c6f  network_occ: flo
+00003d00: 6174 0a20 2020 205f 6f63 6375 7061 6e63  at.    _occupanc
+00003d10: 795f 6361 6368 653a 2066 6c6f 6174 207c  y_cache: float |
+00003d20: 204e 6f6e 650a 0a20 2020 2023 3a20 4b65   None..    #: Ke
+00003d30: 7973 2074 6861 7420 6d61 7920 6e65 6564  ys that may need
+00003d40: 2074 6f20 6265 2066 6574 6368 6564 2074   to be fetched t
+00003d50: 6f20 7468 6973 2077 6f72 6b65 722c 2061  o this worker, a
+00003d60: 6e64 2074 6865 206e 756d 6265 7220 6f66  nd the number of
+00003d70: 2074 6173 6b73 2074 6861 7420 6e65 6564   tasks that need
+00003d80: 2074 6865 6d2e 0a20 2020 2023 3a20 416c   them..    #: Al
+00003d90: 6c20 7461 736b 7320 6172 6520 6375 7272  l tasks are curr
+00003da0: 656e 746c 7920 696e 2060 6d65 6d6f 7279  ently in `memory
+00003db0: 6020 6f6e 2061 2077 6f72 6b65 7220 6f74  ` on a worker ot
+00003dc0: 6865 7220 7468 616e 2074 6869 7320 6f6e  her than this on
+00003dd0: 652e 0a20 2020 2023 3a20 4d75 6368 206c  e..    #: Much l
+00003de0: 696b 6520 6070 726f 6365 7373 696e 6760  ike `processing`
+00003df0: 2c20 7468 6973 2064 6f65 7320 6e6f 7420  , this does not 
+00003e00: 6578 6163 746c 7920 7265 666c 6563 7420  exactly reflect 
+00003e10: 776f 726b 6572 2073 7461 7465 3a0a 2020  worker state:.  
+00003e20: 2020 233a 206b 6579 7320 6865 7265 206d    #: keys here m
+00003e30: 6179 2062 6520 7175 6575 6564 2074 6f20  ay be queued to 
+00003e40: 6665 7463 682c 2069 6e20 666c 6967 6874  fetch, in flight
+00003e50: 2c20 6f72 2061 6c72 6561 6479 2069 6e20  , or already in 
+00003e60: 6d65 6d6f 7279 0a20 2020 2023 3a20 6f6e  memory.    #: on
+00003e70: 2074 6865 2077 6f72 6b65 722e 0a20 2020   the worker..   
+00003e80: 206e 6565 6473 5f77 6861 743a 2064 6963   needs_what: dic
+00003e90: 745b 5461 736b 5374 6174 652c 2069 6e74  t[TaskState, int
+00003ea0: 5d0a 0a20 2020 205f 5f73 6c6f 7473 5f5f  ]..    __slots__
+00003eb0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+00003ec0: 6174 696f 6e73 5f5f 290a 0a20 2020 2064  ations__)..    d
+00003ed0: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00003ee0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00003ef0: 2020 202a 2c0a 2020 2020 2020 2020 6164     *,.        ad
+00003f00: 6472 6573 733a 2073 7472 2c0a 2020 2020  dress: str,.    
+00003f10: 2020 2020 7374 6174 7573 3a20 5374 6174      status: Stat
+00003f20: 7573 2c0a 2020 2020 2020 2020 7069 643a  us,.        pid:
+00003f30: 2069 6e74 2c0a 2020 2020 2020 2020 6e61   int,.        na
+00003f40: 6d65 3a20 6f62 6a65 6374 2c0a 2020 2020  me: object,.    
+00003f50: 2020 2020 6e74 6872 6561 6473 3a20 696e      nthreads: in
+00003f60: 7420 3d20 302c 0a20 2020 2020 2020 206d  t = 0,.        m
+00003f70: 656d 6f72 795f 6c69 6d69 743a 2069 6e74  emory_limit: int
+00003f80: 2c0a 2020 2020 2020 2020 6c6f 6361 6c5f  ,.        local_
+00003f90: 6469 7265 6374 6f72 793a 2073 7472 2c0a  directory: str,.
+00003fa0: 2020 2020 2020 2020 6e61 6e6e 793a 2073          nanny: s
+00003fb0: 7472 2c0a 2020 2020 2020 2020 7365 7276  tr,.        serv
+00003fc0: 6572 5f69 643a 2073 7472 2c0a 2020 2020  er_id: str,.    
+00003fd0: 2020 2020 7365 7276 6963 6573 3a20 6469      services: di
+00003fe0: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
+00003ff0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00004000: 2020 2020 7665 7273 696f 6e73 3a20 6469      versions: di
+00004010: 6374 5b73 7472 2c20 416e 795d 207c 204e  ct[str, Any] | N
+00004020: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00004030: 2020 2020 6578 7472 613a 2064 6963 745b      extra: dict[
+00004040: 7374 722c 2041 6e79 5d20 7c20 4e6f 6e65  str, Any] | None
+00004050: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00004060: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
+00004070: 6475 6c65 7253 7461 7465 207c 204e 6f6e  dulerState | Non
+00004080: 6520 3d20 4e6f 6e65 2c0a 2020 2020 293a  e = None,.    ):
+00004090: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+000040a0: 7276 6572 5f69 6420 3d20 7365 7276 6572  rver_id = server
+000040b0: 5f69 640a 2020 2020 2020 2020 7365 6c66  _id.        self
+000040c0: 2e61 6464 7265 7373 203d 2061 6464 7265  .address = addre
+000040d0: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
+000040e0: 7069 6420 3d20 7069 640a 2020 2020 2020  pid = pid.      
+000040f0: 2020 7365 6c66 2e6e 616d 6520 3d20 6e61    self.name = na
+00004100: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00004110: 6e74 6872 6561 6473 203d 206e 7468 7265  nthreads = nthre
+00004120: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
+00004130: 2e6d 656d 6f72 795f 6c69 6d69 7420 3d20  .memory_limit = 
+00004140: 6d65 6d6f 7279 5f6c 696d 6974 0a20 2020  memory_limit.   
+00004150: 2020 2020 2073 656c 662e 6c6f 6361 6c5f       self.local_
+00004160: 6469 7265 6374 6f72 7920 3d20 6c6f 6361  directory = loca
+00004170: 6c5f 6469 7265 6374 6f72 790a 2020 2020  l_directory.    
+00004180: 2020 2020 7365 6c66 2e73 6572 7669 6365      self.service
+00004190: 7320 3d20 7365 7276 6963 6573 206f 7220  s = services or 
+000041a0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+000041b0: 7665 7273 696f 6e73 203d 2076 6572 7369  versions = versi
+000041c0: 6f6e 7320 6f72 207b 7d0a 2020 2020 2020  ons or {}.      
+000041d0: 2020 7365 6c66 2e6e 616e 6e79 203d 206e    self.nanny = n
+000041e0: 616e 6e79 0a20 2020 2020 2020 2073 656c  anny.        sel
+000041f0: 662e 7374 6174 7573 203d 2073 7461 7475  f.status = statu
+00004200: 730a 2020 2020 2020 2020 7365 6c66 2e5f  s.        self._
+00004210: 6861 7368 203d 2068 6173 6828 7365 6c66  hash = hash(self
+00004220: 2e73 6572 7665 725f 6964 290a 2020 2020  .server_id).    
+00004230: 2020 2020 7365 6c66 2e6e 6279 7465 7320      self.nbytes 
+00004240: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+00004250: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
+00004260: 6564 5f6f 6c64 203d 2030 0a20 2020 2020  ed_old = 0.     
+00004270: 2020 2073 656c 662e 5f6d 656d 6f72 795f     self._memory_
+00004280: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+00004290: 7920 3d20 6465 7175 6528 290a 2020 2020  y = deque().    
+000042a0: 2020 2020 7365 6c66 2e6d 6574 7269 6373      self.metrics
+000042b0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+000042c0: 6c66 2e6c 6173 745f 7365 656e 203d 2030  lf.last_seen = 0
+000042d0: 0a20 2020 2020 2020 2073 656c 662e 7469  .        self.ti
+000042e0: 6d65 5f64 656c 6179 203d 2030 0a20 2020  me_delay = 0.   
+000042f0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
+00004300: 6474 6820 3d20 7061 7273 655f 6279 7465  dth = parse_byte
+00004310: 7328 6461 736b 2e63 6f6e 6669 672e 6765  s(dask.config.ge
+00004320: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+00004330: 6368 6564 756c 6572 2e62 616e 6477 6964  cheduler.bandwid
+00004340: 7468 2229 290a 2020 2020 2020 2020 7365  th")).        se
+00004350: 6c66 2e61 6374 6f72 7320 3d20 7365 7428  lf.actors = set(
+00004360: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00004370: 6861 735f 7768 6174 203d 207b 7d0a 2020  has_what = {}.  
+00004380: 2020 2020 2020 7365 6c66 2e70 726f 6365        self.proce
+00004390: 7373 696e 6720 3d20 7365 7428 290a 2020  ssing = set().  
+000043a0: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
+000043b0: 7275 6e6e 696e 6720 3d20 7365 7428 290a  running = set().
+000043c0: 2020 2020 2020 2020 7365 6c66 2e65 7865          self.exe
+000043d0: 6375 7469 6e67 203d 207b 7d0a 2020 2020  cuting = {}.    
+000043e0: 2020 2020 7365 6c66 2e72 6573 6f75 7263      self.resourc
+000043f0: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
+00004400: 7365 6c66 2e75 7365 645f 7265 736f 7572  self.used_resour
+00004410: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
+00004420: 2073 656c 662e 6578 7472 6120 3d20 6578   self.extra = ex
+00004430: 7472 6120 6f72 207b 7d0a 2020 2020 2020  tra or {}.      
+00004440: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+00004450: 5f72 6566 203d 2077 6561 6b72 6566 2e72  _ref = weakref.r
+00004460: 6566 2873 6368 6564 756c 6572 2920 6966  ef(scheduler) if
+00004470: 2073 6368 6564 756c 6572 2065 6c73 6520   scheduler else 
+00004480: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
+00004490: 662e 7461 736b 5f70 7265 6669 785f 636f  f.task_prefix_co
+000044a0: 756e 7420 3d20 6465 6661 756c 7464 6963  unt = defaultdic
+000044b0: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
+000044c0: 656c 662e 6e65 6564 735f 7768 6174 203d  elf.needs_what =
+000044d0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+000044e0: 2e5f 6e65 7477 6f72 6b5f 6f63 6320 3d20  ._network_occ = 
+000044f0: 300a 2020 2020 2020 2020 7365 6c66 2e5f  0.        self._
+00004500: 6f63 6375 7061 6e63 795f 6361 6368 6520  occupancy_cache 
+00004510: 3d20 4e6f 6e65 0a0a 2020 2020 6465 6620  = None..    def 
+00004520: 5f5f 6861 7368 5f5f 2873 656c 6629 202d  __hash__(self) -
+00004530: 3e20 696e 743a 0a20 2020 2020 2020 2072  > int:.        r
+00004540: 6574 7572 6e20 7365 6c66 2e5f 6861 7368  eturn self._hash
+00004550: 0a0a 2020 2020 6465 6620 5f5f 6571 5f5f  ..    def __eq__
+00004560: 2873 656c 662c 206f 7468 6572 3a20 6f62  (self, other: ob
+00004570: 6a65 6374 2920 2d3e 2062 6f6f 6c3a 0a20  ject) -> bool:. 
+00004580: 2020 2020 2020 2072 6574 7572 6e20 6973         return is
+00004590: 696e 7374 616e 6365 286f 7468 6572 2c20  instance(other, 
+000045a0: 576f 726b 6572 5374 6174 6529 2061 6e64  WorkerState) and
+000045b0: 206f 7468 6572 2e73 6572 7665 725f 6964   other.server_id
+000045c0: 203d 3d20 7365 6c66 2e73 6572 7665 725f   == self.server_
+000045d0: 6964 0a0a 2020 2020 4070 726f 7065 7274  id..    @propert
+000045e0: 790a 2020 2020 6465 6620 6861 735f 7768  y.    def has_wh
+000045f0: 6174 2873 656c 6629 202d 3e20 5365 745b  at(self) -> Set[
+00004600: 5461 736b 5374 6174 655d 3a0a 2020 2020  TaskState]:.    
+00004610: 2020 2020 2222 2241 6e20 696e 7365 7274      """An insert
+00004620: 696f 6e2d 736f 7274 6564 2073 6574 2d6c  ion-sorted set-l
+00004630: 696b 6520 6f66 2074 6173 6b73 2077 6869  ike of tasks whi
+00004640: 6368 2063 7572 7265 6e74 6c79 2072 6573  ch currently res
+00004650: 6964 6520 6f6e 2074 6869 7320 776f 726b  ide on this work
+00004660: 6572 2e0a 2020 2020 2020 2020 416c 6c20  er..        All 
+00004670: 7468 6520 7461 736b 7320 6865 7265 2061  the tasks here a
+00004680: 7265 2069 6e20 7468 6520 226d 656d 6f72  re in the "memor
+00004690: 7922 2073 7461 7465 2e0a 2020 2020 2020  y" state..      
+000046a0: 2020 5468 6973 2069 7320 7468 6520 7265    This is the re
+000046b0: 7665 7273 6520 6d61 7070 696e 6720 6f66  verse mapping of
+000046c0: 203a 6174 7472 3a60 5461 736b 5374 6174   :attr:`TaskStat
+000046d0: 652e 7768 6f5f 6861 7360 2e0a 0a20 2020  e.who_has`...   
+000046e0: 2020 2020 2054 6869 7320 6973 2061 2072       This is a r
+000046f0: 6561 642d 6f6e 6c79 2070 7562 6c69 6320  ead-only public 
+00004700: 6163 6365 7373 6f72 2e20 5468 6520 6461  accessor. The da
+00004710: 7461 2069 7320 696d 706c 656d 656e 7465  ta is implemente
+00004720: 6420 6173 2061 2064 6963 7420 7769 7468  d as a dict with
+00004730: 6f75 740a 2020 2020 2020 2020 7661 6c75  out.        valu
+00004740: 6573 2c20 6265 6361 7573 6520 7265 6261  es, because reba
+00004750: 6c61 6e63 6528 2920 7265 6c69 6573 206f  lance() relies o
+00004760: 6e20 6469 6374 7320 6265 696e 6720 696e  n dicts being in
+00004770: 7365 7274 696f 6e2d 736f 7274 6564 2e0a  sertion-sorted..
+00004780: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00004790: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+000047a0: 5f68 6173 5f77 6861 742e 6b65 7973 2829  _has_what.keys()
+000047b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000047c0: 2020 2020 6465 6620 686f 7374 2873 656c      def host(sel
+000047d0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+000047e0: 2020 2072 6574 7572 6e20 6765 745f 6164     return get_ad
+000047f0: 6472 6573 735f 686f 7374 2873 656c 662e  dress_host(self.
+00004800: 6164 6472 6573 7329 0a0a 2020 2020 4070  address)..    @p
+00004810: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00004820: 6d65 6d6f 7279 2873 656c 6629 202d 3e20  memory(self) -> 
+00004830: 4d65 6d6f 7279 5374 6174 653a 0a20 2020  MemoryState:.   
+00004840: 2020 2020 2022 2222 506f 6c69 7368 6564       """Polished
+00004850: 206d 656d 6f72 7920 6d65 7472 6963 7320   memory metrics 
+00004860: 666f 7220 7468 6520 776f 726b 6572 2e0a  for the worker..
+00004870: 0a20 2020 2020 2020 202a 2a44 6573 6967  .        **Desig
+00004880: 6e20 6e6f 7465 206f 6e20 6d61 6e61 6765  n note on manage
+00004890: 6420 6d65 6d6f 7279 2a2a 0a0a 2020 2020  d memory**..    
+000048a0: 2020 2020 5468 6572 6520 6172 6520 7477      There are tw
+000048b0: 6f20 6d65 6173 7572 6573 2061 7661 696c  o measures avail
+000048c0: 6162 6c65 2066 6f72 206d 616e 6167 6564  able for managed
+000048d0: 206d 656d 6f72 793a 0a0a 2020 2020 2020   memory:..      
+000048e0: 2020 2d20 6060 7365 6c66 2e6e 6279 7465    - ``self.nbyte
+000048f0: 7360 600a 2020 2020 2020 2020 2d20 6060  s``.        - ``
+00004900: 7365 6c66 2e6d 6574 7269 6373 5b22 6d61  self.metrics["ma
+00004910: 6e61 6765 645f 6279 7465 7322 5d60 600a  naged_bytes"]``.
+00004920: 0a20 2020 2020 2020 2041 7420 7265 7374  .        At rest
+00004930: 2c20 7468 6520 7477 6f20 6e75 6d62 6572  , the two number
+00004940: 7320 6d75 7374 2062 6520 6964 656e 7469  s must be identi
+00004950: 6361 6c2e 2048 6f77 6576 6572 2c20 6060  cal. However, ``
+00004960: 7365 6c66 2e6e 6279 7465 7360 6020 6973  self.nbytes`` is
+00004970: 0a20 2020 2020 2020 2069 6d6d 6564 6961  .        immedia
+00004980: 7465 6c79 2075 7064 6174 6564 2074 6872  tely updated thr
+00004990: 6f75 6768 2074 6865 2062 6174 6368 6564  ough the batched
+000049a0: 2063 6f6d 6d73 2061 7320 736f 6f6e 2061   comms as soon a
+000049b0: 7320 6561 6368 2074 6173 6b20 6c61 6e64  s each task land
+000049c0: 7320 696e 0a20 2020 2020 2020 206d 656d  s in.        mem
+000049d0: 6f72 7920 6f6e 2074 6865 2077 6f72 6b65  ory on the worke
+000049e0: 723b 2060 6073 656c 662e 6d65 7472 6963  r; ``self.metric
+000049f0: 735b 226d 616e 6167 6564 5f62 7974 6573  s["managed_bytes
+00004a00: 225d 6060 2069 6e73 7465 6164 2069 7320  "]`` instead is 
+00004a10: 7570 6461 7465 6420 6279 0a20 2020 2020  updated by.     
+00004a20: 2020 2074 6865 2068 6561 7274 6265 6174     the heartbeat
+00004a30: 2c20 7768 6963 6820 6361 6e20 6c61 6720  , which can lag 
+00004a40: 7365 7665 7261 6c20 7365 636f 6e64 7320  several seconds 
+00004a50: 6265 6869 6e64 2e0a 0a20 2020 2020 2020  behind...       
+00004a60: 2042 656c 6f77 2077 6520 6172 6520 6d69   Below we are mi
+00004a70: 7869 6e67 206c 696b 656c 7920 6e65 7765  xing likely newe
+00004a80: 7220 6d61 6e61 6765 6420 6d65 6d6f 7279  r managed memory
+00004a90: 2069 6e66 6f20 6672 6f6d 2060 6073 656c   info from ``sel
+00004aa0: 662e 6e62 7974 6573 6060 2077 6974 680a  f.nbytes`` with.
+00004ab0: 2020 2020 2020 2020 7072 6f63 6573 7320          process 
+00004ac0: 616e 6420 7370 696c 6c65 6420 6d65 6d6f  and spilled memo
+00004ad0: 7279 2066 726f 6d20 7468 6520 6865 6172  ry from the hear
+00004ae0: 7462 6561 742e 2054 6869 7320 6973 2064  tbeat. This is d
+00004af0: 656c 6962 6572 6174 652c 2073 6f20 7468  eliberate, so th
+00004b00: 6174 0a20 2020 2020 2020 206d 616e 6167  at.        manag
+00004b10: 6564 206d 656d 6f72 7920 746f 7461 6c20  ed memory total 
+00004b20: 6973 2075 7064 6174 6564 206d 6f72 6520  is updated more 
+00004b30: 6672 6571 7565 6e74 6c79 2e0a 0a20 2020  frequently...   
+00004b40: 2020 2020 204d 616e 6167 6564 206d 656d       Managed mem
+00004b50: 6f72 7920 6469 7265 6374 6c79 2061 6e64  ory directly and
+00004b60: 2069 6d6d 6564 6961 7465 6c79 2063 6f6e   immediately con
+00004b70: 7472 6962 7574 6573 2074 6f20 6f70 7469  tributes to opti
+00004b80: 6d69 7374 6963 206d 656d 6f72 792c 2077  mistic memory, w
+00004b90: 6869 6368 0a20 2020 2020 2020 2069 7320  hich.        is 
+00004ba0: 696e 2074 7572 6e20 7573 6564 2069 6e20  in turn used in 
+00004bb0: 4163 7469 7665 204d 656d 6f72 7920 4d61  Active Memory Ma
+00004bc0: 6e61 6765 7220 6865 7572 6973 7469 6373  nager heuristics
+00004bd0: 2028 6174 2074 6865 206d 6f6d 656e 7420   (at the moment 
+00004be0: 6f66 2077 7269 7469 6e67 3b0a 2020 2020  of writing;.    
+00004bf0: 2020 2020 6d6f 7265 2075 7365 7320 7769      more uses wi
+00004c00: 6c6c 206c 696b 656c 7920 6265 2061 6464  ll likely be add
+00004c10: 6564 2069 6e20 7468 6520 6675 7475 7265  ed in the future
+00004c20: 292e 2053 6f20 6974 2773 2069 6d70 6f72  ). So it's impor
+00004c30: 7461 6e74 2074 6f20 6861 7665 2069 740a  tant to have it.
+00004c40: 2020 2020 2020 2020 7570 2074 6f20 6461          up to da
+00004c50: 7465 3b20 6d75 6368 206d 6f72 6520 7468  te; much more th
+00004c60: 616e 2069 7420 6973 2066 6f72 2070 726f  an it is for pro
+00004c70: 6365 7373 206d 656d 6f72 792e 0a0a 2020  cess memory...  
+00004c80: 2020 2020 2020 4861 7669 6e67 2075 702d        Having up-
+00004c90: 746f 2d64 6174 6520 6d61 6e61 6765 6420  to-date managed 
+00004ca0: 6d65 6d6f 7279 2069 6e66 6f20 6173 2073  memory info as s
+00004cb0: 6f6f 6e20 6173 2074 6865 2073 6368 6564  oon as the sched
+00004cc0: 756c 6572 206c 6561 726e 7320 6162 6f75  uler learns abou
+00004cd0: 740a 2020 2020 2020 2020 7461 736b 2063  t.        task c
+00004ce0: 6f6d 706c 6574 696f 6e20 616c 736f 2073  ompletion also s
+00004cf0: 7562 7374 616e 7469 616c 6c79 2073 696d  ubstantially sim
+00004d00: 706c 6966 6965 7320 756e 6974 2074 6573  plifies unit tes
+00004d10: 7473 2e0a 0a20 2020 2020 2020 2054 6865  ts...        The
+00004d20: 2066 6c69 7020 7369 6465 206f 6620 7468   flip side of th
+00004d30: 6973 2064 6573 6967 6e20 6973 2074 6861  is design is tha
+00004d40: 7420 6974 206d 6179 2063 6175 7365 2073  t it may cause s
+00004d50: 6f6d 6520 6e6f 6973 6520 696e 2074 6865  ome noise in the
+00004d60: 0a20 2020 2020 2020 2075 6e6d 616e 6167  .        unmanag
+00004d70: 6564 5f72 6563 656e 7420 6d65 6173 7572  ed_recent measur
+00004d80: 652e 2065 2e67 2e3a 0a0a 2020 2020 2020  e. e.g.:..      
+00004d90: 2020 312e 2044 656c 6574 6520 3130 304d    1. Delete 100M
+00004da0: 4220 6f66 206d 616e 6167 6564 2064 6174  B of managed dat
+00004db0: 610a 2020 2020 2020 2020 322e 2054 6865  a.        2. The
+00004dc0: 2075 7064 6174 6564 206d 616e 6167 6564   updated managed
+00004dd0: 206d 656d 6f72 7920 7265 6163 6865 7320   memory reaches 
+00004de0: 7468 6520 7363 6865 6475 6c65 7220 6661  the scheduler fa
+00004df0: 7374 6572 2074 6861 6e20 7468 650a 2020  ster than the.  
+00004e00: 2020 2020 2020 2020 2075 7064 6174 6564           updated
+00004e10: 2070 726f 6365 7373 206d 656d 6f72 790a   process memory.
+00004e20: 2020 2020 2020 2020 332e 2054 6865 7265          3. There
+00004e30: 2773 2061 2062 6c69 7020 7768 6572 6520  's a blip where 
+00004e40: 7468 6520 7363 6865 6475 6c65 7220 7468  the scheduler th
+00004e50: 696e 6b73 2074 6861 7420 7468 6572 6527  inks that there'
+00004e60: 7320 6120 7375 6464 656e 2031 3030 4d42  s a sudden 100MB
+00004e70: 0a20 2020 2020 2020 2020 2020 696e 6372  .           incr
+00004e80: 6561 7365 2069 6e20 756e 6d61 6e61 6765  ease in unmanage
+00004e90: 645f 7265 6365 6e74 2c20 7369 6e63 6520  d_recent, since 
+00004ea0: 7072 6f63 6573 7320 6d65 6d6f 7279 2068  process memory h
+00004eb0: 6173 6e27 7420 6368 616e 6765 6420 6275  asn't changed bu
+00004ec0: 7420 6d61 6e61 6765 640a 2020 2020 2020  t managed.      
+00004ed0: 2020 2020 206d 656d 6f72 7920 6861 7320       memory has 
+00004ee0: 6465 6372 6561 7365 6420 6279 2031 3030  decreased by 100
+00004ef0: 4d42 0a20 2020 2020 2020 2034 2e20 5768  MB.        4. Wh
+00004f00: 656e 2074 6865 2068 6561 7274 6265 6174  en the heartbeat
+00004f10: 2061 7272 6976 6573 2c20 7072 6f63 6573   arrives, proces
+00004f20: 7320 6d65 6d6f 7279 2067 6f65 7320 646f  s memory goes do
+00004f30: 776e 2061 6e64 2073 6f20 646f 6573 2074  wn and so does t
+00004f40: 6865 0a20 2020 2020 2020 2020 2020 756e  he.           un
+00004f50: 6d61 6e61 6765 645f 7265 6365 6e74 2e0a  managed_recent..
+00004f60: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
+00004f70: 204f 4b20 2d20 6f6e 6520 6f66 2074 6865   OK - one of the
+00004f80: 206d 6169 6e20 7265 6173 6f6e 7320 666f   main reasons fo
+00004f90: 7220 7468 6520 756e 6d61 6e61 6765 645f  r the unmanaged_
+00004fa0: 7265 6365 6e74 202f 2075 6e6d 616e 6167  recent / unmanag
+00004fb0: 6564 5f6f 6c64 0a20 2020 2020 2020 2073  ed_old.        s
+00004fc0: 706c 6974 2069 7320 6578 6163 746c 7920  plit is exactly 
+00004fd0: 746f 2063 6f6e 6365 6e74 7261 7465 2061  to concentrate a
+00004fe0: 6c6c 2074 6865 206e 6f69 7365 2069 6e20  ll the noise in 
+00004ff0: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
+00005000: 2061 6e64 2065 7863 6c75 6465 2069 740a   and exclude it.
+00005010: 2020 2020 2020 2020 6672 6f6d 206f 7074          from opt
+00005020: 696d 6973 7469 6320 6d65 6d6f 7279 2c20  imistic memory, 
+00005030: 7768 6963 6820 6973 2075 7365 6420 666f  which is used fo
+00005040: 7220 6865 7572 6973 7469 6373 2e0a 0a20  r heuristics... 
+00005050: 2020 2020 2020 2053 6f6d 6574 6869 6e67         Something
+00005060: 2074 6861 7420 6973 206c 6573 7320 4f4b   that is less OK
+00005070: 2c20 6275 7420 616c 736f 206c 6573 7320  , but also less 
+00005080: 6672 6571 7565 6e74 2c20 6973 2074 6861  frequent, is tha
+00005090: 7420 7468 6520 7375 6464 656e 2064 656c  t the sudden del
+000050a0: 6574 696f 6e0a 2020 2020 2020 2020 6f66  etion.        of
+000050b0: 2073 7069 6c6c 6564 206b 6579 7320 7769   spilled keys wi
+000050c0: 6c6c 2063 6175 7365 2061 206e 6567 6174  ll cause a negat
+000050d0: 6976 6520 626c 6970 2069 6e20 6d61 6e61  ive blip in mana
+000050e0: 6765 6420 6d65 6d6f 7279 3a0a 0a20 2020  ged memory:..   
+000050f0: 2020 2020 2031 2e20 4465 6c65 7465 2031       1. Delete 1
+00005100: 3030 4d42 206f 6620 7370 696c 6c65 6420  00MB of spilled 
+00005110: 6461 7461 0a20 2020 2020 2020 2032 2e20  data.        2. 
+00005120: 5468 6520 7570 6461 7465 6420 6d61 6e61  The updated mana
+00005130: 6765 6420 6d65 6d6f 7279 202a 746f 7461  ged memory *tota
+00005140: 6c2a 2072 6561 6368 6573 2074 6865 2073  l* reaches the s
+00005150: 6368 6564 756c 6572 2066 6173 7465 7220  cheduler faster 
+00005160: 7468 616e 2074 6865 0a20 2020 2020 2020  than the.       
+00005170: 2020 2020 7570 6461 7465 6420 7370 696c      updated spil
+00005180: 6c65 6420 706f 7274 696f 6e0a 2020 2020  led portion.    
+00005190: 2020 2020 332e 2054 6869 7320 6361 7573      3. This caus
+000051a0: 6573 2074 6865 206d 616e 6167 6564 206d  es the managed m
+000051b0: 656d 6f72 7920 746f 2074 656d 706f 7261  emory to tempora
+000051c0: 7269 6c79 2070 6c75 6d6d 6574 2061 6e64  rily plummet and
+000051d0: 2062 6520 7265 706c 6163 6564 2062 790a   be replaced by.
+000051e0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
+000051f0: 6167 6564 5f72 6563 656e 742c 2077 6869  aged_recent, whi
+00005200: 6c65 2073 7069 6c6c 6564 206d 656d 6f72  le spilled memor
+00005210: 7920 7265 6d61 696e 7320 756e 616c 7465  y remains unalte
+00005220: 7265 640a 2020 2020 2020 2020 342e 2057  red.        4. W
+00005230: 6865 6e20 7468 6520 6865 6172 7462 6561  hen the heartbea
+00005240: 7420 6172 7269 7665 732c 206d 616e 6167  t arrives, manag
+00005250: 6564 2067 6f65 7320 6261 636b 2075 702c  ed goes back up,
+00005260: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+00005270: 740a 2020 2020 2020 2020 2020 2067 6f65  t.           goe
+00005280: 7320 6261 636b 2064 6f77 6e2c 2061 6e64  s back down, and
+00005290: 2073 7069 6c6c 6564 2067 6f65 7320 646f   spilled goes do
+000052a0: 776e 2062 7920 3130 304d 4220 6173 2069  wn by 100MB as i
+000052b0: 7420 7368 6f75 6c64 2068 6176 6520 746f  t should have to
+000052c0: 0a20 2020 2020 2020 2020 2020 6265 6769  .           begi
+000052d0: 6e20 7769 7468 2e0a 0a20 2020 2020 2020  n with...       
+000052e0: 203a 6973 7375 653a 6036 3030 3260 2077   :issue:`6002` w
+000052f0: 696c 6c20 6c65 7420 7573 2073 6f6c 7665  ill let us solve
+00005300: 2074 6869 732e 0a20 2020 2020 2020 2022   this..        "
+00005310: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00005320: 6e20 4d65 6d6f 7279 5374 6174 6528 0a20  n MemoryState(. 
+00005330: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+00005340: 7373 3d73 656c 662e 6d65 7472 6963 735b  ss=self.metrics[
+00005350: 226d 656d 6f72 7922 5d2c 0a20 2020 2020  "memory"],.     
+00005360: 2020 2020 2020 206d 616e 6167 6564 3d6d         managed=m
+00005370: 6178 2830 2c20 7365 6c66 2e6e 6279 7465  ax(0, self.nbyte
+00005380: 7320 2d20 7365 6c66 2e6d 6574 7269 6373  s - self.metrics
+00005390: 5b22 7370 696c 6c65 645f 6279 7465 7322  ["spilled_bytes"
+000053a0: 5d5b 226d 656d 6f72 7922 5d29 2c0a 2020  ]["memory"]),.  
+000053b0: 2020 2020 2020 2020 2020 7370 696c 6c65            spille
+000053c0: 643d 7365 6c66 2e6d 6574 7269 6373 5b22  d=self.metrics["
+000053d0: 7370 696c 6c65 645f 6279 7465 7322 5d5b  spilled_bytes"][
+000053e0: 2264 6973 6b22 5d2c 0a20 2020 2020 2020  "disk"],.       
+000053f0: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
+00005400: 6c64 3d73 656c 662e 5f6d 656d 6f72 795f  ld=self._memory_
+00005410: 756e 6d61 6e61 6765 645f 6f6c 642c 0a20  unmanaged_old,. 
+00005420: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00005430: 6620 636c 6561 6e28 7365 6c66 2920 2d3e  f clean(self) ->
+00005440: 2057 6f72 6b65 7253 7461 7465 3a0a 2020   WorkerState:.  
+00005450: 2020 2020 2020 2222 2252 6574 7572 6e20        """Return 
+00005460: 6120 7665 7273 696f 6e20 6f66 2074 6869  a version of thi
+00005470: 7320 6f62 6a65 6374 2074 6861 7420 6973  s object that is
+00005480: 2061 7070 726f 7072 6961 7465 2066 6f72   appropriate for
+00005490: 2073 6572 6961 6c69 7a61 7469 6f6e 2222   serialization""
+000054a0: 220a 2020 2020 2020 2020 7773 203d 2057  ".        ws = W
+000054b0: 6f72 6b65 7253 7461 7465 280a 2020 2020  orkerState(.    
+000054c0: 2020 2020 2020 2020 6164 6472 6573 733d          address=
+000054d0: 7365 6c66 2e61 6464 7265 7373 2c0a 2020  self.address,.  
+000054e0: 2020 2020 2020 2020 2020 7374 6174 7573            status
+000054f0: 3d73 656c 662e 7374 6174 7573 2c0a 2020  =self.status,.  
+00005500: 2020 2020 2020 2020 2020 7069 643d 7365            pid=se
+00005510: 6c66 2e70 6964 2c0a 2020 2020 2020 2020  lf.pid,.        
+00005520: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
+00005530: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00005540: 6e74 6872 6561 6473 3d73 656c 662e 6e74  nthreads=self.nt
+00005550: 6872 6561 6473 2c0a 2020 2020 2020 2020  hreads,.        
+00005560: 2020 2020 6d65 6d6f 7279 5f6c 696d 6974      memory_limit
+00005570: 3d73 656c 662e 6d65 6d6f 7279 5f6c 696d  =self.memory_lim
+00005580: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
+00005590: 6c6f 6361 6c5f 6469 7265 6374 6f72 793d  local_directory=
+000055a0: 7365 6c66 2e6c 6f63 616c 5f64 6972 6563  self.local_direc
+000055b0: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+000055c0: 2020 7365 7276 6963 6573 3d73 656c 662e    services=self.
+000055d0: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
+000055e0: 2020 2020 2020 6e61 6e6e 793d 7365 6c66        nanny=self
+000055f0: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
+00005600: 2020 2020 6578 7472 613d 7365 6c66 2e65      extra=self.e
+00005610: 7874 7261 2c0a 2020 2020 2020 2020 2020  xtra,.          
+00005620: 2020 7365 7276 6572 5f69 643d 7365 6c66    server_id=self
+00005630: 2e73 6572 7665 725f 6964 2c0a 2020 2020  .server_id,.    
+00005640: 2020 2020 290a 2020 2020 2020 2020 7773      ).        ws
+00005650: 2e5f 6f63 6375 7061 6e63 795f 6361 6368  ._occupancy_cach
+00005660: 6520 3d20 7365 6c66 2e6f 6363 7570 616e  e = self.occupan
+00005670: 6379 0a0a 2020 2020 2020 2020 7773 2e65  cy..        ws.e
+00005680: 7865 6375 7469 6e67 203d 207b 0a20 2020  xecuting = {.   
+00005690: 2020 2020 2020 2020 2074 732e 6b65 793a           ts.key:
+000056a0: 2064 7572 6174 696f 6e20 666f 7220 7473   duration for ts
+000056b0: 2c20 6475 7261 7469 6f6e 2069 6e20 7365  , duration in se
+000056c0: 6c66 2e65 7865 6375 7469 6e67 2e69 7465  lf.executing.ite
+000056d0: 6d73 2829 2020 2320 7479 7065 3a20 6967  ms()  # type: ig
+000056e0: 6e6f 7265 0a20 2020 2020 2020 207d 0a20  nore.        }. 
+000056f0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+00005700: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00005710: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+00005720: 0a20 2020 2020 2020 206e 616d 6520 3d20  .        name = 
+00005730: 6622 2c20 6e61 6d65 3a20 7b73 656c 662e  f", name: {self.
+00005740: 6e61 6d65 7d22 2069 6620 7365 6c66 2e6e  name}" if self.n
+00005750: 616d 6520 213d 2073 656c 662e 6164 6472  ame != self.addr
+00005760: 6573 7320 656c 7365 2022 220a 2020 2020  ess else "".    
+00005770: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00005780: 2020 2020 2020 2020 2066 223c 576f 726b           f"<Work
+00005790: 6572 5374 6174 6520 7b73 656c 662e 6164  erState {self.ad
+000057a0: 6472 6573 7321 727d 7b6e 616d 657d 2c20  dress!r}{name}, 
+000057b0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+000057c0: 7374 6174 7573 3a20 7b73 656c 662e 7374  status: {self.st
+000057d0: 6174 7573 2e6e 616d 657d 2c20 220a 2020  atus.name}, ".  
+000057e0: 2020 2020 2020 2020 2020 6622 6d65 6d6f            f"memo
+000057f0: 7279 3a20 7b6c 656e 2873 656c 662e 6861  ry: {len(self.ha
+00005800: 735f 7768 6174 297d 2c20 220a 2020 2020  s_what)}, ".    
+00005810: 2020 2020 2020 2020 6622 7072 6f63 6573          f"proces
+00005820: 7369 6e67 3a20 7b6c 656e 2873 656c 662e  sing: {len(self.
+00005830: 7072 6f63 6573 7369 6e67 297d 3e22 0a20  processing)}>". 
+00005840: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+00005850: 6620 5f72 6570 725f 6874 6d6c 5f28 7365  f _repr_html_(se
+00005860: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+00005870: 2020 2020 7265 7475 726e 2067 6574 5f74      return get_t
+00005880: 656d 706c 6174 6528 2277 6f72 6b65 725f  emplate("worker_
+00005890: 7374 6174 652e 6874 6d6c 2e6a 3222 292e  state.html.j2").
+000058a0: 7265 6e64 6572 280a 2020 2020 2020 2020  render(.        
+000058b0: 2020 2020 6164 6472 6573 733d 7365 6c66      address=self
+000058c0: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+000058d0: 2020 2020 2020 6e61 6d65 3d73 656c 662e        name=self.
+000058e0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+000058f0: 2020 7374 6174 7573 3d73 656c 662e 7374    status=self.st
+00005900: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
+00005910: 2020 2020 2020 2068 6173 5f77 6861 743d         has_what=
+00005920: 7365 6c66 2e68 6173 5f77 6861 742c 0a20  self.has_what,. 
+00005930: 2020 2020 2020 2020 2020 2070 726f 6365             proce
+00005940: 7373 696e 673d 7365 6c66 2e70 726f 6365  ssing=self.proce
+00005950: 7373 696e 672c 0a20 2020 2020 2020 2029  ssing,.        )
+00005960: 0a0a 2020 2020 6465 6620 6964 656e 7469  ..    def identi
+00005970: 7479 2873 656c 6629 202d 3e20 6469 6374  ty(self) -> dict
+00005980: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00005990: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
+000059a0: 2020 2020 2020 2020 2022 7479 7065 223a           "type":
+000059b0: 2022 576f 726b 6572 222c 0a20 2020 2020   "Worker",.     
+000059c0: 2020 2020 2020 2022 6964 223a 2073 656c         "id": sel
+000059d0: 662e 6e61 6d65 2c0a 2020 2020 2020 2020  f.name,.        
+000059e0: 2020 2020 2268 6f73 7422 3a20 7365 6c66      "host": self
+000059f0: 2e68 6f73 742c 0a20 2020 2020 2020 2020  .host,.         
+00005a00: 2020 2022 7265 736f 7572 6365 7322 3a20     "resources": 
+00005a10: 7365 6c66 2e72 6573 6f75 7263 6573 2c0a  self.resources,.
+00005a20: 2020 2020 2020 2020 2020 2020 226c 6f63              "loc
+00005a30: 616c 5f64 6972 6563 746f 7279 223a 2073  al_directory": s
+00005a40: 656c 662e 6c6f 6361 6c5f 6469 7265 6374  elf.local_direct
+00005a50: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
+00005a60: 2022 6e61 6d65 223a 2073 656c 662e 6e61   "name": self.na
+00005a70: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00005a80: 226e 7468 7265 6164 7322 3a20 7365 6c66  "nthreads": self
+00005a90: 2e6e 7468 7265 6164 732c 0a20 2020 2020  .nthreads,.     
+00005aa0: 2020 2020 2020 2022 6d65 6d6f 7279 5f6c         "memory_l
+00005ab0: 696d 6974 223a 2073 656c 662e 6d65 6d6f  imit": self.memo
+00005ac0: 7279 5f6c 696d 6974 2c0a 2020 2020 2020  ry_limit,.      
+00005ad0: 2020 2020 2020 226c 6173 745f 7365 656e        "last_seen
+00005ae0: 223a 2073 656c 662e 6c61 7374 5f73 6565  ": self.last_see
+00005af0: 6e2c 0a20 2020 2020 2020 2020 2020 2022  n,.            "
+00005b00: 7365 7276 6963 6573 223a 2073 656c 662e  services": self.
+00005b10: 7365 7276 6963 6573 2c0a 2020 2020 2020  services,.      
+00005b20: 2020 2020 2020 226d 6574 7269 6373 223a        "metrics":
+00005b30: 2073 656c 662e 6d65 7472 6963 732c 0a20   self.metrics,. 
+00005b40: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00005b50: 7573 223a 2073 656c 662e 7374 6174 7573  us": self.status
+00005b60: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00005b70: 2020 2022 6e61 6e6e 7922 3a20 7365 6c66     "nanny": self
+00005b80: 2e6e 616e 6e79 2c0a 2020 2020 2020 2020  .nanny,.        
+00005b90: 2020 2020 2a2a 7365 6c66 2e65 7874 7261      **self.extra
+00005ba0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00005bb0: 2064 6566 205f 746f 5f64 6963 745f 6e6f   def _to_dict_no
+00005bc0: 5f6e 6573 7428 7365 6c66 2c20 2a2c 2065  _nest(self, *, e
+00005bd0: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
+00005be0: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
+00005bf0: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00005c00: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
+00005c10: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
+00005c20: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
+00005c30: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
+00005c40: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
+00005c50: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
+00005c60: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
+00005c70: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
+00005c80: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+00005c90: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00005ca0: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
+00005cb0: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
+00005cc0: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
+00005cd0: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
+00005ce0: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
+00005cf0: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
+00005d00: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+00005d10: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+00005d20: 7572 7369 7665 5f74 6f5f 6469 6374 280a  ursive_to_dict(.
+00005d30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005d40: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
+00005d50: 636c 7564 653d 7365 7428 6578 636c 7564  clude=set(exclud
+00005d60: 6529 207c 207b 2276 6572 7369 6f6e 7322  e) | {"versions"
+00005d70: 7d2c 2020 2320 7479 7065 3a20 6967 6e6f  },  # type: igno
+00005d80: 7265 0a20 2020 2020 2020 2020 2020 206d  re.            m
+00005d90: 656d 6265 7273 3d54 7275 652c 0a20 2020  embers=True,.   
+00005da0: 2020 2020 2029 0a0a 2020 2020 4070 726f       )..    @pro
+00005db0: 7065 7274 790a 2020 2020 6465 6620 7363  perty.    def sc
+00005dc0: 6865 6475 6c65 7228 7365 6c66 2920 2d3e  heduler(self) ->
+00005dd0: 2053 6368 6564 756c 6572 5374 6174 653a   SchedulerState:
+00005de0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00005df0: 7365 6c66 2e73 6368 6564 756c 6572 5f72  self.scheduler_r
+00005e00: 6566 0a20 2020 2020 2020 2073 203d 2073  ef.        s = s
+00005e10: 656c 662e 7363 6865 6475 6c65 725f 7265  elf.scheduler_re
+00005e20: 6628 290a 2020 2020 2020 2020 6173 7365  f().        asse
+00005e30: 7274 2073 0a20 2020 2020 2020 2072 6574  rt s.        ret
+00005e40: 7572 6e20 730a 0a20 2020 2064 6566 2061  urn s..    def a
+00005e50: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
+00005e60: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+00005e70: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+00005e80: 2020 2020 2020 2022 2222 4173 7369 676e         """Assign
+00005e90: 2061 2074 6173 6b20 746f 2074 6869 7320   a task to this 
+00005ea0: 776f 726b 6572 2066 6f72 2063 6f6d 7075  worker for compu
+00005eb0: 7465 2e22 2222 0a20 2020 2020 2020 2069  te.""".        i
+00005ec0: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+00005ed0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00005ee0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00005ef0: 206e 6f74 2069 6e20 7365 6c66 2e70 726f   not in self.pro
+00005f00: 6365 7373 696e 670a 0a20 2020 2020 2020  cessing..       
+00005f10: 2074 7020 3d20 7473 2e70 7265 6669 780a   tp = ts.prefix.
+00005f20: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+00005f30: 6b5f 7072 6566 6978 5f63 6f75 6e74 5b74  k_prefix_count[t
+00005f40: 702e 6e61 6d65 5d20 2b3d 2031 0a20 2020  p.name] += 1.   
+00005f50: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+00005f60: 6c65 722e 5f74 6173 6b5f 7072 6566 6978  ler._task_prefix
+00005f70: 5f63 6f75 6e74 5f67 6c6f 6261 6c5b 7470  _count_global[tp
+00005f80: 2e6e 616d 655d 202b 3d20 310a 2020 2020  .name] += 1.    
+00005f90: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
+00005fa0: 696e 672e 6164 6428 7473 290a 2020 2020  ing.add(ts).    
+00005fb0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+00005fc0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+00005fd0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00005fe0: 656c 6620 6e6f 7420 696e 2064 7473 2e77  elf not in dts.w
+00005ff0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+00006000: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00006010: 635f 6e65 6564 735f 7265 706c 6963 6128  c_needs_replica(
+00006020: 6474 7329 0a0a 2020 2020 6465 6620 6164  dts)..    def ad
+00006030: 645f 746f 5f6c 6f6e 675f 7275 6e6e 696e  d_to_long_runnin
+00006040: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
+00006050: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00006060: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00006070: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+00006080: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00006090: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
+000060a0: 662e 7072 6f63 6573 7369 6e67 0a20 2020  f.processing.   
+000060b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000060c0: 7473 206e 6f74 2069 6e20 7365 6c66 2e6c  ts not in self.l
+000060d0: 6f6e 675f 7275 6e6e 696e 670a 0a20 2020  ong_running..   
+000060e0: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
+000060f0: 655f 6672 6f6d 5f74 6173 6b5f 7072 6566  e_from_task_pref
+00006100: 6978 5f63 6f75 6e74 2874 7329 0a20 2020  ix_count(ts).   
+00006110: 2020 2020 2023 2043 616e 6e6f 7420 7265       # Cannot re
+00006120: 6d6f 7665 2066 726f 6d20 7072 6f63 6573  move from proces
+00006130: 7369 6e67 2073 696e 6365 2077 6527 7265  sing since we're
+00006140: 2075 7369 6e67 2074 6869 7320 666f 7220   using this for 
+00006150: 7468 696e 6773 206c 696b 650a 2020 2020  things like.    
+00006160: 2020 2020 2320 6964 6c65 6e65 7373 2064      # idleness d
+00006170: 6574 6563 7469 6f6e 2e20 4964 6c65 2077  etection. Idle w
+00006180: 6f72 6b65 7273 2061 7265 2074 7970 6963  orkers are typic
+00006190: 616c 6c79 2074 6172 6765 7465 6420 666f  ally targeted fo
+000061a0: 720a 2020 2020 2020 2020 2320 646f 776e  r.        # down
+000061b0: 7363 616c 696e 6720 6275 7420 7765 2073  scaling but we s
+000061c0: 686f 756c 6420 6e6f 7420 646f 776e 7363  hould not downsc
+000061d0: 616c 6520 776f 726b 6572 7320 7769 7468  ale workers with
+000061e0: 206c 6f6e 6720 7275 6e6e 696e 670a 2020   long running.  
+000061f0: 2020 2020 2020 2320 7461 736b 730a 2020        # tasks.  
+00006200: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
+00006210: 7275 6e6e 696e 672e 6164 6428 7473 290a  running.add(ts).
+00006220: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00006230: 6672 6f6d 5f70 726f 6365 7373 696e 6728  from_processing(
+00006240: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00006250: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+00006260: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+00006270: 6120 7461 736b 2066 726f 6d20 6120 776f  a task from a wo
+00006280: 726b 6572 7320 7072 6f63 6573 7369 6e67  rkers processing
+00006290: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+000062a0: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
+000062b0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000062c0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+000062d0: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
+000062e0: 0a0a 2020 2020 2020 2020 6966 2074 7320  ..        if ts 
+000062f0: 696e 2073 656c 662e 6c6f 6e67 5f72 756e  in self.long_run
+00006300: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00006310: 2020 7365 6c66 2e6c 6f6e 675f 7275 6e6e    self.long_runn
+00006320: 696e 672e 6469 7363 6172 6428 7473 290a  ing.discard(ts).
+00006330: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006340: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00006350: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
+00006360: 5f70 7265 6669 785f 636f 756e 7428 7473  _prefix_count(ts
+00006370: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00006380: 726f 6365 7373 696e 672e 7265 6d6f 7665  rocessing.remove
+00006390: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
+000063a0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+000063b0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000063c0: 2020 2020 2069 6620 6474 7320 696e 2073       if dts in s
+000063d0: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
+000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063f0: 7365 6c66 2e5f 6465 635f 6e65 6564 735f  self._dec_needs_
+00006400: 7265 706c 6963 6128 6474 7329 0a0a 2020  replica(dts)..  
+00006410: 2020 6465 6620 5f72 656d 6f76 655f 6672    def _remove_fr
+00006420: 6f6d 5f74 6173 6b5f 7072 6566 6978 5f63  om_task_prefix_c
+00006430: 6f75 6e74 2873 656c 662c 2074 733a 2054  ount(self, ts: T
+00006440: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00006450: 653a 0a20 2020 2020 2020 2063 6f75 6e74  e:.        count
+00006460: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
+00006470: 6669 785f 636f 756e 745b 7473 2e70 7265  fix_count[ts.pre
+00006480: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+00006490: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+000064a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000064b0: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+000064c0: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
+000064d0: 655d 203d 2063 6f75 6e74 0a20 2020 2020  e] = count.     
+000064e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000064f0: 2020 2020 2064 656c 2073 656c 662e 7461       del self.ta
+00006500: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
+00006510: 7473 2e70 7265 6669 782e 6e61 6d65 5d0a  ts.prefix.name].
+00006520: 0a20 2020 2020 2020 2063 6f75 6e74 203d  .        count =
+00006530: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006540: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+00006550: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
+00006560: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+00006570: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+00006580: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006590: 2e73 6368 6564 756c 6572 2e5f 7461 736b  .scheduler._task
+000065a0: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+000065b0: 6f62 616c 5b74 732e 7072 6566 6978 2e6e  obal[ts.prefix.n
+000065c0: 616d 655d 203d 2063 6f75 6e74 0a20 2020  ame] = count.   
+000065d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000065e0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+000065f0: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
+00006600: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+00006610: 6261 6c5b 7473 2e70 7265 6669 782e 6e61  bal[ts.prefix.na
+00006620: 6d65 5d0a 0a20 2020 2064 6566 2072 656d  me]..    def rem
+00006630: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
+00006640: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+00006650: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006660: 2020 2222 2254 6865 2077 6f72 6b65 7220    """The worker 
+00006670: 6e6f 206c 6f6e 6765 7220 6861 7320 6120  no longer has a 
+00006680: 7461 736b 2069 6e20 6d65 6d6f 7279 2222  task in memory""
+00006690: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+000066a0: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
+000066b0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+000066c0: 2020 6173 7365 7274 2073 656c 6620 696e    assert self in
+000066d0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+000066e0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000066f0: 7320 696e 2073 656c 662e 6861 735f 7768  s in self.has_wh
+00006700: 6174 0a20 2020 2020 2020 2020 2020 2061  at.            a
+00006710: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+00006720: 7365 6c66 2e6e 6565 6473 5f77 6861 740a  self.needs_what.
+00006730: 0a20 2020 2020 2020 2073 656c 662e 6e62  .        self.nb
+00006740: 7974 6573 202d 3d20 7473 2e67 6574 5f6e  ytes -= ts.get_n
+00006750: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
+00006760: 6465 6c20 7365 6c66 2e5f 6861 735f 7768  del self._has_wh
+00006770: 6174 5b74 735d 0a20 2020 2020 2020 2074  at[ts].        t
+00006780: 732e 7768 6f5f 6861 732e 7265 6d6f 7665  s.who_has.remove
+00006790: 2873 656c 6629 0a0a 2020 2020 6465 6620  (self)..    def 
+000067a0: 5f69 6e63 5f6e 6565 6473 5f72 6570 6c69  _inc_needs_repli
+000067b0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
+000067c0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+000067d0: 0a20 2020 2020 2020 2022 2222 4173 7369  .        """Assi
+000067e0: 676e 2061 2074 6173 6b20 6665 7463 6820  gn a task fetch 
+000067f0: 746f 2074 6869 7320 776f 726b 6572 2061  to this worker a
+00006800: 6e64 2075 7064 6174 6520 6e65 7477 6f72  nd update networ
+00006810: 6b20 6f63 6375 7061 6e63 6965 7322 2222  k occupancies"""
+00006820: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00006830: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
+00006840: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00006850: 2061 7373 6572 7420 7365 6c66 206e 6f74   assert self not
+00006860: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
+00006870: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00006880: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+00006890: 2e68 6173 5f77 6861 740a 2020 2020 2020  .has_what.      
+000068a0: 2020 6966 2074 7320 6e6f 7420 696e 2073    if ts not in s
+000068b0: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
+000068c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000068d0: 2e6e 6565 6473 5f77 6861 745b 7473 5d20  .needs_what[ts] 
+000068e0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+000068f0: 6e62 7974 6573 203d 2074 732e 6765 745f  nbytes = ts.get_
+00006900: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
+00006910: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
+00006920: 726b 5f6f 6363 202b 3d20 6e62 7974 6573  rk_occ += nbytes
+00006930: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006940: 662e 7363 6865 6475 6c65 722e 5f6e 6574  f.scheduler._net
+00006950: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c20  work_occ_global 
+00006960: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
+00006970: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00006980: 2020 2020 7365 6c66 2e6e 6565 6473 5f77      self.needs_w
+00006990: 6861 745b 7473 5d20 2b3d 2031 0a0a 2020  hat[ts] += 1..  
+000069a0: 2020 6465 6620 5f64 6563 5f6e 6565 6473    def _dec_needs
+000069b0: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
+000069c0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+000069d0: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+000069e0: 6620 7365 6c66 2e73 6368 6564 756c 6572  f self.scheduler
+000069f0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+00006a00: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00006a10: 2069 6e20 7365 6c66 2e6e 6565 6473 5f77   in self.needs_w
+00006a20: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
+00006a30: 662e 6e65 6564 735f 7768 6174 5b74 735d  f.needs_what[ts]
+00006a40: 202d 3d20 310a 2020 2020 2020 2020 6966   -= 1.        if
+00006a50: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
+00006a60: 5b74 735d 203d 3d20 303a 0a20 2020 2020  [ts] == 0:.     
+00006a70: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+00006a80: 6e65 6564 735f 7768 6174 5b74 735d 0a20  needs_what[ts]. 
+00006a90: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+00006aa0: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
+00006ab0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00006ac0: 7365 6c66 2e5f 6e65 7477 6f72 6b5f 6f63  self._network_oc
+00006ad0: 6320 2d3d 206e 6279 7465 730a 2020 2020  c -= nbytes.    
+00006ae0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00006af0: 6564 756c 6572 2e5f 6e65 7477 6f72 6b5f  eduler._network_
+00006b00: 6f63 635f 676c 6f62 616c 202d 3d20 6e62  occ_global -= nb
+00006b10: 7974 6573 0a0a 2020 2020 6465 6620 6164  ytes..    def ad
+00006b20: 645f 7265 706c 6963 6128 7365 6c66 2c20  d_replica(self, 
+00006b30: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+00006b40: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00006b50: 2222 2254 6865 2077 6f72 6b65 7220 6163  """The worker ac
+00006b60: 7175 6972 6564 2061 2072 6570 6c69 6361  quired a replica
+00006b70: 206f 6620 7461 736b 2222 220a 2020 2020   of task""".    
+00006b80: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
+00006b90: 6475 6c65 722e 7661 6c69 6461 7465 3a0a  duler.validate:.
+00006ba0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006bb0: 7274 2073 656c 6620 6e6f 7420 696e 2074  rt self not in t
+00006bc0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00006bd0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00006be0: 6e6f 7420 696e 2073 656c 662e 6861 735f  not in self.has_
+00006bf0: 7768 6174 0a0a 2020 2020 2020 2020 6e62  what..        nb
+00006c00: 7974 6573 203d 2074 732e 6765 745f 6e62  ytes = ts.get_nb
+00006c10: 7974 6573 2829 0a20 2020 2020 2020 2069  ytes().        i
+00006c20: 6620 7473 2069 6e20 7365 6c66 2e6e 6565  f ts in self.nee
+00006c30: 6473 5f77 6861 743a 0a20 2020 2020 2020  ds_what:.       
+00006c40: 2020 2020 2064 656c 2073 656c 662e 6e65       del self.ne
+00006c50: 6564 735f 7768 6174 5b74 735d 0a20 2020  eds_what[ts].   
+00006c60: 2020 2020 2020 2020 2073 656c 662e 5f6e           self._n
+00006c70: 6574 776f 726b 5f6f 6363 202d 3d20 6e62  etwork_occ -= nb
+00006c80: 7974 6573 0a20 2020 2020 2020 2020 2020  ytes.           
+00006c90: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006ca0: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
+00006cb0: 6261 6c20 2d3d 206e 6279 7465 730a 2020  bal -= nbytes.  
+00006cc0: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
+00006cd0: 2e61 6464 2873 656c 6629 0a20 2020 2020  .add(self).     
+00006ce0: 2020 2073 656c 662e 6e62 7974 6573 202b     self.nbytes +
+00006cf0: 3d20 6e62 7974 6573 0a20 2020 2020 2020  = nbytes.       
+00006d00: 2073 656c 662e 5f68 6173 5f77 6861 745b   self._has_what[
+00006d10: 7473 5d20 3d20 4e6f 6e65 0a0a 2020 2020  ts] = None..    
+00006d20: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00006d30: 6620 6f63 6375 7061 6e63 7928 7365 6c66  f occupancy(self
+00006d40: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
+00006d50: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006d60: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
+00006d70: 206f 7220 7365 6c66 2e73 6368 6564 756c   or self.schedul
+00006d80: 6572 2e5f 6361 6c63 5f6f 6363 7570 616e  er._calc_occupan
+00006d90: 6379 280a 2020 2020 2020 2020 2020 2020  cy(.            
+00006da0: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+00006db0: 5f63 6f75 6e74 2c20 7365 6c66 2e5f 6e65  _count, self._ne
+00006dc0: 7477 6f72 6b5f 6f63 630a 2020 2020 2020  twork_occ.      
+00006dd0: 2020 290a 0a0a 4064 6174 6163 6c61 7373    )...@dataclass
+00006de0: 6573 2e64 6174 6163 6c61 7373 0a63 6c61  es.dataclass.cla
+00006df0: 7373 2045 7272 6564 5461 736b 3a0a 2020  ss ErredTask:.  
+00006e00: 2020 2222 224c 6967 6874 7765 6967 6874    """Lightweight
+00006e10: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
+00006e20: 6f66 2061 6e20 6572 7265 6420 7461 736b  of an erred task
+00006e30: 2077 6974 686f 7574 2061 6e79 2064 6570   without any dep
+00006e40: 656e 6465 6e63 7920 696e 666f 726d 6174  endency informat
+00006e50: 696f 6e0a 2020 2020 6f72 2072 756e 7370  ion.    or runsp
+00006e60: 6563 2e0a 0a20 2020 2053 6565 2061 6c73  ec...    See als
+00006e70: 6f0a 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20  o.    --------. 
+00006e80: 2020 2054 6173 6b53 7461 7465 0a20 2020     TaskState.   
+00006e90: 2022 2222 0a0a 2020 2020 6b65 793a 2048   """..    key: H
+00006ea0: 6173 6861 626c 650a 2020 2020 7469 6d65  ashable.    time
+00006eb0: 7374 616d 703a 2066 6c6f 6174 0a20 2020  stamp: float.   
+00006ec0: 2065 7272 6564 5f6f 6e3a 2073 6574 5b73   erred_on: set[s
+00006ed0: 7472 5d0a 2020 2020 6578 6365 7074 696f  tr].    exceptio
+00006ee0: 6e5f 7465 7874 3a20 7374 720a 2020 2020  n_text: str.    
+00006ef0: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+00006f00: 7374 720a 0a0a 636c 6173 7320 436f 6d70  str...class Comp
+00006f10: 7574 6174 696f 6e3a 0a20 2020 2022 2222  utation:.    """
+00006f20: 436f 6c6c 6563 7469 6f6e 2074 7261 636b  Collection track
+00006f30: 696e 6720 6120 7369 6e67 6c65 2063 6f6d  ing a single com
+00006f40: 7075 7465 206f 7220 7065 7273 6973 7420  pute or persist 
+00006f50: 6361 6c6c 0a0a 2020 2020 4445 5052 4543  call..    DEPREC
+00006f60: 4154 4544 3a20 706c 6561 7365 2075 7365  ATED: please use
+00006f70: 2073 7061 6e73 2069 6e73 7465 6164 0a0a   spans instead..
+00006f80: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00006f90: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
+00006fa0: 736b 5072 6566 6978 0a20 2020 2054 6173  skPrefix.    Tas
+00006fb0: 6b47 726f 7570 0a20 2020 2054 6173 6b53  kGroup.    TaskS
+00006fc0: 7461 7465 0a20 2020 2022 2222 0a0a 2020  tate.    """..  
+00006fd0: 2020 7374 6172 743a 2066 6c6f 6174 0a20    start: float. 
+00006fe0: 2020 2067 726f 7570 733a 2073 6574 5b54     groups: set[T
+00006ff0: 6173 6b47 726f 7570 5d0a 2020 2020 636f  askGroup].    co
+00007000: 6465 3a20 536f 7274 6564 5365 745b 7475  de: SortedSet[tu
+00007010: 706c 655b 536f 7572 6365 436f 6465 2c20  ple[SourceCode, 
+00007020: 2e2e 2e5d 5d0a 2020 2020 6964 3a20 7575  ...]].    id: uu
+00007030: 6964 2e55 5549 440a 2020 2020 616e 6e6f  id.UUID.    anno
+00007040: 7461 7469 6f6e 733a 2064 6963 740a 0a20  tations: dict.. 
+00007050: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+00007060: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+00007070: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+00007080: 5f69 6e69 745f 5f28 7365 6c66 293a 0a20  _init__(self):. 
+00007090: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
+000070a0: 7420 3d20 7469 6d65 2829 0a20 2020 2020  t = time().     
+000070b0: 2020 2073 656c 662e 6772 6f75 7073 203d     self.groups =
+000070c0: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
+000070d0: 656c 662e 636f 6465 203d 2053 6f72 7465  elf.code = Sorte
+000070e0: 6453 6574 2829 0a20 2020 2020 2020 2073  dSet().        s
+000070f0: 656c 662e 6964 203d 2075 7569 642e 7575  elf.id = uuid.uu
+00007100: 6964 3428 290a 2020 2020 2020 2020 7365  id4().        se
+00007110: 6c66 2e61 6e6e 6f74 6174 696f 6e73 203d  lf.annotations =
+00007120: 207b 7d0a 0a20 2020 2040 7072 6f70 6572   {}..    @proper
+00007130: 7479 0a20 2020 2064 6566 2073 746f 7028  ty.    def stop(
+00007140: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
+00007150: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00007160: 6772 6f75 7073 3a0a 2020 2020 2020 2020  groups:.        
+00007170: 2020 2020 7265 7475 726e 206d 6178 2874      return max(t
+00007180: 672e 7374 6f70 2066 6f72 2074 6720 696e  g.stop for tg in
+00007190: 2073 656c 662e 6772 6f75 7073 290a 2020   self.groups).  
+000071a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000071b0: 2020 2020 2020 2020 7265 7475 726e 202d          return -
+000071c0: 310a 0a20 2020 2040 7072 6f70 6572 7479  1..    @property
+000071d0: 0a20 2020 2064 6566 2073 7461 7465 7328  .    def states(
+000071e0: 7365 6c66 2920 2d3e 2064 6963 745b 5461  self) -> dict[Ta
+000071f0: 736b 5374 6174 6553 7461 7465 2c20 696e  skStateState, in
+00007200: 745d 3a0a 2020 2020 2020 2020 7265 7475  t]:.        retu
+00007210: 726e 206d 6572 6765 5f77 6974 6828 7375  rn merge_with(su
+00007220: 6d2c 2028 7467 2e73 7461 7465 7320 666f  m, (tg.states fo
+00007230: 7220 7467 2069 6e20 7365 6c66 2e67 726f  r tg in self.gro
+00007240: 7570 7329 290a 0a20 2020 2064 6566 205f  ups))..    def _
+00007250: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
+00007260: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+00007270: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+00007280: 2020 2066 223c 436f 6d70 7574 6174 696f     f"<Computatio
+00007290: 6e20 7b73 656c 662e 6964 7d3a 2022 0a20  n {self.id}: ". 
+000072a0: 2020 2020 2020 2020 2020 202b 2022 5461             + "Ta
+000072b0: 736b 733a 2022 0a20 2020 2020 2020 2020  sks: ".         
+000072c0: 2020 202b 2022 2c20 222e 6a6f 696e 280a     + ", ".join(.
+000072d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000072e0: 2225 733a 2025 6422 2025 2028 6b2c 2076  "%s: %d" % (k, v
+000072f0: 2920 666f 7220 286b 2c20 7629 2069 6e20  ) for (k, v) in 
+00007300: 736f 7274 6564 2873 656c 662e 7374 6174  sorted(self.stat
+00007310: 6573 2e69 7465 6d73 2829 2920 6966 2076  es.items()) if v
+00007320: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00007330: 2020 2020 2020 2020 2020 202b 2022 3e22             + ">"
+00007340: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00007350: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
+00007360: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
+00007370: 2020 2020 2020 7265 7475 726e 2067 6574        return get
+00007380: 5f74 656d 706c 6174 6528 2263 6f6d 7075  _template("compu
+00007390: 7461 7469 6f6e 2e68 746d 6c2e 6a32 2229  tation.html.j2")
+000073a0: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
+000073b0: 2020 2020 2069 643d 7365 6c66 2e69 642c       id=self.id,
+000073c0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000073d0: 7274 3d73 656c 662e 7374 6172 742c 0a20  rt=self.start,. 
+000073e0: 2020 2020 2020 2020 2020 2073 746f 703d             stop=
+000073f0: 7365 6c66 2e73 746f 702c 0a20 2020 2020  self.stop,.     
+00007400: 2020 2020 2020 2067 726f 7570 733d 7365         groups=se
+00007410: 6c66 2e67 726f 7570 732c 0a20 2020 2020  lf.groups,.     
+00007420: 2020 2020 2020 2073 7461 7465 733d 7365         states=se
+00007430: 6c66 2e73 7461 7465 732c 0a20 2020 2020  lf.states,.     
+00007440: 2020 2020 2020 2063 6f64 653d 7365 6c66         code=self
+00007450: 2e63 6f64 652c 0a20 2020 2020 2020 2029  .code,.        )
+00007460: 0a0a 0a63 6c61 7373 2054 6173 6b50 7265  ...class TaskPre
+00007470: 6669 783a 0a20 2020 2022 2222 436f 6c6c  fix:.    """Coll
+00007480: 6563 7469 6f6e 2074 7261 636b 696e 6720  ection tracking 
+00007490: 616c 6c20 7461 736b 7320 7769 7468 696e  all tasks within
+000074a0: 2061 2067 726f 7570 0a0a 2020 2020 4b65   a group..    Ke
+000074b0: 7973 206f 6674 656e 2068 6176 6520 6120  ys often have a 
+000074c0: 7374 7275 6374 7572 6520 6c69 6b65 2060  structure like `
+000074d0: 6028 2278 2d31 3233 222c 2030 2960 600a  `("x-123", 0)``.
+000074e0: 2020 2020 4120 6772 6f75 7020 7461 6b65      A group take
+000074f0: 7320 7468 6520 6669 7273 7420 7365 6374  s the first sect
+00007500: 696f 6e2c 206c 696b 6520 6060 2278 2260  ion, like ``"x"`
+00007510: 600a 0a20 2020 2053 6565 2041 6c73 6f0a  `..    See Also.
+00007520: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00007530: 2054 6173 6b47 726f 7570 0a20 2020 2022   TaskGroup.    "
+00007540: 2222 0a0a 2020 2020 233a 2054 6865 206e  ""..    #: The n
+00007550: 616d 6520 6f66 2061 2067 726f 7570 206f  ame of a group o
+00007560: 6620 7461 736b 732e 0a20 2020 2023 3a20  f tasks..    #: 
+00007570: 466f 7220 6120 7461 736b 206c 696b 6520  For a task like 
+00007580: 6060 2822 782d 3132 3322 2c20 3029 6060  ``("x-123", 0)``
+00007590: 2074 6869 7320 6973 2074 6865 2074 6578   this is the tex
+000075a0: 7420 6060 2278 2260 600a 2020 2020 6e61  t ``"x"``.    na
+000075b0: 6d65 3a20 7374 720a 0a20 2020 2023 3a20  me: str..    #: 
+000075c0: 416e 2065 7870 6f6e 656e 7469 616c 6c79  An exponentially
+000075d0: 2077 6569 6768 7465 6420 6d6f 7669 6e67   weighted moving
+000075e0: 2061 7665 7261 6765 2064 7572 6174 696f   average duratio
+000075f0: 6e20 6f66 2061 6c6c 2074 6173 6b73 2077  n of all tasks w
+00007600: 6974 6820 7468 6973 2070 7265 6669 780a  ith this prefix.
+00007610: 2020 2020 6475 7261 7469 6f6e 5f61 7665      duration_ave
+00007620: 7261 6765 3a20 666c 6f61 740a 0a20 2020  rage: float..   
+00007630: 2023 3a20 4e75 6d62 6572 7320 6f66 2074   #: Numbers of t
+00007640: 696d 6573 2061 2074 6173 6b20 7761 7320  imes a task was 
+00007650: 6d61 726b 6564 2061 7320 7375 7370 6963  marked as suspic
+00007660: 696f 7573 2077 6974 6820 7468 6973 2070  ious with this p
+00007670: 7265 6669 780a 2020 2020 7375 7370 6963  refix.    suspic
+00007680: 696f 7573 3a20 696e 740a 0a20 2020 2023  ious: int..    #
+00007690: 3a20 5374 6f72 6520 7469 6d69 6e67 7320  : Store timings 
+000076a0: 666f 7220 6561 6368 2070 7265 6669 782d  for each prefix-
+000076b0: 6163 7469 6f6e 0a20 2020 2061 6c6c 5f64  action.    all_d
+000076c0: 7572 6174 696f 6e73 3a20 6465 6661 756c  urations: defaul
+000076d0: 7464 6963 745b 7374 722c 2066 6c6f 6174  tdict[str, float
+000076e0: 5d0a 0a20 2020 2023 3a20 5468 6973 206d  ]..    #: This m
+000076f0: 6561 7375 7265 7320 7468 6520 6d61 7869  easures the maxi
+00007700: 6d75 6d20 7265 636f 7264 6564 206c 6976  mum recorded liv
+00007710: 6520 6578 6563 7574 696f 6e20 7469 6d65  e execution time
+00007720: 2061 6e64 2063 616e 2062 6520 7573 6564   and can be used
+00007730: 2074 6f0a 2020 2020 233a 2064 6574 6563   to.    #: detec
+00007740: 7420 6f75 746c 6965 7273 0a20 2020 206d  t outliers.    m
+00007750: 6178 5f65 7865 635f 7469 6d65 3a20 666c  ax_exec_time: fl
+00007760: 6f61 740a 0a20 2020 2023 3a20 5461 736b  oat..    #: Task
+00007770: 2067 726f 7570 7320 6173 736f 6369 6174   groups associat
+00007780: 6564 2074 6f20 7468 6973 2070 7265 6669  ed to this prefi
+00007790: 780a 2020 2020 6772 6f75 7073 3a20 6c69  x.    groups: li
+000077a0: 7374 5b54 6173 6b47 726f 7570 5d0a 0a20  st[TaskGroup].. 
+000077b0: 2020 2023 3a20 4163 6375 6d75 6c61 7465     #: Accumulate
+000077c0: 2063 6f75 6e74 206f 6620 6e75 6d62 6572   count of number
+000077d0: 206f 6620 7461 736b 7320 696e 2065 6163   of tasks in eac
+000077e0: 6820 7374 6174 650a 2020 2020 7374 6174  h state.    stat
+000077f0: 655f 636f 756e 7473 3a20 6465 6661 756c  e_counts: defaul
+00007800: 7464 6963 745b 5461 736b 5374 6174 6553  tdict[TaskStateS
+00007810: 7461 7465 2c20 696e 745d 0a0a 2020 2020  tate, int]..    
+00007820: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+00007830: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+00007840: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+00007850: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
+00007860: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
+00007870: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+00007880: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+00007890: 7570 7320 3d20 5b5d 0a20 2020 2020 2020  ups = [].       
+000078a0: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+000078b0: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
+000078c0: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+000078d0: 2073 656c 662e 7374 6174 655f 636f 756e   self.state_coun
+000078e0: 7473 203d 2064 6566 6175 6c74 6469 6374  ts = defaultdict
+000078f0: 2869 6e74 290a 2020 2020 2020 2020 7461  (int).        ta
+00007900: 736b 5f64 7572 6174 696f 6e73 203d 2064  sk_durations = d
+00007910: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+00007920: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+00007930: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
+00007940: 736b 2d64 7572 6174 696f 6e73 2229 0a20  sk-durations"). 
+00007950: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+00007960: 616d 6520 696e 2074 6173 6b5f 6475 7261  ame in task_dura
+00007970: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00007980: 2020 2073 656c 662e 6475 7261 7469 6f6e     self.duration
+00007990: 5f61 7665 7261 6765 203d 2070 6172 7365  _average = parse
+000079a0: 5f74 696d 6564 656c 7461 2874 6173 6b5f  _timedelta(task_
+000079b0: 6475 7261 7469 6f6e 735b 7365 6c66 2e6e  durations[self.n
+000079c0: 616d 655d 290a 2020 2020 2020 2020 656c  ame]).        el
+000079d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000079e0: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+000079f0: 6572 6167 6520 3d20 2d31 0a20 2020 2020  erage = -1.     
+00007a00: 2020 2073 656c 662e 6d61 785f 6578 6563     self.max_exec
+00007a10: 5f74 696d 6520 3d20 2d31 0a20 2020 2020  _time = -1.     
+00007a20: 2020 2073 656c 662e 7375 7370 6963 696f     self.suspicio
+00007a30: 7573 203d 2030 0a0a 2020 2020 6465 6620  us = 0..    def 
+00007a40: 6164 645f 6578 6563 5f74 696d 6528 7365  add_exec_time(se
+00007a50: 6c66 2c20 6475 7261 7469 6f6e 3a20 666c  lf, duration: fl
+00007a60: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
+00007a70: 2020 2020 2020 7365 6c66 2e6d 6178 5f65        self.max_e
+00007a80: 7865 635f 7469 6d65 203d 206d 6178 2864  xec_time = max(d
+00007a90: 7572 6174 696f 6e2c 2073 656c 662e 6d61  uration, self.ma
+00007aa0: 785f 6578 6563 5f74 696d 6529 0a20 2020  x_exec_time).   
+00007ab0: 2020 2020 2069 6620 6475 7261 7469 6f6e       if duration
+00007ac0: 203e 2032 202a 2073 656c 662e 6475 7261   > 2 * self.dura
+00007ad0: 7469 6f6e 5f61 7665 7261 6765 3a0a 2020  tion_average:.  
+00007ae0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00007af0: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
+00007b00: 3d20 2d31 0a0a 2020 2020 6465 6620 6164  = -1..    def ad
+00007b10: 645f 6475 7261 7469 6f6e 2873 656c 662c  d_duration(self,
+00007b20: 2061 6374 696f 6e3a 2073 7472 2c20 7374   action: str, st
+00007b30: 6172 743a 2066 6c6f 6174 2c20 7374 6f70  art: float, stop
+00007b40: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
+00007b50: 3a0a 2020 2020 2020 2020 6475 7261 7469  :.        durati
+00007b60: 6f6e 203d 2073 746f 7020 2d20 7374 6172  on = stop - star
+00007b70: 740a 2020 2020 2020 2020 7365 6c66 2e61  t.        self.a
+00007b80: 6c6c 5f64 7572 6174 696f 6e73 5b61 6374  ll_durations[act
+00007b90: 696f 6e5d 202b 3d20 6475 7261 7469 6f6e  ion] += duration
+00007ba0: 0a20 2020 2020 2020 2069 6620 6163 7469  .        if acti
+00007bb0: 6f6e 203d 3d20 2263 6f6d 7075 7465 223a  on == "compute":
+00007bc0: 0a20 2020 2020 2020 2020 2020 206f 6c64  .            old
+00007bd0: 203d 2073 656c 662e 6475 7261 7469 6f6e   = self.duration
+00007be0: 5f61 7665 7261 6765 0a20 2020 2020 2020  _average.       
+00007bf0: 2020 2020 2069 6620 6f6c 6420 3c20 303a       if old < 0:
+00007c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007c10: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007c20: 7665 7261 6765 203d 2064 7572 6174 696f  verage = duratio
+00007c30: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+00007c40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007c50: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
+00007c60: 6e5f 6176 6572 6167 6520 3d20 302e 3520  n_average = 0.5 
+00007c70: 2a20 6475 7261 7469 6f6e 202b 2030 2e35  * duration + 0.5
+00007c80: 202a 206f 6c64 0a0a 2020 2020 4070 726f   * old..    @pro
+00007c90: 7065 7274 790a 2020 2020 6465 6620 7374  perty.    def st
+00007ca0: 6174 6573 2873 656c 6629 202d 3e20 6469  ates(self) -> di
+00007cb0: 6374 5b73 7472 2c20 696e 745d 3a0a 2020  ct[str, int]:.  
+00007cc0: 2020 2020 2020 2222 2254 6865 206e 756d        """The num
+00007cd0: 6265 7220 6f66 2074 6173 6b73 2069 6e20  ber of tasks in 
+00007ce0: 6561 6368 2073 7461 7465 2c0a 2020 2020  each state,.    
+00007cf0: 2020 2020 6c69 6b65 2060 607b 226d 656d      like ``{"mem
+00007d00: 6f72 7922 3a20 3130 2c20 2270 726f 6365  ory": 10, "proce
+00007d10: 7373 696e 6722 3a20 332c 2022 7265 6c65  ssing": 3, "rele
+00007d20: 6173 6564 223a 2034 2c20 2e2e 2e7d 6060  ased": 4, ...}``
+00007d30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00007d40: 2020 2020 2072 6574 7572 6e20 6d65 7267       return merg
+00007d50: 655f 7769 7468 2873 756d 2c20 5b74 672e  e_with(sum, [tg.
+00007d60: 7374 6174 6573 2066 6f72 2074 6720 696e  states for tg in
+00007d70: 2073 656c 662e 6772 6f75 7073 5d29 0a0a   self.groups])..
+00007d80: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00007d90: 2020 6465 6620 6163 7469 7665 2873 656c    def active(sel
+00007da0: 6629 202d 3e20 6c69 7374 5b54 6173 6b47  f) -> list[TaskG
+00007db0: 726f 7570 5d3a 0a20 2020 2020 2020 2072  roup]:.        r
+00007dc0: 6574 7572 6e20 5b0a 2020 2020 2020 2020  eturn [.        
+00007dd0: 2020 2020 7467 0a20 2020 2020 2020 2020      tg.         
+00007de0: 2020 2066 6f72 2074 6720 696e 2073 656c     for tg in sel
+00007df0: 662e 6772 6f75 7073 0a20 2020 2020 2020  f.groups.       
+00007e00: 2020 2020 2069 6620 616e 7928 6b20 213d       if any(k !=
+00007e10: 2022 666f 7267 6f74 7465 6e22 2061 6e64   "forgotten" and
+00007e20: 2076 2021 3d20 3020 666f 7220 6b2c 2076   v != 0 for k, v
+00007e30: 2069 6e20 7467 2e73 7461 7465 732e 6974   in tg.states.it
+00007e40: 656d 7328 2929 0a20 2020 2020 2020 205d  ems()).        ]
+00007e50: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00007e60: 2020 2020 6465 6620 6163 7469 7665 5f73      def active_s
+00007e70: 7461 7465 7328 7365 6c66 2920 2d3e 2064  tates(self) -> d
+00007e80: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+00007e90: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
+00007ea0: 7267 655f 7769 7468 2873 756d 2c20 5b74  rge_with(sum, [t
+00007eb0: 672e 7374 6174 6573 2066 6f72 2074 6720  g.states for tg 
+00007ec0: 696e 2073 656c 662e 6163 7469 7665 5d29  in self.active])
+00007ed0: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00007ee0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+00007ef0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007f00: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
+00007f10: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+00007f20: 7365 6c66 2e6e 616d 650a 2020 2020 2020  self.name.      
+00007f30: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
+00007f40: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
+00007f50: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00007f60: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
+00007f70: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
+00007f80: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
+00007f90: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
+00007fa0: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
+00007fb0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00007fc0: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
+00007fd0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00007fe0: 2020 2020 6465 6620 6e62 7974 6573 5f74      def nbytes_t
+00007ff0: 6f74 616c 2873 656c 6629 202d 3e20 696e  otal(self) -> in
+00008000: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+00008010: 6e20 7375 6d28 7467 2e6e 6279 7465 735f  n sum(tg.nbytes_
+00008020: 746f 7461 6c20 666f 7220 7467 2069 6e20  total for tg in 
+00008030: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
+00008040: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
+00008050: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00008060: 2020 2020 7265 7475 726e 2073 756d 286d      return sum(m
+00008070: 6170 286c 656e 2c20 7365 6c66 2e67 726f  ap(len, self.gro
+00008080: 7570 7329 290a 0a20 2020 2040 7072 6f70  ups))..    @prop
+00008090: 6572 7479 0a20 2020 2064 6566 2064 7572  erty.    def dur
+000080a0: 6174 696f 6e28 7365 6c66 2920 2d3e 2066  ation(self) -> f
+000080b0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
+000080c0: 7475 726e 2073 756d 2874 672e 6475 7261  turn sum(tg.dura
+000080d0: 7469 6f6e 2066 6f72 2074 6720 696e 2073  tion for tg in s
+000080e0: 656c 662e 6772 6f75 7073 290a 0a20 2020  elf.groups)..   
+000080f0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00008100: 6566 2074 7970 6573 2873 656c 6629 202d  ef types(self) -
+00008110: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
+00008120: 2020 2020 7265 7475 726e 207b 7479 7020      return {typ 
+00008130: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
+00008140: 726f 7570 7320 666f 7220 7479 7020 696e  roups for typ in
+00008150: 2074 672e 7479 7065 737d 0a0a 0a63 6c61   tg.types}...cla
+00008160: 7373 2054 6173 6b47 726f 7570 3a0a 2020  ss TaskGroup:.  
+00008170: 2020 2222 2243 6f6c 6c65 6374 696f 6e20    """Collection 
+00008180: 7472 6163 6b69 6e67 2061 6c6c 2074 6173  tracking all tas
+00008190: 6b73 2077 6974 6869 6e20 6120 6772 6f75  ks within a grou
+000081a0: 700a 0a20 2020 204b 6579 7320 6f66 7465  p..    Keys ofte
+000081b0: 6e20 6861 7665 2061 2073 7472 7563 7475  n have a structu
+000081c0: 7265 206c 696b 6520 6060 2822 782d 3132  re like ``("x-12
+000081d0: 3322 2c20 3029 6060 0a20 2020 2041 2067  3", 0)``.    A g
+000081e0: 726f 7570 2074 616b 6573 2074 6865 2066  roup takes the f
+000081f0: 6972 7374 2073 6563 7469 6f6e 2c20 6c69  irst section, li
+00008200: 6b65 2060 6022 782d 3132 3322 6060 0a0a  ke ``"x-123"``..
+00008210: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00008220: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
+00008230: 736b 5072 6566 6978 0a20 2020 2022 2222  skPrefix.    """
+00008240: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
+00008250: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
+00008260: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
+00008270: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
+00008280: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
+00008290: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
+000082a0: 6060 2278 2d31 3233 2260 600a 2020 2020  ``"x-123"``.    
+000082b0: 6e61 6d65 3a20 7374 720a 0a20 2020 2023  name: str..    #
+000082c0: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
+000082d0: 7461 736b 7320 696e 2065 6163 6820 7374  tasks in each st
+000082e0: 6174 652c 0a20 2020 2023 3a20 6c69 6b65  ate,.    #: like
+000082f0: 2060 607b 226d 656d 6f72 7922 3a20 3130   ``{"memory": 10
+00008300: 2c20 2270 726f 6365 7373 696e 6722 3a20  , "processing": 
+00008310: 332c 2022 7265 6c65 6173 6564 223a 2034  3, "released": 4
+00008320: 2c20 2e2e 2e7d 6060 0a20 2020 2073 7461  , ...}``.    sta
+00008330: 7465 733a 2064 6963 745b 5461 736b 5374  tes: dict[TaskSt
+00008340: 6174 6553 7461 7465 2c20 696e 745d 0a0a  ateState, int]..
+00008350: 2020 2020 233a 2054 6865 206f 7468 6572      #: The other
+00008360: 2054 6173 6b47 726f 7570 7320 6f6e 2077   TaskGroups on w
+00008370: 6869 6368 2074 6869 7320 6f6e 6520 6465  hich this one de
+00008380: 7065 6e64 730a 2020 2020 6465 7065 6e64  pends.    depend
+00008390: 656e 6369 6573 3a20 7365 745b 5461 736b  encies: set[Task
+000083a0: 4772 6f75 705d 0a0a 2020 2020 233a 2054  Group]..    #: T
+000083b0: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
+000083c0: 6f66 2062 7974 6573 2074 6861 7420 7468  of bytes that th
+000083d0: 6973 2074 6173 6b20 6772 6f75 7020 6861  is task group ha
+000083e0: 7320 7072 6f64 7563 6564 0a20 2020 206e  s produced.    n
+000083f0: 6279 7465 735f 746f 7461 6c3a 2069 6e74  bytes_total: int
+00008400: 0a0a 2020 2020 233a 2054 6865 2074 6f74  ..    #: The tot
+00008410: 616c 2061 6d6f 756e 7420 6f66 2074 696d  al amount of tim
+00008420: 6520 7370 656e 7420 6f6e 2061 6c6c 2074  e spent on all t
+00008430: 6173 6b73 2069 6e20 7468 6973 2054 6173  asks in this Tas
+00008440: 6b47 726f 7570 0a20 2020 2064 7572 6174  kGroup.    durat
+00008450: 696f 6e3a 2066 6c6f 6174 0a0a 2020 2020  ion: float..    
+00008460: 233a 2054 6865 2072 6573 756c 7420 7479  #: The result ty
+00008470: 7065 7320 6f66 2074 6869 7320 5461 736b  pes of this Task
+00008480: 4772 6f75 700a 2020 2020 7479 7065 733a  Group.    types:
+00008490: 2073 6574 5b73 7472 5d0a 0a20 2020 2023   set[str]..    #
+000084a0: 3a20 5468 6520 776f 726b 6572 206d 6f73  : The worker mos
+000084b0: 7420 7265 6365 6e74 6c79 2061 7373 6967  t recently assig
+000084c0: 6e65 6420 6120 7461 736b 2066 726f 6d20  ned a task from 
+000084d0: 7468 6973 2067 726f 7570 2c20 6f72 204e  this group, or N
+000084e0: 6f6e 6520 7768 656e 2074 6865 2067 726f  one when the gro
+000084f0: 7570 0a20 2020 2023 3a20 6973 206e 6f74  up.    #: is not
+00008500: 2069 6465 6e74 6966 6965 6420 746f 2062   identified to b
+00008510: 6520 726f 6f74 2d6c 696b 6520 6279 2060  e root-like by `
+00008520: 5363 6865 6475 6c65 7253 7461 7465 2e64  SchedulerState.d
+00008530: 6563 6964 655f 776f 726b 6572 602e 0a20  ecide_worker`.. 
+00008540: 2020 206c 6173 745f 776f 726b 6572 3a20     last_worker: 
+00008550: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00008560: 6e65 0a0a 2020 2020 233a 2049 6620 606c  ne..    #: If `l
+00008570: 6173 745f 776f 726b 6572 6020 6973 206e  ast_worker` is n
+00008580: 6f74 204e 6f6e 652c 2074 6865 206e 756d  ot None, the num
+00008590: 6265 7220 6f66 2074 696d 6573 2074 6861  ber of times tha
+000085a0: 7420 776f 726b 6572 2073 686f 756c 6420  t worker should 
+000085b0: 6265 2061 7373 6967 6e65 640a 2020 2020  be assigned.    
+000085c0: 233a 2073 7562 7365 7175 656e 7420 7461  #: subsequent ta
+000085d0: 736b 7320 756e 7469 6c20 6120 6e65 7720  sks until a new 
+000085e0: 776f 726b 6572 2069 7320 6368 6f73 656e  worker is chosen
+000085f0: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
+00008600: 725f 7461 736b 735f 6c65 6674 3a20 696e  r_tasks_left: in
+00008610: 740a 0a20 2020 2070 7265 6669 783a 2054  t..    prefix: T
+00008620: 6173 6b50 7265 6669 7820 7c20 4e6f 6e65  askPrefix | None
+00008630: 0a0a 2020 2020 233a 2045 6172 6c69 6573  ..    #: Earlies
+00008640: 7420 7469 6d65 2077 6865 6e20 6120 7461  t time when a ta
+00008650: 736b 2062 656c 6f6e 6769 6e67 2074 6f20  sk belonging to 
+00008660: 7468 6973 2067 726f 7570 2073 7461 7274  this group start
+00008670: 6564 2063 6f6d 7075 7469 6e67 3b0a 2020  ed computing;.  
+00008680: 2020 233a 2030 2069 6620 6e6f 2074 6173    #: 0 if no tas
+00008690: 6b20 6861 7320 2a66 696e 6973 6865 642a  k has *finished*
+000086a0: 2063 6f6d 7075 7469 6e67 2079 6574 0a20   computing yet. 
+000086b0: 2020 2023 3a0a 2020 2020 233a 204e 6f74     #:.    #: Not
+000086c0: 6573 0a20 2020 2023 3a20 2d2d 2d2d 2d0a  es.    #: -----.
+000086d0: 2020 2020 233a 2054 6869 7320 6973 206e      #: This is n
+000086e0: 6f74 2075 7064 6174 6564 2075 6e74 696c  ot updated until
+000086f0: 2061 7420 6c65 6173 7420 6f6e 6520 7461   at least one ta
+00008700: 736b 2068 6173 202a 6669 6e69 7368 6564  sk has *finished
+00008710: 2a20 636f 6d70 7574 696e 672e 0a20 2020  * computing..   
+00008720: 2023 3a20 4974 2063 6f75 6c64 206d 6f76   #: It could mov
+00008730: 6520 6261 636b 7761 7264 7320 6173 2074  e backwards as t
+00008740: 6173 6b73 2063 6f6d 706c 6574 652e 0a20  asks complete.. 
+00008750: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
+00008760: 0a20 2020 2023 3a20 4c61 7465 7374 2074  .    #: Latest t
+00008770: 696d 6520 7768 656e 2061 2074 6173 6b20  ime when a task 
+00008780: 6265 6c6f 6e67 696e 6720 746f 2074 6869  belonging to thi
+00008790: 7320 6772 6f75 7020 6669 6e69 7368 6564  s group finished
+000087a0: 2063 6f6d 7075 7469 6e67 2c0a 2020 2020   computing,.    
+000087b0: 233a 2030 2069 6620 6e6f 2074 6173 6b20  #: 0 if no task 
+000087c0: 6861 7320 6669 6e69 7368 6564 2063 6f6d  has finished com
+000087d0: 7075 7469 6e67 2079 6574 0a20 2020 2073  puting yet.    s
+000087e0: 746f 703a 2066 6c6f 6174 0a0a 2020 2020  top: float..    
+000087f0: 233a 2043 756d 756c 6174 6976 6520 6475  #: Cumulative du
+00008800: 7261 7469 6f6e 206f 6620 616c 6c20 636f  ration of all co
+00008810: 6d70 6c65 7465 6420 6163 7469 6f6e 732c  mpleted actions,
+00008820: 2062 7920 6163 7469 6f6e 0a20 2020 2061   by action.    a
+00008830: 6c6c 5f64 7572 6174 696f 6e73 3a20 6465  ll_durations: de
+00008840: 6661 756c 7464 6963 745b 7374 722c 2066  faultdict[str, f
+00008850: 6c6f 6174 5d0a 0a20 2020 2023 3a20 5370  loat]..    #: Sp
+00008860: 616e 2049 4420 2873 6565 2060 6064 6973  an ID (see ``dis
+00008870: 7472 6962 7574 6564 2e73 7061 6e73 6060  tributed.spans``
+00008880: 292e 0a20 2020 2023 3a20 4d61 7463 6865  )..    #: Matche
+00008890: 7320 6060 6469 7374 7269 6275 7465 642e  s ``distributed.
+000088a0: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
+000088b0: 6869 6e65 2e54 6173 6b53 7461 7465 2e73  hine.TaskState.s
+000088c0: 7061 6e5f 6964 6060 2e0a 2020 2020 233a  pan_id``..    #:
+000088d0: 2049 7420 6973 2070 6f73 7369 626c 6520   It is possible 
+000088e0: 746f 2065 6e64 2075 7020 696e 2073 6974  to end up in sit
+000088f0: 7561 7469 6f6e 2077 6865 7265 2064 6966  uation where dif
+00008900: 6665 7265 6e74 2074 6173 6b73 206f 6620  ferent tasks of 
+00008910: 7468 6520 7361 6d65 2054 6173 6b47 726f  the same TaskGro
+00008920: 7570 0a20 2020 2023 3a20 6265 6c6f 6e67  up.    #: belong
+00008930: 2074 6f20 6469 6666 6572 656e 7420 7370   to different sp
+00008940: 616e 733b 2074 6865 2070 7572 706f 7365  ans; the purpose
+00008950: 206f 6620 7468 6973 2061 7474 7269 6275   of this attribu
+00008960: 7465 2069 7320 746f 2061 7262 6974 7261  te is to arbitra
+00008970: 7269 6c79 2066 6f72 6365 0a20 2020 2023  rily force.    #
+00008980: 3a20 6576 6572 7974 6869 6e67 206f 6e74  : everything ont
+00008990: 6f20 7468 6520 6561 726c 6965 7374 2065  o the earliest e
+000089a0: 6e63 6f75 6e74 6572 6564 206f 6e65 2e0a  ncountered one..
+000089b0: 2020 2020 7370 616e 5f69 643a 2073 7472      span_id: str
+000089c0: 207c 204e 6f6e 650a 0a20 2020 205f 5f73   | None..    __s
+000089d0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+000089e0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+000089f0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00008a00: 5f28 7365 6c66 2c20 6e61 6d65 3a20 7374  _(self, name: st
+00008a10: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
+00008a20: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
+00008a30: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
+00008a40: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00008a50: 7365 6c66 2e73 7461 7465 7320 3d20 6469  self.states = di
+00008a60: 6374 2e66 726f 6d6b 6579 7328 414c 4c5f  ct.fromkeys(ALL_
+00008a70: 5441 534b 5f53 5441 5445 532c 2030 290a  TASK_STATES, 0).
+00008a80: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
+00008a90: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
+00008aa0: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00008ab0: 6279 7465 735f 746f 7461 6c20 3d20 300a  bytes_total = 0.
+00008ac0: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
+00008ad0: 6174 696f 6e20 3d20 300a 2020 2020 2020  ation = 0.      
+00008ae0: 2020 7365 6c66 2e74 7970 6573 203d 2073    self.types = s
+00008af0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00008b00: 662e 7374 6172 7420 3d20 302e 300a 2020  f.start = 0.0.  
+00008b10: 2020 2020 2020 7365 6c66 2e73 746f 7020        self.stop 
+00008b20: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
+00008b30: 6c66 2e61 6c6c 5f64 7572 6174 696f 6e73  lf.all_durations
+00008b40: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+00008b50: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
+00008b60: 6c66 2e6c 6173 745f 776f 726b 6572 203d  lf.last_worker =
+00008b70: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+00008b80: 6c66 2e6c 6173 745f 776f 726b 6572 5f74  lf.last_worker_t
+00008b90: 6173 6b73 5f6c 6566 7420 3d20 300a 2020  asks_left = 0.  
+00008ba0: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
+00008bb0: 6964 203d 204e 6f6e 650a 0a20 2020 2064  id = None..    d
+00008bc0: 6566 2061 6464 5f64 7572 6174 696f 6e28  ef add_duration(
+00008bd0: 7365 6c66 2c20 6163 7469 6f6e 3a20 7374  self, action: st
+00008be0: 722c 2073 7461 7274 3a20 666c 6f61 742c  r, start: float,
+00008bf0: 2073 746f 703a 2066 6c6f 6174 2920 2d3e   stop: float) ->
+00008c00: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
+00008c10: 7572 6174 696f 6e20 3d20 7374 6f70 202d  uration = stop -
+00008c20: 2073 7461 7274 0a20 2020 2020 2020 2073   start.        s
+00008c30: 656c 662e 6475 7261 7469 6f6e 202b 3d20  elf.duration += 
+00008c40: 6475 7261 7469 6f6e 0a20 2020 2020 2020  duration.       
+00008c50: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00008c60: 6f6e 735b 6163 7469 6f6e 5d20 2b3d 2064  ons[action] += d
+00008c70: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
+00008c80: 6966 2061 6374 696f 6e20 3d3d 2022 636f  if action == "co
+00008c90: 6d70 7574 6522 3a0a 2020 2020 2020 2020  mpute":.        
+00008ca0: 2020 2020 6966 2073 656c 662e 7374 6f70      if self.stop
+00008cb0: 203c 2073 746f 703a 0a20 2020 2020 2020   < stop:.       
+00008cc0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+00008cd0: 6f70 203d 2073 746f 700a 2020 2020 2020  op = stop.      
+00008ce0: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00008cf0: 6172 7420 3d3d 2030 2e30 206f 7220 7365  art == 0.0 or se
+00008d00: 6c66 2e73 7461 7274 203e 2073 7461 7274  lf.start > start
+00008d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008d20: 2020 7365 6c66 2e73 7461 7274 203d 2073    self.start = s
+00008d30: 7461 7274 0a20 2020 2020 2020 2061 7373  tart.        ass
+00008d40: 6572 7420 7365 6c66 2e70 7265 6669 7820  ert self.prefix 
+00008d50: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00008d60: 2020 2020 7365 6c66 2e70 7265 6669 782e      self.prefix.
+00008d70: 6164 645f 6475 7261 7469 6f6e 2861 6374  add_duration(act
+00008d80: 696f 6e2c 2073 7461 7274 2c20 7374 6f70  ion, start, stop
+00008d90: 290a 0a20 2020 2064 6566 2061 6464 2873  )..    def add(s
+00008da0: 656c 662c 206f 7468 6572 3a20 5461 736b  elf, other: Task
+00008db0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00008dc0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00008dd0: 7465 735b 6f74 6865 722e 7374 6174 655d  tes[other.state]
+00008de0: 202b 3d20 310a 2020 2020 2020 2020 6f74   += 1.        ot
+00008df0: 6865 722e 6772 6f75 7020 3d20 7365 6c66  her.group = self
+00008e00: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+00008e10: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+00008e20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00008e30: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
+00008e40: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
+00008e50: 2873 656c 662e 6e61 6d65 206f 7220 226e  (self.name or "n
+00008e60: 6f2d 6772 6f75 7022 290a 2020 2020 2020  o-group").      
+00008e70: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
+00008e80: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
+00008e90: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
+00008ea0: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
+00008eb0: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
+00008ec0: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
+00008ed0: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
+00008ee0: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
+00008ef0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00008f00: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
+00008f10: 0a0a 2020 2020 6465 6620 5f5f 6c65 6e5f  ..    def __len_
+00008f20: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
+00008f30: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00008f40: 756d 2873 656c 662e 7374 6174 6573 2e76  um(self.states.v
+00008f50: 616c 7565 7328 2929 0a0a 2020 2020 6465  alues())..    de
+00008f60: 6620 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  f _to_dict_no_ne
+00008f70: 7374 2873 656c 662c 202a 2c20 6578 636c  st(self, *, excl
+00008f80: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
+00008f90: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
+00008fa0: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+00008fb0: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
+00008fc0: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
+00008fd0: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
+00008fe0: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
+00008ff0: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
+00009000: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
+00009010: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
+00009020: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
+00009030: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
+00009040: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
+00009050: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
+00009060: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
+00009070: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
+00009080: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
+00009090: 6963 740a 2020 2020 2020 2020 5461 736b  ict.        Task
+000090a0: 5374 6174 652e 5f74 6f5f 6469 6374 0a20  State._to_dict. 
+000090b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000090c0: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
+000090d0: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
+000090e0: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
+000090f0: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
+00009100: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+00009110: 2020 2020 6465 6620 646f 6e65 2873 656c      def done(sel
+00009120: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
+00009130: 2020 2020 2222 2252 6574 7572 6e20 5472      """Return Tr
+00009140: 7565 2069 6620 616c 6c20 636f 6d70 7574  ue if all comput
+00009150: 6174 696f 6e73 2066 6f72 2074 6869 7320  ations for this 
+00009160: 6772 6f75 7020 6861 7665 2063 6f6d 706c  group have compl
+00009170: 6574 6564 3b20 4661 6c73 650a 2020 2020  eted; False.    
+00009180: 2020 2020 6f74 6865 7277 6973 652e 0a0a      otherwise...
+00009190: 2020 2020 2020 2020 4e6f 7465 730a 2020          Notes.  
+000091a0: 2020 2020 2020 2d2d 2d2d 2d0a 2020 2020        -----.    
+000091b0: 2020 2020 5468 6973 2070 726f 7065 7274      This propert
+000091c0: 7920 6d61 7920 7472 616e 7369 7469 6f6e  y may transition
+000091d0: 2066 726f 6d20 5472 7565 2074 6f20 4661   from True to Fa
+000091e0: 6c73 652c 2065 2e67 2e20 7768 656e 2061  lse, e.g. when a
+000091f0: 2077 6f72 6b65 7220 7468 6174 0a20 2020   worker that.   
+00009200: 2020 2020 2063 6f6e 7461 696e 6564 2074       contained t
+00009210: 6865 206f 6e6c 7920 7265 706c 6963 6120  he only replica 
+00009220: 6f66 2061 2074 6173 6b20 696e 206d 656d  of a task in mem
+00009230: 6f72 7920 6372 6173 6865 7320 616e 6420  ory crashes and 
+00009240: 7468 6520 7461 736b 206e 6565 6420 746f  the task need to
+00009250: 2062 650a 2020 2020 2020 2020 7265 636f   be.        reco
+00009260: 6d70 7574 6564 2e0a 2020 2020 2020 2020  mputed..        
+00009270: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00009280: 726e 2061 6c6c 280a 2020 2020 2020 2020  rn all(.        
+00009290: 2020 2020 636f 756e 7420 3d3d 2030 206f      count == 0 o
+000092a0: 7220 7374 6174 6520 696e 207b 226d 656d  r state in {"mem
+000092b0: 6f72 7922 2c20 2265 7272 6564 222c 2022  ory", "erred", "
+000092c0: 7265 6c65 6173 6564 222c 2022 666f 7267  released", "forg
+000092d0: 6f74 7465 6e22 7d0a 2020 2020 2020 2020  otten"}.        
+000092e0: 2020 2020 666f 7220 7374 6174 652c 2063      for state, c
+000092f0: 6f75 6e74 2069 6e20 7365 6c66 2e73 7461  ount in self.sta
+00009300: 7465 732e 6974 656d 7328 290a 2020 2020  tes.items().    
+00009310: 2020 2020 290a 0a0a 636c 6173 7320 5461      )...class Ta
+00009320: 736b 5374 6174 653a 0a20 2020 2022 2222  skState:.    """
+00009330: 4120 7369 6d70 6c65 206f 626a 6563 7420  A simple object 
+00009340: 686f 6c64 696e 6720 696e 666f 726d 6174  holding informat
+00009350: 696f 6e20 6162 6f75 7420 6120 7461 736b  ion about a task
+00009360: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
+00009370: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
+00009380: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
+00009390: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
+000093a0: 6d61 6368 696e 652e 5461 736b 5374 6174  machine.TaskStat
+000093b0: 6560 2c20 7768 6963 680a 2020 2020 686f  e`, which.    ho
+000093c0: 6c64 7320 7369 6d69 6c61 7220 696e 666f  lds similar info
+000093d0: 726d 6174 696f 6e20 6f6e 2074 6865 2057  rmation on the W
+000093e0: 6f72 6b65 7220 7369 6465 2e0a 2020 2020  orker side..    
+000093f0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
+00009400: 6b65 7920 6973 2074 6865 2075 6e69 7175  key is the uniqu
+00009410: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
+00009420: 6120 7461 736b 2c20 6765 6e65 7261 6c6c  a task, generall
+00009430: 7920 666f 726d 6564 2066 726f 6d20 7468  y formed from th
+00009440: 6520 6e61 6d65 206f 6620 7468 650a 2020  e name of the.  
+00009450: 2020 233a 2066 756e 6374 696f 6e2c 2066    #: function, f
+00009460: 6f6c 6c6f 7765 6420 6279 2061 2068 6173  ollowed by a has
+00009470: 6820 6f66 2074 6865 2066 756e 6374 696f  h of the functio
+00009480: 6e20 616e 6420 6172 6775 6d65 6e74 732c  n and arguments,
+00009490: 206c 696b 650a 2020 2020 233a 2060 6027   like.    #: ``'
+000094a0: 696e 632d 6162 3331 6330 3130 3434 3439  inc-ab31c0104449
+000094b0: 3737 3030 3464 3635 3636 3130 6432 6434  77004d656610d2d4
+000094c0: 3231 6563 2760 602e 0a20 2020 206b 6579  21ec'``..    key
+000094d0: 3a20 7374 720a 0a20 2020 2023 3a20 5468  : str..    #: Th
+000094e0: 6520 6272 6f61 6420 636c 6173 7320 6f66  e broad class of
+000094f0: 2074 6173 6b73 2074 6f20 7768 6963 6820   tasks to which 
+00009500: 7468 6973 2074 6173 6b20 6265 6c6f 6e67  this task belong
+00009510: 7320 6c69 6b65 2022 696e 6322 206f 7220  s like "inc" or 
+00009520: 2272 6561 645f 6373 7622 0a20 2020 2070  "read_csv".    p
+00009530: 7265 6669 783a 2054 6173 6b50 7265 6669  refix: TaskPrefi
+00009540: 780a 0a20 2020 2023 3a20 4120 7370 6563  x..    #: A spec
+00009550: 6966 6963 6174 696f 6e20 6f66 2068 6f77  ification of how
+00009560: 2074 6f20 7275 6e20 7468 6520 7461 736b   to run the task
+00009570: 2e20 2054 6865 2074 7970 6520 616e 6420  .  The type and 
+00009580: 6d65 616e 696e 6720 6f66 2074 6869 7320  meaning of this 
+00009590: 7661 6c75 6520 6973 0a20 2020 2023 3a20  value is.    #: 
+000095a0: 6f70 6171 7565 2074 6f20 7468 6520 7363  opaque to the sc
+000095b0: 6865 6475 6c65 722c 2061 7320 6974 2069  heduler, as it i
+000095c0: 7320 6f6e 6c79 2069 6e74 6572 7072 6574  s only interpret
+000095d0: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
+000095e0: 2074 6f20 7768 6963 6820 7468 650a 2020   to which the.  
+000095f0: 2020 233a 2074 6173 6b20 6973 2073 656e    #: task is sen
+00009600: 7420 666f 7220 6578 6563 7574 696e 672e  t for executing.
+00009610: 0a20 2020 2023 3a0a 2020 2020 233a 2041  .    #:.    #: A
+00009620: 7320 6120 7370 6563 6961 6c20 6361 7365  s a special case
+00009630: 2c20 7468 6973 2061 7474 7269 6275 7465  , this attribute
+00009640: 206d 6179 2061 6c73 6f20 6265 2060 604e   may also be ``N
+00009650: 6f6e 6560 602c 2069 6e20 7768 6963 6820  one``, in which 
+00009660: 6361 7365 2074 6865 2074 6173 6b20 6973  case the task is
+00009670: 0a20 2020 2023 3a20 2270 7572 6520 6461  .    #: "pure da
+00009680: 7461 2220 2873 7563 6820 6173 2c20 666f  ta" (such as, fo
+00009690: 7220 6578 616d 706c 652c 2061 2070 6965  r example, a pie
+000096a0: 6365 206f 6620 6461 7461 206c 6f61 6465  ce of data loade
+000096b0: 6420 696e 2074 6865 2073 6368 6564 756c  d in the schedul
+000096c0: 6572 2075 7369 6e67 0a20 2020 2023 3a20  er using.    #: 
+000096d0: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
+000096e0: 6174 7465 7260 292e 2020 4120 2270 7572  atter`).  A "pur
+000096f0: 6520 6461 7461 2220 7461 736b 2063 616e  e data" task can
+00009700: 6e6f 7420 6265 2063 6f6d 7075 7465 6420  not be computed 
+00009710: 6167 6169 6e20 6966 2069 7473 0a20 2020  again if its.   
+00009720: 2023 3a20 7661 6c75 6520 6973 206c 6f73   #: value is los
+00009730: 742e 0a20 2020 2072 756e 5f73 7065 633a  t..    run_spec:
+00009740: 206f 626a 6563 740a 0a20 2020 2023 3a20   object..    #: 
+00009750: 5468 6520 7072 696f 7269 7479 2070 726f  The priority pro
+00009760: 7669 6465 7320 6561 6368 2074 6173 6b20  vides each task 
+00009770: 7769 7468 2061 2072 656c 6174 6976 6520  with a relative 
+00009780: 7261 6e6b 696e 6720 7768 6963 6820 6973  ranking which is
+00009790: 2075 7365 6420 746f 2062 7265 616b 0a20   used to break. 
+000097a0: 2020 2023 3a20 7469 6573 2077 6865 6e20     #: ties when 
+000097b0: 6d61 6e79 2074 6173 6b73 2061 7265 2062  many tasks are b
+000097c0: 6569 6e67 2063 6f6e 7369 6465 7265 6420  eing considered 
+000097d0: 666f 7220 6578 6563 7574 696f 6e2e 0a20  for execution.. 
+000097e0: 2020 2023 3a0a 2020 2020 233a 2054 6869     #:.    #: Thi
+000097f0: 7320 7261 6e6b 696e 6720 6973 2067 656e  s ranking is gen
+00009800: 6572 616c 6c79 2061 2032 2d69 7465 6d20  erally a 2-item 
+00009810: 7475 706c 652e 2020 5468 6520 6669 7273  tuple.  The firs
+00009820: 7420 2861 6e64 2064 6f6d 696e 616e 7429  t (and dominant)
+00009830: 2069 7465 6d0a 2020 2020 233a 2063 6f72   item.    #: cor
+00009840: 7265 7370 6f6e 6473 2074 6f20 7768 656e  responds to when
+00009850: 2069 7420 7761 7320 7375 626d 6974 7465   it was submitte
+00009860: 642e 2020 4765 6e65 7261 6c6c 792c 2065  d.  Generally, e
+00009870: 6172 6c69 6572 2074 6173 6b73 2074 616b  arlier tasks tak
+00009880: 6520 7072 6563 6564 656e 6365 2e0a 2020  e precedence..  
+00009890: 2020 233a 2054 6865 2073 6563 6f6e 6420    #: The second 
+000098a0: 6974 656d 2069 7320 6465 7465 726d 696e  item is determin
+000098b0: 6564 2062 7920 7468 6520 636c 6965 6e74  ed by the client
+000098c0: 2c20 616e 6420 6973 2061 2077 6179 2074  , and is a way t
+000098d0: 6f20 7072 696f 7269 7469 7a65 2074 6173  o prioritize tas
+000098e0: 6b73 0a20 2020 2023 3a20 7769 7468 696e  ks.    #: within
+000098f0: 2061 206c 6172 6765 2067 7261 7068 2074   a large graph t
+00009900: 6861 7420 6d61 7920 6265 2069 6d70 6f72  hat may be impor
+00009910: 7461 6e74 2c20 7375 6368 2061 7320 6966  tant, such as if
+00009920: 2074 6865 7920 6172 6520 6f6e 2074 6865   they are on the
+00009930: 2063 7269 7469 6361 6c0a 2020 2020 233a   critical.    #:
+00009940: 2070 6174 682c 206f 7220 676f 6f64 2074   path, or good t
+00009950: 6f20 7275 6e20 696e 206f 7264 6572 2074  o run in order t
+00009960: 6f20 7265 6c65 6173 6520 6d61 6e79 2064  o release many d
+00009970: 6570 656e 6465 6e63 6965 732e 2020 5468  ependencies.  Th
+00009980: 6973 2069 7320 6578 706c 6169 6e65 640a  is is explained.
+00009990: 2020 2020 233a 2066 7572 7468 6572 2069      #: further i
+000099a0: 6e20 3a64 6f63 3a60 5363 6865 6475 6c69  n :doc:`Scheduli
+000099b0: 6e67 2050 6f6c 6963 7920 3c73 6368 6564  ng Policy <sched
+000099c0: 756c 696e 672d 706f 6c69 6369 6573 3e60  uling-policies>`
+000099d0: 2e0a 2020 2020 7072 696f 7269 7479 3a20  ..    priority: 
+000099e0: 7475 706c 655b 666c 6f61 742c 202e 2e2e  tuple[float, ...
+000099f0: 5d20 7c20 4e6f 6e65 0a0a 2020 2020 2320  ] | None..    # 
+00009a00: 4174 7472 6962 7574 6520 756e 6465 726c  Attribute underl
+00009a10: 7969 6e67 2074 6865 2073 7461 7465 2070  ying the state p
+00009a20: 726f 7065 7274 790a 2020 2020 5f73 7461  roperty.    _sta
+00009a30: 7465 3a20 5461 736b 5374 6174 6553 7461  te: TaskStateSta
+00009a40: 7465 0a0a 2020 2020 233a 2054 6865 2073  te..    #: The s
+00009a50: 6574 206f 6620 7461 736b 7320 7468 6973  et of tasks this
+00009a60: 2074 6173 6b20 6465 7065 6e64 7320 6f6e   task depends on
+00009a70: 2066 6f72 2070 726f 7065 7220 6578 6563   for proper exec
+00009a80: 7574 696f 6e2e 204f 6e6c 7920 7461 736b  ution. Only task
+00009a90: 7320 7374 696c 6c0a 2020 2020 233a 2061  s still.    #: a
+00009aa0: 6c69 7665 2061 7265 206c 6973 7465 6420  live are listed 
+00009ab0: 696e 2074 6869 7320 7365 742e 2049 662c  in this set. If,
+00009ac0: 2066 6f72 2077 6861 7465 7665 7220 7265   for whatever re
+00009ad0: 6173 6f6e 2c20 7468 6973 2074 6173 6b20  ason, this task 
+00009ae0: 616c 736f 2064 6570 656e 6473 206f 6e0a  also depends on.
+00009af0: 2020 2020 233a 2061 2066 6f72 676f 7474      #: a forgott
+00009b00: 656e 2074 6173 6b2c 2074 6865 203a 6174  en task, the :at
+00009b10: 7472 3a60 6861 735f 6c6f 7374 5f64 6570  tr:`has_lost_dep
+00009b20: 656e 6465 6e63 6965 7360 2066 6c61 6720  endencies` flag 
+00009b30: 6973 2073 6574 2e0a 2020 2020 233a 0a20  is set..    #:. 
+00009b40: 2020 2023 3a20 4120 7461 736b 2063 616e     #: A task can
+00009b50: 206f 6e6c 7920 6265 2065 7865 6375 7465   only be execute
+00009b60: 6420 6f6e 6365 2061 6c6c 2069 7473 2064  d once all its d
+00009b70: 6570 656e 6465 6e63 6965 7320 6861 7665  ependencies have
+00009b80: 2061 6c72 6561 6479 2062 6565 6e0a 2020   already been.  
+00009b90: 2020 233a 2073 7563 6365 7373 6675 6c6c    #: successfull
+00009ba0: 7920 6578 6563 7574 6564 2061 6e64 2068  y executed and h
+00009bb0: 6176 6520 7468 6569 7220 7265 7375 6c74  ave their result
+00009bc0: 2073 746f 7265 6420 6f6e 2061 7420 6c65   stored on at le
+00009bd0: 6173 7420 6f6e 6520 776f 726b 6572 2e20  ast one worker. 
+00009be0: 5468 6973 0a20 2020 2023 3a20 6973 2074  This.    #: is t
+00009bf0: 7261 636b 6564 2062 7920 7072 6f67 7265  racked by progre
+00009c00: 7373 6976 656c 7920 6472 6169 6e69 6e67  ssively draining
+00009c10: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+00009c20: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+00009c30: 2064 6570 656e 6465 6e63 6965 733a 2073   dependencies: s
+00009c40: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00009c50: 2020 2023 3a20 5468 6520 7365 7420 6f66     #: The set of
+00009c60: 2074 6173 6b73 2077 6869 6368 2064 6570   tasks which dep
+00009c70: 656e 6420 6f6e 2074 6869 7320 7461 736b  end on this task
+00009c80: 2e20 204f 6e6c 7920 7461 736b 7320 7374  .  Only tasks st
+00009c90: 696c 6c20 616c 6976 6520 6172 6520 6c69  ill alive are li
+00009ca0: 7374 6564 2069 6e0a 2020 2020 233a 2074  sted in.    #: t
+00009cb0: 6869 7320 7365 742e 2054 6869 7320 6973  his set. This is
+00009cc0: 2074 6865 2072 6576 6572 7365 206d 6170   the reverse map
+00009cd0: 7069 6e67 206f 6620 3a61 7474 723a 6064  ping of :attr:`d
+00009ce0: 6570 656e 6465 6e63 6965 7360 2e0a 2020  ependencies`..  
+00009cf0: 2020 6465 7065 6e64 656e 7473 3a20 7365    dependents: se
+00009d00: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
+00009d10: 2020 233a 2057 6865 7468 6572 2061 6e79    #: Whether any
+00009d20: 206f 6620 7468 6520 6465 7065 6e64 656e   of the dependen
+00009d30: 6369 6573 206f 6620 7468 6973 2074 6173  cies of this tas
+00009d40: 6b20 6861 7320 6265 656e 2066 6f72 676f  k has been forgo
+00009d50: 7474 656e 2e20 466f 7220 6d65 6d6f 7279  tten. For memory
+00009d60: 0a20 2020 2023 3a20 636f 6e73 756d 7074  .    #: consumpt
+00009d70: 696f 6e20 7265 6173 6f6e 732c 2066 6f72  ion reasons, for
+00009d80: 676f 7474 656e 2074 6173 6b73 2061 7265  gotten tasks are
+00009d90: 206e 6f74 206b 6570 7420 696e 206d 656d   not kept in mem
+00009da0: 6f72 7920 6576 656e 2074 686f 7567 6820  ory even though 
+00009db0: 7468 6579 206d 6179 0a20 2020 2023 3a20  they may.    #: 
+00009dc0: 6861 7665 2064 6570 656e 6465 6e74 2074  have dependent t
+00009dd0: 6173 6b73 2e20 2057 6865 6e20 6120 7461  asks.  When a ta
+00009de0: 736b 2069 7320 666f 7267 6f74 7465 6e2c  sk is forgotten,
+00009df0: 2074 6865 7265 666f 7265 2c20 6561 6368   therefore, each
+00009e00: 206f 6620 6974 730a 2020 2020 233a 2064   of its.    #: d
+00009e10: 6570 656e 6465 6e74 7320 6861 7320 7468  ependents has th
+00009e20: 6569 7220 3a61 7474 723a 6068 6173 5f6c  eir :attr:`has_l
+00009e30: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+00009e40: 6020 6174 7472 6962 7574 6520 7365 7420  ` attribute set 
+00009e50: 746f 2060 6054 7275 6560 602e 0a20 2020  to ``True``..   
+00009e60: 2023 3a0a 2020 2020 233a 2049 6620 3a61   #:.    #: If :a
+00009e70: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
+00009e80: 7065 6e64 656e 6369 6573 6020 6973 2074  pendencies` is t
+00009e90: 7275 652c 2074 6869 7320 7461 736b 2063  rue, this task c
+00009ea0: 616e 6e6f 7420 676f 2069 6e74 6f20 7468  annot go into th
+00009eb0: 650a 2020 2020 233a 2022 7072 6f63 6573  e.    #: "proces
+00009ec0: 7369 6e67 2220 7374 6174 6520 616e 796d  sing" state anym
+00009ed0: 6f72 652e 0a20 2020 2068 6173 5f6c 6f73  ore..    has_los
+00009ee0: 745f 6465 7065 6e64 656e 6369 6573 3a20  t_dependencies: 
+00009ef0: 626f 6f6c 0a0a 2020 2020 233a 2054 6865  bool..    #: The
+00009f00: 2073 6574 206f 6620 7461 736b 7320 7468   set of tasks th
+00009f10: 6973 2074 6173 6b20 6973 2077 6169 7469  is task is waiti
+00009f20: 6e67 206f 6e20 2a62 6566 6f72 652a 2069  ng on *before* i
+00009f30: 7420 6361 6e20 6265 2065 7865 6375 7465  t can be execute
+00009f40: 642e 2054 6869 7320 6973 0a20 2020 2023  d. This is.    #
+00009f50: 3a20 616c 7761 7973 2061 2073 7562 7365  : always a subse
+00009f60: 7420 6f66 203a 6174 7472 3a60 6465 7065  t of :attr:`depe
+00009f70: 6e64 656e 6369 6573 602e 2020 4561 6368  ndencies`.  Each
+00009f80: 2074 696d 6520 6f6e 6520 6f66 2074 6865   time one of the
+00009f90: 2064 6570 656e 6465 6e63 6965 7320 6861   dependencies ha
+00009fa0: 730a 2020 2020 233a 2066 696e 6973 6865  s.    #: finishe
+00009fb0: 6420 7072 6f63 6573 7369 6e67 2c20 6974  d processing, it
+00009fc0: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
+00009fd0: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
+00009fe0: 696e 675f 6f6e 6020 7365 742e 0a20 2020  ing_on` set..   
+00009ff0: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+0000a000: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
+0000a010: 6e60 2062 6563 6f6d 6573 2065 6d70 7479  n` becomes empty
+0000a020: 2c20 7468 6973 2074 6173 6b20 6361 6e20  , this task can 
+0000a030: 6d6f 7665 2066 726f 6d20 7468 6520 2277  move from the "w
+0000a040: 6169 7469 6e67 220a 2020 2020 233a 2073  aiting".    #: s
+0000a050: 7461 7465 2074 6f20 7468 6520 2270 726f  tate to the "pro
+0000a060: 6365 7373 696e 6722 2073 7461 7465 2028  cessing" state (
+0000a070: 756e 6c65 7373 206f 6e65 206f 6620 7468  unless one of th
+0000a080: 6520 6465 7065 6e64 656e 6369 6573 2065  e dependencies e
+0000a090: 7272 6f72 6564 206f 7574 2c20 696e 0a20  rrored out, in. 
+0000a0a0: 2020 2023 3a20 7768 6963 6820 6361 7365     #: which case
+0000a0b0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
+0000a0c0: 7374 6561 6420 6d61 726b 6564 2022 6572  stead marked "er
+0000a0d0: 7265 6422 292e 0a20 2020 2077 6169 7469  red")..    waiti
+0000a0e0: 6e67 5f6f 6e3a 2073 6574 5b54 6173 6b53  ng_on: set[TaskS
+0000a0f0: 7461 7465 5d0a 0a20 2020 2023 3a20 5468  tate]..    #: Th
+0000a100: 6520 7365 7420 6f66 2074 6173 6b73 2077  e set of tasks w
+0000a110: 6869 6368 206e 6565 6420 7468 6973 2074  hich need this t
+0000a120: 6173 6b20 746f 2072 656d 6169 6e20 616c  ask to remain al
+0000a130: 6976 652e 2020 5468 6973 2069 7320 616c  ive.  This is al
+0000a140: 7761 7973 2061 2073 7562 7365 740a 2020  ways a subset.  
+0000a150: 2020 233a 206f 6620 3a61 7474 723a 6064    #: of :attr:`d
+0000a160: 6570 656e 6465 6e74 7360 2e20 2045 6163  ependents`.  Eac
+0000a170: 6820 7469 6d65 206f 6e65 206f 6620 7468  h time one of th
+0000a180: 6520 6465 7065 6e64 656e 7473 2068 6173  e dependents has
+0000a190: 2066 696e 6973 6865 6420 7072 6f63 6573   finished proces
+0000a1a0: 7369 6e67 2c0a 2020 2020 233a 2069 7420  sing,.    #: it 
+0000a1b0: 6973 2072 656d 6f76 6564 2066 726f 6d20  is removed from 
+0000a1c0: 7468 6520 3a61 7474 723a 6077 6169 7465  the :attr:`waite
+0000a1d0: 7273 6020 7365 742e 0a20 2020 2023 3a0a  rs` set..    #:.
+0000a1e0: 2020 2020 233a 204f 6e63 6520 626f 7468      #: Once both
+0000a1f0: 203a 6174 7472 3a60 7761 6974 6572 7360   :attr:`waiters`
+0000a200: 2061 6e64 203a 6174 7472 3a60 7768 6f5f   and :attr:`who_
+0000a210: 7761 6e74 7360 2062 6563 6f6d 6520 656d  wants` become em
+0000a220: 7074 792c 2074 6869 7320 7461 736b 2063  pty, this task c
+0000a230: 616e 2062 650a 2020 2020 233a 2072 656c  an be.    #: rel
+0000a240: 6561 7365 6420 2869 6620 6974 2068 6173  eased (if it has
+0000a250: 2061 206e 6f6e 2d65 6d70 7479 203a 6174   a non-empty :at
+0000a260: 7472 3a60 7275 6e5f 7370 6563 6029 206f  tr:`run_spec`) o
+0000a270: 7220 666f 7267 6f74 7465 6e20 286f 7468  r forgotten (oth
+0000a280: 6572 7769 7365 2920 6279 2074 6865 0a20  erwise) by the. 
+0000a290: 2020 2023 3a20 7363 6865 6475 6c65 722c     #: scheduler,
+0000a2a0: 2061 6e64 2062 7920 616e 7920 776f 726b   and by any work
+0000a2b0: 6572 7320 696e 203a 6174 7472 3a60 7768  ers in :attr:`wh
+0000a2c0: 6f5f 6861 7360 2e0a 2020 2020 233a 0a20  o_has`..    #:. 
+0000a2d0: 2020 2023 3a20 2e2e 206e 6f74 653a 3a0a     #: .. note::.
+0000a2e0: 2020 2020 233a 2020 2020 436f 756e 7465      #:    Counte
+0000a2f0: 722d 696e 7475 6974 6976 656c 792c 203a  r-intuitively, :
+0000a300: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
+0000a310: 6020 616e 6420 3a61 7474 723a 6077 6169  ` and :attr:`wai
+0000a320: 7465 7273 6020 6172 6520 6e6f 7420 7265  ters` are not re
+0000a330: 7665 7273 650a 2020 2020 233a 2020 2020  verse.    #:    
+0000a340: 6d61 7070 696e 6773 206f 6620 6561 6368  mappings of each
+0000a350: 206f 7468 6572 2e0a 2020 2020 7761 6974   other..    wait
+0000a360: 6572 733a 2073 6574 5b54 6173 6b53 7461  ers: set[TaskSta
+0000a370: 7465 5d0a 0a20 2020 2023 3a20 5468 6520  te]..    #: The 
+0000a380: 7365 7420 6f66 2063 6c69 656e 7473 2077  set of clients w
+0000a390: 686f 2077 616e 7420 7468 6520 7265 7375  ho want the resu
+0000a3a0: 6c74 206f 6620 7468 6973 2074 6173 6b20  lt of this task 
+0000a3b0: 746f 2072 656d 6169 6e20 616c 6976 652e  to remain alive.
+0000a3c0: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
+0000a3d0: 7468 6520 7265 7665 7273 6520 6d61 7070  the reverse mapp
+0000a3e0: 696e 6720 6f66 203a 6174 7472 3a60 436c  ing of :attr:`Cl
+0000a3f0: 6965 6e74 5374 6174 652e 7761 6e74 735f  ientState.wants_
+0000a400: 7768 6174 602e 0a20 2020 2023 3a0a 2020  what`..    #:.  
+0000a410: 2020 233a 2057 6865 6e20 6120 636c 6965    #: When a clie
+0000a420: 6e74 2073 7562 6d69 7473 2061 2067 7261  nt submits a gra
+0000a430: 7068 2074 6f20 7468 6520 7363 6865 6475  ph to the schedu
+0000a440: 6c65 7220 6974 2061 6c73 6f20 7370 6563  ler it also spec
+0000a450: 6966 6965 7320 7768 6963 6820 6f75 7470  ifies which outp
+0000a460: 7574 0a20 2020 2023 3a20 7461 736b 7320  ut.    #: tasks 
+0000a470: 6974 2064 6573 6972 6573 2c20 7375 6368  it desires, such
+0000a480: 2074 6861 7420 7468 6569 7220 7265 7375   that their resu
+0000a490: 6c74 7320 6172 6520 6e6f 7420 7265 6c65  lts are not rele
+0000a4a0: 6173 6564 2066 726f 6d20 6d65 6d6f 7279  ased from memory
+0000a4b0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+0000a4c0: 4f6e 6365 2061 2074 6173 6b20 6861 7320  Once a task has 
+0000a4d0: 6669 6e69 7368 6564 2065 7865 6375 7469  finished executi
+0000a4e0: 6e67 2028 692e 652e 206d 6f76 6573 2069  ng (i.e. moves i
+0000a4f0: 6e74 6f20 7468 6520 226d 656d 6f72 7922  nto the "memory"
+0000a500: 206f 7220 2265 7272 6564 220a 2020 2020   or "erred".    
+0000a510: 233a 2073 7461 7465 292c 2074 6865 2063  #: state), the c
+0000a520: 6c69 656e 7473 2069 6e20 3a61 7474 723a  lients in :attr:
+0000a530: 6077 686f 5f77 616e 7473 6020 6172 6520  `who_wants` are 
+0000a540: 6e6f 7469 6669 6564 2e0a 2020 2020 233a  notified..    #:
+0000a550: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
+0000a560: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
+0000a570: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
+0000a580: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
+0000a590: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
+0000a5a0: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
+0000a5b0: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
+0000a5c0: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
+0000a5d0: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
+0000a5e0: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
+0000a5f0: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
+0000a600: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
+0000a610: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
+0000a620: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
+0000a630: 686f 5f68 6173 602e 0a20 2020 2077 686f  ho_has`..    who
+0000a640: 5f77 616e 7473 3a20 7365 745b 436c 6965  _wants: set[Clie
+0000a650: 6e74 5374 6174 655d 0a0a 2020 2020 233a  ntState]..    #:
+0000a660: 2054 6865 2073 6574 206f 6620 776f 726b   The set of work
+0000a670: 6572 7320 7768 6f20 6861 7665 2074 6869  ers who have thi
+0000a680: 7320 7461 736b 2773 2072 6573 756c 7420  s task's result 
+0000a690: 696e 206d 656d 6f72 792e 2049 7420 6973  in memory. It is
+0000a6a0: 206e 6f6e 2d65 6d70 7479 2069 6666 2074   non-empty iff t
+0000a6b0: 6865 0a20 2020 2023 3a20 7461 736b 2069  he.    #: task i
+0000a6c0: 7320 696e 2074 6865 2022 6d65 6d6f 7279  s in the "memory
+0000a6d0: 2220 7374 6174 652e 2020 5468 6572 6520  " state.  There 
+0000a6e0: 6361 6e20 6265 206d 6f72 6520 7468 616e  can be more than
+0000a6f0: 206f 6e65 2077 6f72 6b65 7220 696e 2074   one worker in t
+0000a700: 6869 7320 7365 7420 6966 2c0a 2020 2020  his set if,.    
+0000a710: 233a 2066 6f72 2065 7861 6d70 6c65 2c20  #: for example, 
+0000a720: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
+0000a730: 6174 7465 7260 206f 7220 3a6d 6574 683a  atter` or :meth:
+0000a740: 6043 6c69 656e 742e 7265 706c 6963 6174  `Client.replicat
+0000a750: 6560 2077 6173 2075 7365 642e 0a20 2020  e` was used..   
+0000a760: 2023 3a0a 2020 2020 233a 2054 6869 7320   #:.    #: This 
+0000a770: 6973 2074 6865 2072 6576 6572 7365 206d  is the reverse m
+0000a780: 6170 7069 6e67 206f 6620 3a61 7474 723a  apping of :attr:
+0000a790: 6057 6f72 6b65 7253 7461 7465 2e68 6173  `WorkerState.has
+0000a7a0: 5f77 6861 7460 2e0a 2020 2020 7768 6f5f  _what`..    who_
+0000a7b0: 6861 733a 2073 6574 5b57 6f72 6b65 7253  has: set[WorkerS
+0000a7c0: 7461 7465 5d0a 0a20 2020 2023 3a20 4966  tate]..    #: If
+0000a7d0: 2074 6869 7320 7461 736b 2069 7320 696e   this task is in
+0000a7e0: 2074 6865 2022 7072 6f63 6573 7369 6e67   the "processing
+0000a7f0: 2220 7374 6174 652c 2077 6869 6368 2077  " state, which w
+0000a800: 6f72 6b65 7220 6973 2063 7572 7265 6e74  orker is current
+0000a810: 6c79 2070 726f 6365 7373 696e 670a 2020  ly processing.  
+0000a820: 2020 233a 2069 742e 2054 6869 7320 6174    #: it. This at
+0000a830: 7472 6962 7574 6520 6973 206b 6570 7420  tribute is kept 
+0000a840: 696e 2073 796e 6320 7769 7468 203a 6174  in sync with :at
+0000a850: 7472 3a60 576f 726b 6572 5374 6174 652e  tr:`WorkerState.
+0000a860: 7072 6f63 6573 7369 6e67 602e 0a20 2020  processing`..   
+0000a870: 2070 726f 6365 7373 696e 675f 6f6e 3a20   processing_on: 
+0000a880: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+0000a890: 6e65 0a0a 2020 2020 233a 2054 6865 206e  ne..    #: The n
+0000a8a0: 756d 6265 7220 6f66 2074 696d 6573 2074  umber of times t
+0000a8b0: 6869 7320 7461 736b 2063 616e 2061 7574  his task can aut
+0000a8c0: 6f6d 6174 6963 616c 6c79 2062 6520 7265  omatically be re
+0000a8d0: 7472 6965 6420 696e 2063 6173 6520 6f66  tried in case of
+0000a8e0: 2066 6169 6c75 7265 2e0a 2020 2020 233a   failure..    #:
+0000a8f0: 2049 6620 6120 7461 736b 2066 6169 6c73   If a task fails
+0000a900: 2065 7865 6375 7469 6e67 2028 7468 6520   executing (the 
+0000a910: 776f 726b 6572 2072 6574 7572 6e73 2077  worker returns w
+0000a920: 6974 6820 616e 2065 7272 6f72 292c 2069  ith an error), i
+0000a930: 7473 203a 6174 7472 3a60 7265 7472 6965  ts :attr:`retrie
+0000a940: 7360 0a20 2020 2023 3a20 6174 7472 6962  s`.    #: attrib
+0000a950: 7574 6520 6973 2063 6865 636b 6564 2e20  ute is checked. 
+0000a960: 4966 2069 7420 6973 2065 7175 616c 2074  If it is equal t
+0000a970: 6f20 302c 2074 6865 2074 6173 6b20 6973  o 0, the task is
+0000a980: 206d 6172 6b65 6420 2265 7272 6564 222e   marked "erred".
+0000a990: 2049 6620 6974 2069 730a 2020 2020 233a   If it is.    #:
+0000a9a0: 2067 7265 6174 6572 2074 6861 6e20 302c   greater than 0,
+0000a9b0: 2074 6865 203a 6174 7472 3a60 7265 7472   the :attr:`retr
+0000a9c0: 6965 7360 2061 7474 7269 6275 7465 2069  ies` attribute i
+0000a9d0: 7320 6465 6372 656d 656e 7465 6420 616e  s decremented an
+0000a9e0: 6420 6578 6563 7574 696f 6e20 6973 0a20  d execution is. 
+0000a9f0: 2020 2023 3a20 6174 7465 6d70 7465 6420     #: attempted 
+0000aa00: 6167 6169 6e2e 0a20 2020 2072 6574 7269  again..    retri
+0000aa10: 6573 3a20 696e 740a 0a20 2020 2023 3a20  es: int..    #: 
+0000aa20: 5468 6520 6e75 6d62 6572 206f 6620 6279  The number of by
+0000aa30: 7465 732c 2061 7320 6465 7465 726d 696e  tes, as determin
+0000aa40: 6564 2062 7920 6060 7369 7a65 6f66 6060  ed by ``sizeof``
+0000aa50: 2c20 6f66 2074 6865 2072 6573 756c 7420  , of the result 
+0000aa60: 6f66 2061 2066 696e 6973 6865 640a 2020  of a finished.  
+0000aa70: 2020 233a 2074 6173 6b2e 2054 6869 7320    #: task. This 
+0000aa80: 6e75 6d62 6572 2069 7320 7573 6564 2066  number is used f
+0000aa90: 6f72 2064 6961 676e 6f73 7469 6373 2061  or diagnostics a
+0000aaa0: 6e64 2074 6f20 6865 6c70 2070 7269 6f72  nd to help prior
+0000aab0: 6974 697a 6520 776f 726b 2e0a 2020 2020  itize work..    
+0000aac0: 233a 2053 6574 2074 6f20 2d31 2066 6f72  #: Set to -1 for
+0000aad0: 2075 6e66 696e 6973 6865 6420 7461 736b   unfinished task
+0000aae0: 732e 0a20 2020 206e 6279 7465 733a 2069  s..    nbytes: i
+0000aaf0: 6e74 0a0a 2020 2020 233a 2054 6865 2074  nt..    #: The t
+0000ab00: 7970 6520 6f66 2074 6865 206f 626a 6563  ype of the objec
+0000ab10: 7420 6173 2061 2073 7472 696e 672e 204f  t as a string. O
+0000ab20: 6e6c 7920 7072 6573 656e 7420 666f 7220  nly present for 
+0000ab30: 7461 736b 7320 7468 6174 2068 6176 6520  tasks that have 
+0000ab40: 6265 656e 0a20 2020 2023 3a20 636f 6d70  been.    #: comp
+0000ab50: 7574 6564 2e0a 2020 2020 7479 7065 3a20  uted..    type: 
+0000ab60: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
+0000ab70: 6869 7320 7461 736b 2066 6169 6c65 6420  his task failed 
+0000ab80: 6578 6563 7574 696e 672c 2074 6865 2065  executing, the e
+0000ab90: 7863 6570 7469 6f6e 206f 626a 6563 7420  xception object 
+0000aba0: 6973 2073 746f 7265 6420 6865 7265 2e0a  is stored here..
+0000abb0: 2020 2020 6578 6365 7074 696f 6e3a 2053      exception: S
+0000abc0: 6572 6961 6c69 7a65 6420 7c20 4e6f 6e65  erialized | None
+0000abd0: 0a0a 2020 2020 233a 2049 6620 7468 6973  ..    #: If this
+0000abe0: 2074 6173 6b20 6661 696c 6564 2065 7865   task failed exe
+0000abf0: 6375 7469 6e67 2c20 7468 6520 7472 6163  cuting, the trac
+0000ac00: 6562 6163 6b20 6f62 6a65 6374 2069 7320  eback object is 
+0000ac10: 7374 6f72 6564 2068 6572 652e 0a20 2020  stored here..   
+0000ac20: 2074 7261 6365 6261 636b 3a20 5365 7269   traceback: Seri
+0000ac30: 616c 697a 6564 207c 204e 6f6e 650a 0a20  alized | None.. 
+0000ac40: 2020 2023 3a20 7374 7269 6e67 2072 6570     #: string rep
+0000ac50: 7265 7365 6e74 6174 696f 6e20 6f66 2065  resentation of e
+0000ac60: 7863 6570 7469 6f6e 0a20 2020 2065 7863  xception.    exc
+0000ac70: 6570 7469 6f6e 5f74 6578 743a 2073 7472  eption_text: str
+0000ac80: 0a0a 2020 2020 233a 2073 7472 696e 6720  ..    #: string 
+0000ac90: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+0000aca0: 6620 7472 6163 6562 6163 6b0a 2020 2020  f traceback.    
+0000acb0: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+0000acc0: 7374 720a 0a20 2020 2023 3a20 4966 2074  str..    #: If t
+0000acd0: 6869 7320 7461 736b 206f 7220 6f6e 6520  his task or one 
+0000ace0: 6f66 2069 7473 2064 6570 656e 6465 6e63  of its dependenc
+0000acf0: 6965 7320 6661 696c 6564 2065 7865 6375  ies failed execu
+0000ad00: 7469 6e67 2c20 7468 6520 6661 696c 6564  ting, the failed
+0000ad10: 2074 6173 6b20 6973 0a20 2020 2023 3a20   task is.    #: 
+0000ad20: 7374 6f72 6564 2068 6572 6520 2870 6f73  stored here (pos
+0000ad30: 7369 626c 7920 6974 7365 6c66 292e 0a20  sibly itself).. 
+0000ad40: 2020 2065 7863 6570 7469 6f6e 5f62 6c61     exception_bla
+0000ad50: 6d65 3a20 5461 736b 5374 6174 6520 7c20  me: TaskState | 
+0000ad60: 4e6f 6e65 0a0a 2020 2020 233a 2057 6f72  None..    #: Wor
+0000ad70: 6b65 7220 6164 6472 6573 7365 7320 6f6e  ker addresses on
+0000ad80: 2077 6869 6368 2065 7272 6f72 7320 6170   which errors ap
+0000ad90: 7065 6172 6564 2c20 6361 7573 696e 6720  peared, causing 
+0000ada0: 7468 6973 2074 6173 6b20 746f 2062 6520  this task to be 
+0000adb0: 696e 2061 6e20 6572 726f 720a 2020 2020  in an error.    
+0000adc0: 233a 2073 7461 7465 2e0a 2020 2020 6572  #: state..    er
+0000add0: 7265 645f 6f6e 3a20 7365 745b 7374 725d  red_on: set[str]
+0000ade0: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
+0000adf0: 6265 7220 6f66 2074 696d 6573 2074 6869  ber of times thi
+0000ae00: 7320 7461 736b 2068 6173 2062 6565 6e20  s task has been 
+0000ae10: 696e 766f 6c76 6564 2069 6e20 6120 776f  involved in a wo
+0000ae20: 726b 6572 2064 6561 7468 2e0a 2020 2020  rker death..    
+0000ae30: 233a 0a20 2020 2023 3a20 536f 6d65 2074  #:.    #: Some t
+0000ae40: 6173 6b73 206d 6179 2063 6175 7365 2077  asks may cause w
+0000ae50: 6f72 6b65 7273 2074 6f20 6469 6520 2873  orkers to die (s
+0000ae60: 7563 6820 6173 2063 616c 6c69 6e67 2060  uch as calling `
+0000ae70: 606f 732e 5f65 7869 7428 3029 6060 292e  `os._exit(0)``).
+0000ae80: 2057 6865 6e20 610a 2020 2020 233a 2077   When a.    #: w
+0000ae90: 6f72 6b65 7220 6469 6573 2c20 616c 6c20  orker dies, all 
+0000aea0: 6f66 2074 6865 2074 6173 6b73 206f 6e20  of the tasks on 
+0000aeb0: 7468 6174 2077 6f72 6b65 7220 6172 6520  that worker are 
+0000aec0: 7265 6173 7369 676e 6564 2074 6f20 6f74  reassigned to ot
+0000aed0: 6865 7273 2e20 5468 6973 0a20 2020 2023  hers. This.    #
+0000aee0: 3a20 636f 6d62 696e 6174 696f 6e20 6f66  : combination of
+0000aef0: 2062 6568 6176 696f 7273 2063 616e 2063   behaviors can c
+0000af00: 6175 7365 2061 2062 6164 2074 6173 6b20  ause a bad task 
+0000af10: 746f 2063 6174 6173 7472 6f70 6869 6361  to catastrophica
+0000af20: 6c6c 7920 6465 7374 726f 7920 616c 6c0a  lly destroy all.
+0000af30: 2020 2020 233a 2077 6f72 6b65 7273 206f      #: workers o
+0000af40: 6e20 7468 6520 636c 7573 7465 722c 206f  n the cluster, o
+0000af50: 6e65 2061 6674 6572 2061 6e6f 7468 6572  ne after another
+0000af60: 2e20 5768 656e 6576 6572 2061 2077 6f72  . Whenever a wor
+0000af70: 6b65 7220 6469 6573 2c20 7765 206d 6172  ker dies, we mar
+0000af80: 6b20 6561 6368 0a20 2020 2023 3a20 7461  k each.    #: ta
+0000af90: 736b 2063 7572 7265 6e74 6c79 2070 726f  sk currently pro
+0000afa0: 6365 7373 696e 6720 6f6e 2074 6861 7420  cessing on that 
+0000afb0: 776f 726b 6572 2028 6173 2072 6563 6f72  worker (as recor
+0000afc0: 6465 6420 6279 0a20 2020 2023 3a20 3a61  ded by.    #: :a
+0000afd0: 7474 723a 6057 6f72 6b65 7253 7461 7465  ttr:`WorkerState
+0000afe0: 2e70 726f 6365 7373 696e 6760 2920 6173  .processing`) as
+0000aff0: 2073 7573 7069 6369 6f75 732e 2049 6620   suspicious. If 
+0000b000: 6120 7461 736b 2069 7320 696e 766f 6c76  a task is involv
+0000b010: 6564 2069 6e20 7468 7265 650a 2020 2020  ed in three.    
+0000b020: 233a 2064 6561 7468 7320 286f 7220 736f  #: deaths (or so
+0000b030: 6d65 206f 7468 6572 2066 6978 6564 2063  me other fixed c
+0000b040: 6f6e 7374 616e 7429 2074 6865 6e20 7765  onstant) then we
+0000b050: 206d 6172 6b20 7468 6520 7461 736b 2061   mark the task a
+0000b060: 7320 6060 6572 7265 6460 602e 0a20 2020  s ``erred``..   
+0000b070: 2073 7573 7069 6369 6f75 733a 2069 6e74   suspicious: int
+0000b080: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+0000b090: 6620 686f 7374 6e61 6d65 7320 7768 6572  f hostnames wher
+0000b0a0: 6520 7468 6973 2074 6173 6b20 6361 6e20  e this task can 
+0000b0b0: 6265 2072 756e 2028 6f72 2060 604e 6f6e  be run (or ``Non
+0000b0c0: 6560 6020 6966 2065 6d70 7479 292e 2055  e`` if empty). U
+0000b0d0: 7375 616c 6c79 0a20 2020 2023 3a20 7468  sually.    #: th
+0000b0e0: 6973 2069 7320 656d 7074 7920 756e 6c65  is is empty unle
+0000b0f0: 7373 2074 6865 2074 6173 6b20 6861 7320  ss the task has 
+0000b100: 6265 656e 2073 7065 6369 6669 6361 6c6c  been specificall
+0000b110: 7920 7265 7374 7269 6374 6564 2074 6f20  y restricted to 
+0000b120: 6f6e 6c79 2072 756e 206f 6e0a 2020 2020  only run on.    
+0000b130: 233a 2063 6572 7461 696e 2068 6f73 7473  #: certain hosts
+0000b140: 2e20 4120 686f 7374 6e61 6d65 206d 6179  . A hostname may
+0000b150: 2063 6f72 7265 7370 6f6e 6420 746f 206f   correspond to o
+0000b160: 6e65 206f 7220 7365 7665 7261 6c20 636f  ne or several co
+0000b170: 6e6e 6563 7465 6420 776f 726b 6572 732e  nnected workers.
+0000b180: 0a20 2020 2068 6f73 745f 7265 7374 7269  .    host_restri
+0000b190: 6374 696f 6e73 3a20 7365 745b 7374 725d  ctions: set[str]
+0000b1a0: 0a0a 2020 2020 233a 2041 2073 6574 206f  ..    #: A set o
+0000b1b0: 6620 636f 6d70 6c65 7465 2077 6f72 6b65  f complete worke
+0000b1c0: 7220 6164 6472 6573 7365 7320 7768 6572  r addresses wher
+0000b1d0: 6520 7468 6973 2063 616e 2062 6520 7275  e this can be ru
+0000b1e0: 6e20 286f 7220 6060 4e6f 6e65 6060 2069  n (or ``None`` i
+0000b1f0: 6620 656d 7074 7929 2e0a 2020 2020 233a  f empty)..    #:
+0000b200: 2055 7375 616c 6c79 2074 6869 7320 6973   Usually this is
+0000b210: 2065 6d70 7479 2075 6e6c 6573 7320 7468   empty unless th
+0000b220: 6520 7461 736b 2068 6173 2062 6565 6e20  e task has been 
+0000b230: 7370 6563 6966 6963 616c 6c79 2072 6573  specifically res
+0000b240: 7472 6963 7465 6420 746f 206f 6e6c 790a  tricted to only.
+0000b250: 2020 2020 233a 2072 756e 206f 6e20 6365      #: run on ce
+0000b260: 7274 6169 6e20 776f 726b 6572 732e 0a20  rtain workers.. 
+0000b270: 2020 2023 3a20 4e6f 7465 2074 6869 7320     #: Note this 
+0000b280: 6973 2074 7261 636b 696e 6720 776f 726b  is tracking work
+0000b290: 6572 2061 6464 7265 7373 6573 2c20 6e6f  er addresses, no
+0000b2a0: 7420 776f 726b 6572 2073 7461 7465 732c  t worker states,
+0000b2b0: 2073 696e 6365 2074 6865 2073 7065 6369   since the speci
+0000b2c0: 6669 630a 2020 2020 233a 2077 6f72 6b65  fic.    #: worke
+0000b2d0: 7273 206d 6179 206e 6f74 2062 6520 636f  rs may not be co
+0000b2e0: 6e6e 6563 7465 6420 6174 2074 6869 7320  nnected at this 
+0000b2f0: 7469 6d65 2e0a 2020 2020 776f 726b 6572  time..    worker
+0000b300: 5f72 6573 7472 6963 7469 6f6e 733a 2073  _restrictions: s
+0000b310: 6574 5b73 7472 5d0a 0a20 2020 2023 3a20  et[str]..    #: 
+0000b320: 5265 736f 7572 6365 7320 7265 7175 6972  Resources requir
+0000b330: 6564 2062 7920 7468 6973 2074 6173 6b2c  ed by this task,
+0000b340: 2073 7563 6820 6173 2060 607b 2767 7075   such as ``{'gpu
+0000b350: 273a 2031 7d60 6020 6f72 2060 607b 276d  ': 1}`` or ``{'m
+0000b360: 656d 6f72 7927 3a20 3165 397d 6060 0a20  emory': 1e9}``. 
+0000b370: 2020 2023 3a20 5468 6573 6520 6172 6520     #: These are 
+0000b380: 7573 6572 2d64 6566 696e 6564 206e 616d  user-defined nam
+0000b390: 6573 2061 6e64 2061 7265 206d 6174 6368  es and are match
+0000b3a0: 6564 2061 6761 696e 7374 2074 6865 203a  ed against the :
+0000b3b0: 2063 6f6e 7465 6e74 7320 6f66 2065 6163   contents of eac
+0000b3c0: 680a 2020 2020 233a 203a 6174 7472 3a60  h.    #: :attr:`
+0000b3d0: 576f 726b 6572 5374 6174 652e 7265 736f  WorkerState.reso
+0000b3e0: 7572 6365 7360 2064 6963 7469 6f6e 6172  urces` dictionar
+0000b3f0: 792e 0a20 2020 2072 6573 6f75 7263 655f  y..    resource_
+0000b400: 7265 7374 7269 6374 696f 6e73 3a20 6469  restrictions: di
+0000b410: 6374 5b73 7472 2c20 666c 6f61 745d 0a0a  ct[str, float]..
+0000b420: 2020 2020 233a 2046 616c 7365 0a20 2020      #: False.   
+0000b430: 2023 3a20 2020 2020 4561 6368 206f 6620   #:     Each of 
+0000b440: 3a61 7474 723a 6068 6f73 745f 7265 7374  :attr:`host_rest
+0000b450: 7269 6374 696f 6e73 602c 203a 6174 7472  rictions`, :attr
+0000b460: 3a60 776f 726b 6572 5f72 6573 7472 6963  :`worker_restric
+0000b470: 7469 6f6e 7360 2061 6e64 0a20 2020 2023  tions` and.    #
+0000b480: 3a20 2020 2020 3a61 7474 723a 6072 6573  :     :attr:`res
+0000b490: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0000b4a0: 6e73 6020 6973 2061 2068 6172 6420 636f  ns` is a hard co
+0000b4b0: 6e73 7472 6169 6e74 3a20 6966 206e 6f20  nstraint: if no 
+0000b4c0: 776f 726b 6572 2069 7320 6176 6169 6c61  worker is availa
+0000b4d0: 626c 650a 2020 2020 233a 2020 2020 2073  ble.    #:     s
+0000b4e0: 6174 6973 6679 696e 6720 7468 6f73 6520  atisfying those 
+0000b4f0: 7265 7374 7269 6374 696f 6e73 2c20 7468  restrictions, th
+0000b500: 6520 7461 736b 2063 616e 6e6f 7420 676f  e task cannot go
+0000b510: 2069 6e74 6f20 7468 6520 2270 726f 6365   into the "proce
+0000b520: 7373 696e 6722 2073 7461 7465 0a20 2020  ssing" state.   
+0000b530: 2023 3a20 2020 2020 616e 6420 7769 6c6c   #:     and will
+0000b540: 2069 6e73 7465 6164 2067 6f20 696e 746f   instead go into
+0000b550: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
+0000b560: 2073 7461 7465 2e0a 2020 2020 233a 2054   state..    #: T
+0000b570: 7275 650a 2020 2020 233a 2020 2020 2054  rue.    #:     T
+0000b580: 6865 2061 626f 7665 2072 6573 7472 6963  he above restric
+0000b590: 7469 6f6e 7320 6172 6520 6d65 7265 2070  tions are mere p
+0000b5a0: 7265 6665 7265 6e63 6573 3a20 6966 206e  references: if n
+0000b5b0: 6f20 776f 726b 6572 2069 7320 6176 6169  o worker is avai
+0000b5c0: 6c61 626c 650a 2020 2020 233a 2020 2020  lable.    #:    
+0000b5d0: 2073 6174 6973 6679 696e 6720 7468 6f73   satisfying thos
+0000b5e0: 6520 7265 7374 7269 6374 696f 6e73 2c20  e restrictions, 
+0000b5f0: 7468 6520 7461 736b 2063 616e 2073 7469  the task can sti
+0000b600: 6c6c 2067 6f20 696e 746f 2074 6865 0a20  ll go into the. 
+0000b610: 2020 2023 3a20 2020 2020 2270 726f 6365     #:     "proce
+0000b620: 7373 696e 6722 2073 7461 7465 2061 6e64  ssing" state and
+0000b630: 2062 6520 7365 6e74 2066 6f72 2065 7865   be sent for exe
+0000b640: 6375 7469 6f6e 2074 6f20 616e 6f74 6865  cution to anothe
+0000b650: 7220 636f 6e6e 6563 7465 6420 776f 726b  r connected work
+0000b660: 6572 2e0a 2020 2020 6c6f 6f73 655f 7265  er..    loose_re
+0000b670: 7374 7269 6374 696f 6e73 3a20 626f 6f6c  strictions: bool
+0000b680: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
+0000b690: 2074 6869 7320 7461 736b 2069 7320 616e   this task is an
+0000b6a0: 2041 6374 6f72 0a20 2020 2061 6374 6f72   Actor.    actor
+0000b6b0: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
+0000b6c0: 6865 2067 726f 7570 206f 6620 7461 736b  he group of task
+0000b6d0: 7320 746f 2077 6869 6368 2074 6869 7320  s to which this 
+0000b6e0: 6f6e 6520 6265 6c6f 6e67 730a 2020 2020  one belongs.    
+0000b6f0: 6772 6f75 703a 2054 6173 6b47 726f 7570  group: TaskGroup
+0000b700: 0a0a 2020 2020 233a 2053 616d 6520 6173  ..    #: Same as
+0000b710: 206f 6620 6772 6f75 702e 6e61 6d65 0a20   of group.name. 
+0000b720: 2020 2067 726f 7570 5f6b 6579 3a20 7374     group_key: st
+0000b730: 720a 0a20 2020 2023 3a20 4d65 7461 6461  r..    #: Metada
+0000b740: 7461 2072 656c 6174 6564 2074 6f20 7461  ta related to ta
+0000b750: 736b 0a20 2020 206d 6574 6164 6174 613a  sk.    metadata:
+0000b760: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
+0000b770: 0a20 2020 2023 3a20 5461 736b 2061 6e6e  .    #: Task ann
+0000b780: 6f74 6174 696f 6e73 0a20 2020 2061 6e6e  otations.    ann
+0000b790: 6f74 6174 696f 6e73 3a20 6469 6374 5b73  otations: dict[s
+0000b7a0: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
+0000b7b0: 2054 6865 2075 6e69 7175 6520 6964 656e   The unique iden
+0000b7c0: 7469 6669 6572 206f 6620 6120 7370 6563  tifier of a spec
+0000b7d0: 6966 6963 2065 7865 6375 7469 6f6e 206f  ific execution o
+0000b7e0: 6620 6120 7461 736b 2e20 5468 6973 2069  f a task. This i
+0000b7f0: 6465 6e74 6966 6965 720a 2020 2020 233a  dentifier.    #:
+0000b800: 2069 7320 7573 6564 2074 6f20 7369 676e   is used to sign
+0000b810: 2061 2074 6173 6b20 7375 6368 2074 6861   a task such tha
+0000b820: 7420 7468 6520 6173 7369 676e 6564 2077  t the assigned w
+0000b830: 6f72 6b65 7220 6973 2065 7870 6563 7465  orker is expecte
+0000b840: 6420 746f 2072 6574 7572 6e0a 2020 2020  d to return.    
+0000b850: 233a 2074 6865 2073 616d 6520 6964 656e  #: the same iden
+0000b860: 7469 6669 6572 2069 6e20 7468 6520 7461  tifier in the ta
+0000b870: 736b 2d66 696e 6973 6865 6420 6d65 7373  sk-finished mess
+0000b880: 6167 652e 2054 6869 7320 6973 2075 7365  age. This is use
+0000b890: 6420 746f 2063 6f72 7265 6c61 7465 0a20  d to correlate. 
+0000b8a0: 2020 2023 3a20 7265 7370 6f6e 7365 732e     #: responses.
+0000b8b0: 0a20 2020 2023 3a20 4f6e 6c79 2074 6865  .    #: Only the
+0000b8c0: 206d 6f73 7420 7265 6365 6e74 6c79 2061   most recently a
+0000b8d0: 7373 6967 6e65 6420 776f 726b 6572 2069  ssigned worker i
+0000b8e0: 7320 7472 7573 7465 642e 2041 6c6c 206f  s trusted. All o
+0000b8f0: 7468 6572 2072 6573 756c 7473 2077 696c  ther results wil
+0000b900: 6c0a 2020 2020 233a 2062 6520 7265 6a65  l.    #: be reje
+0000b910: 6374 6564 2e0a 2020 2020 7275 6e5f 6964  cted..    run_id
+0000b920: 3a20 696e 7420 7c20 4e6f 6e65 0a0a 2020  : int | None..  
+0000b930: 2020 233a 2043 6163 6865 6420 6861 7368    #: Cached hash
+0000b940: 206f 6620 3a61 7474 723a 607e 5461 736b   of :attr:`~Task
+0000b950: 5374 6174 652e 636c 6965 6e74 5f6b 6579  State.client_key
+0000b960: 600a 2020 2020 5f68 6173 683a 2069 6e74  `.    _hash: int
+0000b970: 0a0a 2020 2020 2320 5375 7070 6f72 7420  ..    # Support 
+0000b980: 666f 7220 7765 616b 7265 6673 2074 6f20  for weakrefs to 
+0000b990: 6120 636c 6173 7320 7769 7468 205f 5f73  a class with __s
+0000b9a0: 6c6f 7473 5f5f 0a20 2020 205f 5f77 6561  lots__.    __wea
+0000b9b0: 6b72 6566 5f5f 3a20 416e 7920 3d20 4e6f  kref__: Any = No
+0000b9c0: 6e65 0a20 2020 205f 5f73 6c6f 7473 5f5f  ne.    __slots__
+0000b9d0: 203d 2074 7570 6c65 285f 5f61 6e6e 6f74   = tuple(__annot
+0000b9e0: 6174 696f 6e73 5f5f 290a 0a20 2020 2023  ations__)..    #
+0000b9f0: 3a20 476c 6f62 616c 2069 7465 7261 746f  : Global iterato
+0000ba00: 7220 7573 6564 2074 6f20 6372 6561 7465  r used to create
+0000ba10: 2075 6e69 7175 6520 7461 736b 2072 756e   unique task run
+0000ba20: 2049 4473 0a20 2020 205f 7275 6e5f 6964   IDs.    _run_id
+0000ba30: 5f69 7465 7261 746f 723a 2043 6c61 7373  _iterator: Class
+0000ba40: 5661 725b 6974 6572 746f 6f6c 732e 636f  Var[itertools.co
+0000ba50: 756e 745d 203d 2069 7465 7274 6f6f 6c73  unt] = itertools
+0000ba60: 2e63 6f75 6e74 2829 0a0a 2020 2020 2320  .count()..    # 
+0000ba70: 496e 7374 616e 6365 7320 6e6f 7420 7061  Instances not pa
+0000ba80: 7274 206f 6620 736c 6f74 7320 7369 6e63  rt of slots sinc
+0000ba90: 6520 636c 6173 7320 7661 7269 6162 6c65  e class variable
+0000baa0: 0a20 2020 205f 696e 7374 616e 6365 733a  .    _instances:
+0000bab0: 2043 6c61 7373 5661 725b 7765 616b 7265   ClassVar[weakre
+0000bac0: 662e 5765 616b 5365 745b 5461 736b 5374  f.WeakSet[TaskSt
+0000bad0: 6174 655d 5d20 3d20 7765 616b 7265 662e  ate]] = weakref.
+0000bae0: 5765 616b 5365 7428 290a 0a20 2020 2064  WeakSet()..    d
+0000baf0: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+0000bb00: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000bb10: 2020 206b 6579 3a20 7374 722c 0a20 2020     key: str,.   
+0000bb20: 2020 2020 2072 756e 5f73 7065 633a 206f       run_spec: o
+0000bb30: 626a 6563 742c 0a20 2020 2020 2020 2073  bject,.        s
+0000bb40: 7461 7465 3a20 5461 736b 5374 6174 6553  tate: TaskStateS
+0000bb50: 7461 7465 2c0a 2020 2020 293a 0a20 2020  tate,.    ):.   
+0000bb60: 2020 2020 2073 656c 662e 6b65 7920 3d20       self.key = 
+0000bb70: 6b65 790a 2020 2020 2020 2020 7365 6c66  key.        self
+0000bb80: 2e5f 6861 7368 203d 2068 6173 6828 6b65  ._hash = hash(ke
+0000bb90: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+0000bba0: 7275 6e5f 7370 6563 203d 2072 756e 5f73  run_spec = run_s
+0000bbb0: 7065 630a 2020 2020 2020 2020 7365 6c66  pec.        self
+0000bbc0: 2e5f 7374 6174 6520 3d20 7374 6174 650a  ._state = state.
+0000bbd0: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
+0000bbe0: 6570 7469 6f6e 203d 204e 6f6e 650a 2020  eption = None.  
+0000bbf0: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
+0000bc00: 7469 6f6e 5f62 6c61 6d65 203d 204e 6f6e  tion_blame = Non
+0000bc10: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+0000bc20: 7261 6365 6261 636b 203d 204e 6f6e 650a  raceback = None.
+0000bc30: 2020 2020 2020 2020 7365 6c66 2e65 7863          self.exc
+0000bc40: 6570 7469 6f6e 5f74 6578 7420 3d20 2222  eption_text = ""
+0000bc50: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0000bc60: 6163 6562 6163 6b5f 7465 7874 203d 2022  aceback_text = "
+0000bc70: 220a 2020 2020 2020 2020 7365 6c66 2e73  ".        self.s
+0000bc80: 7573 7069 6369 6f75 7320 3d20 300a 2020  uspicious = 0.  
+0000bc90: 2020 2020 2020 7365 6c66 2e72 6574 7269        self.retri
+0000bca0: 6573 203d 2030 0a20 2020 2020 2020 2073  es = 0.        s
+0000bcb0: 656c 662e 6e62 7974 6573 203d 202d 310a  elf.nbytes = -1.
+0000bcc0: 2020 2020 2020 2020 7365 6c66 2e70 7269          self.pri
+0000bcd0: 6f72 6974 7920 3d20 4e6f 6e65 0a20 2020  ority = None.   
+0000bce0: 2020 2020 2073 656c 662e 7768 6f5f 7761       self.who_wa
+0000bcf0: 6e74 7320 3d20 7365 7428 290a 2020 2020  nts = set().    
+0000bd00: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
+0000bd10: 6e63 6965 7320 3d20 7365 7428 290a 2020  ncies = set().  
+0000bd20: 2020 2020 2020 7365 6c66 2e64 6570 656e        self.depen
+0000bd30: 6465 6e74 7320 3d20 7365 7428 290a 2020  dents = set().  
+0000bd40: 2020 2020 2020 7365 6c66 2e77 6169 7469        self.waiti
+0000bd50: 6e67 5f6f 6e20 3d20 7365 7428 290a 2020  ng_on = set().  
+0000bd60: 2020 2020 2020 7365 6c66 2e77 6169 7465        self.waite
+0000bd70: 7273 203d 2073 6574 2829 0a20 2020 2020  rs = set().     
+0000bd80: 2020 2073 656c 662e 7768 6f5f 6861 7320     self.who_has 
+0000bd90: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+0000bda0: 7365 6c66 2e70 726f 6365 7373 696e 675f  self.processing_
+0000bdb0: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
+0000bdc0: 2020 7365 6c66 2e68 6173 5f6c 6f73 745f    self.has_lost_
+0000bdd0: 6465 7065 6e64 656e 6369 6573 203d 2046  dependencies = F
+0000bde0: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
+0000bdf0: 662e 686f 7374 5f72 6573 7472 6963 7469  f.host_restricti
+0000be00: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+0000be10: 2020 2020 7365 6c66 2e77 6f72 6b65 725f      self.worker_
+0000be20: 7265 7374 7269 6374 696f 6e73 203d 2073  restrictions = s
+0000be30: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0000be40: 662e 7265 736f 7572 6365 5f72 6573 7472  f.resource_restr
+0000be50: 6963 7469 6f6e 7320 3d20 7b7d 0a20 2020  ictions = {}.   
+0000be60: 2020 2020 2073 656c 662e 6c6f 6f73 655f       self.loose_
+0000be70: 7265 7374 7269 6374 696f 6e73 203d 2046  restrictions = F
+0000be80: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
+0000be90: 662e 6163 746f 7220 3d20 4661 6c73 650a  f.actor = False.
+0000bea0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+0000beb0: 6669 7820 3d20 4e6f 6e65 2020 2320 7479  fix = None  # ty
+0000bec0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+0000bed0: 2020 2073 656c 662e 7479 7065 203d 204e     self.type = N
+0000bee0: 6f6e 6520 2023 2074 7970 653a 2069 676e  one  # type: ign
+0000bef0: 6f72 650a 2020 2020 2020 2020 7365 6c66  ore.        self
+0000bf00: 2e67 726f 7570 5f6b 6579 203d 206b 6579  .group_key = key
+0000bf10: 5f73 706c 6974 5f67 726f 7570 286b 6579  _split_group(key
+0000bf20: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
+0000bf30: 726f 7570 203d 204e 6f6e 6520 2023 2074  roup = None  # t
+0000bf40: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+0000bf50: 2020 2020 7365 6c66 2e6d 6574 6164 6174      self.metadat
+0000bf60: 6120 3d20 7b7d 0a20 2020 2020 2020 2073  a = {}.        s
+0000bf70: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
+0000bf80: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+0000bf90: 662e 6572 7265 645f 6f6e 203d 2073 6574  f.erred_on = set
+0000bfa0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000bfb0: 7275 6e5f 6964 203d 204e 6f6e 650a 2020  run_id = None.  
+0000bfc0: 2020 2020 2020 5461 736b 5374 6174 652e        TaskState.
+0000bfd0: 5f69 6e73 7461 6e63 6573 2e61 6464 2873  _instances.add(s
+0000bfe0: 656c 6629 0a0a 2020 2020 6465 6620 5f5f  elf)..    def __
+0000bff0: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
+0000c000: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
+0000c010: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
+0000c020: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
+0000c030: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
+0000c040: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
+0000c050: 2020 2020 2072 6574 7572 6e20 6973 696e       return isin
+0000c060: 7374 616e 6365 286f 7468 6572 2c20 5461  stance(other, Ta
+0000c070: 736b 5374 6174 6529 2061 6e64 2073 656c  skState) and sel
+0000c080: 662e 6b65 7920 3d3d 206f 7468 6572 2e6b  f.key == other.k
+0000c090: 6579 0a0a 2020 2020 4070 726f 7065 7274  ey..    @propert
+0000c0a0: 790a 2020 2020 6465 6620 7374 6174 6528  y.    def state(
+0000c0b0: 7365 6c66 2920 2d3e 2054 6173 6b53 7461  self) -> TaskSta
+0000c0c0: 7465 5374 6174 653a 0a20 2020 2020 2020  teState:.       
+0000c0d0: 2022 2222 5468 6973 2074 6173 6b27 7320   """This task's 
+0000c0e0: 6375 7272 656e 7420 7374 6174 652e 2020  current state.  
+0000c0f0: 5661 6c69 6420 7374 6174 6573 2061 7265  Valid states are
+0000c100: 2060 6072 656c 6561 7365 6460 602c 2060   ``released``, `
+0000c110: 6077 6169 7469 6e67 6060 2c0a 2020 2020  `waiting``,.    
+0000c120: 2020 2020 6060 6e6f 2d77 6f72 6b65 7260      ``no-worker`
+0000c130: 602c 2060 6070 726f 6365 7373 696e 6760  `, ``processing`
+0000c140: 602c 2060 606d 656d 6f72 7960 602c 2060  `, ``memory``, `
+0000c150: 6065 7272 6564 6060 2061 6e64 2060 6066  `erred`` and ``f
+0000c160: 6f72 676f 7474 656e 6060 2e20 2049 6620  orgotten``.  If 
+0000c170: 6974 0a20 2020 2020 2020 2069 7320 6060  it.        is ``
+0000c180: 666f 7267 6f74 7465 6e60 602c 2074 6865  forgotten``, the
+0000c190: 2074 6173 6b20 6973 6e27 7420 7374 6f72   task isn't stor
+0000c1a0: 6564 2069 6e20 7468 6520 6060 7461 736b  ed in the ``task
+0000c1b0: 7360 6020 6469 6374 696f 6e61 7279 2061  s`` dictionary a
+0000c1c0: 6e79 6d6f 7265 2061 6e64 0a20 2020 2020  nymore and.     
+0000c1d0: 2020 2077 696c 6c20 7072 6f62 6162 6c79     will probably
+0000c1e0: 2064 6973 6170 7065 6172 2073 6f6f 6e20   disappear soon 
+0000c1f0: 6672 6f6d 206d 656d 6f72 792e 0a20 2020  from memory..   
+0000c200: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000c210: 2072 6574 7572 6e20 7365 6c66 2e5f 7374   return self._st
+0000c220: 6174 650a 0a20 2020 2040 7374 6174 652e  ate..    @state.
+0000c230: 7365 7474 6572 0a20 2020 2064 6566 2073  setter.    def s
+0000c240: 7461 7465 2873 656c 662c 2076 616c 7565  tate(self, value
+0000c250: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000c260: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0000c270: 2020 2073 656c 662e 6772 6f75 702e 7374     self.group.st
+0000c280: 6174 6573 5b73 656c 662e 5f73 7461 7465  ates[self._state
+0000c290: 5d20 2d3d 2031 0a20 2020 2020 2020 2073  ] -= 1.        s
+0000c2a0: 656c 662e 6772 6f75 702e 7374 6174 6573  elf.group.states
+0000c2b0: 5b76 616c 7565 5d20 2b3d 2031 0a20 2020  [value] += 1.   
+0000c2c0: 2020 2020 2073 656c 662e 5f73 7461 7465       self._state
+0000c2d0: 203d 2076 616c 7565 0a20 2020 2020 2020   = value.       
+0000c2e0: 2073 656c 662e 7072 6566 6978 2e73 7461   self.prefix.sta
+0000c2f0: 7465 5f63 6f75 6e74 735b 7661 6c75 655d  te_counts[value]
+0000c300: 202b 3d20 310a 0a20 2020 2064 6566 2061   += 1..    def a
+0000c310: 6464 5f64 6570 656e 6465 6e63 7928 7365  dd_dependency(se
+0000c320: 6c66 2c20 6f74 6865 723a 2054 6173 6b53  lf, other: TaskS
+0000c330: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+0000c340: 2020 2020 2020 2022 2222 4164 6420 616e         """Add an
+0000c350: 6f74 6865 7220 7461 736b 2061 7320 6120  other task as a 
+0000c360: 6465 7065 6e64 656e 6379 206f 6620 7468  dependency of th
+0000c370: 6973 2074 6173 6b22 2222 0a20 2020 2020  is task""".     
+0000c380: 2020 2073 656c 662e 6465 7065 6e64 656e     self.dependen
+0000c390: 6369 6573 2e61 6464 286f 7468 6572 290a  cies.add(other).
+0000c3a0: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+0000c3b0: 7570 2e64 6570 656e 6465 6e63 6965 732e  up.dependencies.
+0000c3c0: 6164 6428 6f74 6865 722e 6772 6f75 7029  add(other.group)
+0000c3d0: 0a20 2020 2020 2020 206f 7468 6572 2e64  .        other.d
+0000c3e0: 6570 656e 6465 6e74 732e 6164 6428 7365  ependents.add(se
+0000c3f0: 6c66 290a 0a20 2020 2064 6566 2067 6574  lf)..    def get
+0000c400: 5f6e 6279 7465 7328 7365 6c66 2920 2d3e  _nbytes(self) ->
+0000c410: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+0000c420: 7475 726e 2073 656c 662e 6e62 7974 6573  turn self.nbytes
+0000c430: 2069 6620 7365 6c66 2e6e 6279 7465 7320   if self.nbytes 
+0000c440: 3e3d 2030 2065 6c73 6520 4445 4641 554c  >= 0 else DEFAUL
+0000c450: 545f 4441 5441 5f53 495a 450a 0a20 2020  T_DATA_SIZE..   
+0000c460: 2064 6566 2073 6574 5f6e 6279 7465 7328   def set_nbytes(
+0000c470: 7365 6c66 2c20 6e62 7974 6573 3a20 696e  self, nbytes: in
+0000c480: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
+0000c490: 2020 2020 6469 6666 203d 206e 6279 7465      diff = nbyte
+0000c4a0: 730a 2020 2020 2020 2020 6f6c 645f 6e62  s.        old_nb
+0000c4b0: 7974 6573 203d 2073 656c 662e 6e62 7974  ytes = self.nbyt
+0000c4c0: 6573 0a20 2020 2020 2020 2069 6620 6f6c  es.        if ol
+0000c4d0: 645f 6e62 7974 6573 203e 3d20 303a 0a20  d_nbytes >= 0:. 
+0000c4e0: 2020 2020 2020 2020 2020 2064 6966 6620             diff 
+0000c4f0: 2d3d 206f 6c64 5f6e 6279 7465 730a 2020  -= old_nbytes.  
+0000c500: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
+0000c510: 2e6e 6279 7465 735f 746f 7461 6c20 2b3d  .nbytes_total +=
+0000c520: 2064 6966 660a 2020 2020 2020 2020 666f   diff.        fo
+0000c530: 7220 7773 2069 6e20 7365 6c66 2e77 686f  r ws in self.who
+0000c540: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+0000c550: 2020 7773 2e6e 6279 7465 7320 2b3d 2064    ws.nbytes += d
+0000c560: 6966 660a 2020 2020 2020 2020 7365 6c66  iff.        self
+0000c570: 2e6e 6279 7465 7320 3d20 6e62 7974 6573  .nbytes = nbytes
+0000c580: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
+0000c590: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
+0000c5a0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c5b0: 6622 3c54 6173 6b53 7461 7465 207b 7365  f"<TaskState {se
+0000c5c0: 6c66 2e6b 6579 2172 7d20 7b73 656c 662e  lf.key!r} {self.
+0000c5d0: 5f73 7461 7465 7d3e 220a 0a20 2020 2064  _state}>"..    d
+0000c5e0: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
+0000c5f0: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+0000c600: 2020 2020 2072 6574 7572 6e20 6765 745f       return get_
+0000c610: 7465 6d70 6c61 7465 2822 7461 736b 5f73  template("task_s
+0000c620: 7461 7465 2e68 746d 6c2e 6a32 2229 2e72  tate.html.j2").r
+0000c630: 656e 6465 7228 0a20 2020 2020 2020 2020  ender(.         
+0000c640: 2020 2073 7461 7465 3d73 656c 662e 7374     state=self.st
+0000c650: 6174 652c 0a20 2020 2020 2020 2020 2020  ate,.           
+0000c660: 206e 6279 7465 733d 7365 6c66 2e6e 6279   nbytes=self.nby
+0000c670: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+0000c680: 206b 6579 3d73 656c 662e 6b65 792c 0a20   key=self.key,. 
+0000c690: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
+0000c6a0: 6620 7661 6c69 6461 7465 2873 656c 6629  f validate(self)
+0000c6b0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000c6c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000c6d0: 2020 2066 6f72 2063 7320 696e 2073 656c     for cs in sel
+0000c6e0: 662e 7768 6f5f 7761 6e74 733a 0a20 2020  f.who_wants:.   
+0000c6f0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c700: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
+0000c710: 732c 2043 6c69 656e 7453 7461 7465 292c  s, ClientState),
+0000c720: 2028 7265 7072 2863 7329 2c20 7365 6c66   (repr(cs), self
+0000c730: 2e77 686f 5f77 616e 7473 290a 2020 2020  .who_wants).    
+0000c740: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+0000c750: 6e20 7365 6c66 2e77 686f 5f68 6173 3a0a  n self.who_has:.
+0000c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c770: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0000c780: 6528 7773 2c20 576f 726b 6572 5374 6174  e(ws, WorkerStat
+0000c790: 6529 2c20 2872 6570 7228 7773 292c 2073  e), (repr(ws), s
+0000c7a0: 656c 662e 7768 6f5f 6861 7329 0a20 2020  elf.who_has).   
+0000c7b0: 2020 2020 2020 2020 2066 6f72 2074 7320           for ts 
+0000c7c0: 696e 2073 656c 662e 6465 7065 6e64 656e  in self.dependen
+0000c7d0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+0000c7e0: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0000c7f0: 6e73 7461 6e63 6528 7473 2c20 5461 736b  nstance(ts, Task
+0000c800: 5374 6174 6529 2c20 2872 6570 7228 7473  State), (repr(ts
+0000c810: 292c 2073 656c 662e 6465 7065 6e64 656e  ), self.dependen
+0000c820: 6369 6573 290a 2020 2020 2020 2020 2020  cies).          
+0000c830: 2020 666f 7220 7473 2069 6e20 7365 6c66    for ts in self
+0000c840: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+0000c850: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0000c860: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
+0000c870: 732c 2054 6173 6b53 7461 7465 292c 2028  s, TaskState), (
+0000c880: 7265 7072 2874 7329 2c20 7365 6c66 2e64  repr(ts), self.d
+0000c890: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
+0000c8a0: 2020 2020 2020 2076 616c 6964 6174 655f         validate_
+0000c8b0: 7461 736b 5f73 7461 7465 2873 656c 6629  task_state(self)
+0000c8c0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+0000c8d0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+0000c8e0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0000c8f0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+0000c900: 2020 2020 2020 2020 2020 2020 6966 204c              if L
+0000c910: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
+0000c920: 2020 2020 2020 2020 696d 706f 7274 2070          import p
+0000c930: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
+0000c940: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
+0000c950: 6528 290a 0a20 2020 2064 6566 2067 6574  e()..    def get
+0000c960: 5f6e 6279 7465 735f 6465 7073 2873 656c  _nbytes_deps(sel
+0000c970: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+0000c980: 2020 2072 6574 7572 6e20 7375 6d28 7473     return sum(ts
+0000c990: 2e67 6574 5f6e 6279 7465 7328 2920 666f  .get_nbytes() fo
+0000c9a0: 7220 7473 2069 6e20 7365 6c66 2e64 6570  r ts in self.dep
+0000c9b0: 656e 6465 6e63 6965 7329 0a0a 2020 2020  endencies)..    
+0000c9c0: 6465 6620 5f74 6f5f 6469 6374 5f6e 6f5f  def _to_dict_no_
+0000c9d0: 6e65 7374 2873 656c 662c 202a 2c20 6578  nest(self, *, ex
+0000c9e0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
+0000c9f0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
+0000ca00: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0000ca10: 2020 2020 2020 2022 2222 4469 6374 696f         """Dictio
+0000ca20: 6e61 7279 2072 6570 7265 7365 6e74 6174  nary representat
+0000ca30: 696f 6e20 666f 7220 6465 6275 6767 696e  ion for debuggin
+0000ca40: 6720 7075 7270 6f73 6573 2e0a 2020 2020  g purposes..    
+0000ca50: 2020 2020 4e6f 7420 7479 7065 2073 7461      Not type sta
+0000ca60: 626c 6520 616e 6420 6e6f 7420 696e 7465  ble and not inte
+0000ca70: 6e64 6564 2066 6f72 2072 6f75 6e64 7472  nded for roundtr
+0000ca80: 6970 732e 0a0a 2020 2020 2020 2020 5365  ips...        Se
+0000ca90: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+0000caa0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0000cab0: 436c 6965 6e74 2e64 756d 705f 636c 7573  Client.dump_clus
+0000cac0: 7465 725f 7374 6174 650a 2020 2020 2020  ter_state.      
+0000cad0: 2020 6469 7374 7269 6275 7465 642e 7574    distributed.ut
+0000cae0: 696c 732e 7265 6375 7273 6976 655f 746f  ils.recursive_to
+0000caf0: 5f64 6963 740a 0a20 2020 2020 2020 204e  _dict..        N
+0000cb00: 6f74 6573 0a20 2020 2020 2020 202d 2d2d  otes.        ---
+0000cb10: 2d2d 0a20 2020 2020 2020 2054 6869 7320  --.        This 
+0000cb20: 636c 6173 7320 7573 6573 2060 605f 746f  class uses ``_to
+0000cb30: 5f64 6963 745f 6e6f 5f6e 6573 7460 6020  _dict_no_nest`` 
+0000cb40: 696e 7374 6561 6420 6f66 2060 605f 746f  instead of ``_to
+0000cb50: 5f64 6963 7460 602e 0a20 2020 2020 2020  _dict``..       
+0000cb60: 2057 6865 6e20 6120 7461 736b 2072 6566   When a task ref
+0000cb70: 6572 656e 6365 7320 616e 6f74 6865 7220  erences another 
+0000cb80: 7461 736b 2c20 6f72 2077 6865 6e20 6120  task, or when a 
+0000cb90: 576f 726b 6572 5374 6174 652e 7461 736b  WorkerState.task
+0000cba0: 7320 636f 6e74 6169 6e73 2074 6173 6b73  s contains tasks
+0000cbb0: 2c0a 2020 2020 2020 2020 7468 6973 206d  ,.        this m
+0000cbc0: 6574 686f 6420 6973 206e 6f74 2065 7865  ethod is not exe
+0000cbd0: 6375 7465 6420 666f 7220 7468 6520 696e  cuted for the in
+0000cbe0: 6e65 7220 7461 736b 2c20 6576 656e 2069  ner task, even i
+0000cbf0: 6620 7468 6520 696e 6e65 7220 7461 736b  f the inner task
+0000cc00: 2077 6173 206e 6576 6572 0a20 2020 2020   was never.     
+0000cc10: 2020 2073 6565 6e20 6265 666f 7265 3b20     seen before; 
+0000cc20: 796f 7520 6765 7420 6120 7265 7072 2069  you get a repr i
+0000cc30: 6e73 7465 6164 2e20 416c 6c20 7461 736b  nstead. All task
+0000cc40: 7320 7368 6f75 6c64 206e 6561 746c 7920  s should neatly 
+0000cc50: 6170 7065 6172 2075 6e64 6572 0a20 2020  appear under.   
+0000cc60: 2020 2020 2053 6368 6564 756c 6572 2e74       Scheduler.t
+0000cc70: 6173 6b73 2e20 5468 6973 2061 6c73 6f20  asks. This also 
+0000cc80: 7072 6576 656e 7473 2061 2052 6563 7572  prevents a Recur
+0000cc90: 7369 6f6e 4572 726f 7220 6475 7269 6e67  sionError during
+0000cca0: 2070 6172 7469 6375 6c61 726c 7920 6865   particularly he
+0000ccb0: 6176 790a 2020 2020 2020 2020 6c6f 6164  avy.        load
+0000ccc0: 732c 2077 6869 6368 2068 6176 6520 6265  s, which have be
+0000ccd0: 656e 206f 6273 6572 7665 6420 746f 2068  en observed to h
+0000cce0: 6170 7065 6e20 7768 656e 6576 6572 2074  appen whenever t
+0000ccf0: 6865 7265 2773 2061 6e20 6163 7963 6c69  here's an acycli
+0000cd00: 6320 6465 7065 6e64 656e 6379 0a20 2020  c dependency.   
+0000cd10: 2020 2020 2063 6861 696e 206f 6620 7e32       chain of ~2
+0000cd20: 3030 2b20 7461 736b 732e 0a20 2020 2020  00+ tasks..     
+0000cd30: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000cd40: 6574 7572 6e20 7265 6375 7273 6976 655f  eturn recursive_
+0000cd50: 746f 5f64 6963 7428 7365 6c66 2c20 6578  to_dict(self, ex
+0000cd60: 636c 7564 653d 6578 636c 7564 652c 206d  clude=exclude, m
+0000cd70: 656d 6265 7273 3d54 7275 6529 0a0a 0a63  embers=True)...c
+0000cd80: 6c61 7373 2054 7261 6e73 6974 696f 6e28  lass Transition(
+0000cd90: 4e61 6d65 6454 7570 6c65 293a 0a20 2020  NamedTuple):.   
+0000cda0: 2022 2222 416e 2065 6e74 7279 2069 6e20   """An entry in 
+0000cdb0: 3a61 7474 723a 6053 6368 6564 756c 6572  :attr:`Scheduler
+0000cdc0: 5374 6174 652e 7472 616e 7369 7469 6f6e  State.transition
+0000cdd0: 5f6c 6f67 6022 2222 0a0a 2020 2020 6b65  _log`"""..    ke
+0000cde0: 793a 2073 7472 0a20 2020 2073 7461 7274  y: str.    start
+0000cdf0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000ce00: 0a20 2020 2066 696e 6973 683a 2054 6173  .    finish: Tas
+0000ce10: 6b53 7461 7465 5374 6174 650a 2020 2020  kStateState.    
+0000ce20: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+0000ce30: 2052 6563 730a 2020 2020 7374 696d 756c   Recs.    stimul
+0000ce40: 7573 5f69 643a 2073 7472 0a20 2020 2074  us_id: str.    t
+0000ce50: 696d 6573 7461 6d70 3a20 666c 6f61 740a  imestamp: float.
+0000ce60: 0a0a 636c 6173 7320 5363 6865 6475 6c65  ..class Schedule
+0000ce70: 7253 7461 7465 3a0a 2020 2020 2222 2255  rState:.    """U
+0000ce80: 6e64 6572 6c79 696e 6720 7461 736b 2073  nderlying task s
+0000ce90: 7461 7465 206f 6620 6479 6e61 6d69 6320  tate of dynamic 
+0000cea0: 7363 6865 6475 6c65 720a 0a20 2020 2054  scheduler..    T
+0000ceb0: 7261 636b 7320 7468 6520 6375 7272 656e  racks the curren
+0000cec0: 7420 7374 6174 6520 6f66 2077 6f72 6b65  t state of worke
+0000ced0: 7273 2c20 6461 7461 2c20 616e 6420 636f  rs, data, and co
+0000cee0: 6d70 7574 6174 696f 6e73 2e0a 0a20 2020  mputations...   
+0000cef0: 2048 616e 646c 6573 2074 7261 6e73 6974   Handles transit
+0000cf00: 696f 6e73 2062 6574 7765 656e 2064 6966  ions between dif
+0000cf10: 6665 7265 6e74 2074 6173 6b20 7374 6174  ferent task stat
+0000cf20: 6573 2e20 4e6f 7469 6669 6573 2074 6865  es. Notifies the
+0000cf30: 0a20 2020 2053 6368 6564 756c 6572 206f  .    Scheduler o
+0000cf40: 6620 6368 616e 6765 7320 6279 206d 6573  f changes by mes
+0000cf50: 7361 6769 6e67 2070 6173 7369 6e67 2074  saging passing t
+0000cf60: 6872 6f75 6768 2051 7565 7565 732c 2077  hrough Queues, w
+0000cf70: 6869 6368 2074 6865 0a20 2020 2053 6368  hich the.    Sch
+0000cf80: 6564 756c 6572 206c 6973 7465 6e73 2074  eduler listens t
+0000cf90: 6f20 7265 7370 6f6e 6473 2061 6363 6f72  o responds accor
+0000cfa0: 6469 6e67 6c79 2e0a 0a20 2020 2041 6c6c  dingly...    All
+0000cfb0: 2065 7665 6e74 7320 6172 6520 6861 6e64   events are hand
+0000cfc0: 6c65 6420 7175 6963 6b6c 792c 2069 6e20  led quickly, in 
+0000cfd0: 6c69 6e65 6172 2074 696d 6520 7769 7468  linear time with
+0000cfe0: 2072 6573 7065 6374 2074 6f20 7468 6569   respect to thei
+0000cff0: 720a 2020 2020 696e 7075 7420 2877 6869  r.    input (whi
+0000d000: 6368 2069 7320 6f66 7465 6e20 6f66 2063  ch is often of c
+0000d010: 6f6e 7374 616e 7420 7369 7a65 2920 616e  onstant size) an
+0000d020: 6420 6765 6e65 7261 6c6c 7920 7769 7468  d generally with
+0000d030: 696e 2061 0a20 2020 206d 696c 6c69 7365  in a.    millise
+0000d040: 636f 6e64 2e0a 0a20 2020 2055 7365 7273  cond...    Users
+0000d050: 2074 7970 6963 616c 6c79 2064 6f20 6e6f   typically do no
+0000d060: 7420 696e 7465 7261 6374 2077 6974 6820  t interact with 
+0000d070: 6060 5472 616e 7369 7469 6f6e 7360 6020  ``Transitions`` 
+0000d080: 6469 7265 6374 6c79 2e20 496e 7374 6561  directly. Instea
+0000d090: 640a 2020 2020 7573 6572 7320 696e 7465  d.    users inte
+0000d0a0: 7261 6374 2077 6974 6820 7468 6520 6060  ract with the ``
+0000d0b0: 436c 6965 6e74 6060 2c20 7768 6963 6820  Client``, which 
+0000d0c0: 696e 2074 7572 6e20 656e 6761 6765 7320  in turn engages 
+0000d0d0: 7468 650a 2020 2020 6060 5363 6865 6475  the.    ``Schedu
+0000d0e0: 6c65 7260 6020 6166 6665 6374 696e 6720  ler`` affecting 
+0000d0f0: 6469 6666 6572 656e 7420 7472 616e 7369  different transi
+0000d100: 7469 6f6e 7320 6865 7265 2075 6e64 6572  tions here under
+0000d110: 2d74 6865 2d68 6f6f 642e 2049 6e0a 2020  -the-hood. In.  
+0000d120: 2020 7468 6520 6261 636b 6772 6f75 6e64    the background
+0000d130: 2060 6057 6f72 6b65 7260 6073 2061 6c73   ``Worker``s als
+0000d140: 6f20 656e 6761 6765 2077 6974 6820 7468  o engage with th
+0000d150: 6520 6060 5363 6865 6475 6c65 7260 600a  e ``Scheduler``.
+0000d160: 2020 2020 6166 6665 6374 696e 6720 7468      affecting th
+0000d170: 6573 6520 7374 6174 6520 7472 616e 7369  ese state transi
+0000d180: 7469 6f6e 7320 6173 2077 656c 6c2e 0a20  tions as well.. 
+0000d190: 2020 2022 2222 0a0a 2020 2020 6261 6e64     """..    band
+0000d1a0: 7769 6474 683a 2069 6e74 0a0a 2020 2020  width: int..    
+0000d1b0: 233a 2043 6c69 656e 7473 2063 7572 7265  #: Clients curre
+0000d1c0: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
+0000d1d0: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
+0000d1e0: 2020 2020 636c 6965 6e74 733a 2064 6963      clients: dic
+0000d1f0: 745b 7374 722c 2043 6c69 656e 7453 7461  t[str, ClientSta
+0000d200: 7465 5d0a 0a20 2020 2065 7874 656e 7369  te]..    extensi
+0000d210: 6f6e 733a 2064 6963 745b 7374 722c 2041  ons: dict[str, A
+0000d220: 6e79 5d20 2023 2054 4f44 4f20 7772 6974  ny]  # TODO writ
+0000d230: 6520 6120 7363 6865 6475 6c65 7220 6578  e a scheduler ex
+0000d240: 7465 6e73 696f 6e20 5072 6f74 6f63 6f6c  tension Protocol
+0000d250: 0a20 2020 2070 6c75 6769 6e73 3a20 6469  .    plugins: di
+0000d260: 6374 5b73 7472 2c20 5363 6865 6475 6c65  ct[str, Schedule
+0000d270: 7250 6c75 6769 6e5d 0a20 2020 2068 6f73  rPlugin].    hos
+0000d280: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
+0000d290: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
+0000d2a0: 5d0a 0a20 2020 2023 3a20 4966 2054 7275  ]..    #: If Tru
+0000d2b0: 652c 2065 6e61 626c 6520 6578 7065 6e73  e, enable expens
+0000d2c0: 6976 6520 696e 7465 726e 616c 2063 6f6e  ive internal con
+0000d2d0: 7369 7374 656e 6379 2063 6865 636b 2e0a  sistency check..
+0000d2e0: 2020 2020 233a 2054 7970 6963 616c 6c79      #: Typically
+0000d2f0: 2064 6973 6162 6c65 6420 696e 2070 726f   disabled in pro
+0000d300: 6475 6374 696f 6e2e 0a20 2020 2076 616c  duction..    val
+0000d310: 6964 6174 653a 2062 6f6f 6c0a 0a20 2020  idate: bool..   
+0000d320: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+0000d330: 2323 2323 2323 2323 0a20 2020 2023 2057  ########.    # W
+0000d340: 6f72 6b65 7273 2d72 656c 6174 6564 2073  orkers-related s
+0000d350: 7461 7465 0a20 2020 2023 2323 2323 2323  tate.    #######
 0000d360: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d370: 2323 2323 2323 0a0a 2020 2020 233a 2057  ######..    #: W
-0000d380: 6f72 6b65 7273 2063 7572 7265 6e74 6c79  orkers currently
-0000d390: 2063 6f6e 6e65 6374 6564 2074 6f20 7468   connected to th
-0000d3a0: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
-0000d3b0: 233a 2028 6163 7475 616c 6c79 2061 2053  #: (actually a S
-0000d3c0: 6f72 7465 6444 6963 742c 2062 7574 2074  ortedDict, but t
-0000d3d0: 6865 2073 6f72 7465 6463 6f6e 7461 696e  he sortedcontain
-0000d3e0: 6572 7320 7061 636b 6167 6520 6973 6e27  ers package isn'
-0000d3f0: 7420 616e 6e6f 7461 7465 6429 0a20 2020  t annotated).   
-0000d400: 2077 6f72 6b65 7273 3a20 6469 6374 5b73   workers: dict[s
-0000d410: 7472 2c20 576f 726b 6572 5374 6174 655d  tr, WorkerState]
-0000d420: 0a20 2020 2023 3a20 576f 726b 6572 207b  .    #: Worker {
-0000d430: 6e61 6d65 3a20 6164 6472 6573 737d 0a20  name: address}. 
-0000d440: 2020 2061 6c69 6173 6573 3a20 6469 6374     aliases: dict
-0000d450: 5b48 6173 6861 626c 652c 2073 7472 5d0a  [Hashable, str].
-0000d460: 2020 2020 233a 2057 6f72 6b65 7273 2074      #: Workers t
-0000d470: 6861 7420 6172 6520 6375 7272 656e 746c  hat are currentl
-0000d480: 7920 696e 2072 756e 6e69 6e67 2073 7461  y in running sta
-0000d490: 7465 0a20 2020 2072 756e 6e69 6e67 3a20  te.    running: 
-0000d4a0: 7365 745b 576f 726b 6572 5374 6174 655d  set[WorkerState]
-0000d4b0: 0a20 2020 2023 3a20 576f 726b 6572 7320  .    #: Workers 
-0000d4c0: 7468 6174 2061 7265 2063 7572 7265 6e74  that are current
-0000d4d0: 6c79 2069 6e20 7275 6e6e 696e 6720 7374  ly in running st
-0000d4e0: 6174 6520 616e 6420 6e6f 7420 6675 6c6c  ate and not full
-0000d4f0: 7920 7574 696c 697a 6564 0a20 2020 2023  y utilized.    #
-0000d500: 3a20 4465 6669 6e69 7469 6f6e 2062 6173  : Definition bas
-0000d510: 6564 206f 6e20 6f63 6375 7061 6e63 790a  ed on occupancy.
-0000d520: 2020 2020 233a 2028 6163 7475 616c 6c79      #: (actually
-0000d530: 2061 2053 6f72 7465 6444 6963 742c 2062   a SortedDict, b
-0000d540: 7574 2074 6865 2073 6f72 7465 6463 6f6e  ut the sortedcon
-0000d550: 7461 696e 6572 7320 7061 636b 6167 6520  tainers package 
-0000d560: 6973 6e27 7420 616e 6e6f 7461 7465 6429  isn't annotated)
-0000d570: 2e0a 2020 2020 233a 204e 6f74 2074 6f20  ..    #: Not to 
-0000d580: 6265 2063 6f6e 6675 7365 6420 7769 7468  be confused with
-0000d590: 203a 6d65 7468 3a60 6973 5f69 646c 6560   :meth:`is_idle`
-0000d5a0: 2e0a 2020 2020 6964 6c65 3a20 6469 6374  ..    idle: dict
-0000d5b0: 5b73 7472 2c20 576f 726b 6572 5374 6174  [str, WorkerStat
-0000d5c0: 655d 0a20 2020 2023 3a20 5369 6d69 6c61  e].    #: Simila
-0000d5d0: 7220 746f 2060 6964 6c65 600a 2020 2020  r to `idle`.    
-0000d5e0: 233a 2044 6566 696e 6974 696f 6e20 6261  #: Definition ba
-0000d5f0: 7365 6420 6f6e 2061 7373 6967 6e65 6420  sed on assigned 
-0000d600: 7461 736b 730a 2020 2020 6964 6c65 5f74  tasks.    idle_t
-0000d610: 6173 6b5f 636f 756e 743a 2073 6574 5b57  ask_count: set[W
-0000d620: 6f72 6b65 7253 7461 7465 5d0a 2020 2020  orkerState].    
-0000d630: 233a 2057 6f72 6b65 7273 2074 6861 7420  #: Workers that 
-0000d640: 6172 6520 6675 6c6c 7920 7574 696c 697a  are fully utiliz
-0000d650: 6564 2e20 4d61 7920 696e 636c 7564 6520  ed. May include 
-0000d660: 6e6f 6e2d 7275 6e6e 696e 6720 776f 726b  non-running work
-0000d670: 6572 732e 0a20 2020 2073 6174 7572 6174  ers..    saturat
-0000d680: 6564 3a20 7365 745b 576f 726b 6572 5374  ed: set[WorkerSt
-0000d690: 6174 655d 0a20 2020 2023 3a20 4375 7272  ate].    #: Curr
-0000d6a0: 656e 7420 6e75 6d62 6572 206f 6620 7468  ent number of th
-0000d6b0: 7265 6164 7320 6163 726f 7373 2061 6c6c  reads across all
-0000d6c0: 2077 6f72 6b65 7273 0a20 2020 2074 6f74   workers.    tot
-0000d6d0: 616c 5f6e 7468 7265 6164 733a 2069 6e74  al_nthreads: int
-0000d6e0: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
-0000d6f0: 6f66 206e 756d 6265 7220 6f66 2074 6872  of number of thr
-0000d700: 6561 6473 0a20 2020 2023 3a20 2874 696d  eads.    #: (tim
-0000d710: 6573 7461 6d70 2c20 6e65 7720 6e75 6d62  estamp, new numb
-0000d720: 6572 206f 6620 7468 7265 6164 7329 0a20  er of threads). 
-0000d730: 2020 2074 6f74 616c 5f6e 7468 7265 6164     total_nthread
-0000d740: 735f 6869 7374 6f72 793a 206c 6973 745b  s_history: list[
-0000d750: 7475 706c 655b 666c 6f61 742c 2069 6e74  tuple[float, int
-0000d760: 5d5d 0a20 2020 2023 3a20 436c 7573 7465  ]].    #: Cluste
-0000d770: 722d 7769 6465 2072 6573 6f75 7263 6573  r-wide resources
-0000d780: 2e20 7b72 6573 6f75 7263 6520 6e61 6d65  . {resource name
-0000d790: 3a20 7b77 6f72 6b65 7220 6164 6472 6573  : {worker addres
-0000d7a0: 733a 2061 6d6f 756e 747d 7d0a 2020 2020  s: amount}}.    
-0000d7b0: 7265 736f 7572 6365 733a 2064 6963 745b  resources: dict[
-0000d7c0: 7374 722c 2064 6963 745b 7374 722c 2066  str, dict[str, f
-0000d7d0: 6c6f 6174 5d5d 0a0a 2020 2020 2323 2323  loat]]..    ####
-0000d7e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d7f0: 230a 2020 2020 2320 5461 736b 732d 7265  #.    # Tasks-re
-0000d800: 6c61 7465 6420 7374 6174 650a 2020 2020  lated state.    
-0000d810: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d820: 2323 2323 230a 0a20 2020 2023 3a20 546f  #####..    #: To
-0000d830: 7461 6c20 6e75 6d62 6572 206f 6620 7461  tal number of ta
-0000d840: 736b 7320 6576 6572 2070 726f 6365 7373  sks ever process
-0000d850: 6564 0a20 2020 206e 5f74 6173 6b73 3a20  ed.    n_tasks: 
-0000d860: 696e 740a 0a20 2020 2023 3a20 416c 6c20  int..    #: All 
-0000d870: 7461 736b 7320 6375 7272 656e 746c 7920  tasks currently 
-0000d880: 6b6e 6f77 6e20 746f 2074 6865 2073 6368  known to the sch
-0000d890: 6564 756c 6572 0a20 2020 2074 6173 6b73  eduler.    tasks
-0000d8a0: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
-0000d8b0: 5374 6174 655d 0a0a 2020 2020 233a 2054  State]..    #: T
-0000d8c0: 6173 6b73 2069 6e20 7468 6520 2271 7565  asks in the "que
-0000d8d0: 7565 6422 2073 7461 7465 2c20 6f72 6465  ued" state, orde
-0000d8e0: 7265 6420 6279 2070 7269 6f72 6974 790a  red by priority.
-0000d8f0: 2020 2020 7175 6575 6564 3a20 4865 6170      queued: Heap
-0000d900: 5365 745b 5461 736b 5374 6174 655d 0a0a  Set[TaskState]..
-0000d910: 2020 2020 233a 2054 6173 6b73 2069 6e20      #: Tasks in 
-0000d920: 7468 6520 226e 6f2d 776f 726b 6572 2220  the "no-worker" 
-0000d930: 7374 6174 650a 2020 2020 756e 7275 6e6e  state.    unrunn
-0000d940: 6162 6c65 3a20 7365 745b 5461 736b 5374  able: set[TaskSt
-0000d950: 6174 655d 0a0a 2020 2020 233a 2053 7562  ate]..    #: Sub
-0000d960: 7365 7420 6f66 2074 6173 6b73 2074 6861  set of tasks tha
-0000d970: 7420 6578 6973 7420 696e 206d 656d 6f72  t exist in memor
-0000d980: 7920 6f6e 206d 6f72 6520 7468 616e 206f  y on more than o
-0000d990: 6e65 2077 6f72 6b65 720a 2020 2020 7265  ne worker.    re
-0000d9a0: 706c 6963 6174 6564 5f74 6173 6b73 3a20  plicated_tasks: 
-0000d9b0: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
-0000d9c0: 2020 2020 756e 6b6e 6f77 6e5f 6475 7261      unknown_dura
-0000d9d0: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
-0000d9e0: 2073 6574 5b54 6173 6b53 7461 7465 5d5d   set[TaskState]]
-0000d9f0: 0a20 2020 2074 6173 6b5f 6772 6f75 7073  .    task_groups
-0000da00: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
-0000da10: 4772 6f75 705d 0a20 2020 2074 6173 6b5f  Group].    task_
-0000da20: 7072 6566 6978 6573 3a20 6469 6374 5b73  prefixes: dict[s
-0000da30: 7472 2c20 5461 736b 5072 6566 6978 5d0a  tr, TaskPrefix].
-0000da40: 2020 2020 7461 736b 5f6d 6574 6164 6174      task_metadat
-0000da50: 613a 2064 6963 745b 7374 722c 2041 6e79  a: dict[str, Any
-0000da60: 5d0a 0a20 2020 2023 2323 2323 2323 2323  ]..    #########
-0000da70: 0a20 2020 2023 2048 6973 746f 7279 0a20  .    # History. 
-0000da80: 2020 2023 2323 2323 2323 2323 0a0a 2020     #########..  
-0000da90: 2020 233a 2048 6973 746f 7279 206f 6620    #: History of 
-0000daa0: 636f 6d70 7574 6174 696f 6e73 2e0a 2020  computations..  
-0000dab0: 2020 233a 2054 6865 206c 656e 6774 6820    #: The length 
-0000dac0: 6361 6e20 6265 2074 7765 616b 6564 2074  can be tweaked t
-0000dad0: 6872 6f75 6768 0a20 2020 2023 3a20 6469  hrough.    #: di
-0000dae0: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
-0000daf0: 7374 6963 732e 636f 6d70 7574 6174 696f  stics.computatio
-0000db00: 6e73 2e6d 6178 2d68 6973 746f 7279 0a20  ns.max-history. 
-0000db10: 2020 2063 6f6d 7075 7461 7469 6f6e 733a     computations:
-0000db20: 2064 6571 7565 5b43 6f6d 7075 7461 7469   deque[Computati
-0000db30: 6f6e 5d0a 0a20 2020 2023 3a20 4869 7374  on]..    #: Hist
-0000db40: 6f72 7920 6f66 2065 7272 6564 2074 6173  ory of erred tas
-0000db50: 6b73 2e0a 2020 2020 233a 2054 6865 206c  ks..    #: The l
-0000db60: 656e 6774 6820 6361 6e20 6265 2074 7765  ength can be twe
-0000db70: 616b 6564 2074 6872 6f75 6768 0a20 2020  aked through.   
-0000db80: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
-0000db90: 6469 6167 6e6f 7374 6963 732e 6572 7265  diagnostics.erre
-0000dba0: 642d 7461 736b 732e 6d61 782d 6869 7374  d-tasks.max-hist
-0000dbb0: 6f72 790a 2020 2020 6572 7265 645f 7461  ory.    erred_ta
-0000dbc0: 736b 733a 2064 6571 7565 5b45 7272 6564  sks: deque[Erred
-0000dbd0: 5461 736b 5d0a 0a20 2020 2023 3a20 4869  Task]..    #: Hi
-0000dbe0: 7374 6f72 7920 6f66 2074 6173 6b20 7374  story of task st
-0000dbf0: 6174 6520 7472 616e 7369 7469 6f6e 732e  ate transitions.
-0000dc00: 0a20 2020 2023 3a20 5468 6520 6c65 6e67  .    #: The leng
-0000dc10: 7468 2063 616e 2062 6520 7477 6561 6b65  th can be tweake
-0000dc20: 6420 7468 726f 7567 680a 2020 2020 233a  d through.    #:
-0000dc30: 2064 6973 7472 6962 7574 6564 2e73 6368   distributed.sch
-0000dc40: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-0000dc50: 6e2d 6c6f 672d 6c65 6e67 7468 0a20 2020  n-log-length.   
-0000dc60: 2074 7261 6e73 6974 696f 6e5f 6c6f 673a   transition_log:
-0000dc70: 2064 6571 7565 5b54 7261 6e73 6974 696f   deque[Transitio
-0000dc80: 6e5d 0a0a 2020 2020 233a 2054 6f74 616c  n]..    #: Total
-0000dc90: 206e 756d 6265 7220 6f66 2074 7261 6e73   number of trans
-0000dca0: 6974 696f 6e73 2073 696e 6365 2074 6865  itions since the
-0000dcb0: 2063 6c75 7374 6572 2077 6173 2073 7461   cluster was sta
-0000dcc0: 7274 6564 0a20 2020 2074 7261 6e73 6974  rted.    transit
-0000dcd0: 696f 6e5f 636f 756e 7465 723a 2069 6e74  ion_counter: int
-0000dce0: 0a0a 2020 2020 233a 2054 6f74 616c 206e  ..    #: Total n
-0000dcf0: 756d 6265 7220 6f66 2074 7261 6e73 6974  umber of transit
-0000dd00: 696f 6e73 2061 7320 6f66 2074 6865 2070  ions as of the p
-0000dd10: 7265 7669 6f75 7320 6361 6c6c 2074 6f20  revious call to 
-0000dd20: 6368 6563 6b5f 6964 6c65 2829 0a20 2020  check_idle().   
-0000dd30: 205f 6964 6c65 5f74 7261 6e73 6974 696f   _idle_transitio
-0000dd40: 6e5f 636f 756e 7465 723a 2069 6e74 0a0a  n_counter: int..
-0000dd50: 2020 2020 233a 2052 6169 7365 2061 6e20      #: Raise an 
-0000dd60: 6572 726f 7220 6966 2074 6865 203a 6174  error if the :at
-0000dd70: 7472 3a60 7472 616e 7369 7469 6f6e 5f63  tr:`transition_c
-0000dd80: 6f75 6e74 6572 6020 6576 6572 2072 6561  ounter` ever rea
-0000dd90: 6368 6573 2074 6869 7320 7661 6c75 652e  ches this value.
-0000dda0: 0a20 2020 2023 3a20 5468 6973 2069 7320  .    #: This is 
-0000ddb0: 6d65 616e 7420 666f 7220 6465 6275 6767  meant for debugg
-0000ddc0: 696e 6720 6f6e 6c79 2c20 746f 2063 6174  ing only, to cat
-0000ddd0: 6368 2069 6e66 696e 6974 6520 7265 6375  ch infinite recu
-0000dde0: 7273 696f 6e20 6c6f 6f70 732e 0a20 2020  rsion loops..   
-0000ddf0: 2023 3a20 496e 2070 726f 6475 6374 696f   #: In productio
-0000de00: 6e2c 2069 7420 7368 6f75 6c64 2061 6c77  n, it should alw
-0000de10: 6179 7320 6265 2073 6574 2074 6f20 4661  ays be set to Fa
-0000de20: 6c73 652e 0a20 2020 2074 7261 6e73 6974  lse..    transit
-0000de30: 696f 6e5f 636f 756e 7465 725f 6d61 783a  ion_counter_max:
-0000de40: 2069 6e74 207c 204c 6974 6572 616c 5b46   int | Literal[F
-0000de50: 616c 7365 5d0a 0a20 2020 205f 7461 736b  alse]..    _task
-0000de60: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
-0000de70: 6f62 616c 3a20 6465 6661 756c 7464 6963  obal: defaultdic
-0000de80: 745b 7374 722c 2069 6e74 5d0a 2020 2020  t[str, int].    
-0000de90: 5f6e 6574 776f 726b 5f6f 6363 5f67 6c6f  _network_occ_glo
-0000dea0: 6261 6c3a 2066 6c6f 6174 0a20 2020 2023  bal: float.    #
-0000deb0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dec0: 2323 2323 230a 2020 2020 2320 4361 6368  #####.    # Cach
-0000ded0: 6564 2063 6f6e 6669 6775 7261 7469 6f6e  ed configuration
-0000dee0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
-0000def0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-0000df00: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
-0000df10: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
-0000df20: 6e2d 7461 736b 2d64 7572 6174 696f 6e0a  n-task-duration.
-0000df30: 2020 2020 554e 4b4e 4f57 4e5f 5441 534b      UNKNOWN_TASK
-0000df40: 5f44 5552 4154 494f 4e3a 2066 6c6f 6174  _DURATION: float
-0000df50: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
-0000df60: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-0000df70: 792e 7265 6365 6e74 2d74 6f2d 6f6c 642d  y.recent-to-old-
-0000df80: 7469 6d65 0a20 2020 204d 454d 4f52 595f  time.    MEMORY_
-0000df90: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
-0000dfa0: 4d45 3a20 666c 6f61 740a 2020 2020 233a  ME: float.    #:
-0000dfb0: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
-0000dfc0: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-0000dfd0: 616e 6365 2e6d 6561 7375 7265 0a20 2020  ance.measure.   
-0000dfe0: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
-0000dff0: 455f 4d45 4153 5552 453a 2073 7472 0a20  E_MEASURE: str. 
-0000e000: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
-0000e010: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-0000e020: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
-0000e030: 2d6d 696e 0a20 2020 204d 454d 4f52 595f  -min.    MEMORY_
-0000e040: 5245 4241 4c41 4e43 455f 5345 4e44 4552  REBALANCE_SENDER
-0000e050: 5f4d 494e 3a20 666c 6f61 740a 2020 2020  _MIN: float.    
-0000e060: 233a 2064 6973 7472 6962 7574 6564 2e77  #: distributed.w
-0000e070: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6562  orker.memory.reb
-0000e080: 616c 616e 6365 2e72 6563 6970 6965 6e74  alance.recipient
-0000e090: 2d6d 6178 0a20 2020 204d 454d 4f52 595f  -max.    MEMORY_
-0000e0a0: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
-0000e0b0: 454e 545f 4d41 583a 2066 6c6f 6174 0a20  ENT_MAX: float. 
-0000e0c0: 2020 2023 3a20 6469 7374 7269 6275 7465     #: distribute
-0000e0d0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-0000e0e0: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
-0000e0f0: 2d72 6563 6970 6965 6e74 2d67 6170 202f  -recipient-gap /
-0000e100: 2032 0a20 2020 204d 454d 4f52 595f 5245   2.    MEMORY_RE
-0000e110: 4241 4c41 4e43 455f 4841 4c46 5f47 4150  BALANCE_HALF_GAP
-0000e120: 3a20 666c 6f61 740a 2020 2020 233a 2064  : float.    #: d
-0000e130: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0000e140: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
-0000e150: 7261 7469 6f6e 0a20 2020 2057 4f52 4b45  ration.    WORKE
-0000e160: 525f 5341 5455 5241 5449 4f4e 3a20 666c  R_SATURATION: fl
-0000e170: 6f61 740a 0a20 2020 205f 5f73 6c6f 7473  oat..    __slots
-0000e180: 5f5f 203d 2074 7570 6c65 285f 5f61 6e6e  __ = tuple(__ann
-0000e190: 6f74 6174 696f 6e73 5f5f 290a 0a20 2020  otations__)..   
-0000e1a0: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
-0000e1b0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0000e1c0: 2020 2020 2061 6c69 6173 6573 3a20 6469       aliases: di
-0000e1d0: 6374 5b48 6173 6861 626c 652c 2073 7472  ct[Hashable, str
-0000e1e0: 5d2c 0a20 2020 2020 2020 2063 6c69 656e  ],.        clien
-0000e1f0: 7473 3a20 6469 6374 5b73 7472 2c20 436c  ts: dict[str, Cl
-0000e200: 6965 6e74 5374 6174 655d 2c0a 2020 2020  ientState],.    
-0000e210: 2020 2020 776f 726b 6572 733a 2053 6f72      workers: Sor
-0000e220: 7465 6444 6963 745b 7374 722c 2057 6f72  tedDict[str, Wor
-0000e230: 6b65 7253 7461 7465 5d2c 0a20 2020 2020  kerState],.     
-0000e240: 2020 2068 6f73 745f 696e 666f 3a20 6469     host_info: di
-0000e250: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
-0000e260: 2c20 416e 795d 5d2c 0a20 2020 2020 2020  , Any]],.       
-0000e270: 2072 6573 6f75 7263 6573 3a20 6469 6374   resources: dict
-0000e280: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-0000e290: 666c 6f61 745d 5d2c 0a20 2020 2020 2020  float]],.       
-0000e2a0: 2074 6173 6b73 3a20 6469 6374 5b73 7472   tasks: dict[str
-0000e2b0: 2c20 5461 736b 5374 6174 655d 2c0a 2020  , TaskState],.  
-0000e2c0: 2020 2020 2020 756e 7275 6e6e 6162 6c65        unrunnable
-0000e2d0: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
-0000e2e0: 2c0a 2020 2020 2020 2020 7175 6575 6564  ,.        queued
-0000e2f0: 3a20 4865 6170 5365 745b 5461 736b 5374  : HeapSet[TaskSt
-0000e300: 6174 655d 2c0a 2020 2020 2020 2020 7661  ate],.        va
-0000e310: 6c69 6461 7465 3a20 626f 6f6c 2c0a 2020  lidate: bool,.  
-0000e320: 2020 2020 2020 706c 7567 696e 733a 2049        plugins: I
-0000e330: 7465 7261 626c 655b 5363 6865 6475 6c65  terable[Schedule
-0000e340: 7250 6c75 6769 6e5d 203d 2028 292c 0a20  rPlugin] = (),. 
-0000e350: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
-0000e360: 6e5f 636f 756e 7465 725f 6d61 783a 2069  n_counter_max: i
-0000e370: 6e74 207c 204c 6974 6572 616c 5b46 616c  nt | Literal[Fal
-0000e380: 7365 5d20 3d20 4661 6c73 652c 0a20 2020  se] = False,.   
-0000e390: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-0000e3a0: 6e79 2c20 2023 2050 6173 7365 6420 7665  ny,  # Passed ve
-0000e3b0: 7262 6174 696d 2074 6f20 5365 7276 6572  rbatim to Server
-0000e3c0: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
-0000e3d0: 293a 0a20 2020 2020 2020 206c 6f67 6765  ):.        logge
-0000e3e0: 722e 696e 666f 2822 5374 6174 6520 7374  r.info("State st
-0000e3f0: 6172 7422 290a 2020 2020 2020 2020 7365  art").        se
-0000e400: 6c66 2e61 6c69 6173 6573 203d 2061 6c69  lf.aliases = ali
-0000e410: 6173 6573 0a20 2020 2020 2020 2073 656c  ases.        sel
-0000e420: 662e 6261 6e64 7769 6474 6820 3d20 7061  f.bandwidth = pa
-0000e430: 7273 655f 6279 7465 7328 6461 736b 2e63  rse_bytes(dask.c
-0000e440: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0000e450: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0000e460: 2e62 616e 6477 6964 7468 2229 290a 2020  .bandwidth")).  
-0000e470: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000e480: 7473 203d 2063 6c69 656e 7473 0a20 2020  ts = clients.   
-0000e490: 2020 2020 2073 656c 662e 636c 6965 6e74       self.client
-0000e4a0: 735b 2266 6972 652d 616e 642d 666f 7267  s["fire-and-forg
-0000e4b0: 6574 225d 203d 2043 6c69 656e 7453 7461  et"] = ClientSta
-0000e4c0: 7465 2822 6669 7265 2d61 6e64 2d66 6f72  te("fire-and-for
-0000e4d0: 6765 7422 290a 2020 2020 2020 2020 7365  get").        se
-0000e4e0: 6c66 2e65 7874 656e 7369 6f6e 7320 3d20  lf.extensions = 
-0000e4f0: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-0000e500: 686f 7374 5f69 6e66 6f20 3d20 686f 7374  host_info = host
-0000e510: 5f69 6e66 6f0a 2020 2020 2020 2020 7365  _info.        se
-0000e520: 6c66 2e69 646c 6520 3d20 536f 7274 6564  lf.idle = Sorted
-0000e530: 4469 6374 2829 0a20 2020 2020 2020 2073  Dict().        s
-0000e540: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-0000e550: 756e 7420 3d20 7365 7428 290a 2020 2020  unt = set().    
-0000e560: 2020 2020 7365 6c66 2e6e 5f74 6173 6b73      self.n_tasks
-0000e570: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-0000e580: 662e 7265 736f 7572 6365 7320 3d20 7265  f.resources = re
-0000e590: 736f 7572 6365 730a 2020 2020 2020 2020  sources.        
-0000e5a0: 7365 6c66 2e73 6174 7572 6174 6564 203d  self.saturated =
-0000e5b0: 2073 6574 2829 0a20 2020 2020 2020 2073   set().        s
-0000e5c0: 656c 662e 7461 736b 7320 3d20 7461 736b  elf.tasks = task
-0000e5d0: 730a 2020 2020 2020 2020 7365 6c66 2e72  s.        self.r
-0000e5e0: 6570 6c69 6361 7465 645f 7461 736b 7320  eplicated_tasks 
-0000e5f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0000e600: 7473 2066 6f72 2074 7320 696e 2073 656c  ts for ts in sel
-0000e610: 662e 7461 736b 732e 7661 6c75 6573 2829  f.tasks.values()
-0000e620: 2069 6620 6c65 6e28 7473 2e77 686f 5f68   if len(ts.who_h
-0000e630: 6173 2920 3e20 310a 2020 2020 2020 2020  as) > 1.        
-0000e640: 7d0a 2020 2020 2020 2020 7365 6c66 2e63  }.        self.c
-0000e650: 6f6d 7075 7461 7469 6f6e 7320 3d20 6465  omputations = de
-0000e660: 7175 6528 0a20 2020 2020 2020 2020 2020  que(.           
-0000e670: 206d 6178 6c65 6e3d 6461 736b 2e63 6f6e   maxlen=dask.con
-0000e680: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0000e690: 7574 6564 2e64 6961 676e 6f73 7469 6373  uted.diagnostics
-0000e6a0: 2e63 6f6d 7075 7461 7469 6f6e 732e 6d61  .computations.ma
-0000e6b0: 782d 6869 7374 6f72 7922 290a 2020 2020  x-history").    
-0000e6c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0000e6d0: 6c66 2e65 7272 6564 5f74 6173 6b73 203d  lf.erred_tasks =
-0000e6e0: 2064 6571 7565 280a 2020 2020 2020 2020   deque(.        
-0000e6f0: 2020 2020 6d61 786c 656e 3d64 6173 6b2e      maxlen=dask.
-0000e700: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0000e710: 7269 6275 7465 642e 6469 6167 6e6f 7374  ributed.diagnost
-0000e720: 6963 732e 6572 7265 642d 7461 736b 732e  ics.erred-tasks.
-0000e730: 6d61 782d 6869 7374 6f72 7922 290a 2020  max-history").  
-0000e740: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0000e750: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
-0000e760: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-0000e770: 6c66 2e74 6173 6b5f 7072 6566 6978 6573  lf.task_prefixes
-0000e780: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-0000e790: 6c66 2e74 6173 6b5f 6d65 7461 6461 7461  lf.task_metadata
-0000e7a0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-0000e7b0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
-0000e7c0: 7320 3d20 300a 2020 2020 2020 2020 7365  s = 0.        se
-0000e7d0: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
-0000e7e0: 735f 6869 7374 6f72 7920 3d20 5b28 7469  s_history = [(ti
-0000e7f0: 6d65 2829 2c20 3029 5d0a 2020 2020 2020  me(), 0)].      
-0000e800: 2020 7365 6c66 2e75 6e6b 6e6f 776e 5f64    self.unknown_d
-0000e810: 7572 6174 696f 6e73 203d 207b 7d0a 2020  urations = {}.  
-0000e820: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-0000e830: 6420 3d20 7175 6575 6564 0a20 2020 2020  d = queued.     
-0000e840: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
-0000e850: 6c65 203d 2075 6e72 756e 6e61 626c 650a  le = unrunnable.
-0000e860: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
-0000e870: 6964 6174 6520 3d20 7661 6c69 6461 7465  idate = validate
-0000e880: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
-0000e890: 726b 6572 7320 3d20 776f 726b 6572 730a  rkers = workers.
-0000e8a0: 2020 2020 2020 2020 7365 6c66 2e5f 7461          self._ta
-0000e8b0: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
-0000e8c0: 676c 6f62 616c 203d 2064 6566 6175 6c74  global = default
-0000e8d0: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-0000e8e0: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-0000e8f0: 6f63 635f 676c 6f62 616c 203d 2030 2e30  occ_global = 0.0
-0000e900: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
-0000e910: 6e6e 696e 6720 3d20 7b0a 2020 2020 2020  nning = {.      
-0000e920: 2020 2020 2020 7773 2066 6f72 2077 7320        ws for ws 
-0000e930: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0000e940: 7661 6c75 6573 2829 2069 6620 7773 2e73  values() if ws.s
-0000e950: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-0000e960: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-0000e970: 7d0a 2020 2020 2020 2020 7365 6c66 2e70  }.        self.p
-0000e980: 6c75 6769 6e73 203d 207b 7d20 6966 206e  lugins = {} if n
-0000e990: 6f74 2070 6c75 6769 6e73 2065 6c73 6520  ot plugins else 
-0000e9a0: 7b5f 6765 745f 706c 7567 696e 5f6e 616d  {_get_plugin_nam
-0000e9b0: 6528 7029 3a20 7020 666f 7220 7020 696e  e(p): p for p in
-0000e9c0: 2070 6c75 6769 6e73 7d0a 0a20 2020 2020   plugins}..     
-0000e9d0: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0000e9e0: 6f6e 5f6c 6f67 203d 2064 6571 7565 280a  on_log = deque(.
-0000e9f0: 2020 2020 2020 2020 2020 2020 6d61 786c              maxl
-0000ea00: 656e 3d64 6173 6b2e 636f 6e66 6967 2e67  en=dask.config.g
-0000ea10: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000ea20: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
-0000ea30: 7469 6f6e 2d6c 6f67 2d6c 656e 6774 6822  tion-log-length"
-0000ea40: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000ea50: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-0000ea60: 696f 6e5f 636f 756e 7465 7220 3d20 300a  ion_counter = 0.
-0000ea70: 2020 2020 2020 2020 7365 6c66 2e5f 6964          self._id
-0000ea80: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
-0000ea90: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
-0000eaa0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-0000eab0: 6e5f 636f 756e 7465 725f 6d61 7820 3d20  n_counter_max = 
-0000eac0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-0000ead0: 6572 5f6d 6178 0a0a 2020 2020 2020 2020  er_max..        
-0000eae0: 2320 5661 7269 6162 6c65 7320 6672 6f6d  # Variables from
-0000eaf0: 2064 6173 6b2e 636f 6e66 6967 2c20 6361   dask.config, ca
-0000eb00: 6368 6564 2062 7920 5f5f 696e 6974 5f5f  ched by __init__
-0000eb10: 2066 6f72 2070 6572 666f 726d 616e 6365   for performance
-0000eb20: 0a20 2020 2020 2020 2073 656c 662e 554e  .        self.UN
-0000eb30: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
-0000eb40: 494f 4e20 3d20 7061 7273 655f 7469 6d65  ION = parse_time
-0000eb50: 6465 6c74 6128 0a20 2020 2020 2020 2020  delta(.         
-0000eb60: 2020 2064 6173 6b2e 636f 6e66 6967 2e67     dask.config.g
-0000eb70: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
-0000eb80: 7363 6865 6475 6c65 722e 756e 6b6e 6f77  scheduler.unknow
-0000eb90: 6e2d 7461 736b 2d64 7572 6174 696f 6e22  n-task-duration"
-0000eba0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000ebb0: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000ebc0: 5245 4345 4e54 5f54 4f5f 4f4c 445f 5449  RECENT_TO_OLD_TI
-0000ebd0: 4d45 203d 2070 6172 7365 5f74 696d 6564  ME = parse_timed
-0000ebe0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0000ebf0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0000ec00: 7428 2264 6973 7472 6962 7574 6564 2e77  t("distributed.w
-0000ec10: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
-0000ec20: 656e 742d 746f 2d6f 6c64 2d74 696d 6522  ent-to-old-time"
-0000ec30: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-0000ec40: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000ec50: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
-0000ec60: 4520 3d20 6461 736b 2e63 6f6e 6669 672e  E = dask.config.
-0000ec70: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000ec80: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-0000ec90: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000eca0: 6c61 6e63 652e 6d65 6173 7572 6522 0a20  lance.measure". 
-0000ecb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000ecc0: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0000ecd0: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
-0000ece0: 4e20 3d20 6461 736b 2e63 6f6e 6669 672e  N = dask.config.
-0000ecf0: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
-0000ed00: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
-0000ed10: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000ed20: 6c61 6e63 652e 7365 6e64 6572 2d6d 696e  lance.sender-min
-0000ed30: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
-0000ed40: 2020 2020 7365 6c66 2e4d 454d 4f52 595f      self.MEMORY_
-0000ed50: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
-0000ed60: 454e 545f 4d41 5820 3d20 6461 736b 2e63  ENT_MAX = dask.c
-0000ed70: 6f6e 6669 672e 6765 7428 0a20 2020 2020  onfig.get(.     
-0000ed80: 2020 2020 2020 2022 6469 7374 7269 6275         "distribu
-0000ed90: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
-0000eda0: 792e 7265 6261 6c61 6e63 652e 7265 6369  y.rebalance.reci
-0000edb0: 7069 656e 742d 6d61 7822 0a20 2020 2020  pient-max".     
-0000edc0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-0000edd0: 662e 4d45 4d4f 5259 5f52 4542 414c 414e  f.MEMORY_REBALAN
-0000ede0: 4345 5f48 414c 465f 4741 5020 3d20 280a  CE_HALF_GAP = (.
-0000edf0: 2020 2020 2020 2020 2020 2020 6461 736b              dask
-0000ee00: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0000ee10: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
-0000ee20: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
-0000ee30: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
-0000ee40: 742d 6761 7022 290a 2020 2020 2020 2020  t-gap").        
-0000ee50: 2020 2020 2f20 322e 300a 2020 2020 2020      / 2.0.      
-0000ee60: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0000ee70: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
-0000ee80: 494f 4e20 3d20 6461 736b 2e63 6f6e 6669  ION = dask.confi
-0000ee90: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-0000eea0: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-0000eeb0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-0000eec0: 2d73 6174 7572 6174 696f 6e22 0a20 2020  -saturation".   
-0000eed0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-0000eee0: 6620 7365 6c66 2e57 4f52 4b45 525f 5341  f self.WORKER_SA
-0000eef0: 5455 5241 5449 4f4e 203d 3d20 2269 6e66  TURATION == "inf
-0000ef00: 223a 0a20 2020 2020 2020 2020 2020 2023  ":.            #
-0000ef10: 2053 7065 6369 616c 2063 6173 6520 6e65   Special case ne
-0000ef20: 6365 7373 6172 7920 6265 6361 7573 6520  cessary because 
-0000ef30: 7468 6572 6527 7320 6e6f 2077 6179 2074  there's no way t
-0000ef40: 6f20 7061 7273 6520 6120 666c 6f61 7420  o parse a float 
-0000ef50: 696e 6669 6e69 7479 0a20 2020 2020 2020  infinity.       
-0000ef60: 2020 2020 2023 2066 726f 6d20 6120 4441       # from a DA
-0000ef70: 534b 5f2a 2065 6e76 6972 6f6e 6d65 6e74  SK_* environment
-0000ef80: 2076 6172 6961 626c 650a 2020 2020 2020   variable.      
-0000ef90: 2020 2020 2020 7365 6c66 2e57 4f52 4b45        self.WORKE
-0000efa0: 525f 5341 5455 5241 5449 4f4e 203d 206d  R_SATURATION = m
-0000efb0: 6174 682e 696e 660a 2020 2020 2020 2020  ath.inf.        
-0000efc0: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-0000efd0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-0000efe0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
-0000eff0: 5241 5449 4f4e 2c20 2869 6e74 2c20 666c  RATION, (int, fl
-0000f000: 6f61 7429 290a 2020 2020 2020 2020 2020  oat)).          
-0000f010: 2020 6f72 2073 656c 662e 574f 524b 4552    or self.WORKER
-0000f020: 5f53 4154 5552 4154 494f 4e20 3c3d 2030  _SATURATION <= 0
-0000f030: 0a20 2020 2020 2020 2029 3a0a 2020 2020  .        ):.    
-0000f040: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-0000f050: 6c75 6545 7272 6f72 2820 2023 2070 7261  lueError(  # pra
-0000f060: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
-0000f070: 2020 2020 2020 2020 2020 2020 2022 6064               "`d
-0000f080: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0000f090: 756c 6572 2e77 6f72 6b65 722d 7361 7475  uler.worker-satu
-0000f0a0: 7261 7469 6f6e 6020 6d75 7374 2062 6520  ration` must be 
-0000f0b0: 6120 666c 6f61 7420 3e20 303b 2067 6f74  a float > 0; got
-0000f0c0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000f0d0: 2020 202b 2072 6570 7228 7365 6c66 2e57     + repr(self.W
-0000f0e0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-0000f0f0: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0000f100: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-0000f110: 2020 2064 6566 206d 656d 6f72 7928 7365     def memory(se
-0000f120: 6c66 2920 2d3e 204d 656d 6f72 7953 7461  lf) -> MemorySta
-0000f130: 7465 3a0a 2020 2020 2020 2020 7265 7475  te:.        retu
-0000f140: 726e 204d 656d 6f72 7953 7461 7465 2e73  rn MemoryState.s
-0000f150: 756d 282a 2877 2e6d 656d 6f72 7920 666f  um(*(w.memory fo
-0000f160: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-0000f170: 6572 732e 7661 6c75 6573 2829 2929 0a0a  ers.values()))..
-0000f180: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0000f190: 2020 6465 6620 5f5f 7064 6963 745f 5f28    def __pdict__(
-0000f1a0: 7365 6c66 2920 2d3e 2064 6963 745b 7374  self) -> dict[st
-0000f1b0: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
-0000f1c0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
-0000f1d0: 2020 2020 2020 2262 616e 6477 6964 7468        "bandwidth
-0000f1e0: 223a 2073 656c 662e 6261 6e64 7769 6474  ": self.bandwidt
-0000f1f0: 682c 0a20 2020 2020 2020 2020 2020 2022  h,.            "
-0000f200: 7265 736f 7572 6365 7322 3a20 7365 6c66  resources": self
-0000f210: 2e72 6573 6f75 7263 6573 2c0a 2020 2020  .resources,.    
-0000f220: 2020 2020 2020 2020 2273 6174 7572 6174          "saturat
-0000f230: 6564 223a 2073 656c 662e 7361 7475 7261  ed": self.satura
-0000f240: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
-0000f250: 2022 756e 7275 6e6e 6162 6c65 223a 2073   "unrunnable": s
-0000f260: 656c 662e 756e 7275 6e6e 6162 6c65 2c0a  elf.unrunnable,.
-0000f270: 2020 2020 2020 2020 2020 2020 2271 7565              "que
-0000f280: 7565 6422 3a20 7365 6c66 2e71 7565 7565  ued": self.queue
-0000f290: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-0000f2a0: 6e5f 7461 736b 7322 3a20 7365 6c66 2e6e  n_tasks": self.n
-0000f2b0: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-0000f2c0: 2020 2020 2275 6e6b 6e6f 776e 5f64 7572      "unknown_dur
-0000f2d0: 6174 696f 6e73 223a 2073 656c 662e 756e  ations": self.un
-0000f2e0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732c  known_durations,
-0000f2f0: 0a20 2020 2020 2020 2020 2020 2022 7661  .            "va
-0000f300: 6c69 6461 7465 223a 2073 656c 662e 7661  lidate": self.va
-0000f310: 6c69 6461 7465 2c0a 2020 2020 2020 2020  lidate,.        
-0000f320: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
-0000f330: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
-0000f340: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
-0000f350: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
-0000f360: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
-0000f370: 2020 2274 6173 6b5f 7072 6566 6978 6573    "task_prefixes
-0000f380: 223a 2073 656c 662e 7461 736b 5f70 7265  ": self.task_pre
-0000f390: 6669 7865 732c 0a20 2020 2020 2020 2020  fixes,.         
-0000f3a0: 2020 2022 746f 7461 6c5f 6e74 6872 6561     "total_nthrea
-0000f3b0: 6473 223a 2073 656c 662e 746f 7461 6c5f  ds": self.total_
-0000f3c0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
-0000f3d0: 2020 2020 2020 2274 6f74 616c 5f6f 6363        "total_occ
-0000f3e0: 7570 616e 6379 223a 2073 656c 662e 746f  upancy": self.to
-0000f3f0: 7461 6c5f 6f63 6375 7061 6e63 792c 0a20  tal_occupancy,. 
-0000f400: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
-0000f410: 645f 7461 736b 7322 3a20 7365 6c66 2e65  d_tasks": self.e
-0000f420: 7272 6564 5f74 6173 6b73 2c0a 2020 2020  rred_tasks,.    
-0000f430: 2020 2020 2020 2020 2265 7874 656e 7369          "extensi
-0000f440: 6f6e 7322 3a20 7365 6c66 2e65 7874 656e  ons": self.exten
-0000f450: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
-0000f460: 2020 2022 636c 6965 6e74 7322 3a20 7365     "clients": se
-0000f470: 6c66 2e63 6c69 656e 7473 2c0a 2020 2020  lf.clients,.    
-0000f480: 2020 2020 2020 2020 2277 6f72 6b65 7273          "workers
-0000f490: 223a 2073 656c 662e 776f 726b 6572 732c  ": self.workers,
-0000f4a0: 0a20 2020 2020 2020 2020 2020 2022 6964  .            "id
-0000f4b0: 6c65 223a 2073 656c 662e 6964 6c65 2c0a  le": self.idle,.
-0000f4c0: 2020 2020 2020 2020 2020 2020 2268 6f73              "hos
-0000f4d0: 745f 696e 666f 223a 2073 656c 662e 686f  t_info": self.ho
-0000f4e0: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
-0000f4f0: 207d 0a0a 2020 2020 6465 6620 6e65 775f   }..    def new_
-0000f500: 7461 736b 280a 2020 2020 2020 2020 7365  task(.        se
-0000f510: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
-0000f520: 2073 7472 2c0a 2020 2020 2020 2020 7370   str,.        sp
-0000f530: 6563 3a20 6f62 6a65 6374 2c0a 2020 2020  ec: object,.    
-0000f540: 2020 2020 7374 6174 653a 2054 6173 6b53      state: TaskS
-0000f550: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
-0000f560: 2020 2063 6f6d 7075 7461 7469 6f6e 3a20     computation: 
-0000f570: 436f 6d70 7574 6174 696f 6e20 7c20 4e6f  Computation | No
-0000f580: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
-0000f590: 202d 3e20 5461 736b 5374 6174 653a 0a20   -> TaskState:. 
-0000f5a0: 2020 2020 2020 2022 2222 4372 6561 7465         """Create
-0000f5b0: 2061 206e 6577 2074 6173 6b2c 2061 6e64   a new task, and
-0000f5c0: 2061 7373 6f63 6961 7465 6420 7374 6174   associated stat
-0000f5d0: 6573 2222 220a 2020 2020 2020 2020 7473  es""".        ts
-0000f5e0: 203d 2054 6173 6b53 7461 7465 286b 6579   = TaskState(key
-0000f5f0: 2c20 7370 6563 2c20 7374 6174 6529 0a0a  , spec, state)..
-0000f600: 2020 2020 2020 2020 7072 6566 6978 5f6b          prefix_k
-0000f610: 6579 203d 206b 6579 5f73 706c 6974 286b  ey = key_split(k
-0000f620: 6579 290a 2020 2020 2020 2020 7470 203d  ey).        tp =
-0000f630: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000f640: 7865 732e 6765 7428 7072 6566 6978 5f6b  xes.get(prefix_k
-0000f650: 6579 290a 2020 2020 2020 2020 6966 2074  ey).        if t
-0000f660: 7020 6973 204e 6f6e 653a 0a20 2020 2020  p is None:.     
-0000f670: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000f680: 5f70 7265 6669 7865 735b 7072 6566 6978  _prefixes[prefix
-0000f690: 5f6b 6579 5d20 3d20 7470 203d 2054 6173  _key] = tp = Tas
-0000f6a0: 6b50 7265 6669 7828 7072 6566 6978 5f6b  kPrefix(prefix_k
-0000f6b0: 6579 290a 2020 2020 2020 2020 7473 2e70  ey).        ts.p
-0000f6c0: 7265 6669 7820 3d20 7470 0a0a 2020 2020  refix = tp..    
-0000f6d0: 2020 2020 6772 6f75 705f 6b65 7920 3d20      group_key = 
-0000f6e0: 7473 2e67 726f 7570 5f6b 6579 0a20 2020  ts.group_key.   
-0000f6f0: 2020 2020 2074 6720 3d20 7365 6c66 2e74       tg = self.t
-0000f700: 6173 6b5f 6772 6f75 7073 2e67 6574 2867  ask_groups.get(g
-0000f710: 726f 7570 5f6b 6579 290a 2020 2020 2020  roup_key).      
-0000f720: 2020 6966 2074 6720 6973 204e 6f6e 653a    if tg is None:
-0000f730: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000f740: 662e 7461 736b 5f67 726f 7570 735b 6772  f.task_groups[gr
-0000f750: 6f75 705f 6b65 795d 203d 2074 6720 3d20  oup_key] = tg = 
-0000f760: 5461 736b 4772 6f75 7028 6772 6f75 705f  TaskGroup(group_
-0000f770: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0000f780: 2069 6620 636f 6d70 7574 6174 696f 6e3a   if computation:
-0000f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f7a0: 2063 6f6d 7075 7461 7469 6f6e 2e67 726f   computation.gro
-0000f7b0: 7570 732e 6164 6428 7467 290a 2020 2020  ups.add(tg).    
-0000f7c0: 2020 2020 2020 2020 7467 2e70 7265 6669          tg.prefi
-0000f7d0: 7820 3d20 7470 0a20 2020 2020 2020 2020  x = tp.         
-0000f7e0: 2020 2074 702e 6772 6f75 7073 2e61 7070     tp.groups.app
-0000f7f0: 656e 6428 7467 290a 2020 2020 2020 2020  end(tg).        
-0000f800: 7467 2e61 6464 2874 7329 0a0a 2020 2020  tg.add(ts)..    
-0000f810: 2020 2020 7365 6c66 2e74 6173 6b73 5b6b      self.tasks[k
-0000f820: 6579 5d20 3d20 7473 0a0a 2020 2020 2020  ey] = ts..      
-0000f830: 2020 7265 7475 726e 2074 730a 0a20 2020    return ts..   
-0000f840: 2064 6566 205f 636c 6561 725f 7461 736b   def _clear_task
-0000f850: 5f73 7461 7465 2873 656c 6629 202d 3e20  _state(self) -> 
-0000f860: 4e6f 6e65 3a0a 2020 2020 2020 2020 6c6f  None:.        lo
-0000f870: 6767 6572 2e64 6562 7567 2822 436c 6561  gger.debug("Clea
-0000f880: 7220 7461 736b 2073 7461 7465 2229 0a20  r task state"). 
-0000f890: 2020 2020 2020 2066 6f72 2063 6f6c 6c65         for colle
-0000f8a0: 6374 696f 6e20 696e 2028 0a20 2020 2020  ction in (.     
-0000f8b0: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
-0000f8c0: 6e6e 6162 6c65 2c0a 2020 2020 2020 2020  nnable,.        
-0000f8d0: 2020 2020 7365 6c66 2e65 7272 6564 5f74      self.erred_t
-0000f8e0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-0000f8f0: 2020 7365 6c66 2e63 6f6d 7075 7461 7469    self.computati
-0000f900: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0000f910: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000f920: 7865 732c 0a20 2020 2020 2020 2020 2020  xes,.           
-0000f930: 2073 656c 662e 7461 736b 5f67 726f 7570   self.task_group
-0000f940: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
-0000f950: 656c 662e 7461 736b 5f6d 6574 6164 6174  elf.task_metadat
-0000f960: 612c 0a20 2020 2020 2020 2020 2020 2073  a,.            s
-0000f970: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-0000f980: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
-0000f990: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
-0000f9a0: 6564 5f74 6173 6b73 2c0a 2020 2020 2020  ed_tasks,.      
-0000f9b0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0000f9c0: 2063 6f6c 6c65 6374 696f 6e2e 636c 6561   collection.clea
-0000f9d0: 7228 2920 2023 2074 7970 653a 2069 676e  r()  # type: ign
-0000f9e0: 6f72 650a 0a20 2020 2040 7072 6f70 6572  ore..    @proper
-0000f9f0: 7479 0a20 2020 2064 6566 2069 735f 6964  ty.    def is_id
-0000fa00: 6c65 2873 656c 6629 202d 3e20 626f 6f6c  le(self) -> bool
-0000fa10: 3a0a 2020 2020 2020 2020 2222 2252 6574  :.        """Ret
-0000fa20: 7572 6e20 5472 7565 2069 6666 2074 6865  urn True iff the
-0000fa30: 7265 2061 7265 206e 6f20 7461 736b 7320  re are no tasks 
-0000fa40: 7468 6174 2068 6176 656e 2774 2066 696e  that haven't fin
-0000fa50: 6973 6865 6420 636f 6d70 7574 696e 672e  ished computing.
-0000fa60: 0a0a 2020 2020 2020 2020 556e 6c69 6b65  ..        Unlike
-0000fa70: 2074 6573 7469 6e67 2060 6073 656c 662e   testing ``self.
-0000fa80: 746f 7461 6c5f 6f63 6375 7061 6e63 7960  total_occupancy`
-0000fa90: 602c 2074 6869 7320 7072 6f70 6572 7479  `, this property
-0000faa0: 2072 6574 7572 6e73 2046 616c 7365 2069   returns False i
-0000fab0: 6620 7468 6572 650a 2020 2020 2020 2020  f there.        
-0000fac0: 6172 6520 6c6f 6e67 2d72 756e 6e69 6e67  are long-running
-0000fad0: 2074 6173 6b73 2c20 6e6f 2d77 6f72 6b65   tasks, no-worke
-0000fae0: 722c 206f 7220 7175 6575 6564 2074 6173  r, or queued tas
-0000faf0: 6b73 2028 6475 6520 746f 206e 6f74 2068  ks (due to not h
-0000fb00: 6176 696e 6720 616e 790a 2020 2020 2020  aving any.      
-0000fb10: 2020 776f 726b 6572 7329 2e0a 0a20 2020    workers)...   
-0000fb20: 2020 2020 204e 6f74 2074 6f20 6265 2063       Not to be c
-0000fb30: 6f6e 6675 7365 6420 7769 7468 2060 6069  onfused with ``i
-0000fb40: 646c 6560 602e 0a20 2020 2020 2020 2022  dle``..        "
-0000fb50: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
-0000fb60: 6e20 616c 6c28 7467 2e64 6f6e 6520 666f  n all(tg.done fo
-0000fb70: 7220 7467 2069 6e20 7365 6c66 2e74 6173  r tg in self.tas
-0000fb80: 6b5f 6772 6f75 7073 2e76 616c 7565 7328  k_groups.values(
-0000fb90: 2929 0a0a 2020 2020 4070 726f 7065 7274  ))..    @propert
-0000fba0: 790a 2020 2020 6465 6620 746f 7461 6c5f  y.    def total_
-0000fbb0: 6f63 6375 7061 6e63 7928 7365 6c66 2920  occupancy(self) 
-0000fbc0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0000fbd0: 2020 7265 7475 726e 2073 656c 662e 5f63    return self._c
-0000fbe0: 616c 635f 6f63 6375 7061 6e63 7928 0a20  alc_occupancy(. 
-0000fbf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fc00: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
-0000fc10: 6e74 5f67 6c6f 6261 6c2c 0a20 2020 2020  nt_global,.     
-0000fc20: 2020 2020 2020 2073 656c 662e 5f6e 6574         self._net
-0000fc30: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c2c  work_occ_global,
-0000fc40: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000fc50: 6465 6620 5f63 616c 635f 6f63 6375 7061  def _calc_occupa
-0000fc60: 6e63 7928 0a20 2020 2020 2020 2073 656c  ncy(.        sel
-0000fc70: 662c 0a20 2020 2020 2020 2074 6173 6b5f  f,.        task_
-0000fc80: 7072 6566 6978 5f63 6f75 6e74 3a20 6469  prefix_count: di
-0000fc90: 6374 5b73 7472 2c20 696e 745d 2c0a 2020  ct[str, int],.  
-0000fca0: 2020 2020 2020 6e65 7477 6f72 6b5f 6f63        network_oc
-0000fcb0: 633a 2066 6c6f 6174 2c0a 2020 2020 2920  c: float,.    ) 
-0000fcc0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-0000fcd0: 2020 7265 7320 3d20 302e 300a 2020 2020    res = 0.0.    
-0000fce0: 2020 2020 666f 7220 7072 6566 6978 5f6e      for prefix_n
-0000fcf0: 616d 652c 2063 6f75 6e74 2069 6e20 7461  ame, count in ta
-0000fd00: 736b 5f70 7265 6669 785f 636f 756e 742e  sk_prefix_count.
-0000fd10: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0000fd20: 2020 2020 2023 2054 4f44 4f3a 2044 6561       # TODO: Dea
-0000fd30: 6c20 7769 7468 2075 6e6b 6e6f 776e 2074  l with unknown t
-0000fd40: 6173 6b73 2062 6574 7465 720a 2020 2020  asks better.    
-0000fd50: 2020 2020 2020 2020 7072 6566 6978 203d          prefix =
-0000fd60: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-0000fd70: 7865 735b 7072 6566 6978 5f6e 616d 655d  xes[prefix_name]
-0000fd80: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0000fd90: 6572 7420 7072 6566 6978 2069 7320 6e6f  ert prefix is no
-0000fda0: 7420 4e6f 6e65 0a20 2020 2020 2020 2020  t None.         
-0000fdb0: 2020 2064 7572 6174 696f 6e20 3d20 7072     duration = pr
-0000fdc0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
-0000fdd0: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
-0000fde0: 2020 6966 2064 7572 6174 696f 6e20 3c20    if duration < 
-0000fdf0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-0000fe00: 2020 2069 6620 7072 6566 6978 2e6d 6178     if prefix.max
-0000fe10: 5f65 7865 635f 7469 6d65 203e 2030 3a0a  _exec_time > 0:.
-0000fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe30: 2020 2020 6475 7261 7469 6f6e 203d 2032      duration = 2
-0000fe40: 202a 2070 7265 6669 782e 6d61 785f 6578   * prefix.max_ex
-0000fe50: 6563 5f74 696d 650a 2020 2020 2020 2020  ec_time.        
-0000fe60: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fe80: 2020 6475 7261 7469 6f6e 203d 2073 656c    duration = sel
-0000fe90: 662e 554e 4b4e 4f57 4e5f 5441 534b 5f44  f.UNKNOWN_TASK_D
-0000fea0: 5552 4154 494f 4e0a 2020 2020 2020 2020  URATION.        
-0000feb0: 2020 2020 7265 7320 2b3d 2064 7572 6174      res += durat
-0000fec0: 696f 6e20 2a20 636f 756e 740a 2020 2020  ion * count.    
-0000fed0: 2020 2020 6f63 6320 3d20 7265 7320 2b20      occ = res + 
-0000fee0: 6e65 7477 6f72 6b5f 6f63 6320 2f20 7365  network_occ / se
-0000fef0: 6c66 2e62 616e 6477 6964 7468 0a20 2020  lf.bandwidth.   
-0000ff00: 2020 2020 2061 7373 6572 7420 6f63 6320       assert occ 
-0000ff10: 3e3d 2030 2c20 286f 6363 2c20 7265 732c  >= 0, (occ, res,
-0000ff20: 206e 6574 776f 726b 5f6f 6363 2c20 7365   network_occ, se
-0000ff30: 6c66 2e62 616e 6477 6964 7468 290a 2020  lf.bandwidth).  
-0000ff40: 2020 2020 2020 7265 7475 726e 206f 6363        return occ
-0000ff50: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-0000ff60: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0000ff70: 2320 5374 6174 6520 5472 616e 7369 7469  # State Transiti
-0000ff80: 6f6e 7320 230a 2020 2020 2323 2323 2323  ons #.    ######
-0000ff90: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-0000ffa0: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
-0000ffb0: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
-0000ffc0: 6c66 2c20 6b65 793a 2073 7472 2c20 6669  lf, key: str, fi
-0000ffd0: 6e69 7368 3a20 5461 736b 5374 6174 6553  nish: TaskStateS
-0000ffe0: 7461 7465 2c20 7374 696d 756c 7573 5f69  tate, stimulus_i
-0000fff0: 643a 2073 7472 2c20 2a2a 6b77 6172 6773  d: str, **kwargs
-00010000: 3a20 416e 790a 2020 2020 2920 2d3e 2052  : Any.    ) -> R
-00010010: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-00010020: 2022 2222 5472 616e 7369 7469 6f6e 2061   """Transition a
-00010030: 206b 6579 2066 726f 6d20 6974 7320 6375   key from its cu
-00010040: 7272 656e 7420 7374 6174 6520 746f 2074  rrent state to t
-00010050: 6865 2066 696e 6973 6820 7374 6174 650a  he finish state.
-00010060: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
-00010070: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00010080: 2d2d 0a20 2020 2020 2020 203e 3e3e 2073  --.        >>> s
-00010090: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
-000100a0: 2778 272c 2027 7761 6974 696e 6727 290a  'x', 'waiting').
-000100b0: 2020 2020 2020 2020 7b27 7827 3a20 2770          {'x': 'p
-000100c0: 726f 6365 7373 696e 6727 7d2c 207b 7d2c  rocessing'}, {},
-000100d0: 207b 7d0a 0a20 2020 2020 2020 2052 6574   {}..        Ret
-000100e0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-000100f0: 2d2d 2d2d 0a20 2020 2020 2020 2054 7570  ----.        Tup
-00010100: 6c65 206f 663a 0a0a 2020 2020 2020 2020  le of:..        
-00010110: 2d20 4469 6374 696f 6e61 7279 206f 6620  - Dictionary of 
-00010120: 7265 636f 6d6d 656e 6461 7469 6f6e 7320  recommendations 
-00010130: 666f 7220 6675 7475 7265 2074 7261 6e73  for future trans
-00010140: 6974 696f 6e73 207b 6b65 793a 206e 6577  itions {key: new
-00010150: 2073 7461 7465 7d0a 2020 2020 2020 2020   state}.        
-00010160: 2d20 4d65 7373 6167 6573 2074 6f20 636c  - Messages to cl
-00010170: 6965 6e74 7320 7b63 6c69 656e 7420 6164  ients {client ad
-00010180: 6472 6573 733a 205b 6d73 672c 206d 7367  dress: [msg, msg
-00010190: 2c20 2e2e 2e5d 7d0a 2020 2020 2020 2020  , ...]}.        
-000101a0: 2d20 4d65 7373 6167 6573 2074 6f20 776f  - Messages to wo
-000101b0: 726b 6572 7320 7b77 6f72 6b65 7220 6164  rkers {worker ad
-000101c0: 6472 6573 733a 205b 6d73 672c 206d 7367  dress: [msg, msg
-000101d0: 2c20 2e2e 2e5d 7d0a 0a20 2020 2020 2020  , ...]}..       
-000101e0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
-000101f0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-00010200: 2020 2053 6368 6564 756c 6572 2e74 7261     Scheduler.tra
-00010210: 6e73 6974 696f 6e73 203a 2074 7261 6e73  nsitions : trans
-00010220: 6974 6976 6520 7665 7273 696f 6e20 6f66  itive version of
-00010230: 2074 6869 7320 6675 6e63 7469 6f6e 0a20   this function. 
-00010240: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00010250: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00010260: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00010270: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
-00010280: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
-00010290: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000102a0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-000102b0: 7d2c 207b 7d2c 207b 7d0a 2020 2020 2020  }, {}, {}.      
-000102c0: 2020 2020 2020 7374 6172 7420 3d20 7473        start = ts
-000102d0: 2e5f 7374 6174 650a 2020 2020 2020 2020  ._state.        
-000102e0: 2020 2020 6966 2073 7461 7274 203d 3d20      if start == 
-000102f0: 6669 6e69 7368 3a0a 2020 2020 2020 2020  finish:.        
-00010300: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00010310: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2020  }, {}, {}..     
-00010320: 2020 2020 2020 2023 204e 6f74 6573 3a0a         # Notes:.
-00010330: 2020 2020 2020 2020 2020 2020 2320 2d20              # - 
-00010340: 696e 2063 6173 6520 6f66 2074 7261 6e73  in case of trans
-00010350: 6974 696f 6e20 7468 726f 7567 6820 7265  ition through re
-00010360: 6c65 6173 6564 2c20 7468 6973 2063 6f75  leased, this cou
-00010370: 6e74 6572 2069 7320 696e 6372 656d 656e  nter is incremen
-00010380: 7465 6420 6279 2032 0a20 2020 2020 2020  ted by 2.       
-00010390: 2020 2020 2023 202d 2074 6869 7320 696e       # - this in
-000103a0: 6372 6561 7365 2068 6170 7065 6e73 2062  crease happens b
-000103b0: 6566 6f72 6520 7468 6520 6163 7475 616c  efore the actual
-000103c0: 2074 7261 6e73 6974 696f 6e73 2c20 736f   transitions, so
-000103d0: 2074 6861 7420 6974 2063 616e 0a20 2020   that it can.   
-000103e0: 2020 2020 2020 2020 2023 2020 2063 6174           #   cat
-000103f0: 6368 2070 6f74 656e 7469 616c 2069 6e66  ch potential inf
-00010400: 696e 6974 6520 7265 6375 7273 696f 6e73  inite recursions
-00010410: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00010420: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-00010430: 6e74 6572 202b 3d20 310a 2020 2020 2020  nter += 1.      
-00010440: 2020 2020 2020 6966 2073 656c 662e 7472        if self.tr
-00010450: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00010460: 5f6d 6178 3a0a 2020 2020 2020 2020 2020  _max:.          
-00010470: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-00010480: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-00010490: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
-000104a0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
-000104b0: 6178 0a0a 2020 2020 2020 2020 2020 2020  ax..            
-000104c0: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-000104d0: 2064 6963 7420 3d20 7b7d 0a20 2020 2020   dict = {}.     
-000104e0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-000104f0: 6773 3a20 6469 6374 203d 207b 7d0a 2020  gs: dict = {}.  
-00010500: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00010510: 5f6d 7367 733a 2064 6963 7420 3d20 7b7d  _msgs: dict = {}
-00010520: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00010530: 2073 656c 662e 706c 7567 696e 733a 0a20   self.plugins:. 
-00010540: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010550: 6570 656e 6465 6e74 7320 3d20 7365 7428  ependents = set(
-00010560: 7473 2e64 6570 656e 6465 6e74 7329 0a20  ts.dependents). 
-00010570: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00010580: 6570 656e 6465 6e63 6965 7320 3d20 7365  ependencies = se
-00010590: 7428 7473 2e64 6570 656e 6465 6e63 6965  t(ts.dependencie
-000105a0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-000105b0: 6675 6e63 203d 2073 656c 662e 5f54 5241  func = self._TRA
-000105c0: 4e53 4954 494f 4e53 5f54 4142 4c45 2e67  NSITIONS_TABLE.g
-000105d0: 6574 2828 7374 6172 742c 2066 696e 6973  et((start, finis
-000105e0: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
-000105f0: 6966 2066 756e 6320 6973 206e 6f74 204e  if func is not N
-00010600: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00010610: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00010620: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-00010630: 732c 2077 6f72 6b65 725f 6d73 6773 203d  s, worker_msgs =
-00010640: 2066 756e 6328 0a20 2020 2020 2020 2020   func(.         
-00010650: 2020 2020 2020 2020 2020 2073 656c 662c             self,
-00010660: 206b 6579 2c20 7374 696d 756c 7573 5f69   key, stimulus_i
-00010670: 642c 202a 2a6b 7761 7267 730a 2020 2020  d, **kwargs.    
-00010680: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00010690: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-000106a0: 2272 656c 6561 7365 6422 206e 6f74 2069  "released" not i
-000106b0: 6e20 2873 7461 7274 2c20 6669 6e69 7368  n (start, finish
-000106c0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000106d0: 2020 2061 7373 6572 7420 6e6f 7420 6b77     assert not kw
-000106e0: 6172 6773 2c20 286b 7761 7267 732c 2073  args, (kwargs, s
-000106f0: 7461 7274 2c20 6669 6e69 7368 290a 2020  tart, finish).  
-00010700: 2020 2020 2020 2020 2020 2020 2020 615f                a_
-00010710: 7265 6373 2c20 615f 636d 7367 732c 2061  recs, a_cmsgs, a
-00010720: 5f77 6d73 6773 203d 2073 656c 662e 5f74  _wmsgs = self._t
-00010730: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
-00010740: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-00010750: 6579 2c20 2272 656c 6561 7365 6422 2c20  ey, "released", 
-00010760: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
-00010770: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00010780: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00010790: 203d 2061 5f72 6563 732e 6765 7428 6b65   = a_recs.get(ke
-000107a0: 792c 2066 696e 6973 6829 0a20 2020 2020  y, finish).     
-000107b0: 2020 2020 2020 2020 2020 2066 756e 6320             func 
-000107c0: 3d20 7365 6c66 2e5f 5452 414e 5349 5449  = self._TRANSITI
-000107d0: 4f4e 535f 5441 424c 455b 2272 656c 6561  ONS_TABLE["relea
-000107e0: 7365 6422 2c20 765d 0a20 2020 2020 2020  sed", v].       
-000107f0: 2020 2020 2020 2020 2062 5f72 6563 732c           b_recs,
-00010800: 2062 5f63 6d73 6773 2c20 625f 776d 7367   b_cmsgs, b_wmsg
-00010810: 7320 3d20 6675 6e63 2873 656c 662c 206b  s = func(self, k
-00010820: 6579 2c20 7374 696d 756c 7573 5f69 6429  ey, stimulus_id)
-00010830: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00010840: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00010850: 732e 7570 6461 7465 2861 5f72 6563 7329  s.update(a_recs)
-00010860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010870: 2066 6f72 2063 2c20 6e65 775f 6d73 6773   for c, new_msgs
-00010880: 2069 6e20 615f 636d 7367 732e 6974 656d   in a_cmsgs.item
-00010890: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000108a0: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-000108b0: 6d73 6773 2e73 6574 6465 6661 756c 7428  msgs.setdefault(
-000108c0: 632c 205b 5d29 2e65 7874 656e 6428 6e65  c, []).extend(ne
-000108d0: 775f 6d73 6773 290a 2020 2020 2020 2020  w_msgs).        
-000108e0: 2020 2020 2020 2020 666f 7220 772c 206e          for w, n
-000108f0: 6577 5f6d 7367 7320 696e 2061 5f77 6d73  ew_msgs in a_wms
-00010900: 6773 2e69 7465 6d73 2829 3a0a 2020 2020  gs.items():.    
-00010910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010920: 776f 726b 6572 5f6d 7367 732e 7365 7464  worker_msgs.setd
-00010930: 6566 6175 6c74 2877 2c20 5b5d 292e 6578  efault(w, []).ex
-00010940: 7465 6e64 286e 6577 5f6d 7367 7329 0a0a  tend(new_msgs)..
-00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010960: 7265 636f 6d6d 656e 6461 7469 6f6e 732e  recommendations.
-00010970: 7570 6461 7465 2862 5f72 6563 7329 0a20  update(b_recs). 
-00010980: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010990: 6f72 2063 2c20 6e65 775f 6d73 6773 2069  or c, new_msgs i
-000109a0: 6e20 625f 636d 7367 732e 6974 656d 7328  n b_cmsgs.items(
-000109b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000109c0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
-000109d0: 6773 2e73 6574 6465 6661 756c 7428 632c  gs.setdefault(c,
-000109e0: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
-000109f0: 6d73 6773 290a 2020 2020 2020 2020 2020  msgs).          
-00010a00: 2020 2020 2020 666f 7220 772c 206e 6577        for w, new
-00010a10: 5f6d 7367 7320 696e 2062 5f77 6d73 6773  _msgs in b_wmsgs
-00010a20: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00010a30: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-00010a40: 726b 6572 5f6d 7367 732e 7365 7464 6566  rker_msgs.setdef
-00010a50: 6175 6c74 2877 2c20 5b5d 292e 6578 7465  ault(w, []).exte
-00010a60: 6e64 286e 6577 5f6d 7367 7329 0a0a 2020  nd(new_msgs)..  
-00010a70: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00010a80: 6172 7420 3d20 2272 656c 6561 7365 6422  art = "released"
-00010a90: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00010aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00010ab0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
-00010ac0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-00010ad0: 2020 2020 2020 2020 2020 2066 2249 6d70             f"Imp
-00010ae0: 6f73 7369 626c 6520 7472 616e 7369 7469  ossible transiti
-00010af0: 6f6e 2066 726f 6d20 7b73 7461 7274 7d20  on from {start} 
-00010b00: 746f 207b 6669 6e69 7368 7d20 666f 7220  to {finish} for 
-00010b10: 7b6b 6579 2172 7d3a 2022 0a20 2020 2020  {key!r}: ".     
-00010b20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00010b30: 227b 7374 696d 756c 7573 5f69 643d 7d2c  "{stimulus_id=},
-00010b40: 207b 6b77 6172 6773 3d7d 2c20 7374 6f72   {kwargs=}, stor
-00010b50: 793d 7b73 656c 662e 7374 6f72 7928 7473  y={self.story(ts
-00010b60: 297d 220a 2020 2020 2020 2020 2020 2020  )}".            
-00010b70: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00010b80: 2020 2069 6620 6e6f 7420 7374 696d 756c     if not stimul
-00010b90: 7573 5f69 643a 0a20 2020 2020 2020 2020  us_id:.         
-00010ba0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-00010bb0: 6964 203d 2053 5449 4d55 4c55 535f 4944  id = STIMULUS_ID
-00010bc0: 5f55 4e53 4554 0a0a 2020 2020 2020 2020  _UNSET..        
-00010bd0: 2020 2020 6163 7475 616c 5f66 696e 6973      actual_finis
-00010be0: 6820 3d20 7473 2e5f 7374 6174 650a 2020  h = ts._state.  
-00010bf0: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-00010c00: 7261 6e73 6974 696f 6e5f 6c6f 672e 6170  ransition_log.ap
-00010c10: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00010c20: 2020 2020 2020 5472 616e 7369 7469 6f6e        Transition
-00010c30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010c40: 2020 2020 2020 6b65 792c 2073 7461 7274        key, start
-00010c50: 2c20 6163 7475 616c 5f66 696e 6973 682c  , actual_finish,
-00010c60: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00010c70: 2c20 7374 696d 756c 7573 5f69 642c 2074  , stimulus_id, t
-00010c80: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
-00010c90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00010ca0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00010cb0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00010cc0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00010cd0: 2020 2020 6966 2073 7469 6d75 6c75 735f      if stimulus_
-00010ce0: 6964 203d 3d20 5354 494d 554c 5553 5f49  id == STIMULUS_I
-00010cf0: 445f 554e 5345 543a 0a20 2020 2020 2020  D_UNSET:.       
-00010d00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00010d10: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
-00010d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d30: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-00010d40: 7573 5f69 6420 6e6f 7420 7365 7420 6475  us_id not set du
-00010d50: 7269 6e67 2053 6368 6564 756c 6572 2074  ring Scheduler t
-00010d60: 7261 6e73 6974 696f 6e22 0a20 2020 2020  ransition".     
-00010d70: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00010d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010d90: 206c 6f67 6765 722e 6465 6275 6728 0a20   logger.debug(. 
-00010da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010db0: 2020 2022 5472 616e 7369 7469 6f6e 6564     "Transitioned
-00010dc0: 2025 7220 2573 2d3e 2573 2028 6163 7475   %r %s->%s (actu
-00010dd0: 616c 3a20 2573 292e 2020 436f 6e73 6571  al: %s).  Conseq
-00010de0: 7565 6e63 653a 2025 7322 2c0a 2020 2020  uence: %s",.    
-00010df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e00: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-00010e10: 2020 2020 2020 2020 2073 7461 7274 2c0a           start,.
-00010e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e30: 2020 2020 6669 6e69 7368 2c0a 2020 2020      finish,.    
-00010e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e50: 6163 7475 616c 5f66 696e 6973 682c 0a20  actual_finish,. 
-00010e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e70: 2020 2064 6963 7428 7265 636f 6d6d 656e     dict(recommen
-00010e80: 6461 7469 6f6e 7329 2c0a 2020 2020 2020  dations),.      
-00010e90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00010ea0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00010eb0: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
-00010ec0: 2020 2020 2020 2020 2023 2054 656d 706f           # Tempo
-00010ed0: 7261 7269 6c79 2070 7574 2062 6163 6b20  rarily put back 
-00010ee0: 666f 7267 6f74 7465 6e20 6b65 7920 666f  forgotten key fo
-00010ef0: 7220 706c 7567 696e 2074 6f20 7265 7472  r plugin to retr
-00010f00: 6965 7665 2069 740a 2020 2020 2020 2020  ieve it.        
-00010f10: 2020 2020 2020 2020 6966 2074 732e 5f73          if ts._s
-00010f20: 7461 7465 203d 3d20 2266 6f72 676f 7474  tate == "forgott
-00010f30: 656e 223a 0a20 2020 2020 2020 2020 2020  en":.           
-00010f40: 2020 2020 2020 2020 2074 732e 6465 7065           ts.depe
-00010f50: 6e64 656e 7473 203d 2064 6570 656e 6465  ndents = depende
-00010f60: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-00010f70: 2020 2020 2020 2020 7473 2e64 6570 656e          ts.depen
-00010f80: 6465 6e63 6965 7320 3d20 6465 7065 6e64  dencies = depend
-00010f90: 656e 6369 6573 0a20 2020 2020 2020 2020  encies.         
-00010fa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010fb0: 7461 736b 735b 7473 2e6b 6579 5d20 3d20  tasks[ts.key] = 
-00010fc0: 7473 0a20 2020 2020 2020 2020 2020 2020  ts.             
-00010fd0: 2020 2066 6f72 2070 6c75 6769 6e20 696e     for plugin in
-00010fe0: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
-00010ff0: 6e73 2e76 616c 7565 7328 2929 3a0a 2020  ns.values()):.  
-00011000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011010: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00011020: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00011030: 6c75 6769 6e2e 7472 616e 7369 7469 6f6e  lugin.transition
-00011040: 286b 6579 2c20 7374 6172 742c 2061 6374  (key, start, act
-00011050: 7561 6c5f 6669 6e69 7368 2c20 2a2a 6b77  ual_finish, **kw
-00011060: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-00011070: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00011080: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110a0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-000110b0: 2250 6c75 6769 6e20 6661 696c 6564 2077  "Plugin failed w
-000110c0: 6974 6820 6578 6365 7074 696f 6e22 2c20  ith exception", 
-000110d0: 6578 635f 696e 666f 3d54 7275 6529 0a20  exc_info=True). 
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000110f0: 6620 7473 2e73 7461 7465 203d 3d20 2266  f ts.state == "f
-00011100: 6f72 676f 7474 656e 223a 0a20 2020 2020  orgotten":.     
-00011110: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00011120: 656c 2073 656c 662e 7461 736b 735b 7473  el self.tasks[ts
-00011130: 2e6b 6579 5d0a 0a20 2020 2020 2020 2020  .key]..         
-00011140: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
-00011150: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011160: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
-00011170: 676f 7474 656e 2220 616e 6420 7467 2e6e  gotten" and tg.n
-00011180: 616d 6520 696e 2073 656c 662e 7461 736b  ame in self.task
-00011190: 5f67 726f 7570 733a 0a20 2020 2020 2020  _groups:.       
-000111a0: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
-000111b0: 6520 5461 736b 4772 6f75 7020 6966 2061  e TaskGroup if a
-000111c0: 6c6c 2074 6173 6b73 2061 7265 2069 6e20  ll tasks are in 
-000111d0: 7468 6520 666f 7267 6f74 7465 6e20 7374  the forgotten st
-000111e0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-000111f0: 2020 2020 6966 2061 6c6c 2876 203d 3d20      if all(v == 
-00011200: 3020 6f72 206b 203d 3d20 2266 6f72 676f  0 or k == "forgo
-00011210: 7474 656e 2220 666f 7220 6b2c 2076 2069  tten" for k, v i
-00011220: 6e20 7467 2e73 7461 7465 732e 6974 656d  n tg.states.item
-00011230: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00011240: 2020 2020 2020 2020 2020 7473 2e70 7265            ts.pre
-00011250: 6669 782e 6772 6f75 7073 2e72 656d 6f76  fix.groups.remov
-00011260: 6528 7467 290a 2020 2020 2020 2020 2020  e(tg).          
-00011270: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-00011280: 6c66 2e74 6173 6b5f 6772 6f75 7073 5b74  lf.task_groups[t
-00011290: 672e 6e61 6d65 5d0a 0a20 2020 2020 2020  g.name]..       
-000112a0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-000112b0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-000112c0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-000112d0: 5f6d 7367 730a 2020 2020 2020 2020 6578  _msgs.        ex
-000112e0: 6365 7074 2045 7863 6570 7469 6f6e 3a0a  cept Exception:.
-000112f0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00011300: 6572 2e65 7863 6570 7469 6f6e 2822 4572  er.exception("Er
-00011310: 726f 7220 7472 616e 7369 7469 6f6e 696e  ror transitionin
-00011320: 6720 2572 2066 726f 6d20 2572 2074 6f20  g %r from %r to 
-00011330: 2572 222c 206b 6579 2c20 7374 6172 742c  %r", key, start,
-00011340: 2066 696e 6973 6829 0a20 2020 2020 2020   finish).       
-00011350: 2020 2020 2069 6620 4c4f 475f 5044 423a       if LOG_PDB:
-00011360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011370: 2069 6d70 6f72 7420 7064 620a 0a20 2020   import pdb..   
-00011380: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
-00011390: 2e73 6574 5f74 7261 6365 2829 0a20 2020  .set_trace().   
-000113a0: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-000113b0: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
-000113c0: 696f 6e73 280a 2020 2020 2020 2020 7365  ions(.        se
-000113d0: 6c66 2c0a 2020 2020 2020 2020 7265 636f  lf,.        reco
-000113e0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-000113f0: 732c 0a20 2020 2020 2020 2063 6c69 656e  s,.        clien
-00011400: 745f 6d73 6773 3a20 4d73 6773 2c0a 2020  t_msgs: Msgs,.  
-00011410: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
-00011420: 733a 204d 7367 732c 0a20 2020 2020 2020  s: Msgs,.       
-00011430: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00011440: 722c 0a20 2020 2029 202d 3e20 4e6f 6e65  r,.    ) -> None
-00011450: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
-00011460: 6365 7373 2074 7261 6e73 6974 696f 6e73  cess transitions
-00011470: 2075 6e74 696c 206e 6f6e 6520 6172 6520   until none are 
-00011480: 6c65 6674 0a0a 2020 2020 2020 2020 5468  left..        Th
-00011490: 6973 2069 6e63 6c75 6465 7320 6665 6564  is includes feed
-000114a0: 6261 636b 2066 726f 6d20 7072 6576 696f  back from previo
-000114b0: 7573 2074 7261 6e73 6974 696f 6e73 2061  us transitions a
-000114c0: 6e64 2063 6f6e 7469 6e75 6573 2075 6e74  nd continues unt
-000114d0: 696c 2077 650a 2020 2020 2020 2020 7265  il we.        re
-000114e0: 6163 6820 6120 7374 6561 6479 2073 7461  ach a steady sta
-000114f0: 7465 0a20 2020 2020 2020 2022 2222 0a20  te.        """. 
-00011500: 2020 2020 2020 206b 6579 733a 2073 6574         keys: set
-00011510: 5b73 7472 5d20 3d20 7365 7428 290a 2020  [str] = set().  
-00011520: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00011530: 7469 6f6e 7320 3d20 7265 636f 6d6d 656e  tions = recommen
-00011540: 6461 7469 6f6e 732e 636f 7079 2829 0a0a  dations.copy()..
-00011550: 2020 2020 2020 2020 7768 696c 6520 7265          while re
-00011560: 636f 6d6d 656e 6461 7469 6f6e 733a 0a20  commendations:. 
-00011570: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00011580: 6669 6e69 7368 203d 2072 6563 6f6d 6d65  finish = recomme
-00011590: 6e64 6174 696f 6e73 2e70 6f70 6974 656d  ndations.popitem
-000115a0: 2829 0a20 2020 2020 2020 2020 2020 206b  ().            k
-000115b0: 6579 732e 6164 6428 6b65 7929 0a0a 2020  eys.add(key)..  
-000115c0: 2020 2020 2020 2020 2020 6e65 775f 7265            new_re
-000115d0: 6373 2c20 6e65 775f 636d 7367 732c 206e  cs, new_cmsgs, n
-000115e0: 6577 5f77 6d73 6773 203d 2073 656c 662e  ew_wmsgs = self.
-000115f0: 5f74 7261 6e73 6974 696f 6e28 6b65 792c  _transition(key,
-00011600: 2066 696e 6973 682c 2073 7469 6d75 6c75   finish, stimulu
-00011610: 735f 6964 290a 0a20 2020 2020 2020 2020  s_id)..         
-00011620: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00011630: 6e73 2e75 7064 6174 6528 6e65 775f 7265  ns.update(new_re
-00011640: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
-00011650: 666f 7220 632c 206e 6577 5f6d 7367 7320  for c, new_msgs 
-00011660: 696e 206e 6577 5f63 6d73 6773 2e69 7465  in new_cmsgs.ite
-00011670: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00011680: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-00011690: 732e 7365 7464 6566 6175 6c74 2863 2c20  s.setdefault(c, 
-000116a0: 5b5d 292e 6578 7465 6e64 286e 6577 5f6d  []).extend(new_m
-000116b0: 7367 7329 0a20 2020 2020 2020 2020 2020  sgs).           
-000116c0: 2066 6f72 2077 2c20 6e65 775f 6d73 6773   for w, new_msgs
-000116d0: 2069 6e20 6e65 775f 776d 7367 732e 6974   in new_wmsgs.it
-000116e0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-000116f0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00011700: 6773 2e73 6574 6465 6661 756c 7428 772c  gs.setdefault(w,
-00011710: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
-00011720: 6d73 6773 290a 0a20 2020 2020 2020 2069  msgs)..        i
-00011730: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00011740: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00011750: 4958 4d45 2064 6f77 6e63 6173 7420 616e  IXME downcast an
-00011760: 7469 7061 7474 6572 6e0a 2020 2020 2020  tipattern.      
-00011770: 2020 2020 2020 7363 6865 6475 6c65 7220        scheduler 
-00011780: 3d20 6361 7374 2853 6368 6564 756c 6572  = cast(Scheduler
-00011790: 2c20 7365 6c66 290a 2020 2020 2020 2020  , self).        
-000117a0: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-000117b0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-000117c0: 2020 2020 2073 6368 6564 756c 6572 2e76       scheduler.v
-000117d0: 616c 6964 6174 655f 6b65 7928 6b65 7929  alidate_key(key)
-000117e0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-000117f0: 7469 6f6e 5f72 656c 6561 7365 645f 7761  tion_released_wa
-00011800: 6974 696e 6728 7365 6c66 2c20 6b65 793a  iting(self, key:
-00011810: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00011820: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00011830: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00011840: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00011850: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00011860: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00011870: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00011880: 7473 2e72 756e 5f73 7065 630a 2020 2020  ts.run_spec.    
-00011890: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000118a0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-000118b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000118c0: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-000118d0: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-000118e0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-000118f0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-00011900: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00011910: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-00011920: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00011930: 2020 2061 7373 6572 7420 6474 732e 7374     assert dts.st
-00011940: 6174 6520 6e6f 7420 696e 207b 2266 6f72  ate not in {"for
-00011950: 676f 7474 656e 222c 2022 6572 7265 6422  gotten", "erred"
-00011960: 7d0a 0a20 2020 2020 2020 2069 6620 7473  }..        if ts
-00011970: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
-00011980: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00011990: 2020 2020 7265 7475 726e 207b 6b65 793a      return {key:
-000119a0: 2022 666f 7267 6f74 7465 6e22 7d2c 207b   "forgotten"}, {
-000119b0: 7d2c 207b 7d0a 0a20 2020 2020 2020 2074  }, {}..        t
-000119c0: 732e 7374 6174 6520 3d20 2277 6169 7469  s.state = "waiti
-000119d0: 6e67 220a 0a20 2020 2020 2020 2072 6563  ng"..        rec
-000119e0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-000119f0: 6373 203d 207b 7d0a 0a20 2020 2020 2020  cs = {}..       
-00011a00: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-00011a10: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-00011a20: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00011a30: 6474 732e 7768 6f5f 6861 733a 0a20 2020  dts.who_has:.   
-00011a40: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-00011a50: 7761 6974 696e 675f 6f6e 2e61 6464 2864  waiting_on.add(d
-00011a60: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-00011a70: 6966 2064 7473 2e73 7461 7465 203d 3d20  if dts.state == 
-00011a80: 2272 656c 6561 7365 6422 3a0a 2020 2020  "released":.    
-00011a90: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00011aa0: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
-00011ab0: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
-00011ac0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00011ad0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00011ae0: 2020 2064 7473 2e77 6169 7465 7273 2e61     dts.waiters.a
-00011af0: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
-00011b00: 7473 2e77 6169 7465 7273 203d 207b 6474  ts.waiters = {dt
-00011b10: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
-00011b20: 6465 7065 6e64 656e 7473 2069 6620 6474  dependents if dt
-00011b30: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
-00011b40: 696e 6722 7d0a 0a20 2020 2020 2020 2069  ing"}..        i
-00011b50: 6620 6e6f 7420 7473 2e77 6169 7469 6e67  f not ts.waiting
-00011b60: 5f6f 6e3a 0a20 2020 2020 2020 2020 2020  _on:.           
-00011b70: 2023 204e 4f54 453a 2077 6169 7469 6e67   # NOTE: waiting
-00011b80: 2d3e 7072 6f63 6573 7369 6e67 2077 696c  ->processing wil
-00011b90: 6c20 7365 6e64 2074 6173 6b73 2074 6f20  l send tasks to 
-00011ba0: 7175 6575 6564 206f 7220 6e6f 2d77 6f72  queued or no-wor
-00011bb0: 6b65 7220 6173 0a20 2020 2020 2020 2020  ker as.         
-00011bc0: 2020 2023 206e 6563 6573 7361 7279 0a20     # necessary. 
-00011bd0: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00011be0: 6d65 6e64 6174 696f 6e73 5b6b 6579 5d20  mendations[key] 
-00011bf0: 3d20 2270 726f 6365 7373 696e 6722 0a0a  = "processing"..
-00011c00: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00011c10: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00011c20: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
-00011c30: 7472 616e 7369 7469 6f6e 5f6e 6f5f 776f  transition_no_wo
-00011c40: 726b 6572 5f70 726f 6365 7373 696e 6728  rker_processing(
-00011c50: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00011c60: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00011c70: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00011c80: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00011c90: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00011ca0: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
-00011cb0: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
-00011cc0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00011cd0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00011ce0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00011cf0: 6163 746f 722c 2066 2241 6374 6f72 7320  actor, f"Actors 
-00011d00: 6361 6e27 7420 6265 2069 6e20 606e 6f2d  can't be in `no-
-00011d10: 776f 726b 6572 603a 207b 7473 7d22 0a20  worker`: {ts}". 
+0000d370: 0a0a 2020 2020 233a 2057 6f72 6b65 7273  ..    #: Workers
+0000d380: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
+0000d390: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
+0000d3a0: 6475 6c65 720a 2020 2020 233a 2028 6163  duler.    #: (ac
+0000d3b0: 7475 616c 6c79 2061 2053 6f72 7465 6444  tually a SortedD
+0000d3c0: 6963 742c 2062 7574 2074 6865 2073 6f72  ict, but the sor
+0000d3d0: 7465 6463 6f6e 7461 696e 6572 7320 7061  tedcontainers pa
+0000d3e0: 636b 6167 6520 6973 6e27 7420 616e 6e6f  ckage isn't anno
+0000d3f0: 7461 7465 6429 0a20 2020 2077 6f72 6b65  tated).    worke
+0000d400: 7273 3a20 6469 6374 5b73 7472 2c20 576f  rs: dict[str, Wo
+0000d410: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
+0000d420: 3a20 576f 726b 6572 207b 6e61 6d65 3a20  : Worker {name: 
+0000d430: 6164 6472 6573 737d 0a20 2020 2061 6c69  address}.    ali
+0000d440: 6173 6573 3a20 6469 6374 5b48 6173 6861  ases: dict[Hasha
+0000d450: 626c 652c 2073 7472 5d0a 2020 2020 233a  ble, str].    #:
+0000d460: 2057 6f72 6b65 7273 2074 6861 7420 6172   Workers that ar
+0000d470: 6520 6375 7272 656e 746c 7920 696e 2072  e currently in r
+0000d480: 756e 6e69 6e67 2073 7461 7465 0a20 2020  unning state.   
+0000d490: 2072 756e 6e69 6e67 3a20 7365 745b 576f   running: set[Wo
+0000d4a0: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
+0000d4b0: 3a20 576f 726b 6572 7320 7468 6174 2061  : Workers that a
+0000d4c0: 7265 2063 7572 7265 6e74 6c79 2069 6e20  re currently in 
+0000d4d0: 7275 6e6e 696e 6720 7374 6174 6520 616e  running state an
+0000d4e0: 6420 6e6f 7420 6675 6c6c 7920 7574 696c  d not fully util
+0000d4f0: 697a 6564 0a20 2020 2023 3a20 4465 6669  ized.    #: Defi
+0000d500: 6e69 7469 6f6e 2062 6173 6564 206f 6e20  nition based on 
+0000d510: 6f63 6375 7061 6e63 790a 2020 2020 233a  occupancy.    #:
+0000d520: 2028 6163 7475 616c 6c79 2061 2053 6f72   (actually a Sor
+0000d530: 7465 6444 6963 742c 2062 7574 2074 6865  tedDict, but the
+0000d540: 2073 6f72 7465 6463 6f6e 7461 696e 6572   sortedcontainer
+0000d550: 7320 7061 636b 6167 6520 6973 6e27 7420  s package isn't 
+0000d560: 616e 6e6f 7461 7465 6429 2e0a 2020 2020  annotated)..    
+0000d570: 233a 204e 6f74 2074 6f20 6265 2063 6f6e  #: Not to be con
+0000d580: 6675 7365 6420 7769 7468 203a 6d65 7468  fused with :meth
+0000d590: 3a60 6973 5f69 646c 6560 2e0a 2020 2020  :`is_idle`..    
+0000d5a0: 6964 6c65 3a20 6469 6374 5b73 7472 2c20  idle: dict[str, 
+0000d5b0: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
+0000d5c0: 2023 3a20 5369 6d69 6c61 7220 746f 2060   #: Similar to `
+0000d5d0: 6964 6c65 600a 2020 2020 233a 2044 6566  idle`.    #: Def
+0000d5e0: 696e 6974 696f 6e20 6261 7365 6420 6f6e  inition based on
+0000d5f0: 2061 7373 6967 6e65 6420 7461 736b 730a   assigned tasks.
+0000d600: 2020 2020 6964 6c65 5f74 6173 6b5f 636f      idle_task_co
+0000d610: 756e 743a 2073 6574 5b57 6f72 6b65 7253  unt: set[WorkerS
+0000d620: 7461 7465 5d0a 2020 2020 233a 2057 6f72  tate].    #: Wor
+0000d630: 6b65 7273 2074 6861 7420 6172 6520 6675  kers that are fu
+0000d640: 6c6c 7920 7574 696c 697a 6564 2e20 4d61  lly utilized. Ma
+0000d650: 7920 696e 636c 7564 6520 6e6f 6e2d 7275  y include non-ru
+0000d660: 6e6e 696e 6720 776f 726b 6572 732e 0a20  nning workers.. 
+0000d670: 2020 2073 6174 7572 6174 6564 3a20 7365     saturated: se
+0000d680: 745b 576f 726b 6572 5374 6174 655d 0a20  t[WorkerState]. 
+0000d690: 2020 2023 3a20 4375 7272 656e 7420 6e75     #: Current nu
+0000d6a0: 6d62 6572 206f 6620 7468 7265 6164 7320  mber of threads 
+0000d6b0: 6163 726f 7373 2061 6c6c 2077 6f72 6b65  across all worke
+0000d6c0: 7273 0a20 2020 2074 6f74 616c 5f6e 7468  rs.    total_nth
+0000d6d0: 7265 6164 733a 2069 6e74 0a20 2020 2023  reads: int.    #
+0000d6e0: 3a20 4869 7374 6f72 7920 6f66 206e 756d  : History of num
+0000d6f0: 6265 7220 6f66 2074 6872 6561 6473 0a20  ber of threads. 
+0000d700: 2020 2023 3a20 2874 696d 6573 7461 6d70     #: (timestamp
+0000d710: 2c20 6e65 7720 6e75 6d62 6572 206f 6620  , new number of 
+0000d720: 7468 7265 6164 7329 0a20 2020 2074 6f74  threads).    tot
+0000d730: 616c 5f6e 7468 7265 6164 735f 6869 7374  al_nthreads_hist
+0000d740: 6f72 793a 206c 6973 745b 7475 706c 655b  ory: list[tuple[
+0000d750: 666c 6f61 742c 2069 6e74 5d5d 0a20 2020  float, int]].   
+0000d760: 2023 3a20 436c 7573 7465 722d 7769 6465   #: Cluster-wide
+0000d770: 2072 6573 6f75 7263 6573 2e20 7b72 6573   resources. {res
+0000d780: 6f75 7263 6520 6e61 6d65 3a20 7b77 6f72  ource name: {wor
+0000d790: 6b65 7220 6164 6472 6573 733a 2061 6d6f  ker address: amo
+0000d7a0: 756e 747d 7d0a 2020 2020 7265 736f 7572  unt}}.    resour
+0000d7b0: 6365 733a 2064 6963 745b 7374 722c 2064  ces: dict[str, d
+0000d7c0: 6963 745b 7374 722c 2066 6c6f 6174 5d5d  ict[str, float]]
+0000d7d0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+0000d7e0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+0000d7f0: 2320 5461 736b 732d 7265 6c61 7465 6420  # Tasks-related 
+0000d800: 7374 6174 650a 2020 2020 2323 2323 2323  state.    ######
+0000d810: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000d820: 0a20 2020 2023 3a20 546f 7461 6c20 6e75  .    #: Total nu
+0000d830: 6d62 6572 206f 6620 7461 736b 7320 6576  mber of tasks ev
+0000d840: 6572 2070 726f 6365 7373 6564 0a20 2020  er processed.   
+0000d850: 206e 5f74 6173 6b73 3a20 696e 740a 0a20   n_tasks: int.. 
+0000d860: 2020 2023 3a20 416c 6c20 7461 736b 7320     #: All tasks 
+0000d870: 6375 7272 656e 746c 7920 6b6e 6f77 6e20  currently known 
+0000d880: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
+0000d890: 0a20 2020 2074 6173 6b73 3a20 6469 6374  .    tasks: dict
+0000d8a0: 5b73 7472 2c20 5461 736b 5374 6174 655d  [str, TaskState]
+0000d8b0: 0a0a 2020 2020 233a 2054 6173 6b73 2069  ..    #: Tasks i
+0000d8c0: 6e20 7468 6520 2271 7565 7565 6422 2073  n the "queued" s
+0000d8d0: 7461 7465 2c20 6f72 6465 7265 6420 6279  tate, ordered by
+0000d8e0: 2070 7269 6f72 6974 790a 2020 2020 7175   priority.    qu
+0000d8f0: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
+0000d900: 736b 5374 6174 655d 0a0a 2020 2020 233a  skState]..    #:
+0000d910: 2054 6173 6b73 2069 6e20 7468 6520 226e   Tasks in the "n
+0000d920: 6f2d 776f 726b 6572 2220 7374 6174 650a  o-worker" state.
+0000d930: 2020 2020 756e 7275 6e6e 6162 6c65 3a20      unrunnable: 
+0000d940: 7365 745b 5461 736b 5374 6174 655d 0a0a  set[TaskState]..
+0000d950: 2020 2020 233a 2053 7562 7365 7420 6f66      #: Subset of
+0000d960: 2074 6173 6b73 2074 6861 7420 6578 6973   tasks that exis
+0000d970: 7420 696e 206d 656d 6f72 7920 6f6e 206d  t in memory on m
+0000d980: 6f72 6520 7468 616e 206f 6e65 2077 6f72  ore than one wor
+0000d990: 6b65 720a 2020 2020 7265 706c 6963 6174  ker.    replicat
+0000d9a0: 6564 5f74 6173 6b73 3a20 7365 745b 5461  ed_tasks: set[Ta
+0000d9b0: 736b 5374 6174 655d 0a0a 2020 2020 756e  skState]..    un
+0000d9c0: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 733a  known_durations:
+0000d9d0: 2064 6963 745b 7374 722c 2073 6574 5b54   dict[str, set[T
+0000d9e0: 6173 6b53 7461 7465 5d5d 0a20 2020 2074  askState]].    t
+0000d9f0: 6173 6b5f 6772 6f75 7073 3a20 6469 6374  ask_groups: dict
+0000da00: 5b73 7472 2c20 5461 736b 4772 6f75 705d  [str, TaskGroup]
+0000da10: 0a20 2020 2074 6173 6b5f 7072 6566 6978  .    task_prefix
+0000da20: 6573 3a20 6469 6374 5b73 7472 2c20 5461  es: dict[str, Ta
+0000da30: 736b 5072 6566 6978 5d0a 2020 2020 7461  skPrefix].    ta
+0000da40: 736b 5f6d 6574 6164 6174 613a 2064 6963  sk_metadata: dic
+0000da50: 745b 7374 722c 2041 6e79 5d0a 0a20 2020  t[str, Any]..   
+0000da60: 2023 2323 2323 2323 2323 0a20 2020 2023   #########.    #
+0000da70: 2048 6973 746f 7279 0a20 2020 2023 2323   History.    ###
+0000da80: 2323 2323 2323 0a0a 2020 2020 233a 2048  ######..    #: H
+0000da90: 6973 746f 7279 206f 6620 636f 6d70 7574  istory of comput
+0000daa0: 6174 696f 6e73 2e0a 2020 2020 233a 2054  ations..    #: T
+0000dab0: 6865 206c 656e 6774 6820 6361 6e20 6265  he length can be
+0000dac0: 2074 7765 616b 6564 2074 6872 6f75 6768   tweaked through
+0000dad0: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000dae0: 7465 642e 6469 6167 6e6f 7374 6963 732e  ted.diagnostics.
+0000daf0: 636f 6d70 7574 6174 696f 6e73 2e6d 6178  computations.max
+0000db00: 2d68 6973 746f 7279 0a20 2020 2063 6f6d  -history.    com
+0000db10: 7075 7461 7469 6f6e 733a 2064 6571 7565  putations: deque
+0000db20: 5b43 6f6d 7075 7461 7469 6f6e 5d0a 0a20  [Computation].. 
+0000db30: 2020 2023 3a20 4869 7374 6f72 7920 6f66     #: History of
+0000db40: 2065 7272 6564 2074 6173 6b73 2e0a 2020   erred tasks..  
+0000db50: 2020 233a 2054 6865 206c 656e 6774 6820    #: The length 
+0000db60: 6361 6e20 6265 2074 7765 616b 6564 2074  can be tweaked t
+0000db70: 6872 6f75 6768 0a20 2020 2023 3a20 6469  hrough.    #: di
+0000db80: 7374 7269 6275 7465 642e 6469 6167 6e6f  stributed.diagno
+0000db90: 7374 6963 732e 6572 7265 642d 7461 736b  stics.erred-task
+0000dba0: 732e 6d61 782d 6869 7374 6f72 790a 2020  s.max-history.  
+0000dbb0: 2020 6572 7265 645f 7461 736b 733a 2064    erred_tasks: d
+0000dbc0: 6571 7565 5b45 7272 6564 5461 736b 5d0a  eque[ErredTask].
+0000dbd0: 0a20 2020 2023 3a20 4869 7374 6f72 7920  .    #: History 
+0000dbe0: 6f66 2074 6173 6b20 7374 6174 6520 7472  of task state tr
+0000dbf0: 616e 7369 7469 6f6e 732e 0a20 2020 2023  ansitions..    #
+0000dc00: 3a20 5468 6520 6c65 6e67 7468 2063 616e  : The length can
+0000dc10: 2062 6520 7477 6561 6b65 6420 7468 726f   be tweaked thro
+0000dc20: 7567 680a 2020 2020 233a 2064 6973 7472  ugh.    #: distr
+0000dc30: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0000dc40: 2e74 7261 6e73 6974 696f 6e2d 6c6f 672d  .transition-log-
+0000dc50: 6c65 6e67 7468 0a20 2020 2074 7261 6e73  length.    trans
+0000dc60: 6974 696f 6e5f 6c6f 673a 2064 6571 7565  ition_log: deque
+0000dc70: 5b54 7261 6e73 6974 696f 6e5d 0a0a 2020  [Transition]..  
+0000dc80: 2020 233a 2054 6f74 616c 206e 756d 6265    #: Total numbe
+0000dc90: 7220 6f66 2074 7261 6e73 6974 696f 6e73  r of transitions
+0000dca0: 2073 696e 6365 2074 6865 2063 6c75 7374   since the clust
+0000dcb0: 6572 2077 6173 2073 7461 7274 6564 0a20  er was started. 
+0000dcc0: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
+0000dcd0: 756e 7465 723a 2069 6e74 0a0a 2020 2020  unter: int..    
+0000dce0: 233a 2054 6f74 616c 206e 756d 6265 7220  #: Total number 
+0000dcf0: 6f66 2074 7261 6e73 6974 696f 6e73 2061  of transitions a
+0000dd00: 7320 6f66 2074 6865 2070 7265 7669 6f75  s of the previou
+0000dd10: 7320 6361 6c6c 2074 6f20 6368 6563 6b5f  s call to check_
+0000dd20: 6964 6c65 2829 0a20 2020 205f 6964 6c65  idle().    _idle
+0000dd30: 5f74 7261 6e73 6974 696f 6e5f 636f 756e  _transition_coun
+0000dd40: 7465 723a 2069 6e74 0a0a 2020 2020 233a  ter: int..    #:
+0000dd50: 2052 6169 7365 2061 6e20 6572 726f 7220   Raise an error 
+0000dd60: 6966 2074 6865 203a 6174 7472 3a60 7472  if the :attr:`tr
+0000dd70: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0000dd80: 6020 6576 6572 2072 6561 6368 6573 2074  ` ever reaches t
+0000dd90: 6869 7320 7661 6c75 652e 0a20 2020 2023  his value..    #
+0000dda0: 3a20 5468 6973 2069 7320 6d65 616e 7420  : This is meant 
+0000ddb0: 666f 7220 6465 6275 6767 696e 6720 6f6e  for debugging on
+0000ddc0: 6c79 2c20 746f 2063 6174 6368 2069 6e66  ly, to catch inf
+0000ddd0: 696e 6974 6520 7265 6375 7273 696f 6e20  inite recursion 
+0000dde0: 6c6f 6f70 732e 0a20 2020 2023 3a20 496e  loops..    #: In
+0000ddf0: 2070 726f 6475 6374 696f 6e2c 2069 7420   production, it 
+0000de00: 7368 6f75 6c64 2061 6c77 6179 7320 6265  should always be
+0000de10: 2073 6574 2074 6f20 4661 6c73 652e 0a20   set to False.. 
+0000de20: 2020 2074 7261 6e73 6974 696f 6e5f 636f     transition_co
+0000de30: 756e 7465 725f 6d61 783a 2069 6e74 207c  unter_max: int |
+0000de40: 204c 6974 6572 616c 5b46 616c 7365 5d0a   Literal[False].
+0000de50: 0a20 2020 205f 7461 736b 5f70 7265 6669  .    _task_prefi
+0000de60: 785f 636f 756e 745f 676c 6f62 616c 3a20  x_count_global: 
+0000de70: 6465 6661 756c 7464 6963 745b 7374 722c  defaultdict[str,
+0000de80: 2069 6e74 5d0a 2020 2020 5f6e 6574 776f   int].    _netwo
+0000de90: 726b 5f6f 6363 5f67 6c6f 6261 6c3a 2066  rk_occ_global: f
+0000dea0: 6c6f 6174 0a20 2020 2023 2323 2323 2323  loat.    #######
+0000deb0: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000dec0: 2020 2020 2320 4361 6368 6564 2063 6f6e      # Cached con
+0000ded0: 6669 6775 7261 7469 6f6e 0a20 2020 2023  figuration.    #
+0000dee0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000def0: 2323 2323 230a 0a20 2020 2023 3a20 6469  #####..    #: di
+0000df00: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0000df10: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
+0000df20: 2d64 7572 6174 696f 6e0a 2020 2020 554e  -duration.    UN
+0000df30: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+0000df40: 494f 4e3a 2066 6c6f 6174 0a20 2020 2023  ION: float.    #
+0000df50: 3a20 6469 7374 7269 6275 7465 642e 776f  : distributed.wo
+0000df60: 726b 6572 2e6d 656d 6f72 792e 7265 6365  rker.memory.rece
+0000df70: 6e74 2d74 6f2d 6f6c 642d 7469 6d65 0a20  nt-to-old-time. 
+0000df80: 2020 204d 454d 4f52 595f 5245 4345 4e54     MEMORY_RECENT
+0000df90: 5f54 4f5f 4f4c 445f 5449 4d45 3a20 666c  _TO_OLD_TIME: fl
+0000dfa0: 6f61 740a 2020 2020 233a 2064 6973 7472  oat.    #: distr
+0000dfb0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+0000dfc0: 6d6f 7279 2e72 6562 616c 616e 6365 2e6d  mory.rebalance.m
+0000dfd0: 6561 7375 7265 0a20 2020 204d 454d 4f52  easure.    MEMOR
+0000dfe0: 595f 5245 4241 4c41 4e43 455f 4d45 4153  Y_REBALANCE_MEAS
+0000dff0: 5552 453a 2073 7472 0a20 2020 2023 3a20  URE: str.    #: 
+0000e000: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000e010: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+0000e020: 6e63 652e 7365 6e64 6572 2d6d 696e 0a20  nce.sender-min. 
+0000e030: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
+0000e040: 4e43 455f 5345 4e44 4552 5f4d 494e 3a20  NCE_SENDER_MIN: 
+0000e050: 666c 6f61 740a 2020 2020 233a 2064 6973  float.    #: dis
+0000e060: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000e070: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000e080: 2e72 6563 6970 6965 6e74 2d6d 6178 0a20  .recipient-max. 
+0000e090: 2020 204d 454d 4f52 595f 5245 4241 4c41     MEMORY_REBALA
+0000e0a0: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
+0000e0b0: 583a 2066 6c6f 6174 0a20 2020 2023 3a20  X: float.    #: 
+0000e0c0: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+0000e0d0: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
+0000e0e0: 6e63 652e 7365 6e64 6572 2d72 6563 6970  nce.sender-recip
+0000e0f0: 6965 6e74 2d67 6170 202f 2032 0a20 2020  ient-gap / 2.   
+0000e100: 204d 454d 4f52 595f 5245 4241 4c41 4e43   MEMORY_REBALANC
+0000e110: 455f 4841 4c46 5f47 4150 3a20 666c 6f61  E_HALF_GAP: floa
+0000e120: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
+0000e130: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
+0000e140: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
+0000e150: 0a20 2020 2057 4f52 4b45 525f 5341 5455  .    WORKER_SATU
+0000e160: 5241 5449 4f4e 3a20 666c 6f61 740a 0a20  RATION: float.. 
+0000e170: 2020 205f 5f73 6c6f 7473 5f5f 203d 2074     __slots__ = t
+0000e180: 7570 6c65 285f 5f61 6e6e 6f74 6174 696f  uple(__annotatio
+0000e190: 6e73 5f5f 290a 0a20 2020 2064 6566 205f  ns__)..    def _
+0000e1a0: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+0000e1b0: 2073 656c 662c 0a20 2020 2020 2020 2061   self,.        a
+0000e1c0: 6c69 6173 6573 3a20 6469 6374 5b48 6173  liases: dict[Has
+0000e1d0: 6861 626c 652c 2073 7472 5d2c 0a20 2020  hable, str],.   
+0000e1e0: 2020 2020 2063 6c69 656e 7473 3a20 6469       clients: di
+0000e1f0: 6374 5b73 7472 2c20 436c 6965 6e74 5374  ct[str, ClientSt
+0000e200: 6174 655d 2c0a 2020 2020 2020 2020 776f  ate],.        wo
+0000e210: 726b 6572 733a 2053 6f72 7465 6444 6963  rkers: SortedDic
+0000e220: 745b 7374 722c 2057 6f72 6b65 7253 7461  t[str, WorkerSta
+0000e230: 7465 5d2c 0a20 2020 2020 2020 2068 6f73  te],.        hos
+0000e240: 745f 696e 666f 3a20 6469 6374 5b73 7472  t_info: dict[str
+0000e250: 2c20 6469 6374 5b73 7472 2c20 416e 795d  , dict[str, Any]
+0000e260: 5d2c 0a20 2020 2020 2020 2072 6573 6f75  ],.        resou
+0000e270: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
+0000e280: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
+0000e290: 5d2c 0a20 2020 2020 2020 2074 6173 6b73  ],.        tasks
+0000e2a0: 3a20 6469 6374 5b73 7472 2c20 5461 736b  : dict[str, Task
+0000e2b0: 5374 6174 655d 2c0a 2020 2020 2020 2020  State],.        
+0000e2c0: 756e 7275 6e6e 6162 6c65 3a20 7365 745b  unrunnable: set[
+0000e2d0: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
+0000e2e0: 2020 2020 7175 6575 6564 3a20 4865 6170      queued: Heap
+0000e2f0: 5365 745b 5461 736b 5374 6174 655d 2c0a  Set[TaskState],.
+0000e300: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0000e310: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+0000e320: 706c 7567 696e 733a 2049 7465 7261 626c  plugins: Iterabl
+0000e330: 655b 5363 6865 6475 6c65 7250 6c75 6769  e[SchedulerPlugi
+0000e340: 6e5d 203d 2028 292c 0a20 2020 2020 2020  n] = (),.       
+0000e350: 2074 7261 6e73 6974 696f 6e5f 636f 756e   transition_coun
+0000e360: 7465 725f 6d61 783a 2069 6e74 207c 204c  ter_max: int | L
+0000e370: 6974 6572 616c 5b46 616c 7365 5d20 3d20  iteral[False] = 
+0000e380: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
+0000e390: 2a6b 7761 7267 733a 2041 6e79 2c20 2023  *kwargs: Any,  #
+0000e3a0: 2050 6173 7365 6420 7665 7262 6174 696d   Passed verbatim
+0000e3b0: 2074 6f20 5365 7276 6572 2e5f 5f69 6e69   to Server.__ini
+0000e3c0: 745f 5f28 290a 2020 2020 293a 0a20 2020  t__().    ):.   
+0000e3d0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0000e3e0: 2822 5374 6174 6520 7374 6172 7422 290a  ("State start").
+0000e3f0: 2020 2020 2020 2020 7365 6c66 2e61 6c69          self.ali
+0000e400: 6173 6573 203d 2061 6c69 6173 6573 0a20  ases = aliases. 
+0000e410: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+0000e420: 7769 6474 6820 3d20 7061 7273 655f 6279  width = parse_by
+0000e430: 7465 7328 6461 736b 2e63 6f6e 6669 672e  tes(dask.config.
+0000e440: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0000e450: 2e73 6368 6564 756c 6572 2e62 616e 6477  .scheduler.bandw
+0000e460: 6964 7468 2229 290a 2020 2020 2020 2020  idth")).        
+0000e470: 7365 6c66 2e63 6c69 656e 7473 203d 2063  self.clients = c
+0000e480: 6c69 656e 7473 0a20 2020 2020 2020 2073  lients.        s
+0000e490: 656c 662e 636c 6965 6e74 735b 2266 6972  elf.clients["fir
+0000e4a0: 652d 616e 642d 666f 7267 6574 225d 203d  e-and-forget"] =
+0000e4b0: 2043 6c69 656e 7453 7461 7465 2822 6669   ClientState("fi
+0000e4c0: 7265 2d61 6e64 2d66 6f72 6765 7422 290a  re-and-forget").
+0000e4d0: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+0000e4e0: 656e 7369 6f6e 7320 3d20 7b7d 0a20 2020  ensions = {}.   
+0000e4f0: 2020 2020 2073 656c 662e 686f 7374 5f69       self.host_i
+0000e500: 6e66 6f20 3d20 686f 7374 5f69 6e66 6f0a  nfo = host_info.
+0000e510: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+0000e520: 6520 3d20 536f 7274 6564 4469 6374 2829  e = SortedDict()
+0000e530: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
+0000e540: 6c65 5f74 6173 6b5f 636f 756e 7420 3d20  le_task_count = 
+0000e550: 7365 7428 290a 2020 2020 2020 2020 7365  set().        se
+0000e560: 6c66 2e6e 5f74 6173 6b73 203d 2030 0a20  lf.n_tasks = 0. 
+0000e570: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
+0000e580: 7572 6365 7320 3d20 7265 736f 7572 6365  urces = resource
+0000e590: 730a 2020 2020 2020 2020 7365 6c66 2e73  s.        self.s
+0000e5a0: 6174 7572 6174 6564 203d 2073 6574 2829  aturated = set()
+0000e5b0: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
+0000e5c0: 736b 7320 3d20 7461 736b 730a 2020 2020  sks = tasks.    
+0000e5d0: 2020 2020 7365 6c66 2e72 6570 6c69 6361      self.replica
+0000e5e0: 7465 645f 7461 736b 7320 3d20 7b0a 2020  ted_tasks = {.  
+0000e5f0: 2020 2020 2020 2020 2020 7473 2066 6f72            ts for
+0000e600: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
+0000e610: 732e 7661 6c75 6573 2829 2069 6620 6c65  s.values() if le
+0000e620: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
+0000e630: 310a 2020 2020 2020 2020 7d0a 2020 2020  1.        }.    
+0000e640: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
+0000e650: 7469 6f6e 7320 3d20 6465 7175 6528 0a20  tions = deque(. 
+0000e660: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
+0000e670: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
+0000e680: 7428 2264 6973 7472 6962 7574 6564 2e64  t("distributed.d
+0000e690: 6961 676e 6f73 7469 6373 2e63 6f6d 7075  iagnostics.compu
+0000e6a0: 7461 7469 6f6e 732e 6d61 782d 6869 7374  tations.max-hist
+0000e6b0: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
+0000e6c0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
+0000e6d0: 6564 5f74 6173 6b73 203d 2064 6571 7565  ed_tasks = deque
+0000e6e0: 280a 2020 2020 2020 2020 2020 2020 6d61  (.            ma
+0000e6f0: 786c 656e 3d64 6173 6b2e 636f 6e66 6967  xlen=dask.config
+0000e700: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0000e710: 642e 6469 6167 6e6f 7374 6963 732e 6572  d.diagnostics.er
+0000e720: 7265 642d 7461 736b 732e 6d61 782d 6869  red-tasks.max-hi
+0000e730: 7374 6f72 7922 290a 2020 2020 2020 2020  story").        
+0000e740: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+0000e750: 6173 6b5f 6772 6f75 7073 203d 207b 7d0a  ask_groups = {}.
+0000e760: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000e770: 6b5f 7072 6566 6978 6573 203d 207b 7d0a  k_prefixes = {}.
+0000e780: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000e790: 6b5f 6d65 7461 6461 7461 203d 207b 7d0a  k_metadata = {}.
+0000e7a0: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0000e7b0: 616c 5f6e 7468 7265 6164 7320 3d20 300a  al_nthreads = 0.
+0000e7c0: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0000e7d0: 616c 5f6e 7468 7265 6164 735f 6869 7374  al_nthreads_hist
+0000e7e0: 6f72 7920 3d20 5b28 7469 6d65 2829 2c20  ory = [(time(), 
+0000e7f0: 3029 5d0a 2020 2020 2020 2020 7365 6c66  0)].        self
+0000e800: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
+0000e810: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
+0000e820: 7365 6c66 2e71 7565 7565 6420 3d20 7175  self.queued = qu
+0000e830: 6575 6564 0a20 2020 2020 2020 2073 656c  eued.        sel
+0000e840: 662e 756e 7275 6e6e 6162 6c65 203d 2075  f.unrunnable = u
+0000e850: 6e72 756e 6e61 626c 650a 2020 2020 2020  nrunnable.      
+0000e860: 2020 7365 6c66 2e76 616c 6964 6174 6520    self.validate 
+0000e870: 3d20 7661 6c69 6461 7465 0a20 2020 2020  = validate.     
+0000e880: 2020 2073 656c 662e 776f 726b 6572 7320     self.workers 
+0000e890: 3d20 776f 726b 6572 730a 2020 2020 2020  = workers.      
+0000e8a0: 2020 7365 6c66 2e5f 7461 736b 5f70 7265    self._task_pre
+0000e8b0: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
+0000e8c0: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
+0000e8d0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
+0000e8e0: 2e5f 6e65 7477 6f72 6b5f 6f63 635f 676c  ._network_occ_gl
+0000e8f0: 6f62 616c 203d 2030 2e30 0a20 2020 2020  obal = 0.0.     
+0000e900: 2020 2073 656c 662e 7275 6e6e 696e 6720     self.running 
+0000e910: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000e920: 7773 2066 6f72 2077 7320 696e 2073 656c  ws for ws in sel
+0000e930: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
+0000e940: 2829 2069 6620 7773 2e73 7461 7475 7320  () if ws.status 
+0000e950: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+0000e960: 670a 2020 2020 2020 2020 7d0a 2020 2020  g.        }.    
+0000e970: 2020 2020 7365 6c66 2e70 6c75 6769 6e73      self.plugins
+0000e980: 203d 207b 7d20 6966 206e 6f74 2070 6c75   = {} if not plu
+0000e990: 6769 6e73 2065 6c73 6520 7b5f 6765 745f  gins else {_get_
+0000e9a0: 706c 7567 696e 5f6e 616d 6528 7029 3a20  plugin_name(p): 
+0000e9b0: 7020 666f 7220 7020 696e 2070 6c75 6769  p for p in plugi
+0000e9c0: 6e73 7d0a 0a20 2020 2020 2020 2073 656c  ns}..        sel
+0000e9d0: 662e 7472 616e 7369 7469 6f6e 5f6c 6f67  f.transition_log
+0000e9e0: 203d 2064 6571 7565 280a 2020 2020 2020   = deque(.      
+0000e9f0: 2020 2020 2020 6d61 786c 656e 3d64 6173        maxlen=das
+0000ea00: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+0000ea10: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0000ea20: 6c65 722e 7472 616e 7369 7469 6f6e 2d6c  ler.transition-l
+0000ea30: 6f67 2d6c 656e 6774 6822 290a 2020 2020  og-length").    
+0000ea40: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000ea50: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
+0000ea60: 756e 7465 7220 3d20 300a 2020 2020 2020  unter = 0.      
+0000ea70: 2020 7365 6c66 2e5f 6964 6c65 5f74 7261    self._idle_tra
+0000ea80: 6e73 6974 696f 6e5f 636f 756e 7465 7220  nsition_counter 
+0000ea90: 3d20 300a 2020 2020 2020 2020 7365 6c66  = 0.        self
+0000eaa0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+0000eab0: 7465 725f 6d61 7820 3d20 7472 616e 7369  ter_max = transi
+0000eac0: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
+0000ead0: 0a0a 2020 2020 2020 2020 2320 5661 7269  ..        # Vari
+0000eae0: 6162 6c65 7320 6672 6f6d 2064 6173 6b2e  ables from dask.
+0000eaf0: 636f 6e66 6967 2c20 6361 6368 6564 2062  config, cached b
+0000eb00: 7920 5f5f 696e 6974 5f5f 2066 6f72 2070  y __init__ for p
+0000eb10: 6572 666f 726d 616e 6365 0a20 2020 2020  erformance.     
+0000eb20: 2020 2073 656c 662e 554e 4b4e 4f57 4e5f     self.UNKNOWN_
+0000eb30: 5441 534b 5f44 5552 4154 494f 4e20 3d20  TASK_DURATION = 
+0000eb40: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
+0000eb50: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
+0000eb60: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+0000eb70: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0000eb80: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
+0000eb90: 2d64 7572 6174 696f 6e22 290a 2020 2020  -duration").    
+0000eba0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000ebb0: 6c66 2e4d 454d 4f52 595f 5245 4345 4e54  lf.MEMORY_RECENT
+0000ebc0: 5f54 4f5f 4f4c 445f 5449 4d45 203d 2070  _TO_OLD_TIME = p
+0000ebd0: 6172 7365 5f74 696d 6564 656c 7461 280a  arse_timedelta(.
+0000ebe0: 2020 2020 2020 2020 2020 2020 6461 736b              dask
+0000ebf0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0000ec00: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000ec10: 6d65 6d6f 7279 2e72 6563 656e 742d 746f  memory.recent-to
+0000ec20: 2d6f 6c64 2d74 696d 6522 290a 2020 2020  -old-time").    
+0000ec30: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000ec40: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
+0000ec50: 4e43 455f 4d45 4153 5552 4520 3d20 6461  NCE_MEASURE = da
+0000ec60: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0000ec70: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0000ec80: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0000ec90: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
+0000eca0: 6d65 6173 7572 6522 0a20 2020 2020 2020  measure".       
+0000ecb0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0000ecc0: 4d45 4d4f 5259 5f52 4542 414c 414e 4345  MEMORY_REBALANCE
+0000ecd0: 5f53 454e 4445 525f 4d49 4e20 3d20 6461  _SENDER_MIN = da
+0000ece0: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+0000ecf0: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+0000ed00: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0000ed10: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
+0000ed20: 7365 6e64 6572 2d6d 696e 220a 2020 2020  sender-min".    
+0000ed30: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0000ed40: 6c66 2e4d 454d 4f52 595f 5245 4241 4c41  lf.MEMORY_REBALA
+0000ed50: 4e43 455f 5245 4349 5049 454e 545f 4d41  NCE_RECIPIENT_MA
+0000ed60: 5820 3d20 6461 736b 2e63 6f6e 6669 672e  X = dask.config.
+0000ed70: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+0000ed80: 2022 6469 7374 7269 6275 7465 642e 776f   "distributed.wo
+0000ed90: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000eda0: 6c61 6e63 652e 7265 6369 7069 656e 742d  lance.recipient-
+0000edb0: 6d61 7822 0a20 2020 2020 2020 2029 0a20  max".        ). 
+0000edc0: 2020 2020 2020 2073 656c 662e 4d45 4d4f         self.MEMO
+0000edd0: 5259 5f52 4542 414c 414e 4345 5f48 414c  RY_REBALANCE_HAL
+0000ede0: 465f 4741 5020 3d20 280a 2020 2020 2020  F_GAP = (.      
+0000edf0: 2020 2020 2020 6461 736b 2e63 6f6e 6669        dask.confi
+0000ee00: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
+0000ee10: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000ee20: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
+0000ee30: 722d 7265 6369 7069 656e 742d 6761 7022  r-recipient-gap"
+0000ee40: 290a 2020 2020 2020 2020 2020 2020 2f20  ).            / 
+0000ee50: 322e 300a 2020 2020 2020 2020 290a 0a20  2.0.        ).. 
+0000ee60: 2020 2020 2020 2073 656c 662e 574f 524b         self.WORK
+0000ee70: 4552 5f53 4154 5552 4154 494f 4e20 3d20  ER_SATURATION = 
+0000ee80: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0000ee90: 0a20 2020 2020 2020 2020 2020 2022 6469  .            "di
+0000eea0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+0000eeb0: 6c65 722e 776f 726b 6572 2d73 6174 7572  ler.worker-satur
+0000eec0: 6174 696f 6e22 0a20 2020 2020 2020 2029  ation".        )
+0000eed0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0000eee0: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
+0000eef0: 4f4e 203d 3d20 2269 6e66 223a 0a20 2020  ON == "inf":.   
+0000ef00: 2020 2020 2020 2020 2023 2053 7065 6369           # Speci
+0000ef10: 616c 2063 6173 6520 6e65 6365 7373 6172  al case necessar
+0000ef20: 7920 6265 6361 7573 6520 7468 6572 6527  y because there'
+0000ef30: 7320 6e6f 2077 6179 2074 6f20 7061 7273  s no way to pars
+0000ef40: 6520 6120 666c 6f61 7420 696e 6669 6e69  e a float infini
+0000ef50: 7479 0a20 2020 2020 2020 2020 2020 2023  ty.            #
+0000ef60: 2066 726f 6d20 6120 4441 534b 5f2a 2065   from a DASK_* e
+0000ef70: 6e76 6972 6f6e 6d65 6e74 2076 6172 6961  nvironment varia
+0000ef80: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+0000ef90: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+0000efa0: 5241 5449 4f4e 203d 206d 6174 682e 696e  RATION = math.in
+0000efb0: 660a 2020 2020 2020 2020 6966 2028 0a20  f.        if (. 
+0000efc0: 2020 2020 2020 2020 2020 206e 6f74 2069             not i
+0000efd0: 7369 6e73 7461 6e63 6528 7365 6c66 2e57  sinstance(self.W
+0000efe0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000eff0: 2c20 2869 6e74 2c20 666c 6f61 7429 290a  , (int, float)).
+0000f000: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
+0000f010: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+0000f020: 4154 494f 4e20 3c3d 2030 0a20 2020 2020  ATION <= 0.     
+0000f030: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0000f040: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+0000f050: 6f72 2820 2023 2070 7261 676d 613a 206e  or(  # pragma: n
+0000f060: 6f63 6f76 6572 0a20 2020 2020 2020 2020  ocover.         
+0000f070: 2020 2020 2020 2022 6064 6973 7472 6962         "`distrib
+0000f080: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
+0000f090: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
+0000f0a0: 6020 6d75 7374 2062 6520 6120 666c 6f61  ` must be a floa
+0000f0b0: 7420 3e20 303b 2067 6f74 2022 0a20 2020  t > 0; got ".   
+0000f0c0: 2020 2020 2020 2020 2020 2020 202b 2072               + r
+0000f0d0: 6570 7228 7365 6c66 2e57 4f52 4b45 525f  epr(self.WORKER_
+0000f0e0: 5341 5455 5241 5449 4f4e 290a 2020 2020  SATURATION).    
+0000f0f0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+0000f100: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0000f110: 206d 656d 6f72 7928 7365 6c66 2920 2d3e   memory(self) ->
+0000f120: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
+0000f130: 2020 2020 2020 7265 7475 726e 204d 656d        return Mem
+0000f140: 6f72 7953 7461 7465 2e73 756d 282a 2877  oryState.sum(*(w
+0000f150: 2e6d 656d 6f72 7920 666f 7220 7720 696e  .memory for w in
+0000f160: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+0000f170: 6c75 6573 2829 2929 0a0a 2020 2020 4070  lues()))..    @p
+0000f180: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+0000f190: 5f5f 7064 6963 745f 5f28 7365 6c66 2920  __pdict__(self) 
+0000f1a0: 2d3e 2064 6963 745b 7374 722c 2041 6e79  -> dict[str, Any
+0000f1b0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+0000f1c0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+0000f1d0: 2262 616e 6477 6964 7468 223a 2073 656c  "bandwidth": sel
+0000f1e0: 662e 6261 6e64 7769 6474 682c 0a20 2020  f.bandwidth,.   
+0000f1f0: 2020 2020 2020 2020 2022 7265 736f 7572           "resour
+0000f200: 6365 7322 3a20 7365 6c66 2e72 6573 6f75  ces": self.resou
+0000f210: 7263 6573 2c0a 2020 2020 2020 2020 2020  rces,.          
+0000f220: 2020 2273 6174 7572 6174 6564 223a 2073    "saturated": s
+0000f230: 656c 662e 7361 7475 7261 7465 642c 0a20  elf.saturated,. 
+0000f240: 2020 2020 2020 2020 2020 2022 756e 7275             "unru
+0000f250: 6e6e 6162 6c65 223a 2073 656c 662e 756e  nnable": self.un
+0000f260: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
+0000f270: 2020 2020 2020 2271 7565 7565 6422 3a20        "queued": 
+0000f280: 7365 6c66 2e71 7565 7565 642c 0a20 2020  self.queued,.   
+0000f290: 2020 2020 2020 2020 2022 6e5f 7461 736b           "n_task
+0000f2a0: 7322 3a20 7365 6c66 2e6e 5f74 6173 6b73  s": self.n_tasks
+0000f2b0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+0000f2c0: 6e6b 6e6f 776e 5f64 7572 6174 696f 6e73  nknown_durations
+0000f2d0: 223a 2073 656c 662e 756e 6b6e 6f77 6e5f  ": self.unknown_
+0000f2e0: 6475 7261 7469 6f6e 732c 0a20 2020 2020  durations,.     
+0000f2f0: 2020 2020 2020 2022 7661 6c69 6461 7465         "validate
+0000f300: 223a 2073 656c 662e 7661 6c69 6461 7465  ": self.validate
+0000f310: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+0000f320: 6173 6b73 223a 2073 656c 662e 7461 736b  asks": self.task
+0000f330: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0000f340: 7461 736b 5f67 726f 7570 7322 3a20 7365  task_groups": se
+0000f350: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
+0000f360: 2020 2020 2020 2020 2020 2020 2274 6173              "tas
+0000f370: 6b5f 7072 6566 6978 6573 223a 2073 656c  k_prefixes": sel
+0000f380: 662e 7461 736b 5f70 7265 6669 7865 732c  f.task_prefixes,
+0000f390: 0a20 2020 2020 2020 2020 2020 2022 746f  .            "to
+0000f3a0: 7461 6c5f 6e74 6872 6561 6473 223a 2073  tal_nthreads": s
+0000f3b0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
+0000f3c0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000f3d0: 2274 6f74 616c 5f6f 6363 7570 616e 6379  "total_occupancy
+0000f3e0: 223a 2073 656c 662e 746f 7461 6c5f 6f63  ": self.total_oc
+0000f3f0: 6375 7061 6e63 792c 0a20 2020 2020 2020  cupancy,.       
+0000f400: 2020 2020 2022 6572 7265 645f 7461 736b       "erred_task
+0000f410: 7322 3a20 7365 6c66 2e65 7272 6564 5f74  s": self.erred_t
+0000f420: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+0000f430: 2020 2265 7874 656e 7369 6f6e 7322 3a20    "extensions": 
+0000f440: 7365 6c66 2e65 7874 656e 7369 6f6e 732c  self.extensions,
+0000f450: 0a20 2020 2020 2020 2020 2020 2022 636c  .            "cl
+0000f460: 6965 6e74 7322 3a20 7365 6c66 2e63 6c69  ients": self.cli
+0000f470: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
+0000f480: 2020 2277 6f72 6b65 7273 223a 2073 656c    "workers": sel
+0000f490: 662e 776f 726b 6572 732c 0a20 2020 2020  f.workers,.     
+0000f4a0: 2020 2020 2020 2022 6964 6c65 223a 2073         "idle": s
+0000f4b0: 656c 662e 6964 6c65 2c0a 2020 2020 2020  elf.idle,.      
+0000f4c0: 2020 2020 2020 2268 6f73 745f 696e 666f        "host_info
+0000f4d0: 223a 2073 656c 662e 686f 7374 5f69 6e66  ": self.host_inf
+0000f4e0: 6f2c 0a20 2020 2020 2020 207d 0a0a 2020  o,.        }..  
+0000f4f0: 2020 6465 6620 6e65 775f 7461 736b 280a    def new_task(.
+0000f500: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000f510: 2020 2020 2020 6b65 793a 2073 7472 2c0a        key: str,.
+0000f520: 2020 2020 2020 2020 7370 6563 3a20 6f62          spec: ob
+0000f530: 6a65 6374 2c0a 2020 2020 2020 2020 7374  ject,.        st
+0000f540: 6174 653a 2054 6173 6b53 7461 7465 5374  ate: TaskStateSt
+0000f550: 6174 652c 0a20 2020 2020 2020 2063 6f6d  ate,.        com
+0000f560: 7075 7461 7469 6f6e 3a20 436f 6d70 7574  putation: Comput
+0000f570: 6174 696f 6e20 7c20 4e6f 6e65 203d 204e  ation | None = N
+0000f580: 6f6e 652c 0a20 2020 2029 202d 3e20 5461  one,.    ) -> Ta
+0000f590: 736b 5374 6174 653a 0a20 2020 2020 2020  skState:.       
+0000f5a0: 2022 2222 4372 6561 7465 2061 206e 6577   """Create a new
+0000f5b0: 2074 6173 6b2c 2061 6e64 2061 7373 6f63   task, and assoc
+0000f5c0: 6961 7465 6420 7374 6174 6573 2222 220a  iated states""".
+0000f5d0: 2020 2020 2020 2020 7473 203d 2054 6173          ts = Tas
+0000f5e0: 6b53 7461 7465 286b 6579 2c20 7370 6563  kState(key, spec
+0000f5f0: 2c20 7374 6174 6529 0a0a 2020 2020 2020  , state)..      
+0000f600: 2020 7072 6566 6978 5f6b 6579 203d 206b    prefix_key = k
+0000f610: 6579 5f73 706c 6974 286b 6579 290a 2020  ey_split(key).  
+0000f620: 2020 2020 2020 7470 203d 2073 656c 662e        tp = self.
+0000f630: 7461 736b 5f70 7265 6669 7865 732e 6765  task_prefixes.ge
+0000f640: 7428 7072 6566 6978 5f6b 6579 290a 2020  t(prefix_key).  
+0000f650: 2020 2020 2020 6966 2074 7020 6973 204e        if tp is N
+0000f660: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000f670: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
+0000f680: 7865 735b 7072 6566 6978 5f6b 6579 5d20  xes[prefix_key] 
+0000f690: 3d20 7470 203d 2054 6173 6b50 7265 6669  = tp = TaskPrefi
+0000f6a0: 7828 7072 6566 6978 5f6b 6579 290a 2020  x(prefix_key).  
+0000f6b0: 2020 2020 2020 7473 2e70 7265 6669 7820        ts.prefix 
+0000f6c0: 3d20 7470 0a0a 2020 2020 2020 2020 6772  = tp..        gr
+0000f6d0: 6f75 705f 6b65 7920 3d20 7473 2e67 726f  oup_key = ts.gro
+0000f6e0: 7570 5f6b 6579 0a20 2020 2020 2020 2074  up_key.        t
+0000f6f0: 6720 3d20 7365 6c66 2e74 6173 6b5f 6772  g = self.task_gr
+0000f700: 6f75 7073 2e67 6574 2867 726f 7570 5f6b  oups.get(group_k
+0000f710: 6579 290a 2020 2020 2020 2020 6966 2074  ey).        if t
+0000f720: 6720 6973 204e 6f6e 653a 0a20 2020 2020  g is None:.     
+0000f730: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+0000f740: 5f67 726f 7570 735b 6772 6f75 705f 6b65  _groups[group_ke
+0000f750: 795d 203d 2074 6720 3d20 5461 736b 4772  y] = tg = TaskGr
+0000f760: 6f75 7028 6772 6f75 705f 6b65 7929 0a20  oup(group_key). 
+0000f770: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+0000f780: 6d70 7574 6174 696f 6e3a 0a20 2020 2020  mputation:.     
+0000f790: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+0000f7a0: 7461 7469 6f6e 2e67 726f 7570 732e 6164  tation.groups.ad
+0000f7b0: 6428 7467 290a 2020 2020 2020 2020 2020  d(tg).          
+0000f7c0: 2020 7467 2e70 7265 6669 7820 3d20 7470    tg.prefix = tp
+0000f7d0: 0a20 2020 2020 2020 2020 2020 2074 702e  .            tp.
+0000f7e0: 6772 6f75 7073 2e61 7070 656e 6428 7467  groups.append(tg
+0000f7f0: 290a 2020 2020 2020 2020 7467 2e61 6464  ).        tg.add
+0000f800: 2874 7329 0a0a 2020 2020 2020 2020 7365  (ts)..        se
+0000f810: 6c66 2e74 6173 6b73 5b6b 6579 5d20 3d20  lf.tasks[key] = 
+0000f820: 7473 0a0a 2020 2020 2020 2020 7265 7475  ts..        retu
+0000f830: 726e 2074 730a 0a20 2020 2064 6566 205f  rn ts..    def _
+0000f840: 636c 6561 725f 7461 736b 5f73 7461 7465  clear_task_state
+0000f850: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+0000f860: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0000f870: 6562 7567 2822 436c 6561 7220 7461 736b  ebug("Clear task
+0000f880: 2073 7461 7465 2229 0a20 2020 2020 2020   state").       
+0000f890: 2066 6f72 2063 6f6c 6c65 6374 696f 6e20   for collection 
+0000f8a0: 696e 2028 0a20 2020 2020 2020 2020 2020  in (.           
+0000f8b0: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+0000f8c0: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000f8d0: 6c66 2e65 7272 6564 5f74 6173 6b73 2c0a  lf.erred_tasks,.
+0000f8e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f8f0: 2e63 6f6d 7075 7461 7469 6f6e 732c 0a20  .computations,. 
+0000f900: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f910: 7461 736b 5f70 7265 6669 7865 732c 0a20  task_prefixes,. 
+0000f920: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f930: 7461 736b 5f67 726f 7570 732c 0a20 2020  task_groups,.   
+0000f940: 2020 2020 2020 2020 2073 656c 662e 7461           self.ta
+0000f950: 736b 5f6d 6574 6164 6174 612c 0a20 2020  sk_metadata,.   
+0000f960: 2020 2020 2020 2020 2073 656c 662e 756e           self.un
+0000f970: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732c  known_durations,
+0000f980: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000f990: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
+0000f9a0: 6b73 2c0a 2020 2020 2020 2020 293a 0a20  ks,.        ):. 
+0000f9b0: 2020 2020 2020 2020 2020 2063 6f6c 6c65             colle
+0000f9c0: 6374 696f 6e2e 636c 6561 7228 2920 2023  ction.clear()  #
+0000f9d0: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
+0000f9e0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
+0000f9f0: 2064 6566 2069 735f 6964 6c65 2873 656c   def is_idle(sel
+0000fa00: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
+0000fa10: 2020 2020 2222 2252 6574 7572 6e20 5472      """Return Tr
+0000fa20: 7565 2069 6666 2074 6865 7265 2061 7265  ue iff there are
+0000fa30: 206e 6f20 7461 736b 7320 7468 6174 2068   no tasks that h
+0000fa40: 6176 656e 2774 2066 696e 6973 6865 6420  aven't finished 
+0000fa50: 636f 6d70 7574 696e 672e 0a0a 2020 2020  computing...    
+0000fa60: 2020 2020 556e 6c69 6b65 2074 6573 7469      Unlike testi
+0000fa70: 6e67 2060 6073 656c 662e 746f 7461 6c5f  ng ``self.total_
+0000fa80: 6f63 6375 7061 6e63 7960 602c 2074 6869  occupancy``, thi
+0000fa90: 7320 7072 6f70 6572 7479 2072 6574 7572  s property retur
+0000faa0: 6e73 2046 616c 7365 2069 6620 7468 6572  ns False if ther
+0000fab0: 650a 2020 2020 2020 2020 6172 6520 6c6f  e.        are lo
+0000fac0: 6e67 2d72 756e 6e69 6e67 2074 6173 6b73  ng-running tasks
+0000fad0: 2c20 6e6f 2d77 6f72 6b65 722c 206f 7220  , no-worker, or 
+0000fae0: 7175 6575 6564 2074 6173 6b73 2028 6475  queued tasks (du
+0000faf0: 6520 746f 206e 6f74 2068 6176 696e 6720  e to not having 
+0000fb00: 616e 790a 2020 2020 2020 2020 776f 726b  any.        work
+0000fb10: 6572 7329 2e0a 0a20 2020 2020 2020 204e  ers)...        N
+0000fb20: 6f74 2074 6f20 6265 2063 6f6e 6675 7365  ot to be confuse
+0000fb30: 6420 7769 7468 2060 6069 646c 6560 602e  d with ``idle``.
+0000fb40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000fb50: 2020 2020 2072 6574 7572 6e20 616c 6c28       return all(
+0000fb60: 7467 2e64 6f6e 6520 666f 7220 7467 2069  tg.done for tg i
+0000fb70: 6e20 7365 6c66 2e74 6173 6b5f 6772 6f75  n self.task_grou
+0000fb80: 7073 2e76 616c 7565 7328 2929 0a0a 2020  ps.values())..  
+0000fb90: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+0000fba0: 6465 6620 746f 7461 6c5f 6f63 6375 7061  def total_occupa
+0000fbb0: 6e63 7928 7365 6c66 2920 2d3e 2066 6c6f  ncy(self) -> flo
+0000fbc0: 6174 3a0a 2020 2020 2020 2020 7265 7475  at:.        retu
+0000fbd0: 726e 2073 656c 662e 5f63 616c 635f 6f63  rn self._calc_oc
+0000fbe0: 6375 7061 6e63 7928 0a20 2020 2020 2020  cupancy(.       
+0000fbf0: 2020 2020 2073 656c 662e 5f74 6173 6b5f       self._task_
+0000fc00: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+0000fc10: 6261 6c2c 0a20 2020 2020 2020 2020 2020  bal,.           
+0000fc20: 2073 656c 662e 5f6e 6574 776f 726b 5f6f   self._network_o
+0000fc30: 6363 5f67 6c6f 6261 6c2c 0a20 2020 2020  cc_global,.     
+0000fc40: 2020 2029 0a0a 2020 2020 6465 6620 5f63     )..    def _c
+0000fc50: 616c 635f 6f63 6375 7061 6e63 7928 0a20  alc_occupancy(. 
+0000fc60: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0000fc70: 2020 2020 2074 6173 6b5f 7072 6566 6978       task_prefix
+0000fc80: 5f63 6f75 6e74 3a20 6469 6374 5b73 7472  _count: dict[str
+0000fc90: 2c20 696e 745d 2c0a 2020 2020 2020 2020  , int],.        
+0000fca0: 6e65 7477 6f72 6b5f 6f63 633a 2066 6c6f  network_occ: flo
+0000fcb0: 6174 2c0a 2020 2020 2920 2d3e 2066 6c6f  at,.    ) -> flo
+0000fcc0: 6174 3a0a 2020 2020 2020 2020 7265 7320  at:.        res 
+0000fcd0: 3d20 302e 300a 2020 2020 2020 2020 666f  = 0.0.        fo
+0000fce0: 7220 7072 6566 6978 5f6e 616d 652c 2063  r prefix_name, c
+0000fcf0: 6f75 6e74 2069 6e20 7461 736b 5f70 7265  ount in task_pre
+0000fd00: 6669 785f 636f 756e 742e 6974 656d 7328  fix_count.items(
+0000fd10: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0000fd20: 2054 4f44 4f3a 2044 6561 6c20 7769 7468   TODO: Deal with
+0000fd30: 2075 6e6b 6e6f 776e 2074 6173 6b73 2062   unknown tasks b
+0000fd40: 6574 7465 720a 2020 2020 2020 2020 2020  etter.          
+0000fd50: 2020 7072 6566 6978 203d 2073 656c 662e    prefix = self.
+0000fd60: 7461 736b 5f70 7265 6669 7865 735b 7072  task_prefixes[pr
+0000fd70: 6566 6978 5f6e 616d 655d 0a20 2020 2020  efix_name].     
+0000fd80: 2020 2020 2020 2061 7373 6572 7420 7072         assert pr
+0000fd90: 6566 6978 2069 7320 6e6f 7420 4e6f 6e65  efix is not None
+0000fda0: 0a20 2020 2020 2020 2020 2020 2064 7572  .            dur
+0000fdb0: 6174 696f 6e20 3d20 7072 6566 6978 2e64  ation = prefix.d
+0000fdc0: 7572 6174 696f 6e5f 6176 6572 6167 650a  uration_average.
+0000fdd0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+0000fde0: 7572 6174 696f 6e20 3c20 303a 0a20 2020  uration < 0:.   
+0000fdf0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000fe00: 7072 6566 6978 2e6d 6178 5f65 7865 635f  prefix.max_exec_
+0000fe10: 7469 6d65 203e 2030 3a0a 2020 2020 2020  time > 0:.      
+0000fe20: 2020 2020 2020 2020 2020 2020 2020 6475                du
+0000fe30: 7261 7469 6f6e 203d 2032 202a 2070 7265  ration = 2 * pre
+0000fe40: 6669 782e 6d61 785f 6578 6563 5f74 696d  fix.max_exec_tim
+0000fe50: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000fe60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000fe70: 2020 2020 2020 2020 2020 2020 6475 7261              dura
+0000fe80: 7469 6f6e 203d 2073 656c 662e 554e 4b4e  tion = self.UNKN
+0000fe90: 4f57 4e5f 5441 534b 5f44 5552 4154 494f  OWN_TASK_DURATIO
+0000fea0: 4e0a 2020 2020 2020 2020 2020 2020 7265  N.            re
+0000feb0: 7320 2b3d 2064 7572 6174 696f 6e20 2a20  s += duration * 
+0000fec0: 636f 756e 740a 2020 2020 2020 2020 6f63  count.        oc
+0000fed0: 6320 3d20 7265 7320 2b20 6e65 7477 6f72  c = res + networ
+0000fee0: 6b5f 6f63 6320 2f20 7365 6c66 2e62 616e  k_occ / self.ban
+0000fef0: 6477 6964 7468 0a20 2020 2020 2020 2061  dwidth.        a
+0000ff00: 7373 6572 7420 6f63 6320 3e3d 2030 2c20  ssert occ >= 0, 
+0000ff10: 286f 6363 2c20 7265 732c 206e 6574 776f  (occ, res, netwo
+0000ff20: 726b 5f6f 6363 2c20 7365 6c66 2e62 616e  rk_occ, self.ban
+0000ff30: 6477 6964 7468 290a 2020 2020 2020 2020  dwidth).        
+0000ff40: 7265 7475 726e 206f 6363 0a0a 2020 2020  return occ..    
+0000ff50: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ff60: 2323 2323 230a 2020 2020 2320 5374 6174  #####.    # Stat
+0000ff70: 6520 5472 616e 7369 7469 6f6e 7320 230a  e Transitions #.
+0000ff80: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+0000ff90: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
+0000ffa0: 6566 205f 7472 616e 7369 7469 6f6e 280a  ef _transition(.
+0000ffb0: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
+0000ffc0: 793a 2073 7472 2c20 6669 6e69 7368 3a20  y: str, finish: 
+0000ffd0: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
+0000ffe0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+0000fff0: 2c20 2a2a 6b77 6172 6773 3a20 416e 790a  , **kwargs: Any.
+00010000: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
+00010010: 733a 0a20 2020 2020 2020 2022 2222 5472  s:.        """Tr
+00010020: 616e 7369 7469 6f6e 2061 206b 6579 2066  ansition a key f
+00010030: 726f 6d20 6974 7320 6375 7272 656e 7420  rom its current 
+00010040: 7374 6174 6520 746f 2074 6865 2066 696e  state to the fin
+00010050: 6973 6820 7374 6174 650a 0a20 2020 2020  ish state..     
+00010060: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
+00010070: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00010080: 2020 2020 203e 3e3e 2073 656c 662e 5f74       >>> self._t
+00010090: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
+000100a0: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
+000100b0: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
+000100c0: 696e 6727 7d2c 207b 7d2c 207b 7d0a 0a20  ing'}, {}, {}.. 
+000100d0: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+000100e0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+000100f0: 2020 2020 2020 2054 7570 6c65 206f 663a         Tuple of:
+00010100: 0a0a 2020 2020 2020 2020 2d20 4469 6374  ..        - Dict
+00010110: 696f 6e61 7279 206f 6620 7265 636f 6d6d  ionary of recomm
+00010120: 656e 6461 7469 6f6e 7320 666f 7220 6675  endations for fu
+00010130: 7475 7265 2074 7261 6e73 6974 696f 6e73  ture transitions
+00010140: 207b 6b65 793a 206e 6577 2073 7461 7465   {key: new state
+00010150: 7d0a 2020 2020 2020 2020 2d20 4d65 7373  }.        - Mess
+00010160: 6167 6573 2074 6f20 636c 6965 6e74 7320  ages to clients 
+00010170: 7b63 6c69 656e 7420 6164 6472 6573 733a  {client address:
+00010180: 205b 6d73 672c 206d 7367 2c20 2e2e 2e5d   [msg, msg, ...]
+00010190: 7d0a 2020 2020 2020 2020 2d20 4d65 7373  }.        - Mess
+000101a0: 6167 6573 2074 6f20 776f 726b 6572 7320  ages to workers 
+000101b0: 7b77 6f72 6b65 7220 6164 6472 6573 733a  {worker address:
+000101c0: 205b 6d73 672c 206d 7367 2c20 2e2e 2e5d   [msg, msg, ...]
+000101d0: 7d0a 0a20 2020 2020 2020 2053 6565 2041  }..        See A
+000101e0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+000101f0: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+00010200: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00010210: 6e73 203a 2074 7261 6e73 6974 6976 6520  ns : transitive 
+00010220: 7665 7273 696f 6e20 6f66 2074 6869 7320  version of this 
+00010230: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+00010240: 2022 2222 0a20 2020 2020 2020 2074 7279   """.        try
+00010250: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
+00010260: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
+00010270: 7428 6b65 7929 0a20 2020 2020 2020 2020  t(key).         
+00010280: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
+00010290: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000102a0: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+000102b0: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+000102c0: 7374 6172 7420 3d20 7473 2e5f 7374 6174  start = ts._stat
+000102d0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+000102e0: 2073 7461 7274 203d 3d20 6669 6e69 7368   start == finish
+000102f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010300: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
+00010310: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+00010320: 2023 204e 6f74 6573 3a0a 2020 2020 2020   # Notes:.      
+00010330: 2020 2020 2020 2320 2d20 696e 2063 6173        # - in cas
+00010340: 6520 6f66 2074 7261 6e73 6974 696f 6e20  e of transition 
+00010350: 7468 726f 7567 6820 7265 6c65 6173 6564  through released
+00010360: 2c20 7468 6973 2063 6f75 6e74 6572 2069  , this counter i
+00010370: 7320 696e 6372 656d 656e 7465 6420 6279  s incremented by
+00010380: 2032 0a20 2020 2020 2020 2020 2020 2023   2.            #
+00010390: 202d 2074 6869 7320 696e 6372 6561 7365   - this increase
+000103a0: 2068 6170 7065 6e73 2062 6566 6f72 6520   happens before 
+000103b0: 7468 6520 6163 7475 616c 2074 7261 6e73  the actual trans
+000103c0: 6974 696f 6e73 2c20 736f 2074 6861 7420  itions, so that 
+000103d0: 6974 2063 616e 0a20 2020 2020 2020 2020  it can.         
+000103e0: 2020 2023 2020 2063 6174 6368 2070 6f74     #   catch pot
+000103f0: 656e 7469 616c 2069 6e66 696e 6974 6520  ential infinite 
+00010400: 7265 6375 7273 696f 6e73 0a20 2020 2020  recursions.     
+00010410: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+00010420: 7369 7469 6f6e 5f63 6f75 6e74 6572 202b  sition_counter +
+00010430: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+00010440: 6966 2073 656c 662e 7472 616e 7369 7469  if self.transiti
+00010450: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 3a0a  on_counter_max:.
+00010460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010470: 6173 7365 7274 2073 656c 662e 7472 616e  assert self.tran
+00010480: 7369 7469 6f6e 5f63 6f75 6e74 6572 203c  sition_counter <
+00010490: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+000104a0: 5f63 6f75 6e74 6572 5f6d 6178 0a0a 2020  _counter_max..  
+000104b0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+000104c0: 656e 6461 7469 6f6e 733a 2064 6963 7420  endations: dict 
+000104d0: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
+000104e0: 2077 6f72 6b65 725f 6d73 6773 3a20 6469   worker_msgs: di
+000104f0: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
+00010500: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+00010510: 2064 6963 7420 3d20 7b7d 0a0a 2020 2020   dict = {}..    
+00010520: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00010530: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
+00010540: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00010550: 6e74 7320 3d20 7365 7428 7473 2e64 6570  nts = set(ts.dep
+00010560: 656e 6465 6e74 7329 0a20 2020 2020 2020  endents).       
+00010570: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00010580: 6e63 6965 7320 3d20 7365 7428 7473 2e64  ncies = set(ts.d
+00010590: 6570 656e 6465 6e63 6965 7329 0a0a 2020  ependencies)..  
+000105a0: 2020 2020 2020 2020 2020 6675 6e63 203d            func =
+000105b0: 2073 656c 662e 5f54 5241 4e53 4954 494f   self._TRANSITIO
+000105c0: 4e53 5f54 4142 4c45 2e67 6574 2828 7374  NS_TABLE.get((st
+000105d0: 6172 742c 2066 696e 6973 6829 290a 2020  art, finish)).  
+000105e0: 2020 2020 2020 2020 2020 6966 2066 756e            if fun
+000105f0: 6320 6973 206e 6f74 204e 6f6e 653a 0a20  c is not None:. 
+00010600: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010610: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00010620: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
+00010630: 6b65 725f 6d73 6773 203d 2066 756e 6328  ker_msgs = func(
+00010640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010650: 2020 2020 2073 656c 662c 206b 6579 2c20       self, key, 
+00010660: 7374 696d 756c 7573 5f69 642c 202a 2a6b  stimulus_id, **k
+00010670: 7761 7267 730a 2020 2020 2020 2020 2020  wargs.          
+00010680: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00010690: 2020 2020 2065 6c69 6620 2272 656c 6561       elif "relea
+000106a0: 7365 6422 206e 6f74 2069 6e20 2873 7461  sed" not in (sta
+000106b0: 7274 2c20 6669 6e69 7368 293a 0a20 2020  rt, finish):.   
+000106c0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+000106d0: 6572 7420 6e6f 7420 6b77 6172 6773 2c20  ert not kwargs, 
+000106e0: 286b 7761 7267 732c 2073 7461 7274 2c20  (kwargs, start, 
+000106f0: 6669 6e69 7368 290a 2020 2020 2020 2020  finish).        
+00010700: 2020 2020 2020 2020 615f 7265 6373 2c20          a_recs, 
+00010710: 615f 636d 7367 732c 2061 5f77 6d73 6773  a_cmsgs, a_wmsgs
+00010720: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
+00010730: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00010740: 2020 2020 2020 2020 206b 6579 2c20 2272           key, "r
+00010750: 656c 6561 7365 6422 2c20 7374 696d 756c  eleased", stimul
+00010760: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+00010770: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00010780: 2020 2020 2020 2020 2076 203d 2061 5f72           v = a_r
+00010790: 6563 732e 6765 7428 6b65 792c 2066 696e  ecs.get(key, fin
+000107a0: 6973 6829 0a20 2020 2020 2020 2020 2020  ish).           
+000107b0: 2020 2020 2066 756e 6320 3d20 7365 6c66       func = self
+000107c0: 2e5f 5452 414e 5349 5449 4f4e 535f 5441  ._TRANSITIONS_TA
+000107d0: 424c 455b 2272 656c 6561 7365 6422 2c20  BLE["released", 
+000107e0: 765d 0a20 2020 2020 2020 2020 2020 2020  v].             
+000107f0: 2020 2062 5f72 6563 732c 2062 5f63 6d73     b_recs, b_cms
+00010800: 6773 2c20 625f 776d 7367 7320 3d20 6675  gs, b_wmsgs = fu
+00010810: 6e63 2873 656c 662c 206b 6579 2c20 7374  nc(self, key, st
+00010820: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+00010830: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00010840: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
+00010850: 7465 2861 5f72 6563 7329 0a20 2020 2020  te(a_recs).     
+00010860: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00010870: 2c20 6e65 775f 6d73 6773 2069 6e20 615f  , new_msgs in a_
+00010880: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
+00010890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108a0: 2020 2063 6c69 656e 745f 6d73 6773 2e73     client_msgs.s
+000108b0: 6574 6465 6661 756c 7428 632c 205b 5d29  etdefault(c, [])
+000108c0: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
+000108d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000108e0: 2020 666f 7220 772c 206e 6577 5f6d 7367    for w, new_msg
+000108f0: 7320 696e 2061 5f77 6d73 6773 2e69 7465  s in a_wmsgs.ite
+00010900: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00010910: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00010920: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
+00010930: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
+00010940: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
+00010950: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00010960: 656e 6461 7469 6f6e 732e 7570 6461 7465  endations.update
+00010970: 2862 5f72 6563 7329 0a20 2020 2020 2020  (b_recs).       
+00010980: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
+00010990: 6e65 775f 6d73 6773 2069 6e20 625f 636d  new_msgs in b_cm
+000109a0: 7367 732e 6974 656d 7328 293a 0a20 2020  sgs.items():.   
+000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109c0: 2063 6c69 656e 745f 6d73 6773 2e73 6574   client_msgs.set
+000109d0: 6465 6661 756c 7428 632c 205b 5d29 2e65  default(c, []).e
+000109e0: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
+000109f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a00: 666f 7220 772c 206e 6577 5f6d 7367 7320  for w, new_msgs 
+00010a10: 696e 2062 5f77 6d73 6773 2e69 7465 6d73  in b_wmsgs.items
+00010a20: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00010a30: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+00010a40: 7367 732e 7365 7464 6566 6175 6c74 2877  sgs.setdefault(w
+00010a50: 2c20 5b5d 292e 6578 7465 6e64 286e 6577  , []).extend(new
+00010a60: 5f6d 7367 7329 0a0a 2020 2020 2020 2020  _msgs)..        
+00010a70: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00010a80: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
+00010a90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010aa0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00010ab0: 7365 2052 756e 7469 6d65 4572 726f 7228  se RuntimeError(
+00010ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ad0: 2020 2020 2066 2249 6d70 6f73 7369 626c       f"Impossibl
+00010ae0: 6520 7472 616e 7369 7469 6f6e 2066 726f  e transition fro
+00010af0: 6d20 7b73 7461 7274 7d20 746f 207b 6669  m {start} to {fi
+00010b00: 6e69 7368 7d20 666f 7220 7b6b 6579 2172  nish} for {key!r
+00010b10: 7d3a 2022 0a20 2020 2020 2020 2020 2020  }: ".           
+00010b20: 2020 2020 2020 2020 2066 227b 7374 696d           f"{stim
+00010b30: 756c 7573 5f69 643d 7d2c 207b 6b77 6172  ulus_id=}, {kwar
+00010b40: 6773 3d7d 2c20 7374 6f72 793d 7b73 656c  gs=}, story={sel
+00010b50: 662e 7374 6f72 7928 7473 297d 220a 2020  f.story(ts)}".  
+00010b60: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00010b70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010b80: 6e6f 7420 7374 696d 756c 7573 5f69 643a  not stimulus_id:
+00010b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010ba0: 2073 7469 6d75 6c75 735f 6964 203d 2053   stimulus_id = S
+00010bb0: 5449 4d55 4c55 535f 4944 5f55 4e53 4554  TIMULUS_ID_UNSET
+00010bc0: 0a0a 2020 2020 2020 2020 2020 2020 6163  ..            ac
+00010bd0: 7475 616c 5f66 696e 6973 6820 3d20 7473  tual_finish = ts
+00010be0: 2e5f 7374 6174 650a 2020 2020 2020 2020  ._state.        
+00010bf0: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+00010c00: 696f 6e5f 6c6f 672e 6170 7065 6e64 280a  ion_log.append(.
+00010c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c20: 5472 616e 7369 7469 6f6e 280a 2020 2020  Transition(.    
+00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c40: 6b65 792c 2073 7461 7274 2c20 6163 7475  key, start, actu
+00010c50: 616c 5f66 696e 6973 682c 2072 6563 6f6d  al_finish, recom
+00010c60: 6d65 6e64 6174 696f 6e73 2c20 7374 696d  mendations, stim
+00010c70: 756c 7573 5f69 642c 2074 696d 6528 290a  ulus_id, time().
+00010c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c90: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
+00010ca0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+00010cb0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010cd0: 2073 7469 6d75 6c75 735f 6964 203d 3d20   stimulus_id == 
+00010ce0: 5354 494d 554c 5553 5f49 445f 554e 5345  STIMULUS_ID_UNSE
+00010cf0: 543a 0a20 2020 2020 2020 2020 2020 2020  T:.             
+00010d00: 2020 2020 2020 2072 6169 7365 2052 756e         raise Run
+00010d10: 7469 6d65 4572 726f 7228 0a20 2020 2020  timeError(.     
+00010d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d30: 2020 2022 7374 696d 756c 7573 5f69 6420     "stimulus_id 
+00010d40: 6e6f 7420 7365 7420 6475 7269 6e67 2053  not set during S
+00010d50: 6368 6564 756c 6572 2074 7261 6e73 6974  cheduler transit
+00010d60: 696f 6e22 0a20 2020 2020 2020 2020 2020  ion".           
+00010d70: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00010d80: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00010d90: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+00010da0: 2020 2020 2020 2020 2020 2020 2022 5472               "Tr
+00010db0: 616e 7369 7469 6f6e 6564 2025 7220 2573  ansitioned %r %s
+00010dc0: 2d3e 2573 2028 6163 7475 616c 3a20 2573  ->%s (actual: %s
+00010dd0: 292e 2020 436f 6e73 6571 7565 6e63 653a  ).  Consequence:
+00010de0: 2025 7322 2c0a 2020 2020 2020 2020 2020   %s",.          
+00010df0: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
+00010e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e10: 2020 2073 7461 7274 2c0a 2020 2020 2020     start,.      
+00010e20: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00010e30: 6e69 7368 2c0a 2020 2020 2020 2020 2020  nish,.          
+00010e40: 2020 2020 2020 2020 2020 6163 7475 616c            actual
+00010e50: 5f66 696e 6973 682c 0a20 2020 2020 2020  _finish,.       
+00010e60: 2020 2020 2020 2020 2020 2020 2064 6963               dic
+00010e70: 7428 7265 636f 6d6d 656e 6461 7469 6f6e  t(recommendation
+00010e80: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00010e90: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00010ea0: 2020 6966 2073 656c 662e 706c 7567 696e    if self.plugin
+00010eb0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00010ec0: 2020 2023 2054 656d 706f 7261 7269 6c79     # Temporarily
+00010ed0: 2070 7574 2062 6163 6b20 666f 7267 6f74   put back forgot
+00010ee0: 7465 6e20 6b65 7920 666f 7220 706c 7567  ten key for plug
+00010ef0: 696e 2074 6f20 7265 7472 6965 7665 2069  in to retrieve i
+00010f00: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00010f10: 2020 6966 2074 732e 5f73 7461 7465 203d    if ts._state =
+00010f20: 3d20 2266 6f72 676f 7474 656e 223a 0a20  = "forgotten":. 
+00010f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f40: 2020 2074 732e 6465 7065 6e64 656e 7473     ts.dependents
+00010f50: 203d 2064 6570 656e 6465 6e74 730a 2020   = dependents.  
+00010f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010f70: 2020 7473 2e64 6570 656e 6465 6e63 6965    ts.dependencie
+00010f80: 7320 3d20 6465 7065 6e64 656e 6369 6573  s = dependencies
+00010f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010fa0: 2020 2020 2073 656c 662e 7461 736b 735b       self.tasks[
+00010fb0: 7473 2e6b 6579 5d20 3d20 7473 0a20 2020  ts.key] = ts.   
+00010fc0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010fd0: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00010fe0: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00010ff0: 7565 7328 2929 3a0a 2020 2020 2020 2020  ues()):.        
+00011000: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00011010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011020: 2020 2020 2020 2020 2070 6c75 6769 6e2e           plugin.
+00011030: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
+00011040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011050: 2020 2020 2020 2020 6b65 792c 2073 7461          key, sta
+00011060: 7274 2c20 6163 7475 616c 5f66 696e 6973  rt, actual_finis
+00011070: 682c 2073 7469 6d75 6c75 735f 6964 3d73  h, stimulus_id=s
+00011080: 7469 6d75 6c75 735f 6964 2c20 2a2a 6b77  timulus_id, **kw
+00011090: 6172 6773 0a20 2020 2020 2020 2020 2020  args.           
+000110a0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+000110b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110c0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+000110d0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+000110e0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+000110f0: 6765 722e 696e 666f 2822 506c 7567 696e  ger.info("Plugin
+00011100: 2066 6169 6c65 6420 7769 7468 2065 7863   failed with exc
+00011110: 6570 7469 6f6e 222c 2065 7863 5f69 6e66  eption", exc_inf
+00011120: 6f3d 5472 7565 290a 2020 2020 2020 2020  o=True).        
+00011130: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+00011140: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
+00011150: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+00011160: 2020 2020 2020 2020 6465 6c20 7365 6c66          del self
+00011170: 2e74 6173 6b73 5b74 732e 6b65 795d 0a0a  .tasks[ts.key]..
+00011180: 2020 2020 2020 2020 2020 2020 7467 203d              tg =
+00011190: 2074 732e 6772 6f75 700a 2020 2020 2020   ts.group.      
+000111a0: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
+000111b0: 6520 3d3d 2022 666f 7267 6f74 7465 6e22  e == "forgotten"
+000111c0: 2061 6e64 2074 672e 6e61 6d65 2069 6e20   and tg.name in 
+000111d0: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
+000111e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000111f0: 2020 2320 5265 6d6f 7665 2054 6173 6b47    # Remove TaskG
+00011200: 726f 7570 2069 6620 616c 6c20 7461 736b  roup if all task
+00011210: 7320 6172 6520 696e 2074 6865 2066 6f72  s are in the for
+00011220: 676f 7474 656e 2073 7461 7465 0a20 2020  gotten state.   
+00011230: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00011240: 616c 6c28 7620 3d3d 2030 206f 7220 6b20  all(v == 0 or k 
+00011250: 3d3d 2022 666f 7267 6f74 7465 6e22 2066  == "forgotten" f
+00011260: 6f72 206b 2c20 7620 696e 2074 672e 7374  or k, v in tg.st
+00011270: 6174 6573 2e69 7465 6d73 2829 293a 0a20  ates.items()):. 
+00011280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011290: 2020 2074 732e 7072 6566 6978 2e67 726f     ts.prefix.gro
+000112a0: 7570 732e 7265 6d6f 7665 2874 6729 0a20  ups.remove(tg). 
+000112b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112c0: 2020 2064 656c 2073 656c 662e 7461 736b     del self.task
+000112d0: 5f67 726f 7570 735b 7467 2e6e 616d 655d  _groups[tg.name]
+000112e0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+000112f0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+00011300: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+00011310: 732c 2077 6f72 6b65 725f 6d73 6773 0a20  s, worker_msgs. 
+00011320: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
+00011330: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
+00011340: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00011350: 7074 696f 6e28 2245 7272 6f72 2074 7261  ption("Error tra
+00011360: 6e73 6974 696f 6e69 6e67 2025 7220 6672  nsitioning %r fr
+00011370: 6f6d 2025 7220 746f 2025 7222 2c20 6b65  om %r to %r", ke
+00011380: 792c 2073 7461 7274 2c20 6669 6e69 7368  y, start, finish
+00011390: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000113a0: 204c 4f47 5f50 4442 3a0a 2020 2020 2020   LOG_PDB:.      
+000113b0: 2020 2020 2020 2020 2020 696d 706f 7274            import
+000113c0: 2070 6462 0a0a 2020 2020 2020 2020 2020   pdb..          
+000113d0: 2020 2020 2020 7064 622e 7365 745f 7472        pdb.set_tr
+000113e0: 6163 6528 290a 2020 2020 2020 2020 2020  ace().          
+000113f0: 2020 7261 6973 650a 0a20 2020 2064 6566    raise..    def
+00011400: 205f 7472 616e 7369 7469 6f6e 7328 0a20   _transitions(. 
+00011410: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00011420: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00011430: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
+00011440: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
+00011450: 204d 7367 732c 0a20 2020 2020 2020 2077   Msgs,.        w
+00011460: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00011470: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+00011480: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+00011490: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000114a0: 2020 2022 2222 5072 6f63 6573 7320 7472     """Process tr
+000114b0: 616e 7369 7469 6f6e 7320 756e 7469 6c20  ansitions until 
+000114c0: 6e6f 6e65 2061 7265 206c 6566 740a 0a20  none are left.. 
+000114d0: 2020 2020 2020 2054 6869 7320 696e 636c         This incl
+000114e0: 7564 6573 2066 6565 6462 6163 6b20 6672  udes feedback fr
+000114f0: 6f6d 2070 7265 7669 6f75 7320 7472 616e  om previous tran
+00011500: 7369 7469 6f6e 7320 616e 6420 636f 6e74  sitions and cont
+00011510: 696e 7565 7320 756e 7469 6c20 7765 0a20  inues until we. 
+00011520: 2020 2020 2020 2072 6561 6368 2061 2073         reach a s
+00011530: 7465 6164 7920 7374 6174 650a 2020 2020  teady state.    
+00011540: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00011550: 6b65 7973 3a20 7365 745b 7374 725d 203d  keys: set[str] =
+00011560: 2073 6574 2829 0a20 2020 2020 2020 2072   set().        r
+00011570: 6563 6f6d 6d65 6e64 6174 696f 6e73 203d  ecommendations =
+00011580: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00011590: 2e63 6f70 7928 290a 0a20 2020 2020 2020  .copy()..       
+000115a0: 2077 6869 6c65 2072 6563 6f6d 6d65 6e64   while recommend
+000115b0: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
+000115c0: 2020 2020 6b65 792c 2066 696e 6973 6820      key, finish 
+000115d0: 3d20 7265 636f 6d6d 656e 6461 7469 6f6e  = recommendation
+000115e0: 732e 706f 7069 7465 6d28 290a 2020 2020  s.popitem().    
+000115f0: 2020 2020 2020 2020 6b65 7973 2e61 6464          keys.add
+00011600: 286b 6579 290a 0a20 2020 2020 2020 2020  (key)..         
+00011610: 2020 206e 6577 5f72 6563 732c 206e 6577     new_recs, new
+00011620: 5f63 6d73 6773 2c20 6e65 775f 776d 7367  _cmsgs, new_wmsg
+00011630: 7320 3d20 7365 6c66 2e5f 7472 616e 7369  s = self._transi
+00011640: 7469 6f6e 286b 6579 2c20 6669 6e69 7368  tion(key, finish
+00011650: 2c20 7374 696d 756c 7573 5f69 6429 0a0a  , stimulus_id)..
+00011660: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00011670: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
+00011680: 7465 286e 6577 5f72 6563 7329 0a20 2020  te(new_recs).   
+00011690: 2020 2020 2020 2020 2066 6f72 2063 2c20           for c, 
+000116a0: 6e65 775f 6d73 6773 2069 6e20 6e65 775f  new_msgs in new_
+000116b0: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
+000116c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000116d0: 6c69 656e 745f 6d73 6773 2e73 6574 6465  lient_msgs.setde
+000116e0: 6661 756c 7428 632c 205b 5d29 2e65 7874  fault(c, []).ext
+000116f0: 656e 6428 6e65 775f 6d73 6773 290a 2020  end(new_msgs).  
+00011700: 2020 2020 2020 2020 2020 666f 7220 772c            for w,
+00011710: 206e 6577 5f6d 7367 7320 696e 206e 6577   new_msgs in new
+00011720: 5f77 6d73 6773 2e69 7465 6d73 2829 3a0a  _wmsgs.items():.
+00011730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011740: 776f 726b 6572 5f6d 7367 732e 7365 7464  worker_msgs.setd
+00011750: 6566 6175 6c74 2877 2c20 5b5d 292e 6578  efault(w, []).ex
+00011760: 7465 6e64 286e 6577 5f6d 7367 7329 0a0a  tend(new_msgs)..
+00011770: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00011780: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00011790: 2020 2020 2020 2320 4649 584d 4520 646f        # FIXME do
+000117a0: 776e 6361 7374 2061 6e74 6970 6174 7465  wncast antipatte
+000117b0: 726e 0a20 2020 2020 2020 2020 2020 2073  rn.            s
+000117c0: 6368 6564 756c 6572 203d 2063 6173 7428  cheduler = cast(
+000117d0: 5363 6865 6475 6c65 722c 2073 656c 6629  Scheduler, self)
+000117e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000117f0: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+00011800: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+00011810: 6865 6475 6c65 722e 7661 6c69 6461 7465  heduler.validate
+00011820: 5f6b 6579 286b 6579 290a 0a20 2020 2064  _key(key)..    d
+00011830: 6566 2074 7261 6e73 6974 696f 6e5f 7265  ef transition_re
+00011840: 6c65 6173 6564 5f77 6169 7469 6e67 2873  leased_waiting(s
+00011850: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
+00011860: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
+00011870: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00011880: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00011890: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+000118a0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+000118b0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+000118c0: 2020 6173 7365 7274 2074 732e 7275 6e5f    assert ts.run_
+000118d0: 7370 6563 0a20 2020 2020 2020 2020 2020  spec.           
+000118e0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+000118f0: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+00011900: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00011910: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+00011920: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00011930: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
+00011940: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
+00011950: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00011960: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+00011970: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00011980: 7274 2064 7473 2e73 7461 7465 206e 6f74  rt dts.state not
+00011990: 2069 6e20 7b22 666f 7267 6f74 7465 6e22   in {"forgotten"
+000119a0: 2c20 2265 7272 6564 227d 0a0a 2020 2020  , "erred"}..    
+000119b0: 2020 2020 6966 2074 732e 6861 735f 6c6f      if ts.has_lo
+000119c0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
+000119d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000119e0: 7572 6e20 7b6b 6579 3a20 2266 6f72 676f  urn {key: "forgo
+000119f0: 7474 656e 227d 2c20 7b7d 2c20 7b7d 0a0a  tten"}, {}, {}..
+00011a00: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00011a10: 203d 2022 7761 6974 696e 6722 0a0a 2020   = "waiting"..  
+00011a20: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00011a30: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00011a40: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
+00011a50: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00011a60: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00011a70: 2020 6966 206e 6f74 2064 7473 2e77 686f    if not dts.who
+00011a80: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
+00011a90: 2020 2020 2020 7473 2e77 6169 7469 6e67        ts.waiting
+00011aa0: 5f6f 6e2e 6164 6428 6474 7329 0a20 2020  _on.add(dts).   
+00011ab0: 2020 2020 2020 2020 2069 6620 6474 732e           if dts.
+00011ac0: 7374 6174 6520 3d3d 2022 7265 6c65 6173  state == "releas
+00011ad0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+00011ae0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00011af0: 696f 6e73 5b64 7473 2e6b 6579 5d20 3d20  ions[dts.key] = 
+00011b00: 2277 6169 7469 6e67 220a 2020 2020 2020  "waiting".      
+00011b10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00011b20: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+00011b30: 7761 6974 6572 732e 6164 6428 7473 290a  waiters.add(ts).
+00011b40: 0a20 2020 2020 2020 2074 732e 7761 6974  .        ts.wait
+00011b50: 6572 7320 3d20 7b64 7473 2066 6f72 2064  ers = {dts for d
+00011b60: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00011b70: 6e74 7320 6966 2064 7473 2e73 7461 7465  nts if dts.state
+00011b80: 203d 3d20 2277 6169 7469 6e67 227d 0a0a   == "waiting"}..
+00011b90: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+00011ba0: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
+00011bb0: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00011bc0: 3a20 7761 6974 696e 672d 3e70 726f 6365  : waiting->proce
+00011bd0: 7373 696e 6720 7769 6c6c 2073 656e 6420  ssing will send 
+00011be0: 7461 736b 7320 746f 2071 7565 7565 6420  tasks to queued 
+00011bf0: 6f72 206e 6f2d 776f 726b 6572 2061 730a  or no-worker as.
+00011c00: 2020 2020 2020 2020 2020 2020 2320 6e65              # ne
+00011c10: 6365 7373 6172 790a 2020 2020 2020 2020  cessary.        
+00011c20: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00011c30: 6f6e 735b 6b65 795d 203d 2022 7072 6f63  ons[key] = "proc
+00011c40: 6573 7369 6e67 220a 0a20 2020 2020 2020  essing"..       
+00011c50: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+00011c60: 6461 7469 6f6e 732c 207b 7d2c 207b 7d0a  dations, {}, {}.
+00011c70: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
+00011c80: 696f 6e5f 6e6f 5f77 6f72 6b65 725f 7072  ion_no_worker_pr
+00011c90: 6f63 6573 7369 6e67 2873 656c 662c 206b  ocessing(self, k
+00011ca0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00011cb0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00011cc0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00011cd0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00011ce0: 6b65 795d 0a20 2020 2020 2020 2077 6f72  key].        wor
+00011cf0: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
+00011d00: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+00011d10: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
 00011d20: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00011d30: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
-00011d40: 756e 6e61 626c 650a 0a20 2020 2020 2020  unnable..       
-00011d50: 2069 6620 7773 203a 3d20 7365 6c66 2e64   if ws := self.d
-00011d60: 6563 6964 655f 776f 726b 6572 5f6e 6f6e  ecide_worker_non
-00011d70: 5f72 6f6f 7469 7368 2874 7329 3a0a 2020  _rootish(ts):.  
-00011d80: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-00011d90: 6e72 756e 6e61 626c 652e 6469 7363 6172  nrunnable.discar
-00011da0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00011db0: 2020 776f 726b 6572 5f6d 7367 7320 3d20    worker_msgs = 
-00011dc0: 7365 6c66 2e5f 6164 645f 746f 5f70 726f  self._add_to_pro
-00011dd0: 6365 7373 696e 6728 7473 2c20 7773 290a  cessing(ts, ws).
-00011de0: 2020 2020 2020 2020 2320 4966 206e 6f20          # If no 
-00011df0: 776f 726b 6572 2c20 7461 736b 206a 7573  worker, task jus
-00011e00: 7420 7374 6179 7320 696e 2060 6e6f 2d77  t stays in `no-w
-00011e10: 6f72 6b65 7260 0a0a 2020 2020 2020 2020  orker`..        
-00011e20: 7265 7475 726e 207b 7d2c 207b 7d2c 2077  return {}, {}, w
-00011e30: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-00011e40: 6465 6620 6465 6369 6465 5f77 6f72 6b65  def decide_worke
-00011e50: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
-00011e60: 675f 6469 7361 626c 6564 280a 2020 2020  g_disabled(.    
-00011e70: 2020 2020 7365 6c66 2c20 7473 3a20 5461      self, ts: Ta
-00011e80: 736b 5374 6174 650a 2020 2020 2920 2d3e  skState.    ) ->
-00011e90: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
-00011ea0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00011eb0: 5069 636b 2061 2077 6f72 6b65 7220 666f  Pick a worker fo
-00011ec0: 7220 6120 7275 6e6e 6162 6c65 2072 6f6f  r a runnable roo
-00011ed0: 742d 6973 6820 7461 736b 2c20 7769 7468  t-ish task, with
-00011ee0: 6f75 7420 7175 6575 696e 672e 0a0a 2020  out queuing...  
-00011ef0: 2020 2020 2020 5468 6973 2061 7474 656d        This attem
-00011f00: 7074 7320 746f 2073 6368 6564 756c 6520  pts to schedule 
-00011f10: 7369 626c 696e 6720 7461 736b 7320 6f6e  sibling tasks on
-00011f20: 2074 6865 2073 616d 6520 776f 726b 6572   the same worker
-00011f30: 2c20 7265 6475 6369 6e67 2066 7574 7572  , reducing futur
-00011f40: 6520 6461 7461 0a20 2020 2020 2020 2074  e data.        t
-00011f50: 7261 6e73 6665 722e 2049 7420 646f 6573  ransfer. It does
-00011f60: 206e 6f74 2063 6f6e 7369 6465 7220 7468   not consider th
-00011f70: 6520 6c6f 6361 7469 6f6e 206f 6620 6465  e location of de
-00011f80: 7065 6e64 656e 6369 6573 2c20 7369 6e63  pendencies, sinc
-00011f90: 6520 7468 6579 276c 6c20 656e 640a 2020  e they'll end.  
-00011fa0: 2020 2020 2020 7570 206f 6e20 6576 6572        up on ever
-00011fb0: 7920 776f 726b 6572 2061 6e79 7761 792e  y worker anyway.
-00011fc0: 0a0a 2020 2020 2020 2020 4974 2061 7373  ..        It ass
-00011fd0: 756d 6573 2069 7427 7320 6265 696e 6720  umes it's being 
-00011fe0: 6361 6c6c 6564 206f 6e20 6120 6261 7463  called on a batc
-00011ff0: 6820 6f66 2074 6173 6b73 2069 6e20 7072  h of tasks in pr
-00012000: 696f 7269 7479 206f 7264 6572 2c20 616e  iority order, an
-00012010: 640a 2020 2020 2020 2020 6d61 696e 7461  d.        mainta
-00012020: 696e 7320 7374 6174 6520 696e 2060 5363  ins state in `Sc
-00012030: 6865 6475 6c65 7253 7461 7465 2e6c 6173  hedulerState.las
-00012040: 745f 726f 6f74 5f77 6f72 6b65 7260 2061  t_root_worker` a
-00012050: 6e64 0a20 2020 2020 2020 2060 5363 6865  nd.        `Sche
-00012060: 6475 6c65 7253 7461 7465 2e6c 6173 745f  dulerState.last_
-00012070: 726f 6f74 5f77 6f72 6b65 725f 7461 736b  root_worker_task
-00012080: 735f 6c65 6674 6020 746f 2061 6368 6965  s_left` to achie
-00012090: 7665 2074 6869 732e 0a0a 2020 2020 2020  ve this...      
-000120a0: 2020 5468 6973 2077 696c 6c20 7365 6e64    This will send
-000120b0: 2065 7665 7279 2072 756e 6e61 626c 6520   every runnable 
-000120c0: 7461 736b 2074 6f20 6120 776f 726b 6572  task to a worker
-000120d0: 2c20 6f66 7465 6e20 6361 7573 696e 6720  , often causing 
-000120e0: 726f 6f74 2074 6173 6b0a 2020 2020 2020  root task.      
-000120f0: 2020 6f76 6572 7072 6f64 7563 7469 6f6e    overproduction
-00012100: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-00012110: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-00012120: 2d2d 0a20 2020 2020 2020 2077 733a 2057  --.        ws: W
-00012130: 6f72 6b65 7253 7461 7465 207c 204e 6f6e  orkerState | Non
-00012140: 650a 2020 2020 2020 2020 2020 2020 5468  e.            Th
-00012150: 6520 776f 726b 6572 2074 6f20 6173 7369  e worker to assi
-00012160: 676e 2074 6865 2074 6173 6b20 746f 2e20  gn the task to. 
-00012170: 4966 2074 6865 7265 2061 7265 206e 6f20  If there are no 
-00012180: 776f 726b 6572 7320 696e 2074 6865 2063  workers in the c
-00012190: 6c75 7374 6572 2c0a 2020 2020 2020 2020  luster,.        
-000121a0: 2020 2020 7265 7475 726e 7320 4e6f 6e65      returns None
-000121b0: 2c20 696e 2077 6869 6368 2063 6173 6520  , in which case 
-000121c0: 7468 6520 7461 736b 2073 686f 756c 6420  the task should 
-000121d0: 6265 2074 7261 6e73 6974 696f 6e65 6420  be transitioned 
-000121e0: 746f 0a20 2020 2020 2020 2020 2020 2060  to.            `
-000121f0: 606e 6f2d 776f 726b 6572 6060 2e0a 2020  `no-worker``..  
-00012200: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00012210: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00012220: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00012230: 2320 5365 6520 726f 6f74 2d69 7368 2d6e  # See root-ish-n
-00012240: 6573 7320 6e6f 7465 2062 656c 6f77 2069  ess note below i
-00012250: 6e20 6064 6563 6964 655f 776f 726b 6572  n `decide_worker
-00012260: 5f72 6f6f 7469 7368 5f71 7565 7569 6e67  _rootish_queuing
-00012270: 5f65 6e61 626c 6564 600a 2020 2020 2020  _enabled`.      
-00012280: 2020 2020 2020 6173 7365 7274 206d 6174        assert mat
-00012290: 682e 6973 696e 6628 7365 6c66 2e57 4f52  h.isinf(self.WOR
-000122a0: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
-000122b0: 0a20 2020 2020 2020 2070 6f6f 6c20 3d20  .        pool = 
-000122c0: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
-000122d0: 2829 2069 6620 7365 6c66 2e69 646c 6520  () if self.idle 
-000122e0: 656c 7365 2073 656c 662e 7275 6e6e 696e  else self.runnin
-000122f0: 670a 2020 2020 2020 2020 6966 206e 6f74  g.        if not
-00012300: 2070 6f6f 6c3a 0a20 2020 2020 2020 2020   pool:.         
-00012310: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00012320: 2020 2020 2020 2020 7467 203d 2074 732e          tg = ts.
-00012330: 6772 6f75 700a 2020 2020 2020 2020 6c77  group.        lw
-00012340: 7320 3d20 7467 2e6c 6173 745f 776f 726b  s = tg.last_work
-00012350: 6572 0a20 2020 2020 2020 2069 6620 280a  er.        if (.
-00012360: 2020 2020 2020 2020 2020 2020 6c77 730a              lws.
-00012370: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00012380: 7467 2e6c 6173 745f 776f 726b 6572 5f74  tg.last_worker_t
-00012390: 6173 6b73 5f6c 6566 740a 2020 2020 2020  asks_left.      
-000123a0: 2020 2020 2020 616e 6420 6c77 732e 7374        and lws.st
-000123b0: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
-000123c0: 756e 6e69 6e67 0a20 2020 2020 2020 2020  unning.         
-000123d0: 2020 2061 6e64 2073 656c 662e 776f 726b     and self.work
-000123e0: 6572 732e 6765 7428 6c77 732e 6164 6472  ers.get(lws.addr
-000123f0: 6573 7329 2069 7320 6c77 730a 2020 2020  ess) is lws.    
-00012400: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
-00012410: 2020 2077 7320 3d20 6c77 730a 2020 2020     ws = lws.    
-00012420: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012430: 2020 2020 2020 2320 4c61 7374 2d75 7365        # Last-use
-00012440: 6420 776f 726b 6572 2069 7320 6675 6c6c  d worker is full
-00012450: 2c20 756e 6b6e 6f77 6e2c 2072 6574 6972  , unknown, retir
-00012460: 696e 672c 206f 7220 7061 7573 6564 3b0a  ing, or paused;.
-00012470: 2020 2020 2020 2020 2020 2020 2320 7069              # pi
-00012480: 636b 2061 206e 6577 2077 6f72 6b65 7220  ck a new worker 
-00012490: 666f 7220 7468 6520 6e65 7874 2066 6577  for the next few
-000124a0: 2074 6173 6b73 0a20 2020 2020 2020 2020   tasks.         
-000124b0: 2020 2077 7320 3d20 6d69 6e28 706f 6f6c     ws = min(pool
-000124c0: 2c20 6b65 793d 7061 7274 6961 6c28 7365  , key=partial(se
-000124d0: 6c66 2e77 6f72 6b65 725f 6f62 6a65 6374  lf.worker_object
-000124e0: 6976 652c 2074 7329 290a 2020 2020 2020  ive, ts)).      
-000124f0: 2020 2020 2020 7467 2e6c 6173 745f 776f        tg.last_wo
-00012500: 726b 6572 5f74 6173 6b73 5f6c 6566 7420  rker_tasks_left 
-00012510: 3d20 6d61 7468 2e66 6c6f 6f72 280a 2020  = math.floor(.  
-00012520: 2020 2020 2020 2020 2020 2020 2020 286c                (l
-00012530: 656e 2874 6729 202f 2073 656c 662e 746f  en(tg) / self.to
-00012540: 7461 6c5f 6e74 6872 6561 6473 2920 2a20  tal_nthreads) * 
-00012550: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
-00012560: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00012570: 2020 2023 2052 6563 6f72 6420 606c 6173     # Record `las
-00012580: 745f 776f 726b 6572 602c 206f 7220 636c  t_worker`, or cl
-00012590: 6561 7220 6974 206f 6e20 7468 6520 6669  ear it on the fi
-000125a0: 6e61 6c20 7461 736b 0a20 2020 2020 2020  nal task.       
-000125b0: 2074 672e 6c61 7374 5f77 6f72 6b65 7220   tg.last_worker 
-000125c0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-000125d0: 7773 2069 6620 7467 2e73 7461 7465 735b  ws if tg.states[
-000125e0: 2272 656c 6561 7365 6422 5d20 2b20 7467  "released"] + tg
-000125f0: 2e73 7461 7465 735b 2277 6169 7469 6e67  .states["waiting
-00012600: 225d 203e 2031 2065 6c73 6520 4e6f 6e65  "] > 1 else None
-00012610: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00012620: 2020 2074 672e 6c61 7374 5f77 6f72 6b65     tg.last_worke
-00012630: 725f 7461 736b 735f 6c65 6674 202d 3d20  r_tasks_left -= 
-00012640: 310a 0a20 2020 2020 2020 2069 6620 7365  1..        if se
-00012650: 6c66 2e76 616c 6964 6174 6520 616e 6420  lf.validate and 
-00012660: 7773 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ws is not None:.
-00012670: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00012680: 7274 2073 656c 662e 776f 726b 6572 732e  rt self.workers.
-00012690: 6765 7428 7773 2e61 6464 7265 7373 2920  get(ws.address) 
-000126a0: 6973 2077 730a 2020 2020 2020 2020 2020  is ws.          
-000126b0: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
-000126c0: 656c 662e 7275 6e6e 696e 672c 2028 7773  elf.running, (ws
-000126d0: 2c20 7365 6c66 2e72 756e 6e69 6e67 290a  , self.running).
-000126e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000126f0: 7773 0a0a 2020 2020 6465 6620 6465 6369  ws..    def deci
-00012700: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
-00012710: 685f 7175 6575 696e 675f 656e 6162 6c65  h_queuing_enable
-00012720: 6428 7365 6c66 2920 2d3e 2057 6f72 6b65  d(self) -> Worke
-00012730: 7253 7461 7465 207c 204e 6f6e 653a 0a20  rState | None:. 
-00012740: 2020 2020 2020 2022 2222 5069 636b 2061         """Pick a
-00012750: 2077 6f72 6b65 7220 666f 7220 6120 7275   worker for a ru
-00012760: 6e6e 6162 6c65 2072 6f6f 742d 6973 6820  nnable root-ish 
-00012770: 7461 736b 2c20 6966 206e 6f74 2061 6c6c  task, if not all
-00012780: 2061 7265 2062 7573 792e 0a0a 2020 2020   are busy...    
-00012790: 2020 2020 5069 636b 7320 7468 6520 6c65      Picks the le
-000127a0: 6173 742d 6275 7379 2077 6f72 6b65 7220  ast-busy worker 
-000127b0: 6f75 7420 6f66 2074 6865 2060 6069 646c  out of the ``idl
-000127c0: 6560 6020 776f 726b 6572 7320 2869 646c  e`` workers (idl
-000127d0: 6520 776f 726b 6572 7320 6861 7665 2066  e workers have f
-000127e0: 6577 6572 0a20 2020 2020 2020 2074 6173  ewer.        tas
-000127f0: 6b73 2072 756e 6e69 6e67 2074 6861 6e20  ks running than 
-00012800: 7468 7265 6164 732c 2061 7320 7365 7420  threads, as set 
-00012810: 6279 2060 6064 6973 7472 6962 7574 6564  by ``distributed
-00012820: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
-00012830: 722d 7361 7475 7261 7469 6f6e 6060 292e  r-saturation``).
-00012840: 0a20 2020 2020 2020 2049 7420 646f 6573  .        It does
-00012850: 206e 6f74 2063 6f6e 7369 6465 7220 7468   not consider th
-00012860: 6520 6c6f 6361 7469 6f6e 206f 6620 6465  e location of de
-00012870: 7065 6e64 656e 6369 6573 2c20 7369 6e63  pendencies, sinc
-00012880: 6520 7468 6579 276c 6c20 656e 6420 7570  e they'll end up
-00012890: 206f 6e20 6576 6572 790a 2020 2020 2020   on every.      
-000128a0: 2020 776f 726b 6572 2061 6e79 7761 792e    worker anyway.
-000128b0: 0a0a 2020 2020 2020 2020 4966 2061 6c6c  ..        If all
-000128c0: 2077 6f72 6b65 7273 2061 7265 2066 756c   workers are ful
-000128d0: 6c2c 2072 6574 7572 6e73 204e 6f6e 652c  l, returns None,
-000128e0: 206d 6561 6e69 6e67 2074 6865 2074 6173   meaning the tas
-000128f0: 6b20 7368 6f75 6c64 2074 7261 6e73 6974  k should transit
-00012900: 696f 6e20 746f 0a20 2020 2020 2020 2060  ion to.        `
-00012910: 6071 7565 7565 6460 602e 2054 6865 2073  `queued``. The s
-00012920: 6368 6564 756c 6572 2077 696c 6c20 7761  cheduler will wa
-00012930: 6974 2074 6f20 7365 6e64 2069 7420 746f  it to send it to
-00012940: 2061 2077 6f72 6b65 7220 756e 7469 6c20   a worker until 
-00012950: 6120 7468 7265 6164 206f 7065 6e73 0a20  a thread opens. 
-00012960: 2020 2020 2020 2075 702e 2054 6869 7320         up. This 
-00012970: 656e 7375 7265 7320 7468 6174 2064 6f77  ensures that dow
-00012980: 6e73 7472 6561 6d20 7461 736b 7320 616c  nstream tasks al
-00012990: 7761 7973 2072 756e 2062 6566 6f72 6520  ways run before 
-000129a0: 6e65 7720 726f 6f74 2074 6173 6b73 2061  new root tasks a
-000129b0: 7265 0a20 2020 2020 2020 2073 7461 7274  re.        start
-000129c0: 6564 2e0a 0a20 2020 2020 2020 2054 6869  ed...        Thi
-000129d0: 7320 646f 6573 206e 6f74 2074 7279 2074  s does not try t
-000129e0: 6f20 7363 6865 6475 6c65 2073 6962 6c69  o schedule sibli
-000129f0: 6e67 2074 6173 6b73 206f 6e20 7468 6520  ng tasks on the 
-00012a00: 7361 6d65 2077 6f72 6b65 723b 2069 6e20  same worker; in 
-00012a10: 6661 6374 2c20 6974 0a20 2020 2020 2020  fact, it.       
-00012a20: 2075 7375 616c 6c79 2064 6f65 7320 7468   usually does th
-00012a30: 6520 6f70 706f 7369 7465 2e20 4576 656e  e opposite. Even
-00012a40: 2074 686f 7567 6820 7468 6973 2069 6e63   though this inc
-00012a50: 7265 6173 6573 2073 7562 7365 7175 656e  reases subsequen
-00012a60: 7420 6461 7461 2074 7261 6e73 6665 722c  t data transfer,
-00012a70: 0a20 2020 2020 2020 2069 7420 7479 7069  .        it typi
-00012a80: 6361 6c6c 7920 7265 6475 6365 7320 6f76  cally reduces ov
-00012a90: 6572 616c 6c20 6d65 6d6f 7279 2075 7365  erall memory use
-00012aa0: 2062 7920 656c 696d 696e 6174 696e 6720   by eliminating 
-00012ab0: 726f 6f74 2074 6173 6b20 6f76 6572 7072  root task overpr
-00012ac0: 6f64 7563 7469 6f6e 2e0a 0a20 2020 2020  oduction...     
-00012ad0: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00012ae0: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00012af0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
-00012b00: 7465 207c 204e 6f6e 650a 2020 2020 2020  te | None.      
-00012b10: 2020 2020 2020 5468 6520 776f 726b 6572        The worker
-00012b20: 2074 6f20 6173 7369 676e 2074 6865 2074   to assign the t
-00012b30: 6173 6b20 746f 2e20 4966 2074 6865 7265  ask to. If there
-00012b40: 2061 7265 206e 6f20 6964 6c65 2077 6f72   are no idle wor
-00012b50: 6b65 7273 2c20 7265 7475 726e 730a 2020  kers, returns.  
-00012b60: 2020 2020 2020 2020 2020 4e6f 6e65 2c20            None, 
-00012b70: 696e 2077 6869 6368 2063 6173 6520 7468  in which case th
-00012b80: 6520 7461 736b 2073 686f 756c 6420 6265  e task should be
-00012b90: 2074 7261 6e73 6974 696f 6e65 6420 746f   transitioned to
-00012ba0: 2060 6071 7565 7565 6460 602e 0a0a 2020   ``queued``...  
-00012bb0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00012bc0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00012bd0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00012be0: 2320 5765 2064 6f6e 2774 2060 6173 7365  # We don't `asse
-00012bf0: 7274 2073 656c 662e 6973 5f72 6f6f 7469  rt self.is_rooti
-00012c00: 7368 2874 7329 6020 6865 7265 2c20 6265  sh(ts)` here, be
-00012c10: 6361 7573 6520 7468 6174 2063 6865 636b  cause that check
-00012c20: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-00012c30: 2320 6465 7065 6e64 656e 7420 6f6e 2063  # dependent on c
-00012c40: 6c75 7374 6572 2073 697a 652e 2049 7427  luster size. It'
-00012c50: 7320 706f 7373 6962 6c65 2061 2074 6173  s possible a tas
-00012c60: 6b20 6c6f 6f6b 6564 2072 6f6f 742d 6973  k looked root-is
-00012c70: 6820 7768 656e 2069 740a 2020 2020 2020  h when it.      
-00012c80: 2020 2020 2020 2320 7761 7320 7175 6575        # was queu
-00012c90: 6564 2c20 6275 7420 7468 6520 636c 7573  ed, but the clus
-00012ca0: 7465 7220 6861 7320 7369 6e63 6520 7363  ter has since sc
-00012cb0: 616c 6564 2075 7020 616e 6420 6974 206e  aled up and it n
-00012cc0: 6f20 6c6f 6e67 6572 2064 6f65 7320 7768  o longer does wh
-00012cd0: 656e 0a20 2020 2020 2020 2020 2020 2023  en.            #
-00012ce0: 2063 6f6d 696e 6720 6f75 7420 6f66 2074   coming out of t
-00012cf0: 6865 2071 7565 7565 2e20 4966 2060 6973  he queue. If `is
-00012d00: 5f72 6f6f 7469 7368 6020 6368 616e 6765  _rootish` change
-00012d10: 7320 746f 2061 2073 7461 7469 6320 6465  s to a static de
-00012d20: 6669 6e69 7469 6f6e 2c0a 2020 2020 2020  finition,.      
-00012d30: 2020 2020 2020 2320 7468 656e 2061 6464        # then add
-00012d40: 2074 6861 7420 6173 7365 7274 696f 6e20   that assertion 
-00012d50: 6865 7265 2028 616e 6420 6163 7475 616c  here (and actual
-00012d60: 6c79 2070 6173 7320 696e 2074 6865 2074  ly pass in the t
-00012d70: 6173 6b29 2e0a 2020 2020 2020 2020 2020  ask)..          
-00012d80: 2020 6173 7365 7274 206e 6f74 206d 6174    assert not mat
-00012d90: 682e 6973 696e 6628 7365 6c66 2e57 4f52  h.isinf(self.WOR
-00012da0: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
-00012db0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00012dc0: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-00012dd0: 6f75 6e74 3a0a 2020 2020 2020 2020 2020  ount:.          
-00012de0: 2020 2320 416c 6c20 776f 726b 6572 7320    # All workers 
-00012df0: 6275 7379 3f20 5461 736b 2067 6574 732f  busy? Task gets/
-00012e00: 7374 6179 7320 7175 6575 6564 2e0a 2020  stays queued..  
-00012e10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00012e20: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
-00012e30: 204a 7573 7420 7069 636b 2074 6865 206c   Just pick the l
-00012e40: 6561 7374 2062 7573 7920 776f 726b 6572  east busy worker
-00012e50: 2e0a 2020 2020 2020 2020 2320 4e4f 5445  ..        # NOTE
-00012e60: 3a20 7468 6973 2077 696c 6c20 6c65 6164  : this will lead
-00012e70: 2074 6f20 776f 7273 742d 6361 7365 2073   to worst-case s
-00012e80: 6368 6564 756c 696e 6720 7769 7468 2072  cheduling with r
-00012e90: 6567 6172 6473 2074 6f20 636f 2d61 7373  egards to co-ass
-00012ea0: 6967 6e6d 656e 742e 0a20 2020 2020 2020  ignment..       
-00012eb0: 2077 7320 3d20 6d69 6e28 0a20 2020 2020   ws = min(.     
-00012ec0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-00012ed0: 5f74 6173 6b5f 636f 756e 742c 0a20 2020  _task_count,.   
-00012ee0: 2020 2020 2020 2020 206b 6579 3d6c 616d           key=lam
-00012ef0: 6264 6120 7773 3a20 6c65 6e28 7773 2e70  bda ws: len(ws.p
-00012f00: 726f 6365 7373 696e 6729 202f 2077 732e  rocessing) / ws.
-00012f10: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
-00012f20: 2020 290a 2020 2020 2020 2020 6966 2073    ).        if s
-00012f30: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00012f40: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00012f50: 206e 6f74 205f 776f 726b 6572 5f66 756c   not _worker_ful
-00012f60: 6c28 7773 2c20 7365 6c66 2e57 4f52 4b45  l(ws, self.WORKE
-00012f70: 525f 5341 5455 5241 5449 4f4e 292c 2028  R_SATURATION), (
-00012f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012f90: 2077 732c 0a20 2020 2020 2020 2020 2020   ws,.           
-00012fa0: 2020 2020 205f 7461 736b 5f73 6c6f 7473       _task_slots
-00012fb0: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
-00012fc0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-00012fd0: 4154 494f 4e29 2c0a 2020 2020 2020 2020  ATION),.        
-00012fe0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00012ff0: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
-00013000: 656c 662e 7275 6e6e 696e 672c 2028 7773  elf.running, (ws
-00013010: 2c20 7365 6c66 2e72 756e 6e69 6e67 290a  , self.running).
-00013020: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013030: 2e76 616c 6964 6174 6520 616e 6420 7773  .validate and ws
-00013040: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00013050: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00013060: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00013070: 7428 7773 2e61 6464 7265 7373 2920 6973  t(ws.address) is
-00013080: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
-00013090: 6173 7365 7274 2077 7320 696e 2073 656c  assert ws in sel
-000130a0: 662e 7275 6e6e 696e 672c 2028 7773 2c20  f.running, (ws, 
-000130b0: 7365 6c66 2e72 756e 6e69 6e67 290a 0a20  self.running).. 
-000130c0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
-000130d0: 0a0a 2020 2020 6465 6620 6465 6369 6465  ..    def decide
-000130e0: 5f77 6f72 6b65 725f 6e6f 6e5f 726f 6f74  _worker_non_root
-000130f0: 6973 6828 7365 6c66 2c20 7473 3a20 5461  ish(self, ts: Ta
-00013100: 736b 5374 6174 6529 202d 3e20 576f 726b  skState) -> Work
-00013110: 6572 5374 6174 6520 7c20 4e6f 6e65 3a0a  erState | None:.
-00013120: 2020 2020 2020 2020 2222 2250 6963 6b20          """Pick 
-00013130: 6120 776f 726b 6572 2066 6f72 2061 2072  a worker for a r
-00013140: 756e 6e61 626c 6520 6e6f 6e2d 726f 6f74  unnable non-root
-00013150: 2074 6173 6b2c 2063 6f6e 7369 6465 7269   task, consideri
-00013160: 6e67 2064 6570 656e 6465 6e63 6965 7320  ng dependencies 
-00013170: 616e 640a 2020 2020 2020 2020 7265 7374  and.        rest
-00013180: 7269 6374 696f 6e73 2e0a 0a20 2020 2020  rictions...     
-00013190: 2020 204f 7574 206f 6620 656c 6967 6962     Out of eligib
-000131a0: 6c65 2077 6f72 6b65 7273 2068 6f6c 6469  le workers holdi
-000131b0: 6e67 2064 6570 656e 6465 6e63 6965 7320  ng dependencies 
-000131c0: 6f66 2060 6074 7360 602c 2073 656c 6563  of ``ts``, selec
-000131d0: 7473 2074 6865 2077 6f72 6b65 720a 2020  ts the worker.  
-000131e0: 2020 2020 2020 7768 6572 652c 2063 6f6e        where, con
-000131f0: 7369 6465 7269 6e67 2077 6f72 6b65 7220  sidering worker 
-00013200: 6261 636b 6c6f 6e67 2061 6e64 2064 6174  backlong and dat
-00013210: 612d 7472 616e 7366 6572 2063 6f73 7473  a-transfer costs
-00013220: 2c20 7468 6520 7461 736b 2069 730a 2020  , the task is.  
-00013230: 2020 2020 2020 6573 7469 6d61 7465 6420        estimated 
-00013240: 746f 2073 7461 7274 2072 756e 6e69 6e67  to start running
-00013250: 2074 6865 2073 6f6f 6e65 7374 2e0a 0a20   the soonest... 
-00013260: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
-00013270: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
-00013280: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
-00013290: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
-000132a0: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
-000132b0: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
-000132c0: 6865 2074 6173 6b20 746f 2e20 4966 206e  he task to. If n
-000132d0: 6f20 776f 726b 6572 7320 7361 7469 7366  o workers satisf
-000132e0: 7920 7468 6520 7265 7374 7269 6374 696f  y the restrictio
-000132f0: 6e73 206f 660a 2020 2020 2020 2020 2020  ns of.          
-00013300: 2020 6060 7473 6060 206f 7220 7468 6572    ``ts`` or ther
-00013310: 6520 6172 6520 6e6f 2072 756e 6e69 6e67  e are no running
-00013320: 2077 6f72 6b65 7273 2c20 7265 7475 726e   workers, return
-00013330: 7320 4e6f 6e65 2c20 696e 2077 6869 6368  s None, in which
-00013340: 2063 6173 6520 7468 6520 7461 736b 0a20   case the task. 
-00013350: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
-00013360: 6420 6265 2074 7261 6e73 6974 696f 6e65  d be transitione
-00013370: 6420 746f 2060 606e 6f2d 776f 726b 6572  d to ``no-worker
-00013380: 6060 2e0a 2020 2020 2020 2020 2222 220a  ``..        """.
-00013390: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-000133a0: 656c 662e 7275 6e6e 696e 673a 0a20 2020  elf.running:.   
-000133b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000133c0: 4e6f 6e65 0a0a 2020 2020 2020 2020 7661  None..        va
-000133d0: 6c69 645f 776f 726b 6572 7320 3d20 7365  lid_workers = se
-000133e0: 6c66 2e76 616c 6964 5f77 6f72 6b65 7273  lf.valid_workers
-000133f0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
-00013400: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
-00013410: 204e 6f6e 6520 616e 6420 6c65 6e28 7365   None and len(se
-00013420: 6c66 2e72 756e 6e69 6e67 2920 3c20 6c65  lf.running) < le
-00013430: 6e28 7365 6c66 2e77 6f72 6b65 7273 293a  n(self.workers):
-00013440: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00013450: 6e6f 7420 7365 6c66 2e72 756e 6e69 6e67  not self.running
-00013460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00013470: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00013480: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-00013490: 7468 6572 6520 7765 7265 206e 6f20 7265  there were no re
-000134a0: 7374 7269 6374 696f 6e73 2c20 6076 616c  strictions, `val
-000134b0: 6964 5f77 6f72 6b65 7273 2829 6020 6469  id_workers()` di
-000134c0: 646e 2774 2073 7562 7365 7420 6279 0a20  dn't subset by. 
-000134d0: 2020 2020 2020 2020 2020 2023 2060 7275             # `ru
-000134e0: 6e6e 696e 6760 2e0a 2020 2020 2020 2020  nning`..        
-000134f0: 2020 2020 7661 6c69 645f 776f 726b 6572      valid_worker
-00013500: 7320 3d20 7365 6c66 2e72 756e 6e69 6e67  s = self.running
-00013510: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
-00013520: 6465 7065 6e64 656e 6369 6573 206f 7220  dependencies or 
-00013530: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
-00013540: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00013550: 2020 2020 2020 2077 7320 3d20 6465 6369         ws = deci
-00013560: 6465 5f77 6f72 6b65 7228 0a20 2020 2020  de_worker(.     
-00013570: 2020 2020 2020 2020 2020 2074 732c 0a20             ts,. 
-00013580: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00013590: 656c 662e 7275 6e6e 696e 672c 0a20 2020  elf.running,.   
-000135a0: 2020 2020 2020 2020 2020 2020 2076 616c               val
-000135b0: 6964 5f77 6f72 6b65 7273 2c0a 2020 2020  id_workers,.    
-000135c0: 2020 2020 2020 2020 2020 2020 7061 7274              part
-000135d0: 6961 6c28 7365 6c66 2e77 6f72 6b65 725f  ial(self.worker_
-000135e0: 6f62 6a65 6374 6976 652c 2074 7329 2c0a  objective, ts),.
-000135f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00013600: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00013610: 2020 2020 2020 2020 2320 544f 444f 2069          # TODO i
-00013620: 6620 6069 735f 726f 6f74 6973 6860 2077  f `is_rootish` w
-00013630: 6f75 6c64 2061 6c77 6179 7320 7265 7475  ould always retu
-00013640: 726e 2054 7275 6520 666f 7220 7461 736b  rn True for task
-00013650: 7320 7769 7468 6f75 740a 2020 2020 2020  s without.      
-00013660: 2020 2020 2020 2320 6465 7065 6e64 656e        # dependen
-00013670: 6369 6573 2c20 7765 2063 6f75 6c64 2072  cies, we could r
-00013680: 656d 6f76 6520 616c 6c20 7468 6973 206c  emove all this l
-00013690: 6f67 6963 2e20 5468 6520 726f 6f74 6973  ogic. The rootis
-000136a0: 6820 6173 7369 676e 6d65 6e74 206c 6f67  h assignment log
-000136b0: 6963 0a20 2020 2020 2020 2020 2020 2023  ic.            #
-000136c0: 2077 6f75 6c64 2062 6568 6176 6520 6d6f   would behave mo
-000136d0: 7265 206f 7220 6c65 7373 2074 6865 2073  re or less the s
-000136e0: 616d 6520 6173 2074 6869 732c 206d 6179  ame as this, may
-000136f0: 6265 2077 6974 686f 7574 2067 7561 7261  be without guara
-00013700: 6e74 6565 640a 2020 2020 2020 2020 2020  nteed.          
-00013710: 2020 2320 726f 756e 642d 726f 6269 6e20    # round-robin 
-00013720: 7468 6f75 6768 3f20 5468 6973 2070 6174  though? This pat
-00013730: 6820 6973 206f 6e6c 7920 7265 6163 6861  h is only reacha
-00013740: 626c 6520 7768 656e 2060 7473 6020 646f  ble when `ts` do
-00013750: 6573 6e27 7420 6861 7665 0a20 2020 2020  esn't have.     
-00013760: 2020 2020 2020 2023 2064 6570 656e 6465         # depende
-00013770: 6e63 6965 732c 2062 7574 2069 7473 2067  ncies, but its g
-00013780: 726f 7570 2069 7320 616c 736f 2073 6d61  roup is also sma
-00013790: 6c6c 6572 2074 6861 6e20 7468 6520 636c  ller than the cl
-000137a0: 7573 7465 722e 0a0a 2020 2020 2020 2020  uster...        
-000137b0: 2020 2020 2320 4661 7374 7061 7468 2077      # Fastpath w
-000137c0: 6865 6e20 7468 6572 6520 6172 6520 6e6f  hen there are no
-000137d0: 2072 656c 6174 6564 2074 6173 6b73 206f   related tasks o
-000137e0: 7220 7265 7374 7269 6374 696f 6e73 0a20  r restrictions. 
-000137f0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-00013800: 725f 706f 6f6c 203d 2073 656c 662e 6964  r_pool = self.id
-00013810: 6c65 206f 7220 7365 6c66 2e77 6f72 6b65  le or self.worke
-00013820: 7273 0a20 2020 2020 2020 2020 2020 2023  rs.            #
-00013830: 2046 4958 4d45 2069 646c 6520 616e 6420   FIXME idle and 
-00013840: 776f 726b 6572 7320 6172 6520 536f 7274  workers are Sort
-00013850: 6564 4469 6374 2773 2064 6563 6c61 7265  edDict's declare
-00013860: 6420 6173 2064 6963 7473 0a20 2020 2020  d as dicts.     
-00013870: 2020 2020 2020 2023 2020 2020 2020 2062         #       b
-00013880: 6563 6175 7365 2073 6f72 7465 6463 6f6e  ecause sortedcon
-00013890: 7461 696e 6572 7320 6973 206e 6f74 2061  tainers is not a
-000138a0: 6e6e 6f74 6174 6564 0a20 2020 2020 2020  nnotated.       
-000138b0: 2020 2020 2077 705f 7661 6c73 203d 2063       wp_vals = c
-000138c0: 6173 7428 2253 6571 7565 6e63 655b 576f  ast("Sequence[Wo
-000138d0: 726b 6572 5374 6174 655d 222c 2077 6f72  rkerState]", wor
-000138e0: 6b65 725f 706f 6f6c 2e76 616c 7565 7328  ker_pool.values(
-000138f0: 2929 0a20 2020 2020 2020 2020 2020 206e  )).            n
-00013900: 5f77 6f72 6b65 7273 203d 206c 656e 2877  _workers = len(w
-00013910: 705f 7661 6c73 290a 2020 2020 2020 2020  p_vals).        
-00013920: 2020 2020 6966 206e 5f77 6f72 6b65 7273      if n_workers
-00013930: 203c 2032 303a 2020 2320 736d 6172 7420   < 20:  # smart 
-00013940: 6275 7420 6c69 6e65 6172 2069 6e20 736d  but linear in sm
-00013950: 616c 6c20 6361 7365 0a20 2020 2020 2020  all case.       
-00013960: 2020 2020 2020 2020 2077 7320 3d20 6d69           ws = mi
-00013970: 6e28 7770 5f76 616c 732c 206b 6579 3d6f  n(wp_vals, key=o
-00013980: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
-00013990: 6572 2822 6f63 6375 7061 6e63 7922 2929  er("occupancy"))
-000139a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000139b0: 2061 7373 6572 7420 7773 0a20 2020 2020   assert ws.     
-000139c0: 2020 2020 2020 2020 2020 2069 6620 7773             if ws
-000139d0: 2e6f 6363 7570 616e 6379 203d 3d20 303a  .occupancy == 0:
-000139e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000139f0: 2020 2020 2023 2073 7065 6369 616c 2063       # special c
-00013a00: 6173 6520 746f 2075 7365 2072 6f75 6e64  ase to use round
-00013a10: 2d72 6f62 696e 3b20 6c69 6e65 6172 2073  -robin; linear s
-00013a20: 6561 7263 680a 2020 2020 2020 2020 2020  earch.          
-00013a30: 2020 2020 2020 2020 2020 2320 666f 7220            # for 
-00013a40: 6e65 7874 2077 6f72 6b65 7220 7769 7468  next worker with
-00013a50: 207a 6572 6f20 6f63 6375 7061 6e63 7920   zero occupancy 
-00013a60: 286f 7220 6a75 7374 0a20 2020 2020 2020  (or just.       
-00013a70: 2020 2020 2020 2020 2020 2020 2023 206c               # l
-00013a80: 616e 6420 6261 636b 2077 6865 7265 2077  and back where w
-00013a90: 6520 7374 6172 7465 6429 2e0a 2020 2020  e started)..    
-00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013ab0: 7374 6172 7420 3d20 7365 6c66 2e6e 5f74  start = self.n_t
-00013ac0: 6173 6b73 2025 206e 5f77 6f72 6b65 7273  asks % n_workers
-00013ad0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013ae0: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
-00013af0: 6e67 6528 6e5f 776f 726b 6572 7329 3a0a  nge(n_workers):.
-00013b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b10: 2020 2020 2020 2020 7770 5f69 203d 2077          wp_i = w
-00013b20: 705f 7661 6c73 5b28 6920 2b20 7374 6172  p_vals[(i + star
-00013b30: 7429 2025 206e 5f77 6f72 6b65 7273 5d0a  t) % n_workers].
-00013b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b50: 2020 2020 2020 2020 6966 2077 705f 692e          if wp_i.
-00013b60: 6f63 6375 7061 6e63 7920 3d3d 2030 3a0a  occupancy == 0:.
-00013b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013b80: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-00013b90: 2077 705f 690a 2020 2020 2020 2020 2020   wp_i.          
-00013ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013bb0: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00013bc0: 2020 2020 656c 7365 3a20 2023 2064 756d      else:  # dum
-00013bd0: 6220 6275 7420 6661 7374 2069 6e20 6c61  b but fast in la
-00013be0: 7267 6520 6361 7365 0a20 2020 2020 2020  rge case.       
-00013bf0: 2020 2020 2020 2020 2077 7320 3d20 7770           ws = wp
-00013c00: 5f76 616c 735b 7365 6c66 2e6e 5f74 6173  _vals[self.n_tas
-00013c10: 6b73 2025 206e 5f77 6f72 6b65 7273 5d0a  ks % n_workers].
-00013c20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00013c30: 2e76 616c 6964 6174 6520 616e 6420 7773  .validate and ws
-00013c40: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00013c50: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00013c60: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00013c70: 7428 7773 2e61 6464 7265 7373 2920 6973  t(ws.address) is
-00013c80: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
-00013c90: 6173 7365 7274 2077 7320 696e 2073 656c  assert ws in sel
-00013ca0: 662e 7275 6e6e 696e 672c 2028 7773 2c20  f.running, (ws, 
-00013cb0: 7365 6c66 2e72 756e 6e69 6e67 290a 0a20  self.running).. 
-00013cc0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
-00013cd0: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00013ce0: 7469 6f6e 5f77 6169 7469 6e67 5f70 726f  tion_waiting_pro
-00013cf0: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
-00013d00: 793a 2073 7472 2c20 7374 696d 756c 7573  y: str, stimulus
-00013d10: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
-00013d20: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
-00013d30: 2222 506f 7373 6962 6c79 2073 6368 6564  ""Possibly sched
-00013d40: 756c 6520 6120 7265 6164 7920 7461 736b  ule a ready task
-00013d50: 2e20 5468 6973 2069 7320 7468 6520 7072  . This is the pr
-00013d60: 696d 6172 7920 6469 7370 6174 6368 2066  imary dispatch f
-00013d70: 6f72 2072 6561 6479 2074 6173 6b73 2e0a  or ready tasks..
-00013d80: 0a20 2020 2020 2020 2049 6620 7468 6572  .        If ther
-00013d90: 6527 7320 6e6f 2061 7070 726f 7072 6961  e's no appropria
-00013da0: 7465 2077 6f72 6b65 7220 666f 7220 7468  te worker for th
-00013db0: 6520 7461 736b 2028 6275 7420 7468 6520  e task (but the 
-00013dc0: 7461 736b 2069 7320 6f74 6865 7277 6973  task is otherwis
-00013dd0: 650a 2020 2020 2020 2020 7275 6e6e 6162  e.        runnab
-00013de0: 6c65 292c 2069 7420 7769 6c6c 2062 6520  le), it will be 
-00013df0: 7265 636f 6d6d 656e 6465 6420 746f 2060  recommended to `
-00013e00: 606e 6f2d 776f 726b 6572 6060 206f 7220  `no-worker`` or 
-00013e10: 6060 7175 6575 6564 6060 2e0a 2020 2020  ``queued``..    
-00013e20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00013e30: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00013e40: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
-00013e50: 2073 656c 662e 6973 5f72 6f6f 7469 7368   self.is_rootish
-00013e60: 2874 7329 3a0a 2020 2020 2020 2020 2020  (ts):.          
-00013e70: 2020 2320 4e4f 5445 3a20 6861 7669 6e67    # NOTE: having
-00013e80: 2074 776f 2072 6f6f 742d 6973 6820 6d65   two root-ish me
-00013e90: 7468 6f64 7320 6973 2074 656d 706f 7261  thods is tempora
-00013ea0: 7279 2e20 5768 656e 2074 6865 2066 6561  ry. When the fea
-00013eb0: 7475 7265 2066 6c61 6720 6973 0a20 2020  ture flag is.   
-00013ec0: 2020 2020 2020 2020 2023 2072 656d 6f76           # remov
-00013ed0: 6564 2c20 7468 6572 6520 7368 6f75 6c64  ed, there should
-00013ee0: 206f 6e6c 7920 6265 206f 6e65 2c20 7768   only be one, wh
-00013ef0: 6963 6820 636f 6d62 696e 6573 2063 6f2d  ich combines co-
-00013f00: 6173 7369 676e 6d65 6e74 2061 6e64 0a20  assignment and. 
-00013f10: 2020 2020 2020 2020 2020 2023 2071 7565             # que
-00013f20: 7569 6e67 2e20 4576 656e 7475 616c 6c79  uing. Eventually
-00013f30: 2c20 7370 6563 6961 6c2d 6361 7369 6e67  , special-casing
-00013f40: 2072 6f6f 7420 7461 736b 7320 6d69 6768   root tasks migh
-00013f50: 7420 6265 2072 656d 6f76 6564 2065 6e74  t be removed ent
-00013f60: 6972 656c 792c 0a20 2020 2020 2020 2020  irely,.         
-00013f70: 2020 2023 2077 6974 6820 6265 7474 6572     # with better
-00013f80: 2068 6575 7269 7374 6963 732e 0a20 2020   heuristics..   
-00013f90: 2020 2020 2020 2020 2069 6620 6d61 7468           if math
-00013fa0: 2e69 7369 6e66 2873 656c 662e 574f 524b  .isinf(self.WORK
-00013fb0: 4552 5f53 4154 5552 4154 494f 4e29 3a0a  ER_SATURATION):.
-00013fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013fd0: 6966 206e 6f74 2028 7773 203a 3d20 7365  if not (ws := se
-00013fe0: 6c66 2e64 6563 6964 655f 776f 726b 6572  lf.decide_worker
-00013ff0: 5f72 6f6f 7469 7368 5f71 7565 7569 6e67  _rootish_queuing
-00014000: 5f64 6973 6162 6c65 6428 7473 2929 3a0a  _disabled(ts)):.
-00014010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014020: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
-00014030: 6579 3a20 226e 6f2d 776f 726b 6572 227d  ey: "no-worker"}
-00014040: 2c20 7b7d 2c20 7b7d 0a20 2020 2020 2020  , {}, {}.       
-00014050: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00014060: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014070: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
-00014080: 6369 6465 5f77 6f72 6b65 725f 726f 6f74  cide_worker_root
-00014090: 6973 685f 7175 6575 696e 675f 656e 6162  ish_queuing_enab
-000140a0: 6c65 6428 2929 3a0a 2020 2020 2020 2020  led()):.        
-000140b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000140c0: 726e 207b 7473 2e6b 6579 3a20 2271 7565  rn {ts.key: "que
-000140d0: 7565 6422 7d2c 207b 7d2c 207b 7d0a 2020  ued"}, {}, {}.  
-000140e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000140f0: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
-00014100: 7773 203a 3d20 7365 6c66 2e64 6563 6964  ws := self.decid
-00014110: 655f 776f 726b 6572 5f6e 6f6e 5f72 6f6f  e_worker_non_roo
-00014120: 7469 7368 2874 7329 293a 0a20 2020 2020  tish(ts)):.     
-00014130: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00014140: 6e20 7b74 732e 6b65 793a 2022 6e6f 2d77  n {ts.key: "no-w
-00014150: 6f72 6b65 7222 7d2c 207b 7d2c 207b 7d0a  orker"}, {}, {}.
-00014160: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00014170: 6d73 6773 203d 2073 656c 662e 5f61 6464  msgs = self._add
-00014180: 5f74 6f5f 7072 6f63 6573 7369 6e67 2874  _to_processing(t
-00014190: 732c 2077 7329 0a20 2020 2020 2020 2072  s, ws).        r
-000141a0: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 776f  eturn {}, {}, wo
-000141b0: 726b 6572 5f6d 7367 730a 0a20 2020 2064  rker_msgs..    d
-000141c0: 6566 2074 7261 6e73 6974 696f 6e5f 7761  ef transition_wa
-000141d0: 6974 696e 675f 6d65 6d6f 7279 280a 2020  iting_memory(.  
-000141e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000141f0: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
-00014200: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00014210: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
-00014220: 2a2c 0a20 2020 2020 2020 206e 6279 7465  *,.        nbyte
-00014230: 733a 2069 6e74 207c 204e 6f6e 6520 3d20  s: int | None = 
-00014240: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
-00014250: 7065 3a20 6279 7465 7320 7c20 4e6f 6e65  pe: bytes | None
-00014260: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00014270: 2074 7970 656e 616d 653a 2073 7472 207c   typename: str |
-00014280: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00014290: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
-000142a0: 722c 0a20 2020 2020 2020 202a 2a6b 7761  r,.        **kwa
-000142b0: 7267 733a 2041 6e79 2c0a 2020 2020 2920  rgs: Any,.    ) 
-000142c0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-000142d0: 2020 2020 2022 2222 5468 6973 2074 7261       """This tra
-000142e0: 6e73 6974 696f 6e20 6578 636c 7573 6976  nsition exclusiv
-000142f0: 656c 7920 6861 7070 656e 7320 696e 2061  ely happens in a
-00014300: 2072 6163 6520 636f 6e64 6974 696f 6e20   race condition 
-00014310: 7768 6572 6520 7468 6520 7363 6865 6475  where the schedu
-00014320: 6c65 720a 2020 2020 2020 2020 6265 6c69  ler.        beli
-00014330: 6576 6573 2074 6861 7420 7468 6520 6f6e  eves that the on
-00014340: 6c79 2063 6f70 7920 6f66 2061 2064 6570  ly copy of a dep
-00014350: 656e 6465 6e63 7920 7461 736b 2068 6173  endency task has
-00014360: 206a 7573 7420 6265 656e 206c 6f73 742c   just been lost,
-00014370: 2073 6f20 6974 0a20 2020 2020 2020 2074   so it.        t
-00014380: 7261 6e73 6974 696f 6e73 2061 6c6c 2064  ransitions all d
-00014390: 6570 656e 6465 6e74 7320 6261 636b 2074  ependents back t
-000143a0: 6f20 7761 6974 696e 672c 2062 7574 2061  o waiting, but a
-000143b0: 6374 7561 6c6c 7920 6120 7265 706c 6963  ctually a replic
-000143c0: 6120 6861 7320 616c 7265 6164 790a 2020  a has already.  
-000143d0: 2020 2020 2020 6265 656e 2061 6371 7569        been acqui
-000143e0: 7265 6420 6279 2061 2077 6f72 6b65 7220  red by a worker 
-000143f0: 636f 6d70 7574 696e 6720 7468 6520 6465  computing the de
-00014400: 7065 6e64 656e 6379 202d 2074 6865 2073  pendency - the s
-00014410: 6368 6564 756c 6572 206a 7573 7420 646f  cheduler just do
-00014420: 6573 6e27 740a 2020 2020 2020 2020 6b6e  esn't.        kn
-00014430: 6f77 2079 6574 202d 2061 6e64 2074 6865  ow yet - and the
-00014440: 2065 7865 6375 7469 6f6e 2066 696e 6973   execution finis
-00014450: 6865 7320 6265 666f 7265 2074 6865 2063  hes before the c
-00014460: 616e 6365 6c6c 6174 696f 6e20 6d65 7373  ancellation mess
-00014470: 6167 6520 6672 6f6d 2074 6865 0a20 2020  age from the.   
-00014480: 2020 2020 2073 6368 6564 756c 6572 2068       scheduler h
-00014490: 6173 2061 2063 6861 6e63 6520 746f 2072  as a chance to r
-000144a0: 6561 6368 2074 6865 2077 6f72 6b65 722e  each the worker.
-000144b0: 2053 686f 7274 6c79 2c20 7468 6520 6361   Shortly, the ca
-000144c0: 6e63 656c 6c61 7469 6f6e 2072 6571 7565  ncellation reque
-000144d0: 7374 0a20 2020 2020 2020 2077 696c 6c20  st.        will 
-000144e0: 7265 6163 6820 7468 6520 776f 726b 6572  reach the worker
-000144f0: 2c20 7468 7573 2064 656c 6574 696e 6720  , thus deleting 
-00014500: 7468 6520 6461 7461 2066 726f 6d20 6d65  the data from me
-00014510: 6d6f 7279 2e0a 2020 2020 2020 2020 2222  mory..        ""
-00014520: 220a 2020 2020 2020 2020 7473 203d 2073  ".        ts = s
-00014530: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
-00014540: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00014550: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00014560: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00014570: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00014580: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00014590: 7365 7274 2074 732e 7761 6974 696e 675f  sert ts.waiting_
-000145a0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-000145b0: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
-000145c0: 3d20 2277 6169 7469 6e67 220a 0a20 2020  = "waiting"..   
-000145d0: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
-000145e0: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
-000145f0: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
-00014600: 7373 696e 675f 6d65 6d6f 7279 280a 2020  ssing_memory(.  
-00014610: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00014620: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
-00014630: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-00014640: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
-00014650: 2a2c 0a20 2020 2020 2020 206e 6279 7465  *,.        nbyte
-00014660: 733a 2069 6e74 207c 204e 6f6e 6520 3d20  s: int | None = 
-00014670: 4e6f 6e65 2c0a 2020 2020 2020 2020 7479  None,.        ty
-00014680: 7065 3a20 6279 7465 7320 7c20 4e6f 6e65  pe: bytes | None
-00014690: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000146a0: 2074 7970 656e 616d 653a 2073 7472 207c   typename: str |
-000146b0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000146c0: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
-000146d0: 722c 0a20 2020 2020 2020 2073 7461 7274  r,.        start
-000146e0: 7374 6f70 733a 206c 6973 745b 6469 6374  stops: list[dict
-000146f0: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
-00014700: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00014710: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-00014720: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00014730: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00014740: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
-00014750: 2061 7373 6572 7420 776f 726b 6572 0a20   assert worker. 
-00014760: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00014770: 696e 7374 616e 6365 2877 6f72 6b65 722c  instance(worker,
-00014780: 2073 7472 290a 0a20 2020 2020 2020 2069   str)..        i
-00014790: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000147a0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000147b0: 6572 7420 7473 2e70 726f 6365 7373 696e  ert ts.processin
-000147c0: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-000147d0: 2077 7373 203d 2074 732e 7072 6f63 6573   wss = ts.proces
-000147e0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-000147f0: 2020 2020 6173 7365 7274 2077 7373 0a20      assert wss. 
-00014800: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014810: 7420 7473 2069 6e20 7773 732e 7072 6f63  t ts in wss.proc
-00014820: 6573 7369 6e67 0a20 2020 2020 2020 2020  essing.         
-00014830: 2020 2064 656c 2077 7373 0a20 2020 2020     del wss.     
-00014840: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00014850: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00014860: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014870: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
-00014880: 732c 2028 7473 2c20 7473 2e77 686f 5f68  s, (ts, ts.who_h
-00014890: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
-000148a0: 6173 7365 7274 206e 6f74 2074 732e 6578  assert not ts.ex
-000148b0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-000148c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000148d0: 2074 732e 7374 6174 6520 3d3d 2022 7072   ts.state == "pr
-000148e0: 6f63 6573 7369 6e67 220a 0a20 2020 2020  ocessing"..     
-000148f0: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-00014900: 6b65 7273 2e67 6574 2877 6f72 6b65 7229  kers.get(worker)
-00014910: 0a20 2020 2020 2020 2069 6620 7773 2069  .        if ws i
-00014920: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-00014930: 2020 2020 7265 7475 726e 207b 6b65 793a      return {key:
-00014940: 2022 7265 6c65 6173 6564 227d 2c20 7b7d   "released"}, {}
-00014950: 2c20 7b7d 0a0a 2020 2020 2020 2020 6966  , {}..        if
-00014960: 2077 7320 213d 2074 732e 7072 6f63 6573   ws != ts.proces
-00014970: 7369 6e67 5f6f 6e3a 2020 2320 7072 6167  sing_on:  # prag
-00014980: 6d61 3a20 6e6f 636f 7665 720a 2020 2020  ma: nocover.    
-00014990: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000149a0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-000149b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-000149c0: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
-000149d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149e0: 6622 5461 736b 207b 7473 2e6b 6579 2172  f"Task {ts.key!r
-000149f0: 7d20 7472 616e 7369 7469 6f6e 6564 2066  } transitioned f
-00014a00: 726f 6d20 7072 6f63 6573 7369 6e67 2074  rom processing t
-00014a10: 6f20 6d65 6d6f 7279 206f 6e20 776f 726b  o memory on work
-00014a20: 6572 2022 0a20 2020 2020 2020 2020 2020  er ".           
-00014a30: 2020 2020 2066 227b 7773 7d2c 2077 6869       f"{ws}, whi
-00014a40: 6c65 2069 7420 7761 7320 6578 7065 6374  le it was expect
-00014a50: 6564 2066 726f 6d20 7b74 732e 7072 6f63  ed from {ts.proc
-00014a60: 6573 7369 6e67 5f6f 6e7d 2e20 5468 6973  essing_on}. This
-00014a70: 2073 686f 756c 6420 220a 2020 2020 2020   should ".      
-00014a80: 2020 2020 2020 2020 2020 6622 6265 2069            f"be i
-00014a90: 6d70 6f73 7369 626c 652e 207b 7374 696d  mpossible. {stim
-00014aa0: 756c 7573 5f69 643d 7d2c 2073 746f 7279  ulus_id=}, story
-00014ab0: 3d7b 7365 6c66 2e73 746f 7279 2874 7329  ={self.story(ts)
-00014ac0: 7d22 0a20 2020 2020 2020 2020 2020 2029  }".            )
-00014ad0: 0a0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
-00014ae0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014af0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-00014b00: 2320 5570 6461 7465 2054 696d 696e 6720  # Update Timing 
-00014b10: 496e 666f 726d 6174 696f 6e20 230a 2020  Information #.  
-00014b20: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+00011d30: 7420 6e6f 7420 7473 2e61 6374 6f72 2c20  t not ts.actor, 
+00011d40: 6622 4163 746f 7273 2063 616e 2774 2062  f"Actors can't b
+00011d50: 6520 696e 2060 6e6f 2d77 6f72 6b65 7260  e in `no-worker`
+00011d60: 3a20 7b74 737d 220a 2020 2020 2020 2020  : {ts}".        
+00011d70: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+00011d80: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00011d90: 0a0a 2020 2020 2020 2020 6966 2077 7320  ..        if ws 
+00011da0: 3a3d 2073 656c 662e 6465 6369 6465 5f77  := self.decide_w
+00011db0: 6f72 6b65 725f 6e6f 6e5f 726f 6f74 6973  orker_non_rootis
+00011dc0: 6828 7473 293a 0a20 2020 2020 2020 2020  h(ts):.         
+00011dd0: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
+00011de0: 6c65 2e64 6973 6361 7264 2874 7329 0a20  le.discard(ts). 
+00011df0: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00011e00: 725f 6d73 6773 203d 2073 656c 662e 5f61  r_msgs = self._a
+00011e10: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
+00011e20: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
+00011e30: 2023 2049 6620 6e6f 2077 6f72 6b65 722c   # If no worker,
+00011e40: 2074 6173 6b20 6a75 7374 2073 7461 7973   task just stays
+00011e50: 2069 6e20 606e 6f2d 776f 726b 6572 600a   in `no-worker`.
+00011e60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00011e70: 7b7d 2c20 7b7d 2c20 776f 726b 6572 5f6d  {}, {}, worker_m
+00011e80: 7367 730a 0a20 2020 2064 6566 2064 6563  sgs..    def dec
+00011e90: 6964 655f 776f 726b 6572 5f72 6f6f 7469  ide_worker_rooti
+00011ea0: 7368 5f71 7565 7569 6e67 5f64 6973 6162  sh_queuing_disab
+00011eb0: 6c65 6428 0a20 2020 2020 2020 2073 656c  led(.        sel
+00011ec0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+00011ed0: 0a20 2020 2029 202d 3e20 576f 726b 6572  .    ) -> Worker
+00011ee0: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
+00011ef0: 2020 2020 2020 2222 2250 6963 6b20 6120        """Pick a 
+00011f00: 776f 726b 6572 2066 6f72 2061 2072 756e  worker for a run
+00011f10: 6e61 626c 6520 726f 6f74 2d69 7368 2074  nable root-ish t
+00011f20: 6173 6b2c 2077 6974 686f 7574 2071 7565  ask, without que
+00011f30: 7569 6e67 2e0a 0a20 2020 2020 2020 2054  uing...        T
+00011f40: 6869 7320 6174 7465 6d70 7473 2074 6f20  his attempts to 
+00011f50: 7363 6865 6475 6c65 2073 6962 6c69 6e67  schedule sibling
+00011f60: 2074 6173 6b73 206f 6e20 7468 6520 7361   tasks on the sa
+00011f70: 6d65 2077 6f72 6b65 722c 2072 6564 7563  me worker, reduc
+00011f80: 696e 6720 6675 7475 7265 2064 6174 610a  ing future data.
+00011f90: 2020 2020 2020 2020 7472 616e 7366 6572          transfer
+00011fa0: 2e20 4974 2064 6f65 7320 6e6f 7420 636f  . It does not co
+00011fb0: 6e73 6964 6572 2074 6865 206c 6f63 6174  nsider the locat
+00011fc0: 696f 6e20 6f66 2064 6570 656e 6465 6e63  ion of dependenc
+00011fd0: 6965 732c 2073 696e 6365 2074 6865 7927  ies, since they'
+00011fe0: 6c6c 2065 6e64 0a20 2020 2020 2020 2075  ll end.        u
+00011ff0: 7020 6f6e 2065 7665 7279 2077 6f72 6b65  p on every worke
+00012000: 7220 616e 7977 6179 2e0a 0a20 2020 2020  r anyway...     
+00012010: 2020 2049 7420 6173 7375 6d65 7320 6974     It assumes it
+00012020: 2773 2062 6569 6e67 2063 616c 6c65 6420  's being called 
+00012030: 6f6e 2061 2062 6174 6368 206f 6620 7461  on a batch of ta
+00012040: 736b 7320 696e 2070 7269 6f72 6974 7920  sks in priority 
+00012050: 6f72 6465 722c 2061 6e64 0a20 2020 2020  order, and.     
+00012060: 2020 206d 6169 6e74 6169 6e73 2073 7461     maintains sta
+00012070: 7465 2069 6e20 6053 6368 6564 756c 6572  te in `Scheduler
+00012080: 5374 6174 652e 6c61 7374 5f72 6f6f 745f  State.last_root_
+00012090: 776f 726b 6572 6020 616e 640a 2020 2020  worker` and.    
+000120a0: 2020 2020 6053 6368 6564 756c 6572 5374      `SchedulerSt
+000120b0: 6174 652e 6c61 7374 5f72 6f6f 745f 776f  ate.last_root_wo
+000120c0: 726b 6572 5f74 6173 6b73 5f6c 6566 7460  rker_tasks_left`
+000120d0: 2074 6f20 6163 6869 6576 6520 7468 6973   to achieve this
+000120e0: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
+000120f0: 7769 6c6c 2073 656e 6420 6576 6572 7920  will send every 
+00012100: 7275 6e6e 6162 6c65 2074 6173 6b20 746f  runnable task to
+00012110: 2061 2077 6f72 6b65 722c 206f 6674 656e   a worker, often
+00012120: 2063 6175 7369 6e67 2072 6f6f 7420 7461   causing root ta
+00012130: 736b 0a20 2020 2020 2020 206f 7665 7270  sk.        overp
+00012140: 726f 6475 6374 696f 6e2e 0a0a 2020 2020  roduction...    
+00012150: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+00012160: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+00012170: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
+00012180: 6174 6520 7c20 4e6f 6e65 0a20 2020 2020  ate | None.     
+00012190: 2020 2020 2020 2054 6865 2077 6f72 6b65         The worke
+000121a0: 7220 746f 2061 7373 6967 6e20 7468 6520  r to assign the 
+000121b0: 7461 736b 2074 6f2e 2049 6620 7468 6572  task to. If ther
+000121c0: 6520 6172 6520 6e6f 2077 6f72 6b65 7273  e are no workers
+000121d0: 2069 6e20 7468 6520 636c 7573 7465 722c   in the cluster,
+000121e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000121f0: 7572 6e73 204e 6f6e 652c 2069 6e20 7768  urns None, in wh
+00012200: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
+00012210: 6b20 7368 6f75 6c64 2062 6520 7472 616e  k should be tran
+00012220: 7369 7469 6f6e 6564 2074 6f0a 2020 2020  sitioned to.    
+00012230: 2020 2020 2020 2020 6060 6e6f 2d77 6f72          ``no-wor
+00012240: 6b65 7260 602e 0a20 2020 2020 2020 2022  ker``..        "
+00012250: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
+00012260: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00012270: 2020 2020 2020 2020 2023 2053 6565 2072           # See r
+00012280: 6f6f 742d 6973 682d 6e65 7373 206e 6f74  oot-ish-ness not
+00012290: 6520 6265 6c6f 7720 696e 2060 6465 6369  e below in `deci
+000122a0: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+000122b0: 685f 7175 6575 696e 675f 656e 6162 6c65  h_queuing_enable
+000122c0: 6460 0a20 2020 2020 2020 2020 2020 2061  d`.            a
+000122d0: 7373 6572 7420 6d61 7468 2e69 7369 6e66  ssert math.isinf
+000122e0: 2873 656c 662e 574f 524b 4552 5f53 4154  (self.WORKER_SAT
+000122f0: 5552 4154 494f 4e29 0a0a 2020 2020 2020  URATION)..      
+00012300: 2020 706f 6f6c 203d 2073 656c 662e 6964    pool = self.id
+00012310: 6c65 2e76 616c 7565 7328 2920 6966 2073  le.values() if s
+00012320: 656c 662e 6964 6c65 2065 6c73 6520 7365  elf.idle else se
+00012330: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+00012340: 2020 2069 6620 6e6f 7420 706f 6f6c 3a0a     if not pool:.
+00012350: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00012360: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
+00012370: 2074 6720 3d20 7473 2e67 726f 7570 0a20   tg = ts.group. 
+00012380: 2020 2020 2020 206c 7773 203d 2074 672e         lws = tg.
+00012390: 6c61 7374 5f77 6f72 6b65 720a 2020 2020  last_worker.    
+000123a0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+000123b0: 2020 2020 206c 7773 0a20 2020 2020 2020       lws.       
+000123c0: 2020 2020 2061 6e64 2074 672e 6c61 7374       and tg.last
+000123d0: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+000123e0: 6674 0a20 2020 2020 2020 2020 2020 2061  ft.            a
+000123f0: 6e64 206c 7773 2e73 7461 7475 7320 3d3d  nd lws.status ==
+00012400: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
+00012410: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+00012420: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
+00012430: 286c 7773 2e61 6464 7265 7373 2920 6973  (lws.address) is
+00012440: 206c 7773 0a20 2020 2020 2020 2029 3a0a   lws.        ):.
+00012450: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+00012460: 206c 7773 0a20 2020 2020 2020 2065 6c73   lws.        els
+00012470: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00012480: 204c 6173 742d 7573 6564 2077 6f72 6b65   Last-used worke
+00012490: 7220 6973 2066 756c 6c2c 2075 6e6b 6e6f  r is full, unkno
+000124a0: 776e 2c20 7265 7469 7269 6e67 2c20 6f72  wn, retiring, or
+000124b0: 2070 6175 7365 643b 0a20 2020 2020 2020   paused;.       
+000124c0: 2020 2020 2023 2070 6963 6b20 6120 6e65       # pick a ne
+000124d0: 7720 776f 726b 6572 2066 6f72 2074 6865  w worker for the
+000124e0: 206e 6578 7420 6665 7720 7461 736b 730a   next few tasks.
+000124f0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+00012500: 206d 696e 2870 6f6f 6c2c 206b 6579 3d70   min(pool, key=p
+00012510: 6172 7469 616c 2873 656c 662e 776f 726b  artial(self.work
+00012520: 6572 5f6f 626a 6563 7469 7665 2c20 7473  er_objective, ts
+00012530: 2929 0a20 2020 2020 2020 2020 2020 2074  )).            t
+00012540: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
+00012550: 736b 735f 6c65 6674 203d 206d 6174 682e  sks_left = math.
+00012560: 666c 6f6f 7228 0a20 2020 2020 2020 2020  floor(.         
+00012570: 2020 2020 2020 2028 6c65 6e28 7467 2920         (len(tg) 
+00012580: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
+00012590: 7265 6164 7329 202a 2077 732e 6e74 6872  reads) * ws.nthr
+000125a0: 6561 6473 0a20 2020 2020 2020 2020 2020  eads.           
+000125b0: 2029 0a0a 2020 2020 2020 2020 2320 5265   )..        # Re
+000125c0: 636f 7264 2060 6c61 7374 5f77 6f72 6b65  cord `last_worke
+000125d0: 7260 2c20 6f72 2063 6c65 6172 2069 7420  r`, or clear it 
+000125e0: 6f6e 2074 6865 2066 696e 616c 2074 6173  on the final tas
+000125f0: 6b0a 2020 2020 2020 2020 7467 2e6c 6173  k.        tg.las
+00012600: 745f 776f 726b 6572 203d 2028 0a20 2020  t_worker = (.   
+00012610: 2020 2020 2020 2020 2077 7320 6966 2074           ws if t
+00012620: 672e 7374 6174 6573 5b22 7265 6c65 6173  g.states["releas
+00012630: 6564 225d 202b 2074 672e 7374 6174 6573  ed"] + tg.states
+00012640: 5b22 7761 6974 696e 6722 5d20 3e20 3120  ["waiting"] > 1 
+00012650: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+00012660: 2020 290a 2020 2020 2020 2020 7467 2e6c    ).        tg.l
+00012670: 6173 745f 776f 726b 6572 5f74 6173 6b73  ast_worker_tasks
+00012680: 5f6c 6566 7420 2d3d 2031 0a0a 2020 2020  _left -= 1..    
+00012690: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+000126a0: 6461 7465 2061 6e64 2077 7320 6973 206e  date and ws is n
+000126b0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+000126c0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+000126d0: 2e77 6f72 6b65 7273 2e67 6574 2877 732e  .workers.get(ws.
+000126e0: 6164 6472 6573 7329 2069 7320 7773 0a20  address) is ws. 
+000126f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00012700: 7420 7773 2069 6e20 7365 6c66 2e72 756e  t ws in self.run
+00012710: 6e69 6e67 2c20 2877 732c 2073 656c 662e  ning, (ws, self.
+00012720: 7275 6e6e 696e 6729 0a0a 2020 2020 2020  running)..      
+00012730: 2020 7265 7475 726e 2077 730a 0a20 2020    return ws..   
+00012740: 2064 6566 2064 6563 6964 655f 776f 726b   def decide_work
+00012750: 6572 5f72 6f6f 7469 7368 5f71 7565 7569  er_rootish_queui
+00012760: 6e67 5f65 6e61 626c 6564 2873 656c 6629  ng_enabled(self)
+00012770: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
+00012780: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00012790: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
+000127a0: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
+000127b0: 726f 6f74 2d69 7368 2074 6173 6b2c 2069  root-ish task, i
+000127c0: 6620 6e6f 7420 616c 6c20 6172 6520 6275  f not all are bu
+000127d0: 7379 2e0a 0a20 2020 2020 2020 2050 6963  sy...        Pic
+000127e0: 6b73 2074 6865 206c 6561 7374 2d62 7573  ks the least-bus
+000127f0: 7920 776f 726b 6572 206f 7574 206f 6620  y worker out of 
+00012800: 7468 6520 6060 6964 6c65 6060 2077 6f72  the ``idle`` wor
+00012810: 6b65 7273 2028 6964 6c65 2077 6f72 6b65  kers (idle worke
+00012820: 7273 2068 6176 6520 6665 7765 720a 2020  rs have fewer.  
+00012830: 2020 2020 2020 7461 736b 7320 7275 6e6e        tasks runn
+00012840: 696e 6720 7468 616e 2074 6872 6561 6473  ing than threads
+00012850: 2c20 6173 2073 6574 2062 7920 6060 6469  , as set by ``di
+00012860: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00012870: 6c65 722e 776f 726b 6572 2d73 6174 7572  ler.worker-satur
+00012880: 6174 696f 6e60 6029 2e0a 2020 2020 2020  ation``)..      
+00012890: 2020 4974 2064 6f65 7320 6e6f 7420 636f    It does not co
+000128a0: 6e73 6964 6572 2074 6865 206c 6f63 6174  nsider the locat
+000128b0: 696f 6e20 6f66 2064 6570 656e 6465 6e63  ion of dependenc
+000128c0: 6965 732c 2073 696e 6365 2074 6865 7927  ies, since they'
+000128d0: 6c6c 2065 6e64 2075 7020 6f6e 2065 7665  ll end up on eve
+000128e0: 7279 0a20 2020 2020 2020 2077 6f72 6b65  ry.        worke
+000128f0: 7220 616e 7977 6179 2e0a 0a20 2020 2020  r anyway...     
+00012900: 2020 2049 6620 616c 6c20 776f 726b 6572     If all worker
+00012910: 7320 6172 6520 6675 6c6c 2c20 7265 7475  s are full, retu
+00012920: 726e 7320 4e6f 6e65 2c20 6d65 616e 696e  rns None, meanin
+00012930: 6720 7468 6520 7461 736b 2073 686f 756c  g the task shoul
+00012940: 6420 7472 616e 7369 7469 6f6e 2074 6f0a  d transition to.
+00012950: 2020 2020 2020 2020 6060 7175 6575 6564          ``queued
+00012960: 6060 2e20 5468 6520 7363 6865 6475 6c65  ``. The schedule
+00012970: 7220 7769 6c6c 2077 6169 7420 746f 2073  r will wait to s
+00012980: 656e 6420 6974 2074 6f20 6120 776f 726b  end it to a work
+00012990: 6572 2075 6e74 696c 2061 2074 6872 6561  er until a threa
+000129a0: 6420 6f70 656e 730a 2020 2020 2020 2020  d opens.        
+000129b0: 7570 2e20 5468 6973 2065 6e73 7572 6573  up. This ensures
+000129c0: 2074 6861 7420 646f 776e 7374 7265 616d   that downstream
+000129d0: 2074 6173 6b73 2061 6c77 6179 7320 7275   tasks always ru
+000129e0: 6e20 6265 666f 7265 206e 6577 2072 6f6f  n before new roo
+000129f0: 7420 7461 736b 7320 6172 650a 2020 2020  t tasks are.    
+00012a00: 2020 2020 7374 6172 7465 642e 0a0a 2020      started...  
+00012a10: 2020 2020 2020 5468 6973 2064 6f65 7320        This does 
+00012a20: 6e6f 7420 7472 7920 746f 2073 6368 6564  not try to sched
+00012a30: 756c 6520 7369 626c 696e 6720 7461 736b  ule sibling task
+00012a40: 7320 6f6e 2074 6865 2073 616d 6520 776f  s on the same wo
+00012a50: 726b 6572 3b20 696e 2066 6163 742c 2069  rker; in fact, i
+00012a60: 740a 2020 2020 2020 2020 7573 7561 6c6c  t.        usuall
+00012a70: 7920 646f 6573 2074 6865 206f 7070 6f73  y does the oppos
+00012a80: 6974 652e 2045 7665 6e20 7468 6f75 6768  ite. Even though
+00012a90: 2074 6869 7320 696e 6372 6561 7365 7320   this increases 
+00012aa0: 7375 6273 6571 7565 6e74 2064 6174 6120  subsequent data 
+00012ab0: 7472 616e 7366 6572 2c0a 2020 2020 2020  transfer,.      
+00012ac0: 2020 6974 2074 7970 6963 616c 6c79 2072    it typically r
+00012ad0: 6564 7563 6573 206f 7665 7261 6c6c 206d  educes overall m
+00012ae0: 656d 6f72 7920 7573 6520 6279 2065 6c69  emory use by eli
+00012af0: 6d69 6e61 7469 6e67 2072 6f6f 7420 7461  minating root ta
+00012b00: 736b 206f 7665 7270 726f 6475 6374 696f  sk overproductio
+00012b10: 6e2e 0a0a 2020 2020 2020 2020 5265 7475  n...        Retu
+00012b20: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
+00012b30: 2d2d 2d0a 2020 2020 2020 2020 7773 3a20  ---.        ws: 
+00012b40: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00012b50: 6e65 0a20 2020 2020 2020 2020 2020 2054  ne.            T
+00012b60: 6865 2077 6f72 6b65 7220 746f 2061 7373  he worker to ass
+00012b70: 6967 6e20 7468 6520 7461 736b 2074 6f2e  ign the task to.
+00012b80: 2049 6620 7468 6572 6520 6172 6520 6e6f   If there are no
+00012b90: 2069 646c 6520 776f 726b 6572 732c 2072   idle workers, r
+00012ba0: 6574 7572 6e73 0a20 2020 2020 2020 2020  eturns.         
+00012bb0: 2020 204e 6f6e 652c 2069 6e20 7768 6963     None, in whic
+00012bc0: 6820 6361 7365 2074 6865 2074 6173 6b20  h case the task 
+00012bd0: 7368 6f75 6c64 2062 6520 7472 616e 7369  should be transi
+00012be0: 7469 6f6e 6564 2074 6f20 6060 7175 6575  tioned to ``queu
+00012bf0: 6564 6060 2e0a 0a20 2020 2020 2020 2022  ed``...        "
+00012c00: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
+00012c10: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00012c20: 2020 2020 2020 2020 2023 2057 6520 646f           # We do
+00012c30: 6e27 7420 6061 7373 6572 7420 7365 6c66  n't `assert self
+00012c40: 2e69 735f 726f 6f74 6973 6828 7473 2960  .is_rootish(ts)`
+00012c50: 2068 6572 652c 2062 6563 6175 7365 2074   here, because t
+00012c60: 6861 7420 6368 6563 6b20 6973 0a20 2020  hat check is.   
+00012c70: 2020 2020 2020 2020 2023 2064 6570 656e           # depen
+00012c80: 6465 6e74 206f 6e20 636c 7573 7465 7220  dent on cluster 
+00012c90: 7369 7a65 2e20 4974 2773 2070 6f73 7369  size. It's possi
+00012ca0: 626c 6520 6120 7461 736b 206c 6f6f 6b65  ble a task looke
+00012cb0: 6420 726f 6f74 2d69 7368 2077 6865 6e20  d root-ish when 
+00012cc0: 6974 0a20 2020 2020 2020 2020 2020 2023  it.            #
+00012cd0: 2077 6173 2071 7565 7565 642c 2062 7574   was queued, but
+00012ce0: 2074 6865 2063 6c75 7374 6572 2068 6173   the cluster has
+00012cf0: 2073 696e 6365 2073 6361 6c65 6420 7570   since scaled up
+00012d00: 2061 6e64 2069 7420 6e6f 206c 6f6e 6765   and it no longe
+00012d10: 7220 646f 6573 2077 6865 6e0a 2020 2020  r does when.    
+00012d20: 2020 2020 2020 2020 2320 636f 6d69 6e67          # coming
+00012d30: 206f 7574 206f 6620 7468 6520 7175 6575   out of the queu
+00012d40: 652e 2049 6620 6069 735f 726f 6f74 6973  e. If `is_rootis
+00012d50: 6860 2063 6861 6e67 6573 2074 6f20 6120  h` changes to a 
+00012d60: 7374 6174 6963 2064 6566 696e 6974 696f  static definitio
+00012d70: 6e2c 0a20 2020 2020 2020 2020 2020 2023  n,.            #
+00012d80: 2074 6865 6e20 6164 6420 7468 6174 2061   then add that a
+00012d90: 7373 6572 7469 6f6e 2068 6572 6520 2861  ssertion here (a
+00012da0: 6e64 2061 6374 7561 6c6c 7920 7061 7373  nd actually pass
+00012db0: 2069 6e20 7468 6520 7461 736b 292e 0a20   in the task).. 
+00012dc0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00012dd0: 7420 6e6f 7420 6d61 7468 2e69 7369 6e66  t not math.isinf
+00012de0: 2873 656c 662e 574f 524b 4552 5f53 4154  (self.WORKER_SAT
+00012df0: 5552 4154 494f 4e29 0a0a 2020 2020 2020  URATION)..      
+00012e00: 2020 6966 206e 6f74 2073 656c 662e 6964    if not self.id
+00012e10: 6c65 5f74 6173 6b5f 636f 756e 743a 0a20  le_task_count:. 
+00012e20: 2020 2020 2020 2020 2020 2023 2041 6c6c             # All
+00012e30: 2077 6f72 6b65 7273 2062 7573 793f 2054   workers busy? T
+00012e40: 6173 6b20 6765 7473 2f73 7461 7973 2071  ask gets/stays q
+00012e50: 7565 7565 642e 0a20 2020 2020 2020 2020  ueued..         
+00012e60: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00012e70: 2020 2020 2020 2020 2320 4a75 7374 2070          # Just p
+00012e80: 6963 6b20 7468 6520 6c65 6173 7420 6275  ick the least bu
+00012e90: 7379 2077 6f72 6b65 722e 0a20 2020 2020  sy worker..     
+00012ea0: 2020 2023 204e 4f54 453a 2074 6869 7320     # NOTE: this 
+00012eb0: 7769 6c6c 206c 6561 6420 746f 2077 6f72  will lead to wor
+00012ec0: 7374 2d63 6173 6520 7363 6865 6475 6c69  st-case scheduli
+00012ed0: 6e67 2077 6974 6820 7265 6761 7264 7320  ng with regards 
+00012ee0: 746f 2063 6f2d 6173 7369 676e 6d65 6e74  to co-assignment
+00012ef0: 2e0a 2020 2020 2020 2020 7773 203d 206d  ..        ws = m
+00012f00: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00012f10: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
+00012f20: 6f75 6e74 2c0a 2020 2020 2020 2020 2020  ount,.          
+00012f30: 2020 6b65 793d 6c61 6d62 6461 2077 733a    key=lambda ws:
+00012f40: 206c 656e 2877 732e 7072 6f63 6573 7369   len(ws.processi
+00012f50: 6e67 2920 2f20 7773 2e6e 7468 7265 6164  ng) / ws.nthread
+00012f60: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+00012f70: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00012f80: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00012f90: 2020 2061 7373 6572 7420 6e6f 7420 5f77     assert not _w
+00012fa0: 6f72 6b65 725f 6675 6c6c 2877 732c 2073  orker_full(ws, s
+00012fb0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+00012fc0: 4154 494f 4e29 2c20 280a 2020 2020 2020  ATION), (.      
+00012fd0: 2020 2020 2020 2020 2020 7773 2c0a 2020            ws,.  
+00012fe0: 2020 2020 2020 2020 2020 2020 2020 5f74                _t
+00012ff0: 6173 6b5f 736c 6f74 735f 6176 6169 6c61  ask_slots_availa
+00013000: 626c 6528 7773 2c20 7365 6c66 2e57 4f52  ble(ws, self.WOR
+00013010: 4b45 525f 5341 5455 5241 5449 4f4e 292c  KER_SATURATION),
+00013020: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00013030: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00013040: 7420 7773 2069 6e20 7365 6c66 2e72 756e  t ws in self.run
+00013050: 6e69 6e67 2c20 2877 732c 2073 656c 662e  ning, (ws, self.
+00013060: 7275 6e6e 696e 6729 0a0a 2020 2020 2020  running)..      
+00013070: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00013080: 7465 2061 6e64 2077 7320 6973 206e 6f74  te and ws is not
+00013090: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000130a0: 2020 2061 7373 6572 7420 7365 6c66 2e77     assert self.w
+000130b0: 6f72 6b65 7273 2e67 6574 2877 732e 6164  orkers.get(ws.ad
+000130c0: 6472 6573 7329 2069 7320 7773 0a20 2020  dress) is ws.   
+000130d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000130e0: 7773 2069 6e20 7365 6c66 2e72 756e 6e69  ws in self.runni
+000130f0: 6e67 2c20 2877 732c 2073 656c 662e 7275  ng, (ws, self.ru
+00013100: 6e6e 696e 6729 0a0a 2020 2020 2020 2020  nning)..        
+00013110: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
+00013120: 6566 2064 6563 6964 655f 776f 726b 6572  ef decide_worker
+00013130: 5f6e 6f6e 5f72 6f6f 7469 7368 2873 656c  _non_rootish(sel
+00013140: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+00013150: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
+00013160: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
+00013170: 2022 2222 5069 636b 2061 2077 6f72 6b65   """Pick a worke
+00013180: 7220 666f 7220 6120 7275 6e6e 6162 6c65  r for a runnable
+00013190: 206e 6f6e 2d72 6f6f 7420 7461 736b 2c20   non-root task, 
+000131a0: 636f 6e73 6964 6572 696e 6720 6465 7065  considering depe
+000131b0: 6e64 656e 6369 6573 2061 6e64 0a20 2020  ndencies and.   
+000131c0: 2020 2020 2072 6573 7472 6963 7469 6f6e       restriction
+000131d0: 732e 0a0a 2020 2020 2020 2020 4f75 7420  s...        Out 
+000131e0: 6f66 2065 6c69 6769 626c 6520 776f 726b  of eligible work
+000131f0: 6572 7320 686f 6c64 696e 6720 6465 7065  ers holding depe
+00013200: 6e64 656e 6369 6573 206f 6620 6060 7473  ndencies of ``ts
+00013210: 6060 2c20 7365 6c65 6374 7320 7468 6520  ``, selects the 
+00013220: 776f 726b 6572 0a20 2020 2020 2020 2077  worker.        w
+00013230: 6865 7265 2c20 636f 6e73 6964 6572 696e  here, considerin
+00013240: 6720 776f 726b 6572 2062 6163 6b6c 6f6e  g worker backlon
+00013250: 6720 616e 6420 6461 7461 2d74 7261 6e73  g and data-trans
+00013260: 6665 7220 636f 7374 732c 2074 6865 2074  fer costs, the t
+00013270: 6173 6b20 6973 0a20 2020 2020 2020 2065  ask is.        e
+00013280: 7374 696d 6174 6564 2074 6f20 7374 6172  stimated to star
+00013290: 7420 7275 6e6e 696e 6720 7468 6520 736f  t running the so
+000132a0: 6f6e 6573 742e 0a0a 2020 2020 2020 2020  onest...        
+000132b0: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
+000132c0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+000132d0: 7773 3a20 576f 726b 6572 5374 6174 6520  ws: WorkerState 
+000132e0: 7c20 4e6f 6e65 0a20 2020 2020 2020 2020  | None.         
+000132f0: 2020 2054 6865 2077 6f72 6b65 7220 746f     The worker to
+00013300: 2061 7373 6967 6e20 7468 6520 7461 736b   assign the task
+00013310: 2074 6f2e 2049 6620 6e6f 2077 6f72 6b65   to. If no worke
+00013320: 7273 2073 6174 6973 6679 2074 6865 2072  rs satisfy the r
+00013330: 6573 7472 6963 7469 6f6e 7320 6f66 0a20  estrictions of. 
+00013340: 2020 2020 2020 2020 2020 2060 6074 7360             ``ts`
+00013350: 6020 6f72 2074 6865 7265 2061 7265 206e  ` or there are n
+00013360: 6f20 7275 6e6e 696e 6720 776f 726b 6572  o running worker
+00013370: 732c 2072 6574 7572 6e73 204e 6f6e 652c  s, returns None,
+00013380: 2069 6e20 7768 6963 6820 6361 7365 2074   in which case t
+00013390: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
+000133a0: 2020 2020 7368 6f75 6c64 2062 6520 7472      should be tr
+000133b0: 616e 7369 7469 6f6e 6564 2074 6f20 6060  ansitioned to ``
+000133c0: 6e6f 2d77 6f72 6b65 7260 602e 0a20 2020  no-worker``..   
+000133d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000133e0: 2069 6620 6e6f 7420 7365 6c66 2e72 756e   if not self.run
+000133f0: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00013400: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00013410: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
+00013420: 6b65 7273 203d 2073 656c 662e 7661 6c69  kers = self.vali
+00013430: 645f 776f 726b 6572 7328 7473 290a 2020  d_workers(ts).  
+00013440: 2020 2020 2020 6966 2076 616c 6964 5f77        if valid_w
+00013450: 6f72 6b65 7273 2069 7320 4e6f 6e65 2061  orkers is None a
+00013460: 6e64 206c 656e 2873 656c 662e 7275 6e6e  nd len(self.runn
+00013470: 696e 6729 203c 206c 656e 2873 656c 662e  ing) < len(self.
+00013480: 776f 726b 6572 7329 3a0a 2020 2020 2020  workers):.      
+00013490: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+000134a0: 662e 7275 6e6e 696e 673a 0a20 2020 2020  f.running:.     
+000134b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000134c0: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+000134d0: 2020 2020 2320 4966 2074 6865 7265 2077      # If there w
+000134e0: 6572 6520 6e6f 2072 6573 7472 6963 7469  ere no restricti
+000134f0: 6f6e 732c 2060 7661 6c69 645f 776f 726b  ons, `valid_work
+00013500: 6572 7328 2960 2064 6964 6e27 7420 7375  ers()` didn't su
+00013510: 6273 6574 2062 790a 2020 2020 2020 2020  bset by.        
+00013520: 2020 2020 2320 6072 756e 6e69 6e67 602e      # `running`.
+00013530: 0a20 2020 2020 2020 2020 2020 2076 616c  .            val
+00013540: 6964 5f77 6f72 6b65 7273 203d 2073 656c  id_workers = sel
+00013550: 662e 7275 6e6e 696e 670a 0a20 2020 2020  f.running..     
+00013560: 2020 2069 6620 7473 2e64 6570 656e 6465     if ts.depende
+00013570: 6e63 6965 7320 6f72 2076 616c 6964 5f77  ncies or valid_w
+00013580: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
+00013590: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000135a0: 7773 203d 2064 6563 6964 655f 776f 726b  ws = decide_work
+000135b0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000135c0: 2020 2020 7473 2c0a 2020 2020 2020 2020      ts,.        
+000135d0: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+000135e0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+000135f0: 2020 2020 2020 7661 6c69 645f 776f 726b        valid_work
+00013600: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00013610: 2020 2020 2070 6172 7469 616c 2873 656c       partial(sel
+00013620: 662e 776f 726b 6572 5f6f 626a 6563 7469  f.worker_objecti
+00013630: 7665 2c20 7473 292c 0a20 2020 2020 2020  ve, ts),.       
+00013640: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00013650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00013660: 2023 2054 4f44 4f20 6966 2060 6973 5f72   # TODO if `is_r
+00013670: 6f6f 7469 7368 6020 776f 756c 6420 616c  ootish` would al
+00013680: 7761 7973 2072 6574 7572 6e20 5472 7565  ways return True
+00013690: 2066 6f72 2074 6173 6b73 2077 6974 686f   for tasks witho
+000136a0: 7574 0a20 2020 2020 2020 2020 2020 2023  ut.            #
+000136b0: 2064 6570 656e 6465 6e63 6965 732c 2077   dependencies, w
+000136c0: 6520 636f 756c 6420 7265 6d6f 7665 2061  e could remove a
+000136d0: 6c6c 2074 6869 7320 6c6f 6769 632e 2054  ll this logic. T
+000136e0: 6865 2072 6f6f 7469 7368 2061 7373 6967  he rootish assig
+000136f0: 6e6d 656e 7420 6c6f 6769 630a 2020 2020  nment logic.    
+00013700: 2020 2020 2020 2020 2320 776f 756c 6420          # would 
+00013710: 6265 6861 7665 206d 6f72 6520 6f72 206c  behave more or l
+00013720: 6573 7320 7468 6520 7361 6d65 2061 7320  ess the same as 
+00013730: 7468 6973 2c20 6d61 7962 6520 7769 7468  this, maybe with
+00013740: 6f75 7420 6775 6172 616e 7465 6564 0a20  out guaranteed. 
+00013750: 2020 2020 2020 2020 2020 2023 2072 6f75             # rou
+00013760: 6e64 2d72 6f62 696e 2074 686f 7567 683f  nd-robin though?
+00013770: 2054 6869 7320 7061 7468 2069 7320 6f6e   This path is on
+00013780: 6c79 2072 6561 6368 6162 6c65 2077 6865  ly reachable whe
+00013790: 6e20 6074 7360 2064 6f65 736e 2774 2068  n `ts` doesn't h
+000137a0: 6176 650a 2020 2020 2020 2020 2020 2020  ave.            
+000137b0: 2320 6465 7065 6e64 656e 6369 6573 2c20  # dependencies, 
+000137c0: 6275 7420 6974 7320 6772 6f75 7020 6973  but its group is
+000137d0: 2061 6c73 6f20 736d 616c 6c65 7220 7468   also smaller th
+000137e0: 616e 2074 6865 2063 6c75 7374 6572 2e0a  an the cluster..
+000137f0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+00013800: 6173 7470 6174 6820 7768 656e 2074 6865  astpath when the
+00013810: 7265 2061 7265 206e 6f20 7265 6c61 7465  re are no relate
+00013820: 6420 7461 736b 7320 6f72 2072 6573 7472  d tasks or restr
+00013830: 6963 7469 6f6e 730a 2020 2020 2020 2020  ictions.        
+00013840: 2020 2020 776f 726b 6572 5f70 6f6f 6c20      worker_pool 
+00013850: 3d20 7365 6c66 2e69 646c 6520 6f72 2073  = self.idle or s
+00013860: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
+00013870: 2020 2020 2020 2020 2320 4649 584d 4520          # FIXME 
+00013880: 6964 6c65 2061 6e64 2077 6f72 6b65 7273  idle and workers
+00013890: 2061 7265 2053 6f72 7465 6444 6963 7427   are SortedDict'
+000138a0: 7320 6465 636c 6172 6564 2061 7320 6469  s declared as di
+000138b0: 6374 730a 2020 2020 2020 2020 2020 2020  cts.            
+000138c0: 2320 2020 2020 2020 6265 6361 7573 6520  #       because 
+000138d0: 736f 7274 6564 636f 6e74 6169 6e65 7273  sortedcontainers
+000138e0: 2069 7320 6e6f 7420 616e 6e6f 7461 7465   is not annotate
+000138f0: 640a 2020 2020 2020 2020 2020 2020 7770  d.            wp
+00013900: 5f76 616c 7320 3d20 6361 7374 2822 5365  _vals = cast("Se
+00013910: 7175 656e 6365 5b57 6f72 6b65 7253 7461  quence[WorkerSta
+00013920: 7465 5d22 2c20 776f 726b 6572 5f70 6f6f  te]", worker_poo
+00013930: 6c2e 7661 6c75 6573 2829 290a 2020 2020  l.values()).    
+00013940: 2020 2020 2020 2020 6e5f 776f 726b 6572          n_worker
+00013950: 7320 3d20 6c65 6e28 7770 5f76 616c 7329  s = len(wp_vals)
+00013960: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00013970: 6e5f 776f 726b 6572 7320 3c20 3230 3a20  n_workers < 20: 
+00013980: 2023 2073 6d61 7274 2062 7574 206c 696e   # smart but lin
+00013990: 6561 7220 696e 2073 6d61 6c6c 2063 6173  ear in small cas
+000139a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000139b0: 2020 7773 203d 206d 696e 2877 705f 7661    ws = min(wp_va
+000139c0: 6c73 2c20 6b65 793d 6f70 6572 6174 6f72  ls, key=operator
+000139d0: 2e61 7474 7267 6574 7465 7228 226f 6363  .attrgetter("occ
+000139e0: 7570 616e 6379 2229 290a 2020 2020 2020  upancy")).      
+000139f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00013a00: 2077 730a 2020 2020 2020 2020 2020 2020   ws.            
+00013a10: 2020 2020 6966 2077 732e 6f63 6375 7061      if ws.occupa
+00013a20: 6e63 7920 3d3d 2030 3a0a 2020 2020 2020  ncy == 0:.      
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013a40: 7370 6563 6961 6c20 6361 7365 2074 6f20  special case to 
+00013a50: 7573 6520 726f 756e 642d 726f 6269 6e3b  use round-robin;
+00013a60: 206c 696e 6561 7220 7365 6172 6368 0a20   linear search. 
+00013a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a80: 2020 2023 2066 6f72 206e 6578 7420 776f     # for next wo
+00013a90: 726b 6572 2077 6974 6820 7a65 726f 206f  rker with zero o
+00013aa0: 6363 7570 616e 6379 2028 6f72 206a 7573  ccupancy (or jus
+00013ab0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00013ac0: 2020 2020 2020 2320 6c61 6e64 2062 6163        # land bac
+00013ad0: 6b20 7768 6572 6520 7765 2073 7461 7274  k where we start
+00013ae0: 6564 292e 0a20 2020 2020 2020 2020 2020  ed)..           
+00013af0: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+00013b00: 2073 656c 662e 6e5f 7461 736b 7320 2520   self.n_tasks % 
+00013b10: 6e5f 776f 726b 6572 730a 2020 2020 2020  n_workers.      
+00013b20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00013b30: 7220 6920 696e 2072 616e 6765 286e 5f77  r i in range(n_w
+00013b40: 6f72 6b65 7273 293a 0a20 2020 2020 2020  orkers):.       
+00013b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b60: 2077 705f 6920 3d20 7770 5f76 616c 735b   wp_i = wp_vals[
+00013b70: 2869 202b 2073 7461 7274 2920 2520 6e5f  (i + start) % n_
+00013b80: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
+00013b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ba0: 2069 6620 7770 5f69 2e6f 6363 7570 616e   if wp_i.occupan
+00013bb0: 6379 203d 3d20 303a 0a20 2020 2020 2020  cy == 0:.       
+00013bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bd0: 2020 2020 2077 7320 3d20 7770 5f69 0a20       ws = wp_i. 
+00013be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013bf0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00013c00: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00013c10: 653a 2020 2320 6475 6d62 2062 7574 2066  e:  # dumb but f
+00013c20: 6173 7420 696e 206c 6172 6765 2063 6173  ast in large cas
+00013c30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00013c40: 2020 7773 203d 2077 705f 7661 6c73 5b73    ws = wp_vals[s
+00013c50: 656c 662e 6e5f 7461 736b 7320 2520 6e5f  elf.n_tasks % n_
+00013c60: 776f 726b 6572 735d 0a0a 2020 2020 2020  workers]..      
+00013c70: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+00013c80: 7465 2061 6e64 2077 7320 6973 206e 6f74  te and ws is not
+00013c90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00013ca0: 2020 2061 7373 6572 7420 7365 6c66 2e77     assert self.w
+00013cb0: 6f72 6b65 7273 2e67 6574 2877 732e 6164  orkers.get(ws.ad
+00013cc0: 6472 6573 7329 2069 7320 7773 0a20 2020  dress) is ws.   
+00013cd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00013ce0: 7773 2069 6e20 7365 6c66 2e72 756e 6e69  ws in self.runni
+00013cf0: 6e67 2c20 2877 732c 2073 656c 662e 7275  ng, (ws, self.ru
+00013d00: 6e6e 696e 6729 0a0a 2020 2020 2020 2020  nning)..        
+00013d10: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
+00013d20: 6566 2074 7261 6e73 6974 696f 6e5f 7761  ef transition_wa
+00013d30: 6974 696e 675f 7072 6f63 6573 7369 6e67  iting_processing
+00013d40: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
+00013d50: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00013d60: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00013d70: 2020 2020 2020 2020 2222 2250 6f73 7369          """Possi
+00013d80: 626c 7920 7363 6865 6475 6c65 2061 2072  bly schedule a r
+00013d90: 6561 6479 2074 6173 6b2e 2054 6869 7320  eady task. This 
+00013da0: 6973 2074 6865 2070 7269 6d61 7279 2064  is the primary d
+00013db0: 6973 7061 7463 6820 666f 7220 7265 6164  ispatch for read
+00013dc0: 7920 7461 736b 732e 0a0a 2020 2020 2020  y tasks...      
+00013dd0: 2020 4966 2074 6865 7265 2773 206e 6f20    If there's no 
+00013de0: 6170 7072 6f70 7269 6174 6520 776f 726b  appropriate work
+00013df0: 6572 2066 6f72 2074 6865 2074 6173 6b20  er for the task 
+00013e00: 2862 7574 2074 6865 2074 6173 6b20 6973  (but the task is
+00013e10: 206f 7468 6572 7769 7365 0a20 2020 2020   otherwise.     
+00013e20: 2020 2072 756e 6e61 626c 6529 2c20 6974     runnable), it
+00013e30: 2077 696c 6c20 6265 2072 6563 6f6d 6d65   will be recomme
+00013e40: 6e64 6564 2074 6f20 6060 6e6f 2d77 6f72  nded to ``no-wor
+00013e50: 6b65 7260 6020 6f72 2060 6071 7565 7565  ker`` or ``queue
+00013e60: 6460 602e 0a20 2020 2020 2020 2022 2222  d``..        """
+00013e70: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00013e80: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00013e90: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00013ea0: 735f 726f 6f74 6973 6828 7473 293a 0a20  s_rootish(ts):. 
+00013eb0: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
+00013ec0: 453a 2068 6176 696e 6720 7477 6f20 726f  E: having two ro
+00013ed0: 6f74 2d69 7368 206d 6574 686f 6473 2069  ot-ish methods i
+00013ee0: 7320 7465 6d70 6f72 6172 792e 2057 6865  s temporary. Whe
+00013ef0: 6e20 7468 6520 6665 6174 7572 6520 666c  n the feature fl
+00013f00: 6167 2069 730a 2020 2020 2020 2020 2020  ag is.          
+00013f10: 2020 2320 7265 6d6f 7665 642c 2074 6865    # removed, the
+00013f20: 7265 2073 686f 756c 6420 6f6e 6c79 2062  re should only b
+00013f30: 6520 6f6e 652c 2077 6869 6368 2063 6f6d  e one, which com
+00013f40: 6269 6e65 7320 636f 2d61 7373 6967 6e6d  bines co-assignm
+00013f50: 656e 7420 616e 640a 2020 2020 2020 2020  ent and.        
+00013f60: 2020 2020 2320 7175 6575 696e 672e 2045      # queuing. E
+00013f70: 7665 6e74 7561 6c6c 792c 2073 7065 6369  ventually, speci
+00013f80: 616c 2d63 6173 696e 6720 726f 6f74 2074  al-casing root t
+00013f90: 6173 6b73 206d 6967 6874 2062 6520 7265  asks might be re
+00013fa0: 6d6f 7665 6420 656e 7469 7265 6c79 2c0a  moved entirely,.
+00013fb0: 2020 2020 2020 2020 2020 2020 2320 7769              # wi
+00013fc0: 7468 2062 6574 7465 7220 6865 7572 6973  th better heuris
+00013fd0: 7469 6373 2e0a 2020 2020 2020 2020 2020  tics..          
+00013fe0: 2020 6966 206d 6174 682e 6973 696e 6628    if math.isinf(
+00013ff0: 7365 6c66 2e57 4f52 4b45 525f 5341 5455  self.WORKER_SATU
+00014000: 5241 5449 4f4e 293a 0a20 2020 2020 2020  RATION):.       
+00014010: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00014020: 2877 7320 3a3d 2073 656c 662e 6465 6369  (ws := self.deci
+00014030: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+00014040: 685f 7175 6575 696e 675f 6469 7361 626c  h_queuing_disabl
+00014050: 6564 2874 7329 293a 0a20 2020 2020 2020  ed(ts)):.       
+00014060: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00014070: 7572 6e20 7b74 732e 6b65 793a 2022 6e6f  urn {ts.key: "no
+00014080: 2d77 6f72 6b65 7222 7d2c 207b 7d2c 207b  -worker"}, {}, {
+00014090: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
+000140a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000140b0: 2020 2020 6966 206e 6f74 2028 7773 203a      if not (ws :
+000140c0: 3d20 7365 6c66 2e64 6563 6964 655f 776f  = self.decide_wo
+000140d0: 726b 6572 5f72 6f6f 7469 7368 5f71 7565  rker_rootish_que
+000140e0: 7569 6e67 5f65 6e61 626c 6564 2829 293a  uing_enabled()):
+000140f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014100: 2020 2020 2072 6574 7572 6e20 7b74 732e       return {ts.
+00014110: 6b65 793a 2022 7175 6575 6564 227d 2c20  key: "queued"}, 
+00014120: 7b7d 2c20 7b7d 0a20 2020 2020 2020 2065  {}, {}.        e
+00014130: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00014140: 2069 6620 6e6f 7420 2877 7320 3a3d 2073   if not (ws := s
+00014150: 656c 662e 6465 6369 6465 5f77 6f72 6b65  elf.decide_worke
+00014160: 725f 6e6f 6e5f 726f 6f74 6973 6828 7473  r_non_rootish(ts
+00014170: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00014180: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
+00014190: 6579 3a20 226e 6f2d 776f 726b 6572 227d  ey: "no-worker"}
+000141a0: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
+000141b0: 2020 776f 726b 6572 5f6d 7367 7320 3d20    worker_msgs = 
+000141c0: 7365 6c66 2e5f 6164 645f 746f 5f70 726f  self._add_to_pro
+000141d0: 6365 7373 696e 6728 7473 2c20 7773 290a  cessing(ts, ws).
+000141e0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000141f0: 7d2c 207b 7d2c 2077 6f72 6b65 725f 6d73  }, {}, worker_ms
+00014200: 6773 0a0a 2020 2020 6465 6620 7472 616e  gs..    def tran
+00014210: 7369 7469 6f6e 5f77 6169 7469 6e67 5f6d  sition_waiting_m
+00014220: 656d 6f72 7928 0a20 2020 2020 2020 2073  emory(.        s
+00014230: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+00014240: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+00014250: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+00014260: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+00014270: 2020 2020 6e62 7974 6573 3a20 696e 7420      nbytes: int 
+00014280: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00014290: 2020 2020 2020 2074 7970 653a 2062 7974         type: byt
+000142a0: 6573 207c 204e 6f6e 6520 3d20 4e6f 6e65  es | None = None
+000142b0: 2c0a 2020 2020 2020 2020 7479 7065 6e61  ,.        typena
+000142c0: 6d65 3a20 7374 7220 7c20 4e6f 6e65 203d  me: str | None =
+000142d0: 204e 6f6e 652c 0a20 2020 2020 2020 2077   None,.        w
+000142e0: 6f72 6b65 723a 2073 7472 2c0a 2020 2020  orker: str,.    
+000142f0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+00014300: 792c 0a20 2020 2029 202d 3e20 5265 6373  y,.    ) -> Recs
+00014310: 4d73 6773 3a0a 2020 2020 2020 2020 2222  Msgs:.        ""
+00014320: 2254 6869 7320 7472 616e 7369 7469 6f6e  "This transition
+00014330: 2065 7863 6c75 7369 7665 6c79 2068 6170   exclusively hap
+00014340: 7065 6e73 2069 6e20 6120 7261 6365 2063  pens in a race c
+00014350: 6f6e 6469 7469 6f6e 2077 6865 7265 2074  ondition where t
+00014360: 6865 2073 6368 6564 756c 6572 0a20 2020  he scheduler.   
+00014370: 2020 2020 2062 656c 6965 7665 7320 7468       believes th
+00014380: 6174 2074 6865 206f 6e6c 7920 636f 7079  at the only copy
+00014390: 206f 6620 6120 6465 7065 6e64 656e 6379   of a dependency
+000143a0: 2074 6173 6b20 6861 7320 6a75 7374 2062   task has just b
+000143b0: 6565 6e20 6c6f 7374 2c20 736f 2069 740a  een lost, so it.
+000143c0: 2020 2020 2020 2020 7472 616e 7369 7469          transiti
+000143d0: 6f6e 7320 616c 6c20 6465 7065 6e64 656e  ons all dependen
+000143e0: 7473 2062 6163 6b20 746f 2077 6169 7469  ts back to waiti
+000143f0: 6e67 2c20 6275 7420 6163 7475 616c 6c79  ng, but actually
+00014400: 2061 2072 6570 6c69 6361 2068 6173 2061   a replica has a
+00014410: 6c72 6561 6479 0a20 2020 2020 2020 2062  lready.        b
+00014420: 6565 6e20 6163 7175 6972 6564 2062 7920  een acquired by 
+00014430: 6120 776f 726b 6572 2063 6f6d 7075 7469  a worker computi
+00014440: 6e67 2074 6865 2064 6570 656e 6465 6e63  ng the dependenc
+00014450: 7920 2d20 7468 6520 7363 6865 6475 6c65  y - the schedule
+00014460: 7220 6a75 7374 2064 6f65 736e 2774 0a20  r just doesn't. 
+00014470: 2020 2020 2020 206b 6e6f 7720 7965 7420         know yet 
+00014480: 2d20 616e 6420 7468 6520 6578 6563 7574  - and the execut
+00014490: 696f 6e20 6669 6e69 7368 6573 2062 6566  ion finishes bef
+000144a0: 6f72 6520 7468 6520 6361 6e63 656c 6c61  ore the cancella
+000144b0: 7469 6f6e 206d 6573 7361 6765 2066 726f  tion message fro
+000144c0: 6d20 7468 650a 2020 2020 2020 2020 7363  m the.        sc
+000144d0: 6865 6475 6c65 7220 6861 7320 6120 6368  heduler has a ch
+000144e0: 616e 6365 2074 6f20 7265 6163 6820 7468  ance to reach th
+000144f0: 6520 776f 726b 6572 2e20 5368 6f72 746c  e worker. Shortl
+00014500: 792c 2074 6865 2063 616e 6365 6c6c 6174  y, the cancellat
+00014510: 696f 6e20 7265 7175 6573 740a 2020 2020  ion request.    
+00014520: 2020 2020 7769 6c6c 2072 6561 6368 2074      will reach t
+00014530: 6865 2077 6f72 6b65 722c 2074 6875 7320  he worker, thus 
+00014540: 6465 6c65 7469 6e67 2074 6865 2064 6174  deleting the dat
+00014550: 6120 6672 6f6d 206d 656d 6f72 792e 0a20  a from memory.. 
+00014560: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00014570: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00014580: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00014590: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+000145a0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+000145b0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+000145c0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+000145d0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+000145e0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+000145f0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00014600: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
+00014610: 696e 6722 0a0a 2020 2020 2020 2020 7265  ing"..        re
+00014620: 7475 726e 207b 7d2c 207b 7d2c 207b 7d0a  turn {}, {}, {}.
+00014630: 0a20 2020 2064 6566 2074 7261 6e73 6974  .    def transit
+00014640: 696f 6e5f 7072 6f63 6573 7369 6e67 5f6d  ion_processing_m
+00014650: 656d 6f72 7928 0a20 2020 2020 2020 2073  emory(.        s
+00014660: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
+00014670: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
+00014680: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+00014690: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+000146a0: 2020 2020 6e62 7974 6573 3a20 696e 7420      nbytes: int 
+000146b0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000146c0: 2020 2020 2020 2074 7970 653a 2062 7974         type: byt
+000146d0: 6573 207c 204e 6f6e 6520 3d20 4e6f 6e65  es | None = None
+000146e0: 2c0a 2020 2020 2020 2020 7479 7065 6e61  ,.        typena
+000146f0: 6d65 3a20 7374 7220 7c20 4e6f 6e65 203d  me: str | None =
+00014700: 204e 6f6e 652c 0a20 2020 2020 2020 2077   None,.        w
+00014710: 6f72 6b65 723a 2073 7472 2c0a 2020 2020  orker: str,.    
+00014720: 2020 2020 7374 6172 7473 746f 7073 3a20      startstops: 
+00014730: 6c69 7374 5b64 6963 745d 207c 204e 6f6e  list[dict] | Non
+00014740: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00014750: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+00014760: 0a20 2020 2029 202d 3e20 5265 6373 4d73  .    ) -> RecsMs
+00014770: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+00014780: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00014790: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+000147a0: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+000147b0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000147c0: 6528 776f 726b 6572 2c20 7374 7229 0a0a  e(worker, str)..
+000147d0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000147e0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+000147f0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00014800: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00014810: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+00014820: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00014830: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00014840: 6572 7420 7773 730a 2020 2020 2020 2020  ert wss.        
+00014850: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+00014860: 2077 7373 2e70 726f 6365 7373 696e 670a   wss.processing.
+00014870: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00014880: 7773 730a 2020 2020 2020 2020 2020 2020  wss.            
+00014890: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+000148a0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+000148b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000148c0: 7473 2e77 686f 5f68 6173 2c20 2874 732c  ts.who_has, (ts,
+000148d0: 2074 732e 7768 6f5f 6861 7329 0a20 2020   ts.who_has).   
+000148e0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000148f0: 6e6f 7420 7473 2e65 7863 6570 7469 6f6e  not ts.exception
+00014900: 5f62 6c61 6d65 0a20 2020 2020 2020 2020  _blame.         
+00014910: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
+00014920: 7465 203d 3d20 2270 726f 6365 7373 696e  te == "processin
+00014930: 6722 0a0a 2020 2020 2020 2020 7773 203d  g"..        ws =
+00014940: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
+00014950: 7428 776f 726b 6572 290a 2020 2020 2020  t(worker).      
+00014960: 2020 6966 2077 7320 6973 204e 6f6e 653a    if ws is None:
+00014970: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00014980: 7572 6e20 7b6b 6579 3a20 2272 656c 6561  urn {key: "relea
+00014990: 7365 6422 7d2c 207b 7d2c 207b 7d0a 0a20  sed"}, {}, {}.. 
+000149a0: 2020 2020 2020 2069 6620 7773 2021 3d20         if ws != 
+000149b0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+000149c0: 3a20 2023 2070 7261 676d 613a 206e 6f63  :  # pragma: noc
+000149d0: 6f76 6572 0a20 2020 2020 2020 2020 2020  over.           
+000149e0: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
+000149f0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+00014a00: 2020 2020 2072 6169 7365 2052 756e 7469       raise Runti
+00014a10: 6d65 4572 726f 7228 0a20 2020 2020 2020  meError(.       
+00014a20: 2020 2020 2020 2020 2066 2254 6173 6b20           f"Task 
+00014a30: 7b74 732e 6b65 7921 727d 2074 7261 6e73  {ts.key!r} trans
+00014a40: 6974 696f 6e65 6420 6672 6f6d 2070 726f  itioned from pro
+00014a50: 6365 7373 696e 6720 746f 206d 656d 6f72  cessing to memor
+00014a60: 7920 6f6e 2077 6f72 6b65 7220 220a 2020  y on worker ".  
+00014a70: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00014a80: 7b77 737d 2c20 7768 696c 6520 6974 2077  {ws}, while it w
+00014a90: 6173 2065 7870 6563 7465 6420 6672 6f6d  as expected from
+00014aa0: 207b 7473 2e70 726f 6365 7373 696e 675f   {ts.processing_
+00014ab0: 6f6e 7d2e 2054 6869 7320 7368 6f75 6c64  on}. This should
+00014ac0: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00014ad0: 2020 2066 2262 6520 696d 706f 7373 6962     f"be impossib
+00014ae0: 6c65 2e20 7b73 7469 6d75 6c75 735f 6964  le. {stimulus_id
+00014af0: 3d7d 2c20 7374 6f72 793d 7b73 656c 662e  =}, story={self.
+00014b00: 7374 6f72 7928 7473 297d 220a 2020 2020  story(ts)}".    
+00014b10: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00014b20: 2020 2023 2323 2323 2323 2323 2323 2323     #############
 00014b30: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014b40: 2323 230a 2020 2020 2020 2020 6966 2073  ###.        if s
-00014b50: 7461 7274 7374 6f70 733a 0a20 2020 2020  tartstops:.     
-00014b60: 2020 2020 2020 2066 6f72 2073 7461 7274         for start
-00014b70: 7374 6f70 2069 6e20 7374 6172 7473 746f  stop in startsto
-00014b80: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
-00014b90: 2020 2020 7473 2e67 726f 7570 2e61 6464      ts.group.add
-00014ba0: 5f64 7572 6174 696f 6e28 0a20 2020 2020  _duration(.     
-00014bb0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014bc0: 746f 703d 7374 6172 7473 746f 705b 2273  top=startstop["s
-00014bd0: 746f 7022 5d2c 0a20 2020 2020 2020 2020  top"],.         
-00014be0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-00014bf0: 3d73 7461 7274 7374 6f70 5b22 7374 6172  =startstop["star
-00014c00: 7422 5d2c 0a20 2020 2020 2020 2020 2020  t"],.           
-00014c10: 2020 2020 2020 2020 2061 6374 696f 6e3d           action=
-00014c20: 7374 6172 7473 746f 705b 2261 6374 696f  startstop["actio
-00014c30: 6e22 5d2c 0a20 2020 2020 2020 2020 2020  n"],.           
-00014c40: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00014c50: 7320 3d20 7365 6c66 2e75 6e6b 6e6f 776e  s = self.unknown
-00014c60: 5f64 7572 6174 696f 6e73 2e70 6f70 2874  _durations.pop(t
-00014c70: 732e 7072 6566 6978 2e6e 616d 652c 2073  s.prefix.name, s
-00014c80: 6574 2829 290a 2020 2020 2020 2020 7374  et()).        st
-00014c90: 6561 6c20 3d20 7365 6c66 2e65 7874 656e  eal = self.exten
-00014ca0: 7369 6f6e 732e 6765 7428 2273 7465 616c  sions.get("steal
-00014cb0: 696e 6722 290a 2020 2020 2020 2020 6966  ing").        if
-00014cc0: 2073 7465 616c 3a0a 2020 2020 2020 2020   steal:.        
-00014cd0: 2020 2020 666f 7220 7474 7320 696e 2073      for tts in s
-00014ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014cf0: 2020 6966 2074 7473 2e70 726f 6365 7373    if tts.process
-00014d00: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
-00014d10: 2020 2020 2020 2020 2020 2020 7374 6561              stea
-00014d20: 6c2e 7265 6361 6c63 756c 6174 655f 636f  l.recalculate_co
-00014d30: 7374 2874 7473 290a 0a20 2020 2020 2020  st(tts)..       
-00014d40: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00014d50: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00014d60: 2020 2020 2020 2320 5570 6461 7465 2053        # Update S
-00014d70: 7461 7465 2049 6e66 6f72 6d61 7469 6f6e  tate Information
-00014d80: 2023 0a20 2020 2020 2020 2023 2323 2323   #.        #####
+00014b40: 0a20 2020 2020 2020 2023 2055 7064 6174  .        # Updat
+00014b50: 6520 5469 6d69 6e67 2049 6e66 6f72 6d61  e Timing Informa
+00014b60: 7469 6f6e 2023 0a20 2020 2020 2020 2023  tion #.        #
+00014b70: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014b80: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+00014b90: 2020 2020 2069 6620 7374 6172 7473 746f       if startsto
+00014ba0: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00014bb0: 666f 7220 7374 6172 7473 746f 7020 696e  for startstop in
+00014bc0: 2073 7461 7274 7374 6f70 733a 0a20 2020   startstops:.   
+00014bd0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+00014be0: 6772 6f75 702e 6164 645f 6475 7261 7469  group.add_durati
+00014bf0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+00014c00: 2020 2020 2020 2020 7374 6f70 3d73 7461          stop=sta
+00014c10: 7274 7374 6f70 5b22 7374 6f70 225d 2c0a  rtstop["stop"],.
+00014c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c30: 2020 2020 7374 6172 743d 7374 6172 7473      start=starts
+00014c40: 746f 705b 2273 7461 7274 225d 2c0a 2020  top["start"],.  
+00014c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014c60: 2020 6163 7469 6f6e 3d73 7461 7274 7374    action=startst
+00014c70: 6f70 5b22 6163 7469 6f6e 225d 2c0a 2020  op["action"],.  
+00014c80: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00014c90: 0a20 2020 2020 2020 2073 203d 2073 656c  .        s = sel
+00014ca0: 662e 756e 6b6e 6f77 6e5f 6475 7261 7469  f.unknown_durati
+00014cb0: 6f6e 732e 706f 7028 7473 2e70 7265 6669  ons.pop(ts.prefi
+00014cc0: 782e 6e61 6d65 2c20 7365 7428 2929 0a20  x.name, set()). 
+00014cd0: 2020 2020 2020 2073 7465 616c 203d 2073         steal = s
+00014ce0: 656c 662e 6578 7465 6e73 696f 6e73 2e67  elf.extensions.g
+00014cf0: 6574 2822 7374 6561 6c69 6e67 2229 0a20  et("stealing"). 
+00014d00: 2020 2020 2020 2069 6620 7374 6561 6c3a         if steal:
+00014d10: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00014d20: 2074 7473 2069 6e20 733a 0a20 2020 2020   tts in s:.     
+00014d30: 2020 2020 2020 2020 2020 2069 6620 7474             if tt
+00014d40: 732e 7072 6f63 6573 7369 6e67 5f6f 6e3a  s.processing_on:
+00014d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014d60: 2020 2020 2073 7465 616c 2e72 6563 616c       steal.recal
+00014d70: 6375 6c61 7465 5f63 6f73 7428 7474 7329  culate_cost(tts)
+00014d80: 0a0a 2020 2020 2020 2020 2323 2323 2323  ..        ######
 00014d90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00014da0: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-00014db0: 6966 206e 6279 7465 7320 6973 206e 6f74  if nbytes is not
-00014dc0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00014dd0: 2020 2074 732e 7365 745f 6e62 7974 6573     ts.set_nbytes
-00014de0: 286e 6279 7465 7329 0a0a 2020 2020 2020  (nbytes)..      
-00014df0: 2020 7365 6c66 2e5f 6578 6974 5f70 726f    self._exit_pro
-00014e00: 6365 7373 696e 675f 636f 6d6d 6f6e 2874  cessing_common(t
-00014e10: 7329 0a0a 2020 2020 2020 2020 7265 636f  s)..        reco
-00014e20: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00014e30: 7320 3d20 7b7d 0a20 2020 2020 2020 2063  s = {}.        c
-00014e40: 6c69 656e 745f 6d73 6773 3a20 4d73 6773  lient_msgs: Msgs
-00014e50: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00014e60: 6c66 2e5f 6164 645f 746f 5f6d 656d 6f72  lf._add_to_memor
-00014e70: 7928 0a20 2020 2020 2020 2020 2020 2074  y(.            t
-00014e80: 732c 2077 732c 2072 6563 6f6d 6d65 6e64  s, ws, recommend
-00014e90: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00014ea0: 7367 732c 2074 7970 653d 7479 7065 2c20  sgs, type=type, 
-00014eb0: 7479 7065 6e61 6d65 3d74 7970 656e 616d  typename=typenam
-00014ec0: 650a 2020 2020 2020 2020 290a 0a20 2020  e.        )..   
-00014ed0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00014ee0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00014ef0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00014f00: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-00014f10: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014f20: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00014f30: 5f6f 6e0a 0a20 2020 2020 2020 2072 6574  _on..        ret
-00014f40: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00014f50: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-00014f60: 2c20 7b7d 0a0a 2020 2020 6465 6620 7472  , {}..    def tr
-00014f70: 616e 7369 7469 6f6e 5f6d 656d 6f72 795f  ansition_memory_
-00014f80: 7265 6c65 6173 6564 280a 2020 2020 2020  released(.      
-00014f90: 2020 7365 6c66 2c20 6b65 793a 2073 7472    self, key: str
-00014fa0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00014fb0: 7472 2c20 2a2c 2073 6166 653a 2062 6f6f  tr, *, safe: boo
-00014fc0: 6c20 3d20 4661 6c73 650a 2020 2020 2920  l = False.    ) 
-00014fd0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00014fe0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00014ff0: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
-00015000: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00015010: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00015020: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00015030: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-00015040: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00015050: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00015060: 6e0a 2020 2020 2020 2020 2020 2020 6966  n.            if
-00015070: 2073 6166 653a 0a20 2020 2020 2020 2020   safe:.         
-00015080: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015090: 7420 7473 2e77 6169 7465 7273 0a0a 2020  t ts.waiters..  
-000150a0: 2020 2020 2020 6966 2074 732e 6163 746f        if ts.acto
-000150b0: 723a 0a20 2020 2020 2020 2020 2020 2066  r:.            f
-000150c0: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
-000150d0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-000150e0: 2020 2020 2077 732e 6163 746f 7273 2e64       ws.actors.d
-000150f0: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
-00015100: 2020 2020 2020 2069 6620 7473 2e77 686f         if ts.who
-00015110: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
-00015120: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
-00015130: 7469 6f6e 5f62 6c61 6d65 203d 2074 730a  tion_blame = ts.
-00015140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015150: 7473 2e65 7863 6570 7469 6f6e 203d 2053  ts.exception = S
-00015160: 6572 6961 6c69 7a65 6428 0a20 2020 2020  erialized(.     
-00015170: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-00015180: 7365 7269 616c 697a 6528 5661 6c75 6545  serialize(ValueE
-00015190: 7272 6f72 2822 576f 726b 6572 2068 6f6c  rror("Worker hol
-000151a0: 6469 6e67 2041 6374 6f72 2077 6173 206c  ding Actor was l
-000151b0: 6f73 7422 2929 0a20 2020 2020 2020 2020  ost")).         
-000151c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000151d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000151e0: 7b74 732e 6b65 793a 2022 6572 7265 6422  {ts.key: "erred"
-000151f0: 7d2c 207b 7d2c 207b 7d20 2023 2064 6f6e  }, {}, {}  # don
-00015200: 2774 2074 7279 2074 6f20 7265 6372 6561  't try to recrea
-00015210: 7465 0a0a 2020 2020 2020 2020 7265 636f  te..        reco
-00015220: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00015230: 7320 3d20 7b7d 0a20 2020 2020 2020 2063  s = {}.        c
-00015240: 6c69 656e 745f 6d73 6773 3a20 4d73 6773  lient_msgs: Msgs
-00015250: 203d 207b 7d0a 2020 2020 2020 2020 776f   = {}.        wo
-00015260: 726b 6572 5f6d 7367 733a 204d 7367 7320  rker_msgs: Msgs 
-00015270: 3d20 7b7d 0a0a 2020 2020 2020 2020 2320  = {}..        # 
-00015280: 5858 5820 6661 6374 6f72 2074 6869 7320  XXX factor this 
-00015290: 6f75 743f 0a20 2020 2020 2020 2077 6f72  out?.        wor
-000152a0: 6b65 725f 6d73 6720 3d20 7b0a 2020 2020  ker_msg = {.    
-000152b0: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
-000152c0: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
-000152d0: 2020 2020 2020 2022 6b65 7973 223a 205b         "keys": [
-000152e0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
-000152f0: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-00015300: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00015310: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00015320: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
-00015330: 5f68 6173 3a0a 2020 2020 2020 2020 2020  _has:.          
-00015340: 2020 776f 726b 6572 5f6d 7367 735b 7773    worker_msgs[ws
-00015350: 2e61 6464 7265 7373 5d20 3d20 5b77 6f72  .address] = [wor
-00015360: 6b65 725f 6d73 675d 0a20 2020 2020 2020  ker_msg].       
-00015370: 2073 656c 662e 7265 6d6f 7665 5f61 6c6c   self.remove_all
-00015380: 5f72 6570 6c69 6361 7328 7473 290a 0a20  _replicas(ts).. 
-00015390: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-000153a0: 3d20 2272 656c 6561 7365 6422 0a0a 2020  = "released"..  
-000153b0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
-000153c0: 203d 207b 226f 7022 3a20 226c 6f73 742d   = {"op": "lost-
-000153d0: 6461 7461 222c 2022 6b65 7922 3a20 6b65  data", "key": ke
-000153e0: 797d 0a20 2020 2020 2020 2066 6f72 2063  y}.        for c
-000153f0: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-00015400: 733a 0a20 2020 2020 2020 2020 2020 2063  s:.            c
-00015410: 6c69 656e 745f 6d73 6773 5b63 732e 636c  lient_msgs[cs.cl
-00015420: 6965 6e74 5f6b 6579 5d20 3d20 5b72 6570  ient_key] = [rep
-00015430: 6f72 745f 6d73 675d 0a0a 2020 2020 2020  ort_msg]..      
-00015440: 2020 6966 206e 6f74 2074 732e 7275 6e5f    if not ts.run_
-00015450: 7370 6563 3a20 2023 2070 7572 6520 6461  spec:  # pure da
-00015460: 7461 0a20 2020 2020 2020 2020 2020 2072  ta.            r
-00015470: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
-00015480: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
-00015490: 220a 2020 2020 2020 2020 656c 6966 2074  ".        elif t
-000154a0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
-000154b0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-000154c0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-000154d0: 696f 6e73 5b6b 6579 5d20 3d20 2266 6f72  ions[key] = "for
-000154e0: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
-000154f0: 656c 6966 2074 732e 7768 6f5f 7761 6e74  elif ts.who_want
-00015500: 7320 6f72 2074 732e 7761 6974 6572 733a  s or ts.waiters:
-00015510: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
-00015520: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
-00015530: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
-00015540: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00015550: 6e20 7473 2e77 6169 7465 7273 3a0a 2020  n ts.waiters:.  
-00015560: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
-00015570: 2e73 7461 7465 2069 6e20 2822 6e6f 2d77  .state in ("no-w
-00015580: 6f72 6b65 7222 2c20 2270 726f 6365 7373  orker", "process
-00015590: 696e 6722 293a 0a20 2020 2020 2020 2020  ing"):.         
-000155a0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-000155b0: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
-000155c0: 3d20 2277 6169 7469 6e67 220a 2020 2020  = "waiting".    
-000155d0: 2020 2020 2020 2020 656c 6966 2064 7473          elif dts
-000155e0: 2e73 7461 7465 203d 3d20 2277 6169 7469  .state == "waiti
-000155f0: 6e67 223a 0a20 2020 2020 2020 2020 2020  ng":.           
-00015600: 2020 2020 2064 7473 2e77 6169 7469 6e67       dts.waiting
-00015610: 5f6f 6e2e 6164 6428 7473 290a 0a20 2020  _on.add(ts)..   
-00015620: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00015630: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00015640: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00015650: 2e77 6169 7469 6e67 5f6f 6e0a 0a20 2020  .waiting_on..   
-00015660: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-00015670: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-00015680: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-00015690: 5f6d 7367 730a 0a20 2020 2064 6566 2074  _msgs..    def t
-000156a0: 7261 6e73 6974 696f 6e5f 7265 6c65 6173  ransition_releas
-000156b0: 6564 5f65 7272 6564 2873 656c 662c 206b  ed_erred(self, k
-000156c0: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
-000156d0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-000156e0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-000156f0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00015700: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
-00015710: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00015720: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-00015730: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-00015740: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-00015750: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-00015760: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00015770: 7468 206c 6f67 5f65 7272 6f72 7328 7064  th log_errors(pd
-00015780: 623d 4c4f 475f 5044 4229 3a0a 2020 2020  b=LOG_PDB):.    
-00015790: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000157a0: 7274 2074 732e 6578 6365 7074 696f 6e5f  rt ts.exception_
-000157b0: 626c 616d 650a 2020 2020 2020 2020 2020  blame.          
-000157c0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-000157d0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-000157e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000157f0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-00015800: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00015810: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00015820: 7473 2e77 6169 7465 7273 0a0a 2020 2020  ts.waiters..    
-00015830: 2020 2020 6661 696c 696e 675f 7473 203d      failing_ts =
-00015840: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
-00015850: 616d 650a 2020 2020 2020 2020 6173 7365  ame.        asse
-00015860: 7274 2066 6169 6c69 6e67 5f74 730a 0a20  rt failing_ts.. 
-00015870: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-00015880: 6e20 7473 2e64 6570 656e 6465 6e74 733a  n ts.dependents:
-00015890: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-000158a0: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-000158b0: 203d 2066 6169 6c69 6e67 5f74 730a 2020   = failing_ts.  
-000158c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-000158d0: 2064 7473 2e77 686f 5f68 6173 3a0a 2020   dts.who_has:.  
-000158e0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000158f0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-00015900: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
-00015910: 0a0a 2020 2020 2020 2020 7265 706f 7274  ..        report
-00015920: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
-00015930: 2020 2020 2022 6f70 223a 2022 7461 736b       "op": "task
-00015940: 2d65 7272 6564 222c 0a20 2020 2020 2020  -erred",.       
-00015950: 2020 2020 2022 6b65 7922 3a20 6b65 792c       "key": key,
-00015960: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
-00015970: 6365 7074 696f 6e22 3a20 6661 696c 696e  ception": failin
-00015980: 675f 7473 2e65 7863 6570 7469 6f6e 2c0a  g_ts.exception,.
-00015990: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
-000159a0: 6365 6261 636b 223a 2066 6169 6c69 6e67  ceback": failing
-000159b0: 5f74 732e 7472 6163 6562 6163 6b2c 0a20  _ts.traceback,. 
-000159c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000159d0: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
-000159e0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-000159f0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00015a00: 5b63 732e 636c 6965 6e74 5f6b 6579 5d20  [cs.client_key] 
-00015a10: 3d20 5b72 6570 6f72 745f 6d73 675d 0a0a  = [report_msg]..
-00015a20: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-00015a30: 203d 2022 6572 7265 6422 0a0a 2020 2020   = "erred"..    
-00015a40: 2020 2020 2320 544f 444f 3a20 7761 6974      # TODO: wait
-00015a50: 696e 6720 6461 7461 3f0a 2020 2020 2020  ing data?.      
-00015a60: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-00015a70: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-00015a80: 5f6d 7367 732c 207b 7d0a 0a20 2020 2064  _msgs, {}..    d
-00015a90: 6566 2074 7261 6e73 6974 696f 6e5f 6572  ef transition_er
-00015aa0: 7265 645f 7265 6c65 6173 6564 2873 656c  red_released(sel
-00015ab0: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00015ac0: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00015ad0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00015ae0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00015af0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-00015b00: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015b10: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-00015b20: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-00015b30: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
-00015b40: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-00015b50: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
-00015b60: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00015b70: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00015b80: 2077 6974 6820 6c6f 675f 6572 726f 7273   with log_errors
-00015b90: 2870 6462 3d4c 4f47 5f50 4442 293a 0a20  (pdb=LOG_PDB):. 
-00015ba0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00015bb0: 7373 6572 7420 7473 2e65 7863 6570 7469  ssert ts.excepti
-00015bc0: 6f6e 5f62 6c61 6d65 0a20 2020 2020 2020  on_blame.       
-00015bd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015be0: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-00015bf0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00015c00: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00015c10: 7469 6e67 5f6f 6e0a 2020 2020 2020 2020  ting_on.        
-00015c20: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00015c30: 6f74 2074 732e 7761 6974 6572 730a 0a20  ot ts.waiters.. 
-00015c40: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-00015c50: 696f 6e20 3d20 4e6f 6e65 0a20 2020 2020  ion = None.     
-00015c60: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
-00015c70: 626c 616d 6520 3d20 4e6f 6e65 0a20 2020  blame = None.   
-00015c80: 2020 2020 2074 732e 7472 6163 6562 6163       ts.tracebac
-00015c90: 6b20 3d20 4e6f 6e65 0a0a 2020 2020 2020  k = None..      
-00015ca0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-00015cb0: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
-00015cc0: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
-00015cd0: 7461 7465 203d 3d20 2265 7272 6564 223a  tate == "erred":
-00015ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015cf0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015d00: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
-00015d10: 7469 6e67 220a 0a20 2020 2020 2020 2077  ting"..        w
-00015d20: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
-00015d30: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
-00015d40: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
-00015d50: 2020 2020 226b 6579 7322 3a20 5b6b 6579      "keys": [key
-00015d60: 5d2c 0a20 2020 2020 2020 2020 2020 2022  ],.            "
-00015d70: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-00015d80: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00015d90: 2020 207d 0a20 2020 2020 2020 2066 6f72     }.        for
-00015da0: 2077 735f 6164 6472 2069 6e20 7473 2e65   ws_addr in ts.e
-00015db0: 7272 6564 5f6f 6e3a 0a20 2020 2020 2020  rred_on:.       
-00015dc0: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00015dd0: 5b77 735f 6164 6472 5d20 3d20 5b77 5f6d  [ws_addr] = [w_m
-00015de0: 7367 5d0a 2020 2020 2020 2020 7473 2e65  sg].        ts.e
-00015df0: 7272 6564 5f6f 6e2e 636c 6561 7228 290a  rred_on.clear().
-00015e00: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
-00015e10: 6d73 6720 3d20 7b22 6f70 223a 2022 7461  msg = {"op": "ta
-00015e20: 736b 2d72 6574 7269 6564 222c 2022 6b65  sk-retried", "ke
-00015e30: 7922 3a20 6b65 797d 0a20 2020 2020 2020  y": key}.       
-00015e40: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
-00015e50: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-00015e60: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00015e70: 5b63 732e 636c 6965 6e74 5f6b 6579 5d20  [cs.client_key] 
-00015e80: 3d20 5b72 6570 6f72 745f 6d73 675d 0a0a  = [report_msg]..
-00015e90: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-00015ea0: 203d 2022 7265 6c65 6173 6564 220a 0a20   = "released".. 
-00015eb0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00015ec0: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-00015ed0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-00015ee0: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
-00015ef0: 2074 7261 6e73 6974 696f 6e5f 7761 6974   transition_wait
-00015f00: 696e 675f 7265 6c65 6173 6564 2873 656c  ing_released(sel
-00015f10: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
-00015f20: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00015f30: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00015f40: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00015f50: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-00015f60: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00015f70: 3a20 5265 6373 203d 207b 7d0a 0a20 2020  : Recs = {}..   
-00015f80: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00015f90: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00015fa0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-00015fb0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-00015fc0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00015fd0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00015fe0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-00015ff0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-00016000: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00016010: 2020 6966 2074 7320 696e 2064 7473 2e77    if ts in dts.w
-00016020: 6169 7465 7273 3a0a 2020 2020 2020 2020  aiters:.        
-00016030: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-00016040: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
-00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016060: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
-00016070: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
-00016080: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-00016090: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000160a0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-000160b0: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-000160c0: 6564 220a 2020 2020 2020 2020 7473 2e77  ed".        ts.w
-000160d0: 6169 7469 6e67 5f6f 6e2e 636c 6561 7228  aiting_on.clear(
-000160e0: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
-000160f0: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
-00016100: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
-00016110: 6861 735f 6c6f 7374 5f64 6570 656e 6465  has_lost_depende
-00016120: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-00016130: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-00016140: 6e73 5b6b 6579 5d20 3d20 2266 6f72 676f  ns[key] = "forgo
-00016150: 7474 656e 220a 2020 2020 2020 2020 656c  tten".        el
-00016160: 6966 206e 6f74 2074 732e 6578 6365 7074  if not ts.except
-00016170: 696f 6e5f 626c 616d 6520 616e 6420 2874  ion_blame and (t
-00016180: 732e 7768 6f5f 7761 6e74 7320 6f72 2074  s.who_wants or t
-00016190: 732e 7761 6974 6572 7329 3a0a 2020 2020  s.waiters):.    
-000161a0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000161b0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
-000161c0: 7761 6974 696e 6722 0a20 2020 2020 2020  waiting".       
-000161d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000161e0: 2020 2074 732e 7761 6974 6572 732e 636c     ts.waiters.cl
-000161f0: 6561 7228 290a 0a20 2020 2020 2020 2072  ear()..        r
-00016200: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00016210: 7469 6f6e 732c 207b 7d2c 207b 7d0a 0a20  tions, {}, {}.. 
-00016220: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-00016230: 6e5f 7072 6f63 6573 7369 6e67 5f72 656c  n_processing_rel
-00016240: 6561 7365 6428 7365 6c66 2c20 6b65 793a  eased(self, key:
-00016250: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
-00016260: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
-00016270: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
-00016280: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00016290: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
-000162a0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
-000162b0: 3d20 7b7d 0a20 2020 2020 2020 2077 6f72  = {}.        wor
-000162c0: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
-000162d0: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-000162e0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-000162f0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00016300: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00016310: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00016320: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
-00016330: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
-00016340: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00016350: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-00016360: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00016370: 7374 6174 6520 3d3d 2022 7072 6f63 6573  state == "proces
-00016380: 7369 6e67 220a 0a20 2020 2020 2020 2077  sing"..        w
-00016390: 7320 3d20 7365 6c66 2e5f 6578 6974 5f70  s = self._exit_p
-000163a0: 726f 6365 7373 696e 675f 636f 6d6d 6f6e  rocessing_common
-000163b0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
-000163c0: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
-000163d0: 776f 726b 6572 5f6d 7367 735b 7773 2e61  worker_msgs[ws.a
-000163e0: 6464 7265 7373 5d20 3d20 5b0a 2020 2020  ddress] = [.    
-000163f0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00016400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016410: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
-00016420: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
-00016430: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
-00016440: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
-00016450: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00016460: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00016470: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00016480: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00016490: 2020 2020 2020 5d0a 0a20 2020 2020 2020        ]..       
-000164a0: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
-000164b0: 5f72 656c 6561 7365 6428 7473 2c20 7265  _released(ts, re
-000164c0: 636f 6d6d 656e 6461 7469 6f6e 7329 0a20  commendations). 
-000164d0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-000164e0: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
-000164f0: 7d2c 2077 6f72 6b65 725f 6d73 6773 0a0a  }, worker_msgs..
-00016500: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-00016510: 6f6e 5f70 726f 6365 7373 696e 675f 6572  on_processing_er
-00016520: 7265 6428 0a20 2020 2020 2020 2073 656c  red(.        sel
-00016530: 662c 0a20 2020 2020 2020 206b 6579 3a20  f,.        key: 
-00016540: 7374 722c 0a20 2020 2020 2020 2073 7469  str,.        sti
-00016550: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
-00016560: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-00016570: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
-00016580: 2020 2020 2020 2063 6175 7365 3a20 7374         cause: st
-00016590: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-000165a0: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-000165b0: 6f6e 3a20 5365 7269 616c 697a 6564 207c  on: Serialized |
-000165c0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000165d0: 2020 2020 2020 7472 6163 6562 6163 6b3a        traceback:
-000165e0: 2053 6572 6961 6c69 7a65 6420 7c20 4e6f   Serialized | No
-000165f0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00016600: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-00016610: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
-00016620: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
-00016630: 6163 6562 6163 6b5f 7465 7874 3a20 7374  aceback_text: st
-00016640: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00016650: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00016660: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-00016670: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00016680: 2020 2022 2222 5072 6f63 6573 7365 6420     """Processed 
-00016690: 6120 7265 636f 6d6d 656e 6465 6420 7472  a recommended tr
-000166a0: 616e 7369 7469 6f6e 2070 726f 6365 7373  ansition process
-000166b0: 696e 6720 2d3e 2065 7272 6564 2e0a 0a20  ing -> erred... 
-000166c0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-000166d0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-000166e0: 2d2d 2d2d 0a20 2020 2020 2020 206b 6579  ----.        key
-000166f0: 0a20 2020 2020 2020 2020 2020 4b65 7920  .           Key 
-00016700: 6f66 2074 6865 2074 6173 6b20 746f 2074  of the task to t
-00016710: 7261 6e73 6974 696f 6e0a 2020 2020 2020  ransition.      
-00016720: 2020 7374 696d 756c 7573 5f69 640a 2020    stimulus_id.  
-00016730: 2020 2020 2020 2020 2020 4944 206f 6620            ID of 
-00016740: 7468 6520 7374 696d 756c 7573 2063 6175  the stimulus cau
-00016750: 7369 6e67 2074 6865 2074 7261 6e73 6974  sing the transit
-00016760: 696f 6e0a 2020 2020 2020 2020 776f 726b  ion.        work
-00016770: 6572 0a20 2020 2020 2020 2020 2020 2041  er.            A
-00016780: 6464 7265 7373 206f 6620 7468 6520 776f  ddress of the wo
-00016790: 726b 6572 2077 6865 7265 2074 6865 2074  rker where the t
-000167a0: 6173 6b20 6572 7265 642e 0a20 2020 2020  ask erred..     
-000167b0: 2020 2020 2020 204e 6f74 206e 6563 6573         Not neces
-000167c0: 7361 7269 6c79 2060 6074 732e 7072 6f63  sarily ``ts.proc
-000167d0: 6573 7369 6e67 5f6f 6e60 602e 0a20 2020  essing_on``..   
-000167e0: 2020 2020 2063 6175 7365 0a20 2020 2020       cause.     
-000167f0: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
-00016800: 6620 7468 6520 7461 736b 2074 6861 7420  f the task that 
-00016810: 6361 7573 6564 2074 6869 7320 7461 736b  caused this task
-00016820: 2074 6f20 6265 2074 7261 6e73 6974 696f   to be transitio
-00016830: 6e65 6420 746f 2065 7272 6564 0a20 2020  ned to erred.   
-00016840: 2020 2020 2065 7863 6570 7469 6f6e 0a20       exception. 
-00016850: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
-00016860: 7469 6f6e 2063 6175 7365 6420 6279 2074  tion caused by t
-00016870: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
-00016880: 7472 6163 6562 6163 6b0a 2020 2020 2020  traceback.      
-00016890: 2020 2020 2020 5472 6163 6562 6163 6b20        Traceback 
-000168a0: 6361 7573 6564 2062 7920 7468 6520 7461  caused by the ta
-000168b0: 736b 0a20 2020 2020 2020 2065 7863 6570  sk.        excep
-000168c0: 7469 6f6e 5f74 6578 740a 2020 2020 2020  tion_text.      
-000168d0: 2020 2020 2020 5374 7269 6e67 2072 6570        String rep
-000168e0: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
-000168f0: 6865 2065 7863 6570 7469 6f6e 0a20 2020  he exception.   
-00016900: 2020 2020 2074 7261 6365 6261 636b 5f74       traceback_t
-00016910: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
-00016920: 5374 7269 6e67 2072 6570 7265 7365 6e74  String represent
-00016930: 6174 696f 6e20 6f66 2074 6865 2074 7261  ation of the tra
-00016940: 6365 6261 636b 0a0a 2020 2020 2020 2020  ceback..        
-00016950: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-00016960: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00016970: 5265 636f 6d6d 656e 6461 7469 6f6e 732c  Recommendations,
-00016980: 2063 6c69 656e 7420 6d65 7373 6167 6573   client messages
-00016990: 2061 6e64 2077 6f72 6b65 7220 6d65 7373   and worker mess
-000169a0: 6167 6573 2074 6f20 7072 6f63 6573 730a  ages to process.
-000169b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000169c0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000169d0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-000169e0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000169f0: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-00016a00: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-00016a10: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
-00016a20: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00016a30: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00016a40: 2020 6173 7365 7274 2063 6175 7365 206f    assert cause o
-00016a50: 7220 7473 2e65 7863 6570 7469 6f6e 5f62  r ts.exception_b
-00016a60: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
-00016a70: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
-00016a80: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00016a90: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00016aa0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-00016ab0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00016ac0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00016ad0: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
-00016ae0: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-00016af0: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
-00016b00: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-00016b10: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
-00016b20: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
-00016b30: 6f72 732e 7265 6d6f 7665 2874 7329 0a0a  ors.remove(ts)..
-00016b40: 2020 2020 2020 2020 7365 6c66 2e5f 6578          self._ex
-00016b50: 6974 5f70 726f 6365 7373 696e 675f 636f  it_processing_co
-00016b60: 6d6d 6f6e 2874 7329 0a0a 2020 2020 2020  mmon(ts)..      
-00016b70: 2020 7473 2e65 7272 6564 5f6f 6e2e 6164    ts.erred_on.ad
-00016b80: 6428 776f 726b 6572 290a 2020 2020 2020  d(worker).      
-00016b90: 2020 6966 2065 7863 6570 7469 6f6e 2069    if exception i
-00016ba0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00016bb0: 2020 2020 2020 2020 7473 2e65 7863 6570          ts.excep
-00016bc0: 7469 6f6e 203d 2065 7863 6570 7469 6f6e  tion = exception
-00016bd0: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-00016be0: 6578 6365 7074 696f 6e5f 7465 7874 203d  exception_text =
-00016bf0: 2065 7863 6570 7469 6f6e 5f74 6578 7420   exception_text 
-00016c00: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00016c10: 2020 2020 2020 2020 6966 2074 7261 6365          if trace
-00016c20: 6261 636b 2069 7320 6e6f 7420 4e6f 6e65  back is not None
-00016c30: 3a0a 2020 2020 2020 2020 2020 2020 7473  :.            ts
-00016c40: 2e74 7261 6365 6261 636b 203d 2074 7261  .traceback = tra
-00016c50: 6365 6261 636b 0a20 2020 2020 2020 2020  ceback.         
-00016c60: 2020 2074 732e 7472 6163 6562 6163 6b5f     ts.traceback_
-00016c70: 7465 7874 203d 2074 7261 6365 6261 636b  text = traceback
-00016c80: 5f74 6578 7420 2023 2074 7970 653a 2069  _text  # type: i
-00016c90: 676e 6f72 650a 2020 2020 2020 2020 6966  gnore.        if
-00016ca0: 2063 6175 7365 2069 7320 6e6f 7420 4e6f   cause is not No
-00016cb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00016cc0: 6661 696c 696e 675f 7473 203d 2073 656c  failing_ts = sel
-00016cd0: 662e 7461 736b 735b 6361 7573 655d 0a20  f.tasks[cause]. 
-00016ce0: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
-00016cf0: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00016d00: 6661 696c 696e 675f 7473 0a20 2020 2020  failing_ts.     
-00016d10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00016d20: 2020 2020 2066 6169 6c69 6e67 5f74 7320       failing_ts 
-00016d30: 3d20 7473 2e65 7863 6570 7469 6f6e 5f62  = ts.exception_b
-00016d40: 6c61 6d65 2020 2320 7479 7065 3a20 6967  lame  # type: ig
-00016d50: 6e6f 7265 0a0a 2020 2020 2020 2020 7365  nore..        se
-00016d60: 6c66 2e65 7272 6564 5f74 6173 6b73 2e61  lf.erred_tasks.a
-00016d70: 7070 656e 646c 6566 7428 0a20 2020 2020  ppendleft(.     
-00016d80: 2020 2020 2020 2045 7272 6564 5461 736b         ErredTask
-00016d90: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016da0: 2020 7473 2e6b 6579 2c0a 2020 2020 2020    ts.key,.      
-00016db0: 2020 2020 2020 2020 2020 7469 6d65 2829            time()
-00016dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00016dd0: 2020 7473 2e65 7272 6564 5f6f 6e2e 636f    ts.erred_on.co
-00016de0: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-00016df0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
-00016e00: 7465 7874 206f 7220 2222 2c0a 2020 2020  text or "",.    
-00016e10: 2020 2020 2020 2020 2020 2020 7472 6163              trac
-00016e20: 6562 6163 6b5f 7465 7874 206f 7220 2222  eback_text or ""
-00016e30: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00016e40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00016e50: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00016e60: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
-00016e70: 2020 2020 2020 2020 2064 7473 2e65 7863           dts.exc
-00016e80: 6570 7469 6f6e 5f62 6c61 6d65 203d 2066  eption_blame = f
-00016e90: 6169 6c69 6e67 5f74 730a 2020 2020 2020  ailing_ts.      
-00016ea0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00016eb0: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-00016ec0: 2022 6572 7265 6422 0a0a 2020 2020 2020   "erred"..      
-00016ed0: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-00016ee0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-00016ef0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
-00016f00: 6974 6572 732e 6469 7363 6172 6428 7473  iters.discard(ts
-00016f10: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00016f20: 206e 6f74 2064 7473 2e77 6169 7465 7273   not dts.waiters
-00016f30: 2061 6e64 206e 6f74 2064 7473 2e77 686f   and not dts.who
-00016f40: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
-00016f50: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-00016f60: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-00016f70: 203d 2022 7265 6c65 6173 6564 220a 0a20   = "released".. 
-00016f80: 2020 2020 2020 2074 732e 7761 6974 6572         ts.waiter
-00016f90: 732e 636c 6561 7228 2920 2023 2064 6f20  s.clear()  # do 
-00016fa0: 616e 7974 6869 6e67 2077 6974 6820 7468  anything with th
-00016fb0: 6973 3f0a 0a20 2020 2020 2020 2074 732e  is?..        ts.
-00016fc0: 7374 6174 6520 3d20 2265 7272 6564 220a  state = "erred".
-00016fd0: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
-00016fe0: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
-00016ff0: 2020 2020 226f 7022 3a20 2274 6173 6b2d      "op": "task-
-00017000: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
-00017010: 2020 2020 226b 6579 223a 206b 6579 2c0a      "key": key,.
-00017020: 2020 2020 2020 2020 2020 2020 2265 7863              "exc
-00017030: 6570 7469 6f6e 223a 2066 6169 6c69 6e67  eption": failing
-00017040: 5f74 732e 6578 6365 7074 696f 6e2c 0a20  _ts.exception,. 
-00017050: 2020 2020 2020 2020 2020 2022 7472 6163             "trac
-00017060: 6562 6163 6b22 3a20 6661 696c 696e 675f  eback": failing_
-00017070: 7473 2e74 7261 6365 6261 636b 2c0a 2020  ts.traceback,.  
-00017080: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00017090: 666f 7220 6373 2069 6e20 7473 2e77 686f  for cs in ts.who
-000170a0: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
-000170b0: 2020 2020 636c 6965 6e74 5f6d 7367 735b      client_msgs[
-000170c0: 6373 2e63 6c69 656e 745f 6b65 795d 203d  cs.client_key] =
-000170d0: 205b 7265 706f 7274 5f6d 7367 5d0a 0a20   [report_msg].. 
-000170e0: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
-000170f0: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
-00017100: 6e64 2d66 6f72 6765 7422 5d0a 2020 2020  nd-forget"].    
-00017110: 2020 2020 6966 2074 7320 696e 2063 732e      if ts in cs.
-00017120: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
-00017130: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-00017140: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
-00017150: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
-00017160: 2020 2020 6373 3d63 732c 0a20 2020 2020      cs=cs,.     
-00017170: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
-00017180: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
-00017190: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-000171a0: 6174 696f 6e73 3d72 6563 6f6d 6d65 6e64  ations=recommend
-000171b0: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
-000171c0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
-000171d0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000171e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000171f0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-00017200: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
-00017210: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
-00017220: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
-00017230: 5f6d 7367 732c 207b 7d0a 0a20 2020 2064  _msgs, {}..    d
-00017240: 6566 2074 7261 6e73 6974 696f 6e5f 6e6f  ef transition_no
-00017250: 5f77 6f72 6b65 725f 7265 6c65 6173 6564  _worker_released
-00017260: 2873 656c 662c 206b 6579 3a20 7374 722c  (self, key: str,
-00017270: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00017280: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00017290: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-000172a0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
-000172b0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-000172c0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-000172d0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-000172e0: 7461 736b 735b 6b65 795d 2e73 7461 7465  tasks[key].state
-000172f0: 203d 3d20 226e 6f2d 776f 726b 6572 220a   == "no-worker".
-00017300: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00017310: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
-00017320: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
-00017330: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00017340: 696e 675f 6f6e 0a0a 2020 2020 2020 2020  ing_on..        
-00017350: 7365 6c66 2e75 6e72 756e 6e61 626c 652e  self.unrunnable.
-00017360: 7265 6d6f 7665 2874 7329 0a20 2020 2020  remove(ts).     
-00017370: 2020 2074 732e 7374 6174 6520 3d20 2272     ts.state = "r
-00017380: 656c 6561 7365 6422 0a0a 2020 2020 2020  eleased"..      
-00017390: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-000173a0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-000173b0: 2020 2020 2020 2020 2020 6474 732e 7761            dts.wa
-000173c0: 6974 6572 732e 6469 7363 6172 6428 7473  iters.discard(ts
-000173d0: 290a 0a20 2020 2020 2020 2074 732e 7761  )..        ts.wa
-000173e0: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
-000173f0: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
-00017400: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 6465  , {}, {}..    de
-00017410: 6620 7472 616e 7369 7469 6f6e 5f77 6169  f transition_wai
-00017420: 7469 6e67 5f71 7565 7565 6428 7365 6c66  ting_queued(self
-00017430: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
-00017440: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
-00017450: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00017460: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00017470: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
-00017480: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-00017490: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-000174a0: 7373 6572 7420 6e6f 7420 7365 6c66 2e69  ssert not self.i
-000174b0: 646c 655f 7461 736b 5f63 6f75 6e74 2c20  dle_task_count, 
-000174c0: 2874 732c 2073 656c 662e 6964 6c65 5f74  (ts, self.idle_t
-000174d0: 6173 6b5f 636f 756e 7429 0a20 2020 2020  ask_count).     
-000174e0: 2020 2020 2020 2073 656c 662e 5f76 616c         self._val
-000174f0: 6964 6174 655f 7265 6164 7928 7473 290a  idate_ready(ts).
-00017500: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
-00017510: 6520 3d20 2271 7565 7565 6422 0a20 2020  e = "queued".   
-00017520: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
-00017530: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
-00017540: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-00017550: 207b 7d0a 0a20 2020 2064 6566 2074 7261   {}..    def tra
-00017560: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-00017570: 6e6f 5f77 6f72 6b65 7228 7365 6c66 2c20  no_worker(self, 
-00017580: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-00017590: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
-000175a0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-000175b0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-000175c0: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
-000175d0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-000175e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000175f0: 662e 5f76 616c 6964 6174 655f 7265 6164  f._validate_read
-00017600: 7928 7473 290a 0a20 2020 2020 2020 2074  y(ts)..        t
-00017610: 732e 7374 6174 6520 3d20 226e 6f2d 776f  s.state = "no-wo
-00017620: 726b 6572 220a 2020 2020 2020 2020 7365  rker".        se
-00017630: 6c66 2e75 6e72 756e 6e61 626c 652e 6164  lf.unrunnable.ad
-00017640: 6428 7473 290a 0a20 2020 2020 2020 2072  d(ts)..        r
-00017650: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
-00017660: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-00017670: 7469 6f6e 5f71 7565 7565 645f 7265 6c65  tion_queued_rele
-00017680: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
-00017690: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
-000176a0: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-000176b0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-000176c0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000176d0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-000176e0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-000176f0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00017700: 7320 696e 2073 656c 662e 7175 6575 6564  s in self.queued
-00017710: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017720: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-00017730: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
-00017740: 2020 7365 6c66 2e71 7565 7565 642e 7265    self.queued.re
-00017750: 6d6f 7665 2874 7329 0a0a 2020 2020 2020  move(ts)..      
-00017760: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00017770: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00017780: 2020 2020 2073 656c 662e 5f70 726f 7061       self._propa
-00017790: 6761 7465 5f72 656c 6561 7365 6428 7473  gate_released(ts
-000177a0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-000177b0: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-000177c0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-000177d0: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
-000177e0: 6566 2074 7261 6e73 6974 696f 6e5f 7175  ef transition_qu
-000177f0: 6575 6564 5f70 726f 6365 7373 696e 6728  eued_processing(
-00017800: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
-00017810: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00017820: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00017830: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00017840: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00017850: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00017860: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
-00017870: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-00017880: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
-00017890: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-000178a0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-000178b0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-000178c0: 7473 2e61 6374 6f72 2c20 6622 4163 746f  ts.actor, f"Acto
-000178d0: 7273 2063 616e 2774 2062 6520 7175 6575  rs can't be queu
-000178e0: 6564 3a20 7b74 737d 220a 2020 2020 2020  ed: {ts}".      
-000178f0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-00017900: 696e 2073 656c 662e 7175 6575 6564 0a0a  in self.queued..
-00017910: 2020 2020 2020 2020 6966 2077 7320 3a3d          if ws :=
-00017920: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
-00017930: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-00017940: 696e 675f 656e 6162 6c65 6428 293a 0a20  ing_enabled():. 
-00017950: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017960: 7175 6575 6564 2e64 6973 6361 7264 2874  queued.discard(t
-00017970: 7329 0a20 2020 2020 2020 2020 2020 2077  s).            w
-00017980: 6f72 6b65 725f 6d73 6773 203d 2073 656c  orker_msgs = sel
-00017990: 662e 5f61 6464 5f74 6f5f 7072 6f63 6573  f._add_to_proces
-000179a0: 7369 6e67 2874 732c 2077 7329 0a20 2020  sing(ts, ws).   
-000179b0: 2020 2020 2023 2049 6620 6e6f 2077 6f72       # If no wor
-000179c0: 6b65 722c 2074 6173 6b20 6a75 7374 2073  ker, task just s
-000179d0: 7461 7973 2060 7175 6575 6564 600a 0a20  tays `queued`.. 
-000179e0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-000179f0: 636f 6d6d 656e 6461 7469 6f6e 732c 207b  commendations, {
-00017a00: 7d2c 2077 6f72 6b65 725f 6d73 6773 0a0a  }, worker_msgs..
-00017a10: 2020 2020 6465 6620 5f72 656d 6f76 655f      def _remove_
-00017a20: 6b65 7928 7365 6c66 2c20 6b65 793a 2073  key(self, key: s
-00017a30: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-00017a40: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00017a50: 6173 6b73 2e70 6f70 286b 6579 290a 2020  asks.pop(key).  
-00017a60: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00017a70: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
-00017a80: 7465 6e22 0a20 2020 2020 2020 2073 656c  ten".        sel
-00017a90: 662e 756e 7275 6e6e 6162 6c65 2e64 6973  f.unrunnable.dis
-00017aa0: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
-00017ab0: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
-00017ac0: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
-00017ad0: 2020 2020 2063 732e 7761 6e74 735f 7768       cs.wants_wh
-00017ae0: 6174 2e72 656d 6f76 6528 7473 290a 2020  at.remove(ts).  
-00017af0: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
-00017b00: 7473 2e63 6c65 6172 2829 0a20 2020 2020  ts.clear().     
-00017b10: 2020 2074 732e 7072 6f63 6573 7369 6e67     ts.processing
-00017b20: 5f6f 6e20 3d20 4e6f 6e65 0a20 2020 2020  _on = None.     
-00017b30: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
-00017b40: 626c 616d 6520 3d20 7473 2e65 7863 6570  blame = ts.excep
-00017b50: 7469 6f6e 203d 2074 732e 7472 6163 6562  tion = ts.traceb
-00017b60: 6163 6b20 3d20 4e6f 6e65 0a20 2020 2020  ack = None.     
-00017b70: 2020 2073 656c 662e 7461 736b 5f6d 6574     self.task_met
-00017b80: 6164 6174 612e 706f 7028 6b65 792c 204e  adata.pop(key, N
-00017b90: 6f6e 6529 0a0a 2020 2020 6465 6620 7472  one)..    def tr
-00017ba0: 616e 7369 7469 6f6e 5f6d 656d 6f72 795f  ansition_memory_
-00017bb0: 666f 7267 6f74 7465 6e28 7365 6c66 2c20  forgotten(self, 
-00017bc0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
-00017bd0: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
-00017be0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
-00017bf0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
-00017c00: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
-00017c10: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
-00017c20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017c30: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
-00017c40: 226d 656d 6f72 7922 0a20 2020 2020 2020  "memory".       
-00017c50: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017c60: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00017c70: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00017c80: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
-00017c90: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00017ca0: 2020 6966 206e 6f74 2074 732e 7275 6e5f    if not ts.run_
-00017cb0: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
-00017cc0: 2020 2020 2020 2320 4974 2773 206f 6b20        # It's ok 
-00017cd0: 746f 2066 6f72 6765 7420 6120 7075 7265  to forget a pure
-00017ce0: 2064 6174 6120 7461 736b 0a20 2020 2020   data task.     
-00017cf0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-00017d00: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00017d10: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
-00017d20: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00017d30: 2020 2020 2020 2020 2020 2023 2049 7427             # It'
-00017d40: 7320 6f6b 2074 6f20 666f 7267 6574 2061  s ok to forget a
-00017d50: 2074 6173 6b20 7769 7468 2066 6f72 676f   task with forgo
-00017d60: 7474 656e 2064 6570 656e 6465 6e63 6965  tten dependencie
-00017d70: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00017d80: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-00017d90: 2020 2065 6c69 6620 6e6f 7420 7473 2e77     elif not ts.w
-00017da0: 686f 5f77 616e 7473 2061 6e64 206e 6f74  ho_wants and not
-00017db0: 2074 732e 7761 6974 6572 7320 616e 6420   ts.waiters and 
-00017dc0: 6e6f 7420 7473 2e64 6570 656e 6465 6e74  not ts.dependent
-00017dd0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00017de0: 2020 2023 2049 7427 7320 6f6b 2074 6f20     # It's ok to 
-00017df0: 666f 7267 6574 2061 2074 6173 6b20 7468  forget a task th
-00017e00: 6174 206e 6f62 6f64 7920 6e65 6564 730a  at nobody needs.
-00017e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017e20: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
-00017e30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00017e40: 2020 2020 2020 2072 6169 7365 2041 7373         raise Ass
-00017e50: 6572 7469 6f6e 4572 726f 7228 2255 6e72  ertionError("Unr
-00017e60: 6561 6368 6162 6c65 222c 2074 7329 2020  eachable", ts)  
-00017e70: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
-00017e80: 720a 0a20 2020 2020 2020 2069 6620 7473  r..        if ts
-00017e90: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
-00017ea0: 2020 2020 666f 7220 7773 2069 6e20 7473      for ws in ts
-00017eb0: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-00017ec0: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
-00017ed0: 6f72 732e 6469 7363 6172 6428 7473 290a  ors.discard(ts).
-00017ee0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00017ef0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00017f00: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
-00017f10: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
-00017f20: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
-00017f30: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
-00017f40: 7474 656e 2874 732c 2072 6563 6f6d 6d65  tten(ts, recomme
-00017f50: 6e64 6174 696f 6e73 2c20 776f 726b 6572  ndations, worker
-00017f60: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
-00017f70: 6964 290a 0a20 2020 2020 2020 2063 6c69  id)..        cli
-00017f80: 656e 745f 6d73 6773 203d 205f 7461 736b  ent_msgs = _task
-00017f90: 5f74 6f5f 636c 6965 6e74 5f6d 7367 7328  _to_client_msgs(
-00017fa0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
-00017fb0: 2e5f 7265 6d6f 7665 5f6b 6579 286b 6579  ._remove_key(key
-00017fc0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00017fd0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-00017fe0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
-00017ff0: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
-00018000: 2064 6566 2074 7261 6e73 6974 696f 6e5f   def transition_
-00018010: 7265 6c65 6173 6564 5f66 6f72 676f 7474  released_forgott
-00018020: 656e 2873 656c 662c 206b 6579 3a20 7374  en(self, key: st
-00018030: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
-00018040: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00018050: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00018060: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
-00018070: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00018080: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00018090: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-000180a0: 7374 6174 6520 696e 2028 2272 656c 6561  state in ("relea
-000180b0: 7365 6422 2c20 2265 7272 6564 2229 0a20  sed", "erred"). 
-000180c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000180d0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-000180e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000180f0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-00018100: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00018110: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-00018120: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
-00018130: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
-00018140: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00018150: 696e 675f 6f6e 2c20 2874 732c 2074 732e  ing_on, (ts, ts.
-00018160: 7761 6974 696e 675f 6f6e 290a 2020 2020  waiting_on).    
-00018170: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-00018180: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
-00018190: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-000181a0: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
-000181b0: 6120 7075 7265 2064 6174 6120 7461 736b  a pure data task
-000181c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000181d0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-000181e0: 2020 656c 6966 2074 732e 6861 735f 6c6f    elif ts.has_lo
-000181f0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
-00018200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018210: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
-00018220: 7267 6574 2061 2074 6173 6b20 7769 7468  rget a task with
-00018230: 2066 6f72 676f 7474 656e 2064 6570 656e   forgotten depen
-00018240: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-00018250: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00018260: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
-00018270: 7420 7473 2e77 686f 5f77 616e 7473 2061  t ts.who_wants a
-00018280: 6e64 206e 6f74 2074 732e 7761 6974 6572  nd not ts.waiter
-00018290: 7320 616e 6420 6e6f 7420 7473 2e64 6570  s and not ts.dep
-000182a0: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-000182b0: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
-000182c0: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
-000182d0: 6173 6b20 7468 6174 206e 6f62 6f64 7920  ask that nobody 
-000182e0: 6e65 6564 730a 2020 2020 2020 2020 2020  needs.          
-000182f0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00018300: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018310: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00018320: 7365 2041 7373 6572 7469 6f6e 4572 726f  se AssertionErro
-00018330: 7228 2255 6e72 6561 6368 6162 6c65 222c  r("Unreachable",
-00018340: 2073 7472 2874 7329 2920 2023 2070 7261   str(ts))  # pra
-00018350: 676d 613a 206e 6f63 6f76 6572 0a0a 2020  gma: nocover..  
-00018360: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00018370: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00018380: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00018390: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-000183a0: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-000183b0: 6f70 6167 6174 655f 666f 7267 6f74 7465  opagate_forgotte
-000183c0: 6e28 7473 2c20 7265 636f 6d6d 656e 6461  n(ts, recommenda
-000183d0: 7469 6f6e 732c 2077 6f72 6b65 725f 6d73  tions, worker_ms
-000183e0: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
-000183f0: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-00018400: 5f6d 7367 7320 3d20 5f74 6173 6b5f 746f  _msgs = _task_to
-00018410: 5f63 6c69 656e 745f 6d73 6773 2874 7329  _client_msgs(ts)
-00018420: 0a20 2020 2020 2020 2073 656c 662e 5f72  .        self._r
-00018430: 656d 6f76 655f 6b65 7928 6b65 7929 0a0a  emove_key(key)..
-00018440: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00018450: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00018460: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-00018470: 6b65 725f 6d73 6773 0a0a 2020 2020 2320  ker_msgs..    # 
-00018480: 7b0a 2020 2020 2320 2020 2020 2873 7461  {.    #     (sta
-00018490: 7274 2c20 6669 6e69 7368 293a 0a20 2020  rt, finish):.   
-000184a0: 2023 2020 2020 2074 7261 6e73 6974 696f   #     transitio
-000184b0: 6e5f 3c73 7461 7274 3e5f 3c66 696e 6973  n_<start>_<finis
-000184c0: 683e 280a 2020 2020 2320 2020 2020 2020  h>(.    #       
-000184d0: 2020 7365 6c66 2c20 6b65 793a 2073 7472    self, key: str
-000184e0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-000184f0: 7472 2c20 2a2a 6b77 6172 6773 0a20 2020  tr, **kwargs.   
-00018500: 2023 2020 2020 2029 202d 3e20 2872 6563   #     ) -> (rec
-00018510: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-00018520: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00018530: 725f 6d73 6773 290a 2020 2020 2320 7d0a  r_msgs).    # }.
-00018540: 2020 2020 5f54 5241 4e53 4954 494f 4e53      _TRANSITIONS
-00018550: 5f54 4142 4c45 3a20 436c 6173 7356 6172  _TABLE: ClassVar
-00018560: 5b0a 2020 2020 2020 2020 4d61 7070 696e  [.        Mappin
-00018570: 675b 0a20 2020 2020 2020 2020 2020 2074  g[.            t
-00018580: 7570 6c65 5b54 6173 6b53 7461 7465 5374  uple[TaskStateSt
-00018590: 6174 652c 2054 6173 6b53 7461 7465 5374  ate, TaskStateSt
-000185a0: 6174 655d 2c0a 2020 2020 2020 2020 2020  ate],.          
-000185b0: 2020 4361 6c6c 6162 6c65 5b2e 2e2e 2c20    Callable[..., 
-000185c0: 5265 6373 4d73 6773 5d2c 0a20 2020 2020  RecsMsgs],.     
-000185d0: 2020 205d 0a20 2020 205d 203d 207b 0a20     ].    ] = {. 
-000185e0: 2020 2020 2020 2028 2272 656c 6561 7365         ("release
-000185f0: 6422 2c20 2277 6169 7469 6e67 2229 3a20  d", "waiting"): 
-00018600: 7472 616e 7369 7469 6f6e 5f72 656c 6561  transition_relea
-00018610: 7365 645f 7761 6974 696e 672c 0a20 2020  sed_waiting,.   
-00018620: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
-00018630: 2022 7265 6c65 6173 6564 2229 3a20 7472   "released"): tr
-00018640: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
-00018650: 5f72 656c 6561 7365 642c 0a20 2020 2020  _released,.     
-00018660: 2020 2028 2277 6169 7469 6e67 222c 2022     ("waiting", "
-00018670: 7072 6f63 6573 7369 6e67 2229 3a20 7472  processing"): tr
-00018680: 616e 7369 7469 6f6e 5f77 6169 7469 6e67  ansition_waiting
-00018690: 5f70 726f 6365 7373 696e 672c 0a20 2020  _processing,.   
-000186a0: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
-000186b0: 2022 6e6f 2d77 6f72 6b65 7222 293a 2074   "no-worker"): t
-000186c0: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
-000186d0: 675f 6e6f 5f77 6f72 6b65 722c 0a20 2020  g_no_worker,.   
-000186e0: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
-000186f0: 2022 7175 6575 6564 2229 3a20 7472 616e   "queued"): tran
-00018700: 7369 7469 6f6e 5f77 6169 7469 6e67 5f71  sition_waiting_q
-00018710: 7565 7565 642c 0a20 2020 2020 2020 2028  ueued,.        (
-00018720: 2277 6169 7469 6e67 222c 2022 6d65 6d6f  "waiting", "memo
-00018730: 7279 2229 3a20 7472 616e 7369 7469 6f6e  ry"): transition
-00018740: 5f77 6169 7469 6e67 5f6d 656d 6f72 792c  _waiting_memory,
-00018750: 0a20 2020 2020 2020 2028 2271 7565 7565  .        ("queue
-00018760: 6422 2c20 2272 656c 6561 7365 6422 293a  d", "released"):
-00018770: 2074 7261 6e73 6974 696f 6e5f 7175 6575   transition_queu
-00018780: 6564 5f72 656c 6561 7365 642c 0a20 2020  ed_released,.   
-00018790: 2020 2020 2028 2271 7565 7565 6422 2c20       ("queued", 
-000187a0: 2270 726f 6365 7373 696e 6722 293a 2074  "processing"): t
-000187b0: 7261 6e73 6974 696f 6e5f 7175 6575 6564  ransition_queued
-000187c0: 5f70 726f 6365 7373 696e 672c 0a20 2020  _processing,.   
-000187d0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
-000187e0: 6722 2c20 2272 656c 6561 7365 6422 293a  g", "released"):
-000187f0: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
-00018800: 6573 7369 6e67 5f72 656c 6561 7365 642c  essing_released,
-00018810: 0a20 2020 2020 2020 2028 2270 726f 6365  .        ("proce
-00018820: 7373 696e 6722 2c20 226d 656d 6f72 7922  ssing", "memory"
-00018830: 293a 2074 7261 6e73 6974 696f 6e5f 7072  ): transition_pr
-00018840: 6f63 6573 7369 6e67 5f6d 656d 6f72 792c  ocessing_memory,
-00018850: 0a20 2020 2020 2020 2028 2270 726f 6365  .        ("proce
-00018860: 7373 696e 6722 2c20 2265 7272 6564 2229  ssing", "erred")
-00018870: 3a20 7472 616e 7369 7469 6f6e 5f70 726f  : transition_pro
-00018880: 6365 7373 696e 675f 6572 7265 642c 0a20  cessing_erred,. 
-00018890: 2020 2020 2020 2028 226e 6f2d 776f 726b         ("no-work
-000188a0: 6572 222c 2022 7265 6c65 6173 6564 2229  er", "released")
-000188b0: 3a20 7472 616e 7369 7469 6f6e 5f6e 6f5f  : transition_no_
-000188c0: 776f 726b 6572 5f72 656c 6561 7365 642c  worker_released,
-000188d0: 0a20 2020 2020 2020 2028 226e 6f2d 776f  .        ("no-wo
-000188e0: 726b 6572 222c 2022 7072 6f63 6573 7369  rker", "processi
-000188f0: 6e67 2229 3a20 7472 616e 7369 7469 6f6e  ng"): transition
-00018900: 5f6e 6f5f 776f 726b 6572 5f70 726f 6365  _no_worker_proce
-00018910: 7373 696e 672c 0a20 2020 2020 2020 2028  ssing,.        (
-00018920: 2272 656c 6561 7365 6422 2c20 2266 6f72  "released", "for
-00018930: 676f 7474 656e 2229 3a20 7472 616e 7369  gotten"): transi
-00018940: 7469 6f6e 5f72 656c 6561 7365 645f 666f  tion_released_fo
-00018950: 7267 6f74 7465 6e2c 0a20 2020 2020 2020  rgotten,.       
-00018960: 2028 226d 656d 6f72 7922 2c20 2266 6f72   ("memory", "for
-00018970: 676f 7474 656e 2229 3a20 7472 616e 7369  gotten"): transi
-00018980: 7469 6f6e 5f6d 656d 6f72 795f 666f 7267  tion_memory_forg
-00018990: 6f74 7465 6e2c 0a20 2020 2020 2020 2028  otten,.        (
-000189a0: 2265 7272 6564 222c 2022 7265 6c65 6173  "erred", "releas
-000189b0: 6564 2229 3a20 7472 616e 7369 7469 6f6e  ed"): transition
-000189c0: 5f65 7272 6564 5f72 656c 6561 7365 642c  _erred_released,
-000189d0: 0a20 2020 2020 2020 2028 226d 656d 6f72  .        ("memor
-000189e0: 7922 2c20 2272 656c 6561 7365 6422 293a  y", "released"):
-000189f0: 2074 7261 6e73 6974 696f 6e5f 6d65 6d6f   transition_memo
-00018a00: 7279 5f72 656c 6561 7365 642c 0a20 2020  ry_released,.   
-00018a10: 2020 2020 2028 2272 656c 6561 7365 6422       ("released"
-00018a20: 2c20 2265 7272 6564 2229 3a20 7472 616e  , "erred"): tran
-00018a30: 7369 7469 6f6e 5f72 656c 6561 7365 645f  sition_released_
-00018a40: 6572 7265 642c 0a20 2020 207d 0a0a 2020  erred,.    }..  
-00018a50: 2020 6465 6620 7374 6f72 7928 7365 6c66    def story(self
-00018a60: 2c20 2a6b 6579 735f 6f72 5f74 6173 6b73  , *keys_or_tasks
-00018a70: 5f6f 725f 7374 696d 756c 693a 2073 7472  _or_stimuli: str
-00018a80: 207c 2054 6173 6b53 7461 7465 2920 2d3e   | TaskState) ->
-00018a90: 206c 6973 745b 5472 616e 7369 7469 6f6e   list[Transition
-00018aa0: 5d3a 0a20 2020 2020 2020 2022 2222 4765  ]:.        """Ge
-00018ab0: 7420 616c 6c20 7472 616e 7369 7469 6f6e  t all transition
-00018ac0: 7320 7468 6174 2074 6f75 6368 206f 6e65  s that touch one
-00018ad0: 206f 6620 7468 6520 696e 7075 7420 6b65   of the input ke
-00018ae0: 7973 206f 7220 7374 696d 756c 7573 5f69  ys or stimulus_i
-00018af0: 6427 7322 2222 0a20 2020 2020 2020 206b  d's""".        k
-00018b00: 6579 735f 6f72 5f73 7469 6d75 6c69 203d  eys_or_stimuli =
-00018b10: 207b 0a20 2020 2020 2020 2020 2020 206b   {.            k
-00018b20: 6579 2e6b 6579 2069 6620 6973 696e 7374  ey.key if isinst
-00018b30: 616e 6365 286b 6579 2c20 5461 736b 5374  ance(key, TaskSt
-00018b40: 6174 6529 2065 6c73 6520 6b65 790a 2020  ate) else key.  
-00018b50: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00018b60: 7920 696e 206b 6579 735f 6f72 5f74 6173  y in keys_or_tas
-00018b70: 6b73 5f6f 725f 7374 696d 756c 690a 2020  ks_or_stimuli.  
-00018b80: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00018b90: 7265 7475 726e 2073 6368 6564 756c 6572  return scheduler
-00018ba0: 5f73 746f 7279 286b 6579 735f 6f72 5f73  _story(keys_or_s
-00018bb0: 7469 6d75 6c69 2c20 7365 6c66 2e74 7261  timuli, self.tra
-00018bc0: 6e73 6974 696f 6e5f 6c6f 6729 0a0a 2020  nsition_log)..  
-00018bd0: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00018be0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018bf0: 0a20 2020 2023 2041 7373 6967 6e69 6e67  .    # Assigning
-00018c00: 2054 6173 6b73 2074 6f20 576f 726b 6572   Tasks to Worker
-00018c10: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+00014da0: 2323 2323 2323 0a20 2020 2020 2020 2023  ######.        #
+00014db0: 2055 7064 6174 6520 5374 6174 6520 496e   Update State In
+00014dc0: 666f 726d 6174 696f 6e20 230a 2020 2020  formation #.    
+00014dd0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
+00014de0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00014df0: 0a20 2020 2020 2020 2069 6620 6e62 7974  .        if nbyt
+00014e00: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
+00014e10: 2020 2020 2020 2020 2020 2020 7473 2e73              ts.s
+00014e20: 6574 5f6e 6279 7465 7328 6e62 7974 6573  et_nbytes(nbytes
+00014e30: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00014e40: 5f65 7869 745f 7072 6f63 6573 7369 6e67  _exit_processing
+00014e50: 5f63 6f6d 6d6f 6e28 7473 290a 0a20 2020  _common(ts)..   
+00014e60: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00014e70: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00014e80: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00014e90: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
+00014ea0: 2020 2020 2020 2073 656c 662e 5f61 6464         self._add
+00014eb0: 5f74 6f5f 6d65 6d6f 7279 280a 2020 2020  _to_memory(.    
+00014ec0: 2020 2020 2020 2020 7473 2c20 7773 2c20          ts, ws, 
+00014ed0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00014ee0: 2063 6c69 656e 745f 6d73 6773 2c20 7479   client_msgs, ty
+00014ef0: 7065 3d74 7970 652c 2074 7970 656e 616d  pe=type, typenam
+00014f00: 653d 7479 7065 6e61 6d65 0a20 2020 2020  e=typename.     
+00014f10: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
+00014f20: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00014f30: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00014f40: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+00014f50: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00014f60: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00014f70: 732e 7761 6974 696e 675f 6f6e 0a0a 2020  s.waiting_on..  
+00014f80: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+00014f90: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+00014fa0: 6965 6e74 5f6d 7367 732c 207b 7d0a 0a20  ient_msgs, {}.. 
+00014fb0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+00014fc0: 6e5f 6d65 6d6f 7279 5f72 656c 6561 7365  n_memory_release
+00014fd0: 6428 0a20 2020 2020 2020 2073 656c 662c  d(.        self,
+00014fe0: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
+00014ff0: 6c75 735f 6964 3a20 7374 722c 202a 2c20  lus_id: str, *, 
+00015000: 7361 6665 3a20 626f 6f6c 203d 2046 616c  safe: bool = Fal
+00015010: 7365 0a20 2020 2029 202d 3e20 5265 6373  se.    ) -> Recs
+00015020: 4d73 6773 3a0a 2020 2020 2020 2020 7473  Msgs:.        ts
+00015030: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+00015040: 795d 0a0a 2020 2020 2020 2020 6966 2073  y]..        if s
+00015050: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00015060: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00015070: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+00015080: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+00015090: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
+000150a0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+000150b0: 2020 2020 2020 2069 6620 7361 6665 3a0a         if safe:.
+000150c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000150d0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+000150e0: 6974 6572 730a 0a20 2020 2020 2020 2069  iters..        i
+000150f0: 6620 7473 2e61 6374 6f72 3a0a 2020 2020  f ts.actor:.    
+00015100: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+00015110: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+00015120: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00015130: 2e61 6374 6f72 732e 6469 7363 6172 6428  .actors.discard(
+00015140: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+00015150: 6966 2074 732e 7768 6f5f 7761 6e74 733a  if ts.who_wants:
+00015160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015170: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+00015180: 616d 6520 3d20 7473 0a20 2020 2020 2020  ame = ts.       
+00015190: 2020 2020 2020 2020 2074 732e 6578 6365           ts.exce
+000151a0: 7074 696f 6e20 3d20 5365 7269 616c 697a  ption = Serializ
+000151b0: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
+000151c0: 2020 2020 2020 2020 2a73 6572 6961 6c69          *seriali
+000151d0: 7a65 2856 616c 7565 4572 726f 7228 2257  ze(ValueError("W
+000151e0: 6f72 6b65 7220 686f 6c64 696e 6720 4163  orker holding Ac
+000151f0: 746f 7220 7761 7320 6c6f 7374 2229 290a  tor was lost")).
+00015200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015210: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015220: 2020 7265 7475 726e 207b 7473 2e6b 6579    return {ts.key
+00015230: 3a20 2265 7272 6564 227d 2c20 7b7d 2c20  : "erred"}, {}, 
+00015240: 7b7d 2020 2320 646f 6e27 7420 7472 7920  {}  # don't try 
+00015250: 746f 2072 6563 7265 6174 650a 0a20 2020  to recreate..   
+00015260: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00015270: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00015280: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00015290: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
+000152a0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+000152b0: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
+000152c0: 2020 2020 2020 2023 2058 5858 2066 6163         # XXX fac
+000152d0: 746f 7220 7468 6973 206f 7574 3f0a 2020  tor this out?.  
+000152e0: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+000152f0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00015300: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
+00015310: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00015320: 226b 6579 7322 3a20 5b6b 6579 5d2c 0a20  "keys": [key],. 
+00015330: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+00015340: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+00015350: 7573 5f69 642c 0a20 2020 2020 2020 207d  us_id,.        }
+00015360: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
+00015370: 696e 2074 732e 7768 6f5f 6861 733a 0a20  in ts.who_has:. 
+00015380: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00015390: 725f 6d73 6773 5b77 732e 6164 6472 6573  r_msgs[ws.addres
+000153a0: 735d 203d 205b 776f 726b 6572 5f6d 7367  s] = [worker_msg
+000153b0: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
+000153c0: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
+000153d0: 6173 2874 7329 0a0a 2020 2020 2020 2020  as(ts)..        
+000153e0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
+000153f0: 6173 6564 220a 0a20 2020 2020 2020 2072  ased"..        r
+00015400: 6570 6f72 745f 6d73 6720 3d20 7b22 6f70  eport_msg = {"op
+00015410: 223a 2022 6c6f 7374 2d64 6174 6122 2c20  ": "lost-data", 
+00015420: 226b 6579 223a 206b 6579 7d0a 2020 2020  "key": key}.    
+00015430: 2020 2020 666f 7220 6373 2069 6e20 7473      for cs in ts
+00015440: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+00015450: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00015460: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
+00015470: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
+00015480: 5d0a 0a20 2020 2020 2020 2069 6620 6e6f  ]..        if no
+00015490: 7420 7473 2e72 756e 5f73 7065 633a 2020  t ts.run_spec:  
+000154a0: 2320 7075 7265 2064 6174 610a 2020 2020  # pure data.    
+000154b0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+000154c0: 6461 7469 6f6e 735b 6b65 795d 203d 2022  dations[key] = "
+000154d0: 666f 7267 6f74 7465 6e22 0a20 2020 2020  forgotten".     
+000154e0: 2020 2065 6c69 6620 7473 2e68 6173 5f6c     elif ts.has_l
+000154f0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+00015500: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00015510: 636f 6d6d 656e 6461 7469 6f6e 735b 6b65  commendations[ke
+00015520: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
+00015530: 0a20 2020 2020 2020 2065 6c69 6620 7473  .        elif ts
+00015540: 2e77 686f 5f77 616e 7473 206f 7220 7473  .who_wants or ts
+00015550: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
+00015560: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00015570: 7469 6f6e 735b 6b65 795d 203d 2022 7761  tions[key] = "wa
+00015580: 6974 696e 6722 0a0a 2020 2020 2020 2020  iting"..        
+00015590: 666f 7220 6474 7320 696e 2074 732e 7761  for dts in ts.wa
+000155a0: 6974 6572 733a 0a20 2020 2020 2020 2020  iters:.         
+000155b0: 2020 2069 6620 6474 732e 7374 6174 6520     if dts.state 
+000155c0: 696e 2028 226e 6f2d 776f 726b 6572 222c  in ("no-worker",
+000155d0: 2022 7072 6f63 6573 7369 6e67 2229 3a0a   "processing"):.
+000155e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000155f0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+00015600: 6474 732e 6b65 795d 203d 2022 7761 6974  dts.key] = "wait
+00015610: 696e 6722 0a20 2020 2020 2020 2020 2020  ing".           
+00015620: 2065 6c69 6620 6474 732e 7374 6174 6520   elif dts.state 
+00015630: 3d3d 2022 7761 6974 696e 6722 3a0a 2020  == "waiting":.  
+00015640: 2020 2020 2020 2020 2020 2020 2020 6474                dt
+00015650: 732e 7761 6974 696e 675f 6f6e 2e61 6464  s.waiting_on.add
+00015660: 2874 7329 0a0a 2020 2020 2020 2020 6966  (ts)..        if
+00015670: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00015680: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00015690: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
+000156a0: 675f 6f6e 0a0a 2020 2020 2020 2020 7265  g_on..        re
+000156b0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+000156c0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+000156d0: 732c 2077 6f72 6b65 725f 6d73 6773 0a0a  s, worker_msgs..
+000156e0: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
+000156f0: 6f6e 5f72 656c 6561 7365 645f 6572 7265  on_released_erre
+00015700: 6428 7365 6c66 2c20 6b65 793a 2073 7472  d(self, key: str
+00015710: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00015720: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00015730: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00015740: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+00015750: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00015760: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00015770: 0a20 2020 2020 2020 2063 6c69 656e 745f  .        client_
+00015780: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+00015790: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000157a0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+000157b0: 2020 2020 2020 2077 6974 6820 6c6f 675f         with log_
+000157c0: 6572 726f 7273 2870 6462 3d4c 4f47 5f50  errors(pdb=LOG_P
+000157d0: 4442 293a 0a20 2020 2020 2020 2020 2020  DB):.           
+000157e0: 2020 2020 2061 7373 6572 7420 7473 2e65       assert ts.e
+000157f0: 7863 6570 7469 6f6e 5f62 6c61 6d65 0a20  xception_blame. 
+00015800: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015810: 7373 6572 7420 6e6f 7420 7473 2e77 686f  ssert not ts.who
+00015820: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+00015830: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00015840: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
+00015850: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00015860: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00015870: 6572 730a 0a20 2020 2020 2020 2066 6169  ers..        fai
+00015880: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
+00015890: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+000158a0: 2020 2020 2061 7373 6572 7420 6661 696c       assert fail
+000158b0: 696e 675f 7473 0a0a 2020 2020 2020 2020  ing_ts..        
+000158c0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+000158d0: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+000158e0: 2020 2020 2020 6474 732e 6578 6365 7074        dts.except
+000158f0: 696f 6e5f 626c 616d 6520 3d20 6661 696c  ion_blame = fail
+00015900: 696e 675f 7473 0a20 2020 2020 2020 2020  ing_ts.         
+00015910: 2020 2069 6620 6e6f 7420 6474 732e 7768     if not dts.wh
+00015920: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+00015930: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00015940: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
+00015950: 3d20 2265 7272 6564 220a 0a20 2020 2020  = "erred"..     
+00015960: 2020 2072 6570 6f72 745f 6d73 6720 3d20     report_msg = 
+00015970: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
+00015980: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
+00015990: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
+000159a0: 6579 223a 206b 6579 2c0a 2020 2020 2020  ey": key,.      
+000159b0: 2020 2020 2020 2265 7863 6570 7469 6f6e        "exception
+000159c0: 223a 2066 6169 6c69 6e67 5f74 732e 6578  ": failing_ts.ex
+000159d0: 6365 7074 696f 6e2c 0a20 2020 2020 2020  ception,.       
+000159e0: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
+000159f0: 3a20 6661 696c 696e 675f 7473 2e74 7261  : failing_ts.tra
+00015a00: 6365 6261 636b 2c0a 2020 2020 2020 2020  ceback,.        
+00015a10: 7d0a 2020 2020 2020 2020 666f 7220 6373  }.        for cs
+00015a20: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
+00015a30: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00015a40: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
+00015a50: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
+00015a60: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
+00015a70: 2074 732e 7374 6174 6520 3d20 2265 7272   ts.state = "err
+00015a80: 6564 220a 0a20 2020 2020 2020 2023 2054  ed"..        # T
+00015a90: 4f44 4f3a 2077 6169 7469 6e67 2064 6174  ODO: waiting dat
+00015aa0: 613f 0a20 2020 2020 2020 2072 6574 7572  a?.        retur
+00015ab0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00015ac0: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00015ad0: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
+00015ae0: 7369 7469 6f6e 5f65 7272 6564 5f72 656c  sition_erred_rel
+00015af0: 6561 7365 6428 7365 6c66 2c20 6b65 793a  eased(self, key:
+00015b00: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00015b10: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00015b20: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00015b30: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00015b40: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
+00015b50: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+00015b60: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
+00015b70: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
+00015b80: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+00015b90: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+00015ba0: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
+00015bb0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00015bc0: 2020 2020 2020 2020 2020 7769 7468 206c            with l
+00015bd0: 6f67 5f65 7272 6f72 7328 7064 623d 4c4f  og_errors(pdb=LO
+00015be0: 475f 5044 4229 3a0a 2020 2020 2020 2020  G_PDB):.        
+00015bf0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00015c00: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00015c10: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00015c20: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00015c30: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+00015c40: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00015c50: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
+00015c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c70: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00015c80: 6169 7465 7273 0a0a 2020 2020 2020 2020  aiters..        
+00015c90: 7473 2e65 7863 6570 7469 6f6e 203d 204e  ts.exception = N
+00015ca0: 6f6e 650a 2020 2020 2020 2020 7473 2e65  one.        ts.e
+00015cb0: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
+00015cc0: 204e 6f6e 650a 2020 2020 2020 2020 7473   None.        ts
+00015cd0: 2e74 7261 6365 6261 636b 203d 204e 6f6e  .traceback = Non
+00015ce0: 650a 0a20 2020 2020 2020 2066 6f72 2064  e..        for d
+00015cf0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00015d00: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+00015d10: 2069 6620 6474 732e 7374 6174 6520 3d3d   if dts.state ==
+00015d20: 2022 6572 7265 6422 3a0a 2020 2020 2020   "erred":.      
+00015d30: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+00015d40: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
+00015d50: 795d 203d 2022 7761 6974 696e 6722 0a0a  y] = "waiting"..
+00015d60: 2020 2020 2020 2020 775f 6d73 6720 3d20          w_msg = 
+00015d70: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
+00015d80: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
+00015d90: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
+00015da0: 7973 223a 205b 6b65 795d 2c0a 2020 2020  ys": [key],.    
+00015db0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+00015dc0: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+00015dd0: 6964 2c0a 2020 2020 2020 2020 7d0a 2020  id,.        }.  
+00015de0: 2020 2020 2020 666f 7220 7773 5f61 6464        for ws_add
+00015df0: 7220 696e 2074 732e 6572 7265 645f 6f6e  r in ts.erred_on
+00015e00: 3a0a 2020 2020 2020 2020 2020 2020 776f  :.            wo
+00015e10: 726b 6572 5f6d 7367 735b 7773 5f61 6464  rker_msgs[ws_add
+00015e20: 725d 203d 205b 775f 6d73 675d 0a20 2020  r] = [w_msg].   
+00015e30: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
+00015e40: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
+00015e50: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
+00015e60: 226f 7022 3a20 2274 6173 6b2d 7265 7472  "op": "task-retr
+00015e70: 6965 6422 2c20 226b 6579 223a 206b 6579  ied", "key": key
+00015e80: 7d0a 2020 2020 2020 2020 666f 7220 6373  }.        for cs
+00015e90: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
+00015ea0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
+00015eb0: 6965 6e74 5f6d 7367 735b 6373 2e63 6c69  ient_msgs[cs.cli
+00015ec0: 656e 745f 6b65 795d 203d 205b 7265 706f  ent_key] = [repo
+00015ed0: 7274 5f6d 7367 5d0a 0a20 2020 2020 2020  rt_msg]..       
+00015ee0: 2074 732e 7374 6174 6520 3d20 2272 656c   ts.state = "rel
+00015ef0: 6561 7365 6422 0a0a 2020 2020 2020 2020  eased"..        
+00015f00: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00015f10: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00015f20: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+00015f30: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00015f40: 7469 6f6e 5f77 6169 7469 6e67 5f72 656c  tion_waiting_rel
+00015f50: 6561 7365 6428 7365 6c66 2c20 6b65 793a  eased(self, key:
+00015f60: 2073 7472 2c20 7374 696d 756c 7573 5f69   str, stimulus_i
+00015f70: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00015f80: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00015f90: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00015fa0: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
+00015fb0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+00015fc0: 3d20 7b7d 0a0a 2020 2020 2020 2020 6966  = {}..        if
+00015fd0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00015fe0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00015ff0: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+00016000: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00016010: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00016020: 6573 7369 6e67 5f6f 6e0a 0a20 2020 2020  essing_on..     
+00016030: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00016040: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+00016050: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
+00016060: 2069 6e20 6474 732e 7761 6974 6572 733a   in dts.waiters:
+00016070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016080: 2064 7473 2e77 6169 7465 7273 2e64 6973   dts.waiters.dis
+00016090: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+000160a0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+000160b0: 6474 732e 7761 6974 6572 7320 616e 6420  dts.waiters and 
+000160c0: 6e6f 7420 6474 732e 7768 6f5f 7761 6e74  not dts.who_want
+000160d0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000160e0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+000160f0: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
+00016100: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+00016110: 2020 2020 2074 732e 7761 6974 696e 675f       ts.waiting_
+00016120: 6f6e 2e63 6c65 6172 2829 0a0a 2020 2020  on.clear()..    
+00016130: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
+00016140: 7265 6c65 6173 6564 220a 0a20 2020 2020  released"..     
+00016150: 2020 2069 6620 7473 2e68 6173 5f6c 6f73     if ts.has_los
+00016160: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
+00016170: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00016180: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+00016190: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
+000161a0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+000161b0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+000161c0: 6d65 2061 6e64 2028 7473 2e77 686f 5f77  me and (ts.who_w
+000161d0: 616e 7473 206f 7220 7473 2e77 6169 7465  ants or ts.waite
+000161e0: 7273 293a 0a20 2020 2020 2020 2020 2020  rs):.           
+000161f0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00016200: 5b6b 6579 5d20 3d20 2277 6169 7469 6e67  [key] = "waiting
+00016210: 220a 2020 2020 2020 2020 656c 7365 3a0a  ".        else:.
+00016220: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+00016230: 6169 7465 7273 2e63 6c65 6172 2829 0a0a  aiters.clear()..
+00016240: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00016250: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00016260: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+00016270: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00016280: 7373 696e 675f 7265 6c65 6173 6564 2873  ssing_released(s
+00016290: 656c 662c 206b 6579 3a20 7374 722c 2073  elf, key: str, s
+000162a0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
+000162b0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+000162c0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+000162d0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+000162e0: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+000162f0: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
+00016300: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00016310: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
+00016320: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+00016330: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00016340: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+00016350: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00016360: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00016370: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+00016380: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00016390: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+000163a0: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
+000163b0: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
+000163c0: 3d20 2270 726f 6365 7373 696e 6722 0a0a  = "processing"..
+000163d0: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+000163e0: 662e 5f65 7869 745f 7072 6f63 6573 7369  f._exit_processi
+000163f0: 6e67 5f63 6f6d 6d6f 6e28 7473 290a 2020  ng_common(ts).  
+00016400: 2020 2020 2020 6966 2077 733a 0a20 2020        if ws:.   
+00016410: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
+00016420: 6d73 6773 5b77 732e 6164 6472 6573 735d  msgs[ws.address]
+00016430: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00016440: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+00016450: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
+00016460: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
+00016470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016480: 2020 226b 6579 7322 3a20 5b6b 6579 5d2c    "keys": [key],
+00016490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000164a0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+000164b0: 6422 3a20 7374 696d 756c 7573 5f69 642c  d": stimulus_id,
+000164c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000164d0: 207d 0a20 2020 2020 2020 2020 2020 205d   }.            ]
+000164e0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+000164f0: 7072 6f70 6167 6174 655f 7265 6c65 6173  propagate_releas
+00016500: 6564 2874 732c 2072 6563 6f6d 6d65 6e64  ed(ts, recommend
+00016510: 6174 696f 6e73 290a 2020 2020 2020 2020  ations).        
+00016520: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00016530: 6174 696f 6e73 2c20 7b7d 2c20 776f 726b  ations, {}, work
+00016540: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
+00016550: 2074 7261 6e73 6974 696f 6e5f 7072 6f63   transition_proc
+00016560: 6573 7369 6e67 5f65 7272 6564 280a 2020  essing_erred(.  
+00016570: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00016580: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
+00016590: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+000165a0: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+000165b0: 2a2c 0a20 2020 2020 2020 2077 6f72 6b65  *,.        worke
+000165c0: 723a 2073 7472 2c0a 2020 2020 2020 2020  r: str,.        
+000165d0: 6361 7573 653a 2073 7472 207c 204e 6f6e  cause: str | Non
+000165e0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000165f0: 2020 6578 6365 7074 696f 6e3a 2053 6572    exception: Ser
+00016600: 6961 6c69 7a65 6420 7c20 4e6f 6e65 203d  ialized | None =
+00016610: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
+00016620: 7261 6365 6261 636b 3a20 5365 7269 616c  raceback: Serial
+00016630: 697a 6564 207c 204e 6f6e 6520 3d20 4e6f  ized | None = No
+00016640: 6e65 2c0a 2020 2020 2020 2020 6578 6365  ne,.        exce
+00016650: 7074 696f 6e5f 7465 7874 3a20 7374 7220  ption_text: str 
+00016660: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00016670: 2020 2020 2020 2074 7261 6365 6261 636b         traceback
+00016680: 5f74 6578 743a 2073 7472 207c 204e 6f6e  _text: str | Non
+00016690: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000166a0: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+000166b0: 0a20 2020 2029 202d 3e20 5265 6373 4d73  .    ) -> RecsMs
+000166c0: 6773 3a0a 2020 2020 2020 2020 2222 2250  gs:.        """P
+000166d0: 726f 6365 7373 6564 2061 2072 6563 6f6d  rocessed a recom
+000166e0: 6d65 6e64 6564 2074 7261 6e73 6974 696f  mended transitio
+000166f0: 6e20 7072 6f63 6573 7369 6e67 202d 3e20  n processing -> 
+00016700: 6572 7265 642e 0a0a 2020 2020 2020 2020  erred...        
+00016710: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+00016720: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00016730: 2020 2020 2020 6b65 790a 2020 2020 2020        key.      
+00016740: 2020 2020 204b 6579 206f 6620 7468 6520       Key of the 
+00016750: 7461 736b 2074 6f20 7472 616e 7369 7469  task to transiti
+00016760: 6f6e 0a20 2020 2020 2020 2073 7469 6d75  on.        stimu
+00016770: 6c75 735f 6964 0a20 2020 2020 2020 2020  lus_id.         
+00016780: 2020 2049 4420 6f66 2074 6865 2073 7469     ID of the sti
+00016790: 6d75 6c75 7320 6361 7573 696e 6720 7468  mulus causing th
+000167a0: 6520 7472 616e 7369 7469 6f6e 0a20 2020  e transition.   
+000167b0: 2020 2020 2077 6f72 6b65 720a 2020 2020       worker.    
+000167c0: 2020 2020 2020 2020 4164 6472 6573 7320          Address 
+000167d0: 6f66 2074 6865 2077 6f72 6b65 7220 7768  of the worker wh
+000167e0: 6572 6520 7468 6520 7461 736b 2065 7272  ere the task err
+000167f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00016800: 4e6f 7420 6e65 6365 7373 6172 696c 7920  Not necessarily 
+00016810: 6060 7473 2e70 726f 6365 7373 696e 675f  ``ts.processing_
+00016820: 6f6e 6060 2e0a 2020 2020 2020 2020 6361  on``..        ca
+00016830: 7573 650a 2020 2020 2020 2020 2020 2020  use.            
+00016840: 4164 6472 6573 7320 6f66 2074 6865 2074  Address of the t
+00016850: 6173 6b20 7468 6174 2063 6175 7365 6420  ask that caused 
+00016860: 7468 6973 2074 6173 6b20 746f 2062 6520  this task to be 
+00016870: 7472 616e 7369 7469 6f6e 6564 2074 6f20  transitioned to 
+00016880: 6572 7265 640a 2020 2020 2020 2020 6578  erred.        ex
+00016890: 6365 7074 696f 6e0a 2020 2020 2020 2020  ception.        
+000168a0: 2020 2020 4578 6365 7074 696f 6e20 6361      Exception ca
+000168b0: 7573 6564 2062 7920 7468 6520 7461 736b  used by the task
+000168c0: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
+000168d0: 636b 0a20 2020 2020 2020 2020 2020 2054  ck.            T
+000168e0: 7261 6365 6261 636b 2063 6175 7365 6420  raceback caused 
+000168f0: 6279 2074 6865 2074 6173 6b0a 2020 2020  by the task.    
+00016900: 2020 2020 6578 6365 7074 696f 6e5f 7465      exception_te
+00016910: 7874 0a20 2020 2020 2020 2020 2020 2053  xt.            S
+00016920: 7472 696e 6720 7265 7072 6573 656e 7461  tring representa
+00016930: 7469 6f6e 206f 6620 7468 6520 6578 6365  tion of the exce
+00016940: 7074 696f 6e0a 2020 2020 2020 2020 7472  ption.        tr
+00016950: 6163 6562 6163 6b5f 7465 7874 0a20 2020  aceback_text.   
+00016960: 2020 2020 2020 2020 2053 7472 696e 6720           String 
+00016970: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+00016980: 6620 7468 6520 7472 6163 6562 6163 6b0a  f the traceback.
+00016990: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+000169a0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000169b0: 0a20 2020 2020 2020 2052 6563 6f6d 6d65  .        Recomme
+000169c0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+000169d0: 206d 6573 7361 6765 7320 616e 6420 776f   messages and wo
+000169e0: 726b 6572 206d 6573 7361 6765 7320 746f  rker messages to
+000169f0: 2070 726f 6365 7373 0a20 2020 2020 2020   process.       
+00016a00: 2022 2222 0a20 2020 2020 2020 2074 7320   """.        ts 
+00016a10: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00016a20: 5d0a 2020 2020 2020 2020 7265 636f 6d6d  ].        recomm
+00016a30: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+00016a40: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
+00016a50: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
+00016a60: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
+00016a70: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00016a80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00016a90: 7420 6361 7573 6520 6f72 2074 732e 6578  t cause or ts.ex
+00016aa0: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
+00016ab0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00016ac0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00016ad0: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00016ae0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+00016af0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+00016b00: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+00016b10: 6974 696e 675f 6f6e 0a0a 2020 2020 2020  iting_on..      
+00016b20: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
+00016b30: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
+00016b40: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00016b50: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00016b60: 6572 7420 7773 0a20 2020 2020 2020 2020  ert ws.         
+00016b70: 2020 2077 732e 6163 746f 7273 2e72 656d     ws.actors.rem
+00016b80: 6f76 6528 7473 290a 0a20 2020 2020 2020  ove(ts)..       
+00016b90: 2073 656c 662e 5f65 7869 745f 7072 6f63   self._exit_proc
+00016ba0: 6573 7369 6e67 5f63 6f6d 6d6f 6e28 7473  essing_common(ts
+00016bb0: 290a 0a20 2020 2020 2020 2074 732e 6572  )..        ts.er
+00016bc0: 7265 645f 6f6e 2e61 6464 2877 6f72 6b65  red_on.add(worke
+00016bd0: 7229 0a20 2020 2020 2020 2069 6620 6578  r).        if ex
+00016be0: 6365 7074 696f 6e20 6973 206e 6f74 204e  ception is not N
+00016bf0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00016c00: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
+00016c10: 6578 6365 7074 696f 6e0a 2020 2020 2020  exception.      
+00016c20: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
+00016c30: 6f6e 5f74 6578 7420 3d20 6578 6365 7074  on_text = except
+00016c40: 696f 6e5f 7465 7874 2020 2320 7479 7065  ion_text  # type
+00016c50: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00016c60: 2069 6620 7472 6163 6562 6163 6b20 6973   if traceback is
+00016c70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00016c80: 2020 2020 2020 2074 732e 7472 6163 6562         ts.traceb
+00016c90: 6163 6b20 3d20 7472 6163 6562 6163 6b0a  ack = traceback.
+00016ca0: 2020 2020 2020 2020 2020 2020 7473 2e74              ts.t
+00016cb0: 7261 6365 6261 636b 5f74 6578 7420 3d20  raceback_text = 
+00016cc0: 7472 6163 6562 6163 6b5f 7465 7874 2020  traceback_text  
+00016cd0: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
+00016ce0: 2020 2020 2020 2069 6620 6361 7573 6520         if cause 
+00016cf0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00016d00: 2020 2020 2020 2020 2066 6169 6c69 6e67           failing
+00016d10: 5f74 7320 3d20 7365 6c66 2e74 6173 6b73  _ts = self.tasks
+00016d20: 5b63 6175 7365 5d0a 2020 2020 2020 2020  [cause].        
+00016d30: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
+00016d40: 5f62 6c61 6d65 203d 2066 6169 6c69 6e67  _blame = failing
+00016d50: 5f74 730a 2020 2020 2020 2020 656c 7365  _ts.        else
+00016d60: 3a0a 2020 2020 2020 2020 2020 2020 6661  :.            fa
+00016d70: 696c 696e 675f 7473 203d 2074 732e 6578  iling_ts = ts.ex
+00016d80: 6365 7074 696f 6e5f 626c 616d 6520 2023  ception_blame  #
+00016d90: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
+00016da0: 2020 2020 2020 2073 656c 662e 6572 7265         self.erre
+00016db0: 645f 7461 736b 732e 6170 7065 6e64 6c65  d_tasks.appendle
+00016dc0: 6674 280a 2020 2020 2020 2020 2020 2020  ft(.            
+00016dd0: 4572 7265 6454 6173 6b28 0a20 2020 2020  ErredTask(.     
+00016de0: 2020 2020 2020 2020 2020 2074 732e 6b65             ts.ke
+00016df0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00016e00: 2020 2074 696d 6528 292c 0a20 2020 2020     time(),.     
+00016e10: 2020 2020 2020 2020 2020 2074 732e 6572             ts.er
+00016e20: 7265 645f 6f6e 2e63 6f70 7928 292c 0a20  red_on.copy(),. 
+00016e30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00016e40: 7863 6570 7469 6f6e 5f74 6578 7420 6f72  xception_text or
+00016e50: 2022 222c 0a20 2020 2020 2020 2020 2020   "",.           
+00016e60: 2020 2020 2074 7261 6365 6261 636b 5f74       traceback_t
+00016e70: 6578 7420 6f72 2022 222c 0a20 2020 2020  ext or "",.     
+00016e80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00016e90: 2029 0a0a 2020 2020 2020 2020 666f 7220   )..        for 
+00016ea0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+00016eb0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+00016ec0: 2020 6474 732e 6578 6365 7074 696f 6e5f    dts.exception_
+00016ed0: 626c 616d 6520 3d20 6661 696c 696e 675f  blame = failing_
+00016ee0: 7473 0a20 2020 2020 2020 2020 2020 2072  ts.            r
+00016ef0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+00016f00: 7473 2e6b 6579 5d20 3d20 2265 7272 6564  ts.key] = "erred
+00016f10: 220a 0a20 2020 2020 2020 2066 6f72 2064  "..        for d
+00016f20: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+00016f30: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+00016f40: 2020 2064 7473 2e77 6169 7465 7273 2e64     dts.waiters.d
+00016f50: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
+00016f60: 2020 2020 2020 2069 6620 6e6f 7420 6474         if not dt
+00016f70: 732e 7761 6974 6572 7320 616e 6420 6e6f  s.waiters and no
+00016f80: 7420 6474 732e 7768 6f5f 7761 6e74 733a  t dts.who_wants:
+00016f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016fa0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00016fb0: 5b64 7473 2e6b 6579 5d20 3d20 2272 656c  [dts.key] = "rel
+00016fc0: 6561 7365 6422 0a0a 2020 2020 2020 2020  eased"..        
+00016fd0: 7473 2e77 6169 7465 7273 2e63 6c65 6172  ts.waiters.clear
+00016fe0: 2829 2020 2320 646f 2061 6e79 7468 696e  ()  # do anythin
+00016ff0: 6720 7769 7468 2074 6869 733f 0a0a 2020  g with this?..  
+00017000: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
+00017010: 2022 6572 7265 6422 0a0a 2020 2020 2020   "erred"..      
+00017020: 2020 7265 706f 7274 5f6d 7367 203d 207b    report_msg = {
+00017030: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
+00017040: 223a 2022 7461 736b 2d65 7272 6564 222c  ": "task-erred",
+00017050: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
+00017060: 7922 3a20 6b65 792c 0a20 2020 2020 2020  y": key,.       
+00017070: 2020 2020 2022 6578 6365 7074 696f 6e22       "exception"
+00017080: 3a20 6661 696c 696e 675f 7473 2e65 7863  : failing_ts.exc
+00017090: 6570 7469 6f6e 2c0a 2020 2020 2020 2020  eption,.        
+000170a0: 2020 2020 2274 7261 6365 6261 636b 223a      "traceback":
+000170b0: 2066 6169 6c69 6e67 5f74 732e 7472 6163   failing_ts.trac
+000170c0: 6562 6163 6b2c 0a20 2020 2020 2020 207d  eback,.        }
+000170d0: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+000170e0: 696e 2074 732e 7768 6f5f 7761 6e74 733a  in ts.who_wants:
+000170f0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
+00017100: 656e 745f 6d73 6773 5b63 732e 636c 6965  ent_msgs[cs.clie
+00017110: 6e74 5f6b 6579 5d20 3d20 5b72 6570 6f72  nt_key] = [repor
+00017120: 745f 6d73 675d 0a0a 2020 2020 2020 2020  t_msg]..        
+00017130: 6373 203d 2073 656c 662e 636c 6965 6e74  cs = self.client
+00017140: 735b 2266 6972 652d 616e 642d 666f 7267  s["fire-and-forg
+00017150: 6574 225d 0a20 2020 2020 2020 2069 6620  et"].        if 
+00017160: 7473 2069 6e20 6373 2e77 616e 7473 5f77  ts in cs.wants_w
+00017170: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
+00017180: 2073 656c 662e 5f63 6c69 656e 745f 7265   self._client_re
+00017190: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
+000171a0: 2020 2020 2020 2020 2020 2020 2063 733d               cs=
+000171b0: 6373 2c0a 2020 2020 2020 2020 2020 2020  cs,.            
+000171c0: 2020 2020 6b65 7973 3d5b 6b65 795d 2c0a      keys=[key],.
+000171d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000171e0: 7265 636f 6d6d 656e 6461 7469 6f6e 733d  recommendations=
+000171f0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00017200: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00017210: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017220: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00017230: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00017240: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00017250: 6e0a 0a20 2020 2020 2020 2072 6574 7572  n..        retur
+00017260: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00017270: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00017280: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
+00017290: 7369 7469 6f6e 5f6e 6f5f 776f 726b 6572  sition_no_worker
+000172a0: 5f72 656c 6561 7365 6428 7365 6c66 2c20  _released(self, 
+000172b0: 6b65 793a 2073 7472 2c20 7374 696d 756c  key: str, stimul
+000172c0: 7573 5f69 643a 2073 7472 2920 2d3e 2052  us_id: str) -> R
+000172d0: 6563 734d 7367 733a 0a20 2020 2020 2020  ecsMsgs:.       
+000172e0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+000172f0: 5b6b 6579 5d0a 0a20 2020 2020 2020 2069  [key]..        i
+00017300: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00017310: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017320: 6572 7420 7365 6c66 2e74 6173 6b73 5b6b  ert self.tasks[k
+00017330: 6579 5d2e 7374 6174 6520 3d3d 2022 6e6f  ey].state == "no
+00017340: 2d77 6f72 6b65 7222 0a20 2020 2020 2020  -worker".       
+00017350: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00017360: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+00017370: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00017380: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
+00017390: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+000173a0: 7275 6e6e 6162 6c65 2e72 656d 6f76 6528  runnable.remove(
+000173b0: 7473 290a 2020 2020 2020 2020 7473 2e73  ts).        ts.s
+000173c0: 7461 7465 203d 2022 7265 6c65 6173 6564  tate = "released
+000173d0: 220a 0a20 2020 2020 2020 2066 6f72 2064  "..        for d
+000173e0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+000173f0: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
+00017400: 2020 2064 7473 2e77 6169 7465 7273 2e64     dts.waiters.d
+00017410: 6973 6361 7264 2874 7329 0a0a 2020 2020  iscard(ts)..    
+00017420: 2020 2020 7473 2e77 6169 7465 7273 2e63      ts.waiters.c
+00017430: 6c65 6172 2829 0a0a 2020 2020 2020 2020  lear()..        
+00017440: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
+00017450: 7d0a 0a20 2020 2064 6566 2074 7261 6e73  }..    def trans
+00017460: 6974 696f 6e5f 7761 6974 696e 675f 7175  ition_waiting_qu
+00017470: 6575 6564 2873 656c 662c 206b 6579 3a20  eued(self, key: 
+00017480: 7374 722c 2073 7469 6d75 6c75 735f 6964  str, stimulus_id
+00017490: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
+000174a0: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
+000174b0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+000174c0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000174d0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000174e0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+000174f0: 6f74 2073 656c 662e 6964 6c65 5f74 6173  ot self.idle_tas
+00017500: 6b5f 636f 756e 742c 2028 7473 2c20 7365  k_count, (ts, se
+00017510: 6c66 2e69 646c 655f 7461 736b 5f63 6f75  lf.idle_task_cou
+00017520: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00017530: 7365 6c66 2e5f 7661 6c69 6461 7465 5f72  self._validate_r
+00017540: 6561 6479 2874 7329 0a0a 2020 2020 2020  eady(ts)..      
+00017550: 2020 7473 2e73 7461 7465 203d 2022 7175    ts.state = "qu
+00017560: 6575 6564 220a 2020 2020 2020 2020 7365  eued".        se
+00017570: 6c66 2e71 7565 7565 642e 6164 6428 7473  lf.queued.add(ts
+00017580: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00017590: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
+000175a0: 2020 6465 6620 7472 616e 7369 7469 6f6e    def transition
+000175b0: 5f77 6169 7469 6e67 5f6e 6f5f 776f 726b  _waiting_no_work
+000175c0: 6572 2873 656c 662c 206b 6579 3a20 7374  er(self, key: st
+000175d0: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+000175e0: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+000175f0: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00017600: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00017610: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017620: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00017630: 2020 2020 2020 7365 6c66 2e5f 7661 6c69        self._vali
+00017640: 6461 7465 5f72 6561 6479 2874 7329 0a0a  date_ready(ts)..
+00017650: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+00017660: 203d 2022 6e6f 2d77 6f72 6b65 7222 0a20   = "no-worker". 
+00017670: 2020 2020 2020 2073 656c 662e 756e 7275         self.unru
+00017680: 6e6e 6162 6c65 2e61 6464 2874 7329 0a0a  nnable.add(ts)..
+00017690: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000176a0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
+000176b0: 6566 2074 7261 6e73 6974 696f 6e5f 7175  ef transition_qu
+000176c0: 6575 6564 5f72 656c 6561 7365 6428 7365  eued_released(se
+000176d0: 6c66 2c20 6b65 793a 2073 7472 2c20 7374  lf, key: str, st
+000176e0: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
+000176f0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+00017700: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00017710: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
+00017720: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+00017730: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+00017740: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
+00017750: 6c66 2e71 7565 7565 640a 2020 2020 2020  lf.queued.      
+00017760: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00017770: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00017780: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
+00017790: 7175 6575 6564 2e72 656d 6f76 6528 7473  queued.remove(ts
+000177a0: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
+000177b0: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+000177c0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+000177d0: 6c66 2e5f 7072 6f70 6167 6174 655f 7265  lf._propagate_re
+000177e0: 6c65 6173 6564 2874 732c 2072 6563 6f6d  leased(ts, recom
+000177f0: 6d65 6e64 6174 696f 6e73 290a 2020 2020  mendations).    
+00017800: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
+00017810: 6d65 6e64 6174 696f 6e73 2c20 7b7d 2c20  mendations, {}, 
+00017820: 7b7d 0a0a 2020 2020 6465 6620 7472 616e  {}..    def tran
+00017830: 7369 7469 6f6e 5f71 7565 7565 645f 7072  sition_queued_pr
+00017840: 6f63 6573 7369 6e67 2873 656c 662c 206b  ocessing(self, k
+00017850: 6579 3a20 7374 722c 2073 7469 6d75 6c75  ey: str, stimulu
+00017860: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
+00017870: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00017880: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00017890: 6b65 795d 0a20 2020 2020 2020 2072 6563  key].        rec
+000178a0: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
+000178b0: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
+000178c0: 776f 726b 6572 5f6d 7367 733a 204d 7367  worker_msgs: Msg
+000178d0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
+000178e0: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+000178f0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00017900: 7365 7274 206e 6f74 2074 732e 6163 746f  sert not ts.acto
+00017910: 722c 2066 2241 6374 6f72 7320 6361 6e27  r, f"Actors can'
+00017920: 7420 6265 2071 7565 7565 643a 207b 7473  t be queued: {ts
+00017930: 7d22 0a20 2020 2020 2020 2020 2020 2061  }".            a
+00017940: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
+00017950: 2e71 7565 7565 640a 0a20 2020 2020 2020  .queued..       
+00017960: 2069 6620 7773 203a 3d20 7365 6c66 2e64   if ws := self.d
+00017970: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00017980: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
+00017990: 626c 6564 2829 3a0a 2020 2020 2020 2020  bled():.        
+000179a0: 2020 2020 7365 6c66 2e71 7565 7565 642e      self.queued.
+000179b0: 6469 7363 6172 6428 7473 290a 2020 2020  discard(ts).    
+000179c0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+000179d0: 7367 7320 3d20 7365 6c66 2e5f 6164 645f  sgs = self._add_
+000179e0: 746f 5f70 726f 6365 7373 696e 6728 7473  to_processing(ts
+000179f0: 2c20 7773 290a 2020 2020 2020 2020 2320  , ws).        # 
+00017a00: 4966 206e 6f20 776f 726b 6572 2c20 7461  If no worker, ta
+00017a10: 736b 206a 7573 7420 7374 6179 7320 6071  sk just stays `q
+00017a20: 7565 7565 6460 0a0a 2020 2020 2020 2020  ueued`..        
+00017a30: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00017a40: 6174 696f 6e73 2c20 7b7d 2c20 776f 726b  ations, {}, work
+00017a50: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
+00017a60: 205f 7265 6d6f 7665 5f6b 6579 2873 656c   _remove_key(sel
+00017a70: 662c 206b 6579 3a20 7374 7229 202d 3e20  f, key: str) -> 
+00017a80: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+00017a90: 203d 2073 656c 662e 7461 736b 732e 706f   = self.tasks.po
+00017aa0: 7028 6b65 7929 0a20 2020 2020 2020 2061  p(key).        a
+00017ab0: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
+00017ac0: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
+00017ad0: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
+00017ae0: 6e61 626c 652e 6469 7363 6172 6428 7473  nable.discard(ts
+00017af0: 290a 2020 2020 2020 2020 666f 7220 6373  ).        for cs
+00017b00: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
+00017b10: 3a0a 2020 2020 2020 2020 2020 2020 6373  :.            cs
+00017b20: 2e77 616e 7473 5f77 6861 742e 7265 6d6f  .wants_what.remo
+00017b30: 7665 2874 7329 0a20 2020 2020 2020 2074  ve(ts).        t
+00017b40: 732e 7768 6f5f 7761 6e74 732e 636c 6561  s.who_wants.clea
+00017b50: 7228 290a 2020 2020 2020 2020 7473 2e70  r().        ts.p
+00017b60: 726f 6365 7373 696e 675f 6f6e 203d 204e  rocessing_on = N
+00017b70: 6f6e 650a 2020 2020 2020 2020 7473 2e65  one.        ts.e
+00017b80: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
+00017b90: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
+00017ba0: 7473 2e74 7261 6365 6261 636b 203d 204e  ts.traceback = N
+00017bb0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00017bc0: 2e74 6173 6b5f 6d65 7461 6461 7461 2e70  .task_metadata.p
+00017bd0: 6f70 286b 6579 2c20 4e6f 6e65 290a 0a20  op(key, None).. 
+00017be0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+00017bf0: 6e5f 6d65 6d6f 7279 5f66 6f72 676f 7474  n_memory_forgott
+00017c00: 656e 2873 656c 662c 206b 6579 3a20 7374  en(self, key: st
+00017c10: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00017c20: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
+00017c30: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00017c40: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00017c50: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00017c60: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00017c70: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00017c80: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
+00017c90: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+00017ca0: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00017cb0: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+00017cc0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00017cd0: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
+00017ce0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00017cf0: 7420 7473 2e72 756e 5f73 7065 633a 0a20  t ts.run_spec:. 
+00017d00: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017d10: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
+00017d20: 6574 2061 2070 7572 6520 6461 7461 2074  et a pure data t
+00017d30: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+00017d40: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00017d50: 2020 2020 2065 6c69 6620 7473 2e68 6173       elif ts.has
+00017d60: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+00017d70: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00017d80: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
+00017d90: 2066 6f72 6765 7420 6120 7461 736b 2077   forget a task w
+00017da0: 6974 6820 666f 7267 6f74 7465 6e20 6465  ith forgotten de
+00017db0: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
+00017dc0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00017dd0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00017de0: 206e 6f74 2074 732e 7768 6f5f 7761 6e74   not ts.who_want
+00017df0: 7320 616e 6420 6e6f 7420 7473 2e77 6169  s and not ts.wai
+00017e00: 7465 7273 2061 6e64 206e 6f74 2074 732e  ters and not ts.
+00017e10: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00017e20: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00017e30: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
+00017e40: 6120 7461 736b 2074 6861 7420 6e6f 626f  a task that nobo
+00017e50: 6479 206e 6565 6473 0a20 2020 2020 2020  dy needs.       
+00017e60: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00017e70: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00017e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e90: 7261 6973 6520 4173 7365 7274 696f 6e45  raise AssertionE
+00017ea0: 7272 6f72 2822 556e 7265 6163 6861 626c  rror("Unreachabl
+00017eb0: 6522 2c20 7473 2920 2023 2070 7261 676d  e", ts)  # pragm
+00017ec0: 613a 206e 6f63 6f76 6572 0a0a 2020 2020  a: nocover..    
+00017ed0: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
+00017ee0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00017ef0: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
+00017f00: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00017f10: 2020 2077 732e 6163 746f 7273 2e64 6973     ws.actors.dis
+00017f20: 6361 7264 2874 7329 0a0a 2020 2020 2020  card(ts)..      
+00017f30: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00017f40: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
+00017f50: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+00017f60: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
+00017f70: 2020 2020 7365 6c66 2e5f 7072 6f70 6167      self._propag
+00017f80: 6174 655f 666f 7267 6f74 7465 6e28 7473  ate_forgotten(ts
+00017f90: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
+00017fa0: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
+00017fb0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+00017fc0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00017fd0: 7320 3d20 5f74 6173 6b5f 746f 5f63 6c69  s = _task_to_cli
+00017fe0: 656e 745f 6d73 6773 2874 7329 0a20 2020  ent_msgs(ts).   
+00017ff0: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
+00018000: 655f 6b65 7928 6b65 7929 0a0a 2020 2020  e_key(key)..    
+00018010: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
+00018020: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
+00018030: 6e74 5f6d 7367 732c 2077 6f72 6b65 725f  nt_msgs, worker_
+00018040: 6d73 6773 0a0a 2020 2020 6465 6620 7472  msgs..    def tr
+00018050: 616e 7369 7469 6f6e 5f72 656c 6561 7365  ansition_release
+00018060: 645f 666f 7267 6f74 7465 6e28 7365 6c66  d_forgotten(self
+00018070: 2c20 6b65 793a 2073 7472 2c20 7374 696d  , key: str, stim
+00018080: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+00018090: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+000180a0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000180b0: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+000180c0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+000180d0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+000180e0: 7373 6572 7420 7473 2e73 7461 7465 2069  ssert ts.state i
+000180f0: 6e20 2822 7265 6c65 6173 6564 222c 2022  n ("released", "
+00018100: 6572 7265 6422 290a 2020 2020 2020 2020  erred").        
+00018110: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00018120: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00018130: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00018140: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00018150: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00018160: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+00018170: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+00018180: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00018190: 7420 7473 2e77 6169 7469 6e67 5f6f 6e2c  t ts.waiting_on,
+000181a0: 2028 7473 2c20 7473 2e77 6169 7469 6e67   (ts, ts.waiting
+000181b0: 5f6f 6e29 0a20 2020 2020 2020 2020 2020  _on).           
+000181c0: 2069 6620 6e6f 7420 7473 2e72 756e 5f73   if not ts.run_s
+000181d0: 7065 633a 0a20 2020 2020 2020 2020 2020  pec:.           
+000181e0: 2020 2020 2023 2049 7427 7320 6f6b 2074       # It's ok t
+000181f0: 6f20 666f 7267 6574 2061 2070 7572 6520  o forget a pure 
+00018200: 6461 7461 2074 6173 6b0a 2020 2020 2020  data task.      
+00018210: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00018220: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00018230: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
+00018240: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+00018250: 2020 2020 2020 2020 2020 2320 4974 2773            # It's
+00018260: 206f 6b20 746f 2066 6f72 6765 7420 6120   ok to forget a 
+00018270: 7461 736b 2077 6974 6820 666f 7267 6f74  task with forgot
+00018280: 7465 6e20 6465 7065 6e64 656e 6369 6573  ten dependencies
+00018290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000182a0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
+000182b0: 2020 656c 6966 206e 6f74 2074 732e 7768    elif not ts.wh
+000182c0: 6f5f 7761 6e74 7320 616e 6420 6e6f 7420  o_wants and not 
+000182d0: 7473 2e77 6169 7465 7273 2061 6e64 206e  ts.waiters and n
+000182e0: 6f74 2074 732e 6465 7065 6e64 656e 7473  ot ts.dependents
+000182f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018300: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
+00018310: 6f72 6765 7420 6120 7461 736b 2074 6861  orget a task tha
+00018320: 7420 6e6f 626f 6479 206e 6565 6473 0a20  t nobody needs. 
+00018330: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00018340: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00018350: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00018360: 2020 2020 2020 7261 6973 6520 4173 7365        raise Asse
+00018370: 7274 696f 6e45 7272 6f72 2822 556e 7265  rtionError("Unre
+00018380: 6163 6861 626c 6522 2c20 7374 7228 7473  achable", str(ts
+00018390: 2929 2020 2320 7072 6167 6d61 3a20 6e6f  ))  # pragma: no
+000183a0: 636f 7665 720a 0a20 2020 2020 2020 2072  cover..        r
+000183b0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+000183c0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+000183d0: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
+000183e0: 7367 7320 3d20 7b7d 0a20 2020 2020 2020  sgs = {}.       
+000183f0: 2073 656c 662e 5f70 726f 7061 6761 7465   self._propagate
+00018400: 5f66 6f72 676f 7474 656e 2874 732c 2072  _forgotten(ts, r
+00018410: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+00018420: 776f 726b 6572 5f6d 7367 732c 2073 7469  worker_msgs, sti
+00018430: 6d75 6c75 735f 6964 290a 0a20 2020 2020  mulus_id)..     
+00018440: 2020 2063 6c69 656e 745f 6d73 6773 203d     client_msgs =
+00018450: 205f 7461 736b 5f74 6f5f 636c 6965 6e74   _task_to_client
+00018460: 5f6d 7367 7328 7473 290a 2020 2020 2020  _msgs(ts).      
+00018470: 2020 7365 6c66 2e5f 7265 6d6f 7665 5f6b    self._remove_k
+00018480: 6579 286b 6579 290a 0a20 2020 2020 2020  ey(key)..       
+00018490: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
+000184a0: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+000184b0: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+000184c0: 730a 0a20 2020 2023 207b 0a20 2020 2023  s..    # {.    #
+000184d0: 2020 2020 2028 7374 6172 742c 2066 696e       (start, fin
+000184e0: 6973 6829 3a0a 2020 2020 2320 2020 2020  ish):.    #     
+000184f0: 7472 616e 7369 7469 6f6e 5f3c 7374 6172  transition_<star
+00018500: 743e 5f3c 6669 6e69 7368 3e28 0a20 2020  t>_<finish>(.   
+00018510: 2023 2020 2020 2020 2020 2073 656c 662c   #         self,
+00018520: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
+00018530: 6c75 735f 6964 3a20 7374 722c 202a 2a6b  lus_id: str, **k
+00018540: 7761 7267 730a 2020 2020 2320 2020 2020  wargs.    #     
+00018550: 2920 2d3e 2028 7265 636f 6d6d 656e 6461  ) -> (recommenda
+00018560: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
+00018570: 6773 2c20 776f 726b 6572 5f6d 7367 7329  gs, worker_msgs)
+00018580: 0a20 2020 2023 207d 0a20 2020 205f 5452  .    # }.    _TR
+00018590: 414e 5349 5449 4f4e 535f 5441 424c 453a  ANSITIONS_TABLE:
+000185a0: 2043 6c61 7373 5661 725b 0a20 2020 2020   ClassVar[.     
+000185b0: 2020 204d 6170 7069 6e67 5b0a 2020 2020     Mapping[.    
+000185c0: 2020 2020 2020 2020 7475 706c 655b 5461          tuple[Ta
+000185d0: 736b 5374 6174 6553 7461 7465 2c20 5461  skStateState, Ta
+000185e0: 736b 5374 6174 6553 7461 7465 5d2c 0a20  skStateState],. 
+000185f0: 2020 2020 2020 2020 2020 2043 616c 6c61             Calla
+00018600: 626c 655b 2e2e 2e2c 2052 6563 734d 7367  ble[..., RecsMsg
+00018610: 735d 2c0a 2020 2020 2020 2020 5d0a 2020  s],.        ].  
+00018620: 2020 5d20 3d20 7b0a 2020 2020 2020 2020    ] = {.        
+00018630: 2822 7265 6c65 6173 6564 222c 2022 7761  ("released", "wa
+00018640: 6974 696e 6722 293a 2074 7261 6e73 6974  iting"): transit
+00018650: 696f 6e5f 7265 6c65 6173 6564 5f77 6169  ion_released_wai
+00018660: 7469 6e67 2c0a 2020 2020 2020 2020 2822  ting,.        ("
+00018670: 7761 6974 696e 6722 2c20 2272 656c 6561  waiting", "relea
+00018680: 7365 6422 293a 2074 7261 6e73 6974 696f  sed"): transitio
+00018690: 6e5f 7761 6974 696e 675f 7265 6c65 6173  n_waiting_releas
+000186a0: 6564 2c0a 2020 2020 2020 2020 2822 7761  ed,.        ("wa
+000186b0: 6974 696e 6722 2c20 2270 726f 6365 7373  iting", "process
+000186c0: 696e 6722 293a 2074 7261 6e73 6974 696f  ing"): transitio
+000186d0: 6e5f 7761 6974 696e 675f 7072 6f63 6573  n_waiting_proces
+000186e0: 7369 6e67 2c0a 2020 2020 2020 2020 2822  sing,.        ("
+000186f0: 7761 6974 696e 6722 2c20 226e 6f2d 776f  waiting", "no-wo
+00018700: 726b 6572 2229 3a20 7472 616e 7369 7469  rker"): transiti
+00018710: 6f6e 5f77 6169 7469 6e67 5f6e 6f5f 776f  on_waiting_no_wo
+00018720: 726b 6572 2c0a 2020 2020 2020 2020 2822  rker,.        ("
+00018730: 7761 6974 696e 6722 2c20 2271 7565 7565  waiting", "queue
+00018740: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
+00018750: 7761 6974 696e 675f 7175 6575 6564 2c0a  waiting_queued,.
+00018760: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
+00018770: 6722 2c20 226d 656d 6f72 7922 293a 2074  g", "memory"): t
+00018780: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
+00018790: 675f 6d65 6d6f 7279 2c0a 2020 2020 2020  g_memory,.      
+000187a0: 2020 2822 7175 6575 6564 222c 2022 7265    ("queued", "re
+000187b0: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
+000187c0: 7469 6f6e 5f71 7565 7565 645f 7265 6c65  tion_queued_rele
+000187d0: 6173 6564 2c0a 2020 2020 2020 2020 2822  ased,.        ("
+000187e0: 7175 6575 6564 222c 2022 7072 6f63 6573  queued", "proces
+000187f0: 7369 6e67 2229 3a20 7472 616e 7369 7469  sing"): transiti
+00018800: 6f6e 5f71 7565 7565 645f 7072 6f63 6573  on_queued_proces
+00018810: 7369 6e67 2c0a 2020 2020 2020 2020 2822  sing,.        ("
+00018820: 7072 6f63 6573 7369 6e67 222c 2022 7265  processing", "re
+00018830: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
+00018840: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
+00018850: 7265 6c65 6173 6564 2c0a 2020 2020 2020  released,.      
+00018860: 2020 2822 7072 6f63 6573 7369 6e67 222c    ("processing",
+00018870: 2022 6d65 6d6f 7279 2229 3a20 7472 616e   "memory"): tran
+00018880: 7369 7469 6f6e 5f70 726f 6365 7373 696e  sition_processin
+00018890: 675f 6d65 6d6f 7279 2c0a 2020 2020 2020  g_memory,.      
+000188a0: 2020 2822 7072 6f63 6573 7369 6e67 222c    ("processing",
+000188b0: 2022 6572 7265 6422 293a 2074 7261 6e73   "erred"): trans
+000188c0: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
+000188d0: 5f65 7272 6564 2c0a 2020 2020 2020 2020  _erred,.        
+000188e0: 2822 6e6f 2d77 6f72 6b65 7222 2c20 2272  ("no-worker", "r
+000188f0: 656c 6561 7365 6422 293a 2074 7261 6e73  eleased"): trans
+00018900: 6974 696f 6e5f 6e6f 5f77 6f72 6b65 725f  ition_no_worker_
+00018910: 7265 6c65 6173 6564 2c0a 2020 2020 2020  released,.      
+00018920: 2020 2822 6e6f 2d77 6f72 6b65 7222 2c20    ("no-worker", 
+00018930: 2270 726f 6365 7373 696e 6722 293a 2074  "processing"): t
+00018940: 7261 6e73 6974 696f 6e5f 6e6f 5f77 6f72  ransition_no_wor
+00018950: 6b65 725f 7072 6f63 6573 7369 6e67 2c0a  ker_processing,.
+00018960: 2020 2020 2020 2020 2822 7265 6c65 6173          ("releas
+00018970: 6564 222c 2022 666f 7267 6f74 7465 6e22  ed", "forgotten"
+00018980: 293a 2074 7261 6e73 6974 696f 6e5f 7265  ): transition_re
+00018990: 6c65 6173 6564 5f66 6f72 676f 7474 656e  leased_forgotten
+000189a0: 2c0a 2020 2020 2020 2020 2822 6d65 6d6f  ,.        ("memo
+000189b0: 7279 222c 2022 666f 7267 6f74 7465 6e22  ry", "forgotten"
+000189c0: 293a 2074 7261 6e73 6974 696f 6e5f 6d65  ): transition_me
+000189d0: 6d6f 7279 5f66 6f72 676f 7474 656e 2c0a  mory_forgotten,.
+000189e0: 2020 2020 2020 2020 2822 6572 7265 6422          ("erred"
+000189f0: 2c20 2272 656c 6561 7365 6422 293a 2074  , "released"): t
+00018a00: 7261 6e73 6974 696f 6e5f 6572 7265 645f  ransition_erred_
+00018a10: 7265 6c65 6173 6564 2c0a 2020 2020 2020  released,.      
+00018a20: 2020 2822 6d65 6d6f 7279 222c 2022 7265    ("memory", "re
+00018a30: 6c65 6173 6564 2229 3a20 7472 616e 7369  leased"): transi
+00018a40: 7469 6f6e 5f6d 656d 6f72 795f 7265 6c65  tion_memory_rele
+00018a50: 6173 6564 2c0a 2020 2020 2020 2020 2822  ased,.        ("
+00018a60: 7265 6c65 6173 6564 222c 2022 6572 7265  released", "erre
+00018a70: 6422 293a 2074 7261 6e73 6974 696f 6e5f  d"): transition_
+00018a80: 7265 6c65 6173 6564 5f65 7272 6564 2c0a  released_erred,.
+00018a90: 2020 2020 7d0a 0a20 2020 2064 6566 2073      }..    def s
+00018aa0: 746f 7279 2873 656c 662c 202a 6b65 7973  tory(self, *keys
+00018ab0: 5f6f 725f 7461 736b 735f 6f72 5f73 7469  _or_tasks_or_sti
+00018ac0: 6d75 6c69 3a20 7374 7220 7c20 5461 736b  muli: str | Task
+00018ad0: 5374 6174 6529 202d 3e20 6c69 7374 5b54  State) -> list[T
+00018ae0: 7261 6e73 6974 696f 6e5d 3a0a 2020 2020  ransition]:.    
+00018af0: 2020 2020 2222 2247 6574 2061 6c6c 2074      """Get all t
+00018b00: 7261 6e73 6974 696f 6e73 2074 6861 7420  ransitions that 
+00018b10: 746f 7563 6820 6f6e 6520 6f66 2074 6865  touch one of the
+00018b20: 2069 6e70 7574 206b 6579 7320 6f72 2073   input keys or s
+00018b30: 7469 6d75 6c75 735f 6964 2773 2222 220a  timulus_id's""".
+00018b40: 2020 2020 2020 2020 6b65 7973 5f6f 725f          keys_or_
+00018b50: 7374 696d 756c 6920 3d20 7b0a 2020 2020  stimuli = {.    
+00018b60: 2020 2020 2020 2020 6b65 792e 6b65 7920          key.key 
+00018b70: 6966 2069 7369 6e73 7461 6e63 6528 6b65  if isinstance(ke
+00018b80: 792c 2054 6173 6b53 7461 7465 2920 656c  y, TaskState) el
+00018b90: 7365 206b 6579 0a20 2020 2020 2020 2020  se key.         
+00018ba0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+00018bb0: 7973 5f6f 725f 7461 736b 735f 6f72 5f73  ys_or_tasks_or_s
+00018bc0: 7469 6d75 6c69 0a20 2020 2020 2020 207d  timuli.        }
+00018bd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00018be0: 7363 6865 6475 6c65 725f 7374 6f72 7928  scheduler_story(
+00018bf0: 6b65 7973 5f6f 725f 7374 696d 756c 692c  keys_or_stimuli,
+00018c00: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+00018c10: 5f6c 6f67 290a 0a20 2020 2023 2323 2323  _log)..    #####
 00018c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00018c30: 2323 2323 2323 0a0a 2020 2020 6465 6620  ######..    def 
-00018c40: 6973 5f72 6f6f 7469 7368 2873 656c 662c  is_rootish(self,
-00018c50: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
-00018c60: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00018c70: 2022 2222 0a20 2020 2020 2020 2057 6865   """.        Whe
-00018c80: 7468 6572 2060 6074 7360 6020 6973 2061  ther ``ts`` is a
-00018c90: 2072 6f6f 7420 6f72 2072 6f6f 742d 6c69   root or root-li
-00018ca0: 6b65 2074 6173 6b2e 0a0a 2020 2020 2020  ke task...      
-00018cb0: 2020 526f 6f74 2d69 7368 2074 6173 6b73    Root-ish tasks
-00018cc0: 2061 7265 2070 6172 7420 6f66 2061 2067   are part of a g
-00018cd0: 726f 7570 2074 6861 7427 7320 6d75 6368  roup that's much
-00018ce0: 206c 6172 6765 7220 7468 616e 2074 6865   larger than the
-00018cf0: 2063 6c75 7374 6572 2c0a 2020 2020 2020   cluster,.      
-00018d00: 2020 616e 6420 6861 7665 2066 6577 206f    and have few o
-00018d10: 7220 6e6f 2064 6570 656e 6465 6e63 6965  r no dependencie
-00018d20: 732e 0a20 2020 2020 2020 2022 2222 0a20  s..        """. 
-00018d30: 2020 2020 2020 2069 6620 7473 2e72 6573         if ts.res
-00018d40: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-00018d50: 6e73 206f 7220 7473 2e77 6f72 6b65 725f  ns or ts.worker_
-00018d60: 7265 7374 7269 6374 696f 6e73 206f 7220  restrictions or 
-00018d70: 7473 2e68 6f73 745f 7265 7374 7269 6374  ts.host_restrict
-00018d80: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00018d90: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
-00018da0: 2020 2020 2020 2074 6720 3d20 7473 2e67         tg = ts.g
-00018db0: 726f 7570 0a20 2020 2020 2020 2023 2054  roup.        # T
-00018dc0: 4f44 4f20 7368 6f72 742d 6369 7263 7569  ODO short-circui
-00018dd0: 7420 746f 2054 7275 6520 6966 2060 6e6f  t to True if `no
-00018de0: 7420 7473 2e64 6570 656e 6465 6e63 6965  t ts.dependencie
-00018df0: 7360 3f0a 2020 2020 2020 2020 7265 7475  s`?.        retu
-00018e00: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
-00018e10: 206c 656e 2874 6729 203e 2073 656c 662e   len(tg) > self.
-00018e20: 746f 7461 6c5f 6e74 6872 6561 6473 202a  total_nthreads *
-00018e30: 2032 0a20 2020 2020 2020 2020 2020 2061   2.            a
-00018e40: 6e64 206c 656e 2874 672e 6465 7065 6e64  nd len(tg.depend
-00018e50: 656e 6369 6573 2920 3c20 350a 2020 2020  encies) < 5.    
-00018e60: 2020 2020 2020 2020 616e 6420 7375 6d28          and sum(
-00018e70: 6d61 7028 6c65 6e2c 2074 672e 6465 7065  map(len, tg.depe
-00018e80: 6e64 656e 6369 6573 2929 203c 2035 0a20  ndencies)) < 5. 
-00018e90: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00018ea0: 6620 6368 6563 6b5f 6964 6c65 5f73 6174  f check_idle_sat
-00018eb0: 7572 6174 6564 2873 656c 662c 2077 733a  urated(self, ws:
-00018ec0: 2057 6f72 6b65 7253 7461 7465 2c20 6f63   WorkerState, oc
-00018ed0: 633a 2066 6c6f 6174 203d 202d 312e 3029  c: float = -1.0)
-00018ee0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00018ef0: 2020 2222 2255 7064 6174 6520 7468 6520    """Update the 
-00018f00: 7374 6174 7573 206f 6620 7468 6520 6964  status of the id
-00018f10: 6c65 2061 6e64 2073 6174 7572 6174 6564  le and saturated
-00018f20: 2073 7461 7465 0a0a 2020 2020 2020 2020   state..        
-00018f30: 5468 6520 7363 6865 6475 6c65 7220 6b65  The scheduler ke
-00018f40: 6570 7320 7472 6163 6b20 6f66 2077 6f72  eps track of wor
-00018f50: 6b65 7273 2074 6861 7420 6172 6520 2e2e  kers that are ..
-00018f60: 0a0a 2020 2020 2020 2020 2d20 2053 6174  ..        -  Sat
-00018f70: 7572 6174 6564 3a20 6861 7665 2065 6e6f  urated: have eno
-00018f80: 7567 6820 776f 726b 2074 6f20 7374 6179  ugh work to stay
-00018f90: 2062 7573 790a 2020 2020 2020 2020 2d20   busy.        - 
-00018fa0: 2049 646c 653a 2064 6f20 6e6f 7420 6861   Idle: do not ha
-00018fb0: 7665 2065 6e6f 7567 6820 776f 726b 2074  ve enough work t
-00018fc0: 6f20 7374 6179 2062 7573 790a 0a20 2020  o stay busy..   
-00018fd0: 2020 2020 2054 6865 7920 6172 6520 636f       They are co
-00018fe0: 6e73 6964 6572 6564 2073 6174 7572 6174  nsidered saturat
-00018ff0: 6564 2069 6620 7468 6579 2062 6f74 6820  ed if they both 
-00019000: 6861 7665 2065 6e6f 7567 6820 7461 736b  have enough task
-00019010: 7320 746f 206f 6363 7570 790a 2020 2020  s to occupy.    
-00019020: 2020 2020 616c 6c20 6f66 2074 6865 6972      all of their
-00019030: 2074 6872 6561 6473 2c20 616e 6420 6966   threads, and if
-00019040: 2074 6865 2065 7870 6563 7465 6420 7275   the expected ru
-00019050: 6e74 696d 6520 6f66 2074 686f 7365 2074  ntime of those t
-00019060: 6173 6b73 2069 730a 2020 2020 2020 2020  asks is.        
-00019070: 6c61 7267 6520 656e 6f75 6768 2e0a 0a20  large enough... 
-00019080: 2020 2020 2020 2049 6620 6060 6469 7374         If ``dist
-00019090: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-000190a0: 722e 776f 726b 6572 2d73 6174 7572 6174  r.worker-saturat
-000190b0: 696f 6e60 6020 6973 206e 6f74 2060 6069  ion`` is not ``i
-000190c0: 6e66 6060 0a20 2020 2020 2020 2028 7363  nf``.        (sc
-000190d0: 6865 6475 6c65 722d 7369 6465 2071 7565  heduler-side que
-000190e0: 7569 6e67 2069 7320 656e 6162 6c65 6429  uing is enabled)
-000190f0: 2c20 7468 6579 2061 7265 2063 6f6e 7369  , they are consi
-00019100: 6465 7265 6420 6964 6c65 0a20 2020 2020  dered idle.     
-00019110: 2020 2069 6620 7468 6579 2068 6176 6520     if they have 
-00019120: 6665 7765 7220 7461 736b 7320 7072 6f63  fewer tasks proc
-00019130: 6573 7369 6e67 2074 6861 6e20 7468 6520  essing than the 
-00019140: 6060 776f 726b 6572 2d73 6174 7572 6174  ``worker-saturat
-00019150: 696f 6e60 600a 2020 2020 2020 2020 7468  ion``.        th
-00019160: 7265 7368 6f6c 6420 6469 6374 6174 6573  reshold dictates
-00019170: 2e0a 0a20 2020 2020 2020 204f 7468 6572  ...        Other
-00019180: 7769 7365 2c20 7468 6579 2061 7265 2063  wise, they are c
-00019190: 6f6e 7369 6465 7265 6420 6964 6c65 2069  onsidered idle i
-000191a0: 6620 7468 6579 2068 6176 6520 6665 7765  f they have fewe
-000191b0: 7220 7461 736b 7320 7072 6f63 6573 7369  r tasks processi
-000191c0: 6e67 0a20 2020 2020 2020 2074 6861 6e20  ng.        than 
-000191d0: 7468 7265 6164 732c 206f 7220 6966 2074  threads, or if t
-000191e0: 6865 6972 2074 6173 6b73 2720 746f 7461  heir tasks' tota
-000191f0: 6c20 6578 7065 6374 6564 2072 756e 7469  l expected runti
-00019200: 6d65 2069 7320 6c65 7373 2074 6861 6e20  me is less than 
-00019210: 6861 6c66 0a20 2020 2020 2020 2074 6865  half.        the
-00019220: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
-00019230: 6520 6f66 2074 6865 2073 616d 6520 6e75  e of the same nu
-00019240: 6d62 6572 206f 6620 6176 6572 6167 6520  mber of average 
-00019250: 7461 736b 732e 0a0a 2020 2020 2020 2020  tasks...        
-00019260: 5468 6973 2069 7320 7573 6566 756c 2066  This is useful f
-00019270: 6f72 206c 6f61 6420 6261 6c61 6e63 696e  or load balancin
-00019280: 6720 616e 6420 6164 6170 7469 7669 7479  g and adaptivity
-00019290: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-000192a0: 2020 2020 2020 6966 2073 656c 662e 746f        if self.to
-000192b0: 7461 6c5f 6e74 6872 6561 6473 203d 3d20  tal_nthreads == 
-000192c0: 3020 6f72 2077 732e 7374 6174 7573 203d  0 or ws.status =
-000192d0: 3d20 5374 6174 7573 2e63 6c6f 7365 643a  = Status.closed:
-000192e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000192f0: 7572 6e0a 2020 2020 2020 2020 6966 206f  urn.        if o
-00019300: 6363 203c 2030 3a0a 2020 2020 2020 2020  cc < 0:.        
-00019310: 2020 2020 6f63 6320 3d20 7773 2e6f 6363      occ = ws.occ
-00019320: 7570 616e 6379 0a0a 2020 2020 2020 2020  upancy..        
-00019330: 7020 3d20 6c65 6e28 7773 2e70 726f 6365  p = len(ws.proce
-00019340: 7373 696e 6729 0a0a 2020 2020 2020 2020  ssing)..        
-00019350: 7365 6c66 2e73 6174 7572 6174 6564 2e64  self.saturated.d
-00019360: 6973 6361 7264 2877 7329 0a20 2020 2020  iscard(ws).     
-00019370: 2020 2069 6620 7773 2e73 7461 7475 7320     if ws.status 
-00019380: 213d 2053 7461 7475 732e 7275 6e6e 696e  != Status.runnin
-00019390: 673a 0a20 2020 2020 2020 2020 2020 2073  g:.            s
-000193a0: 656c 662e 6964 6c65 2e70 6f70 2877 732e  elf.idle.pop(ws.
-000193b0: 6164 6472 6573 732c 204e 6f6e 6529 0a20  address, None). 
-000193c0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-000193d0: 2e69 735f 756e 6f63 6375 7069 6564 2877  .is_unoccupied(w
-000193e0: 732c 206f 6363 2c20 7029 3a0a 2020 2020  s, occ, p):.    
-000193f0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
-00019400: 655b 7773 2e61 6464 7265 7373 5d20 3d20  e[ws.address] = 
-00019410: 7773 0a20 2020 2020 2020 2065 6c73 653a  ws.        else:
-00019420: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00019430: 662e 6964 6c65 2e70 6f70 2877 732e 6164  f.idle.pop(ws.ad
-00019440: 6472 6573 732c 204e 6f6e 6529 0a20 2020  dress, None).   
-00019450: 2020 2020 2020 2020 206e 6320 3d20 7773           nc = ws
-00019460: 2e6e 7468 7265 6164 730a 2020 2020 2020  .nthreads.      
-00019470: 2020 2020 2020 6966 2070 203e 206e 633a        if p > nc:
-00019480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019490: 2070 656e 6469 6e67 203d 206f 6363 202a   pending = occ *
-000194a0: 2028 7020 2d20 6e63 2920 2f20 2870 202a   (p - nc) / (p *
-000194b0: 206e 6329 0a20 2020 2020 2020 2020 2020   nc).           
-000194c0: 2020 2020 2069 6620 302e 3420 3c20 7065       if 0.4 < pe
-000194d0: 6e64 696e 6720 3e20 312e 3920 2a20 2873  nding > 1.9 * (s
-000194e0: 656c 662e 746f 7461 6c5f 6f63 6375 7061  elf.total_occupa
-000194f0: 6e63 7920 2f20 7365 6c66 2e74 6f74 616c  ncy / self.total
-00019500: 5f6e 7468 7265 6164 7329 3a0a 2020 2020  _nthreads):.    
-00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019520: 7365 6c66 2e73 6174 7572 6174 6564 2e61  self.saturated.a
-00019530: 6464 2877 7329 0a0a 2020 2020 2020 2020  dd(ws)..        
-00019540: 6966 206e 6f74 205f 776f 726b 6572 5f66  if not _worker_f
-00019550: 756c 6c28 7773 2c20 7365 6c66 2e57 4f52  ull(ws, self.WOR
-00019560: 4b45 525f 5341 5455 5241 5449 4f4e 2920  KER_SATURATION) 
-00019570: 616e 6420 7773 2e73 7461 7475 7320 3d3d  and ws.status ==
-00019580: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-00019590: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000195a0: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
-000195b0: 742e 6164 6428 7773 290a 2020 2020 2020  t.add(ws).      
-000195c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000195d0: 2020 2020 7365 6c66 2e69 646c 655f 7461      self.idle_ta
-000195e0: 736b 5f63 6f75 6e74 2e64 6973 6361 7264  sk_count.discard
-000195f0: 2877 7329 0a0a 2020 2020 6465 6620 6973  (ws)..    def is
-00019600: 5f75 6e6f 6363 7570 6965 6428 0a20 2020  _unoccupied(.   
-00019610: 2020 2020 2073 656c 662c 2077 733a 2057       self, ws: W
-00019620: 6f72 6b65 7253 7461 7465 2c20 6f63 6375  orkerState, occu
-00019630: 7061 6e63 793a 2066 6c6f 6174 2c20 6e70  pancy: float, np
-00019640: 726f 6365 7373 696e 673a 2069 6e74 0a20  rocessing: int. 
-00019650: 2020 2029 202d 3e20 626f 6f6c 3a0a 2020     ) -> bool:.  
-00019660: 2020 2020 2020 6e74 6872 6561 6473 203d        nthreads =
-00019670: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
-00019680: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
-00019690: 2020 2020 2020 2020 2020 6e70 726f 6365            nproce
-000196a0: 7373 696e 6720 3c20 6e74 6872 6561 6473  ssing < nthreads
-000196b0: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-000196c0: 6f63 6375 7061 6e63 7920 3c20 6e74 6872  occupancy < nthr
-000196d0: 6561 6473 202a 2028 7365 6c66 2e74 6f74  eads * (self.tot
-000196e0: 616c 5f6f 6363 7570 616e 6379 202f 2073  al_occupancy / s
-000196f0: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-00019700: 6473 2920 2f20 320a 2020 2020 2020 2020  ds) / 2.        
-00019710: 290a 0a20 2020 2064 6566 2067 6574 5f63  )..    def get_c
-00019720: 6f6d 6d5f 636f 7374 2873 656c 662c 2074  omm_cost(self, t
-00019730: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
-00019740: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
-00019750: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
-00019760: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
-00019770: 2074 6865 2065 7374 696d 6174 6564 2063   the estimated c
-00019780: 6f6d 6d75 6e69 6361 7469 6f6e 2063 6f73  ommunication cos
-00019790: 7420 2869 6e20 732e 2920 746f 2063 6f6d  t (in s.) to com
-000197a0: 7075 7465 2074 6865 2074 6173 6b0a 2020  pute the task.  
-000197b0: 2020 2020 2020 6f6e 2074 6865 2067 6976        on the giv
-000197c0: 656e 2077 6f72 6b65 722e 0a20 2020 2020  en worker..     
-000197d0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-000197e0: 6620 3130 202a 206c 656e 2874 732e 6465  f 10 * len(ts.de
-000197f0: 7065 6e64 656e 6369 6573 2920 3c20 6c65  pendencies) < le
-00019800: 6e28 7773 2e68 6173 5f77 6861 7429 3a0a  n(ws.has_what):.
-00019810: 2020 2020 2020 2020 2020 2020 2320 496e              # In
-00019820: 2074 6865 2063 6f6d 6d6f 6e20 6361 7365   the common case
-00019830: 2077 6865 7265 2074 6865 206e 756d 6265   where the numbe
-00019840: 7220 6f66 2064 6570 656e 6465 6e63 6965  r of dependencie
-00019850: 7320 6973 0a20 2020 2020 2020 2020 2020  s is.           
-00019860: 2023 206d 7563 6820 6c65 7373 2074 6861   # much less tha
-00019870: 6e20 7468 6520 6e75 6d62 6572 206f 6620  n the number of 
-00019880: 7461 736b 7320 7468 6174 2077 6520 6861  tasks that we ha
-00019890: 7665 2c0a 2020 2020 2020 2020 2020 2020  ve,.            
-000198a0: 2320 636f 6e73 7472 7563 7420 7468 6520  # construct the 
-000198b0: 7365 7420 6f66 2064 6570 7320 7468 6174  set of deps that
-000198c0: 2072 6571 7569 7265 2063 6f6d 6d75 6e69   require communi
-000198d0: 6361 7469 6f6e 2069 6e0a 2020 2020 2020  cation in.      
-000198e0: 2020 2020 2020 2320 4f28 6c65 6e28 6465        # O(len(de
-000198f0: 7065 6e64 656e 6369 6573 2929 2072 6174  pendencies)) rat
-00019900: 6865 7220 7468 616e 204f 286c 656e 2868  her than O(len(h
-00019910: 6173 5f77 6861 7429 2920 7469 6d65 2e0a  as_what)) time..
-00019920: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
-00019930: 6374 6f72 206f 6620 3130 2069 7320 6120  ctor of 10 is a 
-00019940: 6775 6573 7320 6174 2074 6865 206f 7665  guess at the ove
-00019950: 7268 6561 6420 6f66 2065 7870 6c69 6369  rhead of explici
-00019960: 740a 2020 2020 2020 2020 2020 2020 2320  t.            # 
-00019970: 6974 6572 6174 696f 6e20 6173 206f 7070  iteration as opp
-00019980: 6f73 6564 2074 6f20 6a75 7374 2063 616c  osed to just cal
-00019990: 6c69 6e67 2073 6574 2e64 6966 6665 7265  ling set.differe
-000199a0: 6e63 650a 2020 2020 2020 2020 2020 2020  nce.            
-000199b0: 6465 7073 203d 207b 6465 7020 666f 7220  deps = {dep for 
-000199c0: 6465 7020 696e 2074 732e 6465 7065 6e64  dep in ts.depend
-000199d0: 656e 6369 6573 2069 6620 6465 7020 6e6f  encies if dep no
-000199e0: 7420 696e 2077 732e 6861 735f 7768 6174  t in ws.has_what
-000199f0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-00019a00: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-00019a10: 203d 2074 732e 6465 7065 6e64 656e 6369   = ts.dependenci
-00019a20: 6573 2e64 6966 6665 7265 6e63 6528 7773  es.difference(ws
-00019a30: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
-00019a40: 2020 206e 6279 7465 7320 3d20 7375 6d28     nbytes = sum(
-00019a50: 6474 732e 6e62 7974 6573 2066 6f72 2064  dts.nbytes for d
-00019a60: 7473 2069 6e20 6465 7073 290a 2020 2020  ts in deps).    
-00019a70: 2020 2020 7265 7475 726e 206e 6279 7465      return nbyte
-00019a80: 7320 2f20 7365 6c66 2e62 616e 6477 6964  s / self.bandwid
-00019a90: 7468 0a0a 2020 2020 6465 6620 6765 745f  th..    def get_
-00019aa0: 7461 736b 5f64 7572 6174 696f 6e28 7365  task_duration(se
-00019ab0: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-00019ac0: 6529 202d 3e20 666c 6f61 743a 0a20 2020  e) -> float:.   
-00019ad0: 2020 2020 2022 2222 4765 7420 7468 6520       """Get the 
-00019ae0: 6573 7469 6d61 7465 6420 636f 6d70 7574  estimated comput
-00019af0: 6174 696f 6e20 636f 7374 206f 6620 7468  ation cost of th
-00019b00: 6520 6769 7665 6e20 7461 736b 2028 6e6f  e given task (no
-00019b10: 7420 696e 636c 7564 696e 670a 2020 2020  t including.    
-00019b20: 2020 2020 616e 7920 636f 6d6d 756e 6963      any communic
-00019b30: 6174 696f 6e20 636f 7374 292e 0a0a 2020  ation cost)...  
-00019b40: 2020 2020 2020 4966 206e 6f20 6461 7461        If no data
-00019b50: 2068 6173 2062 6565 6e20 6f62 7365 7276   has been observ
-00019b60: 6564 2c20 7661 6c75 6520 6f66 0a20 2020  ed, value of.   
-00019b70: 2020 2020 2060 6469 7374 7269 6275 7465       `distribute
-00019b80: 642e 7363 6865 6475 6c65 722e 6465 6661  d.scheduler.defa
-00019b90: 756c 742d 7461 736b 2d64 7572 6174 696f  ult-task-duratio
-00019ba0: 6e73 6020 6172 6520 7573 6564 2e20 4966  ns` are used. If
-00019bb0: 206e 6f6e 6520 6973 2073 6574 0a20 2020   none is set.   
-00019bc0: 2020 2020 2066 6f72 2074 6869 7320 7461       for this ta
-00019bd0: 736b 2c20 6064 6973 7472 6962 7574 6564  sk, `distributed
-00019be0: 2e73 6368 6564 756c 6572 2e75 6e6b 6e6f  .scheduler.unkno
-00019bf0: 776e 2d74 6173 6b2d 6475 7261 7469 6f6e  wn-task-duration
-00019c00: 6020 6973 2075 7365 640a 2020 2020 2020  ` is used.      
-00019c10: 2020 696e 7374 6561 642e 0a20 2020 2020    instead..     
-00019c20: 2020 2022 2222 0a20 2020 2020 2020 2064     """.        d
-00019c30: 7572 6174 696f 6e3a 2066 6c6f 6174 203d  uration: float =
-00019c40: 2074 732e 7072 6566 6978 2e64 7572 6174   ts.prefix.durat
-00019c50: 696f 6e5f 6176 6572 6167 650a 2020 2020  ion_average.    
-00019c60: 2020 2020 6966 2064 7572 6174 696f 6e20      if duration 
-00019c70: 3e3d 2030 3a0a 2020 2020 2020 2020 2020  >= 0:.          
-00019c80: 2020 7265 7475 726e 2064 7572 6174 696f    return duratio
-00019c90: 6e0a 0a20 2020 2020 2020 2073 203d 2073  n..        s = s
-00019ca0: 656c 662e 756e 6b6e 6f77 6e5f 6475 7261  elf.unknown_dura
-00019cb0: 7469 6f6e 732e 6765 7428 7473 2e70 7265  tions.get(ts.pre
-00019cc0: 6669 782e 6e61 6d65 290a 2020 2020 2020  fix.name).      
-00019cd0: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
-00019ce0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019cf0: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
-00019d00: 6e73 5b74 732e 7072 6566 6978 2e6e 616d  ns[ts.prefix.nam
-00019d10: 655d 203d 2073 203d 2073 6574 2829 0a20  e] = s = set(). 
-00019d20: 2020 2020 2020 2073 2e61 6464 2874 7329         s.add(ts)
-00019d30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00019d40: 7365 6c66 2e55 4e4b 4e4f 574e 5f54 4153  self.UNKNOWN_TAS
-00019d50: 4b5f 4455 5241 5449 4f4e 0a0a 2020 2020  K_DURATION..    
-00019d60: 6465 6620 7661 6c69 645f 776f 726b 6572  def valid_worker
-00019d70: 7328 7365 6c66 2c20 7473 3a20 5461 736b  s(self, ts: Task
-00019d80: 5374 6174 6529 202d 3e20 7365 745b 576f  State) -> set[Wo
-00019d90: 726b 6572 5374 6174 655d 207c 204e 6f6e  rkerState] | Non
-00019da0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-00019db0: 7475 726e 2073 6574 206f 6620 6375 7272  turn set of curr
-00019dc0: 656e 746c 7920 7661 6c69 6420 776f 726b  ently valid work
-00019dd0: 6572 7320 666f 7220 6b65 790a 0a20 2020  ers for key..   
-00019de0: 2020 2020 2049 6620 616c 6c20 776f 726b       If all work
-00019df0: 6572 7320 6172 6520 7661 6c69 6420 7468  ers are valid th
-00019e00: 656e 2074 6869 7320 7265 7475 726e 7320  en this returns 
-00019e10: 6060 4e6f 6e65 6060 2c20 696e 2077 6869  ``None``, in whi
-00019e20: 6368 2063 6173 650a 2020 2020 2020 2020  ch case.        
-00019e30: 616e 7920 2a72 756e 6e69 6e67 2a20 776f  any *running* wo
-00019e40: 726b 6572 2063 616e 2062 6520 7573 6564  rker can be used
-00019e50: 2e0a 2020 2020 2020 2020 4f74 6865 7277  ..        Otherw
-00019e60: 6973 652c 2074 6865 2073 7562 7365 7420  ise, the subset 
-00019e70: 6f66 2072 756e 6e69 6e67 2077 6f72 6b65  of running worke
-00019e80: 7273 2076 616c 6964 2066 6f72 2074 6869  rs valid for thi
-00019e90: 7320 7461 736b 0a20 2020 2020 2020 2069  s task.        i
-00019ea0: 7320 7265 7475 726e 6564 2e0a 2020 2020  s returned..    
-00019eb0: 2020 2020 5468 6973 2063 6865 636b 7320      This checks 
-00019ec0: 7472 6163 6b73 2074 6865 2066 6f6c 6c6f  tracks the follo
-00019ed0: 7769 6e67 2073 7461 7465 3a0a 0a20 2020  wing state:..   
-00019ee0: 2020 2020 202a 2020 776f 726b 6572 5f72       *  worker_r
-00019ef0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
-00019f00: 2020 2020 2a20 2068 6f73 745f 7265 7374      *  host_rest
-00019f10: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
-00019f20: 202a 2020 7265 736f 7572 6365 5f72 6573   *  resource_res
-00019f30: 7472 6963 7469 6f6e 730a 2020 2020 2020  trictions.      
-00019f40: 2020 2222 220a 2020 2020 2020 2020 733a    """.        s:
-00019f50: 2073 6574 5b73 7472 5d20 7c20 4e6f 6e65   set[str] | None
-00019f60: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
-00019f70: 2069 6620 7473 2e77 6f72 6b65 725f 7265   if ts.worker_re
-00019f80: 7374 7269 6374 696f 6e73 3a0a 2020 2020  strictions:.    
-00019f90: 2020 2020 2020 2020 7320 3d20 7b61 6464          s = {add
-00019fa0: 7220 666f 7220 6164 6472 2069 6e20 7473  r for addr in ts
-00019fb0: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
-00019fc0: 696f 6e73 2069 6620 6164 6472 2069 6e20  ions if addr in 
-00019fd0: 7365 6c66 2e77 6f72 6b65 7273 7d0a 0a20  self.workers}.. 
-00019fe0: 2020 2020 2020 2069 6620 7473 2e68 6f73         if ts.hos
-00019ff0: 745f 7265 7374 7269 6374 696f 6e73 3a0a  t_restrictions:.
-0001a000: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-0001a010: 736f 6c76 6520 7468 6520 616c 6961 7320  solve the alias 
-0001a020: 6865 7265 2072 6174 6865 7220 7468 616e  here rather than
-0001a030: 2065 6172 6c79 2c20 666f 7220 7468 6520   early, for the 
-0001a040: 776f 726b 6572 0a20 2020 2020 2020 2020  worker.         
-0001a050: 2020 2023 206d 6179 206e 6f74 2062 6520     # may not be 
-0001a060: 636f 6e6e 6563 7465 6420 7768 656e 2068  connected when h
-0001a070: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-0001a080: 2069 7320 706f 7075 6c61 7465 640a 2020   is populated.  
-0001a090: 2020 2020 2020 2020 2020 6872 203d 205b            hr = [
-0001a0a0: 7365 6c66 2e63 6f65 7263 655f 686f 7374  self.coerce_host
-0001a0b0: 6e61 6d65 2868 2920 666f 7220 6820 696e  name(h) for h in
-0001a0c0: 2074 732e 686f 7374 5f72 6573 7472 6963   ts.host_restric
-0001a0d0: 7469 6f6e 735d 0a20 2020 2020 2020 2020  tions].         
-0001a0e0: 2020 2023 2058 5858 206e 6565 6420 486f     # XXX need Ho
-0001a0f0: 7374 5374 6174 653f 0a20 2020 2020 2020  stState?.       
-0001a100: 2020 2020 2073 6c20 3d20 5b5d 0a20 2020       sl = [].   
-0001a110: 2020 2020 2020 2020 2066 6f72 2068 2069           for h i
-0001a120: 6e20 6872 3a0a 2020 2020 2020 2020 2020  n hr:.          
-0001a130: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
-0001a140: 686f 7374 5f69 6e66 6f2e 6765 7428 6829  host_info.get(h)
-0001a150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a160: 2069 6620 6468 2069 7320 6e6f 7420 4e6f   if dh is not No
-0001a170: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001a180: 2020 2020 2020 2020 736c 2e61 7070 656e          sl.appen
-0001a190: 6428 6468 5b22 6164 6472 6573 7365 7322  d(dh["addresses"
-0001a1a0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
-0001a1b0: 7373 203d 2073 6574 2e75 6e69 6f6e 282a  ss = set.union(*
-0001a1c0: 736c 2920 6966 2073 6c20 656c 7365 2073  sl) if sl else s
-0001a1d0: 6574 2829 0a20 2020 2020 2020 2020 2020  et().           
-0001a1e0: 2069 6620 7320 6973 204e 6f6e 653a 0a20   if s is None:. 
-0001a1f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001a200: 203d 2073 730a 2020 2020 2020 2020 2020   = ss.          
-0001a210: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001a220: 2020 2020 2020 2020 7320 7c3d 2073 730a          s |= ss.
-0001a230: 0a20 2020 2020 2020 2069 6620 7473 2e72  .        if ts.r
-0001a240: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-0001a250: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-0001a260: 2020 6477 203d 207b 7d0a 2020 2020 2020    dw = {}.      
-0001a270: 2020 2020 2020 666f 7220 7265 736f 7572        for resour
-0001a280: 6365 2c20 7265 7175 6972 6564 2069 6e20  ce, required in 
-0001a290: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
-0001a2a0: 7269 6374 696f 6e73 2e69 7465 6d73 2829  rictions.items()
-0001a2b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a2c0: 2020 6472 203d 2073 656c 662e 7265 736f    dr = self.reso
-0001a2d0: 7572 6365 732e 6765 7428 7265 736f 7572  urces.get(resour
-0001a2e0: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
-0001a2f0: 2020 2020 6966 2064 7220 6973 204e 6f6e      if dr is Non
-0001a300: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001a310: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
-0001a320: 7572 6365 735b 7265 736f 7572 6365 5d20  urces[resource] 
-0001a330: 3d20 6472 203d 207b 7d0a 0a20 2020 2020  = dr = {}..     
-0001a340: 2020 2020 2020 2020 2020 2073 7720 3d20             sw = 
-0001a350: 7365 7428 290a 2020 2020 2020 2020 2020  set().          
-0001a360: 2020 2020 2020 666f 7220 6164 6472 2c20        for addr, 
-0001a370: 7375 7070 6c69 6564 2069 6e20 6472 2e69  supplied in dr.i
-0001a380: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0001a390: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001a3a0: 7570 706c 6965 6420 3e3d 2072 6571 7569  upplied >= requi
-0001a3b0: 7265 643a 0a20 2020 2020 2020 2020 2020  red:.           
-0001a3c0: 2020 2020 2020 2020 2020 2020 2073 772e               sw.
-0001a3d0: 6164 6428 6164 6472 290a 0a20 2020 2020  add(addr)..     
-0001a3e0: 2020 2020 2020 2020 2020 2064 775b 7265             dw[re
-0001a3f0: 736f 7572 6365 5d20 3d20 7377 0a0a 2020  source] = sw..  
-0001a400: 2020 2020 2020 2020 2020 7777 203d 2073            ww = s
-0001a410: 6574 2e69 6e74 6572 7365 6374 696f 6e28  et.intersection(
-0001a420: 2a64 772e 7661 6c75 6573 2829 290a 2020  *dw.values()).  
-0001a430: 2020 2020 2020 2020 2020 6966 2073 2069            if s i
-0001a440: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0001a450: 2020 2020 2020 2020 7320 3d20 7777 0a20          s = ww. 
-0001a460: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001a470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a480: 2073 2026 3d20 7777 0a0a 2020 2020 2020   s &= ww..      
-0001a490: 2020 6966 2073 2069 7320 4e6f 6e65 3a0a    if s is None:.
-0001a4a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001a4b0: 726e 204e 6f6e 6520 2023 2041 6c6c 2077  rn None  # All w
-0001a4c0: 6f72 6b65 7273 2061 7265 2076 616c 6964  orkers are valid
-0001a4d0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0001a4e0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-0001a4f0: 6574 7572 6e20 7365 7428 2920 2023 204e  eturn set()  # N
-0001a500: 6f20 776f 726b 6572 7320 6172 6520 7661  o workers are va
-0001a510: 6c69 640a 0a20 2020 2020 2020 2023 2053  lid..        # S
-0001a520: 6f6d 6520 776f 726b 6572 7320 6172 6520  ome workers are 
-0001a530: 7661 6c69 640a 2020 2020 2020 2020 735f  valid.        s_
-0001a540: 7773 203d 207b 7365 6c66 2e77 6f72 6b65  ws = {self.worke
-0001a550: 7273 5b61 6464 725d 2066 6f72 2061 6464  rs[addr] for add
-0001a560: 7220 696e 2073 7d0a 2020 2020 2020 2020  r in s}.        
-0001a570: 6966 206c 656e 2873 656c 662e 7275 6e6e  if len(self.runn
-0001a580: 696e 6729 203c 206c 656e 2873 656c 662e  ing) < len(self.
-0001a590: 776f 726b 6572 7329 3a0a 2020 2020 2020  workers):.      
-0001a5a0: 2020 2020 2020 735f 7773 2026 3d20 7365        s_ws &= se
-0001a5b0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
-0001a5c0: 2020 2072 6574 7572 6e20 735f 7773 0a0a     return s_ws..
-0001a5d0: 2020 2020 6465 6620 6163 7175 6972 655f      def acquire_
-0001a5e0: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
-0001a5f0: 7473 3a20 5461 736b 5374 6174 652c 2077  ts: TaskState, w
-0001a600: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-0001a610: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0001a620: 2066 6f72 2072 2c20 7265 7175 6972 6564   for r, required
-0001a630: 2069 6e20 7473 2e72 6573 6f75 7263 655f   in ts.resource_
-0001a640: 7265 7374 7269 6374 696f 6e73 2e69 7465  restrictions.ite
-0001a650: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0001a660: 2020 7773 2e75 7365 645f 7265 736f 7572    ws.used_resour
-0001a670: 6365 735b 725d 202b 3d20 7265 7175 6972  ces[r] += requir
-0001a680: 6564 0a0a 2020 2020 6465 6620 7265 6c65  ed..    def rele
-0001a690: 6173 655f 7265 736f 7572 6365 7328 7365  ase_resources(se
-0001a6a0: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001a6b0: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
-0001a6c0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-0001a6d0: 2020 2020 2066 6f72 2072 2c20 7265 7175       for r, requ
-0001a6e0: 6972 6564 2069 6e20 7473 2e72 6573 6f75  ired in ts.resou
-0001a6f0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001a700: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0001a710: 2020 2020 2020 7773 2e75 7365 645f 7265        ws.used_re
-0001a720: 736f 7572 6365 735b 725d 202d 3d20 7265  sources[r] -= re
-0001a730: 7175 6972 6564 0a0a 2020 2020 6465 6620  quired..    def 
-0001a740: 636f 6572 6365 5f68 6f73 746e 616d 6528  coerce_hostname(
-0001a750: 7365 6c66 2c20 686f 7374 3a20 4861 7368  self, host: Hash
-0001a760: 6162 6c65 2920 2d3e 2073 7472 3a0a 2020  able) -> str:.  
-0001a770: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001a780: 2020 436f 6572 6365 2074 6865 2068 6f73    Coerce the hos
-0001a790: 746e 616d 6520 6f66 2061 2077 6f72 6b65  tname of a worke
-0001a7a0: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
-0001a7b0: 2020 2020 2020 2061 6c69 6173 203d 2073         alias = s
-0001a7c0: 656c 662e 616c 6961 7365 732e 6765 7428  elf.aliases.get(
-0001a7d0: 686f 7374 290a 2020 2020 2020 2020 6966  host).        if
-0001a7e0: 2061 6c69 6173 2069 7320 6e6f 7420 4e6f   alias is not No
-0001a7f0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001a800: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
-0001a810: 735b 616c 6961 735d 0a20 2020 2020 2020  s[alias].       
-0001a820: 2020 2020 2072 6574 7572 6e20 7773 2e68       return ws.h
-0001a830: 6f73 740a 2020 2020 2020 2020 656c 7365  ost.        else
-0001a840: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0001a850: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0001a860: 686f 7374 2c20 7374 7229 0a20 2020 2020  host, str).     
-0001a870: 2020 2020 2020 2072 6574 7572 6e20 686f         return ho
-0001a880: 7374 0a0a 2020 2020 6465 6620 776f 726b  st..    def work
-0001a890: 6572 5f6f 626a 6563 7469 7665 2873 656c  er_objective(sel
-0001a8a0: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-0001a8b0: 2c20 7773 3a20 576f 726b 6572 5374 6174  , ws: WorkerStat
-0001a8c0: 6529 202d 3e20 7475 706c 653a 0a20 2020  e) -> tuple:.   
-0001a8d0: 2020 2020 2022 2222 4f62 6a65 6374 6976       """Objectiv
-0001a8e0: 6520 6675 6e63 7469 6f6e 2074 6f20 6465  e function to de
-0001a8f0: 7465 726d 696e 6520 7768 6963 6820 776f  termine which wo
-0001a900: 726b 6572 2073 686f 756c 6420 6765 7420  rker should get 
-0001a910: 7468 6520 7461 736b 0a0a 2020 2020 2020  the task..      
-0001a920: 2020 4d69 6e69 6d69 7a65 2065 7870 6563    Minimize expec
-0001a930: 7465 6420 7374 6172 7420 7469 6d65 2e20  ted start time. 
-0001a940: 2049 6620 6120 7469 6520 7468 656e 2062   If a tie then b
-0001a950: 7265 616b 2077 6974 6820 6461 7461 2073  reak with data s
-0001a960: 746f 7261 6765 2e0a 2020 2020 2020 2020  torage..        
-0001a970: 2222 220a 2020 2020 2020 2020 636f 6d6d  """.        comm
-0001a980: 5f62 7974 6573 203d 2073 756d 280a 2020  _bytes = sum(.  
-0001a990: 2020 2020 2020 2020 2020 6474 732e 6765            dts.ge
-0001a9a0: 745f 6e62 7974 6573 2829 2066 6f72 2064  t_nbytes() for d
-0001a9b0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-0001a9c0: 6e63 6965 7320 6966 2077 7320 6e6f 7420  ncies if ws not 
-0001a9d0: 696e 2064 7473 2e77 686f 5f68 6173 0a20  in dts.who_has. 
-0001a9e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001a9f0: 2020 7374 6163 6b5f 7469 6d65 203d 2077    stack_time = w
-0001aa00: 732e 6f63 6375 7061 6e63 7920 2f20 7773  s.occupancy / ws
-0001aa10: 2e6e 7468 7265 6164 730a 2020 2020 2020  .nthreads.      
-0001aa20: 2020 7374 6172 745f 7469 6d65 203d 2073    start_time = s
-0001aa30: 7461 636b 5f74 696d 6520 2b20 636f 6d6d  tack_time + comm
-0001aa40: 5f62 7974 6573 202f 2073 656c 662e 6261  _bytes / self.ba
-0001aa50: 6e64 7769 6474 680a 0a20 2020 2020 2020  ndwidth..       
-0001aa60: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
-0001aa70: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001aa80: 2028 6c65 6e28 7773 2e61 6374 6f72 7329   (len(ws.actors)
-0001aa90: 2c20 7374 6172 745f 7469 6d65 2c20 7773  , start_time, ws
-0001aaa0: 2e6e 6279 7465 7329 0a20 2020 2020 2020  .nbytes).       
-0001aab0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001aac0: 2020 2072 6574 7572 6e20 2873 7461 7274     return (start
-0001aad0: 5f74 696d 652c 2077 732e 6e62 7974 6573  _time, ws.nbytes
-0001aae0: 290a 0a20 2020 2064 6566 2061 6464 5f72  )..    def add_r
-0001aaf0: 6570 6c69 6361 2873 656c 662c 2074 733a  eplica(self, ts:
-0001ab00: 2054 6173 6b53 7461 7465 2c20 7773 3a20   TaskState, ws: 
-0001ab10: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
-0001ab20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0001ab30: 224e 6f74 6520 7468 6174 2061 2077 6f72  "Note that a wor
-0001ab40: 6b65 7220 686f 6c64 7320 6120 7265 706c  ker holds a repl
-0001ab50: 6963 6120 6f66 2061 2074 6173 6b20 7769  ica of a task wi
-0001ab60: 7468 2073 7461 7465 3d27 6d65 6d6f 7279  th state='memory
-0001ab70: 2722 2222 0a20 2020 2020 2020 2077 732e  '""".        ws.
-0001ab80: 6164 645f 7265 706c 6963 6128 7473 290a  add_replica(ts).
-0001ab90: 2020 2020 2020 2020 6966 206c 656e 2874          if len(t
-0001aba0: 732e 7768 6f5f 6861 7329 203d 3d20 323a  s.who_has) == 2:
-0001abb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001abc0: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
-0001abd0: 6b73 2e61 6464 2874 7329 0a0a 2020 2020  ks.add(ts)..    
-0001abe0: 6465 6620 7265 6d6f 7665 5f72 6570 6c69  def remove_repli
-0001abf0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
-0001ac00: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
-0001ac10: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
-0001ac20: 3a0a 2020 2020 2020 2020 2222 224e 6f74  :.        """Not
-0001ac30: 6520 7468 6174 2061 2077 6f72 6b65 7220  e that a worker 
-0001ac40: 6e6f 206c 6f6e 6765 7220 686f 6c64 7320  no longer holds 
-0001ac50: 6120 7265 706c 6963 6120 6f66 2061 2074  a replica of a t
-0001ac60: 6173 6b22 2222 0a20 2020 2020 2020 2077  ask""".        w
-0001ac70: 732e 7265 6d6f 7665 5f72 6570 6c69 6361  s.remove_replica
-0001ac80: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
-0001ac90: 6c65 6e28 7473 2e77 686f 5f68 6173 2920  len(ts.who_has) 
-0001aca0: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-0001acb0: 2020 7365 6c66 2e72 6570 6c69 6361 7465    self.replicate
-0001acc0: 645f 7461 736b 732e 7265 6d6f 7665 2874  d_tasks.remove(t
-0001acd0: 7329 0a0a 2020 2020 6465 6620 7265 6d6f  s)..    def remo
-0001ace0: 7665 5f61 6c6c 5f72 6570 6c69 6361 7328  ve_all_replicas(
-0001acf0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001ad00: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-0001ad10: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
-0001ad20: 616c 6c20 7265 706c 6963 6173 206f 6620  all replicas of 
-0001ad30: 6120 7461 736b 2066 726f 6d20 616c 6c20  a task from all 
-0001ad40: 776f 726b 6572 7322 2222 0a20 2020 2020  workers""".     
-0001ad50: 2020 206e 6279 7465 7320 3d20 7473 2e67     nbytes = ts.g
-0001ad60: 6574 5f6e 6279 7465 7328 290a 2020 2020  et_nbytes().    
-0001ad70: 2020 2020 666f 7220 7773 2069 6e20 7473      for ws in ts
-0001ad80: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-0001ad90: 2020 2020 2020 7773 2e6e 6279 7465 7320        ws.nbytes 
-0001ada0: 2d3d 206e 6279 7465 730a 2020 2020 2020  -= nbytes.      
-0001adb0: 2020 2020 2020 6465 6c20 7773 2e5f 6861        del ws._ha
-0001adc0: 735f 7768 6174 5b74 735d 0a20 2020 2020  s_what[ts].     
-0001add0: 2020 2069 6620 6c65 6e28 7473 2e77 686f     if len(ts.who
-0001ade0: 5f68 6173 2920 3e20 313a 0a20 2020 2020  _has) > 1:.     
-0001adf0: 2020 2020 2020 2073 656c 662e 7265 706c         self.repl
-0001ae00: 6963 6174 6564 5f74 6173 6b73 2e72 656d  icated_tasks.rem
-0001ae10: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-0001ae20: 7473 2e77 686f 5f68 6173 2e63 6c65 6172  ts.who_has.clear
-0001ae30: 2829 0a0a 2020 2020 6465 6620 6275 6c6b  ()..    def bulk
-0001ae40: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
-0001ae50: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
-0001ae60: 675f 776f 726b 6572 2873 656c 662c 2077  g_worker(self, w
-0001ae70: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
-0001ae80: 2d3e 2052 6563 733a 0a20 2020 2020 2020  -> Recs:.       
-0001ae90: 2022 2222 5365 6e64 2060 606e 6f2d 776f   """Send ``no-wo
-0001aea0: 726b 6572 6060 2074 6173 6b73 2074 6f20  rker`` tasks to 
-0001aeb0: 6060 7072 6f63 6573 7369 6e67 6060 2074  ``processing`` t
-0001aec0: 6861 7420 7468 6973 2077 6f72 6b65 7220  hat this worker 
-0001aed0: 6361 6e20 6861 6e64 6c65 2e0a 0a20 2020  can handle...   
-0001aee0: 2020 2020 2052 6574 7572 6e73 2070 7269       Returns pri
-0001aef0: 6f72 6974 792d 6f72 6465 7265 6420 7265  ority-ordered re
-0001af00: 636f 6d6d 656e 6461 7469 6f6e 732e 0a20  commendations.. 
-0001af10: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001af20: 2020 2072 756e 6e61 626c 653a 206c 6973     runnable: lis
-0001af30: 745b 5461 736b 5374 6174 655d 203d 205b  t[TaskState] = [
-0001af40: 5d0a 2020 2020 2020 2020 666f 7220 7473  ].        for ts
-0001af50: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
-0001af60: 626c 653a 0a20 2020 2020 2020 2020 2020  ble:.           
-0001af70: 2076 616c 6964 203d 2073 656c 662e 7661   valid = self.va
-0001af80: 6c69 645f 776f 726b 6572 7328 7473 290a  lid_workers(ts).
-0001af90: 2020 2020 2020 2020 2020 2020 6966 2076              if v
-0001afa0: 616c 6964 2069 7320 4e6f 6e65 206f 7220  alid is None or 
-0001afb0: 7773 2069 6e20 7661 6c69 643a 0a20 2020  ws in valid:.   
-0001afc0: 2020 2020 2020 2020 2020 2020 2072 756e               run
-0001afd0: 6e61 626c 652e 6170 7065 6e64 2874 7329  nable.append(ts)
-0001afe0: 0a0a 2020 2020 2020 2020 2320 5265 636f  ..        # Reco
-0001aff0: 6d6d 656e 6461 7469 6f6e 7320 6172 6520  mmendations are 
-0001b000: 7072 6f63 6573 7365 6420 4c49 464f 2c20  processed LIFO, 
-0001b010: 6865 6e63 6520 7468 6520 7265 7665 7273  hence the revers
-0001b020: 6564 206f 7264 6572 0a20 2020 2020 2020  ed order.       
-0001b030: 2072 756e 6e61 626c 652e 736f 7274 286b   runnable.sort(k
-0001b040: 6579 3d6f 7065 7261 746f 722e 6174 7472  ey=operator.attr
-0001b050: 6765 7474 6572 2822 7072 696f 7269 7479  getter("priority
-0001b060: 2229 2c20 7265 7665 7273 653d 5472 7565  "), reverse=True
-0001b070: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001b080: 207b 7473 2e6b 6579 3a20 2270 726f 6365   {ts.key: "proce
-0001b090: 7373 696e 6722 2066 6f72 2074 7320 696e  ssing" for ts in
-0001b0a0: 2072 756e 6e61 626c 657d 0a0a 2020 2020   runnable}..    
-0001b0b0: 6465 6620 5f76 616c 6964 6174 655f 7265  def _validate_re
-0001b0c0: 6164 7928 7365 6c66 2c20 7473 3a20 5461  ady(self, ts: Ta
-0001b0d0: 736b 5374 6174 6529 202d 3e20 4e6f 6e65  skState) -> None
-0001b0e0: 3a0a 2020 2020 2020 2020 2222 2256 616c  :.        """Val
-0001b0f0: 6964 6174 696f 6e20 666f 7220 7265 6164  idation for read
-0001b100: 7920 7374 6174 6573 2028 7072 6f63 6573  y states (proces
-0001b110: 7369 6e67 2c20 7175 6575 6564 2c20 6e6f  sing, queued, no
-0001b120: 2d77 6f72 6b65 7229 2222 220a 2020 2020  -worker)""".    
-0001b130: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-0001b140: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
-0001b150: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0001b160: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0001b170: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0001b180: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-0001b190: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001b1a0: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-0001b1b0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-0001b1c0: 6572 7420 6e6f 7420 7473 2e68 6173 5f6c  ert not ts.has_l
-0001b1d0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
-0001b1e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001b1f0: 7473 206e 6f74 2069 6e20 7365 6c66 2e75  ts not in self.u
-0001b200: 6e72 756e 6e61 626c 650a 2020 2020 2020  nrunnable.      
-0001b210: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
-0001b220: 696e 2073 656c 662e 7175 6575 6564 0a20  in self.queued. 
-0001b230: 2020 2020 2020 2061 7373 6572 7420 616c         assert al
-0001b240: 6c28 6474 732e 7768 6f5f 6861 7320 666f  l(dts.who_has fo
-0001b250: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0001b260: 6e64 656e 6369 6573 290a 0a20 2020 2064  ndencies)..    d
-0001b270: 6566 205f 6164 645f 746f 5f70 726f 6365  ef _add_to_proce
-0001b280: 7373 696e 6728 7365 6c66 2c20 7473 3a20  ssing(self, ts: 
-0001b290: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-0001b2a0: 6f72 6b65 7253 7461 7465 2920 2d3e 204d  orkerState) -> M
-0001b2b0: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
-0001b2c0: 5365 7420 6120 7461 736b 2061 7320 7072  Set a task as pr
-0001b2d0: 6f63 6573 7369 6e67 206f 6e20 6120 776f  ocessing on a wo
-0001b2e0: 726b 6572 2061 6e64 2072 6574 7572 6e20  rker and return 
-0001b2f0: 7468 6520 776f 726b 6572 206d 6573 7361  the worker messa
-0001b300: 6765 7320 746f 2073 656e 6422 2222 0a20  ges to send""". 
-0001b310: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-0001b320: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-0001b330: 2020 2020 2073 656c 662e 5f76 616c 6964       self._valid
-0001b340: 6174 655f 7265 6164 7928 7473 290a 2020  ate_ready(ts).  
-0001b350: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001b360: 2077 7320 696e 2073 656c 662e 7275 6e6e   ws in self.runn
-0001b370: 696e 672c 2073 656c 662e 7275 6e6e 696e  ing, self.runnin
-0001b380: 670a 2020 2020 2020 2020 2020 2020 6173  g.            as
-0001b390: 7365 7274 2028 6f20 3a3d 2073 656c 662e  sert (o := self.
-0001b3a0: 776f 726b 6572 732e 6765 7428 7773 2e61  workers.get(ws.a
-0001b3b0: 6464 7265 7373 2929 2069 7320 7773 2c20  ddress)) is ws, 
-0001b3c0: 2877 732c 206f 290a 0a20 2020 2020 2020  (ws, o)..       
-0001b3d0: 2077 732e 6164 645f 746f 5f70 726f 6365   ws.add_to_proce
-0001b3e0: 7373 696e 6728 7473 290a 2020 2020 2020  ssing(ts).      
-0001b3f0: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
-0001b400: 6f6e 203d 2077 730a 2020 2020 2020 2020  on = ws.        
-0001b410: 7473 2e73 7461 7465 203d 2022 7072 6f63  ts.state = "proc
-0001b420: 6573 7369 6e67 220a 2020 2020 2020 2020  essing".        
-0001b430: 7365 6c66 2e61 6371 7569 7265 5f72 6573  self.acquire_res
-0001b440: 6f75 7263 6573 2874 732c 2077 7329 0a20  ources(ts, ws). 
-0001b450: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
-0001b460: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
-0001b470: 2877 7329 0a20 2020 2020 2020 2073 656c  (ws).        sel
-0001b480: 662e 6e5f 7461 736b 7320 2b3d 2031 0a0a  f.n_tasks += 1..
-0001b490: 2020 2020 2020 2020 6966 2074 732e 6163          if ts.ac
-0001b4a0: 746f 723a 0a20 2020 2020 2020 2020 2020  tor:.           
-0001b4b0: 2077 732e 6163 746f 7273 2e61 6464 2874   ws.actors.add(t
-0001b4c0: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-0001b4d0: 726e 207b 7773 2e61 6464 7265 7373 3a20  rn {ws.address: 
-0001b4e0: 5b73 656c 662e 5f74 6173 6b5f 746f 5f6d  [self._task_to_m
-0001b4f0: 7367 2874 7329 5d7d 0a0a 2020 2020 6465  sg(ts)]}..    de
-0001b500: 6620 5f65 7869 745f 7072 6f63 6573 7369  f _exit_processi
-0001b510: 6e67 5f63 6f6d 6d6f 6e28 7365 6c66 2c20  ng_common(self, 
-0001b520: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-0001b530: 3e20 576f 726b 6572 5374 6174 6520 7c20  > WorkerState | 
-0001b540: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0001b550: 2252 656d 6f76 6520 2a74 732a 2066 726f  "Remove *ts* fro
-0001b560: 6d20 7468 6520 7365 7420 6f66 2070 726f  m the set of pro
-0001b570: 6365 7373 696e 6720 7461 736b 732e 0a0a  cessing tasks...
-0001b580: 2020 2020 2020 2020 5265 7475 726e 730a          Returns.
-0001b590: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-0001b5a0: 2020 2020 2020 2020 576f 726b 6572 2073          Worker s
-0001b5b0: 7461 7465 206f 6620 7468 6520 776f 726b  tate of the work
-0001b5c0: 6572 2074 6861 7420 7072 6f63 6573 7365  er that processe
-0001b5d0: 6420 2a74 732a 2069 6620 7468 6520 776f  d *ts* if the wo
-0001b5e0: 726b 6572 2069 7320 6375 7272 656e 742c  rker is current,
-0001b5f0: 0a20 2020 2020 2020 204e 6f6e 6520 6966  .        None if
-0001b600: 2074 6865 2077 6f72 6b65 7220 6973 2073   the worker is s
-0001b610: 7461 6c65 2e0a 0a20 2020 2020 2020 2053  tale...        S
-0001b620: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
-0001b630: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-0001b640: 2053 6368 6564 756c 6572 2e5f 7365 745f   Scheduler._set_
-0001b650: 6475 7261 7469 6f6e 5f65 7374 696d 6174  duration_estimat
-0001b660: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-0001b670: 2020 2020 2020 7773 203d 2074 732e 7072        ws = ts.pr
-0001b680: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-0001b690: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
-0001b6a0: 2020 2020 2020 7473 2e70 726f 6365 7373        ts.process
-0001b6b0: 696e 675f 6f6e 203d 204e 6f6e 650a 0a20  ing_on = None.. 
-0001b6c0: 2020 2020 2020 2077 732e 7265 6d6f 7665         ws.remove
-0001b6d0: 5f66 726f 6d5f 7072 6f63 6573 7369 6e67  _from_processing
-0001b6e0: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
-0001b6f0: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
-0001b700: 2877 732e 6164 6472 6573 7329 2069 7320  (ws.address) is 
-0001b710: 6e6f 7420 7773 3a20 2023 206d 6179 2068  not ws:  # may h
-0001b720: 6176 6520 6265 656e 2072 656d 6f76 6564  ave been removed
-0001b730: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001b740: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-0001b750: 2020 7365 6c66 2e63 6865 636b 5f69 646c    self.check_idl
-0001b760: 655f 7361 7475 7261 7465 6428 7773 290a  e_saturated(ws).
-0001b770: 2020 2020 2020 2020 7365 6c66 2e72 656c          self.rel
-0001b780: 6561 7365 5f72 6573 6f75 7263 6573 2874  ease_resources(t
-0001b790: 732c 2077 7329 0a0a 2020 2020 2020 2020  s, ws)..        
-0001b7a0: 7265 7475 726e 2077 730a 0a20 2020 2064  return ws..    d
-0001b7b0: 6566 205f 6164 645f 746f 5f6d 656d 6f72  ef _add_to_memor
-0001b7c0: 7928 0a20 2020 2020 2020 2073 656c 662c  y(.        self,
-0001b7d0: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
-0001b7e0: 6b53 7461 7465 2c0a 2020 2020 2020 2020  kState,.        
-0001b7f0: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
-0001b800: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-0001b810: 6e64 6174 696f 6e73 3a20 5265 6373 2c0a  ndations: Recs,.
-0001b820: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-0001b830: 7367 733a 204d 7367 732c 0a20 2020 2020  sgs: Msgs,.     
-0001b840: 2020 2074 7970 653a 2062 7974 6573 207c     type: bytes |
-0001b850: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-0001b860: 2020 2020 2020 7479 7065 6e61 6d65 3a20        typename: 
-0001b870: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0001b880: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-0001b890: 3a0a 2020 2020 2020 2020 2222 2241 6464  :.        """Add
-0001b8a0: 2074 7320 746f 2074 6865 2073 6574 206f   ts to the set o
-0001b8b0: 6620 696e 2d6d 656d 6f72 7920 7461 736b  f in-memory task
-0001b8c0: 7322 2222 0a20 2020 2020 2020 2069 6620  s""".        if 
-0001b8d0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
-0001b8e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001b8f0: 7420 7473 206e 6f74 2069 6e20 7773 2e68  t ts not in ws.h
-0001b900: 6173 5f77 6861 740a 0a20 2020 2020 2020  as_what..       
-0001b910: 2073 656c 662e 6164 645f 7265 706c 6963   self.add_replic
-0001b920: 6128 7473 2c20 7773 290a 0a20 2020 2020  a(ts, ws)..     
-0001b930: 2020 2064 6570 7320 3d20 6c69 7374 2874     deps = list(t
-0001b940: 732e 6465 7065 6e64 656e 7473 290a 2020  s.dependents).  
-0001b950: 2020 2020 2020 6966 206c 656e 2864 6570        if len(dep
-0001b960: 7329 203e 2031 3a0a 2020 2020 2020 2020  s) > 1:.        
-0001b970: 2020 2020 6465 7073 2e73 6f72 7428 6b65      deps.sort(ke
-0001b980: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
-0001b990: 6574 7465 7228 2270 7269 6f72 6974 7922  etter("priority"
-0001b9a0: 292c 2072 6576 6572 7365 3d54 7275 6529  ), reverse=True)
-0001b9b0: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-0001b9c0: 7320 696e 2064 6570 733a 0a20 2020 2020  s in deps:.     
-0001b9d0: 2020 2020 2020 2073 203d 2064 7473 2e77         s = dts.w
-0001b9e0: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-0001b9f0: 2020 2020 2020 6966 2074 7320 696e 2073        if ts in s
-0001ba00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ba10: 2020 732e 6469 7363 6172 6428 7473 290a    s.discard(ts).
-0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba30: 6966 206e 6f74 2073 3a20 2023 206e 6577  if not s:  # new
-0001ba40: 2074 6173 6b20 7265 6164 7920 746f 2072   task ready to r
-0001ba50: 756e 0a20 2020 2020 2020 2020 2020 2020  un.             
-0001ba60: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-0001ba70: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
-0001ba80: 3d20 2270 726f 6365 7373 696e 6722 0a0a  = "processing"..
-0001ba90: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0001baa0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0001bab0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001bac0: 7320 3d20 6474 732e 7761 6974 6572 730a  s = dts.waiters.
-0001bad0: 2020 2020 2020 2020 2020 2020 732e 6469              s.di
-0001bae0: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
-0001baf0: 2020 2020 2020 6966 206e 6f74 2073 2061        if not s a
-0001bb00: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
-0001bb10: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-0001bb20: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001bb30: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-0001bb40: 2022 7265 6c65 6173 6564 220a 0a20 2020   "released"..   
-0001bb50: 2020 2020 2069 6620 6e6f 7420 7473 2e77       if not ts.w
-0001bb60: 6169 7465 7273 2061 6e64 206e 6f74 2074  aiters and not t
-0001bb70: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
-0001bb80: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001bb90: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
-0001bba0: 203d 2022 7265 6c65 6173 6564 220a 2020   = "released".  
-0001bbb0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001bbc0: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
-0001bbd0: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
-0001bbe0: 795d 203d 207b 226f 7022 3a20 226b 6579  y] = {"op": "key
-0001bbf0: 2d69 6e2d 6d65 6d6f 7279 222c 2022 6b65  -in-memory", "ke
-0001bc00: 7922 3a20 7473 2e6b 6579 7d0a 2020 2020  y": ts.key}.    
-0001bc10: 2020 2020 2020 2020 6966 2074 7970 6520          if type 
-0001bc20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-0001bc30: 2020 2020 2020 2020 2020 2020 2072 6570               rep
-0001bc40: 6f72 745f 6d73 675b 2274 7970 6522 5d20  ort_msg["type"] 
-0001bc50: 3d20 7479 7065 0a20 2020 2020 2020 2020  = type.         
-0001bc60: 2020 2066 6f72 2063 7320 696e 2074 732e     for cs in ts.
-0001bc70: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
-0001bc80: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-0001bc90: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
-0001bca0: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
-0001bcb0: 6d73 675d 0a0a 2020 2020 2020 2020 7473  msg]..        ts
-0001bcc0: 2e73 7461 7465 203d 2022 6d65 6d6f 7279  .state = "memory
-0001bcd0: 220a 2020 2020 2020 2020 7473 2e74 7970  ".        ts.typ
-0001bce0: 6520 3d20 7479 7065 6e61 6d65 2020 2320  e = typename  # 
-0001bcf0: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-0001bd00: 2020 2020 2074 732e 6772 6f75 702e 7479       ts.group.ty
-0001bd10: 7065 732e 6164 6428 7479 7065 6e61 6d65  pes.add(typename
-0001bd20: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0001bd30: 650a 0a20 2020 2020 2020 2063 7320 3d20  e..        cs = 
-0001bd40: 7365 6c66 2e63 6c69 656e 7473 5b22 6669  self.clients["fi
-0001bd50: 7265 2d61 6e64 2d66 6f72 6765 7422 5d0a  re-and-forget"].
-0001bd60: 2020 2020 2020 2020 6966 2074 7320 696e          if ts in
-0001bd70: 2063 732e 7761 6e74 735f 7768 6174 3a0a   cs.wants_what:.
-0001bd80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001bd90: 2e5f 636c 6965 6e74 5f72 656c 6561 7365  ._client_release
-0001bda0: 735f 6b65 7973 280a 2020 2020 2020 2020  s_keys(.        
-0001bdb0: 2020 2020 2020 2020 6373 3d63 732c 0a20          cs=cs,. 
-0001bdc0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0001bdd0: 6579 733d 5b74 732e 6b65 795d 2c0a 2020  eys=[ts.key],.  
-0001bde0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001bdf0: 636f 6d6d 656e 6461 7469 6f6e 733d 7265  commendations=re
-0001be00: 636f 6d6d 656e 6461 7469 6f6e 732c 0a20  commendations,. 
-0001be10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-0001be20: 2020 6465 6620 5f70 726f 7061 6761 7465    def _propagate
-0001be30: 5f72 656c 6561 7365 6428 7365 6c66 2c20  _released(self, 
-0001be40: 7473 3a20 5461 736b 5374 6174 652c 2072  ts: TaskState, r
-0001be50: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0001be60: 5265 6373 2920 2d3e 204e 6f6e 653a 0a20  Recs) -> None:. 
-0001be70: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-0001be80: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-0001be90: 2020 2020 206b 6579 203d 2074 732e 6b65       key = ts.ke
-0001bea0: 790a 0a20 2020 2020 2020 2069 6620 7473  y..        if ts
-0001beb0: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
-0001bec0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-0001bed0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0001bee0: 6f6e 735b 6b65 795d 203d 2022 666f 7267  ons[key] = "forg
-0001bef0: 6f74 7465 6e22 0a20 2020 2020 2020 2065  otten".        e
-0001bf00: 6c69 6620 7473 2e77 6169 7465 7273 206f  lif ts.waiters o
-0001bf10: 7220 7473 2e77 686f 5f77 616e 7473 3a0a  r ts.who_wants:.
-0001bf20: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001bf30: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
-0001bf40: 203d 2022 7761 6974 696e 6722 0a0a 2020   = "waiting"..  
-0001bf50: 2020 2020 2020 6966 2072 6563 6f6d 6d65        if recomme
-0001bf60: 6e64 6174 696f 6e73 2e67 6574 286b 6579  ndations.get(key
-0001bf70: 2920 213d 2022 7761 6974 696e 6722 3a0a  ) != "waiting":.
-0001bf80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001bf90: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0001bfa0: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-0001bfb0: 2020 2020 2020 2020 6966 2064 7473 2e73          if dts.s
-0001bfc0: 7461 7465 2021 3d20 2272 656c 6561 7365  tate != "release
-0001bfd0: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-0001bfe0: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-0001bff0: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
-0001c000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c010: 2020 2020 6966 206e 6f74 2064 7473 2e77      if not dts.w
-0001c020: 6169 7465 7273 2061 6e64 206e 6f74 2064  aiters and not d
-0001c030: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c050: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001c060: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-0001c070: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
-0001c080: 2020 2020 2020 2020 7473 2e77 6169 7465          ts.waite
-0001c090: 7273 2e63 6c65 6172 2829 0a0a 2020 2020  rs.clear()..    
-0001c0a0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-0001c0b0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-0001c0c0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-0001c0d0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-0001c0e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0001c0f0: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-0001c100: 7175 6575 6564 0a0a 2020 2020 6465 6620  queued..    def 
-0001c110: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
-0001c120: 7474 656e 280a 2020 2020 2020 2020 7365  tten(.        se
-0001c130: 6c66 2c0a 2020 2020 2020 2020 7473 3a20  lf,.        ts: 
-0001c140: 5461 736b 5374 6174 652c 0a20 2020 2020  TaskState,.     
-0001c150: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
-0001c160: 6e73 3a20 5265 6373 2c0a 2020 2020 2020  ns: Recs,.      
-0001c170: 2020 776f 726b 6572 5f6d 7367 733a 204d    worker_msgs: M
-0001c180: 7367 732c 0a20 2020 2020 2020 2073 7469  sgs,.        sti
-0001c190: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
-0001c1a0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-0001c1b0: 2020 2020 2020 7473 2e73 7461 7465 203d        ts.state =
-0001c1c0: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-0001c1d0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-0001c1e0: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
-0001c1f0: 2020 2020 2020 2020 2020 2064 7473 2e68             dts.h
-0001c200: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-0001c210: 6369 6573 203d 2054 7275 650a 2020 2020  cies = True.    
-0001c220: 2020 2020 2020 2020 6474 732e 6465 7065          dts.depe
-0001c230: 6e64 656e 6369 6573 2e72 656d 6f76 6528  ndencies.remove(
-0001c240: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-0001c250: 6474 732e 7761 6974 696e 675f 6f6e 2e64  dts.waiting_on.d
-0001c260: 6973 6361 7264 2874 7329 0a20 2020 2020  iscard(ts).     
-0001c270: 2020 2020 2020 2069 6620 6474 732e 7374         if dts.st
-0001c280: 6174 6520 6e6f 7420 696e 2028 226d 656d  ate not in ("mem
-0001c290: 6f72 7922 2c20 2265 7272 6564 2229 3a0a  ory", "erred"):.
-0001c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c2b0: 2320 4361 6e6e 6f74 2063 6f6d 7075 7465  # Cannot compute
-0001c2c0: 2074 6173 6b20 616e 796d 6f72 650a 2020   task anymore.  
-0001c2d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001c2e0: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-0001c2f0: 732e 6b65 795d 203d 2022 666f 7267 6f74  s.key] = "forgot
-0001c300: 7465 6e22 0a20 2020 2020 2020 2074 732e  ten".        ts.
-0001c310: 6465 7065 6e64 656e 7473 2e63 6c65 6172  dependents.clear
-0001c320: 2829 0a20 2020 2020 2020 2074 732e 7761  ().        ts.wa
-0001c330: 6974 6572 732e 636c 6561 7228 290a 0a20  iters.clear().. 
-0001c340: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
-0001c350: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-0001c360: 733a 0a20 2020 2020 2020 2020 2020 2064  s:.            d
-0001c370: 7473 2e64 6570 656e 6465 6e74 732e 7265  ts.dependents.re
-0001c380: 6d6f 7665 2874 7329 0a20 2020 2020 2020  move(ts).       
-0001c390: 2020 2020 2064 7473 2e77 6169 7465 7273       dts.waiters
-0001c3a0: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
-0001c3b0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-0001c3c0: 6474 732e 6465 7065 6e64 656e 7473 2061  dts.dependents a
-0001c3d0: 6e64 206e 6f74 2064 7473 2e77 686f 5f77  nd not dts.who_w
-0001c3e0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
-0001c3f0: 2020 2020 2020 2320 5461 736b 206e 6f74        # Task not
-0001c400: 206e 6565 6465 6420 616e 796d 6f72 650a   needed anymore.
-0001c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c420: 6173 7365 7274 2064 7473 2069 7320 6e6f  assert dts is no
-0001c430: 7420 7473 0a20 2020 2020 2020 2020 2020  t ts.           
-0001c440: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001c450: 696f 6e73 5b64 7473 2e6b 6579 5d20 3d20  ions[dts.key] = 
-0001c460: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
-0001c470: 2020 2020 7473 2e64 6570 656e 6465 6e63      ts.dependenc
-0001c480: 6965 732e 636c 6561 7228 290a 2020 2020  ies.clear().    
-0001c490: 2020 2020 7473 2e77 6169 7469 6e67 5f6f      ts.waiting_o
-0001c4a0: 6e2e 636c 6561 7228 290a 0a20 2020 2020  n.clear()..     
-0001c4b0: 2020 2066 6f72 2077 7320 696e 2074 732e     for ws in ts.
-0001c4c0: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-0001c4d0: 2020 2020 2069 6620 7773 2e61 6464 7265       if ws.addre
-0001c4e0: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
-0001c4f0: 7273 3a20 2023 2069 6e20 6361 7365 2077  rs:  # in case w
-0001c500: 6f72 6b65 7220 6861 7320 6469 6564 0a20  orker has died. 
-0001c510: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0001c520: 6f72 6b65 725f 6d73 6773 5b77 732e 6164  orker_msgs[ws.ad
-0001c530: 6472 6573 735d 203d 205b 0a20 2020 2020  dress] = [.     
-0001c540: 2020 2020 2020 2020 2020 2020 2020 207b                 {
-0001c550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c560: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-0001c570: 6672 6565 2d6b 6579 7322 2c0a 2020 2020  free-keys",.    
-0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c590: 2020 2020 226b 6579 7322 3a20 5b74 732e      "keys": [ts.
-0001c5a0: 6b65 795d 2c0a 2020 2020 2020 2020 2020  key],.          
-0001c5b0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
-0001c5c0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-0001c5d0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-0001c5e0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00018c30: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+00018c40: 4173 7369 676e 696e 6720 5461 736b 7320  Assigning Tasks 
+00018c50: 746f 2057 6f72 6b65 7273 2023 0a20 2020  to Workers #.   
+00018c60: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00018c70: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00018c80: 0a20 2020 2064 6566 2069 735f 726f 6f74  .    def is_root
+00018c90: 6973 6828 7365 6c66 2c20 7473 3a20 5461  ish(self, ts: Ta
+00018ca0: 736b 5374 6174 6529 202d 3e20 626f 6f6c  skState) -> bool
+00018cb0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00018cc0: 2020 2020 2020 5768 6574 6865 7220 6060        Whether ``
+00018cd0: 7473 6060 2069 7320 6120 726f 6f74 206f  ts`` is a root o
+00018ce0: 7220 726f 6f74 2d6c 696b 6520 7461 736b  r root-like task
+00018cf0: 2e0a 0a20 2020 2020 2020 2052 6f6f 742d  ...        Root-
+00018d00: 6973 6820 7461 736b 7320 6172 6520 7061  ish tasks are pa
+00018d10: 7274 206f 6620 6120 6772 6f75 7020 7468  rt of a group th
+00018d20: 6174 2773 206d 7563 6820 6c61 7267 6572  at's much larger
+00018d30: 2074 6861 6e20 7468 6520 636c 7573 7465   than the cluste
+00018d40: 722c 0a20 2020 2020 2020 2061 6e64 2068  r,.        and h
+00018d50: 6176 6520 6665 7720 6f72 206e 6f20 6465  ave few or no de
+00018d60: 7065 6e64 656e 6369 6573 2e0a 2020 2020  pendencies..    
+00018d70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00018d80: 6966 2074 732e 7265 736f 7572 6365 5f72  if ts.resource_r
+00018d90: 6573 7472 6963 7469 6f6e 7320 6f72 2074  estrictions or t
+00018da0: 732e 776f 726b 6572 5f72 6573 7472 6963  s.worker_restric
+00018db0: 7469 6f6e 7320 6f72 2074 732e 686f 7374  tions or ts.host
+00018dc0: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+00018dd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00018de0: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
+00018df0: 7467 203d 2074 732e 6772 6f75 700a 2020  tg = ts.group.  
+00018e00: 2020 2020 2020 2320 544f 444f 2073 686f        # TODO sho
+00018e10: 7274 2d63 6972 6375 6974 2074 6f20 5472  rt-circuit to Tr
+00018e20: 7565 2069 6620 606e 6f74 2074 732e 6465  ue if `not ts.de
+00018e30: 7065 6e64 656e 6369 6573 603f 0a20 2020  pendencies`?.   
+00018e40: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00018e50: 2020 2020 2020 2020 2020 6c65 6e28 7467            len(tg
+00018e60: 2920 3e20 7365 6c66 2e74 6f74 616c 5f6e  ) > self.total_n
+00018e70: 7468 7265 6164 7320 2a20 320a 2020 2020  threads * 2.    
+00018e80: 2020 2020 2020 2020 616e 6420 6c65 6e28          and len(
+00018e90: 7467 2e64 6570 656e 6465 6e63 6965 7329  tg.dependencies)
+00018ea0: 203c 2035 0a20 2020 2020 2020 2020 2020   < 5.           
+00018eb0: 2061 6e64 2073 756d 286d 6170 286c 656e   and sum(map(len
+00018ec0: 2c20 7467 2e64 6570 656e 6465 6e63 6965  , tg.dependencie
+00018ed0: 7329 2920 3c20 350a 2020 2020 2020 2020  s)) < 5.        
+00018ee0: 290a 0a20 2020 2064 6566 2063 6865 636b  )..    def check
+00018ef0: 5f69 646c 655f 7361 7475 7261 7465 6428  _idle_saturated(
+00018f00: 7365 6c66 2c20 7773 3a20 576f 726b 6572  self, ws: Worker
+00018f10: 5374 6174 652c 206f 6363 3a20 666c 6f61  State, occ: floa
+00018f20: 7420 3d20 2d31 2e30 2920 2d3e 204e 6f6e  t = -1.0) -> Non
+00018f30: 653a 0a20 2020 2020 2020 2022 2222 5570  e:.        """Up
+00018f40: 6461 7465 2074 6865 2073 7461 7475 7320  date the status 
+00018f50: 6f66 2074 6865 2069 646c 6520 616e 6420  of the idle and 
+00018f60: 7361 7475 7261 7465 6420 7374 6174 650a  saturated state.
+00018f70: 0a20 2020 2020 2020 2054 6865 2073 6368  .        The sch
+00018f80: 6564 756c 6572 206b 6565 7073 2074 7261  eduler keeps tra
+00018f90: 636b 206f 6620 776f 726b 6572 7320 7468  ck of workers th
+00018fa0: 6174 2061 7265 202e 2e0a 0a20 2020 2020  at are ....     
+00018fb0: 2020 202d 2020 5361 7475 7261 7465 643a     -  Saturated:
+00018fc0: 2068 6176 6520 656e 6f75 6768 2077 6f72   have enough wor
+00018fd0: 6b20 746f 2073 7461 7920 6275 7379 0a20  k to stay busy. 
+00018fe0: 2020 2020 2020 202d 2020 4964 6c65 3a20         -  Idle: 
+00018ff0: 646f 206e 6f74 2068 6176 6520 656e 6f75  do not have enou
+00019000: 6768 2077 6f72 6b20 746f 2073 7461 7920  gh work to stay 
+00019010: 6275 7379 0a0a 2020 2020 2020 2020 5468  busy..        Th
+00019020: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
+00019030: 6420 7361 7475 7261 7465 6420 6966 2074  d saturated if t
+00019040: 6865 7920 626f 7468 2068 6176 6520 656e  hey both have en
+00019050: 6f75 6768 2074 6173 6b73 2074 6f20 6f63  ough tasks to oc
+00019060: 6375 7079 0a20 2020 2020 2020 2061 6c6c  cupy.        all
+00019070: 206f 6620 7468 6569 7220 7468 7265 6164   of their thread
+00019080: 732c 2061 6e64 2069 6620 7468 6520 6578  s, and if the ex
+00019090: 7065 6374 6564 2072 756e 7469 6d65 206f  pected runtime o
+000190a0: 6620 7468 6f73 6520 7461 736b 7320 6973  f those tasks is
+000190b0: 0a20 2020 2020 2020 206c 6172 6765 2065  .        large e
+000190c0: 6e6f 7567 682e 0a0a 2020 2020 2020 2020  nough...        
+000190d0: 4966 2060 6064 6973 7472 6962 7574 6564  If ``distributed
+000190e0: 2e73 6368 6564 756c 6572 2e77 6f72 6b65  .scheduler.worke
+000190f0: 722d 7361 7475 7261 7469 6f6e 6060 2069  r-saturation`` i
+00019100: 7320 6e6f 7420 6060 696e 6660 600a 2020  s not ``inf``.  
+00019110: 2020 2020 2020 2873 6368 6564 756c 6572        (scheduler
+00019120: 2d73 6964 6520 7175 6575 696e 6720 6973  -side queuing is
+00019130: 2065 6e61 626c 6564 292c 2074 6865 7920   enabled), they 
+00019140: 6172 6520 636f 6e73 6964 6572 6564 2069  are considered i
+00019150: 646c 650a 2020 2020 2020 2020 6966 2074  dle.        if t
+00019160: 6865 7920 6861 7665 2066 6577 6572 2074  hey have fewer t
+00019170: 6173 6b73 2070 726f 6365 7373 696e 6720  asks processing 
+00019180: 7468 616e 2074 6865 2060 6077 6f72 6b65  than the ``worke
+00019190: 722d 7361 7475 7261 7469 6f6e 6060 0a20  r-saturation``. 
+000191a0: 2020 2020 2020 2074 6872 6573 686f 6c64         threshold
+000191b0: 2064 6963 7461 7465 732e 0a0a 2020 2020   dictates...    
+000191c0: 2020 2020 4f74 6865 7277 6973 652c 2074      Otherwise, t
+000191d0: 6865 7920 6172 6520 636f 6e73 6964 6572  hey are consider
+000191e0: 6564 2069 646c 6520 6966 2074 6865 7920  ed idle if they 
+000191f0: 6861 7665 2066 6577 6572 2074 6173 6b73  have fewer tasks
+00019200: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
+00019210: 2020 2020 7468 616e 2074 6872 6561 6473      than threads
+00019220: 2c20 6f72 2069 6620 7468 6569 7220 7461  , or if their ta
+00019230: 736b 7327 2074 6f74 616c 2065 7870 6563  sks' total expec
+00019240: 7465 6420 7275 6e74 696d 6520 6973 206c  ted runtime is l
+00019250: 6573 7320 7468 616e 2068 616c 660a 2020  ess than half.  
+00019260: 2020 2020 2020 7468 6520 6578 7065 6374        the expect
+00019270: 6564 2072 756e 7469 6d65 206f 6620 7468  ed runtime of th
+00019280: 6520 7361 6d65 206e 756d 6265 7220 6f66  e same number of
+00019290: 2061 7665 7261 6765 2074 6173 6b73 2e0a   average tasks..
+000192a0: 0a20 2020 2020 2020 2054 6869 7320 6973  .        This is
+000192b0: 2075 7365 6675 6c20 666f 7220 6c6f 6164   useful for load
+000192c0: 2062 616c 616e 6369 6e67 2061 6e64 2061   balancing and a
+000192d0: 6461 7074 6976 6974 792e 0a20 2020 2020  daptivity..     
+000192e0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000192f0: 6620 7365 6c66 2e74 6f74 616c 5f6e 7468  f self.total_nth
+00019300: 7265 6164 7320 3d3d 2030 206f 7220 7773  reads == 0 or ws
+00019310: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00019320: 732e 636c 6f73 6564 3a0a 2020 2020 2020  s.closed:.      
+00019330: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00019340: 2020 2020 2069 6620 6f63 6320 3c20 303a       if occ < 0:
+00019350: 0a20 2020 2020 2020 2020 2020 206f 6363  .            occ
+00019360: 203d 2077 732e 6f63 6375 7061 6e63 790a   = ws.occupancy.
+00019370: 0a20 2020 2020 2020 2070 203d 206c 656e  .        p = len
+00019380: 2877 732e 7072 6f63 6573 7369 6e67 290a  (ws.processing).
+00019390: 0a20 2020 2020 2020 2073 656c 662e 7361  .        self.sa
+000193a0: 7475 7261 7465 642e 6469 7363 6172 6428  turated.discard(
+000193b0: 7773 290a 2020 2020 2020 2020 6966 2077  ws).        if w
+000193c0: 732e 7374 6174 7573 2021 3d20 5374 6174  s.status != Stat
+000193d0: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
+000193e0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+000193f0: 652e 706f 7028 7773 2e61 6464 7265 7373  e.pop(ws.address
+00019400: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+00019410: 656c 6966 2073 656c 662e 6973 5f75 6e6f  elif self.is_uno
+00019420: 6363 7570 6965 6428 7773 2c20 6f63 632c  ccupied(ws, occ,
+00019430: 2070 293a 0a20 2020 2020 2020 2020 2020   p):.           
+00019440: 2073 656c 662e 6964 6c65 5b77 732e 6164   self.idle[ws.ad
+00019450: 6472 6573 735d 203d 2077 730a 2020 2020  dress] = ws.    
+00019460: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00019470: 2020 2020 2020 7365 6c66 2e69 646c 652e        self.idle.
+00019480: 706f 7028 7773 2e61 6464 7265 7373 2c20  pop(ws.address, 
+00019490: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+000194a0: 2020 6e63 203d 2077 732e 6e74 6872 6561    nc = ws.nthrea
+000194b0: 6473 0a20 2020 2020 2020 2020 2020 2069  ds.            i
+000194c0: 6620 7020 3e20 6e63 3a0a 2020 2020 2020  f p > nc:.      
+000194d0: 2020 2020 2020 2020 2020 7065 6e64 696e            pendin
+000194e0: 6720 3d20 6f63 6320 2a20 2870 202d 206e  g = occ * (p - n
+000194f0: 6329 202f 2028 7020 2a20 6e63 290a 2020  c) / (p * nc).  
+00019500: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00019510: 2030 2e34 203c 2070 656e 6469 6e67 203e   0.4 < pending >
+00019520: 2031 2e39 202a 2028 7365 6c66 2e74 6f74   1.9 * (self.tot
+00019530: 616c 5f6f 6363 7570 616e 6379 202f 2073  al_occupancy / s
+00019540: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
+00019550: 6473 293a 0a20 2020 2020 2020 2020 2020  ds):.           
+00019560: 2020 2020 2020 2020 2073 656c 662e 7361           self.sa
+00019570: 7475 7261 7465 642e 6164 6428 7773 290a  turated.add(ws).
+00019580: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00019590: 5f77 6f72 6b65 725f 6675 6c6c 2877 732c  _worker_full(ws,
+000195a0: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
+000195b0: 5552 4154 494f 4e29 2061 6e64 2077 732e  URATION) and ws.
+000195c0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+000195d0: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+000195e0: 2020 2020 2020 7365 6c66 2e69 646c 655f        self.idle_
+000195f0: 7461 736b 5f63 6f75 6e74 2e61 6464 2877  task_count.add(w
+00019600: 7329 0a20 2020 2020 2020 2065 6c73 653a  s).        else:
+00019610: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00019620: 662e 6964 6c65 5f74 6173 6b5f 636f 756e  f.idle_task_coun
+00019630: 742e 6469 7363 6172 6428 7773 290a 0a20  t.discard(ws).. 
+00019640: 2020 2064 6566 2069 735f 756e 6f63 6375     def is_unoccu
+00019650: 7069 6564 280a 2020 2020 2020 2020 7365  pied(.        se
+00019660: 6c66 2c20 7773 3a20 576f 726b 6572 5374  lf, ws: WorkerSt
+00019670: 6174 652c 206f 6363 7570 616e 6379 3a20  ate, occupancy: 
+00019680: 666c 6f61 742c 206e 7072 6f63 6573 7369  float, nprocessi
+00019690: 6e67 3a20 696e 740a 2020 2020 2920 2d3e  ng: int.    ) ->
+000196a0: 2062 6f6f 6c3a 0a20 2020 2020 2020 206e   bool:.        n
+000196b0: 7468 7265 6164 7320 3d20 7773 2e6e 7468  threads = ws.nth
+000196c0: 7265 6164 730a 2020 2020 2020 2020 7265  reads.        re
+000196d0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+000196e0: 2020 206e 7072 6f63 6573 7369 6e67 203c     nprocessing <
+000196f0: 206e 7468 7265 6164 730a 2020 2020 2020   nthreads.      
+00019700: 2020 2020 2020 6f72 206f 6363 7570 616e        or occupan
+00019710: 6379 203c 206e 7468 7265 6164 7320 2a20  cy < nthreads * 
+00019720: 2873 656c 662e 746f 7461 6c5f 6f63 6375  (self.total_occu
+00019730: 7061 6e63 7920 2f20 7365 6c66 2e74 6f74  pancy / self.tot
+00019740: 616c 5f6e 7468 7265 6164 7329 202f 2032  al_nthreads) / 2
+00019750: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00019760: 6465 6620 6765 745f 636f 6d6d 5f63 6f73  def get_comm_cos
+00019770: 7428 7365 6c66 2c20 7473 3a20 5461 736b  t(self, ts: Task
+00019780: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
+00019790: 7253 7461 7465 2920 2d3e 2066 6c6f 6174  rState) -> float
+000197a0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000197b0: 2020 2020 2020 4765 7420 7468 6520 6573        Get the es
+000197c0: 7469 6d61 7465 6420 636f 6d6d 756e 6963  timated communic
+000197d0: 6174 696f 6e20 636f 7374 2028 696e 2073  ation cost (in s
+000197e0: 2e29 2074 6f20 636f 6d70 7574 6520 7468  .) to compute th
+000197f0: 6520 7461 736b 0a20 2020 2020 2020 206f  e task.        o
+00019800: 6e20 7468 6520 6769 7665 6e20 776f 726b  n the given work
+00019810: 6572 2e0a 2020 2020 2020 2020 2222 220a  er..        """.
+00019820: 2020 2020 2020 2020 6966 2031 3020 2a20          if 10 * 
+00019830: 6c65 6e28 7473 2e64 6570 656e 6465 6e63  len(ts.dependenc
+00019840: 6965 7329 203c 206c 656e 2877 732e 6861  ies) < len(ws.ha
+00019850: 735f 7768 6174 293a 0a20 2020 2020 2020  s_what):.       
+00019860: 2020 2020 2023 2049 6e20 7468 6520 636f       # In the co
+00019870: 6d6d 6f6e 2063 6173 6520 7768 6572 6520  mmon case where 
+00019880: 7468 6520 6e75 6d62 6572 206f 6620 6465  the number of de
+00019890: 7065 6e64 656e 6369 6573 2069 730a 2020  pendencies is.  
+000198a0: 2020 2020 2020 2020 2020 2320 6d75 6368            # much
+000198b0: 206c 6573 7320 7468 616e 2074 6865 206e   less than the n
+000198c0: 756d 6265 7220 6f66 2074 6173 6b73 2074  umber of tasks t
+000198d0: 6861 7420 7765 2068 6176 652c 0a20 2020  hat we have,.   
+000198e0: 2020 2020 2020 2020 2023 2063 6f6e 7374           # const
+000198f0: 7275 6374 2074 6865 2073 6574 206f 6620  ruct the set of 
+00019900: 6465 7073 2074 6861 7420 7265 7175 6972  deps that requir
+00019910: 6520 636f 6d6d 756e 6963 6174 696f 6e20  e communication 
+00019920: 696e 0a20 2020 2020 2020 2020 2020 2023  in.            #
+00019930: 204f 286c 656e 2864 6570 656e 6465 6e63   O(len(dependenc
+00019940: 6965 7329 2920 7261 7468 6572 2074 6861  ies)) rather tha
+00019950: 6e20 4f28 6c65 6e28 6861 735f 7768 6174  n O(len(has_what
+00019960: 2929 2074 696d 652e 0a20 2020 2020 2020  )) time..       
+00019970: 2020 2020 2023 2046 6163 746f 7220 6f66       # Factor of
+00019980: 2031 3020 6973 2061 2067 7565 7373 2061   10 is a guess a
+00019990: 7420 7468 6520 6f76 6572 6865 6164 206f  t the overhead o
+000199a0: 6620 6578 706c 6963 6974 0a20 2020 2020  f explicit.     
+000199b0: 2020 2020 2020 2023 2069 7465 7261 7469         # iterati
+000199c0: 6f6e 2061 7320 6f70 706f 7365 6420 746f  on as opposed to
+000199d0: 206a 7573 7420 6361 6c6c 696e 6720 7365   just calling se
+000199e0: 742e 6469 6666 6572 656e 6365 0a20 2020  t.difference.   
+000199f0: 2020 2020 2020 2020 2064 6570 7320 3d20           deps = 
+00019a00: 7b64 6570 2066 6f72 2064 6570 2069 6e20  {dep for dep in 
+00019a10: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
+00019a20: 6966 2064 6570 206e 6f74 2069 6e20 7773  if dep not in ws
+00019a30: 2e68 6173 5f77 6861 747d 0a20 2020 2020  .has_what}.     
+00019a40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00019a50: 2020 2020 2064 6570 7320 3d20 7473 2e64       deps = ts.d
+00019a60: 6570 656e 6465 6e63 6965 732e 6469 6666  ependencies.diff
+00019a70: 6572 656e 6365 2877 732e 6861 735f 7768  erence(ws.has_wh
+00019a80: 6174 290a 2020 2020 2020 2020 6e62 7974  at).        nbyt
+00019a90: 6573 203d 2073 756d 2864 7473 2e6e 6279  es = sum(dts.nby
+00019aa0: 7465 7320 666f 7220 6474 7320 696e 2064  tes for dts in d
+00019ab0: 6570 7329 0a20 2020 2020 2020 2072 6574  eps).        ret
+00019ac0: 7572 6e20 6e62 7974 6573 202f 2073 656c  urn nbytes / sel
+00019ad0: 662e 6261 6e64 7769 6474 680a 0a20 2020  f.bandwidth..   
+00019ae0: 2064 6566 2067 6574 5f74 6173 6b5f 6475   def get_task_du
+00019af0: 7261 7469 6f6e 2873 656c 662c 2074 733a  ration(self, ts:
+00019b00: 2054 6173 6b53 7461 7465 2920 2d3e 2066   TaskState) -> f
+00019b10: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
+00019b20: 2247 6574 2074 6865 2065 7374 696d 6174  "Get the estimat
+00019b30: 6564 2063 6f6d 7075 7461 7469 6f6e 2063  ed computation c
+00019b40: 6f73 7420 6f66 2074 6865 2067 6976 656e  ost of the given
+00019b50: 2074 6173 6b20 286e 6f74 2069 6e63 6c75   task (not inclu
+00019b60: 6469 6e67 0a20 2020 2020 2020 2061 6e79  ding.        any
+00019b70: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2063   communication c
+00019b80: 6f73 7429 2e0a 0a20 2020 2020 2020 2049  ost)...        I
+00019b90: 6620 6e6f 2064 6174 6120 6861 7320 6265  f no data has be
+00019ba0: 656e 206f 6273 6572 7665 642c 2076 616c  en observed, val
+00019bb0: 7565 206f 660a 2020 2020 2020 2020 6064  ue of.        `d
+00019bc0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+00019bd0: 756c 6572 2e64 6566 6175 6c74 2d74 6173  uler.default-tas
+00019be0: 6b2d 6475 7261 7469 6f6e 7360 2061 7265  k-durations` are
+00019bf0: 2075 7365 642e 2049 6620 6e6f 6e65 2069   used. If none i
+00019c00: 7320 7365 740a 2020 2020 2020 2020 666f  s set.        fo
+00019c10: 7220 7468 6973 2074 6173 6b2c 2060 6469  r this task, `di
+00019c20: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
+00019c30: 6c65 722e 756e 6b6e 6f77 6e2d 7461 736b  ler.unknown-task
+00019c40: 2d64 7572 6174 696f 6e60 2069 7320 7573  -duration` is us
+00019c50: 6564 0a20 2020 2020 2020 2069 6e73 7465  ed.        inste
+00019c60: 6164 2e0a 2020 2020 2020 2020 2222 220a  ad..        """.
+00019c70: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+00019c80: 3a20 666c 6f61 7420 3d20 7473 2e70 7265  : float = ts.pre
+00019c90: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+00019ca0: 7261 6765 0a20 2020 2020 2020 2069 6620  rage.        if 
+00019cb0: 6475 7261 7469 6f6e 203e 3d20 303a 0a20  duration >= 0:. 
+00019cc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00019cd0: 6e20 6475 7261 7469 6f6e 0a0a 2020 2020  n duration..    
+00019ce0: 2020 2020 7320 3d20 7365 6c66 2e75 6e6b      s = self.unk
+00019cf0: 6e6f 776e 5f64 7572 6174 696f 6e73 2e67  nown_durations.g
+00019d00: 6574 2874 732e 7072 6566 6978 2e6e 616d  et(ts.prefix.nam
+00019d10: 6529 0a20 2020 2020 2020 2069 6620 7320  e).        if s 
+00019d20: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00019d30: 2020 2020 2073 656c 662e 756e 6b6e 6f77       self.unknow
+00019d40: 6e5f 6475 7261 7469 6f6e 735b 7473 2e70  n_durations[ts.p
+00019d50: 7265 6669 782e 6e61 6d65 5d20 3d20 7320  refix.name] = s 
+00019d60: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00019d70: 732e 6164 6428 7473 290a 2020 2020 2020  s.add(ts).      
+00019d80: 2020 7265 7475 726e 2073 656c 662e 554e    return self.UN
+00019d90: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
+00019da0: 494f 4e0a 0a20 2020 2064 6566 2076 616c  ION..    def val
+00019db0: 6964 5f77 6f72 6b65 7273 2873 656c 662c  id_workers(self,
+00019dc0: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
+00019dd0: 2d3e 2073 6574 5b57 6f72 6b65 7253 7461  -> set[WorkerSta
+00019de0: 7465 5d20 7c20 4e6f 6e65 3a0a 2020 2020  te] | None:.    
+00019df0: 2020 2020 2222 2252 6574 7572 6e20 7365      """Return se
+00019e00: 7420 6f66 2063 7572 7265 6e74 6c79 2076  t of currently v
+00019e10: 616c 6964 2077 6f72 6b65 7273 2066 6f72  alid workers for
+00019e20: 206b 6579 0a0a 2020 2020 2020 2020 4966   key..        If
+00019e30: 2061 6c6c 2077 6f72 6b65 7273 2061 7265   all workers are
+00019e40: 2076 616c 6964 2074 6865 6e20 7468 6973   valid then this
+00019e50: 2072 6574 7572 6e73 2060 604e 6f6e 6560   returns ``None`
+00019e60: 602c 2069 6e20 7768 6963 6820 6361 7365  `, in which case
+00019e70: 0a20 2020 2020 2020 2061 6e79 202a 7275  .        any *ru
+00019e80: 6e6e 696e 672a 2077 6f72 6b65 7220 6361  nning* worker ca
+00019e90: 6e20 6265 2075 7365 642e 0a20 2020 2020  n be used..     
+00019ea0: 2020 204f 7468 6572 7769 7365 2c20 7468     Otherwise, th
+00019eb0: 6520 7375 6273 6574 206f 6620 7275 6e6e  e subset of runn
+00019ec0: 696e 6720 776f 726b 6572 7320 7661 6c69  ing workers vali
+00019ed0: 6420 666f 7220 7468 6973 2074 6173 6b0a  d for this task.
+00019ee0: 2020 2020 2020 2020 6973 2072 6574 7572          is retur
+00019ef0: 6e65 642e 0a20 2020 2020 2020 2054 6869  ned..        Thi
+00019f00: 7320 6368 6563 6b73 2074 7261 636b 7320  s checks tracks 
+00019f10: 7468 6520 666f 6c6c 6f77 696e 6720 7374  the following st
+00019f20: 6174 653a 0a0a 2020 2020 2020 2020 2a20  ate:..        * 
+00019f30: 2077 6f72 6b65 725f 7265 7374 7269 6374   worker_restrict
+00019f40: 696f 6e73 0a20 2020 2020 2020 202a 2020  ions.        *  
+00019f50: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+00019f60: 730a 2020 2020 2020 2020 2a20 2072 6573  s.        *  res
+00019f70: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+00019f80: 6e73 0a20 2020 2020 2020 2022 2222 0a20  ns.        """. 
+00019f90: 2020 2020 2020 2073 3a20 7365 745b 7374         s: set[st
+00019fa0: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
+00019fb0: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+00019fc0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+00019fd0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00019fe0: 2073 203d 207b 6164 6472 2066 6f72 2061   s = {addr for a
+00019ff0: 6464 7220 696e 2074 732e 776f 726b 6572  ddr in ts.worker
+0001a000: 5f72 6573 7472 6963 7469 6f6e 7320 6966  _restrictions if
+0001a010: 2061 6464 7220 696e 2073 656c 662e 776f   addr in self.wo
+0001a020: 726b 6572 737d 0a0a 2020 2020 2020 2020  rkers}..        
+0001a030: 6966 2074 732e 686f 7374 5f72 6573 7472  if ts.host_restr
+0001a040: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+0001a050: 2020 2020 2023 2052 6573 6f6c 7665 2074       # Resolve t
+0001a060: 6865 2061 6c69 6173 2068 6572 6520 7261  he alias here ra
+0001a070: 7468 6572 2074 6861 6e20 6561 726c 792c  ther than early,
+0001a080: 2066 6f72 2074 6865 2077 6f72 6b65 720a   for the worker.
+0001a090: 2020 2020 2020 2020 2020 2020 2320 6d61              # ma
+0001a0a0: 7920 6e6f 7420 6265 2063 6f6e 6e65 6374  y not be connect
+0001a0b0: 6564 2077 6865 6e20 686f 7374 5f72 6573  ed when host_res
+0001a0c0: 7472 6963 7469 6f6e 7320 6973 2070 6f70  trictions is pop
+0001a0d0: 756c 6174 6564 0a20 2020 2020 2020 2020  ulated.         
+0001a0e0: 2020 2068 7220 3d20 5b73 656c 662e 636f     hr = [self.co
+0001a0f0: 6572 6365 5f68 6f73 746e 616d 6528 6829  erce_hostname(h)
+0001a100: 2066 6f72 2068 2069 6e20 7473 2e68 6f73   for h in ts.hos
+0001a110: 745f 7265 7374 7269 6374 696f 6e73 5d0a  t_restrictions].
+0001a120: 2020 2020 2020 2020 2020 2020 2320 5858              # XX
+0001a130: 5820 6e65 6564 2048 6f73 7453 7461 7465  X need HostState
+0001a140: 3f0a 2020 2020 2020 2020 2020 2020 736c  ?.            sl
+0001a150: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0001a160: 2020 666f 7220 6820 696e 2068 723a 0a20    for h in hr:. 
+0001a170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001a180: 6820 3d20 7365 6c66 2e68 6f73 745f 696e  h = self.host_in
+0001a190: 666f 2e67 6574 2868 290a 2020 2020 2020  fo.get(h).      
+0001a1a0: 2020 2020 2020 2020 2020 6966 2064 6820            if dh 
+0001a1b0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001a1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a1d0: 2073 6c2e 6170 7065 6e64 2864 685b 2261   sl.append(dh["a
+0001a1e0: 6464 7265 7373 6573 225d 290a 0a20 2020  ddresses"])..   
+0001a1f0: 2020 2020 2020 2020 2073 7320 3d20 7365           ss = se
+0001a200: 742e 756e 696f 6e28 2a73 6c29 2069 6620  t.union(*sl) if 
+0001a210: 736c 2065 6c73 6520 7365 7428 290a 2020  sl else set().  
+0001a220: 2020 2020 2020 2020 2020 6966 2073 2069            if s i
+0001a230: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0001a240: 2020 2020 2020 2020 7320 3d20 7373 0a20          s = ss. 
+0001a250: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001a260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a270: 2073 207c 3d20 7373 0a0a 2020 2020 2020   s |= ss..      
+0001a280: 2020 6966 2074 732e 7265 736f 7572 6365    if ts.resource
+0001a290: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+0001a2a0: 2020 2020 2020 2020 2020 2064 7720 3d20             dw = 
+0001a2b0: 7b7d 0a20 2020 2020 2020 2020 2020 2066  {}.            f
+0001a2c0: 6f72 2072 6573 6f75 7263 652c 2072 6571  or resource, req
+0001a2d0: 7569 7265 6420 696e 2074 732e 7265 736f  uired in ts.reso
+0001a2e0: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
+0001a2f0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0001a300: 2020 2020 2020 2020 2020 2064 7220 3d20             dr = 
+0001a310: 7365 6c66 2e72 6573 6f75 7263 6573 2e67  self.resources.g
+0001a320: 6574 2872 6573 6f75 7263 6529 0a20 2020  et(resource).   
+0001a330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001a340: 6472 2069 7320 4e6f 6e65 3a0a 2020 2020  dr is None:.    
+0001a350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a360: 7365 6c66 2e72 6573 6f75 7263 6573 5b72  self.resources[r
+0001a370: 6573 6f75 7263 655d 203d 2064 7220 3d20  esource] = dr = 
+0001a380: 7b7d 0a0a 2020 2020 2020 2020 2020 2020  {}..            
+0001a390: 2020 2020 7377 203d 2073 6574 2829 0a20      sw = set(). 
+0001a3a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001a3b0: 6f72 2061 6464 722c 2073 7570 706c 6965  or addr, supplie
+0001a3c0: 6420 696e 2064 722e 6974 656d 7328 293a  d in dr.items():
+0001a3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a3e0: 2020 2020 2069 6620 7375 7070 6c69 6564       if supplied
+0001a3f0: 203e 3d20 7265 7175 6972 6564 3a0a 2020   >= required:.  
+0001a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a410: 2020 2020 2020 7377 2e61 6464 2861 6464        sw.add(add
+0001a420: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+0001a430: 2020 2020 6477 5b72 6573 6f75 7263 655d      dw[resource]
+0001a440: 203d 2073 770a 0a20 2020 2020 2020 2020   = sw..         
+0001a450: 2020 2077 7720 3d20 7365 742e 696e 7465     ww = set.inte
+0001a460: 7273 6563 7469 6f6e 282a 6477 2e76 616c  rsection(*dw.val
+0001a470: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+0001a480: 2020 2069 6620 7320 6973 204e 6f6e 653a     if s is None:
+0001a490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a4a0: 2073 203d 2077 770a 2020 2020 2020 2020   s = ww.        
+0001a4b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0001a4c0: 2020 2020 2020 2020 2020 7320 263d 2077            s &= w
+0001a4d0: 770a 0a20 2020 2020 2020 2069 6620 7320  w..        if s 
+0001a4e0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001a4f0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+0001a500: 2020 2320 416c 6c20 776f 726b 6572 7320    # All workers 
+0001a510: 6172 6520 7661 6c69 640a 2020 2020 2020  are valid.      
+0001a520: 2020 6966 206e 6f74 2073 3a0a 2020 2020    if not s:.    
+0001a530: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001a540: 6574 2829 2020 2320 4e6f 2077 6f72 6b65  et()  # No worke
+0001a550: 7273 2061 7265 2076 616c 6964 0a0a 2020  rs are valid..  
+0001a560: 2020 2020 2020 2320 536f 6d65 2077 6f72        # Some wor
+0001a570: 6b65 7273 2061 7265 2076 616c 6964 0a20  kers are valid. 
+0001a580: 2020 2020 2020 2073 5f77 7320 3d20 7b73         s_ws = {s
+0001a590: 656c 662e 776f 726b 6572 735b 6164 6472  elf.workers[addr
+0001a5a0: 5d20 666f 7220 6164 6472 2069 6e20 737d  ] for addr in s}
+0001a5b0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+0001a5c0: 7365 6c66 2e72 756e 6e69 6e67 2920 3c20  self.running) < 
+0001a5d0: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
+0001a5e0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0001a5f0: 5f77 7320 263d 2073 656c 662e 7275 6e6e  _ws &= self.runn
+0001a600: 696e 670a 2020 2020 2020 2020 7265 7475  ing.        retu
+0001a610: 726e 2073 5f77 730a 0a20 2020 2064 6566  rn s_ws..    def
+0001a620: 2061 6371 7569 7265 5f72 6573 6f75 7263   acquire_resourc
+0001a630: 6573 2873 656c 662c 2074 733a 2054 6173  es(self, ts: Tas
+0001a640: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
+0001a650: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
+0001a660: 3a0a 2020 2020 2020 2020 666f 7220 722c  :.        for r,
+0001a670: 2072 6571 7569 7265 6420 696e 2074 732e   required in ts.
+0001a680: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+0001a690: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
+0001a6a0: 2020 2020 2020 2020 2020 2077 732e 7573             ws.us
+0001a6b0: 6564 5f72 6573 6f75 7263 6573 5b72 5d20  ed_resources[r] 
+0001a6c0: 2b3d 2072 6571 7569 7265 640a 0a20 2020  += required..   
+0001a6d0: 2064 6566 2072 656c 6561 7365 5f72 6573   def release_res
+0001a6e0: 6f75 7263 6573 2873 656c 662c 2074 733a  ources(self, ts:
+0001a6f0: 2054 6173 6b53 7461 7465 2c20 7773 3a20   TaskState, ws: 
+0001a700: 576f 726b 6572 5374 6174 6529 202d 3e20  WorkerState) -> 
+0001a710: 4e6f 6e65 3a0a 2020 2020 2020 2020 666f  None:.        fo
+0001a720: 7220 722c 2072 6571 7569 7265 6420 696e  r r, required in
+0001a730: 2074 732e 7265 736f 7572 6365 5f72 6573   ts.resource_res
+0001a740: 7472 6963 7469 6f6e 732e 6974 656d 7328  trictions.items(
+0001a750: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+0001a760: 732e 7573 6564 5f72 6573 6f75 7263 6573  s.used_resources
+0001a770: 5b72 5d20 2d3d 2072 6571 7569 7265 640a  [r] -= required.
+0001a780: 0a20 2020 2064 6566 2063 6f65 7263 655f  .    def coerce_
+0001a790: 686f 7374 6e61 6d65 2873 656c 662c 2068  hostname(self, h
+0001a7a0: 6f73 743a 2048 6173 6861 626c 6529 202d  ost: Hashable) -
+0001a7b0: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
+0001a7c0: 2222 0a20 2020 2020 2020 2043 6f65 7263  "".        Coerc
+0001a7d0: 6520 7468 6520 686f 7374 6e61 6d65 206f  e the hostname o
+0001a7e0: 6620 6120 776f 726b 6572 2e0a 2020 2020  f a worker..    
+0001a7f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001a800: 616c 6961 7320 3d20 7365 6c66 2e61 6c69  alias = self.ali
+0001a810: 6173 6573 2e67 6574 2868 6f73 7429 0a20  ases.get(host). 
+0001a820: 2020 2020 2020 2069 6620 616c 6961 7320         if alias 
+0001a830: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0001a840: 2020 2020 2020 2020 2077 7320 3d20 7365           ws = se
+0001a850: 6c66 2e77 6f72 6b65 7273 5b61 6c69 6173  lf.workers[alias
+0001a860: 5d0a 2020 2020 2020 2020 2020 2020 7265  ].            re
+0001a870: 7475 726e 2077 732e 686f 7374 0a20 2020  turn ws.host.   
+0001a880: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001a890: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0001a8a0: 696e 7374 616e 6365 2868 6f73 742c 2073  instance(host, s
+0001a8b0: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
+0001a8c0: 7265 7475 726e 2068 6f73 740a 0a20 2020  return host..   
+0001a8d0: 2064 6566 2077 6f72 6b65 725f 6f62 6a65   def worker_obje
+0001a8e0: 6374 6976 6528 7365 6c66 2c20 7473 3a20  ctive(self, ts: 
+0001a8f0: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
+0001a900: 6f72 6b65 7253 7461 7465 2920 2d3e 2074  orkerState) -> t
+0001a910: 7570 6c65 3a0a 2020 2020 2020 2020 2222  uple:.        ""
+0001a920: 224f 626a 6563 7469 7665 2066 756e 6374  "Objective funct
+0001a930: 696f 6e20 746f 2064 6574 6572 6d69 6e65  ion to determine
+0001a940: 2077 6869 6368 2077 6f72 6b65 7220 7368   which worker sh
+0001a950: 6f75 6c64 2067 6574 2074 6865 2074 6173  ould get the tas
+0001a960: 6b0a 0a20 2020 2020 2020 204d 696e 696d  k..        Minim
+0001a970: 697a 6520 6578 7065 6374 6564 2073 7461  ize expected sta
+0001a980: 7274 2074 696d 652e 2020 4966 2061 2074  rt time.  If a t
+0001a990: 6965 2074 6865 6e20 6272 6561 6b20 7769  ie then break wi
+0001a9a0: 7468 2064 6174 6120 7374 6f72 6167 652e  th data storage.
+0001a9b0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001a9c0: 2020 2020 2063 6f6d 6d5f 6279 7465 7320       comm_bytes 
+0001a9d0: 3d20 7375 6d28 0a20 2020 2020 2020 2020  = sum(.         
+0001a9e0: 2020 2064 7473 2e67 6574 5f6e 6279 7465     dts.get_nbyte
+0001a9f0: 7328 2920 666f 7220 6474 7320 696e 2074  s() for dts in t
+0001aa00: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+0001aa10: 6620 7773 206e 6f74 2069 6e20 6474 732e  f ws not in dts.
+0001aa20: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+0001aa30: 290a 0a20 2020 2020 2020 2073 7461 636b  )..        stack
+0001aa40: 5f74 696d 6520 3d20 7773 2e6f 6363 7570  _time = ws.occup
+0001aa50: 616e 6379 202f 2077 732e 6e74 6872 6561  ancy / ws.nthrea
+0001aa60: 6473 0a20 2020 2020 2020 2073 7461 7274  ds.        start
+0001aa70: 5f74 696d 6520 3d20 7374 6163 6b5f 7469  _time = stack_ti
+0001aa80: 6d65 202b 2063 6f6d 6d5f 6279 7465 7320  me + comm_bytes 
+0001aa90: 2f20 7365 6c66 2e62 616e 6477 6964 7468  / self.bandwidth
+0001aaa0: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+0001aab0: 6163 746f 723a 0a20 2020 2020 2020 2020  actor:.         
+0001aac0: 2020 2072 6574 7572 6e20 286c 656e 2877     return (len(w
+0001aad0: 732e 6163 746f 7273 292c 2073 7461 7274  s.actors), start
+0001aae0: 5f74 696d 652c 2077 732e 6e62 7974 6573  _time, ws.nbytes
+0001aaf0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001ab00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001ab10: 726e 2028 7374 6172 745f 7469 6d65 2c20  rn (start_time, 
+0001ab20: 7773 2e6e 6279 7465 7329 0a0a 2020 2020  ws.nbytes)..    
+0001ab30: 6465 6620 6164 645f 7265 706c 6963 6128  def add_replica(
+0001ab40: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+0001ab50: 6174 652c 2077 733a 2057 6f72 6b65 7253  ate, ws: WorkerS
+0001ab60: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
+0001ab70: 2020 2020 2020 2022 2222 4e6f 7465 2074         """Note t
+0001ab80: 6861 7420 6120 776f 726b 6572 2068 6f6c  hat a worker hol
+0001ab90: 6473 2061 2072 6570 6c69 6361 206f 6620  ds a replica of 
+0001aba0: 6120 7461 736b 2077 6974 6820 7374 6174  a task with stat
+0001abb0: 653d 276d 656d 6f72 7927 2222 220a 2020  e='memory'""".  
+0001abc0: 2020 2020 2020 7773 2e61 6464 5f72 6570        ws.add_rep
+0001abd0: 6c69 6361 2874 7329 0a20 2020 2020 2020  lica(ts).       
+0001abe0: 2069 6620 6c65 6e28 7473 2e77 686f 5f68   if len(ts.who_h
+0001abf0: 6173 2920 3d3d 2032 3a0a 2020 2020 2020  as) == 2:.      
+0001ac00: 2020 2020 2020 7365 6c66 2e72 6570 6c69        self.repli
+0001ac10: 6361 7465 645f 7461 736b 732e 6164 6428  cated_tasks.add(
+0001ac20: 7473 290a 0a20 2020 2064 6566 2072 656d  ts)..    def rem
+0001ac30: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
+0001ac40: 2c20 7473 3a20 5461 736b 5374 6174 652c  , ts: TaskState,
+0001ac50: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+0001ac60: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001ac70: 2020 2022 2222 4e6f 7465 2074 6861 7420     """Note that 
+0001ac80: 6120 776f 726b 6572 206e 6f20 6c6f 6e67  a worker no long
+0001ac90: 6572 2068 6f6c 6473 2061 2072 6570 6c69  er holds a repli
+0001aca0: 6361 206f 6620 6120 7461 736b 2222 220a  ca of a task""".
+0001acb0: 2020 2020 2020 2020 7773 2e72 656d 6f76          ws.remov
+0001acc0: 655f 7265 706c 6963 6128 7473 290a 2020  e_replica(ts).  
+0001acd0: 2020 2020 2020 6966 206c 656e 2874 732e        if len(ts.
+0001ace0: 7768 6f5f 6861 7329 203d 3d20 313a 0a20  who_has) == 1:. 
+0001acf0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001ad00: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
+0001ad10: 2e72 656d 6f76 6528 7473 290a 0a20 2020  .remove(ts)..   
+0001ad20: 2064 6566 2072 656d 6f76 655f 616c 6c5f   def remove_all_
+0001ad30: 7265 706c 6963 6173 2873 656c 662c 2074  replicas(self, t
+0001ad40: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+0001ad50: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+0001ad60: 2222 5265 6d6f 7665 2061 6c6c 2072 6570  ""Remove all rep
+0001ad70: 6c69 6361 7320 6f66 2061 2074 6173 6b20  licas of a task 
+0001ad80: 6672 6f6d 2061 6c6c 2077 6f72 6b65 7273  from all workers
+0001ad90: 2222 220a 2020 2020 2020 2020 6e62 7974  """.        nbyt
+0001ada0: 6573 203d 2074 732e 6765 745f 6e62 7974  es = ts.get_nbyt
+0001adb0: 6573 2829 0a20 2020 2020 2020 2066 6f72  es().        for
+0001adc0: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
+0001add0: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
+0001ade0: 732e 6e62 7974 6573 202d 3d20 6e62 7974  s.nbytes -= nbyt
+0001adf0: 6573 0a20 2020 2020 2020 2020 2020 2064  es.            d
+0001ae00: 656c 2077 732e 5f68 6173 5f77 6861 745b  el ws._has_what[
+0001ae10: 7473 5d0a 2020 2020 2020 2020 6966 206c  ts].        if l
+0001ae20: 656e 2874 732e 7768 6f5f 6861 7329 203e  en(ts.who_has) >
+0001ae30: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0001ae40: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
+0001ae50: 7461 736b 732e 7265 6d6f 7665 2874 7329  tasks.remove(ts)
+0001ae60: 0a20 2020 2020 2020 2074 732e 7768 6f5f  .        ts.who_
+0001ae70: 6861 732e 636c 6561 7228 290a 0a20 2020  has.clear()..   
+0001ae80: 2064 6566 2062 756c 6b5f 7363 6865 6475   def bulk_schedu
+0001ae90: 6c65 5f75 6e72 756e 6e61 626c 655f 6166  le_unrunnable_af
+0001aea0: 7465 725f 6164 6469 6e67 5f77 6f72 6b65  ter_adding_worke
+0001aeb0: 7228 7365 6c66 2c20 7773 3a20 576f 726b  r(self, ws: Work
+0001aec0: 6572 5374 6174 6529 202d 3e20 5265 6373  erState) -> Recs
+0001aed0: 3a0a 2020 2020 2020 2020 2222 2253 656e  :.        """Sen
+0001aee0: 6420 6060 6e6f 2d77 6f72 6b65 7260 6020  d ``no-worker`` 
+0001aef0: 7461 736b 7320 746f 2060 6070 726f 6365  tasks to ``proce
+0001af00: 7373 696e 6760 6020 7468 6174 2074 6869  ssing`` that thi
+0001af10: 7320 776f 726b 6572 2063 616e 2068 616e  s worker can han
+0001af20: 646c 652e 0a0a 2020 2020 2020 2020 5265  dle...        Re
+0001af30: 7475 726e 7320 7072 696f 7269 7479 2d6f  turns priority-o
+0001af40: 7264 6572 6564 2072 6563 6f6d 6d65 6e64  rdered recommend
+0001af50: 6174 696f 6e73 2e0a 2020 2020 2020 2020  ations..        
+0001af60: 2222 220a 2020 2020 2020 2020 7275 6e6e  """.        runn
+0001af70: 6162 6c65 3a20 6c69 7374 5b54 6173 6b53  able: list[TaskS
+0001af80: 7461 7465 5d20 3d20 5b5d 0a20 2020 2020  tate] = [].     
+0001af90: 2020 2066 6f72 2074 7320 696e 2073 656c     for ts in sel
+0001afa0: 662e 756e 7275 6e6e 6162 6c65 3a0a 2020  f.unrunnable:.  
+0001afb0: 2020 2020 2020 2020 2020 7661 6c69 6420            valid 
+0001afc0: 3d20 7365 6c66 2e76 616c 6964 5f77 6f72  = self.valid_wor
+0001afd0: 6b65 7273 2874 7329 0a20 2020 2020 2020  kers(ts).       
+0001afe0: 2020 2020 2069 6620 7661 6c69 6420 6973       if valid is
+0001aff0: 204e 6f6e 6520 6f72 2077 7320 696e 2076   None or ws in v
+0001b000: 616c 6964 3a0a 2020 2020 2020 2020 2020  alid:.          
+0001b010: 2020 2020 2020 7275 6e6e 6162 6c65 2e61        runnable.a
+0001b020: 7070 656e 6428 7473 290a 0a20 2020 2020  ppend(ts)..     
+0001b030: 2020 2023 2052 6563 6f6d 6d65 6e64 6174     # Recommendat
+0001b040: 696f 6e73 2061 7265 2070 726f 6365 7373  ions are process
+0001b050: 6564 204c 4946 4f2c 2068 656e 6365 2074  ed LIFO, hence t
+0001b060: 6865 2072 6576 6572 7365 6420 6f72 6465  he reversed orde
+0001b070: 720a 2020 2020 2020 2020 7275 6e6e 6162  r.        runnab
+0001b080: 6c65 2e73 6f72 7428 6b65 793d 6f70 6572  le.sort(key=oper
+0001b090: 6174 6f72 2e61 7474 7267 6574 7465 7228  ator.attrgetter(
+0001b0a0: 2270 7269 6f72 6974 7922 292c 2072 6576  "priority"), rev
+0001b0b0: 6572 7365 3d54 7275 6529 0a20 2020 2020  erse=True).     
+0001b0c0: 2020 2072 6574 7572 6e20 7b74 732e 6b65     return {ts.ke
+0001b0d0: 793a 2022 7072 6f63 6573 7369 6e67 2220  y: "processing" 
+0001b0e0: 666f 7220 7473 2069 6e20 7275 6e6e 6162  for ts in runnab
+0001b0f0: 6c65 7d0a 0a20 2020 2064 6566 205f 7661  le}..    def _va
+0001b100: 6c69 6461 7465 5f72 6561 6479 2873 656c  lidate_ready(sel
+0001b110: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+0001b120: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001b130: 2020 2022 2222 5661 6c69 6461 7469 6f6e     """Validation
+0001b140: 2066 6f72 2072 6561 6479 2073 7461 7465   for ready state
+0001b150: 7320 2870 726f 6365 7373 696e 672c 2071  s (processing, q
+0001b160: 7565 7565 642c 206e 6f2d 776f 726b 6572  ueued, no-worker
+0001b170: 2922 2222 0a20 2020 2020 2020 2061 7373  )""".        ass
+0001b180: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+0001b190: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0001b1a0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+0001b1b0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0001b1c0: 7274 206e 6f74 2074 732e 6578 6365 7074  rt not ts.except
+0001b1d0: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
+0001b1e0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0001b1f0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+0001b200: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0001b210: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
+0001b220: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
+0001b230: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0001b240: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+0001b250: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+0001b260: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+0001b270: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+0001b280: 6173 7365 7274 2061 6c6c 2864 7473 2e77  assert all(dts.w
+0001b290: 686f 5f68 6173 2066 6f72 2064 7473 2069  ho_has for dts i
+0001b2a0: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0001b2b0: 7329 0a0a 2020 2020 6465 6620 5f61 6464  s)..    def _add
+0001b2c0: 5f74 6f5f 7072 6f63 6573 7369 6e67 2873  _to_processing(s
+0001b2d0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+0001b2e0: 7465 2c20 7773 3a20 576f 726b 6572 5374  te, ws: WorkerSt
+0001b2f0: 6174 6529 202d 3e20 4d73 6773 3a0a 2020  ate) -> Msgs:.  
+0001b300: 2020 2020 2020 2222 2253 6574 2061 2074        """Set a t
+0001b310: 6173 6b20 6173 2070 726f 6365 7373 696e  ask as processin
+0001b320: 6720 6f6e 2061 2077 6f72 6b65 7220 616e  g on a worker an
+0001b330: 6420 7265 7475 726e 2074 6865 2077 6f72  d return the wor
+0001b340: 6b65 7220 6d65 7373 6167 6573 2074 6f20  ker messages to 
+0001b350: 7365 6e64 2222 220a 2020 2020 2020 2020  send""".        
+0001b360: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+0001b370: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001b380: 6c66 2e5f 7661 6c69 6461 7465 5f72 6561  lf._validate_rea
+0001b390: 6479 2874 7329 0a20 2020 2020 2020 2020  dy(ts).         
+0001b3a0: 2020 2061 7373 6572 7420 7773 2069 6e20     assert ws in 
+0001b3b0: 7365 6c66 2e72 756e 6e69 6e67 2c20 7365  self.running, se
+0001b3c0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+0001b3d0: 2020 2020 2020 2061 7373 6572 7420 286f         assert (o
+0001b3e0: 203a 3d20 7365 6c66 2e77 6f72 6b65 7273   := self.workers
+0001b3f0: 2e67 6574 2877 732e 6164 6472 6573 7329  .get(ws.address)
+0001b400: 2920 6973 2077 732c 2028 7773 2c20 6f29  ) is ws, (ws, o)
+0001b410: 0a0a 2020 2020 2020 2020 7773 2e61 6464  ..        ws.add
+0001b420: 5f74 6f5f 7072 6f63 6573 7369 6e67 2874  _to_processing(t
+0001b430: 7329 0a20 2020 2020 2020 2074 732e 7072  s).        ts.pr
+0001b440: 6f63 6573 7369 6e67 5f6f 6e20 3d20 7773  ocessing_on = ws
+0001b450: 0a20 2020 2020 2020 2074 732e 7374 6174  .        ts.stat
+0001b460: 6520 3d20 2270 726f 6365 7373 696e 6722  e = "processing"
+0001b470: 0a20 2020 2020 2020 2073 656c 662e 6163  .        self.ac
+0001b480: 7175 6972 655f 7265 736f 7572 6365 7328  quire_resources(
+0001b490: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
+0001b4a0: 7365 6c66 2e63 6865 636b 5f69 646c 655f  self.check_idle_
+0001b4b0: 7361 7475 7261 7465 6428 7773 290a 2020  saturated(ws).  
+0001b4c0: 2020 2020 2020 7365 6c66 2e6e 5f74 6173        self.n_tas
+0001b4d0: 6b73 202b 3d20 310a 0a20 2020 2020 2020  ks += 1..       
+0001b4e0: 2069 6620 7473 2e61 6374 6f72 3a0a 2020   if ts.actor:.  
+0001b4f0: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
+0001b500: 6f72 732e 6164 6428 7473 290a 0a20 2020  ors.add(ts)..   
+0001b510: 2020 2020 2072 6574 7572 6e20 7b77 732e       return {ws.
+0001b520: 6164 6472 6573 733a 205b 7365 6c66 2e5f  address: [self._
+0001b530: 7461 736b 5f74 6f5f 6d73 6728 7473 295d  task_to_msg(ts)]
+0001b540: 7d0a 0a20 2020 2064 6566 205f 6578 6974  }..    def _exit
+0001b550: 5f70 726f 6365 7373 696e 675f 636f 6d6d  _processing_comm
+0001b560: 6f6e 2873 656c 662c 2074 733a 2054 6173  on(self, ts: Tas
+0001b570: 6b53 7461 7465 2920 2d3e 2057 6f72 6b65  kState) -> Worke
+0001b580: 7253 7461 7465 207c 204e 6f6e 653a 0a20  rState | None:. 
+0001b590: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
+0001b5a0: 202a 7473 2a20 6672 6f6d 2074 6865 2073   *ts* from the s
+0001b5b0: 6574 206f 6620 7072 6f63 6573 7369 6e67  et of processing
+0001b5c0: 2074 6173 6b73 2e0a 0a20 2020 2020 2020   tasks...       
+0001b5d0: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
+0001b5e0: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
+0001b5f0: 2057 6f72 6b65 7220 7374 6174 6520 6f66   Worker state of
+0001b600: 2074 6865 2077 6f72 6b65 7220 7468 6174   the worker that
+0001b610: 2070 726f 6365 7373 6564 202a 7473 2a20   processed *ts* 
+0001b620: 6966 2074 6865 2077 6f72 6b65 7220 6973  if the worker is
+0001b630: 2063 7572 7265 6e74 2c0a 2020 2020 2020   current,.      
+0001b640: 2020 4e6f 6e65 2069 6620 7468 6520 776f    None if the wo
+0001b650: 726b 6572 2069 7320 7374 616c 652e 0a0a  rker is stale...
+0001b660: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+0001b670: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0001b680: 2d0a 2020 2020 2020 2020 5363 6865 6475  -.        Schedu
+0001b690: 6c65 722e 5f73 6574 5f64 7572 6174 696f  ler._set_duratio
+0001b6a0: 6e5f 6573 7469 6d61 7465 0a20 2020 2020  n_estimate.     
+0001b6b0: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+0001b6c0: 7320 3d20 7473 2e70 726f 6365 7373 696e  s = ts.processin
+0001b6d0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
+0001b6e0: 6572 7420 7773 0a20 2020 2020 2020 2074  ert ws.        t
+0001b6f0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e20  s.processing_on 
+0001b700: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+0001b710: 7773 2e72 656d 6f76 655f 6672 6f6d 5f70  ws.remove_from_p
+0001b720: 726f 6365 7373 696e 6728 7473 290a 2020  rocessing(ts).  
+0001b730: 2020 2020 2020 6966 2073 656c 662e 776f        if self.wo
+0001b740: 726b 6572 732e 6765 7428 7773 2e61 6464  rkers.get(ws.add
+0001b750: 7265 7373 2920 6973 206e 6f74 2077 733a  ress) is not ws:
+0001b760: 2020 2320 6d61 7920 6861 7665 2062 6565    # may have bee
+0001b770: 6e20 7265 6d6f 7665 640a 2020 2020 2020  n removed.      
+0001b780: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0001b790: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+0001b7a0: 6368 6563 6b5f 6964 6c65 5f73 6174 7572  check_idle_satur
+0001b7b0: 6174 6564 2877 7329 0a20 2020 2020 2020  ated(ws).       
+0001b7c0: 2073 656c 662e 7265 6c65 6173 655f 7265   self.release_re
+0001b7d0: 736f 7572 6365 7328 7473 2c20 7773 290a  sources(ts, ws).
+0001b7e0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001b7f0: 7773 0a0a 2020 2020 6465 6620 5f61 6464  ws..    def _add
+0001b800: 5f74 6f5f 6d65 6d6f 7279 280a 2020 2020  _to_memory(.    
+0001b810: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+0001b820: 2020 7473 3a20 5461 736b 5374 6174 652c    ts: TaskState,
+0001b830: 0a20 2020 2020 2020 2077 733a 2057 6f72  .        ws: Wor
+0001b840: 6b65 7253 7461 7465 2c0a 2020 2020 2020  kerState,.      
+0001b850: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001b860: 733a 2052 6563 732c 0a20 2020 2020 2020  s: Recs,.       
+0001b870: 2063 6c69 656e 745f 6d73 6773 3a20 4d73   client_msgs: Ms
+0001b880: 6773 2c0a 2020 2020 2020 2020 7479 7065  gs,.        type
+0001b890: 3a20 6279 7465 7320 7c20 4e6f 6e65 203d  : bytes | None =
+0001b8a0: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
+0001b8b0: 7970 656e 616d 653a 2073 7472 207c 204e  ypename: str | N
+0001b8c0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+0001b8d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001b8e0: 2020 2022 2222 4164 6420 7473 2074 6f20     """Add ts to 
+0001b8f0: 7468 6520 7365 7420 6f66 2069 6e2d 6d65  the set of in-me
+0001b900: 6d6f 7279 2074 6173 6b73 2222 220a 2020  mory tasks""".  
+0001b910: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+0001b920: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+0001b930: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
+0001b940: 7420 696e 2077 732e 6861 735f 7768 6174  t in ws.has_what
+0001b950: 0a0a 2020 2020 2020 2020 7365 6c66 2e61  ..        self.a
+0001b960: 6464 5f72 6570 6c69 6361 2874 732c 2077  dd_replica(ts, w
+0001b970: 7329 0a0a 2020 2020 2020 2020 6465 7073  s)..        deps
+0001b980: 203d 206c 6973 7428 7473 2e64 6570 656e   = list(ts.depen
+0001b990: 6465 6e74 7329 0a20 2020 2020 2020 2069  dents).        i
+0001b9a0: 6620 6c65 6e28 6465 7073 2920 3e20 313a  f len(deps) > 1:
+0001b9b0: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
+0001b9c0: 732e 736f 7274 286b 6579 3d6f 7065 7261  s.sort(key=opera
+0001b9d0: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
+0001b9e0: 7072 696f 7269 7479 2229 2c20 7265 7665  priority"), reve
+0001b9f0: 7273 653d 5472 7565 290a 0a20 2020 2020  rse=True)..     
+0001ba00: 2020 2066 6f72 2064 7473 2069 6e20 6465     for dts in de
+0001ba10: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+0001ba20: 7320 3d20 6474 732e 7761 6974 696e 675f  s = dts.waiting_
+0001ba30: 6f6e 0a20 2020 2020 2020 2020 2020 2069  on.            i
+0001ba40: 6620 7473 2069 6e20 733a 0a20 2020 2020  f ts in s:.     
+0001ba50: 2020 2020 2020 2020 2020 2073 2e64 6973             s.dis
+0001ba60: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+0001ba70: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+0001ba80: 733a 2020 2320 6e65 7720 7461 736b 2072  s:  # new task r
+0001ba90: 6561 6479 2074 6f20 7275 6e0a 2020 2020  eady to run.    
+0001baa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bab0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+0001bac0: 6474 732e 6b65 795d 203d 2022 7072 6f63  dts.key] = "proc
+0001bad0: 6573 7369 6e67 220a 0a20 2020 2020 2020  essing"..       
+0001bae0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0001baf0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+0001bb00: 2020 2020 2020 2020 2073 203d 2064 7473           s = dts
+0001bb10: 2e77 6169 7465 7273 0a20 2020 2020 2020  .waiters.       
+0001bb20: 2020 2020 2073 2e64 6973 6361 7264 2874       s.discard(t
+0001bb30: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+0001bb40: 6620 6e6f 7420 7320 616e 6420 6e6f 7420  f not s and not 
+0001bb50: 6474 732e 7768 6f5f 7761 6e74 733a 0a20  dts.who_wants:. 
+0001bb60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001bb70: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001bb80: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
+0001bb90: 7365 6422 0a0a 2020 2020 2020 2020 6966  sed"..        if
+0001bba0: 206e 6f74 2074 732e 7761 6974 6572 7320   not ts.waiters 
+0001bbb0: 616e 6420 6e6f 7420 7473 2e77 686f 5f77  and not ts.who_w
+0001bbc0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+0001bbd0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+0001bbe0: 735b 7473 2e6b 6579 5d20 3d20 2272 656c  s[ts.key] = "rel
+0001bbf0: 6561 7365 6422 0a20 2020 2020 2020 2065  eased".        e
+0001bc00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001bc10: 2072 6570 6f72 745f 6d73 673a 2064 6963   report_msg: dic
+0001bc20: 745b 7374 722c 2041 6e79 5d20 3d20 7b22  t[str, Any] = {"
+0001bc30: 6f70 223a 2022 6b65 792d 696e 2d6d 656d  op": "key-in-mem
+0001bc40: 6f72 7922 2c20 226b 6579 223a 2074 732e  ory", "key": ts.
+0001bc50: 6b65 797d 0a20 2020 2020 2020 2020 2020  key}.           
+0001bc60: 2069 6620 7479 7065 2069 7320 6e6f 7420   if type is not 
+0001bc70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001bc80: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+0001bc90: 5b22 7479 7065 225d 203d 2074 7970 650a  ["type"] = type.
+0001bca0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001bcb0: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+0001bcc0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0001bcd0: 2020 2020 636c 6965 6e74 5f6d 7367 735b      client_msgs[
+0001bce0: 6373 2e63 6c69 656e 745f 6b65 795d 203d  cs.client_key] =
+0001bcf0: 205b 7265 706f 7274 5f6d 7367 5d0a 0a20   [report_msg].. 
+0001bd00: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+0001bd10: 3d20 226d 656d 6f72 7922 0a20 2020 2020  = "memory".     
+0001bd20: 2020 2074 732e 7479 7065 203d 2074 7970     ts.type = typ
+0001bd30: 656e 616d 6520 2023 2074 7970 653a 2069  ename  # type: i
+0001bd40: 676e 6f72 650a 2020 2020 2020 2020 7473  gnore.        ts
+0001bd50: 2e67 726f 7570 2e74 7970 6573 2e61 6464  .group.types.add
+0001bd60: 2874 7970 656e 616d 6529 2020 2320 7479  (typename)  # ty
+0001bd70: 7065 3a20 6967 6e6f 7265 0a0a 2020 2020  pe: ignore..    
+0001bd80: 2020 2020 6373 203d 2073 656c 662e 636c      cs = self.cl
+0001bd90: 6965 6e74 735b 2266 6972 652d 616e 642d  ients["fire-and-
+0001bda0: 666f 7267 6574 225d 0a20 2020 2020 2020  forget"].       
+0001bdb0: 2069 6620 7473 2069 6e20 6373 2e77 616e   if ts in cs.wan
+0001bdc0: 7473 5f77 6861 743a 0a20 2020 2020 2020  ts_what:.       
+0001bdd0: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
+0001bde0: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
+0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be00: 2063 733d 6373 2c0a 2020 2020 2020 2020   cs=cs,.        
+0001be10: 2020 2020 2020 2020 6b65 7973 3d5b 7473          keys=[ts
+0001be20: 2e6b 6579 5d2c 0a20 2020 2020 2020 2020  .key],.         
+0001be30: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001be40: 6174 696f 6e73 3d72 6563 6f6d 6d65 6e64  ations=recommend
+0001be50: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
+0001be60: 2020 2020 290a 0a20 2020 2064 6566 205f      )..    def _
+0001be70: 7072 6f70 6167 6174 655f 7265 6c65 6173  propagate_releas
+0001be80: 6564 2873 656c 662c 2074 733a 2054 6173  ed(self, ts: Tas
+0001be90: 6b53 7461 7465 2c20 7265 636f 6d6d 656e  kState, recommen
+0001bea0: 6461 7469 6f6e 733a 2052 6563 7329 202d  dations: Recs) -
+0001beb0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0001bec0: 7473 2e73 7461 7465 203d 2022 7265 6c65  ts.state = "rele
+0001bed0: 6173 6564 220a 2020 2020 2020 2020 6b65  ased".        ke
+0001bee0: 7920 3d20 7473 2e6b 6579 0a0a 2020 2020  y = ts.key..    
+0001bef0: 2020 2020 6966 2074 732e 6861 735f 6c6f      if ts.has_lo
+0001bf00: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
+0001bf10: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0001bf20: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
+0001bf30: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
+0001bf40: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
+0001bf50: 7761 6974 6572 7320 6f72 2074 732e 7768  waiters or ts.wh
+0001bf60: 6f5f 7761 6e74 733a 0a20 2020 2020 2020  o_wants:.       
+0001bf70: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001bf80: 696f 6e73 5b6b 6579 5d20 3d20 2277 6169  ions[key] = "wai
+0001bf90: 7469 6e67 220a 0a20 2020 2020 2020 2069  ting"..        i
+0001bfa0: 6620 7265 636f 6d6d 656e 6461 7469 6f6e  f recommendation
+0001bfb0: 732e 6765 7428 6b65 7929 2021 3d20 2277  s.get(key) != "w
+0001bfc0: 6169 7469 6e67 223a 0a20 2020 2020 2020  aiting":.       
+0001bfd0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+0001bfe0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+0001bff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c000: 2069 6620 6474 732e 7374 6174 6520 213d   if dts.state !=
+0001c010: 2022 7265 6c65 6173 6564 223a 0a20 2020   "released":.   
+0001c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c030: 2064 7473 2e77 6169 7465 7273 2e64 6973   dts.waiters.dis
+0001c040: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+0001c050: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001c060: 6e6f 7420 6474 732e 7761 6974 6572 7320  not dts.waiters 
+0001c070: 616e 6420 6e6f 7420 6474 732e 7768 6f5f  and not dts.who_
+0001c080: 7761 6e74 733a 0a20 2020 2020 2020 2020  wants:.         
+0001c090: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001c0a0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001c0b0: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
+0001c0c0: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
+0001c0d0: 2074 732e 7761 6974 6572 732e 636c 6561   ts.waiters.clea
+0001c0e0: 7228 290a 0a20 2020 2020 2020 2069 6620  r()..        if 
+0001c0f0: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+0001c100: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001c110: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+0001c120: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+0001c130: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+0001c140: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
+0001c150: 0a20 2020 2064 6566 205f 7072 6f70 6167  .    def _propag
+0001c160: 6174 655f 666f 7267 6f74 7465 6e28 0a20  ate_forgotten(. 
+0001c170: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0001c180: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0001c190: 7465 2c0a 2020 2020 2020 2020 7265 636f  te,.        reco
+0001c1a0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+0001c1b0: 732c 0a20 2020 2020 2020 2077 6f72 6b65  s,.        worke
+0001c1c0: 725f 6d73 6773 3a20 4d73 6773 2c0a 2020  r_msgs: Msgs,.  
+0001c1d0: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+0001c1e0: 643a 2073 7472 2c0a 2020 2020 2920 2d3e  d: str,.    ) ->
+0001c1f0: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+0001c200: 732e 7374 6174 6520 3d20 2266 6f72 676f  s.state = "forgo
+0001c210: 7474 656e 220a 2020 2020 2020 2020 666f  tten".        fo
+0001c220: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+0001c230: 6e64 656e 7473 3a0a 2020 2020 2020 2020  ndents:.        
+0001c240: 2020 2020 6474 732e 6861 735f 6c6f 7374      dts.has_lost
+0001c250: 5f64 6570 656e 6465 6e63 6965 7320 3d20  _dependencies = 
+0001c260: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001c270: 2064 7473 2e64 6570 656e 6465 6e63 6965   dts.dependencie
+0001c280: 732e 7265 6d6f 7665 2874 7329 0a20 2020  s.remove(ts).   
+0001c290: 2020 2020 2020 2020 2064 7473 2e77 6169           dts.wai
+0001c2a0: 7469 6e67 5f6f 6e2e 6469 7363 6172 6428  ting_on.discard(
+0001c2b0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+0001c2c0: 6966 2064 7473 2e73 7461 7465 206e 6f74  if dts.state not
+0001c2d0: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
+0001c2e0: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
+0001c2f0: 2020 2020 2020 2020 2023 2043 616e 6e6f           # Canno
+0001c300: 7420 636f 6d70 7574 6520 7461 736b 2061  t compute task a
+0001c310: 6e79 6d6f 7265 0a20 2020 2020 2020 2020  nymore.         
+0001c320: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0001c330: 6174 696f 6e73 5b64 7473 2e6b 6579 5d20  ations[dts.key] 
+0001c340: 3d20 2266 6f72 676f 7474 656e 220a 2020  = "forgotten".  
+0001c350: 2020 2020 2020 7473 2e64 6570 656e 6465        ts.depende
+0001c360: 6e74 732e 636c 6561 7228 290a 2020 2020  nts.clear().    
+0001c370: 2020 2020 7473 2e77 6169 7465 7273 2e63      ts.waiters.c
+0001c380: 6c65 6172 2829 0a0a 2020 2020 2020 2020  lear()..        
+0001c390: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0001c3a0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
+0001c3b0: 2020 2020 2020 2020 6474 732e 6465 7065          dts.depe
+0001c3c0: 6e64 656e 7473 2e72 656d 6f76 6528 7473  ndents.remove(ts
+0001c3d0: 290a 2020 2020 2020 2020 2020 2020 6474  ).            dt
+0001c3e0: 732e 7761 6974 6572 732e 6469 7363 6172  s.waiters.discar
+0001c3f0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+0001c400: 2020 6966 206e 6f74 2064 7473 2e64 6570    if not dts.dep
+0001c410: 656e 6465 6e74 7320 616e 6420 6e6f 7420  endents and not 
+0001c420: 6474 732e 7768 6f5f 7761 6e74 733a 0a20  dts.who_wants:. 
+0001c430: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001c440: 2054 6173 6b20 6e6f 7420 6e65 6564 6564   Task not needed
+0001c450: 2061 6e79 6d6f 7265 0a20 2020 2020 2020   anymore.       
+0001c460: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0001c470: 6474 7320 6973 206e 6f74 2074 730a 2020  dts is not ts.  
+0001c480: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001c490: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+0001c4a0: 732e 6b65 795d 203d 2022 666f 7267 6f74  s.key] = "forgot
+0001c4b0: 7465 6e22 0a20 2020 2020 2020 2074 732e  ten".        ts.
+0001c4c0: 6465 7065 6e64 656e 6369 6573 2e63 6c65  dependencies.cle
+0001c4d0: 6172 2829 0a20 2020 2020 2020 2074 732e  ar().        ts.
+0001c4e0: 7761 6974 696e 675f 6f6e 2e63 6c65 6172  waiting_on.clear
+0001c4f0: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
+0001c500: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+0001c510: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0001c520: 2077 732e 6164 6472 6573 7320 696e 2073   ws.address in s
+0001c530: 656c 662e 776f 726b 6572 733a 2020 2320  elf.workers:  # 
+0001c540: 696e 2063 6173 6520 776f 726b 6572 2068  in case worker h
+0001c550: 6173 2064 6965 640a 2020 2020 2020 2020  as died.        
+0001c560: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
+0001c570: 7367 735b 7773 2e61 6464 7265 7373 5d20  sgs[ws.address] 
+0001c580: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0001c590: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0001c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c5b0: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
+0001c5c0: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
+0001c5d0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
+0001c5e0: 7973 223a 205b 7473 2e6b 6579 5d2c 0a20  ys": [ts.key],. 
 0001c5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c600: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
-0001c610: 656d 6f76 655f 616c 6c5f 7265 706c 6963  emove_all_replic
-0001c620: 6173 2874 7329 0a0a 2020 2020 6465 6620  as(ts)..    def 
-0001c630: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
-0001c640: 5f6b 6579 7328 0a20 2020 2020 2020 2073  _keys(.        s
-0001c650: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
-0001c660: 733a 2043 6f6c 6c65 6374 696f 6e5b 7374  s: Collection[st
-0001c670: 725d 2c0a 2020 2020 2020 2020 6373 3a20  r],.        cs: 
-0001c680: 436c 6965 6e74 5374 6174 652c 0a20 2020  ClientState,.   
-0001c690: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001c6a0: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
-0001c6b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0001c6c0: 2020 2022 2222 5265 6d6f 7665 206b 6579     """Remove key
-0001c6d0: 7320 6672 6f6d 2063 6c69 656e 7420 6465  s from client de
-0001c6e0: 7369 7265 6420 6c69 7374 2222 220a 2020  sired list""".  
-0001c6f0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0001c700: 7567 2822 436c 6965 6e74 2025 7320 7265  ug("Client %s re
-0001c710: 6c65 6173 6573 206b 6579 733a 2025 7322  leases keys: %s"
-0001c720: 2c20 6373 2e63 6c69 656e 745f 6b65 792c  , cs.client_key,
-0001c730: 206b 6579 7329 0a20 2020 2020 2020 2066   keys).        f
-0001c740: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
-0001c750: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0001c760: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
-0001c770: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-0001c780: 2069 6620 7473 2069 7320 6e6f 7420 4e6f   if ts is not No
-0001c790: 6e65 2061 6e64 2074 7320 696e 2063 732e  ne and ts in cs.
-0001c7a0: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
-0001c7b0: 2020 2020 2020 2020 2020 2020 6373 2e77              cs.w
-0001c7c0: 616e 7473 5f77 6861 742e 7265 6d6f 7665  ants_what.remove
-0001c7d0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0001c7e0: 2020 2020 2074 732e 7768 6f5f 7761 6e74       ts.who_want
-0001c7f0: 732e 7265 6d6f 7665 2863 7329 0a20 2020  s.remove(cs).   
-0001c800: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001c810: 6e6f 7420 7473 2e77 686f 5f77 616e 7473  not ts.who_wants
-0001c820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c830: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
-0001c840: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
-0001c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c860: 2020 2020 2320 4e6f 206c 6976 6520 6465      # No live de
-0001c870: 7065 6e64 656e 7473 2c20 6361 6e20 666f  pendents, can fo
-0001c880: 7267 6574 0a20 2020 2020 2020 2020 2020  rget.           
-0001c890: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0001c8a0: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
-0001c8b0: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
-0001c8c0: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-0001c8d0: 2020 2020 2020 2065 6c69 6620 7473 2e73         elif ts.s
-0001c8e0: 7461 7465 2021 3d20 2265 7272 6564 2220  tate != "erred" 
-0001c8f0: 616e 6420 6e6f 7420 7473 2e77 6169 7465  and not ts.waite
-0001c900: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-0001c910: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001c920: 6d6d 656e 6461 7469 6f6e 735b 7473 2e6b  mmendations[ts.k
-0001c930: 6579 5d20 3d20 2272 656c 6561 7365 6422  ey] = "released"
-0001c940: 0a0a 2020 2020 6465 6620 5f74 6173 6b5f  ..    def _task_
-0001c950: 746f 5f6d 7367 2873 656c 662c 2074 733a  to_msg(self, ts:
-0001c960: 2054 6173 6b53 7461 7465 2c20 6475 7261   TaskState, dura
-0001c970: 7469 6f6e 3a20 666c 6f61 7420 3d20 2d31  tion: float = -1
-0001c980: 2920 2d3e 2064 6963 745b 7374 722c 2041  ) -> dict[str, A
-0001c990: 6e79 5d3a 0a20 2020 2020 2020 2022 2222  ny]:.        """
-0001c9a0: 436f 6e76 6572 7420 6120 7369 6e67 6c65  Convert a single
-0001c9b0: 2063 6f6d 7075 7461 7469 6f6e 616c 2074   computational t
-0001c9c0: 6173 6b20 746f 2061 206d 6573 7361 6765  ask to a message
-0001c9d0: 2222 220a 2020 2020 2020 2020 2320 4649  """.        # FI
-0001c9e0: 584d 453a 2054 6865 2064 7572 6174 696f  XME: The duratio
-0001c9f0: 6e20 6174 7472 6962 7574 6520 6973 206e  n attribute is n
-0001ca00: 6f74 2075 7365 6420 6f6e 2077 6f72 6b65  ot used on worke
-0001ca10: 722e 2057 6520 636f 756c 6420 7361 7665  r. We could save
-0001ca20: 206f 7572 7365 6c76 6573 2074 6865 0a20   ourselves the. 
-0001ca30: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-0001ca40: 7469 6d65 2074 6f20 636f 6d70 7574 6520  time to compute 
-0001ca50: 616e 6420 7375 626d 6974 2074 6869 730a  and submit this.
-0001ca60: 2020 2020 2020 2020 6966 2064 7572 6174          if durat
-0001ca70: 696f 6e20 3c20 303a 0a20 2020 2020 2020  ion < 0:.       
-0001ca80: 2020 2020 2064 7572 6174 696f 6e20 3d20       duration = 
-0001ca90: 7365 6c66 2e67 6574 5f74 6173 6b5f 6475  self.get_task_du
-0001caa0: 7261 7469 6f6e 2874 7329 0a20 2020 2020  ration(ts).     
-0001cab0: 2020 2074 732e 7275 6e5f 6964 203d 206e     ts.run_id = n
-0001cac0: 6578 7428 5461 736b 5374 6174 652e 5f72  ext(TaskState._r
-0001cad0: 756e 5f69 645f 6974 6572 6174 6f72 290a  un_id_iterator).
-0001cae0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0001caf0: 732e 7072 696f 7269 7479 2c20 7473 0a20  s.priority, ts. 
-0001cb00: 2020 2020 2020 206d 7367 3a20 6469 6374         msg: dict
-0001cb10: 5b73 7472 2c20 416e 795d 203d 207b 0a20  [str, Any] = {. 
-0001cb20: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-0001cb30: 2022 636f 6d70 7574 652d 7461 736b 222c   "compute-task",
-0001cb40: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
-0001cb50: 7922 3a20 7473 2e6b 6579 2c0a 2020 2020  y": ts.key,.    
-0001cb60: 2020 2020 2020 2020 2272 756e 5f69 6422          "run_id"
-0001cb70: 3a20 7473 2e72 756e 5f69 642c 0a20 2020  : ts.run_id,.   
-0001cb80: 2020 2020 2020 2020 2022 7072 696f 7269           "priori
-0001cb90: 7479 223a 2074 732e 7072 696f 7269 7479  ty": ts.priority
-0001cba0: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
-0001cbb0: 7572 6174 696f 6e22 3a20 6475 7261 7469  uration": durati
-0001cbc0: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-0001cbd0: 2273 7469 6d75 6c75 735f 6964 223a 2066  "stimulus_id": f
-0001cbe0: 2263 6f6d 7075 7465 2d74 6173 6b2d 7b74  "compute-task-{t
-0001cbf0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
-0001cc00: 2020 2020 2022 7768 6f5f 6861 7322 3a20       "who_has": 
-0001cc10: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-0001cc20: 2020 6474 732e 6b65 793a 205b 7773 2e61    dts.key: [ws.a
-0001cc30: 6464 7265 7373 2066 6f72 2077 7320 696e  ddress for ws in
-0001cc40: 2064 7473 2e77 686f 5f68 6173 5d20 666f   dts.who_has] fo
-0001cc50: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0001cc60: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
-0001cc70: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-0001cc80: 2020 2020 226e 6279 7465 7322 3a20 7b64      "nbytes": {d
-0001cc90: 7473 2e6b 6579 3a20 6474 732e 6e62 7974  ts.key: dts.nbyt
-0001cca0: 6573 2066 6f72 2064 7473 2069 6e20 7473  es for dts in ts
-0001ccb0: 2e64 6570 656e 6465 6e63 6965 737d 2c0a  .dependencies},.
-0001ccc0: 2020 2020 2020 2020 2020 2020 2272 756e              "run
-0001ccd0: 5f73 7065 6322 3a20 4e6f 6e65 2c0a 2020  _spec": None,.  
-0001cce0: 2020 2020 2020 2020 2020 2266 756e 6374            "funct
-0001ccf0: 696f 6e22 3a20 4e6f 6e65 2c0a 2020 2020  ion": None,.    
-0001cd00: 2020 2020 2020 2020 2261 7267 7322 3a20          "args": 
-0001cd10: 4e6f 6e65 2c0a 2020 2020 2020 2020 2020  None,.          
-0001cd20: 2020 226b 7761 7267 7322 3a20 4e6f 6e65    "kwargs": None
-0001cd30: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-0001cd40: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-0001cd50: 696f 6e73 223a 2074 732e 7265 736f 7572  ions": ts.resour
-0001cd60: 6365 5f72 6573 7472 6963 7469 6f6e 732c  ce_restrictions,
-0001cd70: 0a20 2020 2020 2020 2020 2020 2022 6163  .            "ac
-0001cd80: 746f 7222 3a20 7473 2e61 6374 6f72 2c0a  tor": ts.actor,.
-0001cd90: 2020 2020 2020 2020 2020 2020 2261 6e6e              "ann
-0001cda0: 6f74 6174 696f 6e73 223a 2074 732e 616e  otations": ts.an
-0001cdb0: 6e6f 7461 7469 6f6e 732c 0a20 2020 2020  notations,.     
-0001cdc0: 2020 2020 2020 2022 7370 616e 5f69 6422         "span_id"
-0001cdd0: 3a20 7473 2e67 726f 7570 2e73 7061 6e5f  : ts.group.span_
-0001cde0: 6964 2c0a 2020 2020 2020 2020 7d0a 2020  id,.        }.  
-0001cdf0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-0001ce00: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-0001ce10: 2020 2020 6173 7365 7274 2061 6c6c 286d      assert all(m
-0001ce20: 7367 5b22 7768 6f5f 6861 7322 5d2e 7661  sg["who_has"].va
-0001ce30: 6c75 6573 2829 290a 0a20 2020 2020 2020  lues())..       
-0001ce40: 2069 6620 6973 696e 7374 616e 6365 2874   if isinstance(t
-0001ce50: 732e 7275 6e5f 7370 6563 2c20 6469 6374  s.run_spec, dict
-0001ce60: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-0001ce70: 7367 2e75 7064 6174 6528 7473 2e72 756e  sg.update(ts.run
-0001ce80: 5f73 7065 6329 0a20 2020 2020 2020 2065  _spec).        e
-0001ce90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001cea0: 206d 7367 5b22 7275 6e5f 7370 6563 225d   msg["run_spec"]
-0001ceb0: 203d 2074 732e 7275 6e5f 7370 6563 0a0a   = ts.run_spec..
-0001cec0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0001ced0: 7367 0a0a 0a63 6c61 7373 2053 6368 6564  sg...class Sched
-0001cee0: 756c 6572 2853 6368 6564 756c 6572 5374  uler(SchedulerSt
-0001cef0: 6174 652c 2053 6572 7665 724e 6f64 6529  ate, ServerNode)
-0001cf00: 3a0a 2020 2020 2222 2244 796e 616d 6963  :.    """Dynamic
-0001cf10: 2064 6973 7472 6962 7574 6564 2074 6173   distributed tas
-0001cf20: 6b20 7363 6865 6475 6c65 720a 0a20 2020  k scheduler..   
-0001cf30: 2054 6865 2073 6368 6564 756c 6572 2074   The scheduler t
-0001cf40: 7261 636b 7320 7468 6520 6375 7272 656e  racks the curren
-0001cf50: 7420 7374 6174 6520 6f66 2077 6f72 6b65  t state of worke
-0001cf60: 7273 2c20 6461 7461 2c20 616e 6420 636f  rs, data, and co
-0001cf70: 6d70 7574 6174 696f 6e73 2e0a 2020 2020  mputations..    
-0001cf80: 5468 6520 7363 6865 6475 6c65 7220 6c69  The scheduler li
-0001cf90: 7374 656e 7320 666f 7220 6576 656e 7473  stens for events
-0001cfa0: 2061 6e64 2072 6573 706f 6e64 7320 6279   and responds by
-0001cfb0: 2063 6f6e 7472 6f6c 6c69 6e67 2077 6f72   controlling wor
-0001cfc0: 6b65 7273 0a20 2020 2061 7070 726f 7072  kers.    appropr
-0001cfd0: 6961 7465 6c79 2e20 2049 7420 636f 6e74  iately.  It cont
-0001cfe0: 696e 756f 7573 6c79 2074 7269 6573 2074  inuously tries t
-0001cff0: 6f20 7573 6520 7468 6520 776f 726b 6572  o use the worker
-0001d000: 7320 746f 2065 7865 6375 7465 2061 6e20  s to execute an 
-0001d010: 6576 6572 0a20 2020 2067 726f 7769 6e67  ever.    growing
-0001d020: 2064 6173 6b20 6772 6170 682e 0a0a 2020   dask graph...  
-0001d030: 2020 416c 6c20 6576 656e 7473 2061 7265    All events are
-0001d040: 2068 616e 646c 6564 2071 7569 636b 6c79   handled quickly
-0001d050: 2c20 696e 206c 696e 6561 7220 7469 6d65  , in linear time
-0001d060: 2077 6974 6820 7265 7370 6563 7420 746f   with respect to
-0001d070: 2074 6865 6972 2069 6e70 7574 0a20 2020   their input.   
-0001d080: 2028 7768 6963 6820 6973 206f 6674 656e   (which is often
-0001d090: 206f 6620 636f 6e73 7461 6e74 2073 697a   of constant siz
-0001d0a0: 6529 2061 6e64 2067 656e 6572 616c 6c79  e) and generally
-0001d0b0: 2077 6974 6869 6e20 6120 6d69 6c6c 6973   within a millis
-0001d0c0: 6563 6f6e 642e 2020 546f 0a20 2020 2061  econd.  To.    a
-0001d0d0: 6363 6f6d 706c 6973 6820 7468 6973 2074  ccomplish this t
-0001d0e0: 6865 2073 6368 6564 756c 6572 2074 7261  he scheduler tra
-0001d0f0: 636b 7320 6120 6c6f 7420 6f66 2073 7461  cks a lot of sta
-0001d100: 7465 2e20 2045 7665 7279 206f 7065 7261  te.  Every opera
-0001d110: 7469 6f6e 0a20 2020 206d 6169 6e74 6169  tion.    maintai
-0001d120: 6e73 2074 6865 2063 6f6e 7369 7374 656e  ns the consisten
-0001d130: 6379 206f 6620 7468 6973 2073 7461 7465  cy of this state
-0001d140: 2e0a 0a20 2020 2054 6865 2073 6368 6564  ...    The sched
-0001d150: 756c 6572 2063 6f6d 6d75 6e69 6361 7465  uler communicate
-0001d160: 7320 7769 7468 2074 6865 206f 7574 7369  s with the outsi
-0001d170: 6465 2077 6f72 6c64 2074 6872 6f75 6768  de world through
-0001d180: 2043 6f6d 6d20 6f62 6a65 6374 732e 0a20   Comm objects.. 
-0001d190: 2020 2049 7420 6d61 696e 7461 696e 7320     It maintains 
-0001d1a0: 6120 636f 6e73 6973 7465 6e74 2061 6e64  a consistent and
-0001d1b0: 2076 616c 6964 2076 6965 7720 6f66 2074   valid view of t
-0001d1c0: 6865 2077 6f72 6c64 2065 7665 6e20 7768  he world even wh
-0001d1d0: 656e 206c 6973 7465 6e69 6e67 0a20 2020  en listening.   
-0001d1e0: 2074 6f20 7365 7665 7261 6c20 636c 6965   to several clie
-0001d1f0: 6e74 7320 6174 206f 6e63 652e 0a0a 2020  nts at once...  
-0001d200: 2020 4120 5363 6865 6475 6c65 7220 6973    A Scheduler is
-0001d210: 2074 7970 6963 616c 6c79 2073 7461 7274   typically start
-0001d220: 6564 2065 6974 6865 7220 7769 7468 2074  ed either with t
-0001d230: 6865 2060 6064 6173 6b20 7363 6865 6475  he ``dask schedu
-0001d240: 6c65 7260 600a 2020 2020 6578 6563 7574  ler``.    execut
-0001d250: 6162 6c65 3a3a 0a0a 2020 2020 2020 2020  able::..        
-0001d260: 2024 2064 6173 6b20 7363 6865 6475 6c65   $ dask schedule
-0001d270: 720a 2020 2020 2020 2020 2053 6368 6564  r.         Sched
-0001d280: 756c 6572 2073 7461 7274 6564 2061 7420  uler started at 
-0001d290: 3132 372e 302e 302e 313a 3837 3836 0a0a  127.0.0.1:8786..
-0001d2a0: 2020 2020 4f72 2077 6974 6869 6e20 6120      Or within a 
-0001d2b0: 4c6f 6361 6c43 6c75 7374 6572 2061 2043  LocalCluster a C
-0001d2c0: 6c69 656e 7420 7374 6172 7473 2075 7020  lient starts up 
-0001d2d0: 7769 7468 6f75 7420 636f 6e6e 6563 7469  without connecti
-0001d2e0: 6f6e 0a20 2020 2069 6e66 6f72 6d61 7469  on.    informati
-0001d2f0: 6f6e 3a3a 0a0a 2020 2020 2020 2020 3e3e  on::..        >>
-0001d300: 3e20 6320 3d20 436c 6965 6e74 2829 2020  > c = Client()  
-0001d310: 2320 646f 6374 6573 743a 202b 534b 4950  # doctest: +SKIP
-0001d320: 0a20 2020 2020 2020 203e 3e3e 2063 2e63  .        >>> c.c
-0001d330: 6c75 7374 6572 2e73 6368 6564 756c 6572  luster.scheduler
-0001d340: 2020 2320 646f 6374 6573 743a 202b 534b    # doctest: +SK
-0001d350: 4950 0a20 2020 2020 2020 2053 6368 6564  IP.        Sched
-0001d360: 756c 6572 282e 2e2e 290a 0a20 2020 2055  uler(...)..    U
-0001d370: 7365 7273 2074 7970 6963 616c 6c79 2064  sers typically d
-0001d380: 6f20 6e6f 7420 696e 7465 7261 6374 2077  o not interact w
-0001d390: 6974 6820 7468 6520 7363 6865 6475 6c65  ith the schedule
-0001d3a0: 7220 6469 7265 6374 6c79 2062 7574 2072  r directly but r
-0001d3b0: 6174 6865 7220 7769 7468 0a20 2020 2074  ather with.    t
-0001d3c0: 6865 2063 6c69 656e 7420 6f62 6a65 6374  he client object
-0001d3d0: 2060 6043 6c69 656e 7460 602e 0a0a 2020   ``Client``...  
-0001d3e0: 2020 5468 6520 6060 636f 6e74 6163 745f    The ``contact_
-0001d3f0: 6164 6472 6573 7360 6020 7061 7261 6d65  address`` parame
-0001d400: 7465 7220 616c 6c6f 7773 2074 6f20 6164  ter allows to ad
-0001d410: 7665 7274 6973 6520 6120 7370 6563 6966  vertise a specif
-0001d420: 6963 2061 6464 7265 7373 2074 6f0a 2020  ic address to.  
-0001d430: 2020 7468 6520 776f 726b 6572 7320 666f    the workers fo
-0001d440: 7220 636f 6d6d 756e 6963 6174 696f 6e20  r communication 
-0001d450: 7769 7468 2074 6865 2073 6368 6564 756c  with the schedul
-0001d460: 6572 2c20 7768 6963 6820 6973 2064 6966  er, which is dif
-0001d470: 6665 7265 6e74 2074 6861 6e0a 2020 2020  ferent than.    
-0001d480: 7468 6520 6164 6472 6573 7320 7468 6520  the address the 
-0001d490: 7363 6865 6475 6c65 7220 6269 6e64 7320  scheduler binds 
-0001d4a0: 746f 2e20 5468 6973 2069 7320 7573 6566  to. This is usef
-0001d4b0: 756c 2077 6865 6e20 7468 6520 7363 6865  ul when the sche
-0001d4c0: 6475 6c65 720a 2020 2020 6c69 7374 656e  duler.    listen
-0001d4d0: 7320 6f6e 2061 2070 7269 7661 7465 2061  s on a private a
-0001d4e0: 6464 7265 7373 2c20 7768 6963 6820 7468  ddress, which th
-0001d4f0: 6572 6566 6f72 6520 6361 6e6e 6f74 2062  erefore cannot b
-0001d500: 6520 7573 6564 2062 7920 7468 6520 776f  e used by the wo
-0001d510: 726b 6572 730a 2020 2020 746f 2063 6f6e  rkers.    to con
-0001d520: 7461 6374 2069 742e 0a0a 2020 2020 2a2a  tact it...    **
-0001d530: 5374 6174 652a 2a0a 0a20 2020 2054 6865  State**..    The
-0001d540: 2073 6368 6564 756c 6572 2063 6f6e 7461   scheduler conta
-0001d550: 696e 7320 7468 6520 666f 6c6c 6f77 696e  ins the followin
-0001d560: 6720 7374 6174 6520 7661 7269 6162 6c65  g state variable
-0001d570: 732e 2020 4561 6368 2076 6172 6961 626c  s.  Each variabl
-0001d580: 6520 6973 0a20 2020 206c 6973 7465 6420  e is.    listed 
-0001d590: 616c 6f6e 6720 7769 7468 2077 6861 7420  along with what 
-0001d5a0: 6974 2073 746f 7265 7320 616e 6420 6120  it stores and a 
-0001d5b0: 6272 6965 6620 6465 7363 7269 7074 696f  brief descriptio
-0001d5c0: 6e2e 0a0a 2020 2020 2a20 2a2a 7461 736b  n...    * **task
-0001d5d0: 733a 2a2a 2060 607b 7461 736b 206b 6579  s:** ``{task key
-0001d5e0: 3a20 5461 736b 5374 6174 657d 6060 0a20  : TaskState}``. 
-0001d5f0: 2020 2020 2020 2054 6173 6b73 2063 7572         Tasks cur
-0001d600: 7265 6e74 6c79 206b 6e6f 776e 2074 6f20  rently known to 
-0001d610: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
-0001d620: 2020 2a20 2a2a 756e 7275 6e6e 6162 6c65    * **unrunnable
-0001d630: 3a2a 2a20 6060 7b54 6173 6b53 7461 7465  :** ``{TaskState
-0001d640: 7d60 600a 2020 2020 2020 2020 5461 736b  }``.        Task
-0001d650: 7320 696e 2074 6865 2022 6e6f 2d77 6f72  s in the "no-wor
-0001d660: 6b65 7222 2073 7461 7465 0a0a 2020 2020  ker" state..    
-0001d670: 2a20 2a2a 776f 726b 6572 733a 2a2a 2060  * **workers:** `
-0001d680: 607b 776f 726b 6572 206b 6579 3a20 576f  `{worker key: Wo
-0001d690: 726b 6572 5374 6174 657d 6060 0a20 2020  rkerState}``.   
-0001d6a0: 2020 2020 2057 6f72 6b65 7273 2063 7572       Workers cur
-0001d6b0: 7265 6e74 6c79 2063 6f6e 6e65 6374 6564  rently connected
-0001d6c0: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
-0001d6d0: 720a 2020 2020 2a20 2a2a 6964 6c65 3a2a  r.    * **idle:*
-0001d6e0: 2a20 6060 7b57 6f72 6b65 7253 7461 7465  * ``{WorkerState
-0001d6f0: 7d60 603a 0a20 2020 2020 2020 2053 6574  }``:.        Set
-0001d700: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
-0001d710: 2061 7265 206e 6f74 2066 756c 6c79 2075   are not fully u
-0001d720: 7469 6c69 7a65 640a 2020 2020 2a20 2a2a  tilized.    * **
-0001d730: 7361 7475 7261 7465 643a 2a2a 2060 607b  saturated:** ``{
-0001d740: 576f 726b 6572 5374 6174 657d 6060 3a0a  WorkerState}``:.
-0001d750: 2020 2020 2020 2020 5365 7420 6f66 2077          Set of w
-0001d760: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
-0001d770: 6e6f 7420 6f76 6572 2d75 7469 6c69 7a65  not over-utilize
-0001d780: 640a 0a20 2020 202a 202a 2a68 6f73 745f  d..    * **host_
-0001d790: 696e 666f 3a2a 2a20 6060 7b68 6f73 746e  info:** ``{hostn
-0001d7a0: 616d 653a 2064 6963 747d 6060 3a0a 2020  ame: dict}``:.  
-0001d7b0: 2020 2020 2020 496e 666f 726d 6174 696f        Informatio
-0001d7c0: 6e20 6162 6f75 7420 6561 6368 2077 6f72  n about each wor
-0001d7d0: 6b65 7220 686f 7374 0a0a 2020 2020 2a20  ker host..    * 
-0001d7e0: 2a2a 636c 6965 6e74 733a 2a2a 2060 607b  **clients:** ``{
-0001d7f0: 636c 6965 6e74 206b 6579 3a20 436c 6965  client key: Clie
-0001d800: 6e74 5374 6174 657d 6060 0a20 2020 2020  ntState}``.     
-0001d810: 2020 2043 6c69 656e 7473 2063 7572 7265     Clients curre
-0001d820: 6e74 6c79 2063 6f6e 6e65 6374 6564 2074  ntly connected t
-0001d830: 6f20 7468 6520 7363 6865 6475 6c65 720a  o the scheduler.
-0001d840: 0a20 2020 202a 202a 2a73 6572 7669 6365  .    * **service
-0001d850: 733a 2a2a 2060 607b 7374 723a 2070 6f72  s:** ``{str: por
-0001d860: 747d 6060 3a0a 2020 2020 2020 2020 4f74  t}``:.        Ot
-0001d870: 6865 7220 7365 7276 6963 6573 2072 756e  her services run
-0001d880: 6e69 6e67 206f 6e20 7468 6973 2073 6368  ning on this sch
-0001d890: 6564 756c 6572 2c20 6c69 6b65 2042 6f6b  eduler, like Bok
-0001d8a0: 6568 0a20 2020 202a 202a 2a6c 6f6f 703a  eh.    * **loop:
-0001d8b0: 2a2a 2060 6049 4f4c 6f6f 7060 603a 0a20  ** ``IOLoop``:. 
-0001d8c0: 2020 2020 2020 2054 6865 2072 756e 6e69         The runni
-0001d8d0: 6e67 2054 6f72 6e61 646f 2049 4f4c 6f6f  ng Tornado IOLoo
-0001d8e0: 700a 2020 2020 2a20 2a2a 636c 6965 6e74  p.    * **client
-0001d8f0: 5f63 6f6d 6d73 3a2a 2a20 6060 7b63 6c69  _comms:** ``{cli
-0001d900: 656e 7420 6b65 793a 2043 6f6d 6d7d 6060  ent key: Comm}``
-0001d910: 0a20 2020 2020 2020 2046 6f72 2065 6163  .        For eac
-0001d920: 6820 636c 6965 6e74 2c20 6120 436f 6d6d  h client, a Comm
-0001d930: 206f 626a 6563 7420 7573 6564 2074 6f20   object used to 
-0001d940: 7265 6365 6976 6520 7461 736b 2072 6571  receive task req
-0001d950: 7565 7374 7320 616e 640a 2020 2020 2020  uests and.      
-0001d960: 2020 7265 706f 7274 2074 6173 6b20 7374    report task st
-0001d970: 6174 7573 2075 7064 6174 6573 2e0a 2020  atus updates..  
-0001d980: 2020 2a20 2a2a 7374 7265 616d 5f63 6f6d    * **stream_com
-0001d990: 6d73 3a2a 2a20 6060 7b77 6f72 6b65 7220  ms:** ``{worker 
-0001d9a0: 6b65 793a 2043 6f6d 6d7d 6060 0a20 2020  key: Comm}``.   
-0001d9b0: 2020 2020 2046 6f72 2065 6163 6820 776f       For each wo
-0001d9c0: 726b 6572 2c20 6120 436f 6d6d 206f 626a  rker, a Comm obj
-0001d9d0: 6563 7420 6672 6f6d 2077 6869 6368 2077  ect from which w
-0001d9e0: 6520 626f 7468 2061 6363 6570 7420 7374  e both accept st
-0001d9f0: 696d 756c 6920 616e 640a 2020 2020 2020  imuli and.      
-0001da00: 2020 7265 706f 7274 2072 6573 756c 7473    report results
-0001da10: 0a20 2020 202a 202a 2a74 6173 6b5f 6475  .    * **task_du
-0001da20: 7261 7469 6f6e 3a2a 2a20 6060 7b6b 6579  ration:** ``{key
-0001da30: 2d70 7265 6669 783a 2074 696d 657d 6060  -prefix: time}``
-0001da40: 0a20 2020 2020 2020 2054 696d 6520 7765  .        Time we
-0001da50: 2065 7870 6563 7420 6365 7274 6169 6e20   expect certain 
-0001da60: 6675 6e63 7469 6f6e 7320 746f 2074 616b  functions to tak
-0001da70: 652c 2065 2e67 2e20 6060 7b27 7375 6d27  e, e.g. ``{'sum'
-0001da80: 3a20 302e 3235 7d60 600a 2020 2020 2222  : 0.25}``.    ""
-0001da90: 220a 0a20 2020 2064 6566 6175 6c74 5f70  "..    default_p
-0001daa0: 6f72 7420 3d20 3837 3836 0a20 2020 205f  ort = 8786.    _
-0001dab0: 696e 7374 616e 6365 733a 2043 6c61 7373  instances: Class
-0001dac0: 5661 725b 7765 616b 7265 662e 5765 616b  Var[weakref.Weak
-0001dad0: 5365 745b 5363 6865 6475 6c65 725d 5d20  Set[Scheduler]] 
-0001dae0: 3d20 7765 616b 7265 662e 5765 616b 5365  = weakref.WeakSe
-0001daf0: 7428 290a 0a20 2020 2064 6566 205f 5f69  t()..    def __i
-0001db00: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
-0001db10: 656c 662c 0a20 2020 2020 2020 206c 6f6f  elf,.        loo
-0001db20: 703d 4e6f 6e65 2c0a 2020 2020 2020 2020  p=None,.        
-0001db30: 6465 6c65 7465 5f69 6e74 6572 7661 6c3d  delete_interval=
-0001db40: 2235 3030 6d73 222c 0a20 2020 2020 2020  "500ms",.       
-0001db50: 2073 796e 6368 726f 6e69 7a65 5f77 6f72   synchronize_wor
-0001db60: 6b65 725f 696e 7465 7276 616c 3d22 3630  ker_interval="60
-0001db70: 7322 2c0a 2020 2020 2020 2020 7365 7276  s",.        serv
-0001db80: 6963 6573 3d4e 6f6e 652c 0a20 2020 2020  ices=None,.     
-0001db90: 2020 2073 6572 7669 6365 5f6b 7761 7267     service_kwarg
-0001dba0: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
-0001dbb0: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-0001dbc0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2065  =None,.        e
-0001dbd0: 7874 656e 7369 6f6e 733d 4e6f 6e65 2c0a  xtensions=None,.
-0001dbe0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-0001dbf0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2073  =None,.        s
-0001dc00: 6368 6564 756c 6572 5f66 696c 653d 4e6f  cheduler_file=No
-0001dc10: 6e65 2c0a 2020 2020 2020 2020 7365 6375  ne,.        secu
-0001dc20: 7269 7479 3d4e 6f6e 652c 0a20 2020 2020  rity=None,.     
-0001dc30: 2020 2077 6f72 6b65 725f 7474 6c3d 4e6f     worker_ttl=No
-0001dc40: 6e65 2c0a 2020 2020 2020 2020 6964 6c65  ne,.        idle
-0001dc50: 5f74 696d 656f 7574 3d4e 6f6e 652c 0a20  _timeout=None,. 
-0001dc60: 2020 2020 2020 2069 6e74 6572 6661 6365         interface
-0001dc70: 3d4e 6f6e 652c 0a20 2020 2020 2020 2068  =None,.        h
-0001dc80: 6f73 743d 4e6f 6e65 2c0a 2020 2020 2020  ost=None,.      
-0001dc90: 2020 706f 7274 3d30 2c0a 2020 2020 2020    port=0,.      
-0001dca0: 2020 7072 6f74 6f63 6f6c 3d4e 6f6e 652c    protocol=None,
-0001dcb0: 0a20 2020 2020 2020 2064 6173 6862 6f61  .        dashboa
-0001dcc0: 7264 5f61 6464 7265 7373 3d4e 6f6e 652c  rd_address=None,
-0001dcd0: 0a20 2020 2020 2020 2064 6173 6862 6f61  .        dashboa
-0001dce0: 7264 3d4e 6f6e 652c 0a20 2020 2020 2020  rd=None,.       
-0001dcf0: 2068 7474 705f 7072 6566 6978 3d22 2f22   http_prefix="/"
-0001dd00: 2c0a 2020 2020 2020 2020 7072 656c 6f61  ,.        preloa
-0001dd10: 643d 4e6f 6e65 2c0a 2020 2020 2020 2020  d=None,.        
-0001dd20: 7072 656c 6f61 645f 6172 6776 3d28 292c  preload_argv=(),
-0001dd30: 0a20 2020 2020 2020 2070 6c75 6769 6e73  .        plugins
-0001dd40: 3d28 292c 0a20 2020 2020 2020 2063 6f6e  =(),.        con
-0001dd50: 7461 6374 5f61 6464 7265 7373 3d4e 6f6e  tact_address=Non
-0001dd60: 652c 0a20 2020 2020 2020 2074 7261 6e73  e,.        trans
-0001dd70: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
-0001dd80: 783d 4661 6c73 652c 0a20 2020 2020 2020  x=False,.       
-0001dd90: 206a 7570 7974 6572 3d46 616c 7365 2c0a   jupyter=False,.
-0001dda0: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
-0001ddb0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-0001ddc0: 2069 6620 6c6f 6f70 2069 7320 6e6f 7420   if loop is not 
-0001ddd0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001dde0: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-0001ddf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001de00: 2022 7468 6520 6c6f 6f70 206b 7761 7267   "the loop kwarg
-0001de10: 2074 6f20 5363 6865 6475 6c65 7220 6973   to Scheduler is
-0001de20: 2064 6570 7265 6361 7465 6422 2c0a 2020   deprecated",.  
-0001de30: 2020 2020 2020 2020 2020 2020 2020 4465                De
-0001de40: 7072 6563 6174 696f 6e57 6172 6e69 6e67  precationWarning
-0001de50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001de60: 2020 7374 6163 6b6c 6576 656c 3d32 2c0a    stacklevel=2,.
-0001de70: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0001de80: 2020 2020 2020 2073 656c 662e 6c6f 6f70         self.loop
-0001de90: 203d 2073 656c 662e 696f 5f6c 6f6f 7020   = self.io_loop 
-0001dea0: 3d20 494f 4c6f 6f70 2e63 7572 7265 6e74  = IOLoop.current
-0001deb0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001dec0: 5f73 6574 7570 5f6c 6f67 6769 6e67 286c  _setup_logging(l
-0001ded0: 6f67 6765 7229 0a0a 2020 2020 2020 2020  ogger)..        
-0001dee0: 2320 4174 7472 6962 7574 6573 0a20 2020  # Attributes.   
-0001def0: 2020 2020 2069 6620 636f 6e74 6163 745f       if contact_
-0001df00: 6164 6472 6573 7320 6973 204e 6f6e 653a  address is None:
-0001df10: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0001df20: 7461 6374 5f61 6464 7265 7373 203d 2064  tact_address = d
-0001df30: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0001df40: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0001df50: 6475 6c65 722e 636f 6e74 6163 742d 6164  duler.contact-ad
-0001df60: 6472 6573 7322 290a 2020 2020 2020 2020  dress").        
-0001df70: 7365 6c66 2e63 6f6e 7461 6374 5f61 6464  self.contact_add
-0001df80: 7265 7373 203d 2063 6f6e 7461 6374 5f61  ress = contact_a
-0001df90: 6464 7265 7373 0a20 2020 2020 2020 2069  ddress.        i
-0001dfa0: 6620 616c 6c6f 7765 645f 6661 696c 7572  f allowed_failur
-0001dfb0: 6573 2069 7320 4e6f 6e65 3a0a 2020 2020  es is None:.    
-0001dfc0: 2020 2020 2020 2020 616c 6c6f 7765 645f          allowed_
-0001dfd0: 6661 696c 7572 6573 203d 2064 6173 6b2e  failures = dask.
-0001dfe0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0001dff0: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001e000: 722e 616c 6c6f 7765 642d 6661 696c 7572  r.allowed-failur
-0001e010: 6573 2229 0a20 2020 2020 2020 2073 656c  es").        sel
-0001e020: 662e 616c 6c6f 7765 645f 6661 696c 7572  f.allowed_failur
-0001e030: 6573 203d 2061 6c6c 6f77 6564 5f66 6169  es = allowed_fai
-0001e040: 6c75 7265 730a 2020 2020 2020 2020 6966  lures.        if
-0001e050: 2076 616c 6964 6174 6520 6973 204e 6f6e   validate is Non
-0001e060: 653a 0a20 2020 2020 2020 2020 2020 2076  e:.            v
-0001e070: 616c 6964 6174 6520 3d20 6461 736b 2e63  alidate = dask.c
-0001e080: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0001e090: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0001e0a0: 2e76 616c 6964 6174 6522 290a 2020 2020  .validate").    
-0001e0b0: 2020 2020 7365 6c66 2e70 726f 6320 3d20      self.proc = 
-0001e0c0: 7073 7574 696c 2e50 726f 6365 7373 2829  psutil.Process()
-0001e0d0: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
-0001e0e0: 6c65 7465 5f69 6e74 6572 7661 6c20 3d20  lete_interval = 
-0001e0f0: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-0001e100: 6465 6c65 7465 5f69 6e74 6572 7661 6c2c  delete_interval,
-0001e110: 2064 6566 6175 6c74 3d22 6d73 2229 0a20   default="ms"). 
-0001e120: 2020 2020 2020 2073 656c 662e 7379 6e63         self.sync
-0001e130: 6872 6f6e 697a 655f 776f 726b 6572 5f69  hronize_worker_i
-0001e140: 6e74 6572 7661 6c20 3d20 7061 7273 655f  nterval = parse_
-0001e150: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
-0001e160: 2020 2020 2020 2073 796e 6368 726f 6e69         synchroni
-0001e170: 7a65 5f77 6f72 6b65 725f 696e 7465 7276  ze_worker_interv
-0001e180: 616c 2c20 6465 6661 756c 743d 226d 7322  al, default="ms"
-0001e190: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001e1a0: 2020 2073 656c 662e 7365 7276 6963 655f     self.service_
-0001e1b0: 7370 6563 7320 3d20 7365 7276 6963 6573  specs = services
-0001e1c0: 206f 7220 7b7d 0a20 2020 2020 2020 2073   or {}.        s
-0001e1d0: 656c 662e 7365 7276 6963 655f 6b77 6172  elf.service_kwar
-0001e1e0: 6773 203d 2073 6572 7669 6365 5f6b 7761  gs = service_kwa
-0001e1f0: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
-0001e200: 2020 7365 6c66 2e73 6572 7669 6365 7320    self.services 
-0001e210: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0001e220: 662e 7363 6865 6475 6c65 725f 6669 6c65  f.scheduler_file
-0001e230: 203d 2073 6368 6564 756c 6572 5f66 696c   = scheduler_fil
-0001e240: 650a 2020 2020 2020 2020 776f 726b 6572  e.        worker
-0001e250: 5f74 746c 203d 2077 6f72 6b65 725f 7474  _ttl = worker_tt
-0001e260: 6c20 6f72 2064 6173 6b2e 636f 6e66 6967  l or dask.config
-0001e270: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0001e280: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
-0001e290: 6572 2d74 746c 2229 0a20 2020 2020 2020  er-ttl").       
-0001e2a0: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
-0001e2b0: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
-0001e2c0: 7461 2877 6f72 6b65 725f 7474 6c29 2069  ta(worker_ttl) i
-0001e2d0: 6620 776f 726b 6572 5f74 746c 2065 6c73  f worker_ttl els
-0001e2e0: 6520 4e6f 6e65 0a20 2020 2020 2020 2069  e None.        i
-0001e2f0: 646c 655f 7469 6d65 6f75 7420 3d20 6964  dle_timeout = id
-0001e300: 6c65 5f74 696d 656f 7574 206f 7220 6461  le_timeout or da
-0001e310: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
-0001e320: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
-0001e330: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001e340: 722e 6964 6c65 2d74 696d 656f 7574 220a  r.idle-timeout".
-0001e350: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001e360: 2020 6966 2069 646c 655f 7469 6d65 6f75    if idle_timeou
-0001e370: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
-0001e380: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
-0001e390: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
-0001e3a0: 7461 2869 646c 655f 7469 6d65 6f75 7429  ta(idle_timeout)
-0001e3b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001e3c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001e3d0: 6964 6c65 5f74 696d 656f 7574 203d 204e  idle_timeout = N
-0001e3e0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0001e3f0: 2e69 646c 655f 7369 6e63 6520 3d20 7469  .idle_since = ti
-0001e400: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
-0001e410: 662e 7469 6d65 5f73 7461 7274 6564 203d  f.time_started =
-0001e420: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-0001e430: 2020 2320 636f 6d70 6174 6962 696c 6974    # compatibilit
-0001e440: 7920 666f 7220 6461 736b 2d67 6174 6577  y for dask-gatew
-0001e450: 6179 0a20 2020 2020 2020 2073 656c 662e  ay.        self.
-0001e460: 5f6c 6f63 6b20 3d20 6173 796e 6369 6f2e  _lock = asyncio.
-0001e470: 4c6f 636b 2829 0a20 2020 2020 2020 2073  Lock().        s
-0001e480: 656c 662e 6261 6e64 7769 6474 685f 776f  elf.bandwidth_wo
-0001e490: 726b 6572 7320 3d20 6465 6661 756c 7464  rkers = defaultd
-0001e4a0: 6963 7428 666c 6f61 7429 0a20 2020 2020  ict(float).     
-0001e4b0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-0001e4c0: 685f 7479 7065 7320 3d20 6465 6661 756c  h_types = defaul
-0001e4d0: 7464 6963 7428 666c 6f61 7429 0a0a 2020  tdict(float)..  
-0001e4e0: 2020 2020 2020 7365 6c66 2e63 756d 756c        self.cumul
-0001e4f0: 6174 6976 655f 776f 726b 6572 5f6d 6574  ative_worker_met
-0001e500: 7269 6373 203d 2064 6566 6175 6c74 6469  rics = defaultdi
-0001e510: 6374 2866 6c6f 6174 290a 0a20 2020 2020  ct(float)..     
-0001e520: 2020 2069 6620 6e6f 7420 7072 656c 6f61     if not preloa
-0001e530: 643a 0a20 2020 2020 2020 2020 2020 2070  d:.            p
-0001e540: 7265 6c6f 6164 203d 2064 6173 6b2e 636f  reload = dask.co
-0001e550: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-0001e560: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-0001e570: 7072 656c 6f61 6422 290a 2020 2020 2020  preload").      
-0001e580: 2020 6966 206e 6f74 2070 7265 6c6f 6164    if not preload
-0001e590: 5f61 7267 763a 0a20 2020 2020 2020 2020  _argv:.         
-0001e5a0: 2020 2070 7265 6c6f 6164 5f61 7267 7620     preload_argv 
-0001e5b0: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
-0001e5c0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0001e5d0: 6368 6564 756c 6572 2e70 7265 6c6f 6164  cheduler.preload
-0001e5e0: 2d61 7267 7622 290a 2020 2020 2020 2020  -argv").        
-0001e5f0: 7365 6c66 2e70 7265 6c6f 6164 7320 3d20  self.preloads = 
-0001e600: 7072 656c 6f61 6469 6e67 2e70 726f 6365  preloading.proce
-0001e610: 7373 5f70 7265 6c6f 6164 7328 7365 6c66  ss_preloads(self
-0001e620: 2c20 7072 656c 6f61 642c 2070 7265 6c6f  , preload, prelo
-0001e630: 6164 5f61 7267 7629 0a0a 2020 2020 2020  ad_argv)..      
-0001e640: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001e650: 7365 6375 7269 7479 2c20 6469 6374 293a  security, dict):
-0001e660: 0a20 2020 2020 2020 2020 2020 2073 6563  .            sec
-0001e670: 7572 6974 7920 3d20 5365 6375 7269 7479  urity = Security
-0001e680: 282a 2a73 6563 7572 6974 7929 0a20 2020  (**security).   
-0001e690: 2020 2020 2073 656c 662e 7365 6375 7269       self.securi
-0001e6a0: 7479 203d 2073 6563 7572 6974 7920 6f72  ty = security or
-0001e6b0: 2053 6563 7572 6974 7928 290a 2020 2020   Security().    
-0001e6c0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0001e6d0: 7461 6e63 6528 7365 6c66 2e73 6563 7572  tance(self.secur
-0001e6e0: 6974 792c 2053 6563 7572 6974 7929 0a20  ity, Security). 
-0001e6f0: 2020 2020 2020 2073 656c 662e 636f 6e6e         self.conn
-0001e700: 6563 7469 6f6e 5f61 7267 7320 3d20 7365  ection_args = se
-0001e710: 6c66 2e73 6563 7572 6974 792e 6765 745f  lf.security.get_
-0001e720: 636f 6e6e 6563 7469 6f6e 5f61 7267 7328  connection_args(
-0001e730: 2273 6368 6564 756c 6572 2229 0a20 2020  "scheduler").   
-0001e740: 2020 2020 2073 656c 662e 636f 6e6e 6563       self.connec
-0001e750: 7469 6f6e 5f61 7267 735b 2268 616e 6473  tion_args["hands
-0001e760: 6861 6b65 5f6f 7665 7272 6964 6573 225d  hake_overrides"]
-0001e770: 203d 207b 2020 2320 636f 6d6d 6f6e 2064   = {  # common d
-0001e780: 656e 6f6d 696e 6174 6f72 0a20 2020 2020  enominator.     
-0001e790: 2020 2020 2020 2022 7069 636b 6c65 2d70         "pickle-p
-0001e7a0: 726f 746f 636f 6c22 3a20 340a 2020 2020  rotocol": 4.    
-0001e7b0: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
-0001e7c0: 656c 662e 5f73 7461 7274 5f61 6464 7265  elf._start_addre
-0001e7d0: 7373 203d 2061 6464 7265 7373 6573 5f66  ss = addresses_f
-0001e7e0: 726f 6d5f 7573 6572 5f61 7267 7328 0a20  rom_user_args(. 
-0001e7f0: 2020 2020 2020 2020 2020 2068 6f73 743d             host=
-0001e800: 686f 7374 2c0a 2020 2020 2020 2020 2020  host,.          
-0001e810: 2020 706f 7274 3d70 6f72 742c 0a20 2020    port=port,.   
-0001e820: 2020 2020 2020 2020 2069 6e74 6572 6661           interfa
-0001e830: 6365 3d69 6e74 6572 6661 6365 2c0a 2020  ce=interface,.  
-0001e840: 2020 2020 2020 2020 2020 7072 6f74 6f63            protoc
-0001e850: 6f6c 3d70 726f 746f 636f 6c2c 0a20 2020  ol=protocol,.   
-0001e860: 2020 2020 2020 2020 2073 6563 7572 6974           securit
-0001e870: 793d 7365 6375 7269 7479 2c0a 2020 2020  y=security,.    
-0001e880: 2020 2020 2020 2020 6465 6661 756c 745f          default_
-0001e890: 706f 7274 3d73 656c 662e 6465 6661 756c  port=self.defaul
-0001e8a0: 745f 706f 7274 2c0a 2020 2020 2020 2020  t_port,.        
-0001e8b0: 290a 0a20 2020 2020 2020 2068 7474 705f  )..        http_
-0001e8c0: 7365 7276 6572 5f6d 6f64 756c 6573 203d  server_modules =
-0001e8d0: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
-0001e8e0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
-0001e8f0: 6865 6475 6c65 722e 6874 7470 2e72 6f75  heduler.http.rou
-0001e900: 7465 7322 290a 2020 2020 2020 2020 7368  tes").        sh
-0001e910: 6f77 5f64 6173 6862 6f61 7264 203d 2064  ow_dashboard = d
-0001e920: 6173 6862 6f61 7264 206f 7220 2864 6173  ashboard or (das
-0001e930: 6862 6f61 7264 2069 7320 4e6f 6e65 2061  hboard is None a
-0001e940: 6e64 2064 6173 6862 6f61 7264 5f61 6464  nd dashboard_add
-0001e950: 7265 7373 290a 2020 2020 2020 2020 2320  ress).        # 
-0001e960: 696e 7374 616c 6c20 7661 6e69 6c6c 6120  install vanilla 
-0001e970: 726f 7574 6520 6966 2073 686f 775f 6461  route if show_da
-0001e980: 7368 626f 6172 6420 6275 7420 626f 6b65  shboard but boke
-0001e990: 6820 6973 206e 6f74 2069 6e73 7461 6c6c  h is not install
-0001e9a0: 6564 0a20 2020 2020 2020 2069 6620 7368  ed.        if sh
-0001e9b0: 6f77 5f64 6173 6862 6f61 7264 3a0a 2020  ow_dashboard:.  
-0001e9c0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0001e9d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001e9e0: 6d70 6f72 7420 6469 7374 7269 6275 7465  mport distribute
-0001e9f0: 642e 6461 7368 626f 6172 642e 7363 6865  d.dashboard.sche
-0001ea00: 6475 6c65 720a 2020 2020 2020 2020 2020  duler.          
-0001ea10: 2020 6578 6365 7074 2049 6d70 6f72 7445    except ImportE
-0001ea20: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0001ea30: 2020 2020 2020 7368 6f77 5f64 6173 6862        show_dashb
-0001ea40: 6f61 7264 203d 2046 616c 7365 0a20 2020  oard = False.   
-0001ea50: 2020 2020 2020 2020 2020 2020 2068 7474               htt
-0001ea60: 705f 7365 7276 6572 5f6d 6f64 756c 6573  p_server_modules
-0001ea70: 2e61 7070 656e 6428 2264 6973 7472 6962  .append("distrib
-0001ea80: 7574 6564 2e68 7474 702e 7363 6865 6475  uted.http.schedu
-0001ea90: 6c65 722e 6d69 7373 696e 675f 626f 6b65  ler.missing_boke
-0001eaa0: 6822 290a 2020 2020 2020 2020 726f 7574  h").        rout
-0001eab0: 6573 203d 2067 6574 5f68 616e 646c 6572  es = get_handler
-0001eac0: 7328 0a20 2020 2020 2020 2020 2020 2073  s(.            s
-0001ead0: 6572 7665 723d 7365 6c66 2c20 6d6f 6475  erver=self, modu
-0001eae0: 6c65 733d 6874 7470 5f73 6572 7665 725f  les=http_server_
-0001eaf0: 6d6f 6475 6c65 732c 2070 7265 6669 783d  modules, prefix=
-0001eb00: 6874 7470 5f70 7265 6669 780a 2020 2020  http_prefix.    
-0001eb10: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001eb20: 6c66 2e73 7461 7274 5f68 7474 705f 7365  lf.start_http_se
-0001eb30: 7276 6572 2872 6f75 7465 732c 2064 6173  rver(routes, das
-0001eb40: 6862 6f61 7264 5f61 6464 7265 7373 2c20  hboard_address, 
-0001eb50: 6465 6661 756c 745f 706f 7274 3d38 3738  default_port=878
-0001eb60: 3729 0a20 2020 2020 2020 2073 656c 662e  7).        self.
-0001eb70: 6a75 7079 7465 7220 3d20 6a75 7079 7465  jupyter = jupyte
-0001eb80: 720a 2020 2020 2020 2020 6966 2073 686f  r.        if sho
-0001eb90: 775f 6461 7368 626f 6172 643a 0a20 2020  w_dashboard:.   
-0001eba0: 2020 2020 2020 2020 2064 6973 7472 6962           distrib
-0001ebb0: 7574 6564 2e64 6173 6862 6f61 7264 2e73  uted.dashboard.s
-0001ebc0: 6368 6564 756c 6572 2e63 6f6e 6e65 6374  cheduler.connect
-0001ebd0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001ebe0: 2020 7365 6c66 2e68 7474 705f 6170 706c    self.http_appl
-0001ebf0: 6963 6174 696f 6e2c 2073 656c 662e 6874  ication, self.ht
-0001ec00: 7470 5f73 6572 7665 722c 2073 656c 662c  tp_server, self,
-0001ec10: 2070 7265 6669 783d 6874 7470 5f70 7265   prefix=http_pre
-0001ec20: 6669 780a 2020 2020 2020 2020 2020 2020  fix.            
-0001ec30: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-0001ec40: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
-0001ec50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001ec60: 2020 2020 2020 2020 2020 2020 6672 6f6d              from
-0001ec70: 206a 7570 7974 6572 5f73 6572 7665 722e   jupyter_server.
-0001ec80: 7365 7276 6572 6170 7020 696d 706f 7274  serverapp import
-0001ec90: 2053 6572 7665 7241 7070 0a20 2020 2020   ServerApp.     
-0001eca0: 2020 2020 2020 2065 7863 6570 7420 496d         except Im
-0001ecb0: 706f 7274 4572 726f 723a 0a20 2020 2020  portError:.     
-0001ecc0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0001ecd0: 2049 6d70 6f72 7445 7272 6f72 280a 2020   ImportError(.  
-0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecf0: 2020 2249 6e20 6f72 6465 7220 746f 2075    "In order to u
-0001ed00: 7365 2074 6865 2044 6173 6b20 6a75 7079  se the Dask jupy
-0001ed10: 7465 7220 6f70 7469 6f6e 2079 6f75 2022  ter option you "
-0001ed20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ed30: 2020 2020 2022 6e65 6564 2074 6f20 6861       "need to ha
-0001ed40: 7665 206a 7570 7974 6572 6c61 6220 696e  ve jupyterlab in
-0001ed50: 7374 616c 6c65 6422 0a20 2020 2020 2020  stalled".       
-0001ed60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001ed70: 2020 2020 2020 2066 726f 6d20 7472 6169         from trai
-0001ed80: 746c 6574 732e 636f 6e66 6967 2069 6d70  tlets.config imp
-0001ed90: 6f72 7420 436f 6e66 6967 0a0a 2020 2020  ort Config..    
-0001eda0: 2020 2020 2020 2020 6a20 3d20 5365 7276          j = Serv
-0001edb0: 6572 4170 702e 696e 7374 616e 6365 280a  erApp.instance(.
-0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edd0: 636f 6e66 6967 3d43 6f6e 6669 6728 0a20  config=Config(. 
-0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0001ee00: 2020 2020 2020 2020 2020 2020 2022 5365               "Se
-0001ee10: 7276 6572 4170 7022 3a20 7b0a 2020 2020  rverApp": {.    
-0001ee20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee30: 2020 2020 2020 2020 2262 6173 655f 7572          "base_ur
-0001ee40: 6c22 3a20 226a 7570 7974 6572 222c 0a20  l": "jupyter",. 
-0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee60: 2020 2020 2020 2020 2020 2023 2053 4543             # SEC
-0001ee70: 5552 4954 593a 2057 6520 7573 7561 6c6c  URITY: We usuall
-0001ee80: 7920 6578 7065 6374 2074 6865 2064 6173  y expect the das
-0001ee90: 6862 6f61 7264 2074 6f20 6265 2061 2072  hboard to be a r
-0001eea0: 6561 642d 6f6e 6c79 2076 6965 7720 696e  ead-only view in
-0001eeb0: 746f 0a20 2020 2020 2020 2020 2020 2020  to.             
-0001eec0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001eed0: 2074 6865 2073 6368 6564 756c 6572 2061   the scheduler a
-0001eee0: 6374 6976 6974 792e 2048 6f77 6576 6572  ctivity. However
-0001eef0: 2c20 6279 2061 6464 696e 6720 616e 206f  , by adding an o
-0001ef00: 7065 6e20 4a75 7079 7465 7220 6170 706c  pen Jupyter appl
-0001ef10: 6963 6174 696f 6e0a 2020 2020 2020 2020  ication.        
-0001ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef30: 2020 2020 2320 7765 2061 7265 2061 6c6c      # we are all
-0001ef40: 6f77 696e 6720 6172 6269 7472 6172 7920  owing arbitrary 
-0001ef50: 7265 6d6f 7465 2063 6f64 6520 6578 6563  remote code exec
-0001ef60: 7574 696f 6e20 6f6e 2074 6865 2073 6368  ution on the sch
-0001ef70: 6564 756c 6572 2076 6961 2074 6865 0a20  eduler via the. 
-0001ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef90: 2020 2020 2020 2020 2020 2023 2064 6173             # das
-0001efa0: 6862 6f61 7264 2073 6572 7665 722e 2054  hboard server. T
-0001efb0: 6869 7320 6f70 7469 6f6e 2073 686f 756c  his option shoul
-0001efc0: 6420 6f6e 6c79 2062 6520 7573 6564 2077  d only be used w
-0001efd0: 6865 6e20 7468 6520 6461 7368 626f 6172  hen the dashboar
-0001efe0: 6420 6973 0a20 2020 2020 2020 2020 2020  d is.           
-0001eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f000: 2023 2070 726f 7465 6374 6564 2076 6961   # protected via
-0001f010: 206f 7468 6572 206d 6561 6e73 2c20 6f72   other means, or
-0001f020: 2077 6865 6e20 796f 7520 646f 6e27 7420   when you don't 
-0001f030: 6361 7265 2061 626f 7574 2063 6c75 7374  care about clust
-0001f040: 6572 2073 6563 7572 6974 792e 0a20 2020  er security..   
-0001f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f060: 2020 2020 2020 2020 2022 746f 6b65 6e22           "token"
-0001f070: 3a20 2222 2c0a 2020 2020 2020 2020 2020  : "",.          
-0001f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f090: 2020 2261 6c6c 6f77 5f72 656d 6f74 655f    "allow_remote_
-0001f0a0: 6163 6365 7373 223a 2054 7275 652c 0a20  access": True,. 
-0001f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0c0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0001f0d0: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
-0001f0e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001f0f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0001f100: 2020 2020 2020 2020 2020 206a 2e69 6e69             j.ini
-0001f110: 7469 616c 697a 6528 0a20 2020 2020 2020  tialize(.       
-0001f120: 2020 2020 2020 2020 206e 6577 5f68 7474           new_htt
-0001f130: 7073 6572 7665 723d 4661 6c73 652c 0a20  pserver=False,. 
-0001f140: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001f150: 7267 763d 5b5d 2c0a 2020 2020 2020 2020  rgv=[],.        
-0001f160: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001f170: 2020 7365 6c66 2e5f 6a75 7079 7465 725f    self._jupyter_
-0001f180: 7365 7276 6572 5f61 7070 6c69 6361 7469  server_applicati
-0001f190: 6f6e 203d 206a 0a20 2020 2020 2020 2020  on = j.         
-0001f1a0: 2020 2073 656c 662e 6874 7470 5f61 7070     self.http_app
-0001f1b0: 6c69 6361 7469 6f6e 2e61 6464 5f61 7070  lication.add_app
-0001f1c0: 6c69 6361 7469 6f6e 286a 2e77 6562 5f61  lication(j.web_a
-0001f1d0: 7070 290a 0a20 2020 2020 2020 2023 2043  pp)..        # C
-0001f1e0: 6f6d 6d75 6e69 6361 7469 6f6e 2073 7461  ommunication sta
-0001f1f0: 7465 0a20 2020 2020 2020 2073 656c 662e  te.        self.
-0001f200: 636c 6965 6e74 5f63 6f6d 6d73 203d 207b  client_comms = {
-0001f210: 7d0a 2020 2020 2020 2020 7365 6c66 2e73  }.        self.s
-0001f220: 7472 6561 6d5f 636f 6d6d 7320 3d20 7b7d  tream_comms = {}
-0001f230: 0a0a 2020 2020 2020 2020 2320 5461 736b  ..        # Task
-0001f240: 2073 7461 7465 0a20 2020 2020 2020 2074   state.        t
-0001f250: 6173 6b73 203d 207b 7d0a 0a20 2020 2020  asks = {}..     
-0001f260: 2020 2073 656c 662e 6765 6e65 7261 7469     self.generati
-0001f270: 6f6e 203d 2030 0a20 2020 2020 2020 2073  on = 0.        s
-0001f280: 656c 662e 5f6c 6173 745f 636c 6965 6e74  elf._last_client
-0001f290: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0001f2a0: 7365 6c66 2e5f 6c61 7374 5f74 696d 6520  self._last_time 
-0001f2b0: 3d20 300a 2020 2020 2020 2020 756e 7275  = 0.        unru
-0001f2c0: 6e6e 6162 6c65 203d 2073 6574 2829 0a20  nnable = set(). 
-0001f2d0: 2020 2020 2020 2071 7565 7565 643a 2048         queued: H
-0001f2e0: 6561 7053 6574 5b54 6173 6b53 7461 7465  eapSet[TaskState
-0001f2f0: 5d20 3d20 4865 6170 5365 7428 6b65 793d  ] = HeapSet(key=
-0001f300: 6f70 6572 6174 6f72 2e61 7474 7267 6574  operator.attrget
-0001f310: 7465 7228 2270 7269 6f72 6974 7922 2929  ter("priority"))
-0001f320: 0a0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
-0001f330: 6174 6173 6574 7320 3d20 7b7d 0a0a 2020  atasets = {}..  
-0001f340: 2020 2020 2020 2320 5072 6566 6978 2d6b        # Prefix-k
-0001f350: 6579 6564 2063 6f6e 7461 696e 6572 730a  eyed containers.
-0001f360: 0a20 2020 2020 2020 2023 2043 6c69 656e  .        # Clien
-0001f370: 7420 7374 6174 650a 2020 2020 2020 2020  t state.        
-0001f380: 636c 6965 6e74 7320 3d20 7b7d 0a0a 2020  clients = {}..  
-0001f390: 2020 2020 2020 2320 576f 726b 6572 2073        # Worker s
-0001f3a0: 7461 7465 0a20 2020 2020 2020 2077 6f72  tate.        wor
-0001f3b0: 6b65 7273 203d 2053 6f72 7465 6444 6963  kers = SortedDic
-0001f3c0: 7428 290a 0a20 2020 2020 2020 2068 6f73  t()..        hos
-0001f3d0: 745f 696e 666f 203d 207b 7d0a 2020 2020  t_info = {}.    
-0001f3e0: 2020 2020 7265 736f 7572 6365 7320 3d20      resources = 
-0001f3f0: 7b7d 0a20 2020 2020 2020 2061 6c69 6173  {}.        alias
-0001f400: 6573 203d 207b 7d0a 0a20 2020 2020 2020  es = {}..       
-0001f410: 2073 656c 662e 5f77 6f72 6b65 725f 636f   self._worker_co
-0001f420: 6c6c 6563 7469 6f6e 7320 3d20 5b0a 2020  llections = [.  
-0001f430: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0001f440: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
-0001f450: 6f73 745f 696e 666f 2c0a 2020 2020 2020  ost_info,.      
-0001f460: 2020 2020 2020 7265 736f 7572 6365 732c        resources,
-0001f470: 0a20 2020 2020 2020 2020 2020 2061 6c69  .            ali
-0001f480: 6173 6573 2c0a 2020 2020 2020 2020 5d0a  ases,.        ].
-0001f490: 0a20 2020 2020 2020 2073 656c 662e 6576  .        self.ev
-0001f4a0: 656e 7473 203d 2064 6566 6175 6c74 6469  ents = defaultdi
-0001f4b0: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0001f4c0: 7061 7274 6961 6c28 0a20 2020 2020 2020  partial(.       
-0001f4d0: 2020 2020 2020 2020 2064 6571 7565 2c20           deque, 
-0001f4e0: 6d61 786c 656e 3d64 6173 6b2e 636f 6e66  maxlen=dask.conf
-0001f4f0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0001f500: 7465 642e 7363 6865 6475 6c65 722e 6576  ted.scheduler.ev
-0001f510: 656e 7473 2d6c 6f67 2d6c 656e 6774 6822  ents-log-length"
-0001f520: 290a 2020 2020 2020 2020 2020 2020 290a  ).            ).
-0001f530: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0001f540: 2020 7365 6c66 2e65 7665 6e74 5f63 6f75    self.event_cou
-0001f550: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
-0001f560: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
-0001f570: 656c 662e 6576 656e 745f 7375 6273 6372  elf.event_subscr
-0001f580: 6962 6572 203d 2064 6566 6175 6c74 6469  iber = defaultdi
-0001f590: 6374 2873 6574 290a 2020 2020 2020 2020  ct(set).        
-0001f5a0: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
-0001f5b0: 696e 7320 3d20 7b7d 0a20 2020 2020 2020  ins = {}.       
-0001f5c0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-0001f5d0: 696e 7320 3d20 7b7d 0a0a 2020 2020 2020  ins = {}..      
-0001f5e0: 2020 776f 726b 6572 5f68 616e 646c 6572    worker_handler
-0001f5f0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-0001f600: 2020 2274 6173 6b2d 6669 6e69 7368 6564    "task-finished
-0001f610: 223a 2073 656c 662e 6861 6e64 6c65 5f74  ": self.handle_t
-0001f620: 6173 6b5f 6669 6e69 7368 6564 2c0a 2020  ask_finished,.  
-0001f630: 2020 2020 2020 2020 2020 2274 6173 6b2d            "task-
-0001f640: 6572 7265 6422 3a20 7365 6c66 2e68 616e  erred": self.han
-0001f650: 646c 655f 7461 736b 5f65 7272 6564 2c0a  dle_task_erred,.
-0001f660: 2020 2020 2020 2020 2020 2020 2272 656c              "rel
-0001f670: 6561 7365 2d77 6f72 6b65 722d 6461 7461  ease-worker-data
-0001f680: 223a 2073 656c 662e 7265 6c65 6173 655f  ": self.release_
-0001f690: 776f 726b 6572 5f64 6174 612c 0a20 2020  worker_data,.   
-0001f6a0: 2020 2020 2020 2020 2022 6164 642d 6b65           "add-ke
-0001f6b0: 7973 223a 2073 656c 662e 6164 645f 6b65  ys": self.add_ke
-0001f6c0: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
-0001f6d0: 226c 6f6e 672d 7275 6e6e 696e 6722 3a20  "long-running": 
-0001f6e0: 7365 6c66 2e68 616e 646c 655f 6c6f 6e67  self.handle_long
-0001f6f0: 5f72 756e 6e69 6e67 2c0a 2020 2020 2020  _running,.      
-0001f700: 2020 2020 2020 2272 6573 6368 6564 756c        "reschedul
-0001f710: 6522 3a20 7365 6c66 2e5f 7265 7363 6865  e": self._resche
-0001f720: 6475 6c65 2c0a 2020 2020 2020 2020 2020  dule,.          
-0001f730: 2020 226b 6565 702d 616c 6976 6522 3a20    "keep-alive": 
-0001f740: 6c61 6d62 6461 202a 6172 6773 2c20 2a2a  lambda *args, **
-0001f750: 6b77 6172 6773 3a20 4e6f 6e65 2c0a 2020  kwargs: None,.  
-0001f760: 2020 2020 2020 2020 2020 226c 6f67 2d65            "log-e
-0001f770: 7665 6e74 223a 2073 656c 662e 6c6f 675f  vent": self.log_
-0001f780: 776f 726b 6572 5f65 7665 6e74 2c0a 2020  worker_event,.  
-0001f790: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-0001f7a0: 722d 7374 6174 7573 2d63 6861 6e67 6522  r-status-change"
-0001f7b0: 3a20 7365 6c66 2e68 616e 646c 655f 776f  : self.handle_wo
-0001f7c0: 726b 6572 5f73 7461 7475 735f 6368 616e  rker_status_chan
-0001f7d0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
-0001f7e0: 2272 6571 7565 7374 2d72 6566 7265 7368  "request-refresh
-0001f7f0: 2d77 686f 2d68 6173 223a 2073 656c 662e  -who-has": self.
-0001f800: 6861 6e64 6c65 5f72 6571 7565 7374 5f72  handle_request_r
-0001f810: 6566 7265 7368 5f77 686f 5f68 6173 2c0a  efresh_who_has,.
-0001f820: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-0001f830: 2020 2063 6c69 656e 745f 6861 6e64 6c65     client_handle
-0001f840: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
-0001f850: 2020 2022 7570 6461 7465 2d67 7261 7068     "update-graph
-0001f860: 223a 2073 656c 662e 7570 6461 7465 5f67  ": self.update_g
-0001f870: 7261 7068 2c0a 2020 2020 2020 2020 2020  raph,.          
-0001f880: 2020 2263 6c69 656e 742d 6465 7369 7265    "client-desire
-0001f890: 732d 6b65 7973 223a 2073 656c 662e 636c  s-keys": self.cl
-0001f8a0: 6965 6e74 5f64 6573 6972 6573 5f6b 6579  ient_desires_key
-0001f8b0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001f8c0: 7570 6461 7465 2d64 6174 6122 3a20 7365  update-data": se
-0001f8d0: 6c66 2e75 7064 6174 655f 6461 7461 2c0a  lf.update_data,.
-0001f8e0: 2020 2020 2020 2020 2020 2020 2272 6570              "rep
-0001f8f0: 6f72 742d 6b65 7922 3a20 7365 6c66 2e72  ort-key": self.r
-0001f900: 6570 6f72 745f 6f6e 5f6b 6579 2c0a 2020  eport_on_key,.  
-0001f910: 2020 2020 2020 2020 2020 2263 6c69 656e            "clien
-0001f920: 742d 7265 6c65 6173 6573 2d6b 6579 7322  t-releases-keys"
-0001f930: 3a20 7365 6c66 2e63 6c69 656e 745f 7265  : self.client_re
-0001f940: 6c65 6173 6573 5f6b 6579 732c 0a20 2020  leases_keys,.   
-0001f950: 2020 2020 2020 2020 2022 6865 6172 7462           "heartb
-0001f960: 6561 742d 636c 6965 6e74 223a 2073 656c  eat-client": sel
-0001f970: 662e 636c 6965 6e74 5f68 6561 7274 6265  f.client_heartbe
-0001f980: 6174 2c0a 2020 2020 2020 2020 2020 2020  at,.            
-0001f990: 2263 6c6f 7365 2d63 6c69 656e 7422 3a20  "close-client": 
-0001f9a0: 7365 6c66 2e72 656d 6f76 655f 636c 6965  self.remove_clie
-0001f9b0: 6e74 2c0a 2020 2020 2020 2020 2020 2020  nt,.            
-0001f9c0: 2273 7562 7363 7269 6265 2d74 6f70 6963  "subscribe-topic
-0001f9d0: 223a 2073 656c 662e 7375 6273 6372 6962  ": self.subscrib
-0001f9e0: 655f 746f 7069 632c 0a20 2020 2020 2020  e_topic,.       
-0001f9f0: 2020 2020 2022 756e 7375 6273 6372 6962       "unsubscrib
-0001fa00: 652d 746f 7069 6322 3a20 7365 6c66 2e75  e-topic": self.u
-0001fa10: 6e73 7562 7363 7269 6265 5f74 6f70 6963  nsubscribe_topic
-0001fa20: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0001fa30: 616e 6365 6c2d 6b65 7973 223a 2073 656c  ancel-keys": sel
-0001fa40: 662e 7374 696d 756c 7573 5f63 616e 6365  f.stimulus_cance
-0001fa50: 6c2c 0a20 2020 2020 2020 207d 0a0a 2020  l,.        }..  
-0001fa60: 2020 2020 2020 7365 6c66 2e68 616e 646c        self.handl
-0001fa70: 6572 7320 3d20 7b0a 2020 2020 2020 2020  ers = {.        
-0001fa80: 2020 2020 2272 6567 6973 7465 722d 636c      "register-cl
-0001fa90: 6965 6e74 223a 2073 656c 662e 6164 645f  ient": self.add_
-0001faa0: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
-0001fab0: 2020 2020 2273 6361 7474 6572 223a 2073      "scatter": s
-0001fac0: 656c 662e 7363 6174 7465 722c 0a20 2020  elf.scatter,.   
-0001fad0: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
-0001fae0: 6572 2d77 6f72 6b65 7222 3a20 7365 6c66  er-worker": self
-0001faf0: 2e61 6464 5f77 6f72 6b65 722c 0a20 2020  .add_worker,.   
-0001fb00: 2020 2020 2020 2020 2022 7265 6769 7374           "regist
-0001fb10: 6572 5f6e 616e 6e79 223a 2073 656c 662e  er_nanny": self.
-0001fb20: 6164 645f 6e61 6e6e 792c 0a20 2020 2020  add_nanny,.     
-0001fb30: 2020 2020 2020 2022 756e 7265 6769 7374         "unregist
-0001fb40: 6572 223a 2073 656c 662e 7265 6d6f 7665  er": self.remove
-0001fb50: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
-0001fb60: 2020 2020 2022 6761 7468 6572 223a 2073       "gather": s
-0001fb70: 656c 662e 6761 7468 6572 2c0a 2020 2020  elf.gather,.    
-0001fb80: 2020 2020 2020 2020 2272 6574 7279 223a          "retry":
-0001fb90: 2073 656c 662e 7374 696d 756c 7573 5f72   self.stimulus_r
-0001fba0: 6574 7279 2c0a 2020 2020 2020 2020 2020  etry,.          
-0001fbb0: 2020 2266 6565 6422 3a20 7365 6c66 2e66    "feed": self.f
-0001fbc0: 6565 642c 0a20 2020 2020 2020 2020 2020  eed,.           
-0001fbd0: 2022 7465 726d 696e 6174 6522 3a20 7365   "terminate": se
-0001fbe0: 6c66 2e63 6c6f 7365 2c0a 2020 2020 2020  lf.close,.      
-0001fbf0: 2020 2020 2020 2262 726f 6164 6361 7374        "broadcast
-0001fc00: 223a 2073 656c 662e 6272 6f61 6463 6173  ": self.broadcas
-0001fc10: 742c 0a20 2020 2020 2020 2020 2020 2022  t,.            "
-0001fc20: 7072 6f78 7922 3a20 7365 6c66 2e70 726f  proxy": self.pro
-0001fc30: 7879 2c0a 2020 2020 2020 2020 2020 2020  xy,.            
-0001fc40: 226e 636f 7265 7322 3a20 7365 6c66 2e67  "ncores": self.g
-0001fc50: 6574 5f6e 636f 7265 732c 0a20 2020 2020  et_ncores,.     
-0001fc60: 2020 2020 2020 2022 6e63 6f72 6573 5f72         "ncores_r
-0001fc70: 756e 6e69 6e67 223a 2073 656c 662e 6765  unning": self.ge
-0001fc80: 745f 6e63 6f72 6573 5f72 756e 6e69 6e67  t_ncores_running
-0001fc90: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-0001fca0: 6173 5f77 6861 7422 3a20 7365 6c66 2e67  as_what": self.g
-0001fcb0: 6574 5f68 6173 5f77 6861 742c 0a20 2020  et_has_what,.   
-0001fcc0: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
-0001fcd0: 7322 3a20 7365 6c66 2e67 6574 5f77 686f  s": self.get_who
-0001fce0: 5f68 6173 2c0a 2020 2020 2020 2020 2020  _has,.          
-0001fcf0: 2020 2270 726f 6365 7373 696e 6722 3a20    "processing": 
-0001fd00: 7365 6c66 2e67 6574 5f70 726f 6365 7373  self.get_process
-0001fd10: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-0001fd20: 2022 6361 6c6c 5f73 7461 636b 223a 2073   "call_stack": s
-0001fd30: 656c 662e 6765 745f 6361 6c6c 5f73 7461  elf.get_call_sta
-0001fd40: 636b 2c0a 2020 2020 2020 2020 2020 2020  ck,.            
-0001fd50: 2270 726f 6669 6c65 223a 2073 656c 662e  "profile": self.
-0001fd60: 6765 745f 7072 6f66 696c 652c 0a20 2020  get_profile,.   
-0001fd70: 2020 2020 2020 2020 2022 7065 7266 6f72           "perfor
-0001fd80: 6d61 6e63 655f 7265 706f 7274 223a 2073  mance_report": s
-0001fd90: 656c 662e 7065 7266 6f72 6d61 6e63 655f  elf.performance_
-0001fda0: 7265 706f 7274 2c0a 2020 2020 2020 2020  report,.        
-0001fdb0: 2020 2020 2267 6574 5f6c 6f67 7322 3a20      "get_logs": 
-0001fdc0: 7365 6c66 2e67 6574 5f6c 6f67 732c 0a20  self.get_logs,. 
-0001fdd0: 2020 2020 2020 2020 2020 2022 6c6f 6773             "logs
-0001fde0: 223a 2073 656c 662e 6765 745f 6c6f 6773  ": self.get_logs
-0001fdf0: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
-0001fe00: 6f72 6b65 725f 6c6f 6773 223a 2073 656c  orker_logs": sel
-0001fe10: 662e 6765 745f 776f 726b 6572 5f6c 6f67  f.get_worker_log
-0001fe20: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001fe30: 6c6f 675f 6576 656e 7422 3a20 7365 6c66  log_event": self
-0001fe40: 2e6c 6f67 5f65 7665 6e74 2c0a 2020 2020  .log_event,.    
-0001fe50: 2020 2020 2020 2020 2265 7665 6e74 7322          "events"
-0001fe60: 3a20 7365 6c66 2e67 6574 5f65 7665 6e74  : self.get_event
-0001fe70: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0001fe80: 6e62 7974 6573 223a 2073 656c 662e 6765  nbytes": self.ge
-0001fe90: 745f 6e62 7974 6573 2c0a 2020 2020 2020  t_nbytes,.      
-0001fea0: 2020 2020 2020 2276 6572 7369 6f6e 7322        "versions"
-0001feb0: 3a20 7365 6c66 2e76 6572 7369 6f6e 732c  : self.versions,
-0001fec0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
-0001fed0: 645f 6b65 7973 223a 2073 656c 662e 6164  d_keys": self.ad
-0001fee0: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
-0001fef0: 2020 2020 2272 6562 616c 616e 6365 223a      "rebalance":
-0001ff00: 2073 656c 662e 7265 6261 6c61 6e63 652c   self.rebalance,
-0001ff10: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-0001ff20: 706c 6963 6174 6522 3a20 7365 6c66 2e72  plicate": self.r
-0001ff30: 6570 6c69 6361 7465 2c0a 2020 2020 2020  eplicate,.      
-0001ff40: 2020 2020 2020 2272 756e 5f66 756e 6374        "run_funct
-0001ff50: 696f 6e22 3a20 7365 6c66 2e72 756e 5f66  ion": self.run_f
-0001ff60: 756e 6374 696f 6e2c 0a20 2020 2020 2020  unction,.       
-0001ff70: 2020 2020 2022 7265 7374 6172 7422 3a20       "restart": 
-0001ff80: 7365 6c66 2e72 6573 7461 7274 2c0a 2020  self.restart,.  
-0001ff90: 2020 2020 2020 2020 2020 2275 7064 6174            "updat
-0001ffa0: 655f 6461 7461 223a 2073 656c 662e 7570  e_data": self.up
-0001ffb0: 6461 7465 5f64 6174 612c 0a20 2020 2020  date_data,.     
-0001ffc0: 2020 2020 2020 2022 7365 745f 7265 736f         "set_reso
-0001ffd0: 7572 6365 7322 3a20 7365 6c66 2e61 6464  urces": self.add
-0001ffe0: 5f72 6573 6f75 7263 6573 2c0a 2020 2020  _resources,.    
-0001fff0: 2020 2020 2020 2020 2272 6574 6972 655f          "retire_
-00020000: 776f 726b 6572 7322 3a20 7365 6c66 2e72  workers": self.r
-00020010: 6574 6972 655f 776f 726b 6572 732c 0a20  etire_workers,. 
-00020020: 2020 2020 2020 2020 2020 2022 6765 745f             "get_
-00020030: 6d65 7461 6461 7461 223a 2073 656c 662e  metadata": self.
-00020040: 6765 745f 6d65 7461 6461 7461 2c0a 2020  get_metadata,.  
-00020050: 2020 2020 2020 2020 2020 2273 6574 5f6d            "set_m
-00020060: 6574 6164 6174 6122 3a20 7365 6c66 2e73  etadata": self.s
-00020070: 6574 5f6d 6574 6164 6174 612c 0a20 2020  et_metadata,.   
-00020080: 2020 2020 2020 2020 2022 7365 745f 7265           "set_re
-00020090: 7374 7269 6374 696f 6e73 223a 2073 656c  strictions": sel
-000200a0: 662e 7365 745f 7265 7374 7269 6374 696f  f.set_restrictio
-000200b0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
-000200c0: 2268 6561 7274 6265 6174 5f77 6f72 6b65  "heartbeat_worke
-000200d0: 7222 3a20 7365 6c66 2e68 6561 7274 6265  r": self.heartbe
-000200e0: 6174 5f77 6f72 6b65 722c 0a20 2020 2020  at_worker,.     
-000200f0: 2020 2020 2020 2022 6765 745f 7461 736b         "get_task
-00020100: 5f73 7461 7475 7322 3a20 7365 6c66 2e67  _status": self.g
-00020110: 6574 5f74 6173 6b5f 7374 6174 7573 2c0a  et_task_status,.
-00020120: 2020 2020 2020 2020 2020 2020 2267 6574              "get
-00020130: 5f74 6173 6b5f 7374 7265 616d 223a 2073  _task_stream": s
-00020140: 656c 662e 6765 745f 7461 736b 5f73 7472  elf.get_task_str
-00020150: 6561 6d2c 0a20 2020 2020 2020 2020 2020  eam,.           
-00020160: 2022 6765 745f 7461 736b 5f70 7265 6669   "get_task_prefi
-00020170: 785f 7374 6174 6573 223a 2073 656c 662e  x_states": self.
-00020180: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
-00020190: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
-000201a0: 2020 2020 2272 6567 6973 7465 725f 7363      "register_sc
-000201b0: 6865 6475 6c65 725f 706c 7567 696e 223a  heduler_plugin":
-000201c0: 2073 656c 662e 7265 6769 7374 6572 5f73   self.register_s
-000201d0: 6368 6564 756c 6572 5f70 6c75 6769 6e2c  cheduler_plugin,
+0001c600: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
+0001c610: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
+0001c620: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0001c630: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0001c640: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+0001c650: 2020 2073 656c 662e 7265 6d6f 7665 5f61     self.remove_a
+0001c660: 6c6c 5f72 6570 6c69 6361 7328 7473 290a  ll_replicas(ts).
+0001c670: 0a20 2020 2064 6566 205f 636c 6965 6e74  .    def _client
+0001c680: 5f72 656c 6561 7365 735f 6b65 7973 280a  _releases_keys(.
+0001c690: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0001c6a0: 2020 2020 2020 6b65 7973 3a20 436f 6c6c        keys: Coll
+0001c6b0: 6563 7469 6f6e 5b73 7472 5d2c 0a20 2020  ection[str],.   
+0001c6c0: 2020 2020 2063 733a 2043 6c69 656e 7453       cs: ClientS
+0001c6d0: 7461 7465 2c0a 2020 2020 2020 2020 7265  tate,.        re
+0001c6e0: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
+0001c6f0: 6563 732c 0a20 2020 2029 202d 3e20 4e6f  ecs,.    ) -> No
+0001c700: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+0001c710: 656d 6f76 6520 6b65 7973 2066 726f 6d20  emove keys from 
+0001c720: 636c 6965 6e74 2064 6573 6972 6564 206c  client desired l
+0001c730: 6973 7422 2222 0a20 2020 2020 2020 206c  ist""".        l
+0001c740: 6f67 6765 722e 6465 6275 6728 2243 6c69  ogger.debug("Cli
+0001c750: 656e 7420 2573 2072 656c 6561 7365 7320  ent %s releases 
+0001c760: 6b65 7973 3a20 2573 222c 2063 732e 636c  keys: %s", cs.cl
+0001c770: 6965 6e74 5f6b 6579 2c20 6b65 7973 290a  ient_key, keys).
+0001c780: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
+0001c790: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
+0001c7a0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0001c7b0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+0001c7c0: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+0001c7d0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0001c7e0: 7473 2069 6e20 6373 2e77 616e 7473 5f77  ts in cs.wants_w
+0001c7f0: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
+0001c800: 2020 2020 2063 732e 7761 6e74 735f 7768       cs.wants_wh
+0001c810: 6174 2e72 656d 6f76 6528 7473 290a 2020  at.remove(ts).  
+0001c820: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0001c830: 2e77 686f 5f77 616e 7473 2e72 656d 6f76  .who_wants.remov
+0001c840: 6528 6373 290a 2020 2020 2020 2020 2020  e(cs).          
+0001c850: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+0001c860: 7768 6f5f 7761 6e74 733a 0a20 2020 2020  who_wants:.     
+0001c870: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c880: 6620 6e6f 7420 7473 2e64 6570 656e 6465  f not ts.depende
+0001c890: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0001c8a0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+0001c8b0: 6f20 6c69 7665 2064 6570 656e 6465 6e74  o live dependent
+0001c8c0: 732c 2063 616e 2066 6f72 6765 740a 2020  s, can forget.  
+0001c8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c8e0: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0001c8f0: 7469 6f6e 735b 7473 2e6b 6579 5d20 3d20  tions[ts.key] = 
+0001c900: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 656c 6966 2074 732e 7374 6174 6520 213d  elif ts.state !=
+0001c930: 2022 6572 7265 6422 2061 6e64 206e 6f74   "erred" and not
+0001c940: 2074 732e 7761 6974 6572 733a 0a20 2020   ts.waiters:.   
+0001c950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c960: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001c970: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
+0001c980: 7265 6c65 6173 6564 220a 0a20 2020 2064  released"..    d
+0001c990: 6566 205f 7461 736b 5f74 6f5f 6d73 6728  ef _task_to_msg(
+0001c9a0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+0001c9b0: 6174 652c 2064 7572 6174 696f 6e3a 2066  ate, duration: f
+0001c9c0: 6c6f 6174 203d 202d 3129 202d 3e20 6469  loat = -1) -> di
+0001c9d0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+0001c9e0: 2020 2020 2020 2222 2243 6f6e 7665 7274        """Convert
+0001c9f0: 2061 2073 696e 676c 6520 636f 6d70 7574   a single comput
+0001ca00: 6174 696f 6e61 6c20 7461 736b 2074 6f20  ational task to 
+0001ca10: 6120 6d65 7373 6167 6522 2222 0a20 2020  a message""".   
+0001ca20: 2020 2020 2023 2046 4958 4d45 3a20 5468       # FIXME: Th
+0001ca30: 6520 6475 7261 7469 6f6e 2061 7474 7269  e duration attri
+0001ca40: 6275 7465 2069 7320 6e6f 7420 7573 6564  bute is not used
+0001ca50: 206f 6e20 776f 726b 6572 2e20 5765 2063   on worker. We c
+0001ca60: 6f75 6c64 2073 6176 6520 6f75 7273 656c  ould save oursel
+0001ca70: 7665 7320 7468 650a 2020 2020 2020 2020  ves the.        
+0001ca80: 2320 2020 2020 2020 2074 696d 6520 746f  #        time to
+0001ca90: 2063 6f6d 7075 7465 2061 6e64 2073 7562   compute and sub
+0001caa0: 6d69 7420 7468 6973 0a20 2020 2020 2020  mit this.       
+0001cab0: 2069 6620 6475 7261 7469 6f6e 203c 2030   if duration < 0
+0001cac0: 3a0a 2020 2020 2020 2020 2020 2020 6475  :.            du
+0001cad0: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
+0001cae0: 745f 7461 736b 5f64 7572 6174 696f 6e28  t_task_duration(
+0001caf0: 7473 290a 2020 2020 2020 2020 7473 2e72  ts).        ts.r
+0001cb00: 756e 5f69 6420 3d20 6e65 7874 2854 6173  un_id = next(Tas
+0001cb10: 6b53 7461 7465 2e5f 7275 6e5f 6964 5f69  kState._run_id_i
+0001cb20: 7465 7261 746f 7229 0a20 2020 2020 2020  terator).       
+0001cb30: 2061 7373 6572 7420 7473 2e70 7269 6f72   assert ts.prior
+0001cb40: 6974 792c 2074 730a 2020 2020 2020 2020  ity, ts.        
+0001cb50: 6d73 673a 2064 6963 745b 7374 722c 2041  msg: dict[str, A
+0001cb60: 6e79 5d20 3d20 7b0a 2020 2020 2020 2020  ny] = {.        
+0001cb70: 2020 2020 226f 7022 3a20 2263 6f6d 7075      "op": "compu
+0001cb80: 7465 2d74 6173 6b22 2c0a 2020 2020 2020  te-task",.      
+0001cb90: 2020 2020 2020 226b 6579 223a 2074 732e        "key": ts.
+0001cba0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+0001cbb0: 2022 7275 6e5f 6964 223a 2074 732e 7275   "run_id": ts.ru
+0001cbc0: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
+0001cbd0: 2020 2270 7269 6f72 6974 7922 3a20 7473    "priority": ts
+0001cbe0: 2e70 7269 6f72 6974 792c 0a20 2020 2020  .priority,.     
+0001cbf0: 2020 2020 2020 2022 6475 7261 7469 6f6e         "duration
+0001cc00: 223a 2064 7572 6174 696f 6e2c 0a20 2020  ": duration,.   
+0001cc10: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
+0001cc20: 7573 5f69 6422 3a20 6622 636f 6d70 7574  us_id": f"comput
+0001cc30: 652d 7461 736b 2d7b 7469 6d65 2829 7d22  e-task-{time()}"
+0001cc40: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+0001cc50: 686f 5f68 6173 223a 207b 0a20 2020 2020  ho_has": {.     
+0001cc60: 2020 2020 2020 2020 2020 2064 7473 2e6b             dts.k
+0001cc70: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
+0001cc80: 666f 7220 7773 2069 6e20 6474 732e 7768  for ws in dts.wh
+0001cc90: 6f5f 6861 735d 2066 6f72 2064 7473 2069  o_has] for dts i
+0001cca0: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0001ccb0: 730a 2020 2020 2020 2020 2020 2020 7d2c  s.            },
+0001ccc0: 0a20 2020 2020 2020 2020 2020 2022 6e62  .            "nb
+0001ccd0: 7974 6573 223a 207b 6474 732e 6b65 793a  ytes": {dts.key:
+0001cce0: 2064 7473 2e6e 6279 7465 7320 666f 7220   dts.nbytes for 
+0001ccf0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+0001cd00: 656e 6369 6573 7d2c 0a20 2020 2020 2020  encies},.       
+0001cd10: 2020 2020 2022 7275 6e5f 7370 6563 223a       "run_spec":
+0001cd20: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0001cd30: 2020 2022 6675 6e63 7469 6f6e 223a 204e     "function": N
+0001cd40: 6f6e 652c 0a20 2020 2020 2020 2020 2020  one,.           
+0001cd50: 2022 6172 6773 223a 204e 6f6e 652c 0a20   "args": None,. 
+0001cd60: 2020 2020 2020 2020 2020 2022 6b77 6172             "kwar
+0001cd70: 6773 223a 204e 6f6e 652c 0a20 2020 2020  gs": None,.     
+0001cd80: 2020 2020 2020 2022 7265 736f 7572 6365         "resource
+0001cd90: 5f72 6573 7472 6963 7469 6f6e 7322 3a20  _restrictions": 
+0001cda0: 7473 2e72 6573 6f75 7263 655f 7265 7374  ts.resource_rest
+0001cdb0: 7269 6374 696f 6e73 2c0a 2020 2020 2020  rictions,.      
+0001cdc0: 2020 2020 2020 2261 6374 6f72 223a 2074        "actor": t
+0001cdd0: 732e 6163 746f 722c 0a20 2020 2020 2020  s.actor,.       
+0001cde0: 2020 2020 2022 616e 6e6f 7461 7469 6f6e       "annotation
+0001cdf0: 7322 3a20 7473 2e61 6e6e 6f74 6174 696f  s": ts.annotatio
+0001ce00: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0001ce10: 2273 7061 6e5f 6964 223a 2074 732e 6772  "span_id": ts.gr
+0001ce20: 6f75 702e 7370 616e 5f69 642c 0a20 2020  oup.span_id,.   
+0001ce30: 2020 2020 207d 0a20 2020 2020 2020 2069       }.        i
+0001ce40: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+0001ce50: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001ce60: 6572 7420 616c 6c28 6d73 675b 2277 686f  ert all(msg["who
+0001ce70: 5f68 6173 225d 2e76 616c 7565 7328 2929  _has"].values())
+0001ce80: 0a0a 2020 2020 2020 2020 6966 2069 7369  ..        if isi
+0001ce90: 6e73 7461 6e63 6528 7473 2e72 756e 5f73  nstance(ts.run_s
+0001cea0: 7065 632c 2064 6963 7429 3a0a 2020 2020  pec, dict):.    
+0001ceb0: 2020 2020 2020 2020 6d73 672e 7570 6461          msg.upda
+0001cec0: 7465 2874 732e 7275 6e5f 7370 6563 290a  te(ts.run_spec).
+0001ced0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0001cee0: 2020 2020 2020 2020 2020 6d73 675b 2272            msg["r
+0001cef0: 756e 5f73 7065 6322 5d20 3d20 7473 2e72  un_spec"] = ts.r
+0001cf00: 756e 5f73 7065 630a 0a20 2020 2020 2020  un_spec..       
+0001cf10: 2072 6574 7572 6e20 6d73 670a 0a0a 636c   return msg...cl
+0001cf20: 6173 7320 5363 6865 6475 6c65 7228 5363  ass Scheduler(Sc
+0001cf30: 6865 6475 6c65 7253 7461 7465 2c20 5365  hedulerState, Se
+0001cf40: 7276 6572 4e6f 6465 293a 0a20 2020 2022  rverNode):.    "
+0001cf50: 2222 4479 6e61 6d69 6320 6469 7374 7269  ""Dynamic distri
+0001cf60: 6275 7465 6420 7461 736b 2073 6368 6564  buted task sched
+0001cf70: 756c 6572 0a0a 2020 2020 5468 6520 7363  uler..    The sc
+0001cf80: 6865 6475 6c65 7220 7472 6163 6b73 2074  heduler tracks t
+0001cf90: 6865 2063 7572 7265 6e74 2073 7461 7465  he current state
+0001cfa0: 206f 6620 776f 726b 6572 732c 2064 6174   of workers, dat
+0001cfb0: 612c 2061 6e64 2063 6f6d 7075 7461 7469  a, and computati
+0001cfc0: 6f6e 732e 0a20 2020 2054 6865 2073 6368  ons..    The sch
+0001cfd0: 6564 756c 6572 206c 6973 7465 6e73 2066  eduler listens f
+0001cfe0: 6f72 2065 7665 6e74 7320 616e 6420 7265  or events and re
+0001cff0: 7370 6f6e 6473 2062 7920 636f 6e74 726f  sponds by contro
+0001d000: 6c6c 696e 6720 776f 726b 6572 730a 2020  lling workers.  
+0001d010: 2020 6170 7072 6f70 7269 6174 656c 792e    appropriately.
+0001d020: 2020 4974 2063 6f6e 7469 6e75 6f75 736c    It continuousl
+0001d030: 7920 7472 6965 7320 746f 2075 7365 2074  y tries to use t
+0001d040: 6865 2077 6f72 6b65 7273 2074 6f20 6578  he workers to ex
+0001d050: 6563 7574 6520 616e 2065 7665 720a 2020  ecute an ever.  
+0001d060: 2020 6772 6f77 696e 6720 6461 736b 2067    growing dask g
+0001d070: 7261 7068 2e0a 0a20 2020 2041 6c6c 2065  raph...    All e
+0001d080: 7665 6e74 7320 6172 6520 6861 6e64 6c65  vents are handle
+0001d090: 6420 7175 6963 6b6c 792c 2069 6e20 6c69  d quickly, in li
+0001d0a0: 6e65 6172 2074 696d 6520 7769 7468 2072  near time with r
+0001d0b0: 6573 7065 6374 2074 6f20 7468 6569 7220  espect to their 
+0001d0c0: 696e 7075 740a 2020 2020 2877 6869 6368  input.    (which
+0001d0d0: 2069 7320 6f66 7465 6e20 6f66 2063 6f6e   is often of con
+0001d0e0: 7374 616e 7420 7369 7a65 2920 616e 6420  stant size) and 
+0001d0f0: 6765 6e65 7261 6c6c 7920 7769 7468 696e  generally within
+0001d100: 2061 206d 696c 6c69 7365 636f 6e64 2e20   a millisecond. 
+0001d110: 2054 6f0a 2020 2020 6163 636f 6d70 6c69   To.    accompli
+0001d120: 7368 2074 6869 7320 7468 6520 7363 6865  sh this the sche
+0001d130: 6475 6c65 7220 7472 6163 6b73 2061 206c  duler tracks a l
+0001d140: 6f74 206f 6620 7374 6174 652e 2020 4576  ot of state.  Ev
+0001d150: 6572 7920 6f70 6572 6174 696f 6e0a 2020  ery operation.  
+0001d160: 2020 6d61 696e 7461 696e 7320 7468 6520    maintains the 
+0001d170: 636f 6e73 6973 7465 6e63 7920 6f66 2074  consistency of t
+0001d180: 6869 7320 7374 6174 652e 0a0a 2020 2020  his state...    
+0001d190: 5468 6520 7363 6865 6475 6c65 7220 636f  The scheduler co
+0001d1a0: 6d6d 756e 6963 6174 6573 2077 6974 6820  mmunicates with 
+0001d1b0: 7468 6520 6f75 7473 6964 6520 776f 726c  the outside worl
+0001d1c0: 6420 7468 726f 7567 6820 436f 6d6d 206f  d through Comm o
+0001d1d0: 626a 6563 7473 2e0a 2020 2020 4974 206d  bjects..    It m
+0001d1e0: 6169 6e74 6169 6e73 2061 2063 6f6e 7369  aintains a consi
+0001d1f0: 7374 656e 7420 616e 6420 7661 6c69 6420  stent and valid 
+0001d200: 7669 6577 206f 6620 7468 6520 776f 726c  view of the worl
+0001d210: 6420 6576 656e 2077 6865 6e20 6c69 7374  d even when list
+0001d220: 656e 696e 670a 2020 2020 746f 2073 6576  ening.    to sev
+0001d230: 6572 616c 2063 6c69 656e 7473 2061 7420  eral clients at 
+0001d240: 6f6e 6365 2e0a 0a20 2020 2041 2053 6368  once...    A Sch
+0001d250: 6564 756c 6572 2069 7320 7479 7069 6361  eduler is typica
+0001d260: 6c6c 7920 7374 6172 7465 6420 6569 7468  lly started eith
+0001d270: 6572 2077 6974 6820 7468 6520 6060 6461  er with the ``da
+0001d280: 736b 2073 6368 6564 756c 6572 6060 0a20  sk scheduler``. 
+0001d290: 2020 2065 7865 6375 7461 626c 653a 3a0a     executable::.
+0001d2a0: 0a20 2020 2020 2020 2020 2420 6461 736b  .         $ dask
+0001d2b0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+0001d2c0: 2020 2020 5363 6865 6475 6c65 7220 7374      Scheduler st
+0001d2d0: 6172 7465 6420 6174 2031 3237 2e30 2e30  arted at 127.0.0
+0001d2e0: 2e31 3a38 3738 360a 0a20 2020 204f 7220  .1:8786..    Or 
+0001d2f0: 7769 7468 696e 2061 204c 6f63 616c 436c  within a LocalCl
+0001d300: 7573 7465 7220 6120 436c 6965 6e74 2073  uster a Client s
+0001d310: 7461 7274 7320 7570 2077 6974 686f 7574  tarts up without
+0001d320: 2063 6f6e 6e65 6374 696f 6e0a 2020 2020   connection.    
+0001d330: 696e 666f 726d 6174 696f 6e3a 3a0a 0a20  information::.. 
+0001d340: 2020 2020 2020 203e 3e3e 2063 203d 2043         >>> c = C
+0001d350: 6c69 656e 7428 2920 2023 2064 6f63 7465  lient()  # docte
+0001d360: 7374 3a20 2b53 4b49 500a 2020 2020 2020  st: +SKIP.      
+0001d370: 2020 3e3e 3e20 632e 636c 7573 7465 722e    >>> c.cluster.
+0001d380: 7363 6865 6475 6c65 7220 2023 2064 6f63  scheduler  # doc
+0001d390: 7465 7374 3a20 2b53 4b49 500a 2020 2020  test: +SKIP.    
+0001d3a0: 2020 2020 5363 6865 6475 6c65 7228 2e2e      Scheduler(..
+0001d3b0: 2e29 0a0a 2020 2020 5573 6572 7320 7479  .)..    Users ty
+0001d3c0: 7069 6361 6c6c 7920 646f 206e 6f74 2069  pically do not i
+0001d3d0: 6e74 6572 6163 7420 7769 7468 2074 6865  nteract with the
+0001d3e0: 2073 6368 6564 756c 6572 2064 6972 6563   scheduler direc
+0001d3f0: 746c 7920 6275 7420 7261 7468 6572 2077  tly but rather w
+0001d400: 6974 680a 2020 2020 7468 6520 636c 6965  ith.    the clie
+0001d410: 6e74 206f 626a 6563 7420 6060 436c 6965  nt object ``Clie
+0001d420: 6e74 6060 2e0a 0a20 2020 2054 6865 2060  nt``...    The `
+0001d430: 6063 6f6e 7461 6374 5f61 6464 7265 7373  `contact_address
+0001d440: 6060 2070 6172 616d 6574 6572 2061 6c6c  `` parameter all
+0001d450: 6f77 7320 746f 2061 6476 6572 7469 7365  ows to advertise
+0001d460: 2061 2073 7065 6369 6669 6320 6164 6472   a specific addr
+0001d470: 6573 7320 746f 0a20 2020 2074 6865 2077  ess to.    the w
+0001d480: 6f72 6b65 7273 2066 6f72 2063 6f6d 6d75  orkers for commu
+0001d490: 6e69 6361 7469 6f6e 2077 6974 6820 7468  nication with th
+0001d4a0: 6520 7363 6865 6475 6c65 722c 2077 6869  e scheduler, whi
+0001d4b0: 6368 2069 7320 6469 6666 6572 656e 7420  ch is different 
+0001d4c0: 7468 616e 0a20 2020 2074 6865 2061 6464  than.    the add
+0001d4d0: 7265 7373 2074 6865 2073 6368 6564 756c  ress the schedul
+0001d4e0: 6572 2062 696e 6473 2074 6f2e 2054 6869  er binds to. Thi
+0001d4f0: 7320 6973 2075 7365 6675 6c20 7768 656e  s is useful when
+0001d500: 2074 6865 2073 6368 6564 756c 6572 0a20   the scheduler. 
+0001d510: 2020 206c 6973 7465 6e73 206f 6e20 6120     listens on a 
+0001d520: 7072 6976 6174 6520 6164 6472 6573 732c  private address,
+0001d530: 2077 6869 6368 2074 6865 7265 666f 7265   which therefore
+0001d540: 2063 616e 6e6f 7420 6265 2075 7365 6420   cannot be used 
+0001d550: 6279 2074 6865 2077 6f72 6b65 7273 0a20  by the workers. 
+0001d560: 2020 2074 6f20 636f 6e74 6163 7420 6974     to contact it
+0001d570: 2e0a 0a20 2020 202a 2a53 7461 7465 2a2a  ...    **State**
+0001d580: 0a0a 2020 2020 5468 6520 7363 6865 6475  ..    The schedu
+0001d590: 6c65 7220 636f 6e74 6169 6e73 2074 6865  ler contains the
+0001d5a0: 2066 6f6c 6c6f 7769 6e67 2073 7461 7465   following state
+0001d5b0: 2076 6172 6961 626c 6573 2e20 2045 6163   variables.  Eac
+0001d5c0: 6820 7661 7269 6162 6c65 2069 730a 2020  h variable is.  
+0001d5d0: 2020 6c69 7374 6564 2061 6c6f 6e67 2077    listed along w
+0001d5e0: 6974 6820 7768 6174 2069 7420 7374 6f72  ith what it stor
+0001d5f0: 6573 2061 6e64 2061 2062 7269 6566 2064  es and a brief d
+0001d600: 6573 6372 6970 7469 6f6e 2e0a 0a20 2020  escription...   
+0001d610: 202a 202a 2a74 6173 6b73 3a2a 2a20 6060   * **tasks:** ``
+0001d620: 7b74 6173 6b20 6b65 793a 2054 6173 6b53  {task key: TaskS
+0001d630: 7461 7465 7d60 600a 2020 2020 2020 2020  tate}``.        
+0001d640: 5461 736b 7320 6375 7272 656e 746c 7920  Tasks currently 
+0001d650: 6b6e 6f77 6e20 746f 2074 6865 2073 6368  known to the sch
+0001d660: 6564 756c 6572 0a20 2020 202a 202a 2a75  eduler.    * **u
+0001d670: 6e72 756e 6e61 626c 653a 2a2a 2060 607b  nrunnable:** ``{
+0001d680: 5461 736b 5374 6174 657d 6060 0a20 2020  TaskState}``.   
+0001d690: 2020 2020 2054 6173 6b73 2069 6e20 7468       Tasks in th
+0001d6a0: 6520 226e 6f2d 776f 726b 6572 2220 7374  e "no-worker" st
+0001d6b0: 6174 650a 0a20 2020 202a 202a 2a77 6f72  ate..    * **wor
+0001d6c0: 6b65 7273 3a2a 2a20 6060 7b77 6f72 6b65  kers:** ``{worke
+0001d6d0: 7220 6b65 793a 2057 6f72 6b65 7253 7461  r key: WorkerSta
+0001d6e0: 7465 7d60 600a 2020 2020 2020 2020 576f  te}``.        Wo
+0001d6f0: 726b 6572 7320 6375 7272 656e 746c 7920  rkers currently 
+0001d700: 636f 6e6e 6563 7465 6420 746f 2074 6865  connected to the
+0001d710: 2073 6368 6564 756c 6572 0a20 2020 202a   scheduler.    *
+0001d720: 202a 2a69 646c 653a 2a2a 2060 607b 576f   **idle:** ``{Wo
+0001d730: 726b 6572 5374 6174 657d 6060 3a0a 2020  rkerState}``:.  
+0001d740: 2020 2020 2020 5365 7420 6f66 2077 6f72        Set of wor
+0001d750: 6b65 7273 2074 6861 7420 6172 6520 6e6f  kers that are no
+0001d760: 7420 6675 6c6c 7920 7574 696c 697a 6564  t fully utilized
+0001d770: 0a20 2020 202a 202a 2a73 6174 7572 6174  .    * **saturat
+0001d780: 6564 3a2a 2a20 6060 7b57 6f72 6b65 7253  ed:** ``{WorkerS
+0001d790: 7461 7465 7d60 603a 0a20 2020 2020 2020  tate}``:.       
+0001d7a0: 2053 6574 206f 6620 776f 726b 6572 7320   Set of workers 
+0001d7b0: 7468 6174 2061 7265 206e 6f74 206f 7665  that are not ove
+0001d7c0: 722d 7574 696c 697a 6564 0a0a 2020 2020  r-utilized..    
+0001d7d0: 2a20 2a2a 686f 7374 5f69 6e66 6f3a 2a2a  * **host_info:**
+0001d7e0: 2060 607b 686f 7374 6e61 6d65 3a20 6469   ``{hostname: di
+0001d7f0: 6374 7d60 603a 0a20 2020 2020 2020 2049  ct}``:.        I
+0001d800: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
+0001d810: 2065 6163 6820 776f 726b 6572 2068 6f73   each worker hos
+0001d820: 740a 0a20 2020 202a 202a 2a63 6c69 656e  t..    * **clien
+0001d830: 7473 3a2a 2a20 6060 7b63 6c69 656e 7420  ts:** ``{client 
+0001d840: 6b65 793a 2043 6c69 656e 7453 7461 7465  key: ClientState
+0001d850: 7d60 600a 2020 2020 2020 2020 436c 6965  }``.        Clie
+0001d860: 6e74 7320 6375 7272 656e 746c 7920 636f  nts currently co
+0001d870: 6e6e 6563 7465 6420 746f 2074 6865 2073  nnected to the s
+0001d880: 6368 6564 756c 6572 0a0a 2020 2020 2a20  cheduler..    * 
+0001d890: 2a2a 7365 7276 6963 6573 3a2a 2a20 6060  **services:** ``
+0001d8a0: 7b73 7472 3a20 706f 7274 7d60 603a 0a20  {str: port}``:. 
+0001d8b0: 2020 2020 2020 204f 7468 6572 2073 6572         Other ser
+0001d8c0: 7669 6365 7320 7275 6e6e 696e 6720 6f6e  vices running on
+0001d8d0: 2074 6869 7320 7363 6865 6475 6c65 722c   this scheduler,
+0001d8e0: 206c 696b 6520 426f 6b65 680a 2020 2020   like Bokeh.    
+0001d8f0: 2a20 2a2a 6c6f 6f70 3a2a 2a20 6060 494f  * **loop:** ``IO
+0001d900: 4c6f 6f70 6060 3a0a 2020 2020 2020 2020  Loop``:.        
+0001d910: 5468 6520 7275 6e6e 696e 6720 546f 726e  The running Torn
+0001d920: 6164 6f20 494f 4c6f 6f70 0a20 2020 202a  ado IOLoop.    *
+0001d930: 202a 2a63 6c69 656e 745f 636f 6d6d 733a   **client_comms:
+0001d940: 2a2a 2060 607b 636c 6965 6e74 206b 6579  ** ``{client key
+0001d950: 3a20 436f 6d6d 7d60 600a 2020 2020 2020  : Comm}``.      
+0001d960: 2020 466f 7220 6561 6368 2063 6c69 656e    For each clien
+0001d970: 742c 2061 2043 6f6d 6d20 6f62 6a65 6374  t, a Comm object
+0001d980: 2075 7365 6420 746f 2072 6563 6569 7665   used to receive
+0001d990: 2074 6173 6b20 7265 7175 6573 7473 2061   task requests a
+0001d9a0: 6e64 0a20 2020 2020 2020 2072 6570 6f72  nd.        repor
+0001d9b0: 7420 7461 736b 2073 7461 7475 7320 7570  t task status up
+0001d9c0: 6461 7465 732e 0a20 2020 202a 202a 2a73  dates..    * **s
+0001d9d0: 7472 6561 6d5f 636f 6d6d 733a 2a2a 2060  tream_comms:** `
+0001d9e0: 607b 776f 726b 6572 206b 6579 3a20 436f  `{worker key: Co
+0001d9f0: 6d6d 7d60 600a 2020 2020 2020 2020 466f  mm}``.        Fo
+0001da00: 7220 6561 6368 2077 6f72 6b65 722c 2061  r each worker, a
+0001da10: 2043 6f6d 6d20 6f62 6a65 6374 2066 726f   Comm object fro
+0001da20: 6d20 7768 6963 6820 7765 2062 6f74 6820  m which we both 
+0001da30: 6163 6365 7074 2073 7469 6d75 6c69 2061  accept stimuli a
+0001da40: 6e64 0a20 2020 2020 2020 2072 6570 6f72  nd.        repor
+0001da50: 7420 7265 7375 6c74 730a 2020 2020 2a20  t results.    * 
+0001da60: 2a2a 7461 736b 5f64 7572 6174 696f 6e3a  **task_duration:
+0001da70: 2a2a 2060 607b 6b65 792d 7072 6566 6978  ** ``{key-prefix
+0001da80: 3a20 7469 6d65 7d60 600a 2020 2020 2020  : time}``.      
+0001da90: 2020 5469 6d65 2077 6520 6578 7065 6374    Time we expect
+0001daa0: 2063 6572 7461 696e 2066 756e 6374 696f   certain functio
+0001dab0: 6e73 2074 6f20 7461 6b65 2c20 652e 672e  ns to take, e.g.
+0001dac0: 2060 607b 2773 756d 273a 2030 2e32 357d   ``{'sum': 0.25}
+0001dad0: 6060 0a20 2020 2022 2222 0a0a 2020 2020  ``.    """..    
+0001dae0: 6465 6661 756c 745f 706f 7274 203d 2038  default_port = 8
+0001daf0: 3738 360a 2020 2020 5f69 6e73 7461 6e63  786.    _instanc
+0001db00: 6573 3a20 436c 6173 7356 6172 5b77 6561  es: ClassVar[wea
+0001db10: 6b72 6566 2e57 6561 6b53 6574 5b53 6368  kref.WeakSet[Sch
+0001db20: 6564 756c 6572 5d5d 203d 2077 6561 6b72  eduler]] = weakr
+0001db30: 6566 2e57 6561 6b53 6574 2829 0a0a 2020  ef.WeakSet()..  
+0001db40: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+0001db50: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0001db60: 2020 2020 2020 6c6f 6f70 3d4e 6f6e 652c        loop=None,
+0001db70: 0a20 2020 2020 2020 2064 656c 6574 655f  .        delete_
+0001db80: 696e 7465 7276 616c 3d22 3530 306d 7322  interval="500ms"
+0001db90: 2c0a 2020 2020 2020 2020 7379 6e63 6872  ,.        synchr
+0001dba0: 6f6e 697a 655f 776f 726b 6572 5f69 6e74  onize_worker_int
+0001dbb0: 6572 7661 6c3d 2236 3073 222c 0a20 2020  erval="60s",.   
+0001dbc0: 2020 2020 2073 6572 7669 6365 733d 4e6f       services=No
+0001dbd0: 6e65 2c0a 2020 2020 2020 2020 7365 7276  ne,.        serv
+0001dbe0: 6963 655f 6b77 6172 6773 3d4e 6f6e 652c  ice_kwargs=None,
+0001dbf0: 0a20 2020 2020 2020 2061 6c6c 6f77 6564  .        allowed
+0001dc00: 5f66 6169 6c75 7265 733d 4e6f 6e65 2c0a  _failures=None,.
+0001dc10: 2020 2020 2020 2020 6578 7465 6e73 696f          extensio
+0001dc20: 6e73 3d4e 6f6e 652c 0a20 2020 2020 2020  ns=None,.       
+0001dc30: 2076 616c 6964 6174 653d 4e6f 6e65 2c0a   validate=None,.
+0001dc40: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+0001dc50: 725f 6669 6c65 3d4e 6f6e 652c 0a20 2020  r_file=None,.   
+0001dc60: 2020 2020 2073 6563 7572 6974 793d 4e6f       security=No
+0001dc70: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
+0001dc80: 6572 5f74 746c 3d4e 6f6e 652c 0a20 2020  er_ttl=None,.   
+0001dc90: 2020 2020 2069 646c 655f 7469 6d65 6f75       idle_timeou
+0001dca0: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
+0001dcb0: 696e 7465 7266 6163 653d 4e6f 6e65 2c0a  interface=None,.
+0001dcc0: 2020 2020 2020 2020 686f 7374 3d4e 6f6e          host=Non
+0001dcd0: 652c 0a20 2020 2020 2020 2070 6f72 743d  e,.        port=
+0001dce0: 302c 0a20 2020 2020 2020 2070 726f 746f  0,.        proto
+0001dcf0: 636f 6c3d 4e6f 6e65 2c0a 2020 2020 2020  col=None,.      
+0001dd00: 2020 6461 7368 626f 6172 645f 6164 6472    dashboard_addr
+0001dd10: 6573 733d 4e6f 6e65 2c0a 2020 2020 2020  ess=None,.      
+0001dd20: 2020 6461 7368 626f 6172 643d 4e6f 6e65    dashboard=None
+0001dd30: 2c0a 2020 2020 2020 2020 6874 7470 5f70  ,.        http_p
+0001dd40: 7265 6669 783d 222f 222c 0a20 2020 2020  refix="/",.     
+0001dd50: 2020 2070 7265 6c6f 6164 3d4e 6f6e 652c     preload=None,
+0001dd60: 0a20 2020 2020 2020 2070 7265 6c6f 6164  .        preload
+0001dd70: 5f61 7267 763d 2829 2c0a 2020 2020 2020  _argv=(),.      
+0001dd80: 2020 706c 7567 696e 733d 2829 2c0a 2020    plugins=(),.  
+0001dd90: 2020 2020 2020 636f 6e74 6163 745f 6164        contact_ad
+0001dda0: 6472 6573 733d 4e6f 6e65 2c0a 2020 2020  dress=None,.    
+0001ddb0: 2020 2020 7472 616e 7369 7469 6f6e 5f63      transition_c
+0001ddc0: 6f75 6e74 6572 5f6d 6178 3d46 616c 7365  ounter_max=False
+0001ddd0: 2c0a 2020 2020 2020 2020 6a75 7079 7465  ,.        jupyte
+0001dde0: 723d 4661 6c73 652c 0a20 2020 2020 2020  r=False,.       
+0001ddf0: 202a 2a6b 7761 7267 732c 0a20 2020 2029   **kwargs,.    )
+0001de00: 3a0a 2020 2020 2020 2020 6966 206c 6f6f  :.        if loo
+0001de10: 7020 6973 206e 6f74 204e 6f6e 653a 0a20  p is not None:. 
+0001de20: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+0001de30: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
+0001de40: 2020 2020 2020 2020 2020 2274 6865 206c            "the l
+0001de50: 6f6f 7020 6b77 6172 6720 746f 2053 6368  oop kwarg to Sch
+0001de60: 6564 756c 6572 2069 7320 6465 7072 6563  eduler is deprec
+0001de70: 6174 6564 222c 0a20 2020 2020 2020 2020  ated",.         
+0001de80: 2020 2020 2020 2044 6570 7265 6361 7469         Deprecati
+0001de90: 6f6e 5761 726e 696e 672c 0a20 2020 2020  onWarning,.     
+0001dea0: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0001deb0: 6c65 7665 6c3d 322c 0a20 2020 2020 2020  level=2,.       
+0001dec0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001ded0: 7365 6c66 2e6c 6f6f 7020 3d20 7365 6c66  self.loop = self
+0001dee0: 2e69 6f5f 6c6f 6f70 203d 2049 4f4c 6f6f  .io_loop = IOLoo
+0001def0: 702e 6375 7272 656e 7428 290a 2020 2020  p.current().    
+0001df00: 2020 2020 7365 6c66 2e5f 7365 7475 705f      self._setup_
+0001df10: 6c6f 6767 696e 6728 6c6f 6767 6572 290a  logging(logger).
+0001df20: 0a20 2020 2020 2020 2023 2041 7474 7269  .        # Attri
+0001df30: 6275 7465 730a 2020 2020 2020 2020 6966  butes.        if
+0001df40: 2063 6f6e 7461 6374 5f61 6464 7265 7373   contact_address
+0001df50: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001df60: 2020 2020 2020 636f 6e74 6163 745f 6164        contact_ad
+0001df70: 6472 6573 7320 3d20 6461 736b 2e63 6f6e  dress = dask.con
+0001df80: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001df90: 7574 6564 2e73 6368 6564 756c 6572 2e63  uted.scheduler.c
+0001dfa0: 6f6e 7461 6374 2d61 6464 7265 7373 2229  ontact-address")
+0001dfb0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0001dfc0: 6e74 6163 745f 6164 6472 6573 7320 3d20  ntact_address = 
+0001dfd0: 636f 6e74 6163 745f 6164 6472 6573 730a  contact_address.
+0001dfe0: 2020 2020 2020 2020 6966 2061 6c6c 6f77          if allow
+0001dff0: 6564 5f66 6169 6c75 7265 7320 6973 204e  ed_failures is N
+0001e000: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0001e010: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
+0001e020: 7320 3d20 6461 736b 2e63 6f6e 6669 672e  s = dask.config.
+0001e030: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+0001e040: 2e73 6368 6564 756c 6572 2e61 6c6c 6f77  .scheduler.allow
+0001e050: 6564 2d66 6169 6c75 7265 7322 290a 2020  ed-failures").  
+0001e060: 2020 2020 2020 7365 6c66 2e61 6c6c 6f77        self.allow
+0001e070: 6564 5f66 6169 6c75 7265 7320 3d20 616c  ed_failures = al
+0001e080: 6c6f 7765 645f 6661 696c 7572 6573 0a20  lowed_failures. 
+0001e090: 2020 2020 2020 2069 6620 7661 6c69 6461         if valida
+0001e0a0: 7465 2069 7320 4e6f 6e65 3a0a 2020 2020  te is None:.    
+0001e0b0: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
+0001e0c0: 203d 2064 6173 6b2e 636f 6e66 6967 2e67   = dask.config.g
+0001e0d0: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+0001e0e0: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+0001e0f0: 7465 2229 0a20 2020 2020 2020 2073 656c  te").        sel
+0001e100: 662e 7072 6f63 203d 2070 7375 7469 6c2e  f.proc = psutil.
+0001e110: 5072 6f63 6573 7328 290a 2020 2020 2020  Process().      
+0001e120: 2020 7365 6c66 2e64 656c 6574 655f 696e    self.delete_in
+0001e130: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
+0001e140: 696d 6564 656c 7461 2864 656c 6574 655f  imedelta(delete_
+0001e150: 696e 7465 7276 616c 2c20 6465 6661 756c  interval, defaul
+0001e160: 743d 226d 7322 290a 2020 2020 2020 2020  t="ms").        
+0001e170: 7365 6c66 2e73 796e 6368 726f 6e69 7a65  self.synchronize
+0001e180: 5f77 6f72 6b65 725f 696e 7465 7276 616c  _worker_interval
+0001e190: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+0001e1a0: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+0001e1b0: 7379 6e63 6872 6f6e 697a 655f 776f 726b  synchronize_work
+0001e1c0: 6572 5f69 6e74 6572 7661 6c2c 2064 6566  er_interval, def
+0001e1d0: 6175 6c74 3d22 6d73 220a 2020 2020 2020  ault="ms".      
+0001e1e0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001e1f0: 2e73 6572 7669 6365 5f73 7065 6373 203d  .service_specs =
+0001e200: 2073 6572 7669 6365 7320 6f72 207b 7d0a   services or {}.
+0001e210: 2020 2020 2020 2020 7365 6c66 2e73 6572          self.ser
+0001e220: 7669 6365 5f6b 7761 7267 7320 3d20 7365  vice_kwargs = se
+0001e230: 7276 6963 655f 6b77 6172 6773 206f 7220  rvice_kwargs or 
+0001e240: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+0001e250: 7365 7276 6963 6573 203d 207b 7d0a 2020  services = {}.  
+0001e260: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+0001e270: 756c 6572 5f66 696c 6520 3d20 7363 6865  uler_file = sche
+0001e280: 6475 6c65 725f 6669 6c65 0a20 2020 2020  duler_file.     
+0001e290: 2020 2077 6f72 6b65 725f 7474 6c20 3d20     worker_ttl = 
+0001e2a0: 776f 726b 6572 5f74 746c 206f 7220 6461  worker_ttl or da
+0001e2b0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0001e2c0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001e2d0: 756c 6572 2e77 6f72 6b65 722d 7474 6c22  uler.worker-ttl"
+0001e2e0: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+0001e2f0: 6f72 6b65 725f 7474 6c20 3d20 7061 7273  orker_ttl = pars
+0001e300: 655f 7469 6d65 6465 6c74 6128 776f 726b  e_timedelta(work
+0001e310: 6572 5f74 746c 2920 6966 2077 6f72 6b65  er_ttl) if worke
+0001e320: 725f 7474 6c20 656c 7365 204e 6f6e 650a  r_ttl else None.
+0001e330: 2020 2020 2020 2020 6964 6c65 5f74 696d          idle_tim
+0001e340: 656f 7574 203d 2069 646c 655f 7469 6d65  eout = idle_time
+0001e350: 6f75 7420 6f72 2064 6173 6b2e 636f 6e66  out or dask.conf
+0001e360: 6967 2e67 6574 280a 2020 2020 2020 2020  ig.get(.        
+0001e370: 2020 2020 2264 6973 7472 6962 7574 6564      "distributed
+0001e380: 2e73 6368 6564 756c 6572 2e69 646c 652d  .scheduler.idle-
+0001e390: 7469 6d65 6f75 7422 0a20 2020 2020 2020  timeout".       
+0001e3a0: 2029 0a20 2020 2020 2020 2069 6620 6964   ).        if id
+0001e3b0: 6c65 5f74 696d 656f 7574 3a0a 2020 2020  le_timeout:.    
+0001e3c0: 2020 2020 2020 2020 7365 6c66 2e69 646c          self.idl
+0001e3d0: 655f 7469 6d65 6f75 7420 3d20 7061 7273  e_timeout = pars
+0001e3e0: 655f 7469 6d65 6465 6c74 6128 6964 6c65  e_timedelta(idle
+0001e3f0: 5f74 696d 656f 7574 290a 2020 2020 2020  _timeout).      
+0001e400: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001e410: 2020 2020 7365 6c66 2e69 646c 655f 7469      self.idle_ti
+0001e420: 6d65 6f75 7420 3d20 4e6f 6e65 0a20 2020  meout = None.   
+0001e430: 2020 2020 2073 656c 662e 6964 6c65 5f73       self.idle_s
+0001e440: 696e 6365 203d 2074 696d 6528 290a 2020  ince = time().  
+0001e450: 2020 2020 2020 7365 6c66 2e74 696d 655f        self.time_
+0001e460: 7374 6172 7465 6420 3d20 7365 6c66 2e69  started = self.i
+0001e470: 646c 655f 7369 6e63 6520 2023 2063 6f6d  dle_since  # com
+0001e480: 7061 7469 6269 6c69 7479 2066 6f72 2064  patibility for d
+0001e490: 6173 6b2d 6761 7465 7761 790a 2020 2020  ask-gateway.    
+0001e4a0: 2020 2020 7365 6c66 2e5f 6c6f 636b 203d      self._lock =
+0001e4b0: 2061 7379 6e63 696f 2e4c 6f63 6b28 290a   asyncio.Lock().
+0001e4c0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+0001e4d0: 6477 6964 7468 5f77 6f72 6b65 7273 203d  dwidth_workers =
+0001e4e0: 2064 6566 6175 6c74 6469 6374 2866 6c6f   defaultdict(flo
+0001e4f0: 6174 290a 2020 2020 2020 2020 7365 6c66  at).        self
+0001e500: 2e62 616e 6477 6964 7468 5f74 7970 6573  .bandwidth_types
+0001e510: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+0001e520: 6c6f 6174 290a 0a20 2020 2020 2020 2073  loat)..        s
+0001e530: 656c 662e 6375 6d75 6c61 7469 7665 5f77  elf.cumulative_w
+0001e540: 6f72 6b65 725f 6d65 7472 6963 7320 3d20  orker_metrics = 
+0001e550: 6465 6661 756c 7464 6963 7428 666c 6f61  defaultdict(floa
+0001e560: 7429 0a0a 2020 2020 2020 2020 6966 206e  t)..        if n
+0001e570: 6f74 2070 7265 6c6f 6164 3a0a 2020 2020  ot preload:.    
+0001e580: 2020 2020 2020 2020 7072 656c 6f61 6420          preload 
+0001e590: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+0001e5a0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0001e5b0: 6368 6564 756c 6572 2e70 7265 6c6f 6164  cheduler.preload
+0001e5c0: 2229 0a20 2020 2020 2020 2069 6620 6e6f  ").        if no
+0001e5d0: 7420 7072 656c 6f61 645f 6172 6776 3a0a  t preload_argv:.
+0001e5e0: 2020 2020 2020 2020 2020 2020 7072 656c              prel
+0001e5f0: 6f61 645f 6172 6776 203d 2064 6173 6b2e  oad_argv = dask.
+0001e600: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001e610: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001e620: 722e 7072 656c 6f61 642d 6172 6776 2229  r.preload-argv")
+0001e630: 0a20 2020 2020 2020 2073 656c 662e 7072  .        self.pr
+0001e640: 656c 6f61 6473 203d 2070 7265 6c6f 6164  eloads = preload
+0001e650: 696e 672e 7072 6f63 6573 735f 7072 656c  ing.process_prel
+0001e660: 6f61 6473 2873 656c 662c 2070 7265 6c6f  oads(self, prelo
+0001e670: 6164 2c20 7072 656c 6f61 645f 6172 6776  ad, preload_argv
+0001e680: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
+0001e690: 696e 7374 616e 6365 2873 6563 7572 6974  instance(securit
+0001e6a0: 792c 2064 6963 7429 3a0a 2020 2020 2020  y, dict):.      
+0001e6b0: 2020 2020 2020 7365 6375 7269 7479 203d        security =
+0001e6c0: 2053 6563 7572 6974 7928 2a2a 7365 6375   Security(**secu
+0001e6d0: 7269 7479 290a 2020 2020 2020 2020 7365  rity).        se
+0001e6e0: 6c66 2e73 6563 7572 6974 7920 3d20 7365  lf.security = se
+0001e6f0: 6375 7269 7479 206f 7220 5365 6375 7269  curity or Securi
+0001e700: 7479 2829 0a20 2020 2020 2020 2061 7373  ty().        ass
+0001e710: 6572 7420 6973 696e 7374 616e 6365 2873  ert isinstance(s
+0001e720: 656c 662e 7365 6375 7269 7479 2c20 5365  elf.security, Se
+0001e730: 6375 7269 7479 290a 2020 2020 2020 2020  curity).        
+0001e740: 7365 6c66 2e63 6f6e 6e65 6374 696f 6e5f  self.connection_
+0001e750: 6172 6773 203d 2073 656c 662e 7365 6375  args = self.secu
+0001e760: 7269 7479 2e67 6574 5f63 6f6e 6e65 6374  rity.get_connect
+0001e770: 696f 6e5f 6172 6773 2822 7363 6865 6475  ion_args("schedu
+0001e780: 6c65 7222 290a 2020 2020 2020 2020 7365  ler").        se
+0001e790: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
+0001e7a0: 6773 5b22 6861 6e64 7368 616b 655f 6f76  gs["handshake_ov
+0001e7b0: 6572 7269 6465 7322 5d20 3d20 7b20 2023  errides"] = {  #
+0001e7c0: 2063 6f6d 6d6f 6e20 6465 6e6f 6d69 6e61   common denomina
+0001e7d0: 746f 720a 2020 2020 2020 2020 2020 2020  tor.            
+0001e7e0: 2270 6963 6b6c 652d 7072 6f74 6f63 6f6c  "pickle-protocol
+0001e7f0: 223a 2034 0a20 2020 2020 2020 207d 0a0a  ": 4.        }..
+0001e800: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+0001e810: 6172 745f 6164 6472 6573 7320 3d20 6164  art_address = ad
+0001e820: 6472 6573 7365 735f 6672 6f6d 5f75 7365  dresses_from_use
+0001e830: 725f 6172 6773 280a 2020 2020 2020 2020  r_args(.        
+0001e840: 2020 2020 686f 7374 3d68 6f73 742c 0a20      host=host,. 
+0001e850: 2020 2020 2020 2020 2020 2070 6f72 743d             port=
+0001e860: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
+0001e870: 2020 696e 7465 7266 6163 653d 696e 7465    interface=inte
+0001e880: 7266 6163 652c 0a20 2020 2020 2020 2020  rface,.         
+0001e890: 2020 2070 726f 746f 636f 6c3d 7072 6f74     protocol=prot
+0001e8a0: 6f63 6f6c 2c0a 2020 2020 2020 2020 2020  ocol,.          
+0001e8b0: 2020 7365 6375 7269 7479 3d73 6563 7572    security=secur
+0001e8c0: 6974 792c 0a20 2020 2020 2020 2020 2020  ity,.           
+0001e8d0: 2064 6566 6175 6c74 5f70 6f72 743d 7365   default_port=se
+0001e8e0: 6c66 2e64 6566 6175 6c74 5f70 6f72 742c  lf.default_port,
+0001e8f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0001e900: 2020 2020 6874 7470 5f73 6572 7665 725f      http_server_
+0001e910: 6d6f 6475 6c65 7320 3d20 6461 736b 2e63  modules = dask.c
+0001e920: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0001e930: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0001e940: 2e68 7474 702e 726f 7574 6573 2229 0a20  .http.routes"). 
+0001e950: 2020 2020 2020 2073 686f 775f 6461 7368         show_dash
+0001e960: 626f 6172 6420 3d20 6461 7368 626f 6172  board = dashboar
+0001e970: 6420 6f72 2028 6461 7368 626f 6172 6420  d or (dashboard 
+0001e980: 6973 204e 6f6e 6520 616e 6420 6461 7368  is None and dash
+0001e990: 626f 6172 645f 6164 6472 6573 7329 0a20  board_address). 
+0001e9a0: 2020 2020 2020 2023 2069 6e73 7461 6c6c         # install
+0001e9b0: 2076 616e 696c 6c61 2072 6f75 7465 2069   vanilla route i
+0001e9c0: 6620 7368 6f77 5f64 6173 6862 6f61 7264  f show_dashboard
+0001e9d0: 2062 7574 2062 6f6b 6568 2069 7320 6e6f   but bokeh is no
+0001e9e0: 7420 696e 7374 616c 6c65 640a 2020 2020  t installed.    
+0001e9f0: 2020 2020 6966 2073 686f 775f 6461 7368      if show_dash
+0001ea00: 626f 6172 643a 0a20 2020 2020 2020 2020  board:.         
+0001ea10: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001ea20: 2020 2020 2020 2020 696d 706f 7274 2064          import d
+0001ea30: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+0001ea40: 6f61 7264 2e73 6368 6564 756c 6572 0a20  oard.scheduler. 
+0001ea50: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001ea60: 7420 496d 706f 7274 4572 726f 723a 0a20  t ImportError:. 
+0001ea70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001ea80: 686f 775f 6461 7368 626f 6172 6420 3d20  how_dashboard = 
+0001ea90: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0001eaa0: 2020 2020 2020 6874 7470 5f73 6572 7665        http_serve
+0001eab0: 725f 6d6f 6475 6c65 732e 6170 7065 6e64  r_modules.append
+0001eac0: 2822 6469 7374 7269 6275 7465 642e 6874  ("distributed.ht
+0001ead0: 7470 2e73 6368 6564 756c 6572 2e6d 6973  tp.scheduler.mis
+0001eae0: 7369 6e67 5f62 6f6b 6568 2229 0a20 2020  sing_bokeh").   
+0001eaf0: 2020 2020 2072 6f75 7465 7320 3d20 6765       routes = ge
+0001eb00: 745f 6861 6e64 6c65 7273 280a 2020 2020  t_handlers(.    
+0001eb10: 2020 2020 2020 2020 7365 7276 6572 3d73          server=s
+0001eb20: 656c 662c 206d 6f64 756c 6573 3d68 7474  elf, modules=htt
+0001eb30: 705f 7365 7276 6572 5f6d 6f64 756c 6573  p_server_modules
+0001eb40: 2c20 7072 6566 6978 3d68 7474 705f 7072  , prefix=http_pr
+0001eb50: 6566 6978 0a20 2020 2020 2020 2029 0a20  efix.        ). 
+0001eb60: 2020 2020 2020 2073 656c 662e 7374 6172         self.star
+0001eb70: 745f 6874 7470 5f73 6572 7665 7228 726f  t_http_server(ro
+0001eb80: 7574 6573 2c20 6461 7368 626f 6172 645f  utes, dashboard_
+0001eb90: 6164 6472 6573 732c 2064 6566 6175 6c74  address, default
+0001eba0: 5f70 6f72 743d 3837 3837 290a 2020 2020  _port=8787).    
+0001ebb0: 2020 2020 7365 6c66 2e6a 7570 7974 6572      self.jupyter
+0001ebc0: 203d 206a 7570 7974 6572 0a20 2020 2020   = jupyter.     
+0001ebd0: 2020 2069 6620 7368 6f77 5f64 6173 6862     if show_dashb
+0001ebe0: 6f61 7264 3a0a 2020 2020 2020 2020 2020  oard:.          
+0001ebf0: 2020 6469 7374 7269 6275 7465 642e 6461    distributed.da
+0001ec00: 7368 626f 6172 642e 7363 6865 6475 6c65  shboard.schedule
+0001ec10: 722e 636f 6e6e 6563 7428 0a20 2020 2020  r.connect(.     
+0001ec20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001ec30: 6874 7470 5f61 7070 6c69 6361 7469 6f6e  http_application
+0001ec40: 2c20 7365 6c66 2e68 7474 705f 7365 7276  , self.http_serv
+0001ec50: 6572 2c20 7365 6c66 2c20 7072 6566 6978  er, self, prefix
+0001ec60: 3d68 7474 705f 7072 6566 6978 0a20 2020  =http_prefix.   
+0001ec70: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001ec80: 2020 2069 6620 7365 6c66 2e6a 7570 7974     if self.jupyt
+0001ec90: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0001eca0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001ecb0: 2020 2020 2066 726f 6d20 6a75 7079 7465       from jupyte
+0001ecc0: 725f 7365 7276 6572 2e73 6572 7665 7261  r_server.servera
+0001ecd0: 7070 2069 6d70 6f72 7420 5365 7276 6572  pp import Server
+0001ece0: 4170 700a 2020 2020 2020 2020 2020 2020  App.            
+0001ecf0: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
+0001ed00: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0001ed10: 2020 2020 7261 6973 6520 496d 706f 7274      raise Import
+0001ed20: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+0001ed30: 2020 2020 2020 2020 2020 2022 496e 206f             "In o
+0001ed40: 7264 6572 2074 6f20 7573 6520 7468 6520  rder to use the 
+0001ed50: 4461 736b 206a 7570 7974 6572 206f 7074  Dask jupyter opt
+0001ed60: 696f 6e20 796f 7520 220a 2020 2020 2020  ion you ".      
+0001ed70: 2020 2020 2020 2020 2020 2020 2020 226e                "n
+0001ed80: 6565 6420 746f 2068 6176 6520 6a75 7079  eed to have jupy
+0001ed90: 7465 726c 6162 2069 6e73 7461 6c6c 6564  terlab installed
+0001eda0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001edb0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001edc0: 6672 6f6d 2074 7261 6974 6c65 7473 2e63  from traitlets.c
+0001edd0: 6f6e 6669 6720 696d 706f 7274 2043 6f6e  onfig import Con
+0001ede0: 6669 670a 0a20 2020 2020 2020 2020 2020  fig..           
+0001edf0: 206a 203d 2053 6572 7665 7241 7070 2e69   j = ServerApp.i
+0001ee00: 6e73 7461 6e63 6528 0a20 2020 2020 2020  nstance(.       
+0001ee10: 2020 2020 2020 2020 2063 6f6e 6669 673d           config=
+0001ee20: 436f 6e66 6967 280a 2020 2020 2020 2020  Config(.        
+0001ee30: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0001ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee50: 2020 2020 2020 2253 6572 7665 7241 7070        "ServerApp
+0001ee60: 223a 207b 0a20 2020 2020 2020 2020 2020  ": {.           
+0001ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee80: 2022 6261 7365 5f75 726c 223a 2022 6a75   "base_url": "ju
+0001ee90: 7079 7465 7222 2c0a 2020 2020 2020 2020  pyter",.        
+0001eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eeb0: 2020 2020 2320 5345 4355 5249 5459 3a20      # SECURITY: 
+0001eec0: 5765 2075 7375 616c 6c79 2065 7870 6563  We usually expec
+0001eed0: 7420 7468 6520 6461 7368 626f 6172 6420  t the dashboard 
+0001eee0: 746f 2062 6520 6120 7265 6164 2d6f 6e6c  to be a read-onl
+0001eef0: 7920 7669 6577 2069 6e74 6f0a 2020 2020  y view into.    
+0001ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef10: 2020 2020 2020 2020 2320 7468 6520 7363          # the sc
+0001ef20: 6865 6475 6c65 7220 6163 7469 7669 7479  heduler activity
+0001ef30: 2e20 486f 7765 7665 722c 2062 7920 6164  . However, by ad
+0001ef40: 6469 6e67 2061 6e20 6f70 656e 204a 7570  ding an open Jup
+0001ef50: 7974 6572 2061 7070 6c69 6361 7469 6f6e  yter application
+0001ef60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ef70: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+0001ef80: 6520 6172 6520 616c 6c6f 7769 6e67 2061  e are allowing a
+0001ef90: 7262 6974 7261 7279 2072 656d 6f74 6520  rbitrary remote 
+0001efa0: 636f 6465 2065 7865 6375 7469 6f6e 206f  code execution o
+0001efb0: 6e20 7468 6520 7363 6865 6475 6c65 7220  n the scheduler 
+0001efc0: 7669 6120 7468 650a 2020 2020 2020 2020  via the.        
+0001efd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001efe0: 2020 2020 2320 6461 7368 626f 6172 6420      # dashboard 
+0001eff0: 7365 7276 6572 2e20 5468 6973 206f 7074  server. This opt
+0001f000: 696f 6e20 7368 6f75 6c64 206f 6e6c 7920  ion should only 
+0001f010: 6265 2075 7365 6420 7768 656e 2074 6865  be used when the
+0001f020: 2064 6173 6862 6f61 7264 2069 730a 2020   dashboard is.  
+0001f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f040: 2020 2020 2020 2020 2020 2320 7072 6f74            # prot
+0001f050: 6563 7465 6420 7669 6120 6f74 6865 7220  ected via other 
+0001f060: 6d65 616e 732c 206f 7220 7768 656e 2079  means, or when y
+0001f070: 6f75 2064 6f6e 2774 2063 6172 6520 6162  ou don't care ab
+0001f080: 6f75 7420 636c 7573 7465 7220 7365 6375  out cluster secu
+0001f090: 7269 7479 2e0a 2020 2020 2020 2020 2020  rity..          
+0001f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0b0: 2020 2274 6f6b 656e 223a 2022 222c 0a20    "token": "",. 
+0001f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0d0: 2020 2020 2020 2020 2020 2022 616c 6c6f             "allo
+0001f0e0: 775f 7265 6d6f 7465 5f61 6363 6573 7322  w_remote_access"
+0001f0f0: 3a20 5472 7565 2c0a 2020 2020 2020 2020  : True,.        
+0001f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f110: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0001f120: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0001f130: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001f140: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001f150: 2020 2020 6a2e 696e 6974 6961 6c69 7a65      j.initialize
+0001f160: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001f170: 2020 6e65 775f 6874 7470 7365 7276 6572    new_httpserver
+0001f180: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+0001f190: 2020 2020 2020 2020 6172 6776 3d5b 5d2c          argv=[],
+0001f1a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001f1b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001f1c0: 5f6a 7570 7974 6572 5f73 6572 7665 725f  _jupyter_server_
+0001f1d0: 6170 706c 6963 6174 696f 6e20 3d20 6a0a  application = j.
+0001f1e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001f1f0: 2e68 7474 705f 6170 706c 6963 6174 696f  .http_applicatio
+0001f200: 6e2e 6164 645f 6170 706c 6963 6174 696f  n.add_applicatio
+0001f210: 6e28 6a2e 7765 625f 6170 7029 0a0a 2020  n(j.web_app)..  
+0001f220: 2020 2020 2020 2320 436f 6d6d 756e 6963        # Communic
+0001f230: 6174 696f 6e20 7374 6174 650a 2020 2020  ation state.    
+0001f240: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
+0001f250: 636f 6d6d 7320 3d20 7b7d 0a20 2020 2020  comms = {}.     
+0001f260: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
+0001f270: 6f6d 6d73 203d 207b 7d0a 0a20 2020 2020  omms = {}..     
+0001f280: 2020 2023 2054 6173 6b20 7374 6174 650a     # Task state.
+0001f290: 2020 2020 2020 2020 7461 736b 7320 3d20          tasks = 
+0001f2a0: 7b7d 0a0a 2020 2020 2020 2020 7365 6c66  {}..        self
+0001f2b0: 2e67 656e 6572 6174 696f 6e20 3d20 300a  .generation = 0.
+0001f2c0: 2020 2020 2020 2020 7365 6c66 2e5f 6c61          self._la
+0001f2d0: 7374 5f63 6c69 656e 7420 3d20 4e6f 6e65  st_client = None
+0001f2e0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+0001f2f0: 6173 745f 7469 6d65 203d 2030 0a20 2020  ast_time = 0.   
+0001f300: 2020 2020 2075 6e72 756e 6e61 626c 6520       unrunnable 
+0001f310: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+0001f320: 7175 6575 6564 3a20 4865 6170 5365 745b  queued: HeapSet[
+0001f330: 5461 736b 5374 6174 655d 203d 2048 6561  TaskState] = Hea
+0001f340: 7053 6574 286b 6579 3d6f 7065 7261 746f  pSet(key=operato
+0001f350: 722e 6174 7472 6765 7474 6572 2822 7072  r.attrgetter("pr
+0001f360: 696f 7269 7479 2229 290a 0a20 2020 2020  iority"))..     
+0001f370: 2020 2073 656c 662e 6461 7461 7365 7473     self.datasets
+0001f380: 203d 207b 7d0a 0a20 2020 2020 2020 2023   = {}..        #
+0001f390: 2050 7265 6669 782d 6b65 7965 6420 636f   Prefix-keyed co
+0001f3a0: 6e74 6169 6e65 7273 0a0a 2020 2020 2020  ntainers..      
+0001f3b0: 2020 2320 436c 6965 6e74 2073 7461 7465    # Client state
+0001f3c0: 0a20 2020 2020 2020 2063 6c69 656e 7473  .        clients
+0001f3d0: 203d 207b 7d0a 0a20 2020 2020 2020 2023   = {}..        #
+0001f3e0: 2057 6f72 6b65 7220 7374 6174 650a 2020   Worker state.  
+0001f3f0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+0001f400: 536f 7274 6564 4469 6374 2829 0a0a 2020  SortedDict()..  
+0001f410: 2020 2020 2020 686f 7374 5f69 6e66 6f20        host_info 
+0001f420: 3d20 7b7d 0a20 2020 2020 2020 2072 6573  = {}.        res
+0001f430: 6f75 7263 6573 203d 207b 7d0a 2020 2020  ources = {}.    
+0001f440: 2020 2020 616c 6961 7365 7320 3d20 7b7d      aliases = {}
+0001f450: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+0001f460: 776f 726b 6572 5f63 6f6c 6c65 6374 696f  worker_collectio
+0001f470: 6e73 203d 205b 0a20 2020 2020 2020 2020  ns = [.         
+0001f480: 2020 2077 6f72 6b65 7273 2c0a 2020 2020     workers,.    
+0001f490: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+0001f4a0: 6f2c 0a20 2020 2020 2020 2020 2020 2072  o,.            r
+0001f4b0: 6573 6f75 7263 6573 2c0a 2020 2020 2020  esources,.      
+0001f4c0: 2020 2020 2020 616c 6961 7365 732c 0a20        aliases,. 
+0001f4d0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+0001f4e0: 2020 7365 6c66 2e65 7665 6e74 7320 3d20    self.events = 
+0001f4f0: 6465 6661 756c 7464 6963 7428 0a20 2020  defaultdict(.   
+0001f500: 2020 2020 2020 2020 2070 6172 7469 616c           partial
+0001f510: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001f520: 2020 6465 7175 652c 206d 6178 6c65 6e3d    deque, maxlen=
+0001f530: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0001f540: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+0001f550: 6564 756c 6572 2e65 7665 6e74 732d 6c6f  eduler.events-lo
+0001f560: 672d 6c65 6e67 7468 2229 0a20 2020 2020  g-length").     
+0001f570: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001f580: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001f590: 6576 656e 745f 636f 756e 7473 203d 2064  event_counts = d
+0001f5a0: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
+0001f5b0: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+0001f5c0: 6e74 5f73 7562 7363 7269 6265 7220 3d20  nt_subscriber = 
+0001f5d0: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
+0001f5e0: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+0001f5f0: 726b 6572 5f70 6c75 6769 6e73 203d 207b  rker_plugins = {
+0001f600: 7d0a 2020 2020 2020 2020 7365 6c66 2e6e  }.        self.n
+0001f610: 616e 6e79 5f70 6c75 6769 6e73 203d 207b  anny_plugins = {
+0001f620: 7d0a 0a20 2020 2020 2020 2077 6f72 6b65  }..        worke
+0001f630: 725f 6861 6e64 6c65 7273 203d 207b 0a20  r_handlers = {. 
+0001f640: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+0001f650: 2d66 696e 6973 6865 6422 3a20 7365 6c66  -finished": self
+0001f660: 2e68 616e 646c 655f 7461 736b 5f66 696e  .handle_task_fin
+0001f670: 6973 6865 642c 0a20 2020 2020 2020 2020  ished,.         
+0001f680: 2020 2022 7461 736b 2d65 7272 6564 223a     "task-erred":
+0001f690: 2073 656c 662e 6861 6e64 6c65 5f74 6173   self.handle_tas
+0001f6a0: 6b5f 6572 7265 642c 0a20 2020 2020 2020  k_erred,.       
+0001f6b0: 2020 2020 2022 7265 6c65 6173 652d 776f       "release-wo
+0001f6c0: 726b 6572 2d64 6174 6122 3a20 7365 6c66  rker-data": self
+0001f6d0: 2e72 656c 6561 7365 5f77 6f72 6b65 725f  .release_worker_
+0001f6e0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+0001f6f0: 2020 2261 6464 2d6b 6579 7322 3a20 7365    "add-keys": se
+0001f700: 6c66 2e61 6464 5f6b 6579 732c 0a20 2020  lf.add_keys,.   
+0001f710: 2020 2020 2020 2020 2022 6c6f 6e67 2d72           "long-r
+0001f720: 756e 6e69 6e67 223a 2073 656c 662e 6861  unning": self.ha
+0001f730: 6e64 6c65 5f6c 6f6e 675f 7275 6e6e 696e  ndle_long_runnin
+0001f740: 672c 0a20 2020 2020 2020 2020 2020 2022  g,.            "
+0001f750: 7265 7363 6865 6475 6c65 223a 2073 656c  reschedule": sel
+0001f760: 662e 5f72 6573 6368 6564 756c 652c 0a20  f._reschedule,. 
+0001f770: 2020 2020 2020 2020 2020 2022 6b65 6570             "keep
+0001f780: 2d61 6c69 7665 223a 206c 616d 6264 6120  -alive": lambda 
+0001f790: 2a61 7267 732c 202a 2a6b 7761 7267 733a  *args, **kwargs:
+0001f7a0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+0001f7b0: 2020 2022 6c6f 672d 6576 656e 7422 3a20     "log-event": 
+0001f7c0: 7365 6c66 2e6c 6f67 5f77 6f72 6b65 725f  self.log_worker_
+0001f7d0: 6576 656e 742c 0a20 2020 2020 2020 2020  event,.         
+0001f7e0: 2020 2022 776f 726b 6572 2d73 7461 7475     "worker-statu
+0001f7f0: 732d 6368 616e 6765 223a 2073 656c 662e  s-change": self.
+0001f800: 6861 6e64 6c65 5f77 6f72 6b65 725f 7374  handle_worker_st
+0001f810: 6174 7573 5f63 6861 6e67 652c 0a20 2020  atus_change,.   
+0001f820: 2020 2020 2020 2020 2022 7265 7175 6573           "reques
+0001f830: 742d 7265 6672 6573 682d 7768 6f2d 6861  t-refresh-who-ha
+0001f840: 7322 3a20 7365 6c66 2e68 616e 646c 655f  s": self.handle_
+0001f850: 7265 7175 6573 745f 7265 6672 6573 685f  request_refresh_
+0001f860: 7768 6f5f 6861 732c 0a20 2020 2020 2020  who_has,.       
+0001f870: 207d 0a0a 2020 2020 2020 2020 636c 6965   }..        clie
+0001f880: 6e74 5f68 616e 646c 6572 7320 3d20 7b0a  nt_handlers = {.
+0001f890: 2020 2020 2020 2020 2020 2020 2275 7064              "upd
+0001f8a0: 6174 652d 6772 6170 6822 3a20 7365 6c66  ate-graph": self
+0001f8b0: 2e75 7064 6174 655f 6772 6170 682c 0a20  .update_graph,. 
+0001f8c0: 2020 2020 2020 2020 2020 2022 636c 6965             "clie
+0001f8d0: 6e74 2d64 6573 6972 6573 2d6b 6579 7322  nt-desires-keys"
+0001f8e0: 3a20 7365 6c66 2e63 6c69 656e 745f 6465  : self.client_de
+0001f8f0: 7369 7265 735f 6b65 7973 2c0a 2020 2020  sires_keys,.    
+0001f900: 2020 2020 2020 2020 2275 7064 6174 652d          "update-
+0001f910: 6461 7461 223a 2073 656c 662e 7570 6461  data": self.upda
+0001f920: 7465 5f64 6174 612c 0a20 2020 2020 2020  te_data,.       
+0001f930: 2020 2020 2022 7265 706f 7274 2d6b 6579       "report-key
+0001f940: 223a 2073 656c 662e 7265 706f 7274 5f6f  ": self.report_o
+0001f950: 6e5f 6b65 792c 0a20 2020 2020 2020 2020  n_key,.         
+0001f960: 2020 2022 636c 6965 6e74 2d72 656c 6561     "client-relea
+0001f970: 7365 732d 6b65 7973 223a 2073 656c 662e  ses-keys": self.
+0001f980: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
+0001f990: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+0001f9a0: 2020 2268 6561 7274 6265 6174 2d63 6c69    "heartbeat-cli
+0001f9b0: 656e 7422 3a20 7365 6c66 2e63 6c69 656e  ent": self.clien
+0001f9c0: 745f 6865 6172 7462 6561 742c 0a20 2020  t_heartbeat,.   
+0001f9d0: 2020 2020 2020 2020 2022 636c 6f73 652d           "close-
+0001f9e0: 636c 6965 6e74 223a 2073 656c 662e 7265  client": self.re
+0001f9f0: 6d6f 7665 5f63 6c69 656e 742c 0a20 2020  move_client,.   
+0001fa00: 2020 2020 2020 2020 2022 7375 6273 6372           "subscr
+0001fa10: 6962 652d 746f 7069 6322 3a20 7365 6c66  ibe-topic": self
+0001fa20: 2e73 7562 7363 7269 6265 5f74 6f70 6963  .subscribe_topic
+0001fa30: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+0001fa40: 6e73 7562 7363 7269 6265 2d74 6f70 6963  nsubscribe-topic
+0001fa50: 223a 2073 656c 662e 756e 7375 6273 6372  ": self.unsubscr
+0001fa60: 6962 655f 746f 7069 632c 0a20 2020 2020  ibe_topic,.     
+0001fa70: 2020 2020 2020 2022 6361 6e63 656c 2d6b         "cancel-k
+0001fa80: 6579 7322 3a20 7365 6c66 2e73 7469 6d75  eys": self.stimu
+0001fa90: 6c75 735f 6361 6e63 656c 2c0a 2020 2020  lus_cancel,.    
+0001faa0: 2020 2020 7d0a 0a20 2020 2020 2020 2073      }..        s
+0001fab0: 656c 662e 6861 6e64 6c65 7273 203d 207b  elf.handlers = {
+0001fac0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+0001fad0: 6769 7374 6572 2d63 6c69 656e 7422 3a20  gister-client": 
+0001fae0: 7365 6c66 2e61 6464 5f63 6c69 656e 742c  self.add_client,
+0001faf0: 0a20 2020 2020 2020 2020 2020 2022 7363  .            "sc
+0001fb00: 6174 7465 7222 3a20 7365 6c66 2e73 6361  atter": self.sca
+0001fb10: 7474 6572 2c0a 2020 2020 2020 2020 2020  tter,.          
+0001fb20: 2020 2272 6567 6973 7465 722d 776f 726b    "register-work
+0001fb30: 6572 223a 2073 656c 662e 6164 645f 776f  er": self.add_wo
+0001fb40: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
+0001fb50: 2020 2272 6567 6973 7465 725f 6e61 6e6e    "register_nann
+0001fb60: 7922 3a20 7365 6c66 2e61 6464 5f6e 616e  y": self.add_nan
+0001fb70: 6e79 2c0a 2020 2020 2020 2020 2020 2020  ny,.            
+0001fb80: 2275 6e72 6567 6973 7465 7222 3a20 7365  "unregister": se
+0001fb90: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
+0001fba0: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
+0001fbb0: 6174 6865 7222 3a20 7365 6c66 2e67 6174  ather": self.gat
+0001fbc0: 6865 722c 0a20 2020 2020 2020 2020 2020  her,.           
+0001fbd0: 2022 7265 7472 7922 3a20 7365 6c66 2e73   "retry": self.s
+0001fbe0: 7469 6d75 6c75 735f 7265 7472 792c 0a20  timulus_retry,. 
+0001fbf0: 2020 2020 2020 2020 2020 2022 6665 6564             "feed
+0001fc00: 223a 2073 656c 662e 6665 6564 2c0a 2020  ": self.feed,.  
+0001fc10: 2020 2020 2020 2020 2020 2274 6572 6d69            "termi
+0001fc20: 6e61 7465 223a 2073 656c 662e 636c 6f73  nate": self.clos
+0001fc30: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+0001fc40: 6272 6f61 6463 6173 7422 3a20 7365 6c66  broadcast": self
+0001fc50: 2e62 726f 6164 6361 7374 2c0a 2020 2020  .broadcast,.    
+0001fc60: 2020 2020 2020 2020 2270 726f 7879 223a          "proxy":
+0001fc70: 2073 656c 662e 7072 6f78 792c 0a20 2020   self.proxy,.   
+0001fc80: 2020 2020 2020 2020 2022 6e63 6f72 6573           "ncores
+0001fc90: 223a 2073 656c 662e 6765 745f 6e63 6f72  ": self.get_ncor
+0001fca0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0001fcb0: 226e 636f 7265 735f 7275 6e6e 696e 6722  "ncores_running"
+0001fcc0: 3a20 7365 6c66 2e67 6574 5f6e 636f 7265  : self.get_ncore
+0001fcd0: 735f 7275 6e6e 696e 672c 0a20 2020 2020  s_running,.     
+0001fce0: 2020 2020 2020 2022 6861 735f 7768 6174         "has_what
+0001fcf0: 223a 2073 656c 662e 6765 745f 6861 735f  ": self.get_has_
+0001fd00: 7768 6174 2c0a 2020 2020 2020 2020 2020  what,.          
+0001fd10: 2020 2277 686f 5f68 6173 223a 2073 656c    "who_has": sel
+0001fd20: 662e 6765 745f 7768 6f5f 6861 732c 0a20  f.get_who_has,. 
+0001fd30: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
+0001fd40: 6573 7369 6e67 223a 2073 656c 662e 6765  essing": self.ge
+0001fd50: 745f 7072 6f63 6573 7369 6e67 2c0a 2020  t_processing,.  
+0001fd60: 2020 2020 2020 2020 2020 2263 616c 6c5f            "call_
+0001fd70: 7374 6163 6b22 3a20 7365 6c66 2e67 6574  stack": self.get
+0001fd80: 5f63 616c 6c5f 7374 6163 6b2c 0a20 2020  _call_stack,.   
+0001fd90: 2020 2020 2020 2020 2022 7072 6f66 696c           "profil
+0001fda0: 6522 3a20 7365 6c66 2e67 6574 5f70 726f  e": self.get_pro
+0001fdb0: 6669 6c65 2c0a 2020 2020 2020 2020 2020  file,.          
+0001fdc0: 2020 2270 6572 666f 726d 616e 6365 5f72    "performance_r
+0001fdd0: 6570 6f72 7422 3a20 7365 6c66 2e70 6572  eport": self.per
+0001fde0: 666f 726d 616e 6365 5f72 6570 6f72 742c  formance_report,
+0001fdf0: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
+0001fe00: 745f 6c6f 6773 223a 2073 656c 662e 6765  t_logs": self.ge
+0001fe10: 745f 6c6f 6773 2c0a 2020 2020 2020 2020  t_logs,.        
+0001fe20: 2020 2020 226c 6f67 7322 3a20 7365 6c66      "logs": self
+0001fe30: 2e67 6574 5f6c 6f67 732c 0a20 2020 2020  .get_logs,.     
+0001fe40: 2020 2020 2020 2022 776f 726b 6572 5f6c         "worker_l
+0001fe50: 6f67 7322 3a20 7365 6c66 2e67 6574 5f77  ogs": self.get_w
+0001fe60: 6f72 6b65 725f 6c6f 6773 2c0a 2020 2020  orker_logs,.    
+0001fe70: 2020 2020 2020 2020 226c 6f67 5f65 7665          "log_eve
+0001fe80: 6e74 223a 2073 656c 662e 6c6f 675f 6576  nt": self.log_ev
+0001fe90: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+0001fea0: 2022 6576 656e 7473 223a 2073 656c 662e   "events": self.
+0001feb0: 6765 745f 6576 656e 7473 2c0a 2020 2020  get_events,.    
+0001fec0: 2020 2020 2020 2020 226e 6279 7465 7322          "nbytes"
+0001fed0: 3a20 7365 6c66 2e67 6574 5f6e 6279 7465  : self.get_nbyte
+0001fee0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+0001fef0: 7665 7273 696f 6e73 223a 2073 656c 662e  versions": self.
+0001ff00: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
+0001ff10: 2020 2020 2020 2261 6464 5f6b 6579 7322        "add_keys"
+0001ff20: 3a20 7365 6c66 2e61 6464 5f6b 6579 732c  : self.add_keys,
+0001ff30: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+0001ff40: 6261 6c61 6e63 6522 3a20 7365 6c66 2e72  balance": self.r
+0001ff50: 6562 616c 616e 6365 2c0a 2020 2020 2020  ebalance,.      
+0001ff60: 2020 2020 2020 2272 6570 6c69 6361 7465        "replicate
+0001ff70: 223a 2073 656c 662e 7265 706c 6963 6174  ": self.replicat
+0001ff80: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+0001ff90: 7275 6e5f 6675 6e63 7469 6f6e 223a 2073  run_function": s
+0001ffa0: 656c 662e 7275 6e5f 6675 6e63 7469 6f6e  elf.run_function
+0001ffb0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+0001ffc0: 6573 7461 7274 223a 2073 656c 662e 7265  estart": self.re
+0001ffd0: 7374 6172 742c 0a20 2020 2020 2020 2020  start,.         
+0001ffe0: 2020 2022 7570 6461 7465 5f64 6174 6122     "update_data"
+0001fff0: 3a20 7365 6c66 2e75 7064 6174 655f 6461  : self.update_da
+00020000: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+00020010: 2273 6574 5f72 6573 6f75 7263 6573 223a  "set_resources":
+00020020: 2073 656c 662e 6164 645f 7265 736f 7572   self.add_resour
+00020030: 6365 732c 0a20 2020 2020 2020 2020 2020  ces,.           
+00020040: 2022 7265 7469 7265 5f77 6f72 6b65 7273   "retire_workers
+00020050: 223a 2073 656c 662e 7265 7469 7265 5f77  ": self.retire_w
+00020060: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+00020070: 2020 2020 2267 6574 5f6d 6574 6164 6174      "get_metadat
+00020080: 6122 3a20 7365 6c66 2e67 6574 5f6d 6574  a": self.get_met
+00020090: 6164 6174 612c 0a20 2020 2020 2020 2020  adata,.         
+000200a0: 2020 2022 7365 745f 6d65 7461 6461 7461     "set_metadata
+000200b0: 223a 2073 656c 662e 7365 745f 6d65 7461  ": self.set_meta
+000200c0: 6461 7461 2c0a 2020 2020 2020 2020 2020  data,.          
+000200d0: 2020 2273 6574 5f72 6573 7472 6963 7469    "set_restricti
+000200e0: 6f6e 7322 3a20 7365 6c66 2e73 6574 5f72  ons": self.set_r
+000200f0: 6573 7472 6963 7469 6f6e 732c 0a20 2020  estrictions,.   
+00020100: 2020 2020 2020 2020 2022 6865 6172 7462           "heartb
+00020110: 6561 745f 776f 726b 6572 223a 2073 656c  eat_worker": sel
+00020120: 662e 6865 6172 7462 6561 745f 776f 726b  f.heartbeat_work
+00020130: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00020140: 2267 6574 5f74 6173 6b5f 7374 6174 7573  "get_task_status
+00020150: 223a 2073 656c 662e 6765 745f 7461 736b  ": self.get_task
+00020160: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
+00020170: 2020 2020 2022 6765 745f 7461 736b 5f73       "get_task_s
+00020180: 7472 6561 6d22 3a20 7365 6c66 2e67 6574  tream": self.get
+00020190: 5f74 6173 6b5f 7374 7265 616d 2c0a 2020  _task_stream,.  
+000201a0: 2020 2020 2020 2020 2020 2267 6574 5f74            "get_t
+000201b0: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
+000201c0: 7322 3a20 7365 6c66 2e67 6574 5f74 6173  s": self.get_tas
+000201d0: 6b5f 7072 6566 6978 5f73 7461 7465 732c  k_prefix_states,
 000201e0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
-000201f0: 6769 7374 6572 5f77 6f72 6b65 725f 706c  gister_worker_pl
-00020200: 7567 696e 223a 2073 656c 662e 7265 6769  ugin": self.regi
-00020210: 7374 6572 5f77 6f72 6b65 725f 706c 7567  ster_worker_plug
-00020220: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
-00020230: 2275 6e72 6567 6973 7465 725f 776f 726b  "unregister_work
-00020240: 6572 5f70 6c75 6769 6e22 3a20 7365 6c66  er_plugin": self
-00020250: 2e75 6e72 6567 6973 7465 725f 776f 726b  .unregister_work
-00020260: 6572 5f70 6c75 6769 6e2c 0a20 2020 2020  er_plugin,.     
-00020270: 2020 2020 2020 2022 7265 6769 7374 6572         "register
-00020280: 5f6e 616e 6e79 5f70 6c75 6769 6e22 3a20  _nanny_plugin": 
-00020290: 7365 6c66 2e72 6567 6973 7465 725f 6e61  self.register_na
-000202a0: 6e6e 795f 706c 7567 696e 2c0a 2020 2020  nny_plugin,.    
-000202b0: 2020 2020 2020 2020 2275 6e72 6567 6973          "unregis
-000202c0: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
-000202d0: 223a 2073 656c 662e 756e 7265 6769 7374  ": self.unregist
-000202e0: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e2c  er_nanny_plugin,
-000202f0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
-00020300: 6170 7469 7665 5f74 6172 6765 7422 3a20  aptive_target": 
-00020310: 7365 6c66 2e61 6461 7074 6976 655f 7461  self.adaptive_ta
-00020320: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
-00020330: 2020 2277 6f72 6b65 7273 5f74 6f5f 636c    "workers_to_cl
-00020340: 6f73 6522 3a20 7365 6c66 2e77 6f72 6b65  ose": self.worke
-00020350: 7273 5f74 6f5f 636c 6f73 652c 0a20 2020  rs_to_close,.   
-00020360: 2020 2020 2020 2020 2022 7375 6273 6372           "subscr
-00020370: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
-00020380: 7322 3a20 7365 6c66 2e73 7562 7363 7269  s": self.subscri
-00020390: 6265 5f77 6f72 6b65 725f 7374 6174 7573  be_worker_status
-000203a0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-000203b0: 7461 7274 5f74 6173 6b5f 6d65 7461 6461  tart_task_metada
-000203c0: 7461 223a 2073 656c 662e 7374 6172 745f  ta": self.start_
-000203d0: 7461 736b 5f6d 6574 6164 6174 612c 0a20  task_metadata,. 
-000203e0: 2020 2020 2020 2020 2020 2022 7374 6f70             "stop
-000203f0: 5f74 6173 6b5f 6d65 7461 6461 7461 223a  _task_metadata":
-00020400: 2073 656c 662e 7374 6f70 5f74 6173 6b5f   self.stop_task_
-00020410: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
-00020420: 2020 2020 2020 2267 6574 5f63 6c75 7374        "get_clust
-00020430: 6572 5f73 7461 7465 223a 2073 656c 662e  er_state": self.
-00020440: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
-00020450: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
-00020460: 6475 6d70 5f63 6c75 7374 6572 5f73 7461  dump_cluster_sta
-00020470: 7465 5f74 6f5f 7572 6c22 3a20 7365 6c66  te_to_url": self
-00020480: 2e64 756d 705f 636c 7573 7465 725f 7374  .dump_cluster_st
-00020490: 6174 655f 746f 5f75 726c 2c0a 2020 2020  ate_to_url,.    
-000204a0: 2020 2020 2020 2020 2262 656e 6368 6d61          "benchma
-000204b0: 726b 5f68 6172 6477 6172 6522 3a20 7365  rk_hardware": se
-000204c0: 6c66 2e62 656e 6368 6d61 726b 5f68 6172  lf.benchmark_har
-000204d0: 6477 6172 652c 0a20 2020 2020 2020 2020  dware,.         
-000204e0: 2020 2022 6765 745f 7374 6f72 7922 3a20     "get_story": 
-000204f0: 7365 6c66 2e67 6574 5f73 746f 7279 2c0a  self.get_story,.
-00020500: 2020 2020 2020 2020 2020 2020 2263 6865              "che
-00020510: 636b 5f69 646c 6522 3a20 7365 6c66 2e63  ck_idle": self.c
-00020520: 6865 636b 5f69 646c 652c 0a20 2020 2020  heck_idle,.     
-00020530: 2020 207d 0a0a 2020 2020 2020 2020 636f     }..        co
-00020540: 6e6e 6563 7469 6f6e 5f6c 696d 6974 203d  nnection_limit =
-00020550: 2067 6574 5f66 696c 656e 6f5f 6c69 6d69   get_fileno_limi
-00020560: 7428 2920 2f20 320a 0a20 2020 2020 2020  t() / 2..       
-00020570: 2053 6368 6564 756c 6572 5374 6174 652e   SchedulerState.
-00020580: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-00020590: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-000205a0: 2020 2020 2020 2020 616c 6961 7365 733d          aliases=
-000205b0: 616c 6961 7365 732c 0a20 2020 2020 2020  aliases,.       
-000205c0: 2020 2020 2063 6c69 656e 7473 3d63 6c69       clients=cli
-000205d0: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
-000205e0: 2020 776f 726b 6572 733d 776f 726b 6572    workers=worker
-000205f0: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
-00020600: 6f73 745f 696e 666f 3d68 6f73 745f 696e  ost_info=host_in
-00020610: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
-00020620: 7265 736f 7572 6365 733d 7265 736f 7572  resources=resour
-00020630: 6365 732c 0a20 2020 2020 2020 2020 2020  ces,.           
-00020640: 2074 6173 6b73 3d74 6173 6b73 2c0a 2020   tasks=tasks,.  
-00020650: 2020 2020 2020 2020 2020 756e 7275 6e6e            unrunn
-00020660: 6162 6c65 3d75 6e72 756e 6e61 626c 652c  able=unrunnable,
-00020670: 0a20 2020 2020 2020 2020 2020 2071 7565  .            que
-00020680: 7565 643d 7175 6575 6564 2c0a 2020 2020  ued=queued,.    
-00020690: 2020 2020 2020 2020 7661 6c69 6461 7465          validate
-000206a0: 3d76 616c 6964 6174 652c 0a20 2020 2020  =validate,.     
-000206b0: 2020 2020 2020 2070 6c75 6769 6e73 3d70         plugins=p
-000206c0: 6c75 6769 6e73 2c0a 2020 2020 2020 2020  lugins,.        
-000206d0: 2020 2020 7472 616e 7369 7469 6f6e 5f63      transition_c
-000206e0: 6f75 6e74 6572 5f6d 6178 3d74 7261 6e73  ounter_max=trans
-000206f0: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
-00020700: 782c 0a20 2020 2020 2020 2029 0a20 2020  x,.        ).   
-00020710: 2020 2020 2053 6572 7665 724e 6f64 652e       ServerNode.
-00020720: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
-00020730: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00020740: 2020 2020 2020 2020 6861 6e64 6c65 7273          handlers
-00020750: 3d73 656c 662e 6861 6e64 6c65 7273 2c0a  =self.handlers,.
-00020760: 2020 2020 2020 2020 2020 2020 7374 7265              stre
-00020770: 616d 5f68 616e 646c 6572 733d 6d65 7267  am_handlers=merg
-00020780: 6528 776f 726b 6572 5f68 616e 646c 6572  e(worker_handler
-00020790: 732c 2063 6c69 656e 745f 6861 6e64 6c65  s, client_handle
-000207a0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
-000207b0: 2063 6f6e 6e65 6374 696f 6e5f 6c69 6d69   connection_limi
-000207c0: 743d 636f 6e6e 6563 7469 6f6e 5f6c 696d  t=connection_lim
-000207d0: 6974 2c0a 2020 2020 2020 2020 2020 2020  it,.            
-000207e0: 6465 7365 7269 616c 697a 653d 4661 6c73  deserialize=Fals
-000207f0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
-00020800: 6f6e 6e65 6374 696f 6e5f 6172 6773 3d73  onnection_args=s
-00020810: 656c 662e 636f 6e6e 6563 7469 6f6e 5f61  elf.connection_a
-00020820: 7267 732c 0a20 2020 2020 2020 2020 2020  rgs,.           
-00020830: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00020840: 2020 2029 0a0a 2020 2020 2020 2020 6966     )..        if
-00020850: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
-00020860: 3a0a 2020 2020 2020 2020 2020 2020 7063  :.            pc
-00020870: 203d 2050 6572 696f 6469 6343 616c 6c62   = PeriodicCallb
-00020880: 6163 6b28 7365 6c66 2e63 6865 636b 5f77  ack(self.check_w
-00020890: 6f72 6b65 725f 7474 6c2c 2073 656c 662e  orker_ttl, self.
-000208a0: 776f 726b 6572 5f74 746c 202a 2031 3030  worker_ttl * 100
-000208b0: 3029 0a20 2020 2020 2020 2020 2020 2073  0).            s
-000208c0: 656c 662e 7065 7269 6f64 6963 5f63 616c  elf.periodic_cal
-000208d0: 6c62 6163 6b73 5b22 776f 726b 6572 2d74  lbacks["worker-t
-000208e0: 746c 225d 203d 2070 630a 0a20 2020 2020  tl"] = pc..     
-000208f0: 2020 2070 6320 3d20 5065 7269 6f64 6963     pc = Periodic
-00020900: 4361 6c6c 6261 636b 2873 656c 662e 6368  Callback(self.ch
-00020910: 6563 6b5f 6964 6c65 2c20 2873 656c 662e  eck_idle, (self.
-00020920: 6964 6c65 5f74 696d 656f 7574 206f 7220  idle_timeout or 
-00020930: 3129 202a 2031 3030 3020 2f20 3429 0a20  1) * 1000 / 4). 
-00020940: 2020 2020 2020 2073 656c 662e 7065 7269         self.peri
-00020950: 6f64 6963 5f63 616c 6c62 6163 6b73 5b22  odic_callbacks["
-00020960: 6964 6c65 2d74 696d 656f 7574 225d 203d  idle-timeout"] =
-00020970: 2070 630a 0a20 2020 2020 2020 2069 6620   pc..        if 
-00020980: 6578 7465 6e73 696f 6e73 2069 7320 4e6f  extensions is No
-00020990: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000209a0: 6578 7465 6e73 696f 6e73 203d 2044 4546  extensions = DEF
-000209b0: 4155 4c54 5f45 5854 454e 5349 4f4e 532e  AULT_EXTENSIONS.
-000209c0: 636f 7079 2829 0a20 2020 2020 2020 2020  copy().         
-000209d0: 2020 2069 6620 6e6f 7420 6461 736b 2e63     if not dask.c
-000209e0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-000209f0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-00020a00: 2e77 6f72 6b2d 7374 6561 6c69 6e67 2229  .work-stealing")
-00020a10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00020a20: 2020 6966 2022 7374 6561 6c69 6e67 2220    if "stealing" 
-00020a30: 696e 2065 7874 656e 7369 6f6e 733a 0a20  in extensions:. 
-00020a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020a50: 2020 2064 656c 2065 7874 656e 7369 6f6e     del extension
-00020a60: 735b 2273 7465 616c 696e 6722 5d0a 0a20  s["stealing"].. 
-00020a70: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-00020a80: 2065 7874 656e 7369 6f6e 2069 6e20 6578   extension in ex
-00020a90: 7465 6e73 696f 6e73 2e69 7465 6d73 2829  tensions.items()
-00020aa0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00020ab0: 6c66 2e65 7874 656e 7369 6f6e 735b 6e61  lf.extensions[na
-00020ac0: 6d65 5d20 3d20 6578 7465 6e73 696f 6e28  me] = extension(
-00020ad0: 7365 6c66 290a 0a20 2020 2020 2020 2073  self)..        s
-00020ae0: 6574 7072 6f63 7469 746c 6528 2264 6173  etproctitle("das
-00020af0: 6b20 7363 6865 6475 6c65 7220 5b6e 6f74  k scheduler [not
-00020b00: 2073 7461 7274 6564 5d22 290a 2020 2020   started]").    
-00020b10: 2020 2020 5363 6865 6475 6c65 722e 5f69      Scheduler._i
-00020b20: 6e73 7461 6e63 6573 2e61 6464 2873 656c  nstances.add(sel
-00020b30: 6629 0a20 2020 2020 2020 2073 656c 662e  f).        self.
-00020b40: 7270 632e 616c 6c6f 775f 6f66 666c 6f61  rpc.allow_offloa
-00020b50: 6420 3d20 4661 6c73 650a 0a20 2020 2023  d = False..    #
-00020b60: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00020b70: 230a 2020 2020 2320 4164 6d69 6e69 7374  #.    # Administ
-00020b80: 7261 7469 6f6e 2023 0a20 2020 2023 2323  ration #.    ###
-00020b90: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00020ba0: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
-00020bb0: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00020bc0: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00020bd0: 2020 2020 2020 6622 3c53 6368 6564 756c        f"<Schedul
-00020be0: 6572 207b 7365 6c66 2e61 6464 7265 7373  er {self.address
-00020bf0: 5f73 6166 6521 727d 2c20 220a 2020 2020  _safe!r}, ".    
-00020c00: 2020 2020 2020 2020 6622 776f 726b 6572          f"worker
-00020c10: 733a 207b 6c65 6e28 7365 6c66 2e77 6f72  s: {len(self.wor
-00020c20: 6b65 7273 297d 2c20 220a 2020 2020 2020  kers)}, ".      
-00020c30: 2020 2020 2020 6622 636f 7265 733a 207b        f"cores: {
-00020c40: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
-00020c50: 6164 737d 2c20 220a 2020 2020 2020 2020  ads}, ".        
-00020c60: 2020 2020 6622 7461 736b 733a 207b 6c65      f"tasks: {le
-00020c70: 6e28 7365 6c66 2e74 6173 6b73 297d 3e22  n(self.tasks)}>"
-00020c80: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00020c90: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
-00020ca0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
-00020cb0: 6574 7572 6e20 6765 745f 7465 6d70 6c61  eturn get_templa
-00020cc0: 7465 2822 7363 6865 6475 6c65 722e 6874  te("scheduler.ht
-00020cd0: 6d6c 2e6a 3222 292e 7265 6e64 6572 280a  ml.j2").render(.
-00020ce0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-00020cf0: 6573 733d 7365 6c66 2e61 6464 7265 7373  ess=self.address
-00020d00: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
-00020d10: 726b 6572 733d 7365 6c66 2e77 6f72 6b65  rkers=self.worke
-00020d20: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00020d30: 7468 7265 6164 733d 7365 6c66 2e74 6f74  threads=self.tot
-00020d40: 616c 5f6e 7468 7265 6164 732c 0a20 2020  al_nthreads,.   
-00020d50: 2020 2020 2020 2020 2074 6173 6b73 3d73           tasks=s
-00020d60: 656c 662e 7461 736b 732c 0a20 2020 2020  elf.tasks,.     
-00020d70: 2020 2029 0a0a 2020 2020 6465 6620 6964     )..    def id
-00020d80: 656e 7469 7479 2873 656c 6629 3a0a 2020  entity(self):.  
-00020d90: 2020 2020 2020 2222 2242 6173 6963 2069        """Basic i
-00020da0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00020db0: 206f 7572 7365 6c76 6573 2061 6e64 206f   ourselves and o
-00020dc0: 7572 2063 6c75 7374 6572 2222 220a 2020  ur cluster""".  
-00020dd0: 2020 2020 2020 6420 3d20 7b0a 2020 2020        d = {.    
-00020de0: 2020 2020 2020 2020 2274 7970 6522 3a20          "type": 
-00020df0: 7479 7065 2873 656c 6629 2e5f 5f6e 616d  type(self).__nam
-00020e00: 655f 5f2c 0a20 2020 2020 2020 2020 2020  e__,.           
-00020e10: 2022 6964 223a 2073 7472 2873 656c 662e   "id": str(self.
-00020e20: 6964 292c 0a20 2020 2020 2020 2020 2020  id),.           
-00020e30: 2022 6164 6472 6573 7322 3a20 7365 6c66   "address": self
-00020e40: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
-00020e50: 2020 2020 2020 2273 6572 7669 6365 7322        "services"
-00020e60: 3a20 7b6b 6579 3a20 762e 706f 7274 2066  : {key: v.port f
-00020e70: 6f72 2028 6b65 792c 2076 2920 696e 2073  or (key, v) in s
-00020e80: 656c 662e 7365 7276 6963 6573 2e69 7465  elf.services.ite
-00020e90: 6d73 2829 7d2c 0a20 2020 2020 2020 2020  ms()},.         
-00020ea0: 2020 2022 7374 6172 7465 6422 3a20 7365     "started": se
-00020eb0: 6c66 2e74 696d 655f 7374 6172 7465 642c  lf.time_started,
-00020ec0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
-00020ed0: 726b 6572 7322 3a20 7b0a 2020 2020 2020  rkers": {.      
-00020ee0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00020ef0: 2e61 6464 7265 7373 3a20 776f 726b 6572  .address: worker
-00020f00: 2e69 6465 6e74 6974 7928 2920 666f 7220  .identity() for 
-00020f10: 776f 726b 6572 2069 6e20 7365 6c66 2e77  worker in self.w
-00020f20: 6f72 6b65 7273 2e76 616c 7565 7328 290a  orkers.values().
-00020f30: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00020f40: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00020f50: 2072 6574 7572 6e20 640a 0a20 2020 2064   return d..    d
-00020f60: 6566 205f 746f 5f64 6963 7428 7365 6c66  ef _to_dict(self
-00020f70: 2c20 2a2c 2065 7863 6c75 6465 3a20 436f  , *, exclude: Co
-00020f80: 6e74 6169 6e65 725b 7374 725d 203d 2028  ntainer[str] = (
-00020f90: 2929 202d 3e20 6469 6374 3a0a 2020 2020  )) -> dict:.    
-00020fa0: 2020 2020 2222 2244 6963 7469 6f6e 6172      """Dictionar
-00020fb0: 7920 7265 7072 6573 656e 7461 7469 6f6e  y representation
-00020fc0: 2066 6f72 2064 6562 7567 6769 6e67 2070   for debugging p
-00020fd0: 7572 706f 7365 732e 0a20 2020 2020 2020  urposes..       
-00020fe0: 204e 6f74 2074 7970 6520 7374 6162 6c65   Not type stable
-00020ff0: 2061 6e64 206e 6f74 2069 6e74 656e 6465   and not intende
-00021000: 6420 666f 7220 726f 756e 6474 7269 7073  d for roundtrips
-00021010: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-00021020: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-00021030: 2d2d 2d2d 0a20 2020 2020 2020 2053 6572  ----.        Ser
-00021040: 7665 722e 6964 656e 7469 7479 0a20 2020  ver.identity.   
-00021050: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
-00021060: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
-00021070: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
-00021080: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
-00021090: 7665 5f74 6f5f 6469 6374 0a20 2020 2020  ve_to_dict.     
-000210a0: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-000210b0: 6e66 6f20 3d20 7375 7065 7228 292e 5f74  nfo = super()._t
-000210c0: 6f5f 6469 6374 2865 7863 6c75 6465 3d65  o_dict(exclude=e
-000210d0: 7863 6c75 6465 290a 2020 2020 2020 2020  xclude).        
-000210e0: 6578 7472 6120 3d20 7b0a 2020 2020 2020  extra = {.      
-000210f0: 2020 2020 2020 2274 7261 6e73 6974 696f        "transitio
-00021100: 6e5f 6c6f 6722 3a20 7365 6c66 2e74 7261  n_log": self.tra
-00021110: 6e73 6974 696f 6e5f 6c6f 672c 0a20 2020  nsition_log,.   
-00021120: 2020 2020 2020 2020 2022 7472 616e 7369           "transi
-00021130: 7469 6f6e 5f63 6f75 6e74 6572 223a 2073  tion_counter": s
-00021140: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
-00021150: 6f75 6e74 6572 2c0a 2020 2020 2020 2020  ounter,.        
-00021160: 2020 2020 2274 6173 6b73 223a 2073 656c      "tasks": sel
-00021170: 662e 7461 736b 732c 0a20 2020 2020 2020  f.tasks,.       
-00021180: 2020 2020 2022 7461 736b 5f67 726f 7570       "task_group
-00021190: 7322 3a20 7365 6c66 2e74 6173 6b5f 6772  s": self.task_gr
-000211a0: 6f75 7073 2c0a 2020 2020 2020 2020 2020  oups,.          
-000211b0: 2020 2320 4f76 6572 7772 6974 6520 6469    # Overwrite di
-000211c0: 6374 206f 6620 576f 726b 6572 5374 6174  ct of WorkerStat
-000211d0: 652e 6964 656e 7469 7479 2066 726f 6d20  e.identity from 
-000211e0: 696e 666f 0a20 2020 2020 2020 2020 2020  info.           
-000211f0: 2022 776f 726b 6572 7322 3a20 7365 6c66   "workers": self
-00021200: 2e77 6f72 6b65 7273 2c0a 2020 2020 2020  .workers,.      
-00021210: 2020 2020 2020 2263 6c69 656e 7473 223a        "clients":
-00021220: 2073 656c 662e 636c 6965 6e74 732c 0a20   self.clients,. 
-00021230: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00021240: 7279 223a 2073 656c 662e 6d65 6d6f 7279  ry": self.memory
-00021250: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
-00021260: 7665 6e74 7322 3a20 7365 6c66 2e65 7665  vents": self.eve
-00021270: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
-00021280: 2022 6578 7465 6e73 696f 6e73 223a 2073   "extensions": s
-00021290: 656c 662e 6578 7465 6e73 696f 6e73 2c0a  elf.extensions,.
-000212a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000212b0: 2020 6578 7472 6120 3d20 7b6b 3a20 7620    extra = {k: v 
-000212c0: 666f 7220 6b2c 2076 2069 6e20 6578 7472  for k, v in extr
-000212d0: 612e 6974 656d 7328 2920 6966 206b 206e  a.items() if k n
-000212e0: 6f74 2069 6e20 6578 636c 7564 657d 0a20  ot in exclude}. 
-000212f0: 2020 2020 2020 2069 6e66 6f2e 7570 6461         info.upda
-00021300: 7465 2872 6563 7572 7369 7665 5f74 6f5f  te(recursive_to_
-00021310: 6469 6374 2865 7874 7261 2c20 6578 636c  dict(extra, excl
-00021320: 7564 653d 6578 636c 7564 6529 290a 2020  ude=exclude)).  
-00021330: 2020 2020 2020 7265 7475 726e 2069 6e66        return inf
-00021340: 6f0a 0a20 2020 2061 7379 6e63 2064 6566  o..    async def
-00021350: 2067 6574 5f63 6c75 7374 6572 5f73 7461   get_cluster_sta
-00021360: 7465 280a 2020 2020 2020 2020 7365 6c66  te(.        self
-00021370: 2c0a 2020 2020 2020 2020 6578 636c 7564  ,.        exclud
-00021380: 653a 2022 436f 6c6c 6563 7469 6f6e 5b73  e: "Collection[s
-00021390: 7472 5d22 2c0a 2020 2020 2920 2d3e 2064  tr]",.    ) -> d
-000213a0: 6963 743a 0a20 2020 2020 2020 2022 5072  ict:.        "Pr
-000213b0: 6f64 7563 6520 7468 6520 7374 6174 6520  oduce the state 
-000213c0: 6469 6374 2075 7365 6420 696e 2061 2063  dict used in a c
-000213d0: 6c75 7374 6572 2073 7461 7465 2064 756d  luster state dum
-000213e0: 7022 0a20 2020 2020 2020 2023 204b 6963  p".        # Kic
-000213f0: 6b20 6f66 6620 7374 6174 652d 6475 6d70  k off state-dump
-00021400: 696e 6720 6f6e 2077 6f72 6b65 7273 2062  ing on workers b
-00021410: 6566 6f72 6520 7765 2062 6c6f 636b 2074  efore we block t
-00021420: 6865 2065 7665 6e74 206c 6f6f 7020 696e  he event loop in
-00021430: 2060 7365 6c66 2e5f 746f 5f64 6963 7460   `self._to_dict`
-00021440: 2e0a 2020 2020 2020 2020 776f 726b 6572  ..        worker
-00021450: 735f 6675 7475 7265 203d 2061 7379 6e63  s_future = async
-00021460: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00021470: 2020 2020 2020 2073 656c 662e 6272 6f61         self.broa
-00021480: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
-00021490: 2020 2020 2020 206d 7367 3d7b 226f 7022         msg={"op"
-000214a0: 3a20 2264 756d 705f 7374 6174 6522 2c20  : "dump_state", 
-000214b0: 2265 7863 6c75 6465 223a 2065 7863 6c75  "exclude": exclu
-000214c0: 6465 7d2c 0a20 2020 2020 2020 2020 2020  de},.           
-000214d0: 2020 2020 206f 6e5f 6572 726f 723d 2272       on_error="r
-000214e0: 6574 7572 6e22 2c0a 2020 2020 2020 2020  eturn",.        
-000214f0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00021500: 2020 2073 656c 662e 6272 6f61 6463 6173     self.broadcas
-00021510: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00021520: 2020 206d 7367 3d7b 226f 7022 3a20 2276     msg={"op": "v
-00021530: 6572 7369 6f6e 7322 7d2c 0a20 2020 2020  ersions"},.     
-00021540: 2020 2020 2020 2020 2020 206f 6e5f 6572             on_er
-00021550: 726f 723d 2269 676e 6f72 6522 2c0a 2020  ror="ignore",.  
-00021560: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00021570: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00021580: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00021590: 7363 6865 6475 6c65 725f 7374 6174 6520  scheduler_state 
-000215a0: 3d20 7365 6c66 2e5f 746f 5f64 6963 7428  = self._to_dict(
-000215b0: 6578 636c 7564 653d 6578 636c 7564 6529  exclude=exclude)
-000215c0: 0a0a 2020 2020 2020 2020 2020 2020 776f  ..            wo
-000215d0: 726b 6572 5f73 7461 7465 732c 2077 6f72  rker_states, wor
-000215e0: 6b65 725f 7665 7273 696f 6e73 203d 2061  ker_versions = a
-000215f0: 7761 6974 2077 6f72 6b65 7273 5f66 7574  wait workers_fut
-00021600: 7572 650a 2020 2020 2020 2020 6669 6e61  ure.        fina
-00021610: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00021620: 2023 2045 6e73 7572 6520 7468 6520 7461   # Ensure the ta
-00021630: 736b 7320 6172 656e 2774 206c 6566 7420  sks aren't left 
-00021640: 7275 6e6e 696e 6720 6966 2061 6e79 7468  running if anyth
-00021650: 696e 6720 6661 696c 732e 0a20 2020 2020  ing fails..     
-00021660: 2020 2020 2020 2023 2053 6f6d 6564 6179         # Someday
-00021670: 2028 7079 332e 3131 292c 2075 7365 2061   (py3.11), use a
-00021680: 2074 7269 6f2d 7374 796c 6520 5461 736b   trio-style Task
-00021690: 4772 6f75 7020 666f 7220 7468 6973 2e0a  Group for this..
-000216a0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000216b0: 6572 735f 6675 7475 7265 2e63 616e 6365  ers_future.cance
-000216c0: 6c28 290a 0a20 2020 2020 2020 2023 2043  l()..        # C
-000216d0: 6f6e 7665 7274 2061 6e79 2052 5043 2065  onvert any RPC e
-000216e0: 7272 6f72 7320 746f 2073 7472 696e 6773  rrors to strings
-000216f0: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00021700: 7374 6174 6573 203d 207b 0a20 2020 2020  states = {.     
-00021710: 2020 2020 2020 206b 3a20 7265 7072 2876         k: repr(v
-00021720: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
-00021730: 762c 2045 7863 6570 7469 6f6e 2920 656c  v, Exception) el
-00021740: 7365 2076 0a20 2020 2020 2020 2020 2020  se v.           
-00021750: 2066 6f72 206b 2c20 7620 696e 2077 6f72   for k, v in wor
-00021760: 6b65 725f 7374 6174 6573 2e69 7465 6d73  ker_states.items
-00021770: 2829 0a20 2020 2020 2020 207d 0a0a 2020  ().        }..  
-00021780: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
-00021790: 2020 2020 2020 2020 2020 2022 7363 6865             "sche
-000217a0: 6475 6c65 7222 3a20 7363 6865 6475 6c65  duler": schedule
-000217b0: 725f 7374 6174 652c 0a20 2020 2020 2020  r_state,.       
-000217c0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
-000217d0: 776f 726b 6572 5f73 7461 7465 732c 0a20  worker_states,. 
-000217e0: 2020 2020 2020 2020 2020 2022 7665 7273             "vers
-000217f0: 696f 6e73 223a 207b 2273 6368 6564 756c  ions": {"schedul
-00021800: 6572 223a 2073 656c 662e 7665 7273 696f  er": self.versio
-00021810: 6e73 2829 2c20 2277 6f72 6b65 7273 223a  ns(), "workers":
-00021820: 2077 6f72 6b65 725f 7665 7273 696f 6e73   worker_versions
-00021830: 7d2c 0a20 2020 2020 2020 207d 0a0a 2020  },.        }..  
-00021840: 2020 6173 796e 6320 6465 6620 6475 6d70    async def dump
-00021850: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
-00021860: 6f5f 7572 6c28 0a20 2020 2020 2020 2073  o_url(.        s
-00021870: 656c 662c 0a20 2020 2020 2020 2075 726c  elf,.        url
-00021880: 3a20 7374 722c 0a20 2020 2020 2020 2065  : str,.        e
-00021890: 7863 6c75 6465 3a20 2243 6f6c 6c65 6374  xclude: "Collect
-000218a0: 696f 6e5b 7374 725d 222c 0a20 2020 2020  ion[str]",.     
-000218b0: 2020 2066 6f72 6d61 743a 204c 6974 6572     format: Liter
-000218c0: 616c 5b22 6d73 6770 6163 6b22 2c20 2279  al["msgpack", "y
-000218d0: 616d 6c22 5d2c 0a20 2020 2020 2020 202a  aml"],.        *
-000218e0: 2a73 746f 7261 6765 5f6f 7074 696f 6e73  *storage_options
-000218f0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-00021900: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-00021910: 0a20 2020 2020 2020 2022 5772 6974 6520  .        "Write 
-00021920: 6120 636c 7573 7465 7220 7374 6174 6520  a cluster state 
-00021930: 6475 6d70 2074 6f20 616e 2066 7373 7065  dump to an fsspe
-00021940: 632d 636f 6d70 6174 6962 6c65 2055 524c  c-compatible URL
-00021950: 2e22 0a20 2020 2020 2020 2061 7761 6974  .".        await
-00021960: 2063 6c75 7374 6572 5f64 756d 702e 7772   cluster_dump.wr
-00021970: 6974 655f 7374 6174 6528 0a20 2020 2020  ite_state(.     
-00021980: 2020 2020 2020 2070 6172 7469 616c 2873         partial(s
-00021990: 656c 662e 6765 745f 636c 7573 7465 725f  elf.get_cluster_
-000219a0: 7374 6174 652c 2065 7863 6c75 6465 292c  state, exclude),
-000219b0: 2075 726c 2c20 666f 726d 6174 2c20 2a2a   url, format, **
-000219c0: 7374 6f72 6167 655f 6f70 7469 6f6e 730a  storage_options.
-000219d0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-000219e0: 6566 2067 6574 5f77 6f72 6b65 725f 7365  ef get_worker_se
-000219f0: 7276 6963 655f 6164 6472 280a 2020 2020  rvice_addr(.    
-00021a00: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
-00021a10: 3a20 7374 722c 2073 6572 7669 6365 5f6e  : str, service_n
-00021a20: 616d 653a 2073 7472 2c20 7072 6f74 6f63  ame: str, protoc
-00021a30: 6f6c 3a20 626f 6f6c 203d 2046 616c 7365  ol: bool = False
-00021a40: 0a20 2020 2029 202d 3e20 7475 706c 655b  .    ) -> tuple[
-00021a50: 7374 722c 2069 6e74 5d20 7c20 7374 7220  str, int] | str 
-00021a60: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
-00021a70: 2222 220a 2020 2020 2020 2020 4765 7420  """.        Get 
-00021a80: 7468 6520 2868 6f73 742c 2070 6f72 7429  the (host, port)
-00021a90: 2061 6464 7265 7373 206f 6620 7468 6520   address of the 
-00021aa0: 6e61 6d65 6420 7365 7276 6963 6520 6f6e  named service on
-00021ab0: 2074 6865 202a 776f 726b 6572 2a2e 0a20   the *worker*.. 
-00021ac0: 2020 2020 2020 2052 6574 7572 6e73 204e         Returns N
-00021ad0: 6f6e 6520 6966 2074 6865 2073 6572 7669  one if the servi
-00021ae0: 6365 2064 6f65 736e 2774 2065 7869 7374  ce doesn't exist
-00021af0: 2e0a 0a20 2020 2020 2020 2050 6172 616d  ...        Param
-00021b00: 6574 6572 730a 2020 2020 2020 2020 2d2d  eters.        --
-00021b10: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00021b20: 2077 6f72 6b65 7220 3a20 6164 6472 6573   worker : addres
-00021b30: 730a 2020 2020 2020 2020 7365 7276 6963  s.        servic
-00021b40: 655f 6e61 6d65 203a 2073 7472 0a20 2020  e_name : str.   
-00021b50: 2020 2020 2020 2020 2043 6f6d 6d6f 6e20           Common 
-00021b60: 7365 7276 6963 6573 2069 6e63 6c75 6465  services include
-00021b70: 2027 626f 6b65 6827 2061 6e64 2027 6e61   'bokeh' and 'na
-00021b80: 6e6e 7927 0a20 2020 2020 2020 2070 726f  nny'.        pro
-00021b90: 746f 636f 6c20 3a20 626f 6f6c 6561 6e0a  tocol : boolean.
-00021ba0: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
-00021bb0: 6865 7220 6f72 206e 6f74 2074 6f20 696e  her or not to in
-00021bc0: 636c 7564 6520 6120 6675 6c6c 2061 6464  clude a full add
-00021bd0: 7265 7373 2077 6974 6820 7072 6f74 6f63  ress with protoc
-00021be0: 6f6c 2028 5472 7565 290a 2020 2020 2020  ol (True).      
-00021bf0: 2020 2020 2020 6f72 206a 7573 7420 6120        or just a 
-00021c00: 2868 6f73 742c 2070 6f72 7429 2070 6169  (host, port) pai
-00021c10: 720a 2020 2020 2020 2020 2222 220a 2020  r.        """.  
-00021c20: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00021c30: 776f 726b 6572 735b 776f 726b 6572 5d0a  workers[worker].
-00021c40: 2020 2020 2020 2020 706f 7274 203d 2077          port = w
-00021c50: 732e 7365 7276 6963 6573 2e67 6574 2873  s.services.get(s
-00021c60: 6572 7669 6365 5f6e 616d 6529 0a20 2020  ervice_name).   
-00021c70: 2020 2020 2069 6620 706f 7274 2069 7320       if port is 
-00021c80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00021c90: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-00021ca0: 2020 2020 2020 656c 6966 2070 726f 746f        elif proto
-00021cb0: 636f 6c3a 0a20 2020 2020 2020 2020 2020  col:.           
-00021cc0: 2072 6574 7572 6e20 2225 2870 726f 746f   return "%(proto
-00021cd0: 636f 6c29 733a 2f2f 2528 686f 7374 2973  col)s://%(host)s
-00021ce0: 3a25 2870 6f72 7429 6422 2025 207b 0a20  :%(port)d" % {. 
-00021cf0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00021d00: 7072 6f74 6f63 6f6c 223a 2077 732e 6164  protocol": ws.ad
-00021d10: 6472 6573 732e 7370 6c69 7428 223a 2f2f  dress.split("://
-00021d20: 2229 5b30 5d2c 0a20 2020 2020 2020 2020  ")[0],.         
-00021d30: 2020 2020 2020 2022 686f 7374 223a 2077         "host": w
-00021d40: 732e 686f 7374 2c0a 2020 2020 2020 2020  s.host,.        
-00021d50: 2020 2020 2020 2020 2270 6f72 7422 3a20          "port": 
-00021d60: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
-00021d70: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
-00021d80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00021d90: 7475 726e 2077 732e 686f 7374 2c20 706f  turn ws.host, po
-00021da0: 7274 0a0a 2020 2020 6173 796e 6320 6465  rt..    async de
-00021db0: 6620 7374 6172 745f 756e 7361 6665 2873  f start_unsafe(s
-00021dc0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00021dd0: 2243 6c65 6172 206f 7574 206f 6c64 2073  "Clear out old s
-00021de0: 7461 7465 2061 6e64 2072 6573 7461 7274  tate and restart
-00021df0: 2061 6c6c 2072 756e 6e69 6e67 2063 6f72   all running cor
-00021e00: 6f75 7469 6e65 7322 2222 0a20 2020 2020  outines""".     
-00021e10: 2020 2061 7761 6974 2073 7570 6572 2829     await super()
-00021e20: 2e73 7461 7274 5f75 6e73 6166 6528 290a  .start_unsafe().
-00021e30: 0a20 2020 2020 2020 2065 6e61 626c 655f  .        enable_
-00021e40: 6763 5f64 6961 676e 6f73 6973 2829 0a0a  gc_diagnosis()..
-00021e50: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
-00021e60: 6561 725f 7461 736b 5f73 7461 7465 2829  ear_task_state()
-00021e70: 0a0a 2020 2020 2020 2020 666f 7220 6164  ..        for ad
-00021e80: 6472 2069 6e20 7365 6c66 2e5f 7374 6172  dr in self._star
-00021e90: 745f 6164 6472 6573 733a 0a20 2020 2020  t_address:.     
-00021ea0: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00021eb0: 662e 6c69 7374 656e 280a 2020 2020 2020  f.listen(.      
-00021ec0: 2020 2020 2020 2020 2020 6164 6472 2c0a            addr,.
-00021ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021ee0: 616c 6c6f 775f 6f66 666c 6f61 643d 4661  allow_offload=Fa
-00021ef0: 6c73 652c 0a20 2020 2020 2020 2020 2020  lse,.           
-00021f00: 2020 2020 2068 616e 6473 6861 6b65 5f6f       handshake_o
-00021f10: 7665 7272 6964 6573 3d7b 2270 6963 6b6c  verrides={"pickl
-00021f20: 652d 7072 6f74 6f63 6f6c 223a 2034 2c20  e-protocol": 4, 
-00021f30: 2263 6f6d 7072 6573 7369 6f6e 223a 204e  "compression": N
-00021f40: 6f6e 657d 2c0a 2020 2020 2020 2020 2020  one},.          
-00021f50: 2020 2020 2020 2a2a 7365 6c66 2e73 6563        **self.sec
-00021f60: 7572 6974 792e 6765 745f 6c69 7374 656e  urity.get_listen
-00021f70: 5f61 7267 7328 2273 6368 6564 756c 6572  _args("scheduler
-00021f80: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00021f90: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00021fa0: 6c66 2e69 7020 3d20 6765 745f 6164 6472  lf.ip = get_addr
-00021fb0: 6573 735f 686f 7374 2873 656c 662e 6c69  ess_host(self.li
-00021fc0: 7374 656e 5f61 6464 7265 7373 290a 2020  sten_address).  
-00021fd0: 2020 2020 2020 2020 2020 6c69 7374 656e            listen
-00021fe0: 5f69 7020 3d20 7365 6c66 2e69 700a 0a20  _ip = self.ip.. 
-00021ff0: 2020 2020 2020 2020 2020 2069 6620 6c69             if li
-00022000: 7374 656e 5f69 7020 3d3d 2022 302e 302e  sten_ip == "0.0.
-00022010: 302e 3022 3a0a 2020 2020 2020 2020 2020  0.0":.          
-00022020: 2020 2020 2020 6c69 7374 656e 5f69 7020        listen_ip 
-00022030: 3d20 2222 0a0a 2020 2020 2020 2020 6966  = ""..        if
-00022040: 2073 656c 662e 6164 6472 6573 732e 7374   self.address.st
-00022050: 6172 7473 7769 7468 2822 696e 7072 6f63  artswith("inproc
-00022060: 3a2f 2f22 293a 0a20 2020 2020 2020 2020  ://"):.         
-00022070: 2020 206c 6973 7465 6e5f 6970 203d 2022     listen_ip = "
-00022080: 6c6f 6361 6c68 6f73 7422 0a0a 2020 2020  localhost"..    
-00022090: 2020 2020 2320 5365 7276 6963 6573 206c      # Services l
-000220a0: 6973 7465 6e20 6f6e 2061 6c6c 2061 6464  isten on all add
-000220b0: 7265 7373 6573 0a20 2020 2020 2020 2073  resses.        s
-000220c0: 656c 662e 7374 6172 745f 7365 7276 6963  elf.start_servic
-000220d0: 6573 286c 6973 7465 6e5f 6970 290a 0a20  es(listen_ip).. 
-000220e0: 2020 2020 2020 2066 6f72 206c 6973 7465         for liste
-000220f0: 6e65 7220 696e 2073 656c 662e 6c69 7374  ner in self.list
-00022100: 656e 6572 733a 0a20 2020 2020 2020 2020  eners:.         
-00022110: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-00022120: 2020 5363 6865 6475 6c65 7220 6174 3a20    Scheduler at: 
-00022130: 2532 3573 222c 206c 6973 7465 6e65 722e  %25s", listener.
-00022140: 636f 6e74 6163 745f 6164 6472 6573 7329  contact_address)
-00022150: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
-00022160: 652c 2073 6572 7665 7220 696e 2073 656c  e, server in sel
-00022170: 662e 7365 7276 6963 6573 2e69 7465 6d73  f.services.items
-00022180: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00022190: 6966 206e 616d 6520 3d3d 2022 6461 7368  if name == "dash
-000221a0: 626f 6172 6422 3a0a 2020 2020 2020 2020  board":.        
-000221b0: 2020 2020 2020 2020 6164 6472 203d 2067          addr = g
-000221c0: 6574 5f61 6464 7265 7373 5f68 6f73 7428  et_address_host(
-000221d0: 6c69 7374 656e 6572 2e63 6f6e 7461 6374  listener.contact
-000221e0: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
-000221f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00022200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022210: 2020 206c 696e 6b20 3d20 666f 726d 6174     link = format
-00022220: 5f64 6173 6862 6f61 7264 5f6c 696e 6b28  _dashboard_link(
-00022230: 6164 6472 2c20 7365 7276 6572 2e70 6f72  addr, server.por
-00022240: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00022250: 2020 2023 2066 6f72 6d61 7474 696e 6720     # formatting 
-00022260: 6461 7368 626f 6172 6420 6c69 6e6b 2063  dashboard link c
-00022270: 616e 2066 6169 6c20 6966 2064 6973 7472  an fail if distr
-00022280: 6962 7574 6564 2e64 6173 6862 6f61 7264  ibuted.dashboard
-00022290: 2e6c 696e 6b0a 2020 2020 2020 2020 2020  .link.          
-000222a0: 2020 2020 2020 2320 7265 6665 7273 2074        # refers t
-000222b0: 6f20 6e6f 6e2d 6578 6973 7461 6e74 2065  o non-existant e
-000222c0: 6e76 2076 6172 732e 0a20 2020 2020 2020  nv vars..       
-000222d0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-000222e0: 4b65 7945 7272 6f72 2061 7320 653a 0a20  KeyError as e:. 
-000222f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022300: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
-00022310: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00022320: 2020 2020 2020 2020 2020 2066 2246 6169             f"Fai
-00022330: 6c65 6420 746f 2066 6f72 6d61 7420 6461  led to format da
-00022340: 7368 626f 6172 6420 6c69 6e6b 2c20 756e  shboard link, un
-00022350: 6b6e 6f77 6e20 7661 6c75 653a 207b 657d  known value: {e}
-00022360: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00022370: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00022380: 2020 2020 2020 2020 2020 2020 6c69 6e6b              link
-00022390: 203d 2066 223a 7b73 6572 7665 722e 706f   = f":{server.po
-000223a0: 7274 7d22 0a20 2020 2020 2020 2020 2020  rt}".           
-000223b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000223c0: 2020 2020 2020 206c 696e 6b20 3d20 6622         link = f"
-000223d0: 7b6c 6973 7465 6e5f 6970 7d3a 7b73 6572  {listen_ip}:{ser
-000223e0: 7665 722e 706f 7274 7d22 0a20 2020 2020  ver.port}".     
-000223f0: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-00022400: 666f 2822 2531 3173 2061 743a 2020 2532  fo("%11s at:  %2
-00022410: 3573 222c 206e 616d 652c 206c 696e 6b29  5s", name, link)
-00022420: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00022430: 662e 7363 6865 6475 6c65 725f 6669 6c65  f.scheduler_file
-00022440: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
-00022450: 7468 206f 7065 6e28 7365 6c66 2e73 6368  th open(self.sch
-00022460: 6564 756c 6572 5f66 696c 652c 2022 7722  eduler_file, "w"
-00022470: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00022480: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-00022490: 7028 7365 6c66 2e69 6465 6e74 6974 7928  p(self.identity(
-000224a0: 292c 2066 2c20 696e 6465 6e74 3d32 290a  ), f, indent=2).
-000224b0: 0a20 2020 2020 2020 2020 2020 2066 6e20  .            fn 
-000224c0: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-000224d0: 5f66 696c 6520 2023 2072 656d 6f76 6520  _file  # remove 
-000224e0: 6669 6c65 2077 6865 6e20 7765 2063 6c6f  file when we clo
-000224f0: 7365 2074 6865 2070 726f 6365 7373 0a0a  se the process..
-00022500: 2020 2020 2020 2020 2020 2020 6465 6620              def 
-00022510: 6465 6c5f 7363 6865 6475 6c65 725f 6669  del_scheduler_fi
-00022520: 6c65 2829 3a0a 2020 2020 2020 2020 2020  le():.          
-00022530: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-00022540: 2e65 7869 7374 7328 666e 293a 0a20 2020  .exists(fn):.   
-00022550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022560: 206f 732e 7265 6d6f 7665 2866 6e29 0a0a   os.remove(fn)..
-00022570: 2020 2020 2020 2020 2020 2020 7765 616b              weak
-00022580: 7265 662e 6669 6e61 6c69 7a65 2873 656c  ref.finalize(sel
-00022590: 662c 2064 656c 5f73 6368 6564 756c 6572  f, del_scheduler
-000225a0: 5f66 696c 6529 0a0a 2020 2020 2020 2020  _file)..        
-000225b0: 666f 7220 7072 656c 6f61 6420 696e 2073  for preload in s
-000225c0: 656c 662e 7072 656c 6f61 6473 3a0a 2020  elf.preloads:.  
-000225d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-000225e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000225f0: 7761 6974 2070 7265 6c6f 6164 2e73 7461  wait preload.sta
-00022600: 7274 2829 0a20 2020 2020 2020 2020 2020  rt().           
-00022610: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00022620: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-00022630: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
-00022640: 696f 6e28 2246 6169 6c65 6420 746f 2073  ion("Failed to s
-00022650: 7461 7274 2070 7265 6c6f 6164 2229 0a0a  tart preload")..
-00022660: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00022670: 6a75 7079 7465 723a 0a20 2020 2020 2020  jupyter:.       
-00022680: 2020 2020 2023 2041 6c6c 6f77 2069 6e73       # Allow ins
-00022690: 6563 7572 6520 636f 6d6d 756e 6963 6174  ecure communicat
-000226a0: 696f 6e73 2066 726f 6d20 6c6f 6361 6c20  ions from local 
-000226b0: 7573 6572 730a 2020 2020 2020 2020 2020  users.          
-000226c0: 2020 6966 2073 656c 662e 6164 6472 6573    if self.addres
-000226d0: 732e 7374 6172 7473 7769 7468 2822 746c  s.startswith("tl
-000226e0: 733a 2f2f 2229 3a0a 2020 2020 2020 2020  s://"):.        
-000226f0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00022700: 6c66 2e6c 6973 7465 6e28 2274 6370 3a2f  lf.listen("tcp:/
-00022710: 2f6c 6f63 616c 686f 7374 3a30 2229 0a20  /localhost:0"). 
-00022720: 2020 2020 2020 2020 2020 206f 732e 656e             os.en
-00022730: 7669 726f 6e5b 2244 4153 4b5f 5343 4845  viron["DASK_SCHE
-00022740: 4455 4c45 525f 4144 4452 4553 5322 5d20  DULER_ADDRESS"] 
-00022750: 3d20 7365 6c66 2e6c 6973 7465 6e65 7273  = self.listeners
-00022760: 5b2d 315d 2e63 6f6e 7461 6374 5f61 6464  [-1].contact_add
-00022770: 7265 7373 0a0a 2020 2020 2020 2020 6177  ress..        aw
-00022780: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-00022790: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-000227a0: 2a5b 706c 7567 696e 2e73 7461 7274 2873  *[plugin.start(s
-000227b0: 656c 6629 2066 6f72 2070 6c75 6769 6e20  elf) for plugin 
-000227c0: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
-000227d0: 6769 6e73 2e76 616c 7565 7328 2929 5d0a  gins.values())].
-000227e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000227f0: 2020 2073 656c 662e 7374 6172 745f 7065     self.start_pe
-00022800: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
-00022810: 2829 0a0a 2020 2020 2020 2020 7365 7470  ()..        setp
-00022820: 726f 6374 6974 6c65 2866 2264 6173 6b20  roctitle(f"dask 
-00022830: 7363 6865 6475 6c65 7220 5b7b 7365 6c66  scheduler [{self
-00022840: 2e61 6464 7265 7373 7d5d 2229 0a20 2020  .address}]").   
-00022850: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00022860: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00022870: 636c 6f73 6528 7365 6c66 2c20 6661 7374  close(self, fast
-00022880: 3d4e 6f6e 652c 2063 6c6f 7365 5f77 6f72  =None, close_wor
-00022890: 6b65 7273 3d4e 6f6e 6529 3a0a 2020 2020  kers=None):.    
-000228a0: 2020 2020 2222 2253 656e 6420 636c 6561      """Send clea
-000228b0: 6e75 7020 7369 676e 616c 2074 6f20 616c  nup signal to al
-000228c0: 6c20 636f 726f 7574 696e 6573 2074 6865  l coroutines the
-000228d0: 6e20 7761 6974 2075 6e74 696c 2066 696e  n wait until fin
-000228e0: 6973 6865 640a 0a20 2020 2020 2020 2053  ished..        S
-000228f0: 6565 2041 6c73 6f0a 2020 2020 2020 2020  ee Also.        
-00022900: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-00022910: 2053 6368 6564 756c 6572 2e63 6c65 616e   Scheduler.clean
-00022920: 7570 0a20 2020 2020 2020 2022 2222 0a20  up.        """. 
-00022930: 2020 2020 2020 2069 6620 6661 7374 2069         if fast i
-00022940: 7320 6e6f 7420 4e6f 6e65 206f 7220 636c  s not None or cl
-00022950: 6f73 655f 776f 726b 6572 7320 6973 206e  ose_workers is n
-00022960: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00022970: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-00022980: 726e 280a 2020 2020 2020 2020 2020 2020  rn(.            
-00022990: 2020 2020 2254 6865 2027 6661 7374 2720      "The 'fast' 
-000229a0: 616e 6420 2763 6c6f 7365 5f77 6f72 6b65  and 'close_worke
-000229b0: 7273 2720 7061 7261 6d65 7465 7273 2069  rs' parameters i
-000229c0: 6e20 5363 6865 6475 6c65 722e 636c 6f73  n Scheduler.clos
-000229d0: 6520 6861 7665 206e 6f20 6566 6665 6374  e have no effect
-000229e0: 2061 6e64 2077 696c 6c20 6265 2072 656d   and will be rem
-000229f0: 6f76 6564 2069 6e20 6120 6675 7475 7265  oved in a future
-00022a00: 2076 6572 7369 6f6e 206f 6620 6469 7374   version of dist
-00022a10: 7269 6275 7465 642e 222c 0a20 2020 2020  ributed.",.     
-00022a20: 2020 2020 2020 2020 2020 2046 7574 7572             Futur
-00022a30: 6557 6172 6e69 6e67 2c0a 2020 2020 2020  eWarning,.      
-00022a40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00022a50: 6966 2073 656c 662e 7374 6174 7573 2069  if self.status i
-00022a60: 6e20 2853 7461 7475 732e 636c 6f73 696e  n (Status.closin
-00022a70: 672c 2053 7461 7475 732e 636c 6f73 6564  g, Status.closed
-00022a80: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-00022a90: 7761 6974 2073 656c 662e 6669 6e69 7368  wait self.finish
-00022aa0: 6564 2829 0a20 2020 2020 2020 2020 2020  ed().           
-00022ab0: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-00022ac0: 2061 7379 6e63 2064 6566 206c 6f67 5f65   async def log_e
-00022ad0: 7272 6f72 7328 6675 6e63 293a 0a20 2020  rrors(func):.   
-00022ae0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00022af0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-00022b00: 6169 7420 6675 6e63 2829 0a20 2020 2020  ait func().     
-00022b10: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-00022b20: 6365 7074 696f 6e3a 0a20 2020 2020 2020  ception:.       
-00022b30: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00022b40: 6578 6365 7074 696f 6e28 2250 6c75 6769  exception("Plugi
-00022b50: 6e20 6361 6c6c 2066 6169 6c65 6420 6475  n call failed du
-00022b60: 7269 6e67 2073 6368 6564 756c 6572 2e63  ring scheduler.c
-00022b70: 6c6f 7365 2229 0a0a 2020 2020 2020 2020  lose")..        
-00022b80: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00022b90: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-00022ba0: 2020 2a5b 6c6f 675f 6572 726f 7273 2870    *[log_errors(p
-00022bb0: 6c75 6769 6e2e 6265 666f 7265 5f63 6c6f  lugin.before_clo
-00022bc0: 7365 2920 666f 7220 706c 7567 696e 2069  se) for plugin i
-00022bd0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-00022be0: 696e 732e 7661 6c75 6573 2829 295d 0a20  ins.values())]. 
-00022bf0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00022c00: 2020 7365 6c66 2e73 7461 7475 7320 3d20    self.status = 
-00022c10: 5374 6174 7573 2e63 6c6f 7369 6e67 0a0a  Status.closing..
-00022c20: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00022c30: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
-00022c40: 6c6f 7369 6e67 2e2e 2e22 290a 2020 2020  losing...").    
-00022c50: 2020 2020 7365 7470 726f 6374 6974 6c65      setproctitle
-00022c60: 2822 6461 736b 2073 6368 6564 756c 6572  ("dask scheduler
-00022c70: 205b 636c 6f73 696e 675d 2229 0a0a 2020   [closing]")..  
-00022c80: 2020 2020 2020 666f 7220 7072 656c 6f61        for preloa
-00022c90: 6420 696e 2073 656c 662e 7072 656c 6f61  d in self.preloa
-00022ca0: 6473 3a0a 2020 2020 2020 2020 2020 2020  ds:.            
-00022cb0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00022cc0: 2020 2020 2061 7761 6974 2070 7265 6c6f       await prelo
-00022cd0: 6164 2e74 6561 7264 6f77 6e28 290a 2020  ad.teardown().  
-00022ce0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00022cf0: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
-00022d00: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00022d10: 6572 2e65 7863 6570 7469 6f6e 2822 4661  er.exception("Fa
-00022d20: 696c 6564 2074 6f20 7465 6172 2064 6f77  iled to tear dow
-00022d30: 6e20 7072 656c 6f61 6422 290a 0a20 2020  n preload")..   
-00022d40: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00022d50: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00022d60: 2020 2020 2020 202a 5b6c 6f67 5f65 7272         *[log_err
-00022d70: 6f72 7328 706c 7567 696e 2e63 6c6f 7365  ors(plugin.close
-00022d80: 2920 666f 7220 706c 7567 696e 2069 6e20  ) for plugin in 
-00022d90: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00022da0: 732e 7661 6c75 6573 2829 295d 0a20 2020  s.values())].   
-00022db0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00022dc0: 666f 7220 7063 2069 6e20 7365 6c66 2e70  for pc in self.p
-00022dd0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00022de0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
-00022df0: 2020 2020 2020 2020 7063 2e73 746f 7028          pc.stop(
-00022e00: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
-00022e10: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00022e20: 732e 636c 6561 7228 290a 0a20 2020 2020  s.clear()..     
-00022e30: 2020 2073 656c 662e 7374 6f70 5f73 6572     self.stop_ser
-00022e40: 7669 6365 7328 290a 0a20 2020 2020 2020  vices()..       
-00022e50: 2066 6f72 2065 7874 2069 6e20 7365 6c66   for ext in self
-00022e60: 2e65 7874 656e 7369 6f6e 732e 7661 6c75  .extensions.valu
-00022e70: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00022e80: 2020 7769 7468 2073 7570 7072 6573 7328    with suppress(
-00022e90: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
-00022ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022eb0: 2065 7874 2e74 6561 7264 6f77 6e28 290a   ext.teardown().
-00022ec0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00022ed0: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
-00022ee0: 6c6f 7369 6e67 2061 6c6c 2063 6f6d 6d73  losing all comms
-00022ef0: 2229 0a0a 2020 2020 2020 2020 6675 7475  ")..        futu
-00022f00: 7265 7320 3d20 5b5d 0a20 2020 2020 2020  res = [].       
-00022f10: 2066 6f72 205f 2c20 636f 6d6d 2069 6e20   for _, comm in 
-00022f20: 6c69 7374 2873 656c 662e 7374 7265 616d  list(self.stream
-00022f30: 5f63 6f6d 6d73 2e69 7465 6d73 2829 293a  _comms.items()):
-00022f40: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-00022f50: 4958 4d45 2075 7365 2060 7365 6c66 2e72  IXME use `self.r
-00022f60: 656d 6f76 655f 776f 726b 6572 2829 6020  emove_worker()` 
-00022f70: 696e 7374 6561 6420 6166 7465 7220 6874  instead after ht
-00022f80: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
-00022f90: 2f64 6173 6b2f 6469 7374 7269 6275 7465  /dask/distribute
-00022fa0: 642f 6973 7375 6573 2f36 3339 300a 2020  d/issues/6390.  
-00022fb0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00022fc0: 2063 6f6d 6d2e 636c 6f73 6564 2829 3a0a   comm.closed():.
-00022fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022fe0: 2320 5468 6973 2063 6c6f 7365 7320 7468  # This closes th
-00022ff0: 6520 576f 726b 6572 2061 6e64 2065 6e73  e Worker and ens
-00023000: 7572 6573 2074 6861 7420 6966 2061 204e  ures that if a N
-00023010: 616e 6e79 2069 7320 6172 6f75 6e64 2c0a  anny is around,.
-00023020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023030: 2320 6974 2069 7320 636c 6f73 6564 2061  # it is closed a
-00023040: 7320 7765 6c6c 0a20 2020 2020 2020 2020  s well.         
-00023050: 2020 2020 2020 2063 6f6d 6d2e 7365 6e64         comm.send
-00023060: 287b 226f 7022 3a20 2263 6c6f 7365 222c  ({"op": "close",
-00023070: 2022 7265 6173 6f6e 223a 2022 7363 6865   "reason": "sche
-00023080: 6475 6c65 722d 636c 6f73 6522 7d29 0a20  duler-close"}). 
-00023090: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000230a0: 6f6d 6d2e 7365 6e64 287b 226f 7022 3a20  omm.send({"op": 
-000230b0: 2263 6c6f 7365 2d73 7472 6561 6d22 7d29  "close-stream"})
-000230c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000230d0: 2023 205e 2054 4f44 4f20 7265 6d6f 7665   # ^ TODO remove
-000230e0: 3f20 6057 6f72 6b65 722e 636c 6f73 6560  ? `Worker.close`
-000230f0: 2077 696c 6c20 636c 6f73 6520 7468 6520   will close the 
-00023100: 7374 7265 616d 2061 6e79 7761 792e 0a20  stream anyway.. 
-00023110: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00023120: 7375 7070 7265 7373 2841 7474 7269 6275  suppress(Attribu
-00023130: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
-00023140: 2020 2020 2020 2020 2020 6675 7475 7265            future
-00023150: 732e 6170 7065 6e64 2863 6f6d 6d2e 636c  s.append(comm.cl
-00023160: 6f73 6528 2929 0a0a 2020 2020 2020 2020  ose())..        
-00023170: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-00023180: 7468 6572 282a 6675 7475 7265 7329 0a0a  ther(*futures)..
-00023190: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000231a0: 6a75 7079 7465 723a 0a20 2020 2020 2020  jupyter:.       
-000231b0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-000231c0: 5f6a 7570 7974 6572 5f73 6572 7665 725f  _jupyter_server_
-000231d0: 6170 706c 6963 6174 696f 6e2e 5f63 6c65  application._cle
-000231e0: 616e 7570 2829 0a0a 2020 2020 2020 2020  anup()..        
-000231f0: 666f 7220 636f 6d6d 2069 6e20 7365 6c66  for comm in self
-00023200: 2e63 6c69 656e 745f 636f 6d6d 732e 7661  .client_comms.va
-00023210: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00023220: 2020 2020 636f 6d6d 2e61 626f 7274 2829      comm.abort()
-00023230: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00023240: 7365 6c66 2e72 7063 2e63 6c6f 7365 2829  self.rpc.close()
-00023250: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-00023260: 7461 7475 7320 3d20 5374 6174 7573 2e63  tatus = Status.c
-00023270: 6c6f 7365 640a 2020 2020 2020 2020 7365  losed.        se
-00023280: 6c66 2e73 746f 7028 290a 2020 2020 2020  lf.stop().      
-00023290: 2020 6177 6169 7420 7375 7065 7228 292e    await super().
-000232a0: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
-000232b0: 2073 6574 7072 6f63 7469 746c 6528 2264   setproctitle("d
-000232c0: 6173 6b20 7363 6865 6475 6c65 7220 5b63  ask scheduler [c
-000232d0: 6c6f 7365 645d 2229 0a20 2020 2020 2020  losed]").       
-000232e0: 2064 6973 6162 6c65 5f67 635f 6469 6167   disable_gc_diag
-000232f0: 6e6f 7369 7328 290a 0a20 2020 2023 2323  nosis()..    ###
-00023300: 2323 2323 2323 2323 0a20 2020 2023 2053  ########.    # S
-00023310: 7469 6d75 6c69 2023 0a20 2020 2023 2323  timuli #.    ###
-00023320: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
-00023330: 6620 6865 6172 7462 6561 745f 776f 726b  f heartbeat_work
-00023340: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
-00023350: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-00023360: 2020 2020 2061 6464 7265 7373 3a20 7374       address: st
-00023370: 722c 0a20 2020 2020 2020 2072 6573 6f6c  r,.        resol
-00023380: 7665 5f61 6464 7265 7373 3a20 626f 6f6c  ve_address: bool
-00023390: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
-000233a0: 206e 6f77 3a20 666c 6f61 7420 7c20 4e6f   now: float | No
-000233b0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-000233c0: 2020 2072 6573 6f75 7263 6573 3a20 6469     resources: di
-000233d0: 6374 5b73 7472 2c20 666c 6f61 745d 207c  ct[str, float] |
-000233e0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000233f0: 2020 2020 2020 686f 7374 5f69 6e66 6f3a        host_info:
-00023400: 2064 6963 7420 7c20 4e6f 6e65 203d 204e   dict | None = N
-00023410: 6f6e 652c 0a20 2020 2020 2020 206d 6574  one,.        met
-00023420: 7269 6373 3a20 6469 6374 2c0a 2020 2020  rics: dict,.    
-00023430: 2020 2020 6578 6563 7574 696e 673a 2064      executing: d
-00023440: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
-00023450: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00023460: 2020 2020 2020 2065 7874 656e 7369 6f6e         extension
-00023470: 733a 2064 6963 7420 7c20 4e6f 6e65 203d  s: dict | None =
-00023480: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-00023490: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-000234a0: 2020 2020 2020 2020 6164 6472 6573 7320          address 
-000234b0: 3d20 7365 6c66 2e63 6f65 7263 655f 6164  = self.coerce_ad
-000234c0: 6472 6573 7328 6164 6472 6573 732c 2072  dress(address, r
-000234d0: 6573 6f6c 7665 5f61 6464 7265 7373 290a  esolve_address).
-000234e0: 2020 2020 2020 2020 6164 6472 6573 7320          address 
-000234f0: 3d20 6e6f 726d 616c 697a 655f 6164 6472  = normalize_addr
-00023500: 6573 7328 6164 6472 6573 7329 0a20 2020  ess(address).   
-00023510: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
-00023520: 6f72 6b65 7273 2e67 6574 2861 6464 7265  orkers.get(addre
-00023530: 7373 290a 2020 2020 2020 2020 6966 2077  ss).        if w
-00023540: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00023550: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
-00023560: 726e 696e 6728 6622 5265 6365 6976 6564  rning(f"Received
-00023570: 2068 6561 7274 6265 6174 2066 726f 6d20   heartbeat from 
-00023580: 756e 7265 6769 7374 6572 6564 2077 6f72  unregistered wor
-00023590: 6b65 7220 7b61 6464 7265 7373 2172 7d2e  ker {address!r}.
-000235a0: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-000235b0: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
-000235c0: 2022 6d69 7373 696e 6722 7d0a 0a20 2020   "missing"}..   
-000235d0: 2020 2020 2068 6f73 7420 3d20 6765 745f       host = get_
-000235e0: 6164 6472 6573 735f 686f 7374 2861 6464  address_host(add
-000235f0: 7265 7373 290a 2020 2020 2020 2020 6c6f  ress).        lo
-00023600: 6361 6c5f 6e6f 7720 3d20 7469 6d65 2829  cal_now = time()
-00023610: 0a20 2020 2020 2020 2068 6f73 745f 696e  .        host_in
-00023620: 666f 203d 2068 6f73 745f 696e 666f 206f  fo = host_info o
-00023630: 7220 7b7d 0a0a 2020 2020 2020 2020 6468  r {}..        dh
-00023640: 3a20 6469 6374 203d 2073 656c 662e 686f  : dict = self.ho
-00023650: 7374 5f69 6e66 6f2e 7365 7464 6566 6175  st_info.setdefau
-00023660: 6c74 2868 6f73 742c 207b 7d29 0a20 2020  lt(host, {}).   
-00023670: 2020 2020 2064 685b 226c 6173 742d 7365       dh["last-se
-00023680: 656e 225d 203d 206c 6f63 616c 5f6e 6f77  en"] = local_now
-00023690: 0a0a 2020 2020 2020 2020 6672 6163 203d  ..        frac =
-000236a0: 2031 202f 206c 656e 2873 656c 662e 776f   1 / len(self.wo
-000236b0: 726b 6572 7329 0a20 2020 2020 2020 2073  rkers).        s
-000236c0: 656c 662e 6261 6e64 7769 6474 6820 3d20  elf.bandwidth = 
-000236d0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
-000236e0: 6c66 2e62 616e 6477 6964 7468 202a 2028  lf.bandwidth * (
-000236f0: 3120 2d20 6672 6163 2920 2b20 6d65 7472  1 - frac) + metr
-00023700: 6963 735b 2262 616e 6477 6964 7468 225d  ics["bandwidth"]
-00023710: 5b22 746f 7461 6c22 5d20 2a20 6672 6163  ["total"] * frac
-00023720: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00023730: 2020 2066 6f72 206f 7468 6572 2c20 2862     for other, (b
-00023740: 772c 2063 6f75 6e74 2920 696e 206d 6574  w, count) in met
-00023750: 7269 6373 5b22 6261 6e64 7769 6474 6822  rics["bandwidth"
-00023760: 5d5b 2277 6f72 6b65 7273 225d 2e69 7465  ]["workers"].ite
-00023770: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00023780: 2020 6966 2028 6164 6472 6573 732c 206f    if (address, o
-00023790: 7468 6572 2920 6e6f 7420 696e 2073 656c  ther) not in sel
-000237a0: 662e 6261 6e64 7769 6474 685f 776f 726b  f.bandwidth_work
-000237b0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000237c0: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-000237d0: 6474 685f 776f 726b 6572 735b 6164 6472  dth_workers[addr
-000237e0: 6573 732c 206f 7468 6572 5d20 3d20 6277  ess, other] = bw
-000237f0: 202f 2063 6f75 6e74 0a20 2020 2020 2020   / count.       
-00023800: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00023810: 2020 2020 2020 2020 2020 2061 6c70 6861             alpha
-00023820: 203d 2028 3120 2d20 6672 6163 2920 2a2a   = (1 - frac) **
-00023830: 2063 6f75 6e74 0a20 2020 2020 2020 2020   count.         
-00023840: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
-00023850: 7769 6474 685f 776f 726b 6572 735b 6164  width_workers[ad
-00023860: 6472 6573 732c 206f 7468 6572 5d20 3d20  dress, other] = 
-00023870: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
-00023880: 6f72 6b65 7273 5b0a 2020 2020 2020 2020  orkers[.        
-00023890: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-000238a0: 6573 732c 206f 7468 6572 0a20 2020 2020  ess, other.     
-000238b0: 2020 2020 2020 2020 2020 205d 202a 2061             ] * a
-000238c0: 6c70 6861 202b 2062 7720 2a20 2831 202d  lpha + bw * (1 -
-000238d0: 2061 6c70 6861 290a 2020 2020 2020 2020   alpha).        
-000238e0: 666f 7220 7479 702c 2028 6277 2c20 636f  for typ, (bw, co
-000238f0: 756e 7429 2069 6e20 6d65 7472 6963 735b  unt) in metrics[
-00023900: 2262 616e 6477 6964 7468 225d 5b22 7479  "bandwidth"]["ty
-00023910: 7065 7322 5d2e 6974 656d 7328 293a 0a20  pes"].items():. 
-00023920: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
-00023930: 7020 6e6f 7420 696e 2073 656c 662e 6261  p not in self.ba
-00023940: 6e64 7769 6474 685f 7479 7065 733a 0a20  ndwidth_types:. 
-00023950: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00023960: 656c 662e 6261 6e64 7769 6474 685f 7479  elf.bandwidth_ty
-00023970: 7065 735b 7479 705d 203d 2062 7720 2f20  pes[typ] = bw / 
-00023980: 636f 756e 740a 2020 2020 2020 2020 2020  count.          
-00023990: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000239a0: 2020 2020 2020 2020 616c 7068 6120 3d20          alpha = 
-000239b0: 2831 202d 2066 7261 6329 202a 2a20 636f  (1 - frac) ** co
-000239c0: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
-000239d0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-000239e0: 7468 5f74 7970 6573 5b74 7970 5d20 3d20  th_types[typ] = 
-000239f0: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
-00023a00: 7970 6573 5b74 7970 5d20 2a20 616c 7068  ypes[typ] * alph
-00023a10: 6120 2b20 6277 202a 2028 0a20 2020 2020  a + bw * (.     
-00023a20: 2020 2020 2020 2020 2020 2020 2020 2031                 1
-00023a30: 202d 2061 6c70 6861 0a20 2020 2020 2020   - alpha.       
-00023a40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00023a50: 2020 2020 7773 2e6c 6173 745f 7365 656e      ws.last_seen
-00023a60: 203d 206c 6f63 616c 5f6e 6f77 0a20 2020   = local_now.   
-00023a70: 2020 2020 2069 6620 6578 6563 7574 696e       if executin
-00023a80: 6720 6973 206e 6f74 204e 6f6e 653a 0a20  g is not None:. 
-00023a90: 2020 2020 2020 2020 2020 2023 204e 4f54             # NOT
-00023aa0: 453a 2074 6865 2065 7865 6375 7469 6e67  E: the executing
-00023ab0: 2064 6963 7420 6973 2075 6e75 7365 640a   dict is unused.
-00023ac0: 2020 2020 2020 2020 2020 2020 7773 2e65              ws.e
-00023ad0: 7865 6375 7469 6e67 203d 207b 7d0a 2020  xecuting = {}.  
-00023ae0: 2020 2020 2020 2020 2020 666f 7220 6b65            for ke
-00023af0: 792c 2064 7572 6174 696f 6e20 696e 2065  y, duration in e
-00023b00: 7865 6375 7469 6e67 2e69 7465 6d73 2829  xecuting.items()
-00023b10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023b20: 2020 6966 206b 6579 2069 6e20 7365 6c66    if key in self
-00023b30: 2e74 6173 6b73 3a0a 2020 2020 2020 2020  .tasks:.        
-00023b40: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-00023b50: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00023b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b70: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
-00023b80: 675b 7473 5d20 3d20 6475 7261 7469 6f6e  g[ts] = duration
-00023b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023ba0: 2020 2020 2074 732e 7072 6566 6978 2e61       ts.prefix.a
-00023bb0: 6464 5f65 7865 635f 7469 6d65 2864 7572  dd_exec_time(dur
-00023bc0: 6174 696f 6e29 0a0a 2020 2020 2020 2020  ation)..        
-00023bd0: 666f 7220 6e61 6d65 2c20 7661 6c75 6520  for name, value 
-00023be0: 696e 206d 6574 7269 6373 5b22 6469 6765  in metrics["dige
-00023bf0: 7374 735f 746f 7461 6c5f 7369 6e63 655f  sts_total_since_
-00023c00: 6865 6172 7462 6561 7422 5d2e 6974 656d  heartbeat"].item
-00023c10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00023c20: 2073 656c 662e 6375 6d75 6c61 7469 7665   self.cumulative
-00023c30: 5f77 6f72 6b65 725f 6d65 7472 6963 735b  _worker_metrics[
-00023c40: 6e61 6d65 5d20 2b3d 2076 616c 7565 0a0a  name] += value..
-00023c50: 2020 2020 2020 2020 7773 2e6d 6574 7269          ws.metri
-00023c60: 6373 203d 206d 6574 7269 6373 0a0a 2020  cs = metrics..  
-00023c70: 2020 2020 2020 2320 4361 6c63 756c 6174        # Calculat
-00023c80: 6520 5253 5320 2d20 6461 736b 206b 6579  e RSS - dask key
-00023c90: 732c 2073 6570 6172 6174 696e 6720 226f  s, separating "o
-00023ca0: 6c64 2220 616e 6420 226e 6577 2220 7573  ld" and "new" us
-00023cb0: 6167 650a 2020 2020 2020 2020 2320 5365  age.        # Se
-00023cc0: 6520 4d65 6d6f 7279 5374 6174 6520 666f  e MemoryState fo
-00023cd0: 7220 6465 7461 696c 730a 2020 2020 2020  r details.      
-00023ce0: 2020 6d61 785f 6d65 6d6f 7279 5f75 6e6d    max_memory_unm
-00023cf0: 616e 6167 6564 5f6f 6c64 5f68 6973 745f  anaged_old_hist_
-00023d00: 6167 6520 3d20 6c6f 6361 6c5f 6e6f 7720  age = local_now 
-00023d10: 2d20 7365 6c66 2e4d 454d 4f52 595f 5245  - self.MEMORY_RE
-00023d20: 4345 4e54 5f54 4f5f 4f4c 445f 5449 4d45  CENT_TO_OLD_TIME
-00023d30: 0a20 2020 2020 2020 206d 656d 6f72 795f  .        memory_
-00023d40: 756e 6d61 6e61 6765 645f 6f6c 6420 3d20  unmanaged_old = 
-00023d50: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
-00023d60: 6167 6564 5f6f 6c64 0a20 2020 2020 2020  aged_old.       
-00023d70: 2077 6869 6c65 2077 732e 5f6d 656d 6f72   while ws._memor
-00023d80: 795f 756e 6d61 6e61 6765 645f 6869 7374  y_unmanaged_hist
-00023d90: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-00023da0: 2074 696d 6573 7461 6d70 2c20 7369 7a65   timestamp, size
-00023db0: 203d 2077 732e 5f6d 656d 6f72 795f 756e   = ws._memory_un
-00023dc0: 6d61 6e61 6765 645f 6869 7374 6f72 795b  managed_history[
-00023dd0: 305d 0a20 2020 2020 2020 2020 2020 2069  0].            i
-00023de0: 6620 7469 6d65 7374 616d 7020 3e3d 206d  f timestamp >= m
-00023df0: 6178 5f6d 656d 6f72 795f 756e 6d61 6e61  ax_memory_unmana
-00023e00: 6765 645f 6f6c 645f 6869 7374 5f61 6765  ged_old_hist_age
-00023e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023e20: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00023e30: 2020 2020 7773 2e5f 6d65 6d6f 7279 5f75      ws._memory_u
-00023e40: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
-00023e50: 2e70 6f70 6c65 6674 2829 0a20 2020 2020  .popleft().     
-00023e60: 2020 2020 2020 2069 6620 7369 7a65 203d         if size =
-00023e70: 3d20 6d65 6d6f 7279 5f75 6e6d 616e 6167  = memory_unmanag
-00023e80: 6564 5f6f 6c64 3a0a 2020 2020 2020 2020  ed_old:.        
-00023e90: 2020 2020 2020 2020 6d65 6d6f 7279 5f75          memory_u
-00023ea0: 6e6d 616e 6167 6564 5f6f 6c64 203d 2030  nmanaged_old = 0
-00023eb0: 2020 2320 7265 6361 6c63 756c 6174 6520    # recalculate 
-00023ec0: 6d69 6e28 290a 0a20 2020 2020 2020 2023  min()..        #
-00023ed0: 2077 732e 5f6e 6279 7465 7320 6973 2075   ws._nbytes is u
-00023ee0: 7064 6174 6564 2061 7420 6120 6469 6666  pdated at a diff
-00023ef0: 6572 656e 7420 7469 6d65 2061 6e64 2073  erent time and s
-00023f00: 697a 656f 6628 2920 6d61 7920 6e6f 7420  izeof() may not 
-00023f10: 6265 2061 6363 7572 6174 652c 0a20 2020  be accurate,.   
-00023f20: 2020 2020 2023 2073 6f20 7369 7a65 206d       # so size m
-00023f30: 6179 2062 6520 2874 656d 706f 7261 7269  ay be (temporari
-00023f40: 6c79 2920 6e65 6761 7469 7665 3b20 666c  ly) negative; fl
-00023f50: 6f6f 7220 6974 2074 6f20 7a65 726f 2e0a  oor it to zero..
-00023f60: 2020 2020 2020 2020 7369 7a65 203d 206d          size = m
-00023f70: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
-00023f80: 302c 206d 6574 7269 6373 5b22 6d65 6d6f  0, metrics["memo
-00023f90: 7279 225d 202d 2077 732e 6e62 7974 6573  ry"] - ws.nbytes
-00023fa0: 202b 206d 6574 7269 6373 5b22 7370 696c   + metrics["spil
-00023fb0: 6c65 645f 6279 7465 7322 5d5b 226d 656d  led_bytes"]["mem
-00023fc0: 6f72 7922 5d0a 2020 2020 2020 2020 290a  ory"].        ).
-00023fd0: 0a20 2020 2020 2020 2077 732e 5f6d 656d  .        ws._mem
-00023fe0: 6f72 795f 756e 6d61 6e61 6765 645f 6869  ory_unmanaged_hi
-00023ff0: 7374 6f72 792e 6170 7065 6e64 2828 6c6f  story.append((lo
-00024000: 6361 6c5f 6e6f 772c 2073 697a 6529 290a  cal_now, size)).
-00024010: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-00024020: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00024030: 6f6c 643a 0a20 2020 2020 2020 2020 2020  old:.           
-00024040: 2023 2054 6865 2077 6f72 6b65 7220 6861   # The worker ha
-00024050: 7320 6a75 7374 2062 6565 6e20 7374 6172  s just been star
-00024060: 7465 6420 6f72 2074 6865 2070 7265 7669  ted or the previ
-00024070: 6f75 7320 6d69 6e69 6d75 6d20 6861 7320  ous minimum has 
-00024080: 6265 656e 2065 7870 756e 6765 640a 2020  been expunged.  
-00024090: 2020 2020 2020 2020 2020 2320 6265 6361            # beca
-000240a0: 7573 6520 746f 6f20 6f6c 642e 0a20 2020  use too old..   
-000240b0: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
-000240c0: 2074 6869 7320 616c 676f 7269 7468 6d20   this algorithm 
-000240d0: 6973 2063 6170 7065 6420 746f 2032 3030  is capped to 200
-000240e0: 202a 204d 454d 4f52 595f 5245 4345 4e54   * MEMORY_RECENT
-000240f0: 5f54 4f5f 4f4c 445f 5449 4d45 2065 6c65  _TO_OLD_TIME ele
-00024100: 6d65 6e74 730a 2020 2020 2020 2020 2020  ments.          
-00024110: 2020 2320 636c 7573 7465 722d 7769 6465    # cluster-wide
-00024120: 2062 7920 6865 6172 7462 6561 745f 696e   by heartbeat_in
-00024130: 7465 7276 616c 2829 2c20 7265 6761 7264  terval(), regard
-00024140: 6c65 7373 206f 6620 7468 6520 6e75 6d62  less of the numb
-00024150: 6572 206f 6620 776f 726b 6572 730a 2020  er of workers.  
-00024160: 2020 2020 2020 2020 2020 7773 2e5f 6d65            ws._me
-00024170: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00024180: 6c64 203d 206d 696e 286d 6170 2873 6563  ld = min(map(sec
-00024190: 6f6e 642c 2077 732e 5f6d 656d 6f72 795f  ond, ws._memory_
-000241a0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-000241b0: 7929 290a 2020 2020 2020 2020 656c 6966  y)).        elif
-000241c0: 2073 697a 6520 3c20 6d65 6d6f 7279 5f75   size < memory_u
-000241d0: 6e6d 616e 6167 6564 5f6f 6c64 3a0a 2020  nmanaged_old:.  
-000241e0: 2020 2020 2020 2020 2020 7773 2e5f 6d65            ws._me
-000241f0: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-00024200: 6c64 203d 2073 697a 650a 0a20 2020 2020  ld = size..     
-00024210: 2020 2069 6620 686f 7374 5f69 6e66 6f3a     if host_info:
-00024220: 0a20 2020 2020 2020 2020 2020 2064 6820  .            dh 
-00024230: 3d20 7365 6c66 2e68 6f73 745f 696e 666f  = self.host_info
-00024240: 2e73 6574 6465 6661 756c 7428 686f 7374  .setdefault(host
-00024250: 2c20 7b7d 290a 2020 2020 2020 2020 2020  , {}).          
-00024260: 2020 6468 2e75 7064 6174 6528 686f 7374    dh.update(host
-00024270: 5f69 6e66 6f29 0a0a 2020 2020 2020 2020  _info)..        
-00024280: 6966 206e 6f77 3a0a 2020 2020 2020 2020  if now:.        
-00024290: 2020 2020 7773 2e74 696d 655f 6465 6c61      ws.time_dela
-000242a0: 7920 3d20 6c6f 6361 6c5f 6e6f 7720 2d20  y = local_now - 
-000242b0: 6e6f 770a 0a20 2020 2020 2020 2069 6620  now..        if 
-000242c0: 7265 736f 7572 6365 733a 0a20 2020 2020  resources:.     
-000242d0: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-000242e0: 7265 736f 7572 6365 7328 776f 726b 6572  resources(worker
-000242f0: 3d61 6464 7265 7373 2c20 7265 736f 7572  =address, resour
-00024300: 6365 733d 7265 736f 7572 6365 7329 0a0a  ces=resources)..
-00024310: 2020 2020 2020 2020 6966 2065 7874 656e          if exten
-00024320: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
-00024330: 2020 2066 6f72 206e 616d 652c 2064 6174     for name, dat
-00024340: 6120 696e 2065 7874 656e 7369 6f6e 732e  a in extensions.
-00024350: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00024360: 2020 2020 2020 2020 2073 656c 662e 6578           self.ex
-00024370: 7465 6e73 696f 6e73 5b6e 616d 655d 2e68  tensions[name].h
-00024380: 6561 7274 6265 6174 2877 732c 2064 6174  eartbeat(ws, dat
-00024390: 6129 0a0a 2020 2020 2020 2020 7265 7475  a)..        retu
-000243a0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-000243b0: 2022 7374 6174 7573 223a 2022 4f4b 222c   "status": "OK",
-000243c0: 0a20 2020 2020 2020 2020 2020 2022 7469  .            "ti
-000243d0: 6d65 223a 206c 6f63 616c 5f6e 6f77 2c0a  me": local_now,.
-000243e0: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
-000243f0: 7274 6265 6174 2d69 6e74 6572 7661 6c22  rtbeat-interval"
-00024400: 3a20 6865 6172 7462 6561 745f 696e 7465  : heartbeat_inte
-00024410: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
-00024420: 726b 6572 7329 292c 0a20 2020 2020 2020  rkers)),.       
-00024430: 207d 0a0a 2020 2020 406c 6f67 5f65 7272   }..    @log_err
-00024440: 6f72 730a 2020 2020 6173 796e 6320 6465  ors.    async de
-00024450: 6620 6164 645f 776f 726b 6572 280a 2020  f add_worker(.  
-00024460: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00024470: 2020 2020 636f 6d6d 3a20 436f 6d6d 2c0a      comm: Comm,.
-00024480: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00024490: 2020 2061 6464 7265 7373 3a20 7374 722c     address: str,
-000244a0: 0a20 2020 2020 2020 2073 7461 7475 733a  .        status:
-000244b0: 2073 7472 2c0a 2020 2020 2020 2020 7365   str,.        se
-000244c0: 7276 6572 5f69 643a 2073 7472 2c0a 2020  rver_id: str,.  
-000244d0: 2020 2020 2020 6e74 6872 6561 6473 3a20        nthreads: 
-000244e0: 696e 742c 0a20 2020 2020 2020 206e 616d  int,.        nam
-000244f0: 653a 2073 7472 2c0a 2020 2020 2020 2020  e: str,.        
-00024500: 7265 736f 6c76 655f 6164 6472 6573 733a  resolve_address:
-00024510: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-00024520: 2020 2020 2020 6e6f 773a 2066 6c6f 6174        now: float
-00024530: 2c0a 2020 2020 2020 2020 7265 736f 7572  ,.        resour
-00024540: 6365 733a 2064 6963 745b 7374 722c 2066  ces: dict[str, f
-00024550: 6c6f 6174 5d2c 0a20 2020 2020 2020 2023  loat],.        #
-00024560: 2046 4958 4d45 3a20 5468 6973 2069 7320   FIXME: This is 
-00024570: 6e65 7665 7220 7375 626d 6974 7465 6420  never submitted 
-00024580: 6279 2074 6865 2077 6f72 6b65 720a 2020  by the worker.  
-00024590: 2020 2020 2020 686f 7374 5f69 6e66 6f3a        host_info:
-000245a0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-000245b0: 2020 2020 2020 6d65 6d6f 7279 5f6c 696d        memory_lim
-000245c0: 6974 3a20 696e 7420 7c20 4e6f 6e65 2c0a  it: int | None,.
-000245d0: 2020 2020 2020 2020 6d65 7472 6963 733a          metrics:
-000245e0: 2064 6963 745b 7374 722c 2041 6e79 5d2c   dict[str, Any],
-000245f0: 0a20 2020 2020 2020 2070 6964 3a20 696e  .        pid: in
-00024600: 7420 3d20 302c 0a20 2020 2020 2020 2073  t = 0,.        s
-00024610: 6572 7669 6365 733a 2064 6963 745b 7374  ervices: dict[st
-00024620: 722c 2069 6e74 5d2c 0a20 2020 2020 2020  r, int],.       
-00024630: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
-00024640: 3a20 7374 722c 0a20 2020 2020 2020 2076  : str,.        v
-00024650: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
-00024660: 722c 2041 6e79 5d2c 0a20 2020 2020 2020  r, Any],.       
-00024670: 206e 616e 6e79 3a20 7374 722c 0a20 2020   nanny: str,.   
-00024680: 2020 2020 2065 7874 7261 3a20 6469 6374       extra: dict
-00024690: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-000246a0: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
-000246b0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-000246c0: 2020 2022 2222 4164 6420 6120 6e65 7720     """Add a new 
-000246d0: 776f 726b 6572 2074 6f20 7468 6520 636c  worker to the cl
-000246e0: 7573 7465 7222 2222 0a20 2020 2020 2020  uster""".       
-000246f0: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
-00024700: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
-00024710: 6464 7265 7373 2c20 7265 736f 6c76 655f  ddress, resolve_
-00024720: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-00024730: 2061 6464 7265 7373 203d 206e 6f72 6d61   address = norma
-00024740: 6c69 7a65 5f61 6464 7265 7373 2861 6464  lize_address(add
-00024750: 7265 7373 290a 2020 2020 2020 2020 686f  ress).        ho
-00024760: 7374 203d 2067 6574 5f61 6464 7265 7373  st = get_address
-00024770: 5f68 6f73 7428 6164 6472 6573 7329 0a0a  _host(address)..
-00024780: 2020 2020 2020 2020 6966 2061 6464 7265          if addre
-00024790: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
-000247a0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-000247b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000247c0: 2822 576f 726b 6572 2061 6c72 6561 6479  ("Worker already
-000247d0: 2065 7869 7374 7320 2573 2220 2520 6164   exists %s" % ad
-000247e0: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
-000247f0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
-00024800: 616c 6961 7365 733a 0a20 2020 2020 2020  aliases:.       
-00024810: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
-00024820: 696e 6728 2257 6f72 6b65 7220 7472 6965  ing("Worker trie
-00024830: 6420 746f 2063 6f6e 6e65 6374 2077 6974  d to connect wit
-00024840: 6820 6120 6475 706c 6963 6174 6520 6e61  h a duplicate na
-00024850: 6d65 3a20 2573 222c 206e 616d 6529 0a20  me: %s", name). 
-00024860: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-00024870: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00024880: 2020 2022 7374 6174 7573 223a 2022 6572     "status": "er
-00024890: 726f 7222 2c0a 2020 2020 2020 2020 2020  ror",.          
-000248a0: 2020 2020 2020 226d 6573 7361 6765 223a        "message":
-000248b0: 2022 6e61 6d65 2074 616b 656e 2c20 2573   "name taken, %s
-000248c0: 2220 2520 6e61 6d65 2c0a 2020 2020 2020  " % name,.      
-000248d0: 2020 2020 2020 2020 2020 2274 696d 6522            "time"
-000248e0: 3a20 7469 6d65 2829 2c0a 2020 2020 2020  : time(),.      
-000248f0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-00024900: 2020 2020 6177 6169 7420 636f 6d6d 2e77      await comm.w
-00024910: 7269 7465 286d 7367 290a 2020 2020 2020  rite(msg).      
-00024920: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
-00024930: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-00024940: 7665 6e74 2861 6464 7265 7373 2c20 7b22  vent(address, {"
-00024950: 6163 7469 6f6e 223a 2022 6164 642d 776f  action": "add-wo
-00024960: 726b 6572 227d 290a 2020 2020 2020 2020  rker"}).        
-00024970: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
-00024980: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
-00024990: 2022 6164 642d 776f 726b 6572 222c 2022   "add-worker", "
-000249a0: 776f 726b 6572 223a 2061 6464 7265 7373  worker": address
-000249b0: 7d29 0a0a 2020 2020 2020 2020 7365 6c66  })..        self
-000249c0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-000249d0: 5d20 3d20 7773 203d 2057 6f72 6b65 7253  ] = ws = WorkerS
-000249e0: 7461 7465 280a 2020 2020 2020 2020 2020  tate(.          
-000249f0: 2020 6164 6472 6573 733d 6164 6472 6573    address=addres
-00024a00: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
-00024a10: 7461 7475 733d 5374 6174 7573 2e6c 6f6f  tatus=Status.loo
-00024a20: 6b75 705b 7374 6174 7573 5d2c 2020 2320  kup[status],  # 
-00024a30: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
-00024a40: 2020 2020 2020 2020 2070 6964 3d70 6964           pid=pid
-00024a50: 2c0a 2020 2020 2020 2020 2020 2020 6e74  ,.            nt
-00024a60: 6872 6561 6473 3d6e 7468 7265 6164 732c  hreads=nthreads,
-00024a70: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-00024a80: 6f72 795f 6c69 6d69 743d 6d65 6d6f 7279  ory_limit=memory
-00024a90: 5f6c 696d 6974 206f 7220 302c 0a20 2020  _limit or 0,.   
-00024aa0: 2020 2020 2020 2020 206e 616d 653d 6e61           name=na
-00024ab0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00024ac0: 6c6f 6361 6c5f 6469 7265 6374 6f72 793d  local_directory=
-00024ad0: 6c6f 6361 6c5f 6469 7265 6374 6f72 792c  local_directory,
-00024ae0: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
-00024af0: 7669 6365 733d 7365 7276 6963 6573 2c0a  vices=services,.
-00024b00: 2020 2020 2020 2020 2020 2020 7665 7273              vers
-00024b10: 696f 6e73 3d76 6572 7369 6f6e 732c 0a20  ions=versions,. 
-00024b20: 2020 2020 2020 2020 2020 206e 616e 6e79             nanny
-00024b30: 3d6e 616e 6e79 2c0a 2020 2020 2020 2020  =nanny,.        
-00024b40: 2020 2020 6578 7472 613d 6578 7472 612c      extra=extra,
-00024b50: 0a20 2020 2020 2020 2020 2020 2073 6572  .            ser
-00024b60: 7665 725f 6964 3d73 6572 7665 725f 6964  ver_id=server_id
-00024b70: 2c0a 2020 2020 2020 2020 2020 2020 7363  ,.            sc
-00024b80: 6865 6475 6c65 723d 7365 6c66 2c0a 2020  heduler=self,.  
-00024b90: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024ba0: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
-00024bb0: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-00024bc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00024bd0: 2e72 756e 6e69 6e67 2e61 6464 2877 7329  .running.add(ws)
-00024be0: 0a0a 2020 2020 2020 2020 6468 203d 2073  ..        dh = s
-00024bf0: 656c 662e 686f 7374 5f69 6e66 6f2e 6765  elf.host_info.ge
-00024c00: 7428 686f 7374 290a 2020 2020 2020 2020  t(host).        
-00024c10: 6966 2064 6820 6973 204e 6f6e 653a 0a20  if dh is None:. 
-00024c20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00024c30: 686f 7374 5f69 6e66 6f5b 686f 7374 5d20  host_info[host] 
-00024c40: 3d20 6468 203d 207b 7d0a 0a20 2020 2020  = dh = {}..     
-00024c50: 2020 2064 685f 6164 6472 6573 7365 7320     dh_addresses 
-00024c60: 3d20 6468 2e67 6574 2822 6164 6472 6573  = dh.get("addres
-00024c70: 7365 7322 290a 2020 2020 2020 2020 6966  ses").        if
-00024c80: 2064 685f 6164 6472 6573 7365 7320 6973   dh_addresses is
-00024c90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00024ca0: 2020 2064 685b 2261 6464 7265 7373 6573     dh["addresses
-00024cb0: 225d 203d 2064 685f 6164 6472 6573 7365  "] = dh_addresse
-00024cc0: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-00024cd0: 2020 2020 2020 6468 5b22 6e74 6872 6561        dh["nthrea
-00024ce0: 6473 225d 203d 2030 0a0a 2020 2020 2020  ds"] = 0..      
-00024cf0: 2020 6468 5f61 6464 7265 7373 6573 2e61    dh_addresses.a
-00024d00: 6464 2861 6464 7265 7373 290a 2020 2020  dd(address).    
-00024d10: 2020 2020 6468 5b22 6e74 6872 6561 6473      dh["nthreads
-00024d20: 225d 202b 3d20 6e74 6872 6561 6473 0a0a  "] += nthreads..
-00024d30: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
-00024d40: 616c 5f6e 7468 7265 6164 7320 2b3d 206e  al_nthreads += n
-00024d50: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
-00024d60: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
-00024d70: 6164 735f 6869 7374 6f72 792e 6170 7065  ads_history.appe
-00024d80: 6e64 2828 7469 6d65 2829 2c20 7365 6c66  nd((time(), self
-00024d90: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
-00024da0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
-00024db0: 6c69 6173 6573 5b6e 616d 655d 203d 2061  liases[name] = a
-00024dc0: 6464 7265 7373 0a0a 2020 2020 2020 2020  ddress..        
-00024dd0: 7365 6c66 2e68 6561 7274 6265 6174 5f77  self.heartbeat_w
-00024de0: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
-00024df0: 2020 2061 6464 7265 7373 3d61 6464 7265     address=addre
-00024e00: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-00024e10: 7265 736f 6c76 655f 6164 6472 6573 733d  resolve_address=
-00024e20: 7265 736f 6c76 655f 6164 6472 6573 732c  resolve_address,
-00024e30: 0a20 2020 2020 2020 2020 2020 206e 6f77  .            now
-00024e40: 3d6e 6f77 2c0a 2020 2020 2020 2020 2020  =now,.          
-00024e50: 2020 7265 736f 7572 6365 733d 7265 736f    resources=reso
-00024e60: 7572 6365 732c 0a20 2020 2020 2020 2020  urces,.         
-00024e70: 2020 2068 6f73 745f 696e 666f 3d68 6f73     host_info=hos
-00024e80: 745f 696e 666f 2c0a 2020 2020 2020 2020  t_info,.        
-00024e90: 2020 2020 6d65 7472 6963 733d 6d65 7472      metrics=metr
-00024ea0: 6963 732c 0a20 2020 2020 2020 2029 0a0a  ics,.        )..
-00024eb0: 2020 2020 2020 2020 2320 446f 206e 6f74          # Do not
-00024ec0: 206e 6565 6420 746f 2061 646a 7573 7420   need to adjust 
-00024ed0: 7365 6c66 2e74 6f74 616c 5f6f 6363 7570  self.total_occup
-00024ee0: 616e 6379 2061 7320 7365 6c66 2e6f 6363  ancy as self.occ
-00024ef0: 7570 616e 6379 5b77 735d 2063 616e 6e6f  upancy[ws] canno
-00024f00: 740a 2020 2020 2020 2020 2320 6578 6973  t.        # exis
-00024f10: 7420 6265 666f 7265 2074 6869 732e 0a20  t before this.. 
-00024f20: 2020 2020 2020 2073 656c 662e 6368 6563         self.chec
-00024f30: 6b5f 6964 6c65 5f73 6174 7572 6174 6564  k_idle_saturated
-00024f40: 2877 7329 0a0a 2020 2020 2020 2020 7365  (ws)..        se
-00024f50: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-00024f60: 6164 6472 6573 735d 203d 2042 6174 6368  address] = Batch
-00024f70: 6564 5365 6e64 2869 6e74 6572 7661 6c3d  edSend(interval=
-00024f80: 2235 6d73 222c 206c 6f6f 703d 7365 6c66  "5ms", loop=self
-00024f90: 2e6c 6f6f 7029 0a0a 2020 2020 2020 2020  .loop)..        
-00024fa0: 6177 6169 7461 626c 6573 203d 205b 5d0a  awaitables = [].
-00024fb0: 2020 2020 2020 2020 666f 7220 706c 7567          for plug
-00024fc0: 696e 2069 6e20 6c69 7374 2873 656c 662e  in in list(self.
-00024fd0: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
-00024fe0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-00024ff0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00025000: 2020 2020 7265 7375 6c74 203d 2070 6c75      result = plu
-00025010: 6769 6e2e 6164 645f 776f 726b 6572 2873  gin.add_worker(s
-00025020: 6368 6564 756c 6572 3d73 656c 662c 2077  cheduler=self, w
-00025030: 6f72 6b65 723d 6164 6472 6573 7329 0a20  orker=address). 
-00025040: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00025050: 6620 7265 7375 6c74 2069 7320 6e6f 7420  f result is not 
-00025060: 4e6f 6e65 2061 6e64 2069 6e73 7065 6374  None and inspect
-00025070: 2e69 7361 7761 6974 6162 6c65 2872 6573  .isawaitable(res
-00025080: 756c 7429 3a0a 2020 2020 2020 2020 2020  ult):.          
-00025090: 2020 2020 2020 2020 2020 6177 6169 7461            awaita
-000250a0: 626c 6573 2e61 7070 656e 6428 7265 7375  bles.append(resu
-000250b0: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-000250c0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000250d0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000250e0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-000250f0: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
-00025100: 2020 2020 706c 7567 696e 5f6d 7367 7320      plugin_msgs 
-00025110: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-00025120: 6761 7468 6572 282a 6177 6169 7461 626c  gather(*awaitabl
-00025130: 6573 2c20 7265 7475 726e 5f65 7863 6570  es, return_excep
-00025140: 7469 6f6e 733d 5472 7565 290a 2020 2020  tions=True).    
-00025150: 2020 2020 706c 7567 696e 735f 6578 6365      plugins_exce
-00025160: 7074 696f 6e73 203d 205b 6d73 6720 666f  ptions = [msg fo
-00025170: 7220 6d73 6720 696e 2070 6c75 6769 6e5f  r msg in plugin_
-00025180: 6d73 6773 2069 6620 6973 696e 7374 616e  msgs if isinstan
-00025190: 6365 286d 7367 2c20 4578 6365 7074 696f  ce(msg, Exceptio
-000251a0: 6e29 5d0a 2020 2020 2020 2020 666f 7220  n)].        for 
-000251b0: 6578 6320 696e 2070 6c75 6769 6e73 5f65  exc in plugins_e
-000251c0: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
-000251d0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-000251e0: 6365 7074 696f 6e28 6578 632c 2065 7863  ception(exc, exc
-000251f0: 5f69 6e66 6f3d 6578 6329 0a0a 2020 2020  _info=exc)..    
-00025200: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-00025210: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-00025220: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-00025230: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
-00025240: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00025250: 2020 7365 6c66 2e62 756c 6b5f 7363 6865    self.bulk_sche
-00025260: 6475 6c65 5f75 6e72 756e 6e61 626c 655f  dule_unrunnable_
-00025270: 6166 7465 725f 6164 6469 6e67 5f77 6f72  after_adding_wor
-00025280: 6b65 7228 7773 292c 2073 7469 6d75 6c75  ker(ws), stimulu
-00025290: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
-000252a0: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-000252b0: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
-000252c0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
-000252d0: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
-000252e0: 643d 7374 696d 756c 7573 5f69 6429 0a0a  d=stimulus_id)..
-000252f0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00025300: 6e66 6f28 2252 6567 6973 7465 7220 776f  nfo("Register wo
-00025310: 726b 6572 2025 7322 2c20 7773 290a 0a20  rker %s", ws).. 
-00025320: 2020 2020 2020 206d 7367 203d 207b 0a20         msg = {. 
-00025330: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00025340: 7573 223a 2022 4f4b 222c 0a20 2020 2020  us": "OK",.     
-00025350: 2020 2020 2020 2022 7469 6d65 223a 2074         "time": t
-00025360: 696d 6528 292c 0a20 2020 2020 2020 2020  ime(),.         
-00025370: 2020 2022 6865 6172 7462 6561 742d 696e     "heartbeat-in
-00025380: 7465 7276 616c 223a 2068 6561 7274 6265  terval": heartbe
-00025390: 6174 5f69 6e74 6572 7661 6c28 6c65 6e28  at_interval(len(
-000253a0: 7365 6c66 2e77 6f72 6b65 7273 2929 2c0a  self.workers)),.
-000253b0: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-000253c0: 6b65 722d 706c 7567 696e 7322 3a20 7365  ker-plugins": se
-000253d0: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
-000253e0: 732c 0a20 2020 2020 2020 207d 0a0a 2020  s,.        }..  
-000253f0: 2020 2020 2020 7665 7273 696f 6e5f 7761        version_wa
-00025400: 726e 696e 6720 3d20 7665 7273 696f 6e5f  rning = version_
-00025410: 6d6f 6475 6c65 2e65 7272 6f72 5f6d 6573  module.error_mes
-00025420: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
-00025430: 2020 7665 7273 696f 6e5f 6d6f 6475 6c65    version_module
-00025440: 2e67 6574 5f76 6572 7369 6f6e 7328 292c  .get_versions(),
-00025450: 0a20 2020 2020 2020 2020 2020 207b 773a  .            {w:
-00025460: 2077 732e 7665 7273 696f 6e73 2066 6f72   ws.versions for
-00025470: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-00025480: 6f72 6b65 7273 2e69 7465 6d73 2829 7d2c  orkers.items()},
-00025490: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-000254a0: 7369 6f6e 732c 0a20 2020 2020 2020 2020  sions,.         
-000254b0: 2020 2073 6f75 7263 655f 6e61 6d65 3d73     source_name=s
-000254c0: 7472 2877 732e 7365 7276 6572 5f69 6429  tr(ws.server_id)
-000254d0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-000254e0: 2020 2020 6d73 672e 7570 6461 7465 2876      msg.update(v
-000254f0: 6572 7369 6f6e 5f77 6172 6e69 6e67 290a  ersion_warning).
-00025500: 0a20 2020 2020 2020 2061 7761 6974 2063  .        await c
-00025510: 6f6d 6d2e 7772 6974 6528 6d73 6729 0a20  omm.write(msg). 
-00025520: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
-00025530: 6c6c 206b 6565 7020 7275 6e6e 696e 6720  ll keep running 
-00025540: 756e 7469 6c20 7468 6520 776f 726b 6572  until the worker
-00025550: 2069 7320 7265 6d6f 7665 640a 2020 2020   is removed.    
-00025560: 2020 2020 6177 6169 7420 7365 6c66 2e68      await self.h
-00025570: 616e 646c 655f 776f 726b 6572 2863 6f6d  andle_worker(com
-00025580: 6d2c 2061 6464 7265 7373 290a 0a20 2020  m, address)..   
-00025590: 2061 7379 6e63 2064 6566 2061 6464 5f6e   async def add_n
-000255a0: 616e 6e79 2873 656c 6629 202d 3e20 6469  anny(self) -> di
-000255b0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
-000255c0: 2020 2020 2020 6d73 6720 3d20 7b0a 2020        msg = {.  
-000255d0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
-000255e0: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
-000255f0: 2020 2020 2020 226e 616e 6e79 2d70 6c75        "nanny-plu
-00025600: 6769 6e73 223a 2073 656c 662e 6e61 6e6e  gins": self.nann
-00025610: 795f 706c 7567 696e 732c 0a20 2020 2020  y_plugins,.     
-00025620: 2020 207d 0a20 2020 2020 2020 2072 6574     }.        ret
-00025630: 7572 6e20 6d73 670a 0a20 2020 2064 6566  urn msg..    def
-00025640: 2075 7064 6174 655f 6772 6170 6828 0a20   update_graph(. 
-00025650: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00025660: 2020 2020 2063 6c69 656e 743a 2073 7472       client: str
-00025670: 2c0a 2020 2020 2020 2020 6772 6170 685f  ,.        graph_
-00025680: 6865 6164 6572 3a20 6469 6374 2c0a 2020  header: dict,.  
-00025690: 2020 2020 2020 6772 6170 685f 6672 616d        graph_fram
-000256a0: 6573 3a20 6c69 7374 5b62 7974 6573 5d2c  es: list[bytes],
-000256b0: 0a20 2020 2020 2020 206b 6579 733a 206c  .        keys: l
-000256c0: 6973 745b 7374 725d 2c0a 2020 2020 2020  ist[str],.      
-000256d0: 2020 696e 7465 726e 616c 5f70 7269 6f72    internal_prior
-000256e0: 6974 793a 2064 6963 745b 7374 722c 2069  ity: dict[str, i
-000256f0: 6e74 5d20 7c20 4e6f 6e65 2c0a 2020 2020  nt] | None,.    
-00025700: 2020 2020 7375 626d 6974 7469 6e67 5f74      submitting_t
-00025710: 6173 6b3a 2073 7472 207c 204e 6f6e 652c  ask: str | None,
-00025720: 0a20 2020 2020 2020 2075 7365 725f 7072  .        user_pr
-00025730: 696f 7269 7479 3a20 696e 7420 7c20 6469  iority: int | di
-00025740: 6374 5b73 7472 2c20 696e 745d 203d 2030  ct[str, int] = 0
-00025750: 2c0a 2020 2020 2020 2020 6163 746f 7273  ,.        actors
-00025760: 3a20 626f 6f6c 207c 206c 6973 745b 7374  : bool | list[st
-00025770: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
-00025780: 2c0a 2020 2020 2020 2020 6669 666f 5f74  ,.        fifo_t
-00025790: 696d 656f 7574 3a20 666c 6f61 7420 3d20  imeout: float = 
-000257a0: 302e 302c 0a20 2020 2020 2020 2063 6f64  0.0,.        cod
-000257b0: 653a 2074 7570 6c65 5b53 6f75 7263 6543  e: tuple[SourceC
-000257c0: 6f64 652c 202e 2e2e 5d20 3d20 2829 2c0a  ode, ...] = (),.
-000257d0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
-000257e0: 6f6e 733a 2064 6963 7420 7c20 4e6f 6e65  ons: dict | None
-000257f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00025800: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00025810: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00025820: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00025830: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-00025840: 7469 6d65 2829 0a20 2020 2020 2020 2074  time().        t
-00025850: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00025860: 2320 544f 444f 3a20 6465 7365 7269 616c  # TODO: deserial
-00025870: 697a 6174 696f 6e20 2b20 6d61 7465 7269  ization + materi
-00025880: 616c 697a 6174 696f 6e20 7368 6f75 6c64  alization should
-00025890: 2062 6520 6f66 666c 6f61 6465 6420 746f   be offloaded to
-000258a0: 2061 0a20 2020 2020 2020 2020 2020 2023   a.            #
-000258b0: 2074 6872 6561 6420 7369 6e63 6520 7468   thread since th
-000258c0: 6973 2069 7320 6e6f 6e2d 7472 6976 6961  is is non-trivia
-000258d0: 6c20 636f 6d70 7574 6520 7469 6d65 2074  l compute time t
-000258e0: 6861 7420 626c 6f63 6b73 2074 6865 0a20  hat blocks the. 
-000258f0: 2020 2020 2020 2020 2020 2023 2065 7665             # eve
-00025900: 6e74 206c 6f6f 702e 2054 6869 7320 6c69  nt loop. This li
-00025910: 6b65 6c79 2072 6571 7569 7265 7320 7573  kely requires us
-00025920: 2074 6f20 7573 6520 6120 6c6f 636b 2073   to use a lock s
-00025930: 696e 6365 2077 6520 6e65 6564 2074 6f0a  ince we need to.
-00025940: 2020 2020 2020 2020 2020 2020 2320 6775              # gu
-00025950: 6172 616e 7465 6520 6f72 6465 7269 6e67  arantee ordering
-00025960: 206f 6620 7570 6461 7465 5f67 7261 7068   of update_graph
-00025970: 2063 616c 6c73 2028 6173 206c 6f6e 6720   calls (as long 
-00025980: 6173 2074 6865 7265 2069 7320 6a75 7374  as there is just
-00025990: 0a20 2020 2020 2020 2020 2020 2023 2061  .            # a
-000259a0: 2073 696e 676c 6520 6f66 666c 6f61 6420   single offload 
-000259b0: 7468 7265 6164 2c20 7468 6973 2069 7320  thread, this is 
-000259c0: 6e6f 7420 6120 7072 6f62 6c65 6d29 0a20  not a problem). 
-000259d0: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
-000259e0: 6469 7374 7269 6275 7465 642e 7072 6f74  distributed.prot
-000259f0: 6f63 6f6c 2069 6d70 6f72 7420 6465 7365  ocol import dese
-00025a00: 7269 616c 697a 650a 0a20 2020 2020 2020  rialize..       
-00025a10: 2020 2020 2067 7261 7068 203d 2064 6573       graph = des
-00025a20: 6572 6961 6c69 7a65 2867 7261 7068 5f68  erialize(graph_h
-00025a30: 6561 6465 722c 2067 7261 7068 5f66 7261  eader, graph_fra
-00025a40: 6d65 7329 2e64 6174 610a 2020 2020 2020  mes).data.      
-00025a50: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00025a60: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00025a70: 2020 2020 206d 7367 203d 2022 2222 5c0a       msg = """\.
-00025a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025a90: 4572 726f 7220 6475 7269 6e67 2064 6573  Error during des
-00025aa0: 6572 6961 6c69 7a61 7469 6f6e 206f 6620  erialization of 
-00025ab0: 7468 6520 7461 736b 2067 7261 7068 2e20  the task graph. 
-00025ac0: 5468 6973 2066 7265 7175 656e 746c 7920  This frequently 
-00025ad0: 6f63 6375 7273 2069 6620 7468 6520 5363  occurs if the Sc
-00025ae0: 6865 6475 6c65 7220 616e 6420 436c 6965  heduler and Clie
-00025af0: 6e74 2068 6176 6520 6469 6666 6572 656e  nt have differen
-00025b00: 7420 656e 7669 726f 6e6d 656e 7473 2e20  t environments. 
-00025b10: 466f 7220 6d6f 7265 2069 6e66 6f72 6d61  For more informa
-00025b20: 7469 6f6e 2c20 7365 6520 6874 7470 733a  tion, see https:
-00025b30: 2f2f 646f 6373 2e64 6173 6b2e 6f72 672f  //docs.dask.org/
-00025b40: 656e 2f73 7461 626c 652f 6465 706c 6f79  en/stable/deploy
-00025b50: 6d65 6e74 2d63 6f6e 7369 6465 7261 7469  ment-considerati
-00025b60: 6f6e 732e 6874 6d6c 2363 6f6e 7369 7374  ons.html#consist
-00025b70: 656e 742d 736f 6674 7761 7265 2d65 6e76  ent-software-env
-00025b80: 6972 6f6e 6d65 6e74 730a 2020 2020 2020  ironments.      
-00025b90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00025ba0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00025bb0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00025bc0: 2052 756e 7469 6d65 4572 726f 7228 7465   RuntimeError(te
-00025bd0: 7874 7772 6170 2e64 6564 656e 7428 6d73  xtwrap.dedent(ms
-00025be0: 6729 2920 6672 6f6d 2065 0a20 2020 2020  g)) from e.     
-00025bf0: 2020 2020 2020 2065 7863 6570 7420 5275         except Ru
-00025c00: 6e74 696d 6545 7272 6f72 2061 7320 653a  ntimeError as e:
-00025c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00025c20: 2065 7272 203d 2065 7272 6f72 5f6d 6573   err = error_mes
-00025c30: 7361 6765 2865 290a 2020 2020 2020 2020  sage(e).        
-00025c40: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00025c50: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-00025c60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00025c70: 662e 7265 706f 7274 280a 2020 2020 2020  f.report(.      
-00025c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025c90: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00025ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025cb0: 226f 7022 3a20 2274 6173 6b2d 6572 7265  "op": "task-erre
-00025cc0: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
-00025cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ce0: 226b 6579 223a 206b 6579 2c0a 2020 2020  "key": key,.    
-00025cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d00: 2020 2020 2020 2020 2265 7863 6570 7469          "excepti
-00025d10: 6f6e 223a 2065 7272 5b22 6578 6365 7074  on": err["except
-00025d20: 696f 6e22 5d2c 0a20 2020 2020 2020 2020  ion"],.         
-00025d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d40: 2020 2022 7472 6163 6562 6163 6b22 3a20     "traceback": 
-00025d50: 6572 725b 2274 7261 6365 6261 636b 225d  err["traceback"]
-00025d60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00025d70: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00025d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025d90: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-00025da0: 6574 7572 6e0a 2020 2020 2020 2020 616e  eturn.        an
-00025db0: 6e6f 7461 7469 6f6e 7320 3d20 616e 6e6f  notations = anno
-00025dc0: 7461 7469 6f6e 7320 6f72 207b 7d0a 2020  tations or {}.  
-00025dd0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-00025de0: 6e63 6528 616e 6e6f 7461 7469 6f6e 732c  nce(annotations,
-00025df0: 2054 6f50 6963 6b6c 6529 3a20 2023 2074   ToPickle):  # t
-00025e00: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
-00025e10: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-00025e20: 2077 6861 7420 7468 6520 6865 636b 3f0a   what the heck?.
-00025e30: 2020 2020 2020 2020 2020 2020 616e 6e6f              anno
-00025e40: 7461 7469 6f6e 7320 3d20 616e 6e6f 7461  tations = annota
-00025e50: 7469 6f6e 732e 6461 7461 2020 2320 7479  tions.data  # ty
-00025e60: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-00025e70: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
-00025e80: 2073 7469 6d75 6c75 735f 6964 206f 7220   stimulus_id or 
-00025e90: 6622 7570 6461 7465 2d67 7261 7068 2d7b  f"update-graph-{
-00025ea0: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-00025eb0: 2028 0a20 2020 2020 2020 2020 2020 2064   (.            d
-00025ec0: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00025ed0: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
-00025ee0: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
-00025ef0: 616e 6e6f 7461 7469 6f6e 732c 0a20 2020  annotations,.   
-00025f00: 2020 2020 2020 2020 2070 7265 5f73 7472           pre_str
-00025f10: 696e 6769 6669 6564 5f6b 6579 732c 0a20  ingified_keys,. 
-00025f20: 2020 2020 2020 2029 203d 2073 656c 662e         ) = self.
-00025f30: 6d61 7465 7269 616c 697a 655f 6772 6170  materialize_grap
-00025f40: 6828 6772 6170 6829 0a0a 2020 2020 2020  h(graph)..      
-00025f50: 2020 7265 7175 6573 7465 645f 6b65 7973    requested_keys
-00025f60: 203d 2073 6574 286b 6579 7329 0a20 2020   = set(keys).   
-00025f70: 2020 2020 2064 656c 206b 6579 730a 2020       del keys.  
-00025f80: 2020 2020 2020 6966 206c 656e 2864 736b        if len(dsk
-00025f90: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
-00025fa0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
-00025fb0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00025fc0: 2020 205b 2261 6c6c 222c 2063 6c69 656e     ["all", clien
-00025fd0: 745d 2c20 7b22 6163 7469 6f6e 223a 2022  t], {"action": "
-00025fe0: 7570 6461 7465 5f67 7261 7068 222c 2022  update_graph", "
-00025ff0: 636f 756e 7422 3a20 6c65 6e28 6473 6b29  count": len(dsk)
-00026000: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
-00026010: 2020 2020 2020 2020 7365 6c66 2e5f 706f          self._po
-00026020: 705f 6b6e 6f77 6e5f 7461 736b 7328 6473  p_known_tasks(ds
-00026030: 6b2c 2064 6570 656e 6465 6e63 6965 7329  k, dependencies)
-00026040: 0a0a 2020 2020 2020 2020 6966 206c 6f73  ..        if los
-00026050: 745f 6b65 7973 203a 3d20 7365 6c66 2e5f  t_keys := self._
-00026060: 706f 705f 6c6f 7374 5f74 6173 6b73 2864  pop_lost_tasks(d
-00026070: 736b 2c20 6465 7065 6e64 656e 6369 6573  sk, dependencies
-00026080: 2c20 7265 7175 6573 7465 645f 6b65 7973  , requested_keys
-00026090: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-000260a0: 656c 662e 7265 706f 7274 287b 226f 7022  elf.report({"op"
-000260b0: 3a20 2263 616e 6365 6c6c 6564 2d6b 6579  : "cancelled-key
-000260c0: 7322 2c20 226b 6579 7322 3a20 6c6f 7374  s", "keys": lost
-000260d0: 5f6b 6579 737d 2c20 636c 6965 6e74 3d63  _keys}, client=c
-000260e0: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-000260f0: 2020 2073 656c 662e 636c 6965 6e74 5f72     self.client_r
-00026100: 656c 6561 7365 735f 6b65 7973 280a 2020  eleases_keys(.  
-00026110: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00026120: 7973 3d6c 6f73 745f 6b65 7973 2c20 636c  ys=lost_keys, cl
-00026130: 6965 6e74 3d63 6c69 656e 742c 2073 7469  ient=client, sti
-00026140: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00026150: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
-00026160: 2029 0a0a 2020 2020 2020 2020 6966 206e   )..        if n
-00026170: 6f74 2073 656c 662e 6973 5f69 646c 6520  ot self.is_idle 
-00026180: 616e 6420 7365 6c66 2e63 6f6d 7075 7461  and self.computa
-00026190: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-000261a0: 2020 2023 2053 7469 6c6c 2077 6f72 6b69     # Still worki
-000261b0: 6e67 206f 6e20 736f 6d65 7468 696e 672e  ng on something.
-000261c0: 2041 7373 6967 6e20 6e65 7720 7461 736b   Assign new task
-000261d0: 7320 746f 2073 616d 6520 636f 6d70 7574  s to same comput
-000261e0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
-000261f0: 2020 636f 6d70 7574 6174 696f 6e20 3d20    computation = 
-00026200: 7365 6c66 2e63 6f6d 7075 7461 7469 6f6e  self.computation
-00026210: 735b 2d31 5d0a 2020 2020 2020 2020 656c  s[-1].        el
-00026220: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00026230: 636f 6d70 7574 6174 696f 6e20 3d20 436f  computation = Co
-00026240: 6d70 7574 6174 696f 6e28 290a 2020 2020  mputation().    
-00026250: 2020 2020 2020 2020 7365 6c66 2e63 6f6d          self.com
-00026260: 7075 7461 7469 6f6e 732e 6170 7065 6e64  putations.append
-00026270: 2863 6f6d 7075 7461 7469 6f6e 290a 0a20  (computation).. 
-00026280: 2020 2020 2020 2069 6620 636f 6465 3a20         if code: 
-00026290: 2023 2061 6464 206e 6577 2063 6f64 6520   # add new code 
-000262a0: 626c 6f63 6b73 0a20 2020 2020 2020 2020  blocks.         
-000262b0: 2020 2063 6f6d 7075 7461 7469 6f6e 2e63     computation.c
-000262c0: 6f64 652e 6164 6428 636f 6465 290a 2020  ode.add(code).  
-000262d0: 2020 2020 2020 6966 2061 6e6e 6f74 6174        if annotat
-000262e0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-000262f0: 2020 636f 6d70 7574 6174 696f 6e2e 616e    computation.an
-00026300: 6e6f 7461 7469 6f6e 732e 7570 6461 7465  notations.update
-00026310: 2861 6e6e 6f74 6174 696f 6e73 290a 0a20  (annotations).. 
-00026320: 2020 2020 2020 2072 756e 6e61 626c 652c         runnable,
-00026330: 2074 6f75 6368 6564 5f74 6173 6b73 2c20   touched_tasks, 
-00026340: 6e65 775f 7461 736b 7320 3d20 7365 6c66  new_tasks = self
-00026350: 2e5f 6765 6e65 7261 7465 5f74 6173 6b73  ._generate_tasks
-00026360: 7461 7465 7328 0a20 2020 2020 2020 2020  tates(.         
-00026370: 2020 206b 6579 733d 7265 7175 6573 7465     keys=requeste
-00026380: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
-00026390: 2020 2020 6473 6b3d 6473 6b2c 0a20 2020      dsk=dsk,.   
-000263a0: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-000263b0: 6e63 6965 733d 6465 7065 6e64 656e 6369  ncies=dependenci
-000263c0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-000263d0: 636f 6d70 7574 6174 696f 6e3d 636f 6d70  computation=comp
-000263e0: 7574 6174 696f 6e2c 0a20 2020 2020 2020  utation,.       
-000263f0: 2029 0a20 2020 2020 2020 2023 2046 4958   ).        # FIX
-00026400: 4d45 3a20 5468 6573 6520 2272 6573 6f6c  ME: These "resol
-00026410: 7665 645f 616e 6e6f 7461 7469 6f6e 7322  ved_annotations"
-00026420: 2061 7265 2061 2062 6967 2064 7570 6c69   are a big dupli
-00026430: 6361 7469 6f6e 2061 6e64 2061 7265 206f  cation and are o
-00026440: 6e6c 790a 2020 2020 2020 2020 2320 7265  nly.        # re
-00026450: 7175 6972 6564 2074 6f20 7361 7469 7366  quired to satisf
-00026460: 7920 7468 6520 6375 7272 656e 7420 706c  y the current pl
-00026470: 7567 696e 2041 5049 2e20 5468 6973 2073  ugin API. This s
-00026480: 686f 756c 6420 6265 0a20 2020 2020 2020  hould be.       
-00026490: 2023 2072 6563 6f6e 7369 6465 7265 642e   # reconsidered.
-000264a0: 0a20 2020 2020 2020 2072 6573 6f6c 7665  .        resolve
-000264b0: 645f 616e 6e6f 7461 7469 6f6e 7320 3d20  d_annotations = 
-000264c0: 7365 6c66 2e5f 7061 7273 655f 616e 645f  self._parse_and_
-000264d0: 6170 706c 795f 616e 6e6f 7461 7469 6f6e  apply_annotation
-000264e0: 7328 0a20 2020 2020 2020 2020 2020 2074  s(.            t
-000264f0: 6173 6b73 3d6e 6577 5f74 6173 6b73 2c0a  asks=new_tasks,.
-00026500: 2020 2020 2020 2020 2020 2020 616e 6e6f              anno
-00026510: 7461 7469 6f6e 733d 616e 6e6f 7461 7469  tations=annotati
-00026520: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-00026530: 206c 6179 6572 5f61 6e6e 6f74 6174 696f   layer_annotatio
-00026540: 6e73 3d6c 6179 6572 5f61 6e6e 6f74 6174  ns=layer_annotat
-00026550: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
-00026560: 2020 7072 655f 7374 7269 6e67 6966 6965    pre_stringifie
-00026570: 645f 6b65 7973 3d70 7265 5f73 7472 696e  d_keys=pre_strin
-00026580: 6769 6669 6564 5f6b 6579 732c 0a20 2020  gified_keys,.   
-00026590: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-000265a0: 7365 6c66 2e5f 7365 745f 7072 696f 7269  self._set_priori
-000265b0: 7469 6573 280a 2020 2020 2020 2020 2020  ties(.          
-000265c0: 2020 696e 7465 726e 616c 5f70 7269 6f72    internal_prior
-000265d0: 6974 793d 696e 7465 726e 616c 5f70 7269  ity=internal_pri
-000265e0: 6f72 6974 792c 0a20 2020 2020 2020 2020  ority,.         
-000265f0: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
-00026600: 736b 3d73 7562 6d69 7474 696e 675f 7461  sk=submitting_ta
-00026610: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
-00026620: 7573 6572 5f70 7269 6f72 6974 793d 7573  user_priority=us
-00026630: 6572 5f70 7269 6f72 6974 792c 0a20 2020  er_priority,.   
-00026640: 2020 2020 2020 2020 2066 6966 6f5f 7469           fifo_ti
-00026650: 6d65 6f75 743d 6669 666f 5f74 696d 656f  meout=fifo_timeo
-00026660: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00026670: 7374 6172 743d 7374 6172 742c 0a20 2020  start=start,.   
-00026680: 2020 2020 2020 2020 2064 736b 3d64 736b           dsk=dsk
-00026690: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
-000266a0: 736b 733d 7275 6e6e 6162 6c65 2c0a 2020  sks=runnable,.  
-000266b0: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
-000266c0: 656e 6369 6573 3d64 6570 656e 6465 6e63  encies=dependenc
-000266d0: 6965 732c 0a20 2020 2020 2020 2029 0a0a  ies,.        )..
-000266e0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-000266f0: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
-00026700: 286b 6579 733d 7265 7175 6573 7465 645f  (keys=requested_
-00026710: 6b65 7973 2c20 636c 6965 6e74 3d63 6c69  keys, client=cli
-00026720: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
-00026730: 4164 6420 6163 746f 7273 0a20 2020 2020  Add actors.     
-00026740: 2020 2069 6620 6163 746f 7273 2069 7320     if actors is 
-00026750: 5472 7565 3a0a 2020 2020 2020 2020 2020  True:.          
-00026760: 2020 6163 746f 7273 203d 206c 6973 7428    actors = list(
-00026770: 7265 7175 6573 7465 645f 6b65 7973 290a  requested_keys).
-00026780: 2020 2020 2020 2020 666f 7220 6163 746f          for acto
-00026790: 7220 696e 2061 6374 6f72 7320 6f72 205b  r in actors or [
-000267a0: 5d3a 0a20 2020 2020 2020 2020 2020 2074  ]:.            t
-000267b0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b61  s = self.tasks[a
-000267c0: 6374 6f72 5d0a 2020 2020 2020 2020 2020  ctor].          
-000267d0: 2020 7473 2e61 6374 6f72 203d 2054 7275    ts.actor = Tru
-000267e0: 650a 0a20 2020 2020 2020 2023 2043 6f6d  e..        # Com
-000267f0: 7075 7465 2072 6563 6f6d 6d65 6e64 6174  pute recommendat
-00026800: 696f 6e73 0a20 2020 2020 2020 2072 6563  ions.        rec
-00026810: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-00026820: 6373 203d 207b 7d0a 2020 2020 2020 2020  cs = {}.        
-00026830: 7072 696f 7269 7479 203d 2064 6963 7428  priority = dict(
-00026840: 290a 2020 2020 2020 2020 666f 7220 7473  ).        for ts
-00026850: 2069 6e20 736f 7274 6564 280a 2020 2020   in sorted(.    
-00026860: 2020 2020 2020 2020 7275 6e6e 6162 6c65          runnable
-00026870: 2c0a 2020 2020 2020 2020 2020 2020 6b65  ,.            ke
-00026880: 793d 6f70 6572 6174 6f72 2e61 7474 7267  y=operator.attrg
-00026890: 6574 7465 7228 2270 7269 6f72 6974 7922  etter("priority"
-000268a0: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
-000268b0: 6576 6572 7365 3d54 7275 652c 0a20 2020  everse=True,.   
-000268c0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-000268d0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
-000268e0: 696f 7269 7479 2020 2320 6d79 7079 0a20  iority  # mypy. 
-000268f0: 2020 2020 2020 2020 2020 2070 7269 6f72             prior
-00026900: 6974 795b 7473 2e6b 6579 5d20 3d20 7473  ity[ts.key] = ts
-00026910: 2e70 7269 6f72 6974 790a 2020 2020 2020  .priority.      
-00026920: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00026930: 7275 6e5f 7370 6563 0a20 2020 2020 2020  run_spec.       
-00026940: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-00026950: 203d 3d20 2272 656c 6561 7365 6422 3a0a   == "released":.
-00026960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026970: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-00026980: 7473 2e6b 6579 5d20 3d20 2277 6169 7469  ts.key] = "waiti
-00026990: 6e67 220a 0a20 2020 2020 2020 2066 6f72  ng"..        for
-000269a0: 2074 7320 696e 2072 756e 6e61 626c 653a   ts in runnable:
-000269b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000269c0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-000269d0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-000269e0: 2020 2020 2020 2020 2069 6620 6474 732e           if dts.
-000269f0: 6578 6365 7074 696f 6e5f 626c 616d 653a  exception_blame:
-00026a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026a10: 2020 2020 2074 732e 6578 6365 7074 696f       ts.exceptio
-00026a20: 6e5f 626c 616d 6520 3d20 6474 732e 6578  n_blame = dts.ex
-00026a30: 6365 7074 696f 6e5f 626c 616d 650a 2020  ception_blame.  
-00026a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a50: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00026a60: 735b 7473 2e6b 6579 5d20 3d20 2265 7272  s[ts.key] = "err
-00026a70: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-00026a80: 2020 2020 2020 2020 6272 6561 6b0a 0a20          break.. 
-00026a90: 2020 2020 2020 2073 7061 6e73 5f65 7874         spans_ext
-00026aa0: 3a20 5370 616e 7353 6368 6564 756c 6572  : SpansScheduler
-00026ab0: 4578 7465 6e73 696f 6e20 7c20 4e6f 6e65  Extension | None
-00026ac0: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
-00026ad0: 6e73 2e67 6574 2822 7370 616e 7322 290a  ns.get("spans").
-00026ae0: 2020 2020 2020 2020 6966 2073 7061 6e73          if spans
-00026af0: 5f65 7874 3a0a 2020 2020 2020 2020 2020  _ext:.          
-00026b00: 2020 2320 6e65 775f 7461 736b 7320 646f    # new_tasks do
-00026b10: 6573 206e 6f74 206e 6563 6573 7361 7269  es not necessari
-00026b20: 6c79 2063 6f6e 7461 696e 2061 6c6c 2072  ly contain all r
-00026b30: 756e 6e61 626c 6520 7461 736b 733b 0a20  unnable tasks;. 
-00026b40: 2020 2020 2020 2020 2020 2023 205f 6765             # _ge
-00026b50: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
-00026b60: 7320 6973 206e 6f74 2074 6865 206f 6e6c  s is not the onl
-00026b70: 7920 7468 696e 6720 7468 6174 2063 616c  y thing that cal
-00026b80: 6c73 206e 6577 5f74 6173 6b28 292e 2041  ls new_task(). A
-00026b90: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00026ba0: 6173 6b53 7461 7465 206d 6179 2068 6176  askState may hav
-00026bb0: 6520 616c 736f 2062 6565 6e20 6372 6561  e also been crea
-00026bc0: 7465 6420 6279 2063 6c69 656e 745f 6465  ted by client_de
-00026bd0: 7369 7265 735f 6b65 7973 206f 7220 7363  sires_keys or sc
-00026be0: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
-00026bf0: 2020 2023 2061 6e64 206f 6e6c 7920 6c61     # and only la
-00026c00: 7465 7220 6761 696e 6564 2061 2072 756e  ter gained a run
-00026c10: 5f73 7065 632e 0a20 2020 2020 2020 2020  _spec..         
-00026c20: 2020 2073 7061 6e5f 616e 6e6f 7461 7469     span_annotati
-00026c30: 6f6e 7320 3d20 7370 616e 735f 6578 742e  ons = spans_ext.
-00026c40: 6f62 7365 7276 655f 7461 736b 7328 7275  observe_tasks(ru
-00026c50: 6e6e 6162 6c65 2c20 636f 6465 3d63 6f64  nnable, code=cod
-00026c60: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
-00026c70: 2049 6e20 6361 7365 206f 6620 5461 736b   In case of Task
-00026c80: 4772 6f75 7020 636f 6c6c 6973 696f 6e2c  Group collision,
-00026c90: 2073 7061 6e73 206d 6179 2068 6176 6520   spans may have 
-00026ca0: 6368 616e 6765 640a 2020 2020 2020 2020  changed.        
-00026cb0: 2020 2020 6966 2073 7061 6e5f 616e 6e6f      if span_anno
-00026cc0: 7461 7469 6f6e 733a 0a20 2020 2020 2020  tations:.       
-00026cd0: 2020 2020 2020 2020 2072 6573 6f6c 7665           resolve
-00026ce0: 645f 616e 6e6f 7461 7469 6f6e 735b 2273  d_annotations["s
-00026cf0: 7061 6e22 5d20 3d20 7370 616e 5f61 6e6e  pan"] = span_ann
-00026d00: 6f74 6174 696f 6e73 0a20 2020 2020 2020  otations.       
-00026d10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00026d20: 2020 2020 2020 2020 2020 2072 6573 6f6c             resol
-00026d30: 7665 645f 616e 6e6f 7461 7469 6f6e 732e  ved_annotations.
-00026d40: 706f 7028 2273 7061 6e22 2c20 4e6f 6e65  pop("span", None
-00026d50: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
-00026d60: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-00026d70: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-00026d80: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00026d90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00026da0: 2020 2020 2020 2070 6c75 6769 6e2e 7570         plugin.up
-00026db0: 6461 7465 5f67 7261 7068 280a 2020 2020  date_graph(.    
-00026dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026dd0: 7365 6c66 2c0a 2020 2020 2020 2020 2020  self,.          
-00026de0: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-00026df0: 3d63 6c69 656e 742c 0a20 2020 2020 2020  =client,.       
-00026e00: 2020 2020 2020 2020 2020 2020 2074 6173               tas
-00026e10: 6b73 3d5b 7473 2e6b 6579 2066 6f72 2074  ks=[ts.key for t
-00026e20: 7320 696e 2074 6f75 6368 6564 5f74 6173  s in touched_tas
-00026e30: 6b73 5d2c 0a20 2020 2020 2020 2020 2020  ks],.           
-00026e40: 2020 2020 2020 2020 206b 6579 733d 7265           keys=re
-00026e50: 7175 6573 7465 645f 6b65 7973 2c0a 2020  quested_keys,.  
-00026e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e70: 2020 6465 7065 6e64 656e 6369 6573 3d64    dependencies=d
-00026e80: 6570 656e 6465 6e63 6965 732c 0a20 2020  ependencies,.   
-00026e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ea0: 2061 6e6e 6f74 6174 696f 6e73 3d72 6573   annotations=res
-00026eb0: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
-00026ec0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00026ed0: 2020 2020 2020 2070 7269 6f72 6974 793d         priority=
-00026ee0: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
-00026ef0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00026f00: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-00026f10: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-00026f20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00026f30: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00026f40: 6529 0a0a 2020 2020 2020 2020 7365 6c66  e)..        self
-00026f50: 2e74 7261 6e73 6974 696f 6e73 2872 6563  .transitions(rec
-00026f60: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
-00026f70: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-00026f80: 2020 2020 666f 7220 7473 2069 6e20 746f      for ts in to
-00026f90: 7563 6865 645f 7461 736b 733a 0a20 2020  uched_tasks:.   
-00026fa0: 2020 2020 2020 2020 2069 6620 7473 2e73           if ts.s
-00026fb0: 7461 7465 2069 6e20 2822 6d65 6d6f 7279  tate in ("memory
-00026fc0: 222c 2022 6572 7265 6422 293a 0a20 2020  ", "erred"):.   
-00026fd0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00026fe0: 662e 7265 706f 7274 5f6f 6e5f 6b65 7928  f.report_on_key(
-00026ff0: 7473 3d74 732c 2063 6c69 656e 743d 636c  ts=ts, client=cl
-00027000: 6965 6e74 290a 0a20 2020 2020 2020 2065  ient)..        e
-00027010: 6e64 203d 2074 696d 6528 290a 2020 2020  nd = time().    
-00027020: 2020 2020 7365 6c66 2e64 6967 6573 745f      self.digest_
-00027030: 6d65 7472 6963 2822 7570 6461 7465 2d67  metric("update-g
-00027040: 7261 7068 2d64 7572 6174 696f 6e22 2c20  raph-duration", 
-00027050: 656e 6420 2d20 7374 6172 7429 0a0a 2020  end - start)..  
-00027060: 2020 6465 6620 5f67 656e 6572 6174 655f    def _generate_
-00027070: 7461 736b 7374 6174 6573 280a 2020 2020  taskstates(.    
-00027080: 2020 2020 7365 6c66 2c20 6b65 7973 3a20      self, keys: 
-00027090: 7365 745b 7374 725d 2c20 6473 6b3a 2064  set[str], dsk: d
-000270a0: 6963 742c 2064 6570 656e 6465 6e63 6965  ict, dependencie
-000270b0: 733a 2064 6963 742c 2063 6f6d 7075 7461  s: dict, computa
-000270c0: 7469 6f6e 3a20 436f 6d70 7574 6174 696f  tion: Computatio
-000270d0: 6e0a 2020 2020 2920 2d3e 2074 7570 6c65  n.    ) -> tuple
-000270e0: 3a0a 2020 2020 2020 2020 2320 4765 7420  :.        # Get 
-000270f0: 6f72 2063 7265 6174 6520 7461 736b 2073  or create task s
-00027100: 7461 7465 730a 2020 2020 2020 2020 7275  tates.        ru
-00027110: 6e6e 6162 6c65 203d 205b 5d0a 2020 2020  nnable = [].    
-00027120: 2020 2020 6e65 775f 7461 736b 7320 3d20      new_tasks = 
-00027130: 5b5d 0a20 2020 2020 2020 2073 7461 636b  [].        stack
-00027140: 203d 206c 6973 7428 6b65 7973 290a 2020   = list(keys).  
-00027150: 2020 2020 2020 746f 7563 6865 645f 6b65        touched_ke
-00027160: 7973 203d 2073 6574 2829 0a20 2020 2020  ys = set().     
-00027170: 2020 2074 6f75 6368 6564 5f74 6173 6b73     touched_tasks
-00027180: 203d 205b 5d0a 2020 2020 2020 2020 7768   = [].        wh
-00027190: 696c 6520 7374 6163 6b3a 0a20 2020 2020  ile stack:.     
-000271a0: 2020 2020 2020 206b 203d 2073 7461 636b         k = stack
-000271b0: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
-000271c0: 2020 2069 6620 6b20 696e 2074 6f75 6368     if k in touch
-000271d0: 6564 5f6b 6579 733a 0a20 2020 2020 2020  ed_keys:.       
-000271e0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-000271f0: 650a 2020 2020 2020 2020 2020 2020 7473  e.            ts
-00027200: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-00027210: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
-00027220: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
-00027230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027240: 7473 203d 2073 656c 662e 6e65 775f 7461  ts = self.new_ta
-00027250: 736b 286b 2c20 6473 6b2e 6765 7428 6b29  sk(k, dsk.get(k)
-00027260: 2c20 2272 656c 6561 7365 6422 2c20 636f  , "released", co
-00027270: 6d70 7574 6174 696f 6e3d 636f 6d70 7574  mputation=comput
-00027280: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
-00027290: 2020 2020 2020 206e 6577 5f74 6173 6b73         new_tasks
-000272a0: 2e61 7070 656e 6428 7473 290a 2020 2020  .append(ts).    
-000272b0: 2020 2020 2020 2020 656c 6966 206e 6f74          elif not
-000272c0: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
-000272d0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000272e0: 2e72 756e 5f73 7065 6320 3d20 6473 6b2e  .run_spec = dsk.
-000272f0: 6765 7428 6b29 0a0a 2020 2020 2020 2020  get(k)..        
-00027300: 2020 2020 6966 2074 732e 7275 6e5f 7370      if ts.run_sp
-00027310: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-00027320: 2020 2020 7275 6e6e 6162 6c65 2e61 7070      runnable.app
-00027330: 656e 6428 7473 290a 2020 2020 2020 2020  end(ts).        
-00027340: 2020 2020 746f 7563 6865 645f 6b65 7973      touched_keys
-00027350: 2e61 6464 286b 290a 2020 2020 2020 2020  .add(k).        
-00027360: 2020 2020 746f 7563 6865 645f 7461 736b      touched_task
-00027370: 732e 6170 7065 6e64 2874 7329 0a20 2020  s.append(ts).   
-00027380: 2020 2020 2020 2020 2073 7461 636b 2e65           stack.e
-00027390: 7874 656e 6428 6465 7065 6e64 656e 6369  xtend(dependenci
-000273a0: 6573 2e67 6574 286b 2c20 2829 2929 0a0a  es.get(k, ()))..
-000273b0: 2020 2020 2020 2020 2320 4164 6420 6465          # Add de
-000273c0: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
-000273d0: 2020 2066 6f72 206b 6579 2c20 6465 7073     for key, deps
-000273e0: 2069 6e20 6465 7065 6e64 656e 6369 6573   in dependencies
-000273f0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00027400: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00027410: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
-00027420: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00027430: 2069 7320 4e6f 6e65 206f 7220 7473 2e64   is None or ts.d
-00027440: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
-00027450: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00027460: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00027470: 2020 666f 7220 6465 7020 696e 2064 6570    for dep in dep
-00027480: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00027490: 2020 2064 7473 203d 2073 656c 662e 7461     dts = self.ta
-000274a0: 736b 735b 6465 705d 0a20 2020 2020 2020  sks[dep].       
-000274b0: 2020 2020 2020 2020 2074 732e 6164 645f           ts.add_
-000274c0: 6465 7065 6e64 656e 6379 2864 7473 290a  dependency(dts).
-000274d0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000274e0: 746f 7563 6865 645f 7461 736b 7329 203c  touched_tasks) <
-000274f0: 206c 656e 286b 6579 7329 3a0a 2020 2020   len(keys):.    
-00027500: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00027510: 6e66 6f28 0a20 2020 2020 2020 2020 2020  nfo(.           
-00027520: 2020 2020 2022 5375 626d 6974 7465 6420       "Submitted 
-00027530: 6772 6170 6820 7769 7468 206c 656e 6774  graph with lengt
-00027540: 6820 2573 2062 7574 2072 6571 7565 7374  h %s but request
-00027550: 6564 2067 7261 7068 206f 6e6c 7920 696e  ed graph only in
-00027560: 636c 7564 6573 2025 7320 6b65 7973 222c  cludes %s keys",
-00027570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027580: 206c 656e 2874 6f75 6368 6564 5f74 6173   len(touched_tas
-00027590: 6b73 292c 0a20 2020 2020 2020 2020 2020  ks),.           
-000275a0: 2020 2020 206c 656e 286b 6579 7329 2c0a       len(keys),.
-000275b0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000275c0: 2020 2020 2020 7265 7475 726e 2072 756e        return run
-000275d0: 6e61 626c 652c 2074 6f75 6368 6564 5f74  nable, touched_t
-000275e0: 6173 6b73 2c20 6e65 775f 7461 736b 730a  asks, new_tasks.
-000275f0: 0a20 2020 2064 6566 205f 7061 7273 655f  .    def _parse_
-00027600: 616e 645f 6170 706c 795f 616e 6e6f 7461  and_apply_annota
-00027610: 7469 6f6e 7328 0a20 2020 2020 2020 2073  tions(.        s
-00027620: 656c 662c 0a20 2020 2020 2020 2074 6173  elf,.        tas
-00027630: 6b73 3a20 4974 6572 6162 6c65 5b54 6173  ks: Iterable[Tas
-00027640: 6b53 7461 7465 5d2c 0a20 2020 2020 2020  kState],.       
-00027650: 2061 6e6e 6f74 6174 696f 6e73 3a20 6469   annotations: di
-00027660: 6374 2c0a 2020 2020 2020 2020 6c61 7965  ct,.        laye
-00027670: 725f 616e 6e6f 7461 7469 6f6e 733a 2064  r_annotations: d
-00027680: 6963 745b 7374 722c 2064 6963 745d 2c0a  ict[str, dict],.
-00027690: 2020 2020 2020 2020 7072 655f 7374 7269          pre_stri
-000276a0: 6e67 6966 6965 645f 6b65 7973 3a20 6469  ngified_keys: di
-000276b0: 6374 5b48 6173 6861 626c 652c 2073 7472  ct[Hashable, str
-000276c0: 5d2c 0a20 2020 2029 202d 3e20 6469 6374  ],.    ) -> dict
-000276d0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
-000276e0: 416e 795d 5d3a 0a20 2020 2020 2020 2022  Any]]:.        "
-000276f0: 2222 4170 706c 7920 7468 6520 7072 6f76  ""Apply the prov
-00027700: 6964 6564 2061 6e6e 6f74 6174 696f 6e73  ided annotations
-00027710: 2074 6f20 7468 6520 7072 6f76 6964 6564   to the provided
-00027720: 2060 5461 736b 5374 6174 6560 206f 626a   `TaskState` obj
-00027730: 6563 7473 2e0a 0a20 2020 2020 2020 2054  ects...        T
-00027740: 6865 2072 6177 2061 6e6e 6f74 6174 696f  he raw annotatio
-00027750: 6e73 2077 696c 6c20 6265 2073 746f 7265  ns will be store
-00027760: 6420 696e 2074 6865 2060 616e 6e6f 7461  d in the `annota
-00027770: 7469 6f6e 7360 2061 7474 7269 6275 7465  tions` attribute
-00027780: 2e0a 0a20 2020 2020 2020 204c 6179 6572  ...        Layer
-00027790: 202f 206b 6579 2073 7065 6369 6669 6320   / key specific 
-000277a0: 616e 6e6f 7461 7469 6f6e 7320 7769 6c6c  annotations will
-000277b0: 2074 616b 6520 7072 6563 6564 656e 6365   take precedence
-000277c0: 206f 7665 7220 676c 6f62 616c 202f 2067   over global / g
-000277d0: 656e 6572 6963 2061 6e6e 6f74 6174 696f  eneric annotatio
-000277e0: 6e73 2e0a 0a20 2020 2020 2020 2050 6172  ns...        Par
-000277f0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00027800: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00027810: 2020 2074 6173 6b73 203a 2049 7465 7261     tasks : Itera
-00027820: 626c 655b 5461 736b 5374 6174 655d 0a20  ble[TaskState]. 
-00027830: 2020 2020 2020 2020 2020 205f 6465 7363             _desc
-00027840: 7269 7074 696f 6e5f 0a20 2020 2020 2020  ription_.       
-00027850: 2061 6e6e 6f74 6174 696f 6e73 203a 2064   annotations : d
-00027860: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
-00027870: 5f64 6573 6372 6970 7469 6f6e 5f0a 2020  _description_.  
-00027880: 2020 2020 2020 6c61 7965 725f 616e 6e6f        layer_anno
-00027890: 7461 7469 6f6e 7320 3a20 6469 6374 5b73  tations : dict[s
-000278a0: 7472 2c20 6469 6374 5d0a 2020 2020 2020  tr, dict].      
-000278b0: 2020 2020 2020 5f64 6573 6372 6970 7469        _descripti
-000278c0: 6f6e 5f0a 0a20 2020 2020 2020 2052 6574  on_..        Ret
-000278d0: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
-000278e0: 2d2d 2d2d 0a20 2020 2020 2020 2072 6573  ----.        res
-000278f0: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
-00027900: 733a 2064 6963 740a 2020 2020 2020 2020  s: dict.        
-00027910: 2020 2020 4120 6d61 7070 696e 6720 6f66      A mapping of
-00027920: 2061 6c6c 2072 6573 6f6c 7665 6420 616e   all resolved an
-00027930: 6e6f 7461 7469 6f6e 7320 696e 2074 6865  notations in the
-00027940: 2066 6f72 6d61 743a 3a0a 0a20 2020 2020   format::..     
-00027950: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
-00027960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027970: 2022 616e 6e6f 7461 7469 6f6e 223a 207b   "annotation": {
-00027980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027990: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-000279a0: 7661 6c75 652c 0a20 2020 2020 2020 2020  value,.         
-000279b0: 2020 2020 2020 2020 2020 2020 2020 202e                 .
-000279c0: 2e2e 0a20 2020 2020 2020 2020 2020 2020  ...             
-000279d0: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-000279e0: 2020 2020 2020 2020 2020 2020 2020 2e2e                ..
-000279f0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00027a00: 2020 7d0a 2020 2020 2020 2020 2222 220a    }.        """.
-00027a10: 2020 2020 2020 2020 7265 736f 6c76 6564          resolved
-00027a20: 5f61 6e6e 6f74 6174 696f 6e73 3a20 6465  _annotations: de
-00027a30: 6661 756c 7464 6963 745b 7374 722c 2064  faultdict[str, d
-00027a40: 6963 745b 7374 722c 2041 6e79 5d5d 203d  ict[str, Any]] =
-00027a50: 2064 6566 6175 6c74 6469 6374 2864 6963   defaultdict(dic
-00027a60: 7429 0a20 2020 2020 2020 2066 6f72 2074  t).        for t
-00027a70: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
-00027a80: 2020 2020 2020 2020 6b65 7920 3d20 7473          key = ts
-00027a90: 2e6b 6579 0a20 2020 2020 2020 2020 2020  .key.           
-00027aa0: 2023 2054 6869 7320 636f 756c 6420 6265   # This could be
-00027ab0: 2061 2074 7970 6564 2064 6963 740a 2020   a typed dict.  
-00027ac0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00027ad0: 2061 6e6e 6f74 6174 696f 6e73 2061 6e64   annotations and
-00027ae0: 206b 6579 206e 6f74 2069 6e20 6c61 7965   key not in laye
-00027af0: 725f 616e 6e6f 7461 7469 6f6e 733a 0a20  r_annotations:. 
-00027b00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00027b10: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-00027b20: 2020 2020 6f75 7420 3d20 616e 6e6f 7461      out = annota
-00027b30: 7469 6f6e 732e 636f 7079 2829 0a20 2020  tions.copy().   
-00027b40: 2020 2020 2020 2020 206f 7574 2e75 7064           out.upd
-00027b50: 6174 6528 6c61 7965 725f 616e 6e6f 7461  ate(layer_annota
-00027b60: 7469 6f6e 732e 6765 7428 6b65 792c 207b  tions.get(key, {
-00027b70: 7d29 290a 2020 2020 2020 2020 2020 2020  })).            
-00027b80: 666f 7220 616e 6e6f 742c 2076 616c 7565  for annot, value
-00027b90: 2069 6e20 6f75 742e 6974 656d 7328 293a   in out.items():
-00027ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00027bb0: 2023 2050 6f70 2074 6865 206b 6579 2073   # Pop the key s
-00027bc0: 696e 6365 206e 616d 6573 2064 6f6e 2774  ince names don't
-00027bd0: 2061 6c77 6179 7320 6d61 7463 6820 6174   always match at
-00027be0: 7472 6962 7574 6573 0a20 2020 2020 2020  tributes.       
-00027bf0: 2020 2020 2020 2020 2069 6620 6361 6c6c           if call
-00027c00: 6162 6c65 2876 616c 7565 293a 0a20 2020  able(value):.   
-00027c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027c20: 2076 616c 7565 203d 2076 616c 7565 2870   value = value(p
-00027c30: 7265 5f73 7472 696e 6769 6669 6564 5f6b  re_stringified_k
-00027c40: 6579 735b 6b65 795d 290a 2020 2020 2020  eys[key]).      
-00027c50: 2020 2020 2020 2020 2020 6f75 745b 616e            out[an
-00027c60: 6e6f 745d 203d 2076 616c 7565 0a20 2020  not] = value.   
-00027c70: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00027c80: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
-00027c90: 735b 616e 6e6f 745d 5b6b 6579 5d20 3d20  s[annot][key] = 
-00027ca0: 7661 6c75 650a 0a20 2020 2020 2020 2020  value..         
-00027cb0: 2020 2020 2020 2069 6620 616e 6e6f 7420         if annot 
-00027cc0: 696e 2028 2272 6573 7472 6963 7469 6f6e  in ("restriction
-00027cd0: 7322 2c20 2277 6f72 6b65 7273 2229 3a0a  s", "workers"):.
-00027ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027cf0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
-00027d00: 7461 6e63 6528 7661 6c75 652c 2028 6c69  tance(value, (li
-00027d10: 7374 2c20 7475 706c 652c 2073 6574 2929  st, tuple, set))
-00027d20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00027d30: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
-00027d40: 3d20 5b76 616c 7565 5d0a 2020 2020 2020  = [value].      
-00027d50: 2020 2020 2020 2020 2020 2020 2020 686f                ho
-00027d60: 7374 5f72 6573 7472 6963 7469 6f6e 7320  st_restrictions 
-00027d70: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00027d80: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00027d90: 6572 5f72 6573 7472 6963 7469 6f6e 7320  er_restrictions 
-00027da0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-00027db0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00027dc0: 7720 696e 2076 616c 7565 3a0a 2020 2020  w in value:.    
-00027dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027de0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00027df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e00: 2020 2020 2077 203d 2073 656c 662e 636f       w = self.co
-00027e10: 6572 6365 5f61 6464 7265 7373 2877 290a  erce_address(w).
-00027e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e30: 2020 2020 2020 2020 6578 6365 7074 2056          except V
-00027e40: 616c 7565 4572 726f 723a 0a20 2020 2020  alueError:.     
-00027e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027e60: 2020 2020 2020 2023 204e 6f74 2061 2076         # Not a v
-00027e70: 616c 6964 2061 6464 7265 7373 2c20 6275  alid address, bu
-00027e80: 7420 7065 7268 6170 7320 6974 2773 2061  t perhaps it's a
-00027e90: 2068 6f73 746e 616d 650a 2020 2020 2020   hostname.      
+000201f0: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
+00020200: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e72  _plugin": self.r
+00020210: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
+00020220: 725f 706c 7567 696e 2c0a 2020 2020 2020  r_plugin,.      
+00020230: 2020 2020 2020 2272 6567 6973 7465 725f        "register_
+00020240: 776f 726b 6572 5f70 6c75 6769 6e22 3a20  worker_plugin": 
+00020250: 7365 6c66 2e72 6567 6973 7465 725f 776f  self.register_wo
+00020260: 726b 6572 5f70 6c75 6769 6e2c 0a20 2020  rker_plugin,.   
+00020270: 2020 2020 2020 2020 2022 756e 7265 6769           "unregi
+00020280: 7374 6572 5f77 6f72 6b65 725f 706c 7567  ster_worker_plug
+00020290: 696e 223a 2073 656c 662e 756e 7265 6769  in": self.unregi
+000202a0: 7374 6572 5f77 6f72 6b65 725f 706c 7567  ster_worker_plug
+000202b0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+000202c0: 2272 6567 6973 7465 725f 6e61 6e6e 795f  "register_nanny_
+000202d0: 706c 7567 696e 223a 2073 656c 662e 7265  plugin": self.re
+000202e0: 6769 7374 6572 5f6e 616e 6e79 5f70 6c75  gister_nanny_plu
+000202f0: 6769 6e2c 0a20 2020 2020 2020 2020 2020  gin,.           
+00020300: 2022 756e 7265 6769 7374 6572 5f6e 616e   "unregister_nan
+00020310: 6e79 5f70 6c75 6769 6e22 3a20 7365 6c66  ny_plugin": self
+00020320: 2e75 6e72 6567 6973 7465 725f 6e61 6e6e  .unregister_nann
+00020330: 795f 706c 7567 696e 2c0a 2020 2020 2020  y_plugin,.      
+00020340: 2020 2020 2020 2261 6461 7074 6976 655f        "adaptive_
+00020350: 7461 7267 6574 223a 2073 656c 662e 6164  target": self.ad
+00020360: 6170 7469 7665 5f74 6172 6765 742c 0a20  aptive_target,. 
+00020370: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+00020380: 6572 735f 746f 5f63 6c6f 7365 223a 2073  ers_to_close": s
+00020390: 656c 662e 776f 726b 6572 735f 746f 5f63  elf.workers_to_c
+000203a0: 6c6f 7365 2c0a 2020 2020 2020 2020 2020  lose,.          
+000203b0: 2020 2273 7562 7363 7269 6265 5f77 6f72    "subscribe_wor
+000203c0: 6b65 725f 7374 6174 7573 223a 2073 656c  ker_status": sel
+000203d0: 662e 7375 6273 6372 6962 655f 776f 726b  f.subscribe_work
+000203e0: 6572 5f73 7461 7475 732c 0a20 2020 2020  er_status,.     
+000203f0: 2020 2020 2020 2022 7374 6172 745f 7461         "start_ta
+00020400: 736b 5f6d 6574 6164 6174 6122 3a20 7365  sk_metadata": se
+00020410: 6c66 2e73 7461 7274 5f74 6173 6b5f 6d65  lf.start_task_me
+00020420: 7461 6461 7461 2c0a 2020 2020 2020 2020  tadata,.        
+00020430: 2020 2020 2273 746f 705f 7461 736b 5f6d      "stop_task_m
+00020440: 6574 6164 6174 6122 3a20 7365 6c66 2e73  etadata": self.s
+00020450: 746f 705f 7461 736b 5f6d 6574 6164 6174  top_task_metadat
+00020460: 612c 0a20 2020 2020 2020 2020 2020 2022  a,.            "
+00020470: 6765 745f 636c 7573 7465 725f 7374 6174  get_cluster_stat
+00020480: 6522 3a20 7365 6c66 2e67 6574 5f63 6c75  e": self.get_clu
+00020490: 7374 6572 5f73 7461 7465 2c0a 2020 2020  ster_state,.    
+000204a0: 2020 2020 2020 2020 2264 756d 705f 636c          "dump_cl
+000204b0: 7573 7465 725f 7374 6174 655f 746f 5f75  uster_state_to_u
+000204c0: 726c 223a 2073 656c 662e 6475 6d70 5f63  rl": self.dump_c
+000204d0: 6c75 7374 6572 5f73 7461 7465 5f74 6f5f  luster_state_to_
+000204e0: 7572 6c2c 0a20 2020 2020 2020 2020 2020  url,.           
+000204f0: 2022 6265 6e63 686d 6172 6b5f 6861 7264   "benchmark_hard
+00020500: 7761 7265 223a 2073 656c 662e 6265 6e63  ware": self.benc
+00020510: 686d 6172 6b5f 6861 7264 7761 7265 2c0a  hmark_hardware,.
+00020520: 2020 2020 2020 2020 2020 2020 2267 6574              "get
+00020530: 5f73 746f 7279 223a 2073 656c 662e 6765  _story": self.ge
+00020540: 745f 7374 6f72 792c 0a20 2020 2020 2020  t_story,.       
+00020550: 2020 2020 2022 6368 6563 6b5f 6964 6c65       "check_idle
+00020560: 223a 2073 656c 662e 6368 6563 6b5f 6964  ": self.check_id
+00020570: 6c65 2c0a 2020 2020 2020 2020 7d0a 0a20  le,.        }.. 
+00020580: 2020 2020 2020 2063 6f6e 6e65 6374 696f         connectio
+00020590: 6e5f 6c69 6d69 7420 3d20 6765 745f 6669  n_limit = get_fi
+000205a0: 6c65 6e6f 5f6c 696d 6974 2829 202f 2032  leno_limit() / 2
+000205b0: 0a0a 2020 2020 2020 2020 5363 6865 6475  ..        Schedu
+000205c0: 6c65 7253 7461 7465 2e5f 5f69 6e69 745f  lerState.__init_
+000205d0: 5f28 0a20 2020 2020 2020 2020 2020 2073  _(.            s
+000205e0: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+000205f0: 2061 6c69 6173 6573 3d61 6c69 6173 6573   aliases=aliases
+00020600: 2c0a 2020 2020 2020 2020 2020 2020 636c  ,.            cl
+00020610: 6965 6e74 733d 636c 6965 6e74 732c 0a20  ients=clients,. 
+00020620: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00020630: 7273 3d77 6f72 6b65 7273 2c0a 2020 2020  rs=workers,.    
+00020640: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+00020650: 6f3d 686f 7374 5f69 6e66 6f2c 0a20 2020  o=host_info,.   
+00020660: 2020 2020 2020 2020 2072 6573 6f75 7263           resourc
+00020670: 6573 3d72 6573 6f75 7263 6573 2c0a 2020  es=resources,.  
+00020680: 2020 2020 2020 2020 2020 7461 736b 733d            tasks=
+00020690: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
+000206a0: 2020 2075 6e72 756e 6e61 626c 653d 756e     unrunnable=un
+000206b0: 7275 6e6e 6162 6c65 2c0a 2020 2020 2020  runnable,.      
+000206c0: 2020 2020 2020 7175 6575 6564 3d71 7565        queued=que
+000206d0: 7565 642c 0a20 2020 2020 2020 2020 2020  ued,.           
+000206e0: 2076 616c 6964 6174 653d 7661 6c69 6461   validate=valida
+000206f0: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+00020700: 706c 7567 696e 733d 706c 7567 696e 732c  plugins=plugins,
+00020710: 0a20 2020 2020 2020 2020 2020 2074 7261  .            tra
+00020720: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+00020730: 6d61 783d 7472 616e 7369 7469 6f6e 5f63  max=transition_c
+00020740: 6f75 6e74 6572 5f6d 6178 2c0a 2020 2020  ounter_max,.    
+00020750: 2020 2020 290a 2020 2020 2020 2020 5365      ).        Se
+00020760: 7276 6572 4e6f 6465 2e5f 5f69 6e69 745f  rverNode.__init_
+00020770: 5f28 0a20 2020 2020 2020 2020 2020 2073  _(.            s
+00020780: 656c 662c 0a20 2020 2020 2020 2020 2020  elf,.           
+00020790: 2068 616e 646c 6572 733d 7365 6c66 2e68   handlers=self.h
+000207a0: 616e 646c 6572 732c 0a20 2020 2020 2020  andlers,.       
+000207b0: 2020 2020 2073 7472 6561 6d5f 6861 6e64       stream_hand
+000207c0: 6c65 7273 3d6d 6572 6765 2877 6f72 6b65  lers=merge(worke
+000207d0: 725f 6861 6e64 6c65 7273 2c20 636c 6965  r_handlers, clie
+000207e0: 6e74 5f68 616e 646c 6572 7329 2c0a 2020  nt_handlers),.  
+000207f0: 2020 2020 2020 2020 2020 636f 6e6e 6563            connec
+00020800: 7469 6f6e 5f6c 696d 6974 3d63 6f6e 6e65  tion_limit=conne
+00020810: 6374 696f 6e5f 6c69 6d69 742c 0a20 2020  ction_limit,.   
+00020820: 2020 2020 2020 2020 2064 6573 6572 6961           deseria
+00020830: 6c69 7a65 3d46 616c 7365 2c0a 2020 2020  lize=False,.    
+00020840: 2020 2020 2020 2020 636f 6e6e 6563 7469          connecti
+00020850: 6f6e 5f61 7267 733d 7365 6c66 2e63 6f6e  on_args=self.con
+00020860: 6e65 6374 696f 6e5f 6172 6773 2c0a 2020  nection_args,.  
+00020870: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
+00020880: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
+00020890: 2020 2020 2020 2069 6620 7365 6c66 2e77         if self.w
+000208a0: 6f72 6b65 725f 7474 6c3a 0a20 2020 2020  orker_ttl:.     
+000208b0: 2020 2020 2020 2070 6320 3d20 5065 7269         pc = Peri
+000208c0: 6f64 6963 4361 6c6c 6261 636b 2873 656c  odicCallback(sel
+000208d0: 662e 6368 6563 6b5f 776f 726b 6572 5f74  f.check_worker_t
+000208e0: 746c 2c20 7365 6c66 2e77 6f72 6b65 725f  tl, self.worker_
+000208f0: 7474 6c20 2a20 3130 3030 290a 2020 2020  ttl * 1000).    
+00020900: 2020 2020 2020 2020 7365 6c66 2e70 6572          self.per
+00020910: 696f 6469 635f 6361 6c6c 6261 636b 735b  iodic_callbacks[
+00020920: 2277 6f72 6b65 722d 7474 6c22 5d20 3d20  "worker-ttl"] = 
+00020930: 7063 0a0a 2020 2020 2020 2020 7063 203d  pc..        pc =
+00020940: 2050 6572 696f 6469 6343 616c 6c62 6163   PeriodicCallbac
+00020950: 6b28 7365 6c66 2e63 6865 636b 5f69 646c  k(self.check_idl
+00020960: 652c 2028 7365 6c66 2e69 646c 655f 7469  e, (self.idle_ti
+00020970: 6d65 6f75 7420 6f72 2031 2920 2a20 3130  meout or 1) * 10
+00020980: 3030 202f 2034 290a 2020 2020 2020 2020  00 / 4).        
+00020990: 7365 6c66 2e70 6572 696f 6469 635f 6361  self.periodic_ca
+000209a0: 6c6c 6261 636b 735b 2269 646c 652d 7469  llbacks["idle-ti
+000209b0: 6d65 6f75 7422 5d20 3d20 7063 0a0a 2020  meout"] = pc..  
+000209c0: 2020 2020 2020 6966 2065 7874 656e 7369        if extensi
+000209d0: 6f6e 7320 6973 204e 6f6e 653a 0a20 2020  ons is None:.   
+000209e0: 2020 2020 2020 2020 2065 7874 656e 7369           extensi
+000209f0: 6f6e 7320 3d20 4445 4641 554c 545f 4558  ons = DEFAULT_EX
+00020a00: 5445 4e53 494f 4e53 2e63 6f70 7928 290a  TENSIONS.copy().
+00020a10: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00020a20: 6f74 2064 6173 6b2e 636f 6e66 6967 2e67  ot dask.config.g
+00020a30: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00020a40: 7363 6865 6475 6c65 722e 776f 726b 2d73  scheduler.work-s
+00020a50: 7465 616c 696e 6722 293a 0a20 2020 2020  tealing"):.     
+00020a60: 2020 2020 2020 2020 2020 2069 6620 2273             if "s
+00020a70: 7465 616c 696e 6722 2069 6e20 6578 7465  tealing" in exte
+00020a80: 6e73 696f 6e73 3a0a 2020 2020 2020 2020  nsions:.        
+00020a90: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00020aa0: 6578 7465 6e73 696f 6e73 5b22 7374 6561  extensions["stea
+00020ab0: 6c69 6e67 225d 0a0a 2020 2020 2020 2020  ling"]..        
+00020ac0: 666f 7220 6e61 6d65 2c20 6578 7465 6e73  for name, extens
+00020ad0: 696f 6e20 696e 2065 7874 656e 7369 6f6e  ion in extension
+00020ae0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00020af0: 2020 2020 2020 2073 656c 662e 6578 7465         self.exte
+00020b00: 6e73 696f 6e73 5b6e 616d 655d 203d 2065  nsions[name] = e
+00020b10: 7874 656e 7369 6f6e 2873 656c 6629 0a0a  xtension(self)..
+00020b20: 2020 2020 2020 2020 7365 7470 726f 6374          setproct
+00020b30: 6974 6c65 2822 6461 736b 2073 6368 6564  itle("dask sched
+00020b40: 756c 6572 205b 6e6f 7420 7374 6172 7465  uler [not starte
+00020b50: 645d 2229 0a20 2020 2020 2020 2053 6368  d]").        Sch
+00020b60: 6564 756c 6572 2e5f 696e 7374 616e 6365  eduler._instance
+00020b70: 732e 6164 6428 7365 6c66 290a 2020 2020  s.add(self).    
+00020b80: 2020 2020 7365 6c66 2e72 7063 2e61 6c6c      self.rpc.all
+00020b90: 6f77 5f6f 6666 6c6f 6164 203d 2046 616c  ow_offload = Fal
+00020ba0: 7365 0a0a 2020 2020 2323 2323 2323 2323  se..    ########
+00020bb0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00020bc0: 2041 646d 696e 6973 7472 6174 696f 6e20   Administration 
+00020bd0: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
+00020be0: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
+00020bf0: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00020c00: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00020c10: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+00020c20: 223c 5363 6865 6475 6c65 7220 7b73 656c  "<Scheduler {sel
+00020c30: 662e 6164 6472 6573 735f 7361 6665 2172  f.address_safe!r
+00020c40: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
+00020c50: 2066 2277 6f72 6b65 7273 3a20 7b6c 656e   f"workers: {len
+00020c60: 2873 656c 662e 776f 726b 6572 7329 7d2c  (self.workers)},
+00020c70: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00020c80: 2263 6f72 6573 3a20 7b73 656c 662e 746f  "cores: {self.to
+00020c90: 7461 6c5f 6e74 6872 6561 6473 7d2c 2022  tal_nthreads}, "
+00020ca0: 0a20 2020 2020 2020 2020 2020 2066 2274  .            f"t
+00020cb0: 6173 6b73 3a20 7b6c 656e 2873 656c 662e  asks: {len(self.
+00020cc0: 7461 736b 7329 7d3e 220a 2020 2020 2020  tasks)}>".      
+00020cd0: 2020 290a 0a20 2020 2064 6566 205f 7265    )..    def _re
+00020ce0: 7072 5f68 746d 6c5f 2873 656c 6629 3a0a  pr_html_(self):.
+00020cf0: 2020 2020 2020 2020 7265 7475 726e 2067          return g
+00020d00: 6574 5f74 656d 706c 6174 6528 2273 6368  et_template("sch
+00020d10: 6564 756c 6572 2e68 746d 6c2e 6a32 2229  eduler.html.j2")
+00020d20: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
+00020d30: 2020 2020 2061 6464 7265 7373 3d73 656c       address=sel
+00020d40: 662e 6164 6472 6573 732c 0a20 2020 2020  f.address,.     
+00020d50: 2020 2020 2020 2077 6f72 6b65 7273 3d73         workers=s
+00020d60: 656c 662e 776f 726b 6572 732c 0a20 2020  elf.workers,.   
+00020d70: 2020 2020 2020 2020 2074 6872 6561 6473           threads
+00020d80: 3d73 656c 662e 746f 7461 6c5f 6e74 6872  =self.total_nthr
+00020d90: 6561 6473 2c0a 2020 2020 2020 2020 2020  eads,.          
+00020da0: 2020 7461 736b 733d 7365 6c66 2e74 6173    tasks=self.tas
+00020db0: 6b73 2c0a 2020 2020 2020 2020 290a 0a20  ks,.        ).. 
+00020dc0: 2020 2064 6566 2069 6465 6e74 6974 7928     def identity(
+00020dd0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00020de0: 2222 4261 7369 6320 696e 666f 726d 6174  ""Basic informat
+00020df0: 696f 6e20 6162 6f75 7420 6f75 7273 656c  ion about oursel
+00020e00: 7665 7320 616e 6420 6f75 7220 636c 7573  ves and our clus
+00020e10: 7465 7222 2222 0a20 2020 2020 2020 2064  ter""".        d
+00020e20: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00020e30: 2022 7479 7065 223a 2074 7970 6528 7365   "type": type(se
+00020e40: 6c66 292e 5f5f 6e61 6d65 5f5f 2c0a 2020  lf).__name__,.  
+00020e50: 2020 2020 2020 2020 2020 2269 6422 3a20            "id": 
+00020e60: 7374 7228 7365 6c66 2e69 6429 2c0a 2020  str(self.id),.  
+00020e70: 2020 2020 2020 2020 2020 2261 6464 7265            "addre
+00020e80: 7373 223a 2073 656c 662e 6164 6472 6573  ss": self.addres
+00020e90: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00020ea0: 7365 7276 6963 6573 223a 207b 6b65 793a  services": {key:
+00020eb0: 2076 2e70 6f72 7420 666f 7220 286b 6579   v.port for (key
+00020ec0: 2c20 7629 2069 6e20 7365 6c66 2e73 6572  , v) in self.ser
+00020ed0: 7669 6365 732e 6974 656d 7328 297d 2c0a  vices.items()},.
+00020ee0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00020ef0: 7274 6564 223a 2073 656c 662e 7469 6d65  rted": self.time
+00020f00: 5f73 7461 7274 6564 2c0a 2020 2020 2020  _started,.      
+00020f10: 2020 2020 2020 2277 6f72 6b65 7273 223a        "workers":
+00020f20: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00020f30: 2020 2077 6f72 6b65 722e 6164 6472 6573     worker.addres
+00020f40: 733a 2077 6f72 6b65 722e 6964 656e 7469  s: worker.identi
+00020f50: 7479 2829 2066 6f72 2077 6f72 6b65 7220  ty() for worker 
+00020f60: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+00020f70: 7661 6c75 6573 2829 0a20 2020 2020 2020  values().       
+00020f80: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+00020f90: 7d0a 2020 2020 2020 2020 7265 7475 726e  }.        return
+00020fa0: 2064 0a0a 2020 2020 6465 6620 5f74 6f5f   d..    def _to_
+00020fb0: 6469 6374 2873 656c 662c 202a 2c20 6578  dict(self, *, ex
+00020fc0: 636c 7564 653a 2043 6f6e 7461 696e 6572  clude: Container
+00020fd0: 5b73 7472 5d20 3d20 2829 2920 2d3e 2064  [str] = ()) -> d
+00020fe0: 6963 743a 0a20 2020 2020 2020 2022 2222  ict:.        """
+00020ff0: 4469 6374 696f 6e61 7279 2072 6570 7265  Dictionary repre
+00021000: 7365 6e74 6174 696f 6e20 666f 7220 6465  sentation for de
+00021010: 6275 6767 696e 6720 7075 7270 6f73 6573  bugging purposes
+00021020: 2e0a 2020 2020 2020 2020 4e6f 7420 7479  ..        Not ty
+00021030: 7065 2073 7461 626c 6520 616e 6420 6e6f  pe stable and no
+00021040: 7420 696e 7465 6e64 6564 2066 6f72 2072  t intended for r
+00021050: 6f75 6e64 7472 6970 732e 0a0a 2020 2020  oundtrips...    
+00021060: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00021070: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00021080: 2020 2020 2020 5365 7276 6572 2e69 6465        Server.ide
+00021090: 6e74 6974 790a 2020 2020 2020 2020 436c  ntity.        Cl
+000210a0: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
+000210b0: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
+000210c0: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
+000210d0: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
+000210e0: 6963 740a 2020 2020 2020 2020 2222 220a  ict.        """.
+000210f0: 2020 2020 2020 2020 696e 666f 203d 2073          info = s
+00021100: 7570 6572 2829 2e5f 746f 5f64 6963 7428  uper()._to_dict(
+00021110: 6578 636c 7564 653d 6578 636c 7564 6529  exclude=exclude)
+00021120: 0a20 2020 2020 2020 2065 7874 7261 203d  .        extra =
+00021130: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+00021140: 7472 616e 7369 7469 6f6e 5f6c 6f67 223a  transition_log":
+00021150: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+00021160: 5f6c 6f67 2c0a 2020 2020 2020 2020 2020  _log,.          
+00021170: 2020 2274 7261 6e73 6974 696f 6e5f 636f    "transition_co
+00021180: 756e 7465 7222 3a20 7365 6c66 2e74 7261  unter": self.tra
+00021190: 6e73 6974 696f 6e5f 636f 756e 7465 722c  nsition_counter,
+000211a0: 0a20 2020 2020 2020 2020 2020 2022 7461  .            "ta
+000211b0: 736b 7322 3a20 7365 6c66 2e74 6173 6b73  sks": self.tasks
+000211c0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+000211d0: 6173 6b5f 6772 6f75 7073 223a 2073 656c  ask_groups": sel
+000211e0: 662e 7461 736b 5f67 726f 7570 732c 0a20  f.task_groups,. 
+000211f0: 2020 2020 2020 2020 2020 2023 204f 7665             # Ove
+00021200: 7277 7269 7465 2064 6963 7420 6f66 2057  rwrite dict of W
+00021210: 6f72 6b65 7253 7461 7465 2e69 6465 6e74  orkerState.ident
+00021220: 6974 7920 6672 6f6d 2069 6e66 6f0a 2020  ity from info.  
+00021230: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+00021240: 7273 223a 2073 656c 662e 776f 726b 6572  rs": self.worker
+00021250: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00021260: 636c 6965 6e74 7322 3a20 7365 6c66 2e63  clients": self.c
+00021270: 6c69 656e 7473 2c0a 2020 2020 2020 2020  lients,.        
+00021280: 2020 2020 226d 656d 6f72 7922 3a20 7365      "memory": se
+00021290: 6c66 2e6d 656d 6f72 792c 0a20 2020 2020  lf.memory,.     
+000212a0: 2020 2020 2020 2022 6576 656e 7473 223a         "events":
+000212b0: 2073 656c 662e 6576 656e 7473 2c0a 2020   self.events,.  
+000212c0: 2020 2020 2020 2020 2020 2265 7874 656e            "exten
+000212d0: 7369 6f6e 7322 3a20 7365 6c66 2e65 7874  sions": self.ext
+000212e0: 656e 7369 6f6e 732c 0a20 2020 2020 2020  ensions,.       
+000212f0: 207d 0a20 2020 2020 2020 2065 7874 7261   }.        extra
+00021300: 203d 207b 6b3a 2076 2066 6f72 206b 2c20   = {k: v for k, 
+00021310: 7620 696e 2065 7874 7261 2e69 7465 6d73  v in extra.items
+00021320: 2829 2069 6620 6b20 6e6f 7420 696e 2065  () if k not in e
+00021330: 7863 6c75 6465 7d0a 2020 2020 2020 2020  xclude}.        
+00021340: 696e 666f 2e75 7064 6174 6528 7265 6375  info.update(recu
+00021350: 7273 6976 655f 746f 5f64 6963 7428 6578  rsive_to_dict(ex
+00021360: 7472 612c 2065 7863 6c75 6465 3d65 7863  tra, exclude=exc
+00021370: 6c75 6465 2929 0a20 2020 2020 2020 2072  lude)).        r
+00021380: 6574 7572 6e20 696e 666f 0a0a 2020 2020  eturn info..    
+00021390: 6173 796e 6320 6465 6620 6765 745f 636c  async def get_cl
+000213a0: 7573 7465 725f 7374 6174 6528 0a20 2020  uster_state(.   
+000213b0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000213c0: 2020 2065 7863 6c75 6465 3a20 2243 6f6c     exclude: "Col
+000213d0: 6c65 6374 696f 6e5b 7374 725d 222c 0a20  lection[str]",. 
+000213e0: 2020 2029 202d 3e20 6469 6374 3a0a 2020     ) -> dict:.  
+000213f0: 2020 2020 2020 2250 726f 6475 6365 2074        "Produce t
+00021400: 6865 2073 7461 7465 2064 6963 7420 7573  he state dict us
+00021410: 6564 2069 6e20 6120 636c 7573 7465 7220  ed in a cluster 
+00021420: 7374 6174 6520 6475 6d70 220a 2020 2020  state dump".    
+00021430: 2020 2020 2320 4b69 636b 206f 6666 2073      # Kick off s
+00021440: 7461 7465 2d64 756d 7069 6e67 206f 6e20  tate-dumping on 
+00021450: 776f 726b 6572 7320 6265 666f 7265 2077  workers before w
+00021460: 6520 626c 6f63 6b20 7468 6520 6576 656e  e block the even
+00021470: 7420 6c6f 6f70 2069 6e20 6073 656c 662e  t loop in `self.
+00021480: 5f74 6f5f 6469 6374 602e 0a20 2020 2020  _to_dict`..     
+00021490: 2020 2077 6f72 6b65 7273 5f66 7574 7572     workers_futur
+000214a0: 6520 3d20 6173 796e 6369 6f2e 6761 7468  e = asyncio.gath
+000214b0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+000214c0: 7365 6c66 2e62 726f 6164 6361 7374 280a  self.broadcast(.
+000214d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000214e0: 6d73 673d 7b22 6f70 223a 2022 6475 6d70  msg={"op": "dump
+000214f0: 5f73 7461 7465 222c 2022 6578 636c 7564  _state", "exclud
+00021500: 6522 3a20 6578 636c 7564 657d 2c0a 2020  e": exclude},.  
+00021510: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+00021520: 5f65 7272 6f72 3d22 7265 7475 726e 222c  _error="return",
+00021530: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00021540: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00021550: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
+00021560: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
+00021570: 7b22 6f70 223a 2022 7665 7273 696f 6e73  {"op": "versions
+00021580: 227d 2c0a 2020 2020 2020 2020 2020 2020  "},.            
+00021590: 2020 2020 6f6e 5f65 7272 6f72 3d22 6967      on_error="ig
+000215a0: 6e6f 7265 222c 0a20 2020 2020 2020 2020  nore",.         
+000215b0: 2020 2029 2c0a 2020 2020 2020 2020 290a     ),.        ).
+000215c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000215d0: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
+000215e0: 6572 5f73 7461 7465 203d 2073 656c 662e  er_state = self.
+000215f0: 5f74 6f5f 6469 6374 2865 7863 6c75 6465  _to_dict(exclude
+00021600: 3d65 7863 6c75 6465 290a 0a20 2020 2020  =exclude)..     
+00021610: 2020 2020 2020 2077 6f72 6b65 725f 7374         worker_st
+00021620: 6174 6573 2c20 776f 726b 6572 5f76 6572  ates, worker_ver
+00021630: 7369 6f6e 7320 3d20 6177 6169 7420 776f  sions = await wo
+00021640: 726b 6572 735f 6675 7475 7265 0a20 2020  rkers_future.   
+00021650: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
+00021660: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+00021670: 7265 2074 6865 2074 6173 6b73 2061 7265  re the tasks are
+00021680: 6e27 7420 6c65 6674 2072 756e 6e69 6e67  n't left running
+00021690: 2069 6620 616e 7974 6869 6e67 2066 6169   if anything fai
+000216a0: 6c73 2e0a 2020 2020 2020 2020 2020 2020  ls..            
+000216b0: 2320 536f 6d65 6461 7920 2870 7933 2e31  # Someday (py3.1
+000216c0: 3129 2c20 7573 6520 6120 7472 696f 2d73  1), use a trio-s
+000216d0: 7479 6c65 2054 6173 6b47 726f 7570 2066  tyle TaskGroup f
+000216e0: 6f72 2074 6869 732e 0a20 2020 2020 2020  or this..       
+000216f0: 2020 2020 2077 6f72 6b65 7273 5f66 7574       workers_fut
+00021700: 7572 652e 6361 6e63 656c 2829 0a0a 2020  ure.cancel()..  
+00021710: 2020 2020 2020 2320 436f 6e76 6572 7420        # Convert 
+00021720: 616e 7920 5250 4320 6572 726f 7273 2074  any RPC errors t
+00021730: 6f20 7374 7269 6e67 730a 2020 2020 2020  o strings.      
+00021740: 2020 776f 726b 6572 5f73 7461 7465 7320    worker_states 
+00021750: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00021760: 6b3a 2072 6570 7228 7629 2069 6620 6973  k: repr(v) if is
+00021770: 696e 7374 616e 6365 2876 2c20 4578 6365  instance(v, Exce
+00021780: 7074 696f 6e29 2065 6c73 6520 760a 2020  ption) else v.  
+00021790: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
+000217a0: 2076 2069 6e20 776f 726b 6572 5f73 7461   v in worker_sta
+000217b0: 7465 732e 6974 656d 7328 290a 2020 2020  tes.items().    
+000217c0: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
+000217d0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+000217e0: 2020 2020 2273 6368 6564 756c 6572 223a      "scheduler":
+000217f0: 2073 6368 6564 756c 6572 5f73 7461 7465   scheduler_state
+00021800: 2c0a 2020 2020 2020 2020 2020 2020 2277  ,.            "w
+00021810: 6f72 6b65 7273 223a 2077 6f72 6b65 725f  orkers": worker_
+00021820: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00021830: 2020 2020 2276 6572 7369 6f6e 7322 3a20      "versions": 
+00021840: 7b22 7363 6865 6475 6c65 7222 3a20 7365  {"scheduler": se
+00021850: 6c66 2e76 6572 7369 6f6e 7328 292c 2022  lf.versions(), "
+00021860: 776f 726b 6572 7322 3a20 776f 726b 6572  workers": worker
+00021870: 5f76 6572 7369 6f6e 737d 2c0a 2020 2020  _versions},.    
+00021880: 2020 2020 7d0a 0a20 2020 2061 7379 6e63      }..    async
+00021890: 2064 6566 2064 756d 705f 636c 7573 7465   def dump_cluste
+000218a0: 725f 7374 6174 655f 746f 5f75 726c 280a  r_state_to_url(.
+000218b0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000218c0: 2020 2020 2020 7572 6c3a 2073 7472 2c0a        url: str,.
+000218d0: 2020 2020 2020 2020 6578 636c 7564 653a          exclude:
+000218e0: 2022 436f 6c6c 6563 7469 6f6e 5b73 7472   "Collection[str
+000218f0: 5d22 2c0a 2020 2020 2020 2020 666f 726d  ]",.        form
+00021900: 6174 3a20 4c69 7465 7261 6c5b 226d 7367  at: Literal["msg
+00021910: 7061 636b 222c 2022 7961 6d6c 225d 2c0a  pack", "yaml"],.
+00021920: 2020 2020 2020 2020 2a2a 7374 6f72 6167          **storag
+00021930: 655f 6f70 7469 6f6e 733a 2064 6963 745b  e_options: dict[
+00021940: 7374 722c 2041 6e79 5d2c 0a20 2020 2029  str, Any],.    )
+00021950: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00021960: 2020 2257 7269 7465 2061 2063 6c75 7374    "Write a clust
+00021970: 6572 2073 7461 7465 2064 756d 7020 746f  er state dump to
+00021980: 2061 6e20 6673 7370 6563 2d63 6f6d 7061   an fsspec-compa
+00021990: 7469 626c 6520 5552 4c2e 220a 2020 2020  tible URL.".    
+000219a0: 2020 2020 6177 6169 7420 636c 7573 7465      await cluste
+000219b0: 725f 6475 6d70 2e77 7269 7465 5f73 7461  r_dump.write_sta
+000219c0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+000219d0: 7061 7274 6961 6c28 7365 6c66 2e67 6574  partial(self.get
+000219e0: 5f63 6c75 7374 6572 5f73 7461 7465 2c20  _cluster_state, 
+000219f0: 6578 636c 7564 6529 2c20 7572 6c2c 2066  exclude), url, f
+00021a00: 6f72 6d61 742c 202a 2a73 746f 7261 6765  ormat, **storage
+00021a10: 5f6f 7074 696f 6e73 0a20 2020 2020 2020  _options.       
+00021a20: 2029 0a0a 2020 2020 6465 6620 6765 745f   )..    def get_
+00021a30: 776f 726b 6572 5f73 6572 7669 6365 5f61  worker_service_a
+00021a40: 6464 7228 0a20 2020 2020 2020 2073 656c  ddr(.        sel
+00021a50: 662c 2077 6f72 6b65 723a 2073 7472 2c20  f, worker: str, 
+00021a60: 7365 7276 6963 655f 6e61 6d65 3a20 7374  service_name: st
+00021a70: 722c 2070 726f 746f 636f 6c3a 2062 6f6f  r, protocol: boo
+00021a80: 6c20 3d20 4661 6c73 650a 2020 2020 2920  l = False.    ) 
+00021a90: 2d3e 2074 7570 6c65 5b73 7472 2c20 696e  -> tuple[str, in
+00021aa0: 745d 207c 2073 7472 207c 204e 6f6e 653a  t] | str | None:
+00021ab0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00021ac0: 2020 2020 2047 6574 2074 6865 2028 686f       Get the (ho
+00021ad0: 7374 2c20 706f 7274 2920 6164 6472 6573  st, port) addres
+00021ae0: 7320 6f66 2074 6865 206e 616d 6564 2073  s of the named s
+00021af0: 6572 7669 6365 206f 6e20 7468 6520 2a77  ervice on the *w
+00021b00: 6f72 6b65 722a 2e0a 2020 2020 2020 2020  orker*..        
+00021b10: 5265 7475 726e 7320 4e6f 6e65 2069 6620  Returns None if 
+00021b20: 7468 6520 7365 7276 6963 6520 646f 6573  the service does
+00021b30: 6e27 7420 6578 6973 742e 0a0a 2020 2020  n't exist...    
+00021b40: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00021b50: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00021b60: 2d0a 2020 2020 2020 2020 776f 726b 6572  -.        worker
+00021b70: 203a 2061 6464 7265 7373 0a20 2020 2020   : address.     
+00021b80: 2020 2073 6572 7669 6365 5f6e 616d 6520     service_name 
+00021b90: 3a20 7374 720a 2020 2020 2020 2020 2020  : str.          
+00021ba0: 2020 436f 6d6d 6f6e 2073 6572 7669 6365    Common service
+00021bb0: 7320 696e 636c 7564 6520 2762 6f6b 6568  s include 'bokeh
+00021bc0: 2720 616e 6420 276e 616e 6e79 270a 2020  ' and 'nanny'.  
+00021bd0: 2020 2020 2020 7072 6f74 6f63 6f6c 203a        protocol :
+00021be0: 2062 6f6f 6c65 616e 0a20 2020 2020 2020   boolean.       
+00021bf0: 2020 2020 2057 6865 7468 6572 206f 7220       Whether or 
+00021c00: 6e6f 7420 746f 2069 6e63 6c75 6465 2061  not to include a
+00021c10: 2066 756c 6c20 6164 6472 6573 7320 7769   full address wi
+00021c20: 7468 2070 726f 746f 636f 6c20 2854 7275  th protocol (Tru
+00021c30: 6529 0a20 2020 2020 2020 2020 2020 206f  e).            o
+00021c40: 7220 6a75 7374 2061 2028 686f 7374 2c20  r just a (host, 
+00021c50: 706f 7274 2920 7061 6972 0a20 2020 2020  port) pair.     
+00021c60: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+00021c70: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+00021c80: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
+00021c90: 2070 6f72 7420 3d20 7773 2e73 6572 7669   port = ws.servi
+00021ca0: 6365 732e 6765 7428 7365 7276 6963 655f  ces.get(service_
+00021cb0: 6e61 6d65 290a 2020 2020 2020 2020 6966  name).        if
+00021cc0: 2070 6f72 7420 6973 204e 6f6e 653a 0a20   port is None:. 
+00021cd0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00021ce0: 6e20 4e6f 6e65 0a20 2020 2020 2020 2065  n None.        e
+00021cf0: 6c69 6620 7072 6f74 6f63 6f6c 3a0a 2020  lif protocol:.  
+00021d00: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021d10: 2022 2528 7072 6f74 6f63 6f6c 2973 3a2f   "%(protocol)s:/
+00021d20: 2f25 2868 6f73 7429 733a 2528 706f 7274  /%(host)s:%(port
+00021d30: 2964 2220 2520 7b0a 2020 2020 2020 2020  )d" % {.        
+00021d40: 2020 2020 2020 2020 2270 726f 746f 636f          "protoco
+00021d50: 6c22 3a20 7773 2e61 6464 7265 7373 2e73  l": ws.address.s
+00021d60: 706c 6974 2822 3a2f 2f22 295b 305d 2c0a  plit("://")[0],.
+00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021d80: 2268 6f73 7422 3a20 7773 2e68 6f73 742c  "host": ws.host,
+00021d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021da0: 2022 706f 7274 223a 2070 6f72 742c 0a20   "port": port,. 
+00021db0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00021dc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00021dd0: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+00021de0: 2e68 6f73 742c 2070 6f72 740a 0a20 2020  .host, port..   
+00021df0: 2061 7379 6e63 2064 6566 2073 7461 7274   async def start
+00021e00: 5f75 6e73 6166 6528 7365 6c66 293a 0a20  _unsafe(self):. 
+00021e10: 2020 2020 2020 2022 2222 436c 6561 7220         """Clear 
+00021e20: 6f75 7420 6f6c 6420 7374 6174 6520 616e  out old state an
+00021e30: 6420 7265 7374 6172 7420 616c 6c20 7275  d restart all ru
+00021e40: 6e6e 696e 6720 636f 726f 7574 696e 6573  nning coroutines
+00021e50: 2222 220a 2020 2020 2020 2020 6177 6169  """.        awai
+00021e60: 7420 7375 7065 7228 292e 7374 6172 745f  t super().start_
+00021e70: 756e 7361 6665 2829 0a0a 2020 2020 2020  unsafe()..      
+00021e80: 2020 656e 6162 6c65 5f67 635f 6469 6167    enable_gc_diag
+00021e90: 6e6f 7369 7328 290a 0a20 2020 2020 2020  nosis()..       
+00021ea0: 2073 656c 662e 5f63 6c65 6172 5f74 6173   self._clear_tas
+00021eb0: 6b5f 7374 6174 6528 290a 0a20 2020 2020  k_state()..     
+00021ec0: 2020 2066 6f72 2061 6464 7220 696e 2073     for addr in s
+00021ed0: 656c 662e 5f73 7461 7274 5f61 6464 7265  elf._start_addre
+00021ee0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+00021ef0: 6177 6169 7420 7365 6c66 2e6c 6973 7465  await self.liste
+00021f00: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00021f10: 2020 2061 6464 722c 0a20 2020 2020 2020     addr,.       
+00021f20: 2020 2020 2020 2020 2061 6c6c 6f77 5f6f           allow_o
+00021f30: 6666 6c6f 6164 3d46 616c 7365 2c0a 2020  ffload=False,.  
+00021f40: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+00021f50: 6e64 7368 616b 655f 6f76 6572 7269 6465  ndshake_override
+00021f60: 733d 7b22 7069 636b 6c65 2d70 726f 746f  s={"pickle-proto
+00021f70: 636f 6c22 3a20 342c 2022 636f 6d70 7265  col": 4, "compre
+00021f80: 7373 696f 6e22 3a20 4e6f 6e65 7d2c 0a20  ssion": None},. 
+00021f90: 2020 2020 2020 2020 2020 2020 2020 202a                 *
+00021fa0: 2a73 656c 662e 7365 6375 7269 7479 2e67  *self.security.g
+00021fb0: 6574 5f6c 6973 7465 6e5f 6172 6773 2822  et_listen_args("
+00021fc0: 7363 6865 6475 6c65 7222 292c 0a20 2020  scheduler"),.   
+00021fd0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00021fe0: 2020 2020 2020 2073 656c 662e 6970 203d         self.ip =
+00021ff0: 2067 6574 5f61 6464 7265 7373 5f68 6f73   get_address_hos
+00022000: 7428 7365 6c66 2e6c 6973 7465 6e5f 6164  t(self.listen_ad
+00022010: 6472 6573 7329 0a20 2020 2020 2020 2020  dress).         
+00022020: 2020 206c 6973 7465 6e5f 6970 203d 2073     listen_ip = s
+00022030: 656c 662e 6970 0a0a 2020 2020 2020 2020  elf.ip..        
+00022040: 2020 2020 6966 206c 6973 7465 6e5f 6970      if listen_ip
+00022050: 203d 3d20 2230 2e30 2e30 2e30 223a 0a20   == "0.0.0.0":. 
+00022060: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00022070: 6973 7465 6e5f 6970 203d 2022 220a 0a20  isten_ip = "".. 
+00022080: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
+00022090: 6464 7265 7373 2e73 7461 7274 7377 6974  ddress.startswit
+000220a0: 6828 2269 6e70 726f 633a 2f2f 2229 3a0a  h("inproc://"):.
+000220b0: 2020 2020 2020 2020 2020 2020 6c69 7374              list
+000220c0: 656e 5f69 7020 3d20 226c 6f63 616c 686f  en_ip = "localho
+000220d0: 7374 220a 0a20 2020 2020 2020 2023 2053  st"..        # S
+000220e0: 6572 7669 6365 7320 6c69 7374 656e 206f  ervices listen o
+000220f0: 6e20 616c 6c20 6164 6472 6573 7365 730a  n all addresses.
+00022100: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+00022110: 7274 5f73 6572 7669 6365 7328 6c69 7374  rt_services(list
+00022120: 656e 5f69 7029 0a0a 2020 2020 2020 2020  en_ip)..        
+00022130: 666f 7220 6c69 7374 656e 6572 2069 6e20  for listener in 
+00022140: 7365 6c66 2e6c 6973 7465 6e65 7273 3a0a  self.listeners:.
+00022150: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022160: 6572 2e69 6e66 6f28 2220 2053 6368 6564  er.info("  Sched
+00022170: 756c 6572 2061 743a 2025 3235 7322 2c20  uler at: %25s", 
+00022180: 6c69 7374 656e 6572 2e63 6f6e 7461 6374  listener.contact
+00022190: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
+000221a0: 2020 666f 7220 6e61 6d65 2c20 7365 7276    for name, serv
+000221b0: 6572 2069 6e20 7365 6c66 2e73 6572 7669  er in self.servi
+000221c0: 6365 732e 6974 656d 7328 293a 0a20 2020  ces.items():.   
+000221d0: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+000221e0: 203d 3d20 2264 6173 6862 6f61 7264 223a   == "dashboard":
+000221f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022200: 2061 6464 7220 3d20 6765 745f 6164 6472   addr = get_addr
+00022210: 6573 735f 686f 7374 286c 6973 7465 6e65  ess_host(listene
+00022220: 722e 636f 6e74 6163 745f 6164 6472 6573  r.contact_addres
+00022230: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00022240: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00022250: 2020 2020 2020 2020 2020 2020 6c69 6e6b              link
+00022260: 203d 2066 6f72 6d61 745f 6461 7368 626f   = format_dashbo
+00022270: 6172 645f 6c69 6e6b 2861 6464 722c 2073  ard_link(addr, s
+00022280: 6572 7665 722e 706f 7274 290a 2020 2020  erver.port).    
+00022290: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
+000222a0: 726d 6174 7469 6e67 2064 6173 6862 6f61  rmatting dashboa
+000222b0: 7264 206c 696e 6b20 6361 6e20 6661 696c  rd link can fail
+000222c0: 2069 6620 6469 7374 7269 6275 7465 642e   if distributed.
+000222d0: 6461 7368 626f 6172 642e 6c69 6e6b 0a20  dashboard.link. 
+000222e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000222f0: 2072 6566 6572 7320 746f 206e 6f6e 2d65   refers to non-e
+00022300: 7869 7374 616e 7420 656e 7620 7661 7273  xistant env vars
+00022310: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00022320: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00022330: 7220 6173 2065 3a0a 2020 2020 2020 2020  r as e:.        
+00022340: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022350: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+00022360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022370: 2020 2020 6622 4661 696c 6564 2074 6f20      f"Failed to 
+00022380: 666f 726d 6174 2064 6173 6862 6f61 7264  format dashboard
+00022390: 206c 696e 6b2c 2075 6e6b 6e6f 776e 2076   link, unknown v
+000223a0: 616c 7565 3a20 7b65 7d22 0a20 2020 2020  alue: {e}".     
+000223b0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000223c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000223d0: 2020 2020 206c 696e 6b20 3d20 6622 3a7b       link = f":{
+000223e0: 7365 7276 6572 2e70 6f72 747d 220a 2020  server.port}".  
+000223f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00022400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022410: 6c69 6e6b 203d 2066 227b 6c69 7374 656e  link = f"{listen
+00022420: 5f69 707d 3a7b 7365 7276 6572 2e70 6f72  _ip}:{server.por
+00022430: 747d 220a 2020 2020 2020 2020 2020 2020  t}".            
+00022440: 6c6f 6767 6572 2e69 6e66 6f28 2225 3131  logger.info("%11
+00022450: 7320 6174 3a20 2025 3235 7322 2c20 6e61  s at:  %25s", na
+00022460: 6d65 2c20 6c69 6e6b 290a 0a20 2020 2020  me, link)..     
+00022470: 2020 2069 6620 7365 6c66 2e73 6368 6564     if self.sched
+00022480: 756c 6572 5f66 696c 653a 0a20 2020 2020  uler_file:.     
+00022490: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+000224a0: 2873 656c 662e 7363 6865 6475 6c65 725f  (self.scheduler_
+000224b0: 6669 6c65 2c20 2277 2229 2061 7320 663a  file, "w") as f:
+000224c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000224d0: 206a 736f 6e2e 6475 6d70 2873 656c 662e   json.dump(self.
+000224e0: 6964 656e 7469 7479 2829 2c20 662c 2069  identity(), f, i
+000224f0: 6e64 656e 743d 3229 0a0a 2020 2020 2020  ndent=2)..      
+00022500: 2020 2020 2020 666e 203d 2073 656c 662e        fn = self.
+00022510: 7363 6865 6475 6c65 725f 6669 6c65 2020  scheduler_file  
+00022520: 2320 7265 6d6f 7665 2066 696c 6520 7768  # remove file wh
+00022530: 656e 2077 6520 636c 6f73 6520 7468 6520  en we close the 
+00022540: 7072 6f63 6573 730a 0a20 2020 2020 2020  process..       
+00022550: 2020 2020 2064 6566 2064 656c 5f73 6368       def del_sch
+00022560: 6564 756c 6572 5f66 696c 6528 293a 0a20  eduler_file():. 
+00022570: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00022580: 6620 6f73 2e70 6174 682e 6578 6973 7473  f os.path.exists
+00022590: 2866 6e29 3a0a 2020 2020 2020 2020 2020  (fn):.          
+000225a0: 2020 2020 2020 2020 2020 6f73 2e72 656d            os.rem
+000225b0: 6f76 6528 666e 290a 0a20 2020 2020 2020  ove(fn)..       
+000225c0: 2020 2020 2077 6561 6b72 6566 2e66 696e       weakref.fin
+000225d0: 616c 697a 6528 7365 6c66 2c20 6465 6c5f  alize(self, del_
+000225e0: 7363 6865 6475 6c65 725f 6669 6c65 290a  scheduler_file).
+000225f0: 0a20 2020 2020 2020 2066 6f72 2070 7265  .        for pre
+00022600: 6c6f 6164 2069 6e20 7365 6c66 2e70 7265  load in self.pre
+00022610: 6c6f 6164 733a 0a20 2020 2020 2020 2020  loads:.         
+00022620: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00022630: 2020 2020 2020 2020 6177 6169 7420 7072          await pr
+00022640: 656c 6f61 642e 7374 6172 7428 290a 2020  eload.start().  
+00022650: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00022660: 2045 7863 6570 7469 6f6e 3a0a 2020 2020   Exception:.    
+00022670: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00022680: 6572 2e65 7863 6570 7469 6f6e 2822 4661  er.exception("Fa
+00022690: 696c 6564 2074 6f20 7374 6172 7420 7072  iled to start pr
+000226a0: 656c 6f61 6422 290a 0a20 2020 2020 2020  eload")..       
+000226b0: 2069 6620 7365 6c66 2e6a 7570 7974 6572   if self.jupyter
+000226c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000226d0: 416c 6c6f 7720 696e 7365 6375 7265 2063  Allow insecure c
+000226e0: 6f6d 6d75 6e69 6361 7469 6f6e 7320 6672  ommunications fr
+000226f0: 6f6d 206c 6f63 616c 2075 7365 7273 0a20  om local users. 
+00022700: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00022710: 6c66 2e61 6464 7265 7373 2e73 7461 7274  lf.address.start
+00022720: 7377 6974 6828 2274 6c73 3a2f 2f22 293a  swith("tls://"):
+00022730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022740: 2061 7761 6974 2073 656c 662e 6c69 7374   await self.list
+00022750: 656e 2822 7463 703a 2f2f 6c6f 6361 6c68  en("tcp://localh
+00022760: 6f73 743a 3022 290a 2020 2020 2020 2020  ost:0").        
+00022770: 2020 2020 6f73 2e65 6e76 6972 6f6e 5b22      os.environ["
+00022780: 4441 534b 5f53 4348 4544 554c 4552 5f41  DASK_SCHEDULER_A
+00022790: 4444 5245 5353 225d 203d 2073 656c 662e  DDRESS"] = self.
+000227a0: 6c69 7374 656e 6572 735b 2d31 5d2e 636f  listeners[-1].co
+000227b0: 6e74 6163 745f 6164 6472 6573 730a 0a20  ntact_address.. 
+000227c0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+000227d0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+000227e0: 2020 2020 2020 2020 202a 5b70 6c75 6769           *[plugi
+000227f0: 6e2e 7374 6172 7428 7365 6c66 2920 666f  n.start(self) fo
+00022800: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+00022810: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+00022820: 6c75 6573 2829 295d 0a20 2020 2020 2020  lues())].       
+00022830: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00022840: 2e73 7461 7274 5f70 6572 696f 6469 635f  .start_periodic_
+00022850: 6361 6c6c 6261 636b 7328 290a 0a20 2020  callbacks()..   
+00022860: 2020 2020 2073 6574 7072 6f63 7469 746c       setproctitl
+00022870: 6528 6622 6461 736b 2073 6368 6564 756c  e(f"dask schedul
+00022880: 6572 205b 7b73 656c 662e 6164 6472 6573  er [{self.addres
+00022890: 737d 5d22 290a 2020 2020 2020 2020 7265  s}]").        re
+000228a0: 7475 726e 2073 656c 660a 0a20 2020 2061  turn self..    a
+000228b0: 7379 6e63 2064 6566 2063 6c6f 7365 2873  sync def close(s
+000228c0: 656c 662c 2066 6173 743d 4e6f 6e65 2c20  elf, fast=None, 
+000228d0: 636c 6f73 655f 776f 726b 6572 733d 4e6f  close_workers=No
+000228e0: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+000228f0: 5365 6e64 2063 6c65 616e 7570 2073 6967  Send cleanup sig
+00022900: 6e61 6c20 746f 2061 6c6c 2063 6f72 6f75  nal to all corou
+00022910: 7469 6e65 7320 7468 656e 2077 6169 7420  tines then wait 
+00022920: 756e 7469 6c20 6669 6e69 7368 6564 0a0a  until finished..
+00022930: 2020 2020 2020 2020 5365 6520 416c 736f          See Also
+00022940: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00022950: 2d0a 2020 2020 2020 2020 5363 6865 6475  -.        Schedu
+00022960: 6c65 722e 636c 6561 6e75 700a 2020 2020  ler.cleanup.    
+00022970: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00022980: 6966 2066 6173 7420 6973 206e 6f74 204e  if fast is not N
+00022990: 6f6e 6520 6f72 2063 6c6f 7365 5f77 6f72  one or close_wor
+000229a0: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
+000229b0: 3a0a 2020 2020 2020 2020 2020 2020 7761  :.            wa
+000229c0: 726e 696e 6773 2e77 6172 6e28 0a20 2020  rnings.warn(.   
+000229d0: 2020 2020 2020 2020 2020 2020 2022 5468               "Th
+000229e0: 6520 2766 6173 7427 2061 6e64 2027 636c  e 'fast' and 'cl
+000229f0: 6f73 655f 776f 726b 6572 7327 2070 6172  ose_workers' par
+00022a00: 616d 6574 6572 7320 696e 2053 6368 6564  ameters in Sched
+00022a10: 756c 6572 2e63 6c6f 7365 2068 6176 6520  uler.close have 
+00022a20: 6e6f 2065 6666 6563 7420 616e 6420 7769  no effect and wi
+00022a30: 6c6c 2062 6520 7265 6d6f 7665 6420 696e  ll be removed in
+00022a40: 2061 2066 7574 7572 6520 7665 7273 696f   a future versio
+00022a50: 6e20 6f66 2064 6973 7472 6962 7574 6564  n of distributed
+00022a60: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
+00022a70: 2020 2020 4675 7475 7265 5761 726e 696e      FutureWarnin
+00022a80: 672c 0a20 2020 2020 2020 2020 2020 2029  g,.            )
+00022a90: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00022aa0: 2e73 7461 7475 7320 696e 2028 5374 6174  .status in (Stat
+00022ab0: 7573 2e63 6c6f 7369 6e67 2c20 5374 6174  us.closing, Stat
+00022ac0: 7573 2e63 6c6f 7365 6429 3a0a 2020 2020  us.closed):.    
+00022ad0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+00022ae0: 6c66 2e66 696e 6973 6865 6428 290a 2020  lf.finished().  
+00022af0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00022b00: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
+00022b10: 6465 6620 6c6f 675f 6572 726f 7273 2866  def log_errors(f
+00022b20: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
+00022b30: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00022b40: 2020 2020 2020 2061 7761 6974 2066 756e         await fun
+00022b50: 6328 290a 2020 2020 2020 2020 2020 2020  c().            
+00022b60: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00022b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00022b80: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00022b90: 6f6e 2822 506c 7567 696e 2063 616c 6c20  on("Plugin call 
+00022ba0: 6661 696c 6564 2064 7572 696e 6720 7363  failed during sc
+00022bb0: 6865 6475 6c65 722e 636c 6f73 6522 290a  heduler.close").
+00022bc0: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
+00022bd0: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
+00022be0: 2020 2020 2020 2020 2020 202a 5b6c 6f67             *[log
+00022bf0: 5f65 7272 6f72 7328 706c 7567 696e 2e62  _errors(plugin.b
+00022c00: 6566 6f72 655f 636c 6f73 6529 2066 6f72  efore_close) for
+00022c10: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
+00022c20: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
+00022c30: 7565 7328 2929 5d0a 2020 2020 2020 2020  ues())].        
+00022c40: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00022c50: 7374 6174 7573 203d 2053 7461 7475 732e  status = Status.
+00022c60: 636c 6f73 696e 670a 0a20 2020 2020 2020  closing..       
+00022c70: 206c 6f67 6765 722e 696e 666f 2822 5363   logger.info("Sc
+00022c80: 6865 6475 6c65 7220 636c 6f73 696e 672e  heduler closing.
+00022c90: 2e2e 2229 0a20 2020 2020 2020 2073 6574  ..").        set
+00022ca0: 7072 6f63 7469 746c 6528 2264 6173 6b20  proctitle("dask 
+00022cb0: 7363 6865 6475 6c65 7220 5b63 6c6f 7369  scheduler [closi
+00022cc0: 6e67 5d22 290a 0a20 2020 2020 2020 2066  ng]")..        f
+00022cd0: 6f72 2070 7265 6c6f 6164 2069 6e20 7365  or preload in se
+00022ce0: 6c66 2e70 7265 6c6f 6164 733a 0a20 2020  lf.preloads:.   
+00022cf0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00022d00: 2020 2020 2020 2020 2020 2020 2020 6177                aw
+00022d10: 6169 7420 7072 656c 6f61 642e 7465 6172  ait preload.tear
+00022d20: 646f 776e 2829 0a20 2020 2020 2020 2020  down().         
+00022d30: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00022d40: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00022d50: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00022d60: 7074 696f 6e28 2246 6169 6c65 6420 746f  ption("Failed to
+00022d70: 2074 6561 7220 646f 776e 2070 7265 6c6f   tear down prelo
+00022d80: 6164 2229 0a0a 2020 2020 2020 2020 6177  ad")..        aw
+00022d90: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00022da0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00022db0: 2a5b 6c6f 675f 6572 726f 7273 2870 6c75  *[log_errors(plu
+00022dc0: 6769 6e2e 636c 6f73 6529 2066 6f72 2070  gin.close) for p
+00022dd0: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
+00022de0: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
+00022df0: 7328 2929 5d0a 2020 2020 2020 2020 290a  s())].        ).
+00022e00: 0a20 2020 2020 2020 2066 6f72 2070 6320  .        for pc 
+00022e10: 696e 2073 656c 662e 7065 7269 6f64 6963  in self.periodic
+00022e20: 5f63 616c 6c62 6163 6b73 2e76 616c 7565  _callbacks.value
+00022e30: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00022e40: 2070 632e 7374 6f70 2829 0a20 2020 2020   pc.stop().     
+00022e50: 2020 2073 656c 662e 7065 7269 6f64 6963     self.periodic
+00022e60: 5f63 616c 6c62 6163 6b73 2e63 6c65 6172  _callbacks.clear
+00022e70: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
+00022e80: 2e73 746f 705f 7365 7276 6963 6573 2829  .stop_services()
+00022e90: 0a0a 2020 2020 2020 2020 666f 7220 6578  ..        for ex
+00022ea0: 7420 696e 2073 656c 662e 6578 7465 6e73  t in self.extens
+00022eb0: 696f 6e73 2e76 616c 7565 7328 293a 0a20  ions.values():. 
+00022ec0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00022ed0: 7375 7070 7265 7373 2841 7474 7269 6275  suppress(Attribu
+00022ee0: 7465 4572 726f 7229 3a0a 2020 2020 2020  teError):.      
+00022ef0: 2020 2020 2020 2020 2020 6578 742e 7465            ext.te
+00022f00: 6172 646f 776e 2829 0a20 2020 2020 2020  ardown().       
+00022f10: 206c 6f67 6765 722e 696e 666f 2822 5363   logger.info("Sc
+00022f20: 6865 6475 6c65 7220 636c 6f73 696e 6720  heduler closing 
+00022f30: 616c 6c20 636f 6d6d 7322 290a 0a20 2020  all comms")..   
+00022f40: 2020 2020 2066 7574 7572 6573 203d 205b       futures = [
+00022f50: 5d0a 2020 2020 2020 2020 666f 7220 5f2c  ].        for _,
+00022f60: 2063 6f6d 6d20 696e 206c 6973 7428 7365   comm in list(se
+00022f70: 6c66 2e73 7472 6561 6d5f 636f 6d6d 732e  lf.stream_comms.
+00022f80: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
+00022f90: 2020 2020 2020 2320 4649 584d 4520 7573        # FIXME us
+00022fa0: 6520 6073 656c 662e 7265 6d6f 7665 5f77  e `self.remove_w
+00022fb0: 6f72 6b65 7228 2960 2069 6e73 7465 6164  orker()` instead
+00022fc0: 2061 6674 6572 2068 7474 7073 3a2f 2f67   after https://g
+00022fd0: 6974 6875 622e 636f 6d2f 6461 736b 2f64  ithub.com/dask/d
+00022fe0: 6973 7472 6962 7574 6564 2f69 7373 7565  istributed/issue
+00022ff0: 732f 3633 3930 0a20 2020 2020 2020 2020  s/6390.         
+00023000: 2020 2069 6620 6e6f 7420 636f 6d6d 2e63     if not comm.c
+00023010: 6c6f 7365 6428 293a 0a20 2020 2020 2020  losed():.       
+00023020: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+00023030: 636c 6f73 6573 2074 6865 2057 6f72 6b65  closes the Worke
+00023040: 7220 616e 6420 656e 7375 7265 7320 7468  r and ensures th
+00023050: 6174 2069 6620 6120 4e61 6e6e 7920 6973  at if a Nanny is
+00023060: 2061 726f 756e 642c 0a20 2020 2020 2020   around,.       
+00023070: 2020 2020 2020 2020 2023 2069 7420 6973           # it is
+00023080: 2063 6c6f 7365 6420 6173 2077 656c 6c0a   closed as well.
+00023090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000230a0: 636f 6d6d 2e73 656e 6428 7b22 6f70 223a  comm.send({"op":
+000230b0: 2022 636c 6f73 6522 2c20 2272 6561 736f   "close", "reaso
+000230c0: 6e22 3a20 2273 6368 6564 756c 6572 2d63  n": "scheduler-c
+000230d0: 6c6f 7365 227d 290a 2020 2020 2020 2020  lose"}).        
+000230e0: 2020 2020 2020 2020 636f 6d6d 2e73 656e          comm.sen
+000230f0: 6428 7b22 6f70 223a 2022 636c 6f73 652d  d({"op": "close-
+00023100: 7374 7265 616d 227d 290a 2020 2020 2020  stream"}).      
+00023110: 2020 2020 2020 2020 2020 2320 5e20 544f            # ^ TO
+00023120: 444f 2072 656d 6f76 653f 2060 576f 726b  DO remove? `Work
+00023130: 6572 2e63 6c6f 7365 6020 7769 6c6c 2063  er.close` will c
+00023140: 6c6f 7365 2074 6865 2073 7472 6561 6d20  lose the stream 
+00023150: 616e 7977 6179 2e0a 2020 2020 2020 2020  anyway..        
+00023160: 2020 2020 7769 7468 2073 7570 7072 6573      with suppres
+00023170: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
+00023180: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00023190: 2020 2066 7574 7572 6573 2e61 7070 656e     futures.appen
+000231a0: 6428 636f 6d6d 2e63 6c6f 7365 2829 290a  d(comm.close()).
+000231b0: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
+000231c0: 7379 6e63 696f 2e67 6174 6865 7228 2a66  syncio.gather(*f
+000231d0: 7574 7572 6573 290a 0a20 2020 2020 2020  utures)..       
+000231e0: 2069 6620 7365 6c66 2e6a 7570 7974 6572   if self.jupyter
+000231f0: 3a0a 2020 2020 2020 2020 2020 2020 6177  :.            aw
+00023200: 6169 7420 7365 6c66 2e5f 6a75 7079 7465  ait self._jupyte
+00023210: 725f 7365 7276 6572 5f61 7070 6c69 6361  r_server_applica
+00023220: 7469 6f6e 2e5f 636c 6561 6e75 7028 290a  tion._cleanup().
+00023230: 0a20 2020 2020 2020 2066 6f72 2063 6f6d  .        for com
+00023240: 6d20 696e 2073 656c 662e 636c 6965 6e74  m in self.client
+00023250: 5f63 6f6d 6d73 2e76 616c 7565 7328 293a  _comms.values():
+00023260: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
+00023270: 6d2e 6162 6f72 7428 290a 0a20 2020 2020  m.abort()..     
+00023280: 2020 2061 7761 6974 2073 656c 662e 7270     await self.rp
+00023290: 632e 636c 6f73 6528 290a 0a20 2020 2020  c.close()..     
+000232a0: 2020 2073 656c 662e 7374 6174 7573 203d     self.status =
+000232b0: 2053 7461 7475 732e 636c 6f73 6564 0a20   Status.closed. 
+000232c0: 2020 2020 2020 2073 656c 662e 7374 6f70         self.stop
+000232d0: 2829 0a20 2020 2020 2020 2061 7761 6974  ().        await
+000232e0: 2073 7570 6572 2829 2e63 6c6f 7365 2829   super().close()
+000232f0: 0a0a 2020 2020 2020 2020 7365 7470 726f  ..        setpro
+00023300: 6374 6974 6c65 2822 6461 736b 2073 6368  ctitle("dask sch
+00023310: 6564 756c 6572 205b 636c 6f73 6564 5d22  eduler [closed]"
+00023320: 290a 2020 2020 2020 2020 6469 7361 626c  ).        disabl
+00023330: 655f 6763 5f64 6961 676e 6f73 6973 2829  e_gc_diagnosis()
+00023340: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+00023350: 230a 2020 2020 2320 5374 696d 756c 6920  #.    # Stimuli 
+00023360: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
+00023370: 230a 0a20 2020 2064 6566 2068 6561 7274  #..    def heart
+00023380: 6265 6174 5f77 6f72 6b65 7228 0a20 2020  beat_worker(.   
+00023390: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000233a0: 2020 202a 2c0a 2020 2020 2020 2020 6164     *,.        ad
+000233b0: 6472 6573 733a 2073 7472 2c0a 2020 2020  dress: str,.    
+000233c0: 2020 2020 7265 736f 6c76 655f 6164 6472      resolve_addr
+000233d0: 6573 733a 2062 6f6f 6c20 3d20 5472 7565  ess: bool = True
+000233e0: 2c0a 2020 2020 2020 2020 6e6f 773a 2066  ,.        now: f
+000233f0: 6c6f 6174 207c 204e 6f6e 6520 3d20 4e6f  loat | None = No
+00023400: 6e65 2c0a 2020 2020 2020 2020 7265 736f  ne,.        reso
+00023410: 7572 6365 733a 2064 6963 745b 7374 722c  urces: dict[str,
+00023420: 2066 6c6f 6174 5d20 7c20 4e6f 6e65 203d   float] | None =
+00023430: 204e 6f6e 652c 0a20 2020 2020 2020 2068   None,.        h
+00023440: 6f73 745f 696e 666f 3a20 6469 6374 207c  ost_info: dict |
+00023450: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00023460: 2020 2020 2020 6d65 7472 6963 733a 2064        metrics: d
+00023470: 6963 742c 0a20 2020 2020 2020 2065 7865  ict,.        exe
+00023480: 6375 7469 6e67 3a20 6469 6374 5b73 7472  cuting: dict[str
+00023490: 2c20 666c 6f61 745d 207c 204e 6f6e 6520  , float] | None 
+000234a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000234b0: 6578 7465 6e73 696f 6e73 3a20 6469 6374  extensions: dict
+000234c0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+000234d0: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
+000234e0: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+000234f0: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
+00023500: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
+00023510: 6464 7265 7373 2c20 7265 736f 6c76 655f  ddress, resolve_
+00023520: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
+00023530: 2061 6464 7265 7373 203d 206e 6f72 6d61   address = norma
+00023540: 6c69 7a65 5f61 6464 7265 7373 2861 6464  lize_address(add
+00023550: 7265 7373 290a 2020 2020 2020 2020 7773  ress).        ws
+00023560: 203d 2073 656c 662e 776f 726b 6572 732e   = self.workers.
+00023570: 6765 7428 6164 6472 6573 7329 0a20 2020  get(address).   
+00023580: 2020 2020 2069 6620 7773 2069 7320 4e6f       if ws is No
+00023590: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000235a0: 6c6f 6767 6572 2e77 6172 6e69 6e67 2866  logger.warning(f
+000235b0: 2252 6563 6569 7665 6420 6865 6172 7462  "Received heartb
+000235c0: 6561 7420 6672 6f6d 2075 6e72 6567 6973  eat from unregis
+000235d0: 7465 7265 6420 776f 726b 6572 207b 6164  tered worker {ad
+000235e0: 6472 6573 7321 727d 2e22 290a 2020 2020  dress!r}.").    
+000235f0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00023600: 2273 7461 7475 7322 3a20 226d 6973 7369  "status": "missi
+00023610: 6e67 227d 0a0a 2020 2020 2020 2020 686f  ng"}..        ho
+00023620: 7374 203d 2067 6574 5f61 6464 7265 7373  st = get_address
+00023630: 5f68 6f73 7428 6164 6472 6573 7329 0a20  _host(address). 
+00023640: 2020 2020 2020 206c 6f63 616c 5f6e 6f77         local_now
+00023650: 203d 2074 696d 6528 290a 2020 2020 2020   = time().      
+00023660: 2020 686f 7374 5f69 6e66 6f20 3d20 686f    host_info = ho
+00023670: 7374 5f69 6e66 6f20 6f72 207b 7d0a 0a20  st_info or {}.. 
+00023680: 2020 2020 2020 2064 683a 2064 6963 7420         dh: dict 
+00023690: 3d20 7365 6c66 2e68 6f73 745f 696e 666f  = self.host_info
+000236a0: 2e73 6574 6465 6661 756c 7428 686f 7374  .setdefault(host
+000236b0: 2c20 7b7d 290a 2020 2020 2020 2020 6468  , {}).        dh
+000236c0: 5b22 6c61 7374 2d73 6565 6e22 5d20 3d20  ["last-seen"] = 
+000236d0: 6c6f 6361 6c5f 6e6f 770a 0a20 2020 2020  local_now..     
+000236e0: 2020 2066 7261 6320 3d20 3120 2f20 6c65     frac = 1 / le
+000236f0: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
+00023700: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+00023710: 6477 6964 7468 203d 2028 0a20 2020 2020  dwidth = (.     
+00023720: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00023730: 7769 6474 6820 2a20 2831 202d 2066 7261  width * (1 - fra
+00023740: 6329 202b 206d 6574 7269 6373 5b22 6261  c) + metrics["ba
+00023750: 6e64 7769 6474 6822 5d5b 2274 6f74 616c  ndwidth"]["total
+00023760: 225d 202a 2066 7261 630a 2020 2020 2020  "] * frac.      
+00023770: 2020 290a 2020 2020 2020 2020 666f 7220    ).        for 
+00023780: 6f74 6865 722c 2028 6277 2c20 636f 756e  other, (bw, coun
+00023790: 7429 2069 6e20 6d65 7472 6963 735b 2262  t) in metrics["b
+000237a0: 616e 6477 6964 7468 225d 5b22 776f 726b  andwidth"]["work
+000237b0: 6572 7322 5d2e 6974 656d 7328 293a 0a20  ers"].items():. 
+000237c0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+000237d0: 6464 7265 7373 2c20 6f74 6865 7229 206e  ddress, other) n
+000237e0: 6f74 2069 6e20 7365 6c66 2e62 616e 6477  ot in self.bandw
+000237f0: 6964 7468 5f77 6f72 6b65 7273 3a0a 2020  idth_workers:.  
+00023800: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00023810: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
+00023820: 6b65 7273 5b61 6464 7265 7373 2c20 6f74  kers[address, ot
+00023830: 6865 725d 203d 2062 7720 2f20 636f 756e  her] = bw / coun
+00023840: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00023850: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00023860: 2020 2020 616c 7068 6120 3d20 2831 202d      alpha = (1 -
+00023870: 2066 7261 6329 202a 2a20 636f 756e 740a   frac) ** count.
+00023880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023890: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
+000238a0: 6f72 6b65 7273 5b61 6464 7265 7373 2c20  orkers[address, 
+000238b0: 6f74 6865 725d 203d 2073 656c 662e 6261  other] = self.ba
+000238c0: 6e64 7769 6474 685f 776f 726b 6572 735b  ndwidth_workers[
+000238d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000238e0: 2020 2020 2061 6464 7265 7373 2c20 6f74       address, ot
+000238f0: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
+00023900: 2020 2020 5d20 2a20 616c 7068 6120 2b20      ] * alpha + 
+00023910: 6277 202a 2028 3120 2d20 616c 7068 6129  bw * (1 - alpha)
+00023920: 0a20 2020 2020 2020 2066 6f72 2074 7970  .        for typ
+00023930: 2c20 2862 772c 2063 6f75 6e74 2920 696e  , (bw, count) in
+00023940: 206d 6574 7269 6373 5b22 6261 6e64 7769   metrics["bandwi
+00023950: 6474 6822 5d5b 2274 7970 6573 225d 2e69  dth"]["types"].i
+00023960: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00023970: 2020 2020 6966 2074 7970 206e 6f74 2069      if typ not i
+00023980: 6e20 7365 6c66 2e62 616e 6477 6964 7468  n self.bandwidth
+00023990: 5f74 7970 6573 3a0a 2020 2020 2020 2020  _types:.        
+000239a0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+000239b0: 6477 6964 7468 5f74 7970 6573 5b74 7970  dwidth_types[typ
+000239c0: 5d20 3d20 6277 202f 2063 6f75 6e74 0a20  ] = bw / count. 
+000239d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000239e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000239f0: 2061 6c70 6861 203d 2028 3120 2d20 6672   alpha = (1 - fr
+00023a00: 6163 2920 2a2a 2063 6f75 6e74 0a20 2020  ac) ** count.   
+00023a10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00023a20: 662e 6261 6e64 7769 6474 685f 7479 7065  f.bandwidth_type
+00023a30: 735b 7479 705d 203d 2073 656c 662e 6261  s[typ] = self.ba
+00023a40: 6e64 7769 6474 685f 7479 7065 735b 7479  ndwidth_types[ty
+00023a50: 705d 202a 2061 6c70 6861 202b 2062 7720  p] * alpha + bw 
+00023a60: 2a20 280a 2020 2020 2020 2020 2020 2020  * (.            
+00023a70: 2020 2020 2020 2020 3120 2d20 616c 7068          1 - alph
+00023a80: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+00023a90: 2020 290a 0a20 2020 2020 2020 2077 732e    )..        ws.
+00023aa0: 6c61 7374 5f73 6565 6e20 3d20 6c6f 6361  last_seen = loca
+00023ab0: 6c5f 6e6f 770a 2020 2020 2020 2020 6966  l_now.        if
+00023ac0: 2065 7865 6375 7469 6e67 2069 7320 6e6f   executing is no
+00023ad0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00023ae0: 2020 2020 2320 4e4f 5445 3a20 7468 6520      # NOTE: the 
+00023af0: 6578 6563 7574 696e 6720 6469 6374 2069  executing dict i
+00023b00: 7320 756e 7573 6564 0a20 2020 2020 2020  s unused.       
+00023b10: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
+00023b20: 6720 3d20 7b7d 0a20 2020 2020 2020 2020  g = {}.         
+00023b30: 2020 2066 6f72 206b 6579 2c20 6475 7261     for key, dura
+00023b40: 7469 6f6e 2069 6e20 6578 6563 7574 696e  tion in executin
+00023b50: 672e 6974 656d 7328 293a 0a20 2020 2020  g.items():.     
+00023b60: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
+00023b70: 7920 696e 2073 656c 662e 7461 736b 733a  y in self.tasks:
+00023b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023b90: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00023ba0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+00023bb0: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00023bc0: 2e65 7865 6375 7469 6e67 5b74 735d 203d  .executing[ts] =
+00023bd0: 2064 7572 6174 696f 6e0a 2020 2020 2020   duration.      
+00023be0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00023bf0: 2e70 7265 6669 782e 6164 645f 6578 6563  .prefix.add_exec
+00023c00: 5f74 696d 6528 6475 7261 7469 6f6e 290a  _time(duration).
+00023c10: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+00023c20: 652c 2076 616c 7565 2069 6e20 6d65 7472  e, value in metr
+00023c30: 6963 735b 2264 6967 6573 7473 5f74 6f74  ics["digests_tot
+00023c40: 616c 5f73 696e 6365 5f68 6561 7274 6265  al_since_heartbe
+00023c50: 6174 225d 2e69 7465 6d73 2829 3a0a 2020  at"].items():.  
+00023c60: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00023c70: 756d 756c 6174 6976 655f 776f 726b 6572  umulative_worker
+00023c80: 5f6d 6574 7269 6373 5b6e 616d 655d 202b  _metrics[name] +
+00023c90: 3d20 7661 6c75 650a 0a20 2020 2020 2020  = value..       
+00023ca0: 2077 732e 6d65 7472 6963 7320 3d20 6d65   ws.metrics = me
+00023cb0: 7472 6963 730a 0a20 2020 2020 2020 2023  trics..        #
+00023cc0: 2043 616c 6375 6c61 7465 2052 5353 202d   Calculate RSS -
+00023cd0: 2064 6173 6b20 6b65 7973 2c20 7365 7061   dask keys, sepa
+00023ce0: 7261 7469 6e67 2022 6f6c 6422 2061 6e64  rating "old" and
+00023cf0: 2022 6e65 7722 2075 7361 6765 0a20 2020   "new" usage.   
+00023d00: 2020 2020 2023 2053 6565 204d 656d 6f72       # See Memor
+00023d10: 7953 7461 7465 2066 6f72 2064 6574 6169  yState for detai
+00023d20: 6c73 0a20 2020 2020 2020 206d 6178 5f6d  ls.        max_m
+00023d30: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00023d40: 6f6c 645f 6869 7374 5f61 6765 203d 206c  old_hist_age = l
+00023d50: 6f63 616c 5f6e 6f77 202d 2073 656c 662e  ocal_now - self.
+00023d60: 4d45 4d4f 5259 5f52 4543 454e 545f 544f  MEMORY_RECENT_TO
+00023d70: 5f4f 4c44 5f54 494d 450a 2020 2020 2020  _OLD_TIME.      
+00023d80: 2020 6d65 6d6f 7279 5f75 6e6d 616e 6167    memory_unmanag
+00023d90: 6564 5f6f 6c64 203d 2077 732e 5f6d 656d  ed_old = ws._mem
+00023da0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+00023db0: 640a 2020 2020 2020 2020 7768 696c 6520  d.        while 
+00023dc0: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
+00023dd0: 6167 6564 5f68 6973 746f 7279 3a0a 2020  aged_history:.  
+00023de0: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+00023df0: 616d 702c 2073 697a 6520 3d20 7773 2e5f  amp, size = ws._
+00023e00: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+00023e10: 5f68 6973 746f 7279 5b30 5d0a 2020 2020  _history[0].    
+00023e20: 2020 2020 2020 2020 6966 2074 696d 6573          if times
+00023e30: 7461 6d70 203e 3d20 6d61 785f 6d65 6d6f  tamp >= max_memo
+00023e40: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
+00023e50: 5f68 6973 745f 6167 653a 0a20 2020 2020  _hist_age:.     
+00023e60: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00023e70: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+00023e80: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
+00023e90: 645f 6869 7374 6f72 792e 706f 706c 6566  d_history.poplef
+00023ea0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00023eb0: 6966 2073 697a 6520 3d3d 206d 656d 6f72  if size == memor
+00023ec0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
+00023ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ee0: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
+00023ef0: 645f 6f6c 6420 3d20 3020 2023 2072 6563  d_old = 0  # rec
+00023f00: 616c 6375 6c61 7465 206d 696e 2829 0a0a  alculate min()..
+00023f10: 2020 2020 2020 2020 2320 7773 2e5f 6e62          # ws._nb
+00023f20: 7974 6573 2069 7320 7570 6461 7465 6420  ytes is updated 
+00023f30: 6174 2061 2064 6966 6665 7265 6e74 2074  at a different t
+00023f40: 696d 6520 616e 6420 7369 7a65 6f66 2829  ime and sizeof()
+00023f50: 206d 6179 206e 6f74 2062 6520 6163 6375   may not be accu
+00023f60: 7261 7465 2c0a 2020 2020 2020 2020 2320  rate,.        # 
+00023f70: 736f 2073 697a 6520 6d61 7920 6265 2028  so size may be (
+00023f80: 7465 6d70 6f72 6172 696c 7929 206e 6567  temporarily) neg
+00023f90: 6174 6976 653b 2066 6c6f 6f72 2069 7420  ative; floor it 
+00023fa0: 746f 207a 6572 6f2e 0a20 2020 2020 2020  to zero..       
+00023fb0: 2073 697a 6520 3d20 6d61 7828 0a20 2020   size = max(.   
+00023fc0: 2020 2020 2020 2020 2030 2c20 6d65 7472           0, metr
+00023fd0: 6963 735b 226d 656d 6f72 7922 5d20 2d20  ics["memory"] - 
+00023fe0: 7773 2e6e 6279 7465 7320 2b20 6d65 7472  ws.nbytes + metr
+00023ff0: 6963 735b 2273 7069 6c6c 6564 5f62 7974  ics["spilled_byt
+00024000: 6573 225d 5b22 6d65 6d6f 7279 225d 0a20  es"]["memory"]. 
+00024010: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00024020: 2020 7773 2e5f 6d65 6d6f 7279 5f75 6e6d    ws._memory_unm
+00024030: 616e 6167 6564 5f68 6973 746f 7279 2e61  anaged_history.a
+00024040: 7070 656e 6428 286c 6f63 616c 5f6e 6f77  ppend((local_now
+00024050: 2c20 7369 7a65 2929 0a20 2020 2020 2020  , size)).       
+00024060: 2069 6620 6e6f 7420 6d65 6d6f 7279 5f75   if not memory_u
+00024070: 6e6d 616e 6167 6564 5f6f 6c64 3a0a 2020  nmanaged_old:.  
+00024080: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00024090: 776f 726b 6572 2068 6173 206a 7573 7420  worker has just 
+000240a0: 6265 656e 2073 7461 7274 6564 206f 7220  been started or 
+000240b0: 7468 6520 7072 6576 696f 7573 206d 696e  the previous min
+000240c0: 696d 756d 2068 6173 2062 6565 6e20 6578  imum has been ex
+000240d0: 7075 6e67 6564 0a20 2020 2020 2020 2020  punged.         
+000240e0: 2020 2023 2062 6563 6175 7365 2074 6f6f     # because too
+000240f0: 206f 6c64 2e0a 2020 2020 2020 2020 2020   old..          
+00024100: 2020 2320 4e6f 7465 3a20 7468 6973 2061    # Note: this a
+00024110: 6c67 6f72 6974 686d 2069 7320 6361 7070  lgorithm is capp
+00024120: 6564 2074 6f20 3230 3020 2a20 4d45 4d4f  ed to 200 * MEMO
+00024130: 5259 5f52 4543 454e 545f 544f 5f4f 4c44  RY_RECENT_TO_OLD
+00024140: 5f54 494d 4520 656c 656d 656e 7473 0a20  _TIME elements. 
+00024150: 2020 2020 2020 2020 2020 2023 2063 6c75             # clu
+00024160: 7374 6572 2d77 6964 6520 6279 2068 6561  ster-wide by hea
+00024170: 7274 6265 6174 5f69 6e74 6572 7661 6c28  rtbeat_interval(
+00024180: 292c 2072 6567 6172 646c 6573 7320 6f66  ), regardless of
+00024190: 2074 6865 206e 756d 6265 7220 6f66 2077   the number of w
+000241a0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+000241b0: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+000241c0: 6d61 6e61 6765 645f 6f6c 6420 3d20 6d69  managed_old = mi
+000241d0: 6e28 6d61 7028 7365 636f 6e64 2c20 7773  n(map(second, ws
+000241e0: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
+000241f0: 6564 5f68 6973 746f 7279 2929 0a20 2020  ed_history)).   
+00024200: 2020 2020 2065 6c69 6620 7369 7a65 203c       elif size <
+00024210: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
+00024220: 645f 6f6c 643a 0a20 2020 2020 2020 2020  d_old:.         
+00024230: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+00024240: 6d61 6e61 6765 645f 6f6c 6420 3d20 7369  managed_old = si
+00024250: 7a65 0a0a 2020 2020 2020 2020 6966 2068  ze..        if h
+00024260: 6f73 745f 696e 666f 3a0a 2020 2020 2020  ost_info:.      
+00024270: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
+00024280: 686f 7374 5f69 6e66 6f2e 7365 7464 6566  host_info.setdef
+00024290: 6175 6c74 2868 6f73 742c 207b 7d29 0a20  ault(host, {}). 
+000242a0: 2020 2020 2020 2020 2020 2064 682e 7570             dh.up
+000242b0: 6461 7465 2868 6f73 745f 696e 666f 290a  date(host_info).
+000242c0: 0a20 2020 2020 2020 2069 6620 6e6f 773a  .        if now:
+000242d0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+000242e0: 7469 6d65 5f64 656c 6179 203d 206c 6f63  time_delay = loc
+000242f0: 616c 5f6e 6f77 202d 206e 6f77 0a0a 2020  al_now - now..  
+00024300: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
+00024310: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00024320: 7365 6c66 2e61 6464 5f72 6573 6f75 7263  self.add_resourc
+00024330: 6573 2877 6f72 6b65 723d 6164 6472 6573  es(worker=addres
+00024340: 732c 2072 6573 6f75 7263 6573 3d72 6573  s, resources=res
+00024350: 6f75 7263 6573 290a 0a20 2020 2020 2020  ources)..       
+00024360: 2069 6620 6578 7465 6e73 696f 6e73 3a0a   if extensions:.
+00024370: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00024380: 6e61 6d65 2c20 6461 7461 2069 6e20 6578  name, data in ex
+00024390: 7465 6e73 696f 6e73 2e69 7465 6d73 2829  tensions.items()
+000243a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000243b0: 2020 7365 6c66 2e65 7874 656e 7369 6f6e    self.extension
+000243c0: 735b 6e61 6d65 5d2e 6865 6172 7462 6561  s[name].heartbea
+000243d0: 7428 7773 2c20 6461 7461 290a 0a20 2020  t(ws, data)..   
+000243e0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+000243f0: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00024400: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+00024410: 2020 2020 2020 2274 696d 6522 3a20 6c6f        "time": lo
+00024420: 6361 6c5f 6e6f 772c 0a20 2020 2020 2020  cal_now,.       
+00024430: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
+00024440: 696e 7465 7276 616c 223a 2068 6561 7274  interval": heart
+00024450: 6265 6174 5f69 6e74 6572 7661 6c28 6c65  beat_interval(le
+00024460: 6e28 7365 6c66 2e77 6f72 6b65 7273 2929  n(self.workers))
+00024470: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00024480: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00024490: 2061 7379 6e63 2064 6566 2061 6464 5f77   async def add_w
+000244a0: 6f72 6b65 7228 0a20 2020 2020 2020 2073  orker(.        s
+000244b0: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
+000244c0: 6d3a 2043 6f6d 6d2c 0a20 2020 2020 2020  m: Comm,.       
+000244d0: 202a 2c0a 2020 2020 2020 2020 6164 6472   *,.        addr
+000244e0: 6573 733a 2073 7472 2c0a 2020 2020 2020  ess: str,.      
+000244f0: 2020 7374 6174 7573 3a20 7374 722c 0a20    status: str,. 
+00024500: 2020 2020 2020 2073 6572 7665 725f 6964         server_id
+00024510: 3a20 7374 722c 0a20 2020 2020 2020 206e  : str,.        n
+00024520: 7468 7265 6164 733a 2069 6e74 2c0a 2020  threads: int,.  
+00024530: 2020 2020 2020 6e61 6d65 3a20 7374 722c        name: str,
+00024540: 0a20 2020 2020 2020 2072 6573 6f6c 7665  .        resolve
+00024550: 5f61 6464 7265 7373 3a20 626f 6f6c 203d  _address: bool =
+00024560: 2054 7275 652c 0a20 2020 2020 2020 206e   True,.        n
+00024570: 6f77 3a20 666c 6f61 742c 0a20 2020 2020  ow: float,.     
+00024580: 2020 2072 6573 6f75 7263 6573 3a20 6469     resources: di
+00024590: 6374 5b73 7472 2c20 666c 6f61 745d 2c0a  ct[str, float],.
+000245a0: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+000245b0: 2054 6869 7320 6973 206e 6576 6572 2073   This is never s
+000245c0: 7562 6d69 7474 6564 2062 7920 7468 6520  ubmitted by the 
+000245d0: 776f 726b 6572 0a20 2020 2020 2020 2068  worker.        h
+000245e0: 6f73 745f 696e 666f 3a20 4e6f 6e65 203d  ost_info: None =
+000245f0: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00024600: 656d 6f72 795f 6c69 6d69 743a 2069 6e74  emory_limit: int
+00024610: 207c 204e 6f6e 652c 0a20 2020 2020 2020   | None,.       
+00024620: 206d 6574 7269 6373 3a20 6469 6374 5b73   metrics: dict[s
+00024630: 7472 2c20 416e 795d 2c0a 2020 2020 2020  tr, Any],.      
+00024640: 2020 7069 643a 2069 6e74 203d 2030 2c0a    pid: int = 0,.
+00024650: 2020 2020 2020 2020 7365 7276 6963 6573          services
+00024660: 3a20 6469 6374 5b73 7472 2c20 696e 745d  : dict[str, int]
+00024670: 2c0a 2020 2020 2020 2020 6c6f 6361 6c5f  ,.        local_
+00024680: 6469 7265 6374 6f72 793a 2073 7472 2c0a  directory: str,.
+00024690: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000246a0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+000246b0: 2c0a 2020 2020 2020 2020 6e61 6e6e 793a  ,.        nanny:
+000246c0: 2073 7472 2c0a 2020 2020 2020 2020 6578   str,.        ex
+000246d0: 7472 613a 2064 6963 742c 0a20 2020 2020  tra: dict,.     
+000246e0: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+000246f0: 7374 722c 0a20 2020 2029 202d 3e20 4e6f  str,.    ) -> No
+00024700: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
+00024710: 6464 2061 206e 6577 2077 6f72 6b65 7220  dd a new worker 
+00024720: 746f 2074 6865 2063 6c75 7374 6572 2222  to the cluster""
+00024730: 220a 2020 2020 2020 2020 6164 6472 6573  ".        addres
+00024740: 7320 3d20 7365 6c66 2e63 6f65 7263 655f  s = self.coerce_
+00024750: 6164 6472 6573 7328 6164 6472 6573 732c  address(address,
+00024760: 2072 6573 6f6c 7665 5f61 6464 7265 7373   resolve_address
+00024770: 290a 2020 2020 2020 2020 6164 6472 6573  ).        addres
+00024780: 7320 3d20 6e6f 726d 616c 697a 655f 6164  s = normalize_ad
+00024790: 6472 6573 7328 6164 6472 6573 7329 0a20  dress(address). 
+000247a0: 2020 2020 2020 2068 6f73 7420 3d20 6765         host = ge
+000247b0: 745f 6164 6472 6573 735f 686f 7374 2861  t_address_host(a
+000247c0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+000247d0: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
+000247e0: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+000247f0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00024800: 616c 7565 4572 726f 7228 2257 6f72 6b65  alueError("Worke
+00024810: 7220 616c 7265 6164 7920 6578 6973 7473  r already exists
+00024820: 2025 7322 2025 2061 6464 7265 7373 290a   %s" % address).
+00024830: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+00024840: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
+00024850: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00024860: 6767 6572 2e77 6172 6e69 6e67 2822 576f  gger.warning("Wo
+00024870: 726b 6572 2074 7269 6564 2074 6f20 636f  rker tried to co
+00024880: 6e6e 6563 7420 7769 7468 2061 2064 7570  nnect with a dup
+00024890: 6c69 6361 7465 206e 616d 653a 2025 7322  licate name: %s"
+000248a0: 2c20 6e61 6d65 290a 2020 2020 2020 2020  , name).        
+000248b0: 2020 2020 6d73 6720 3d20 7b0a 2020 2020      msg = {.    
+000248c0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+000248d0: 7475 7322 3a20 2265 7272 6f72 222c 0a20  tus": "error",. 
+000248e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000248f0: 6d65 7373 6167 6522 3a20 226e 616d 6520  message": "name 
+00024900: 7461 6b65 6e2c 2025 7322 2025 206e 616d  taken, %s" % nam
+00024910: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00024920: 2020 2022 7469 6d65 223a 2074 696d 6528     "time": time(
+00024930: 292c 0a20 2020 2020 2020 2020 2020 207d  ),.            }
+00024940: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00024950: 6974 2063 6f6d 6d2e 7772 6974 6528 6d73  it comm.write(ms
+00024960: 6729 0a20 2020 2020 2020 2020 2020 2072  g).            r
+00024970: 6574 7572 6e0a 0a20 2020 2020 2020 2073  eturn..        s
+00024980: 656c 662e 6c6f 675f 6576 656e 7428 6164  elf.log_event(ad
+00024990: 6472 6573 732c 207b 2261 6374 696f 6e22  dress, {"action"
+000249a0: 3a20 2261 6464 2d77 6f72 6b65 7222 7d29  : "add-worker"})
+000249b0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+000249c0: 675f 6576 656e 7428 2261 6c6c 222c 207b  g_event("all", {
+000249d0: 2261 6374 696f 6e22 3a20 2261 6464 2d77  "action": "add-w
+000249e0: 6f72 6b65 7222 2c20 2277 6f72 6b65 7222  orker", "worker"
+000249f0: 3a20 6164 6472 6573 737d 290a 0a20 2020  : address})..   
+00024a00: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
+00024a10: 735b 6164 6472 6573 735d 203d 2077 7320  s[address] = ws 
+00024a20: 3d20 576f 726b 6572 5374 6174 6528 0a20  = WorkerState(. 
+00024a30: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00024a40: 7373 3d61 6464 7265 7373 2c0a 2020 2020  ss=address,.    
+00024a50: 2020 2020 2020 2020 7374 6174 7573 3d53          status=S
+00024a60: 7461 7475 732e 6c6f 6f6b 7570 5b73 7461  tatus.lookup[sta
+00024a70: 7475 735d 2c20 2023 2074 7970 653a 2069  tus],  # type: i
+00024a80: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+00024a90: 2020 7069 643d 7069 642c 0a20 2020 2020    pid=pid,.     
+00024aa0: 2020 2020 2020 206e 7468 7265 6164 733d         nthreads=
+00024ab0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
+00024ac0: 2020 2020 2020 6d65 6d6f 7279 5f6c 696d        memory_lim
+00024ad0: 6974 3d6d 656d 6f72 795f 6c69 6d69 7420  it=memory_limit 
+00024ae0: 6f72 2030 2c0a 2020 2020 2020 2020 2020  or 0,.          
+00024af0: 2020 6e61 6d65 3d6e 616d 652c 0a20 2020    name=name,.   
+00024b00: 2020 2020 2020 2020 206c 6f63 616c 5f64           local_d
+00024b10: 6972 6563 746f 7279 3d6c 6f63 616c 5f64  irectory=local_d
+00024b20: 6972 6563 746f 7279 2c0a 2020 2020 2020  irectory,.      
+00024b30: 2020 2020 2020 7365 7276 6963 6573 3d73        services=s
+00024b40: 6572 7669 6365 732c 0a20 2020 2020 2020  ervices,.       
+00024b50: 2020 2020 2076 6572 7369 6f6e 733d 7665       versions=ve
+00024b60: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+00024b70: 2020 2020 6e61 6e6e 793d 6e61 6e6e 792c      nanny=nanny,
+00024b80: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+00024b90: 7261 3d65 7874 7261 2c0a 2020 2020 2020  ra=extra,.      
+00024ba0: 2020 2020 2020 7365 7276 6572 5f69 643d        server_id=
+00024bb0: 7365 7276 6572 5f69 642c 0a20 2020 2020  server_id,.     
+00024bc0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00024bd0: 3d73 656c 662c 0a20 2020 2020 2020 2029  =self,.        )
+00024be0: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
+00024bf0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+00024c00: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00024c10: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
+00024c20: 672e 6164 6428 7773 290a 0a20 2020 2020  g.add(ws)..     
+00024c30: 2020 2064 6820 3d20 7365 6c66 2e68 6f73     dh = self.hos
+00024c40: 745f 696e 666f 2e67 6574 2868 6f73 7429  t_info.get(host)
+00024c50: 0a20 2020 2020 2020 2069 6620 6468 2069  .        if dh i
+00024c60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00024c70: 2020 2020 7365 6c66 2e68 6f73 745f 696e      self.host_in
+00024c80: 666f 5b68 6f73 745d 203d 2064 6820 3d20  fo[host] = dh = 
+00024c90: 7b7d 0a0a 2020 2020 2020 2020 6468 5f61  {}..        dh_a
+00024ca0: 6464 7265 7373 6573 203d 2064 682e 6765  ddresses = dh.ge
+00024cb0: 7428 2261 6464 7265 7373 6573 2229 0a20  t("addresses"). 
+00024cc0: 2020 2020 2020 2069 6620 6468 5f61 6464         if dh_add
+00024cd0: 7265 7373 6573 2069 7320 4e6f 6e65 3a0a  resses is None:.
+00024ce0: 2020 2020 2020 2020 2020 2020 6468 5b22              dh["
+00024cf0: 6164 6472 6573 7365 7322 5d20 3d20 6468  addresses"] = dh
+00024d00: 5f61 6464 7265 7373 6573 203d 2073 6574  _addresses = set
+00024d10: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
+00024d20: 685b 226e 7468 7265 6164 7322 5d20 3d20  h["nthreads"] = 
+00024d30: 300a 0a20 2020 2020 2020 2064 685f 6164  0..        dh_ad
+00024d40: 6472 6573 7365 732e 6164 6428 6164 6472  dresses.add(addr
+00024d50: 6573 7329 0a20 2020 2020 2020 2064 685b  ess).        dh[
+00024d60: 226e 7468 7265 6164 7322 5d20 2b3d 206e  "nthreads"] += n
+00024d70: 7468 7265 6164 730a 0a20 2020 2020 2020  threads..       
+00024d80: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+00024d90: 6561 6473 202b 3d20 6e74 6872 6561 6473  eads += nthreads
+00024da0: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00024db0: 7461 6c5f 6e74 6872 6561 6473 5f68 6973  tal_nthreads_his
+00024dc0: 746f 7279 2e61 7070 656e 6428 2874 696d  tory.append((tim
+00024dd0: 6528 292c 2073 656c 662e 746f 7461 6c5f  e(), self.total_
+00024de0: 6e74 6872 6561 6473 2929 0a20 2020 2020  nthreads)).     
+00024df0: 2020 2073 656c 662e 616c 6961 7365 735b     self.aliases[
+00024e00: 6e61 6d65 5d20 3d20 6164 6472 6573 730a  name] = address.
+00024e10: 0a20 2020 2020 2020 2073 656c 662e 6865  .        self.he
+00024e20: 6172 7462 6561 745f 776f 726b 6572 280a  artbeat_worker(.
+00024e30: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00024e40: 6573 733d 6164 6472 6573 732c 0a20 2020  ess=address,.   
+00024e50: 2020 2020 2020 2020 2072 6573 6f6c 7665           resolve
+00024e60: 5f61 6464 7265 7373 3d72 6573 6f6c 7665  _address=resolve
+00024e70: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
+00024e80: 2020 2020 2020 6e6f 773d 6e6f 772c 0a20        now=now,. 
+00024e90: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+00024ea0: 7263 6573 3d72 6573 6f75 7263 6573 2c0a  rces=resources,.
+00024eb0: 2020 2020 2020 2020 2020 2020 686f 7374              host
+00024ec0: 5f69 6e66 6f3d 686f 7374 5f69 6e66 6f2c  _info=host_info,
+00024ed0: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+00024ee0: 7269 6373 3d6d 6574 7269 6373 2c0a 2020  rics=metrics,.  
+00024ef0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00024f00: 2023 2044 6f20 6e6f 7420 6e65 6564 2074   # Do not need t
+00024f10: 6f20 6164 6a75 7374 2073 656c 662e 746f  o adjust self.to
+00024f20: 7461 6c5f 6f63 6375 7061 6e63 7920 6173  tal_occupancy as
+00024f30: 2073 656c 662e 6f63 6375 7061 6e63 795b   self.occupancy[
+00024f40: 7773 5d20 6361 6e6e 6f74 0a20 2020 2020  ws] cannot.     
+00024f50: 2020 2023 2065 7869 7374 2062 6566 6f72     # exist befor
+00024f60: 6520 7468 6973 2e0a 2020 2020 2020 2020  e this..        
+00024f70: 7365 6c66 2e63 6865 636b 5f69 646c 655f  self.check_idle_
+00024f80: 7361 7475 7261 7465 6428 7773 290a 0a20  saturated(ws).. 
+00024f90: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+00024fa0: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
+00024fb0: 5d20 3d20 4261 7463 6865 6453 656e 6428  ] = BatchedSend(
+00024fc0: 696e 7465 7276 616c 3d22 356d 7322 2c20  interval="5ms", 
+00024fd0: 6c6f 6f70 3d73 656c 662e 6c6f 6f70 290a  loop=self.loop).
+00024fe0: 0a20 2020 2020 2020 2061 7761 6974 6162  .        awaitab
+00024ff0: 6c65 7320 3d20 5b5d 0a20 2020 2020 2020  les = [].       
+00025000: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00025010: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00025020: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
+00025030: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00025040: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00025050: 756c 7420 3d20 706c 7567 696e 2e61 6464  ult = plugin.add
+00025060: 5f77 6f72 6b65 7228 7363 6865 6475 6c65  _worker(schedule
+00025070: 723d 7365 6c66 2c20 776f 726b 6572 3d61  r=self, worker=a
+00025080: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00025090: 2020 2020 2020 2020 6966 2072 6573 756c          if resul
+000250a0: 7420 6973 206e 6f74 204e 6f6e 6520 616e  t is not None an
+000250b0: 6420 696e 7370 6563 742e 6973 6177 6169  d inspect.isawai
+000250c0: 7461 626c 6528 7265 7375 6c74 293a 0a20  table(result):. 
+000250d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000250e0: 2020 2061 7761 6974 6162 6c65 732e 6170     awaitables.ap
+000250f0: 7065 6e64 2872 6573 756c 7429 0a20 2020  pend(result).   
+00025100: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00025110: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00025120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025130: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00025140: 2865 290a 0a20 2020 2020 2020 2070 6c75  (e)..        plu
+00025150: 6769 6e5f 6d73 6773 203d 2061 7761 6974  gin_msgs = await
+00025160: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00025170: 2a61 7761 6974 6162 6c65 732c 2072 6574  *awaitables, ret
+00025180: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
+00025190: 7275 6529 0a20 2020 2020 2020 2070 6c75  rue).        plu
+000251a0: 6769 6e73 5f65 7863 6570 7469 6f6e 7320  gins_exceptions 
+000251b0: 3d20 5b6d 7367 2066 6f72 206d 7367 2069  = [msg for msg i
+000251c0: 6e20 706c 7567 696e 5f6d 7367 7320 6966  n plugin_msgs if
+000251d0: 2069 7369 6e73 7461 6e63 6528 6d73 672c   isinstance(msg,
+000251e0: 2045 7863 6570 7469 6f6e 295d 0a20 2020   Exception)].   
+000251f0: 2020 2020 2066 6f72 2065 7863 2069 6e20       for exc in 
+00025200: 706c 7567 696e 735f 6578 6365 7074 696f  plugins_exceptio
+00025210: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00025220: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00025230: 2865 7863 2c20 6578 635f 696e 666f 3d65  (exc, exc_info=e
+00025240: 7863 290a 0a20 2020 2020 2020 2069 6620  xc)..        if 
+00025250: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+00025260: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+00025270: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+00025280: 616e 7369 7469 6f6e 7328 0a20 2020 2020  ansitions(.     
+00025290: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000252a0: 6275 6c6b 5f73 6368 6564 756c 655f 756e  bulk_schedule_un
+000252b0: 7275 6e6e 6162 6c65 5f61 6674 6572 5f61  runnable_after_a
+000252c0: 6464 696e 675f 776f 726b 6572 2877 7329  dding_worker(ws)
+000252d0: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
+000252e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000252f0: 2020 2020 2020 2020 7365 6c66 2e73 7469          self.sti
+00025300: 6d75 6c75 735f 7175 6575 655f 736c 6f74  mulus_queue_slot
+00025310: 735f 6d61 7962 655f 6f70 656e 6564 2873  s_maybe_opened(s
+00025320: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00025330: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
+00025340: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+00025350: 6769 7374 6572 2077 6f72 6b65 7220 2573  gister worker %s
+00025360: 222c 2077 7329 0a0a 2020 2020 2020 2020  ", ws)..        
+00025370: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+00025380: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
+00025390: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
+000253a0: 2274 696d 6522 3a20 7469 6d65 2829 2c0a  "time": time(),.
+000253b0: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
+000253c0: 7274 6265 6174 2d69 6e74 6572 7661 6c22  rtbeat-interval"
+000253d0: 3a20 6865 6172 7462 6561 745f 696e 7465  : heartbeat_inte
+000253e0: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
+000253f0: 726b 6572 7329 292c 0a20 2020 2020 2020  rkers)),.       
+00025400: 2020 2020 2022 776f 726b 6572 2d70 6c75       "worker-plu
+00025410: 6769 6e73 223a 2073 656c 662e 776f 726b  gins": self.work
+00025420: 6572 5f70 6c75 6769 6e73 2c0a 2020 2020  er_plugins,.    
+00025430: 2020 2020 7d0a 0a20 2020 2020 2020 2076      }..        v
+00025440: 6572 7369 6f6e 5f77 6172 6e69 6e67 203d  ersion_warning =
+00025450: 2076 6572 7369 6f6e 5f6d 6f64 756c 652e   version_module.
+00025460: 6572 726f 725f 6d65 7373 6167 6528 0a20  error_message(. 
+00025470: 2020 2020 2020 2020 2020 2076 6572 7369             versi
+00025480: 6f6e 5f6d 6f64 756c 652e 6765 745f 7665  on_module.get_ve
+00025490: 7273 696f 6e73 2829 2c0a 2020 2020 2020  rsions(),.      
+000254a0: 2020 2020 2020 7b77 3a20 7773 2e76 6572        {w: ws.ver
+000254b0: 7369 6f6e 7320 666f 7220 772c 2077 7320  sions for w, ws 
+000254c0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+000254d0: 6974 656d 7328 297d 2c0a 2020 2020 2020  items()},.      
+000254e0: 2020 2020 2020 7665 7273 696f 6e73 2c0a        versions,.
+000254f0: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00025500: 6365 5f6e 616d 653d 7374 7228 7773 2e73  ce_name=str(ws.s
+00025510: 6572 7665 725f 6964 292c 0a20 2020 2020  erver_id),.     
+00025520: 2020 2029 0a20 2020 2020 2020 206d 7367     ).        msg
+00025530: 2e75 7064 6174 6528 7665 7273 696f 6e5f  .update(version_
+00025540: 7761 726e 696e 6729 0a0a 2020 2020 2020  warning)..      
+00025550: 2020 6177 6169 7420 636f 6d6d 2e77 7269    await comm.wri
+00025560: 7465 286d 7367 290a 2020 2020 2020 2020  te(msg).        
+00025570: 2320 5468 6973 2077 696c 6c20 6b65 6570  # This will keep
+00025580: 2072 756e 6e69 6e67 2075 6e74 696c 2074   running until t
+00025590: 6865 2077 6f72 6b65 7220 6973 2072 656d  he worker is rem
+000255a0: 6f76 6564 0a20 2020 2020 2020 2061 7761  oved.        awa
+000255b0: 6974 2073 656c 662e 6861 6e64 6c65 5f77  it self.handle_w
+000255c0: 6f72 6b65 7228 636f 6d6d 2c20 6164 6472  orker(comm, addr
+000255d0: 6573 7329 0a0a 2020 2020 6173 796e 6320  ess)..    async 
+000255e0: 6465 6620 6164 645f 6e61 6e6e 7928 7365  def add_nanny(se
+000255f0: 6c66 2920 2d3e 2064 6963 745b 7374 722c  lf) -> dict[str,
+00025600: 2041 6e79 5d3a 0a20 2020 2020 2020 206d   Any]:.        m
+00025610: 7367 203d 207b 0a20 2020 2020 2020 2020  sg = {.         
+00025620: 2020 2022 7374 6174 7573 223a 2022 4f4b     "status": "OK
+00025630: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00025640: 6e61 6e6e 792d 706c 7567 696e 7322 3a20  nanny-plugins": 
+00025650: 7365 6c66 2e6e 616e 6e79 5f70 6c75 6769  self.nanny_plugi
+00025660: 6e73 2c0a 2020 2020 2020 2020 7d0a 2020  ns,.        }.  
+00025670: 2020 2020 2020 7265 7475 726e 206d 7367        return msg
+00025680: 0a0a 2020 2020 6465 6620 7570 6461 7465  ..    def update
+00025690: 5f67 7261 7068 280a 2020 2020 2020 2020  _graph(.        
+000256a0: 7365 6c66 2c0a 2020 2020 2020 2020 636c  self,.        cl
+000256b0: 6965 6e74 3a20 7374 722c 0a20 2020 2020  ient: str,.     
+000256c0: 2020 2067 7261 7068 5f68 6561 6465 723a     graph_header:
+000256d0: 2064 6963 742c 0a20 2020 2020 2020 2067   dict,.        g
+000256e0: 7261 7068 5f66 7261 6d65 733a 206c 6973  raph_frames: lis
+000256f0: 745b 6279 7465 735d 2c0a 2020 2020 2020  t[bytes],.      
+00025700: 2020 6b65 7973 3a20 6c69 7374 5b73 7472    keys: list[str
+00025710: 5d2c 0a20 2020 2020 2020 2069 6e74 6572  ],.        inter
+00025720: 6e61 6c5f 7072 696f 7269 7479 3a20 6469  nal_priority: di
+00025730: 6374 5b73 7472 2c20 696e 745d 207c 204e  ct[str, int] | N
+00025740: 6f6e 652c 0a20 2020 2020 2020 2073 7562  one,.        sub
+00025750: 6d69 7474 696e 675f 7461 736b 3a20 7374  mitting_task: st
+00025760: 7220 7c20 4e6f 6e65 2c0a 2020 2020 2020  r | None,.      
+00025770: 2020 7573 6572 5f70 7269 6f72 6974 793a    user_priority:
+00025780: 2069 6e74 207c 2064 6963 745b 7374 722c   int | dict[str,
+00025790: 2069 6e74 5d20 3d20 302c 0a20 2020 2020   int] = 0,.     
+000257a0: 2020 2061 6374 6f72 733a 2062 6f6f 6c20     actors: bool 
+000257b0: 7c20 6c69 7374 5b73 7472 5d20 7c20 4e6f  | list[str] | No
+000257c0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+000257d0: 2020 2066 6966 6f5f 7469 6d65 6f75 743a     fifo_timeout:
+000257e0: 2066 6c6f 6174 203d 2030 2e30 2c0a 2020   float = 0.0,.  
+000257f0: 2020 2020 2020 636f 6465 3a20 7475 706c        code: tupl
+00025800: 655b 536f 7572 6365 436f 6465 2c20 2e2e  e[SourceCode, ..
+00025810: 2e5d 203d 2028 292c 0a20 2020 2020 2020  .] = (),.       
+00025820: 2061 6e6e 6f74 6174 696f 6e73 3a20 6469   annotations: di
+00025830: 6374 207c 204e 6f6e 6520 3d20 4e6f 6e65  ct | None = None
+00025840: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+00025850: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
+00025860: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
+00025870: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00025880: 2073 7461 7274 203d 2074 696d 6528 290a   start = time().
+00025890: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000258a0: 2020 2020 2020 2020 2023 2054 4f44 4f3a           # TODO:
+000258b0: 2064 6573 6572 6961 6c69 7a61 7469 6f6e   deserialization
+000258c0: 202b 206d 6174 6572 6961 6c69 7a61 7469   + materializati
+000258d0: 6f6e 2073 686f 756c 6420 6265 206f 6666  on should be off
+000258e0: 6c6f 6164 6564 2074 6f20 610a 2020 2020  loaded to a.    
+000258f0: 2020 2020 2020 2020 2320 7468 7265 6164          # thread
+00025900: 2073 696e 6365 2074 6869 7320 6973 206e   since this is n
+00025910: 6f6e 2d74 7269 7669 616c 2063 6f6d 7075  on-trivial compu
+00025920: 7465 2074 696d 6520 7468 6174 2062 6c6f  te time that blo
+00025930: 636b 7320 7468 650a 2020 2020 2020 2020  cks the.        
+00025940: 2020 2020 2320 6576 656e 7420 6c6f 6f70      # event loop
+00025950: 2e20 5468 6973 206c 696b 656c 7920 7265  . This likely re
+00025960: 7175 6972 6573 2075 7320 746f 2075 7365  quires us to use
+00025970: 2061 206c 6f63 6b20 7369 6e63 6520 7765   a lock since we
+00025980: 206e 6565 6420 746f 0a20 2020 2020 2020   need to.       
+00025990: 2020 2020 2023 2067 7561 7261 6e74 6565       # guarantee
+000259a0: 206f 7264 6572 696e 6720 6f66 2075 7064   ordering of upd
+000259b0: 6174 655f 6772 6170 6820 6361 6c6c 7320  ate_graph calls 
+000259c0: 2861 7320 6c6f 6e67 2061 7320 7468 6572  (as long as ther
+000259d0: 6520 6973 206a 7573 740a 2020 2020 2020  e is just.      
+000259e0: 2020 2020 2020 2320 6120 7369 6e67 6c65        # a single
+000259f0: 206f 6666 6c6f 6164 2074 6872 6561 642c   offload thread,
+00025a00: 2074 6869 7320 6973 206e 6f74 2061 2070   this is not a p
+00025a10: 726f 626c 656d 290a 2020 2020 2020 2020  roblem).        
+00025a20: 2020 2020 6672 6f6d 2064 6973 7472 6962      from distrib
+00025a30: 7574 6564 2e70 726f 746f 636f 6c20 696d  uted.protocol im
+00025a40: 706f 7274 2064 6573 6572 6961 6c69 7a65  port deserialize
+00025a50: 0a0a 2020 2020 2020 2020 2020 2020 6772  ..            gr
+00025a60: 6170 6820 3d20 6465 7365 7269 616c 697a  aph = deserializ
+00025a70: 6528 6772 6170 685f 6865 6164 6572 2c20  e(graph_header, 
+00025a80: 6772 6170 685f 6672 616d 6573 292e 6461  graph_frames).da
+00025a90: 7461 0a20 2020 2020 2020 2065 7863 6570  ta.        excep
+00025aa0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00025ab0: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+00025ac0: 6720 3d20 2222 225c 0a20 2020 2020 2020  g = """\.       
+00025ad0: 2020 2020 2020 2020 2045 7272 6f72 2064           Error d
+00025ae0: 7572 696e 6720 6465 7365 7269 616c 697a  uring deserializ
+00025af0: 6174 696f 6e20 6f66 2074 6865 2074 6173  ation of the tas
+00025b00: 6b20 6772 6170 682e 2054 6869 7320 6672  k graph. This fr
+00025b10: 6571 7565 6e74 6c79 206f 6363 7572 7320  equently occurs 
+00025b20: 6966 2074 6865 2053 6368 6564 756c 6572  if the Scheduler
+00025b30: 2061 6e64 2043 6c69 656e 7420 6861 7665   and Client have
+00025b40: 2064 6966 6665 7265 6e74 2065 6e76 6972   different envir
+00025b50: 6f6e 6d65 6e74 732e 2046 6f72 206d 6f72  onments. For mor
+00025b60: 6520 696e 666f 726d 6174 696f 6e2c 2073  e information, s
+00025b70: 6565 2068 7474 7073 3a2f 2f64 6f63 732e  ee https://docs.
+00025b80: 6461 736b 2e6f 7267 2f65 6e2f 7374 6162  dask.org/en/stab
+00025b90: 6c65 2f64 6570 6c6f 796d 656e 742d 636f  le/deployment-co
+00025ba0: 6e73 6964 6572 6174 696f 6e73 2e68 746d  nsiderations.htm
+00025bb0: 6c23 636f 6e73 6973 7465 6e74 2d73 6f66  l#consistent-sof
+00025bc0: 7477 6172 652d 656e 7669 726f 6e6d 656e  tware-environmen
+00025bd0: 7473 0a20 2020 2020 2020 2020 2020 2022  ts.            "
+00025be0: 2222 0a20 2020 2020 2020 2020 2020 2074  "".            t
+00025bf0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00025c00: 2020 2020 7261 6973 6520 5275 6e74 696d      raise Runtim
+00025c10: 6545 7272 6f72 2874 6578 7477 7261 702e  eError(textwrap.
+00025c20: 6465 6465 6e74 286d 7367 2929 2066 726f  dedent(msg)) fro
+00025c30: 6d20 650a 2020 2020 2020 2020 2020 2020  m e.            
+00025c40: 6578 6365 7074 2052 756e 7469 6d65 4572  except RuntimeEr
+00025c50: 726f 7220 6173 2065 3a0a 2020 2020 2020  ror as e:.      
+00025c60: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
+00025c70: 6572 726f 725f 6d65 7373 6167 6528 6529  error_message(e)
+00025c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025c90: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
+00025ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00025cb0: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
+00025cc0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+00025cd0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00025ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025cf0: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+00025d00: 7461 736b 2d65 7272 6564 222c 0a20 2020  task-erred",.   
+00025d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d20: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
+00025d30: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00025d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d50: 2022 6578 6365 7074 696f 6e22 3a20 6572   "exception": er
+00025d60: 725b 2265 7863 6570 7469 6f6e 225d 2c0a  r["exception"],.
+00025d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d80: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+00025d90: 6365 6261 636b 223a 2065 7272 5b22 7472  ceback": err["tr
+00025da0: 6163 6562 6163 6b22 5d2c 0a20 2020 2020  aceback"],.     
+00025db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025dc0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
+00025dd0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00025de0: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+00025df0: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
+00025e00: 6e73 203d 2061 6e6e 6f74 6174 696f 6e73  ns = annotations
+00025e10: 206f 7220 7b7d 0a20 2020 2020 2020 2069   or {}.        i
+00025e20: 6620 6973 696e 7374 616e 6365 2861 6e6e  f isinstance(ann
+00025e30: 6f74 6174 696f 6e73 2c20 546f 5069 636b  otations, ToPick
+00025e40: 6c65 293a 2020 2320 7479 7065 3a20 6967  le):  # type: ig
+00025e50: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
+00025e60: 2023 2046 4958 4d45 3a20 7768 6174 2074   # FIXME: what t
+00025e70: 6865 2068 6563 6b3f 0a20 2020 2020 2020  he heck?.       
+00025e80: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
+00025e90: 203d 2061 6e6e 6f74 6174 696f 6e73 2e64   = annotations.d
+00025ea0: 6174 6120 2023 2074 7970 653a 2069 676e  ata  # type: ign
+00025eb0: 6f72 650a 2020 2020 2020 2020 7374 696d  ore.        stim
+00025ec0: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
+00025ed0: 7573 5f69 6420 6f72 2066 2275 7064 6174  us_id or f"updat
+00025ee0: 652d 6772 6170 682d 7b74 696d 6528 297d  e-graph-{time()}
+00025ef0: 220a 2020 2020 2020 2020 280a 2020 2020  ".        (.    
+00025f00: 2020 2020 2020 2020 6473 6b2c 0a20 2020          dsk,.   
+00025f10: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00025f20: 6e63 6965 732c 0a20 2020 2020 2020 2020  ncies,.         
+00025f30: 2020 206c 6179 6572 5f61 6e6e 6f74 6174     layer_annotat
+00025f40: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00025f50: 2020 7072 655f 7374 7269 6e67 6966 6965    pre_stringifie
+00025f60: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
+00025f70: 2920 3d20 7365 6c66 2e6d 6174 6572 6961  ) = self.materia
+00025f80: 6c69 7a65 5f67 7261 7068 2867 7261 7068  lize_graph(graph
+00025f90: 290a 0a20 2020 2020 2020 2072 6571 7565  )..        reque
+00025fa0: 7374 6564 5f6b 6579 7320 3d20 7365 7428  sted_keys = set(
+00025fb0: 6b65 7973 290a 2020 2020 2020 2020 6465  keys).        de
+00025fc0: 6c20 6b65 7973 0a20 2020 2020 2020 2069  l keys.        i
+00025fd0: 6620 6c65 6e28 6473 6b29 203e 2031 3a0a  f len(dsk) > 1:.
+00025fe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00025ff0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+00026000: 2020 2020 2020 2020 2020 2020 5b22 616c              ["al
+00026010: 6c22 2c20 636c 6965 6e74 5d2c 207b 2261  l", client], {"a
+00026020: 6374 696f 6e22 3a20 2275 7064 6174 655f  ction": "update_
+00026030: 6772 6170 6822 2c20 2263 6f75 6e74 223a  graph", "count":
+00026040: 206c 656e 2864 736b 297d 0a20 2020 2020   len(dsk)}.     
+00026050: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00026060: 2073 656c 662e 5f70 6f70 5f6b 6e6f 776e   self._pop_known
+00026070: 5f74 6173 6b73 2864 736b 2c20 6465 7065  _tasks(dsk, depe
+00026080: 6e64 656e 6369 6573 290a 0a20 2020 2020  ndencies)..     
+00026090: 2020 2069 6620 6c6f 7374 5f6b 6579 7320     if lost_keys 
+000260a0: 3a3d 2073 656c 662e 5f70 6f70 5f6c 6f73  := self._pop_los
+000260b0: 745f 7461 736b 7328 6473 6b2c 2064 6570  t_tasks(dsk, dep
+000260c0: 656e 6465 6e63 6965 732c 2072 6571 7565  endencies, reque
+000260d0: 7374 6564 5f6b 6579 7329 3a0a 2020 2020  sted_keys):.    
+000260e0: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+000260f0: 6f72 7428 7b22 6f70 223a 2022 6361 6e63  ort({"op": "canc
+00026100: 656c 6c65 642d 6b65 7973 222c 2022 6b65  elled-keys", "ke
+00026110: 7973 223a 206c 6f73 745f 6b65 7973 7d2c  ys": lost_keys},
+00026120: 2063 6c69 656e 743d 636c 6965 6e74 290a   client=client).
+00026130: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00026140: 2e63 6c69 656e 745f 7265 6c65 6173 6573  .client_releases
+00026150: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
+00026160: 2020 2020 2020 206b 6579 733d 6c6f 7374         keys=lost
+00026170: 5f6b 6579 732c 2063 6c69 656e 743d 636c  _keys, client=cl
+00026180: 6965 6e74 2c20 7374 696d 756c 7573 5f69  ient, stimulus_i
+00026190: 643d 7374 696d 756c 7573 5f69 640a 2020  d=stimulus_id.  
+000261a0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000261b0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+000261c0: 2e69 735f 6964 6c65 2061 6e64 2073 656c  .is_idle and sel
+000261d0: 662e 636f 6d70 7574 6174 696f 6e73 3a0a  f.computations:.
+000261e0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+000261f0: 696c 6c20 776f 726b 696e 6720 6f6e 2073  ill working on s
+00026200: 6f6d 6574 6869 6e67 2e20 4173 7369 676e  omething. Assign
+00026210: 206e 6577 2074 6173 6b73 2074 6f20 7361   new tasks to sa
+00026220: 6d65 2063 6f6d 7075 7461 7469 6f6e 0a20  me computation. 
+00026230: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+00026240: 7461 7469 6f6e 203d 2073 656c 662e 636f  tation = self.co
+00026250: 6d70 7574 6174 696f 6e73 5b2d 315d 0a20  mputations[-1]. 
+00026260: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00026270: 2020 2020 2020 2020 2063 6f6d 7075 7461           computa
+00026280: 7469 6f6e 203d 2043 6f6d 7075 7461 7469  tion = Computati
+00026290: 6f6e 2829 0a20 2020 2020 2020 2020 2020  on().           
+000262a0: 2073 656c 662e 636f 6d70 7574 6174 696f   self.computatio
+000262b0: 6e73 2e61 7070 656e 6428 636f 6d70 7574  ns.append(comput
+000262c0: 6174 696f 6e29 0a0a 2020 2020 2020 2020  ation)..        
+000262d0: 6966 2063 6f64 653a 2020 2320 6164 6420  if code:  # add 
+000262e0: 6e65 7720 636f 6465 2062 6c6f 636b 730a  new code blocks.
+000262f0: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00026300: 7574 6174 696f 6e2e 636f 6465 2e61 6464  utation.code.add
+00026310: 2863 6f64 6529 0a20 2020 2020 2020 2069  (code).        i
+00026320: 6620 616e 6e6f 7461 7469 6f6e 733a 0a20  f annotations:. 
+00026330: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+00026340: 7461 7469 6f6e 2e61 6e6e 6f74 6174 696f  tation.annotatio
+00026350: 6e73 2e75 7064 6174 6528 616e 6e6f 7461  ns.update(annota
+00026360: 7469 6f6e 7329 0a0a 2020 2020 2020 2020  tions)..        
+00026370: 7275 6e6e 6162 6c65 2c20 746f 7563 6865  runnable, touche
+00026380: 645f 7461 736b 732c 206e 6577 5f74 6173  d_tasks, new_tas
+00026390: 6b73 203d 2073 656c 662e 5f67 656e 6572  ks = self._gener
+000263a0: 6174 655f 7461 736b 7374 6174 6573 280a  ate_taskstates(.
+000263b0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+000263c0: 3d72 6571 7565 7374 6564 5f6b 6579 732c  =requested_keys,
+000263d0: 0a20 2020 2020 2020 2020 2020 2064 736b  .            dsk
+000263e0: 3d64 736b 2c0a 2020 2020 2020 2020 2020  =dsk,.          
+000263f0: 2020 6465 7065 6e64 656e 6369 6573 3d64    dependencies=d
+00026400: 6570 656e 6465 6e63 6965 732c 0a20 2020  ependencies,.   
+00026410: 2020 2020 2020 2020 2063 6f6d 7075 7461           computa
+00026420: 7469 6f6e 3d63 6f6d 7075 7461 7469 6f6e  tion=computation
+00026430: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00026440: 2020 2020 2320 4649 584d 453a 2054 6865      # FIXME: The
+00026450: 7365 2022 7265 736f 6c76 6564 5f61 6e6e  se "resolved_ann
+00026460: 6f74 6174 696f 6e73 2220 6172 6520 6120  otations" are a 
+00026470: 6269 6720 6475 706c 6963 6174 696f 6e20  big duplication 
+00026480: 616e 6420 6172 6520 6f6e 6c79 0a20 2020  and are only.   
+00026490: 2020 2020 2023 2072 6571 7569 7265 6420       # required 
+000264a0: 746f 2073 6174 6973 6679 2074 6865 2063  to satisfy the c
+000264b0: 7572 7265 6e74 2070 6c75 6769 6e20 4150  urrent plugin AP
+000264c0: 492e 2054 6869 7320 7368 6f75 6c64 2062  I. This should b
+000264d0: 650a 2020 2020 2020 2020 2320 7265 636f  e.        # reco
+000264e0: 6e73 6964 6572 6564 2e0a 2020 2020 2020  nsidered..      
+000264f0: 2020 7265 736f 6c76 6564 5f61 6e6e 6f74    resolved_annot
+00026500: 6174 696f 6e73 203d 2073 656c 662e 5f70  ations = self._p
+00026510: 6172 7365 5f61 6e64 5f61 7070 6c79 5f61  arse_and_apply_a
+00026520: 6e6e 6f74 6174 696f 6e73 280a 2020 2020  nnotations(.    
+00026530: 2020 2020 2020 2020 7461 736b 733d 6e65          tasks=ne
+00026540: 775f 7461 736b 732c 0a20 2020 2020 2020  w_tasks,.       
+00026550: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
+00026560: 3d61 6e6e 6f74 6174 696f 6e73 2c0a 2020  =annotations,.  
+00026570: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+00026580: 616e 6e6f 7461 7469 6f6e 733d 6c61 7965  annotations=laye
+00026590: 725f 616e 6e6f 7461 7469 6f6e 732c 0a20  r_annotations,. 
+000265a0: 2020 2020 2020 2020 2020 2070 7265 5f73             pre_s
+000265b0: 7472 696e 6769 6669 6564 5f6b 6579 733d  tringified_keys=
+000265c0: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
+000265d0: 6b65 7973 2c0a 2020 2020 2020 2020 290a  keys,.        ).
+000265e0: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
+000265f0: 6574 5f70 7269 6f72 6974 6965 7328 0a20  et_priorities(. 
+00026600: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
+00026610: 6e61 6c5f 7072 696f 7269 7479 3d69 6e74  nal_priority=int
+00026620: 6572 6e61 6c5f 7072 696f 7269 7479 2c0a  ernal_priority,.
+00026630: 2020 2020 2020 2020 2020 2020 7375 626d              subm
+00026640: 6974 7469 6e67 5f74 6173 6b3d 7375 626d  itting_task=subm
+00026650: 6974 7469 6e67 5f74 6173 6b2c 0a20 2020  itting_task,.   
+00026660: 2020 2020 2020 2020 2075 7365 725f 7072           user_pr
+00026670: 696f 7269 7479 3d75 7365 725f 7072 696f  iority=user_prio
+00026680: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
+00026690: 2020 6669 666f 5f74 696d 656f 7574 3d66    fifo_timeout=f
+000266a0: 6966 6f5f 7469 6d65 6f75 742c 0a20 2020  ifo_timeout,.   
+000266b0: 2020 2020 2020 2020 2073 7461 7274 3d73           start=s
+000266c0: 7461 7274 2c0a 2020 2020 2020 2020 2020  tart,.          
+000266d0: 2020 6473 6b3d 6473 6b2c 0a20 2020 2020    dsk=dsk,.     
+000266e0: 2020 2020 2020 2074 6173 6b73 3d72 756e         tasks=run
+000266f0: 6e61 626c 652c 0a20 2020 2020 2020 2020  nable,.         
+00026700: 2020 2064 6570 656e 6465 6e63 6965 733d     dependencies=
+00026710: 6465 7065 6e64 656e 6369 6573 2c0a 2020  dependencies,.  
+00026720: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00026730: 2073 656c 662e 636c 6965 6e74 5f64 6573   self.client_des
+00026740: 6972 6573 5f6b 6579 7328 6b65 7973 3d72  ires_keys(keys=r
+00026750: 6571 7565 7374 6564 5f6b 6579 732c 2063  equested_keys, c
+00026760: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+00026770: 2020 2020 2020 2023 2041 6464 2061 6374         # Add act
+00026780: 6f72 730a 2020 2020 2020 2020 6966 2061  ors.        if a
+00026790: 6374 6f72 7320 6973 2054 7275 653a 0a20  ctors is True:. 
+000267a0: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+000267b0: 7320 3d20 6c69 7374 2872 6571 7565 7374  s = list(request
+000267c0: 6564 5f6b 6579 7329 0a20 2020 2020 2020  ed_keys).       
+000267d0: 2066 6f72 2061 6374 6f72 2069 6e20 6163   for actor in ac
+000267e0: 746f 7273 206f 7220 5b5d 3a0a 2020 2020  tors or []:.    
+000267f0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00026800: 662e 7461 736b 735b 6163 746f 725d 0a20  f.tasks[actor]. 
+00026810: 2020 2020 2020 2020 2020 2074 732e 6163             ts.ac
+00026820: 746f 7220 3d20 5472 7565 0a0a 2020 2020  tor = True..    
+00026830: 2020 2020 2320 436f 6d70 7574 6520 7265      # Compute re
+00026840: 636f 6d6d 656e 6461 7469 6f6e 730a 2020  commendations.  
+00026850: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+00026860: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+00026870: 0a20 2020 2020 2020 2070 7269 6f72 6974  .        priorit
+00026880: 7920 3d20 6469 6374 2829 0a20 2020 2020  y = dict().     
+00026890: 2020 2066 6f72 2074 7320 696e 2073 6f72     for ts in sor
+000268a0: 7465 6428 0a20 2020 2020 2020 2020 2020  ted(.           
+000268b0: 2072 756e 6e61 626c 652c 0a20 2020 2020   runnable,.     
+000268c0: 2020 2020 2020 206b 6579 3d6f 7065 7261         key=opera
+000268d0: 746f 722e 6174 7472 6765 7474 6572 2822  tor.attrgetter("
+000268e0: 7072 696f 7269 7479 2229 2c0a 2020 2020  priority"),.    
+000268f0: 2020 2020 2020 2020 7265 7665 7273 653d          reverse=
+00026900: 5472 7565 2c0a 2020 2020 2020 2020 293a  True,.        ):
+00026910: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00026920: 6572 7420 7473 2e70 7269 6f72 6974 7920  ert ts.priority 
+00026930: 2023 206d 7970 790a 2020 2020 2020 2020   # mypy.        
+00026940: 2020 2020 7072 696f 7269 7479 5b74 732e      priority[ts.
+00026950: 6b65 795d 203d 2074 732e 7072 696f 7269  key] = ts.priori
+00026960: 7479 0a20 2020 2020 2020 2020 2020 2061  ty.            a
+00026970: 7373 6572 7420 7473 2e72 756e 5f73 7065  ssert ts.run_spe
+00026980: 630a 2020 2020 2020 2020 2020 2020 6966  c.            if
+00026990: 2074 732e 7374 6174 6520 3d3d 2022 7265   ts.state == "re
+000269a0: 6c65 6173 6564 223a 0a20 2020 2020 2020  leased":.       
+000269b0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+000269c0: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
+000269d0: 203d 2022 7761 6974 696e 6722 0a0a 2020   = "waiting"..  
+000269e0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+000269f0: 7275 6e6e 6162 6c65 3a0a 2020 2020 2020  runnable:.      
+00026a00: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00026a10: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00026a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026a30: 2020 6966 2064 7473 2e65 7863 6570 7469    if dts.excepti
+00026a40: 6f6e 5f62 6c61 6d65 3a0a 2020 2020 2020  on_blame:.      
+00026a50: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00026a60: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00026a70: 203d 2064 7473 2e65 7863 6570 7469 6f6e   = dts.exception
+00026a80: 5f62 6c61 6d65 0a20 2020 2020 2020 2020  _blame.         
+00026a90: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+00026aa0: 6d65 6e64 6174 696f 6e73 5b74 732e 6b65  mendations[ts.ke
+00026ab0: 795d 203d 2022 6572 7265 6422 0a20 2020  y] = "erred".   
+00026ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ad0: 2062 7265 616b 0a0a 2020 2020 2020 2020   break..        
+00026ae0: 7370 616e 735f 6578 743a 2053 7061 6e73  spans_ext: Spans
+00026af0: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
+00026b00: 6f6e 207c 204e 6f6e 6520 3d20 7365 6c66  on | None = self
+00026b10: 2e65 7874 656e 7369 6f6e 732e 6765 7428  .extensions.get(
+00026b20: 2273 7061 6e73 2229 0a20 2020 2020 2020  "spans").       
+00026b30: 2069 6620 7370 616e 735f 6578 743a 0a20   if spans_ext:. 
+00026b40: 2020 2020 2020 2020 2020 2023 206e 6577             # new
+00026b50: 5f74 6173 6b73 2064 6f65 7320 6e6f 7420  _tasks does not 
+00026b60: 6e65 6365 7373 6172 696c 7920 636f 6e74  necessarily cont
+00026b70: 6169 6e20 616c 6c20 7275 6e6e 6162 6c65  ain all runnable
+00026b80: 2074 6173 6b73 3b0a 2020 2020 2020 2020   tasks;.        
+00026b90: 2020 2020 2320 5f67 656e 6572 6174 655f      # _generate_
+00026ba0: 7461 736b 7374 6174 6573 2069 7320 6e6f  taskstates is no
+00026bb0: 7420 7468 6520 6f6e 6c79 2074 6869 6e67  t the only thing
+00026bc0: 2074 6861 7420 6361 6c6c 7320 6e65 775f   that calls new_
+00026bd0: 7461 736b 2829 2e20 410a 2020 2020 2020  task(). A.      
+00026be0: 2020 2020 2020 2320 5461 736b 5374 6174        # TaskStat
+00026bf0: 6520 6d61 7920 6861 7665 2061 6c73 6f20  e may have also 
+00026c00: 6265 656e 2063 7265 6174 6564 2062 7920  been created by 
+00026c10: 636c 6965 6e74 5f64 6573 6972 6573 5f6b  client_desires_k
+00026c20: 6579 7320 6f72 2073 6361 7474 6572 2c0a  eys or scatter,.
+00026c30: 2020 2020 2020 2020 2020 2020 2320 616e              # an
+00026c40: 6420 6f6e 6c79 206c 6174 6572 2067 6169  d only later gai
+00026c50: 6e65 6420 6120 7275 6e5f 7370 6563 2e0a  ned a run_spec..
+00026c60: 2020 2020 2020 2020 2020 2020 7370 616e              span
+00026c70: 5f61 6e6e 6f74 6174 696f 6e73 203d 2073  _annotations = s
+00026c80: 7061 6e73 5f65 7874 2e6f 6273 6572 7665  pans_ext.observe
+00026c90: 5f74 6173 6b73 2872 756e 6e61 626c 652c  _tasks(runnable,
+00026ca0: 2063 6f64 653d 636f 6465 290a 2020 2020   code=code).    
+00026cb0: 2020 2020 2020 2020 2320 496e 2063 6173          # In cas
+00026cc0: 6520 6f66 2054 6173 6b47 726f 7570 2063  e of TaskGroup c
+00026cd0: 6f6c 6c69 7369 6f6e 2c20 7370 616e 7320  ollision, spans 
+00026ce0: 6d61 7920 6861 7665 2063 6861 6e67 6564  may have changed
+00026cf0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00026d00: 7370 616e 5f61 6e6e 6f74 6174 696f 6e73  span_annotations
+00026d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00026d20: 2020 7265 736f 6c76 6564 5f61 6e6e 6f74    resolved_annot
+00026d30: 6174 696f 6e73 5b22 7370 616e 225d 203d  ations["span"] =
+00026d40: 2073 7061 6e5f 616e 6e6f 7461 7469 6f6e   span_annotation
+00026d50: 730a 2020 2020 2020 2020 2020 2020 656c  s.            el
+00026d60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00026d70: 2020 2020 7265 736f 6c76 6564 5f61 6e6e      resolved_ann
+00026d80: 6f74 6174 696f 6e73 2e70 6f70 2822 7370  otations.pop("sp
+00026d90: 616e 222c 204e 6f6e 6529 0a0a 2020 2020  an", None)..    
+00026da0: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
+00026db0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+00026dc0: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
+00026dd0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00026de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026df0: 706c 7567 696e 2e75 7064 6174 655f 6772  plugin.update_gr
+00026e00: 6170 6828 0a20 2020 2020 2020 2020 2020  aph(.           
+00026e10: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00026e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e30: 2020 2063 6c69 656e 743d 636c 6965 6e74     client=client
+00026e40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00026e50: 2020 2020 2020 7461 736b 733d 5b74 732e        tasks=[ts.
+00026e60: 6b65 7920 666f 7220 7473 2069 6e20 746f  key for ts in to
+00026e70: 7563 6865 645f 7461 736b 735d 2c0a 2020  uched_tasks],.  
+00026e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e90: 2020 6b65 7973 3d72 6571 7565 7374 6564    keys=requested
+00026ea0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+00026eb0: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00026ec0: 6465 6e63 6965 733d 6465 7065 6e64 656e  dencies=dependen
+00026ed0: 6369 6573 2c0a 2020 2020 2020 2020 2020  cies,.          
+00026ee0: 2020 2020 2020 2020 2020 616e 6e6f 7461            annota
+00026ef0: 7469 6f6e 733d 7265 736f 6c76 6564 5f61  tions=resolved_a
+00026f00: 6e6e 6f74 6174 696f 6e73 2c0a 2020 2020  nnotations,.    
+00026f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026f20: 7072 696f 7269 7479 3d70 7269 6f72 6974  priority=priorit
+00026f30: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00026f40: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00026f50: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+00026f60: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
+00026f70: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+00026f80: 7863 6570 7469 6f6e 2865 290a 0a20 2020  xception(e)..   
+00026f90: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+00026fa0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
+00026fb0: 7469 6f6e 732c 2073 7469 6d75 6c75 735f  tions, stimulus_
+00026fc0: 6964 290a 0a20 2020 2020 2020 2066 6f72  id)..        for
+00026fd0: 2074 7320 696e 2074 6f75 6368 6564 5f74   ts in touched_t
+00026fe0: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+00026ff0: 2020 6966 2074 732e 7374 6174 6520 696e    if ts.state in
+00027000: 2028 226d 656d 6f72 7922 2c20 2265 7272   ("memory", "err
+00027010: 6564 2229 3a0a 2020 2020 2020 2020 2020  ed"):.          
+00027020: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
+00027030: 745f 6f6e 5f6b 6579 2874 733d 7473 2c20  t_on_key(ts=ts, 
+00027040: 636c 6965 6e74 3d63 6c69 656e 7429 0a0a  client=client)..
+00027050: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+00027060: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
+00027070: 662e 6469 6765 7374 5f6d 6574 7269 6328  f.digest_metric(
+00027080: 2275 7064 6174 652d 6772 6170 682d 6475  "update-graph-du
+00027090: 7261 7469 6f6e 222c 2065 6e64 202d 2073  ration", end - s
+000270a0: 7461 7274 290a 0a20 2020 2064 6566 205f  tart)..    def _
+000270b0: 6765 6e65 7261 7465 5f74 6173 6b73 7461  generate_tasksta
+000270c0: 7465 7328 0a20 2020 2020 2020 2073 656c  tes(.        sel
+000270d0: 662c 206b 6579 733a 2073 6574 5b73 7472  f, keys: set[str
+000270e0: 5d2c 2064 736b 3a20 6469 6374 2c20 6465  ], dsk: dict, de
+000270f0: 7065 6e64 656e 6369 6573 3a20 6469 6374  pendencies: dict
+00027100: 2c20 636f 6d70 7574 6174 696f 6e3a 2043  , computation: C
+00027110: 6f6d 7075 7461 7469 6f6e 0a20 2020 2029  omputation.    )
+00027120: 202d 3e20 7475 706c 653a 0a20 2020 2020   -> tuple:.     
+00027130: 2020 2023 2047 6574 206f 7220 6372 6561     # Get or crea
+00027140: 7465 2074 6173 6b20 7374 6174 6573 0a20  te task states. 
+00027150: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
+00027160: 3d20 5b5d 0a20 2020 2020 2020 206e 6577  = [].        new
+00027170: 5f74 6173 6b73 203d 205b 5d0a 2020 2020  _tasks = [].    
+00027180: 2020 2020 7374 6163 6b20 3d20 6c69 7374      stack = list
+00027190: 286b 6579 7329 0a20 2020 2020 2020 2074  (keys).        t
+000271a0: 6f75 6368 6564 5f6b 6579 7320 3d20 7365  ouched_keys = se
+000271b0: 7428 290a 2020 2020 2020 2020 746f 7563  t().        touc
+000271c0: 6865 645f 7461 736b 7320 3d20 5b5d 0a20  hed_tasks = []. 
+000271d0: 2020 2020 2020 2077 6869 6c65 2073 7461         while sta
+000271e0: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+000271f0: 6b20 3d20 7374 6163 6b2e 706f 7028 290a  k = stack.pop().
+00027200: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+00027210: 2069 6e20 746f 7563 6865 645f 6b65 7973   in touched_keys
+00027220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027230: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00027240: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00027250: 2e74 6173 6b73 2e67 6574 286b 290a 2020  .tasks.get(k).  
+00027260: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+00027270: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00027280: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+00027290: 6c66 2e6e 6577 5f74 6173 6b28 6b2c 2064  lf.new_task(k, d
+000272a0: 736b 2e67 6574 286b 292c 2022 7265 6c65  sk.get(k), "rele
+000272b0: 6173 6564 222c 2063 6f6d 7075 7461 7469  ased", computati
+000272c0: 6f6e 3d63 6f6d 7075 7461 7469 6f6e 290a  on=computation).
+000272d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000272e0: 6e65 775f 7461 736b 732e 6170 7065 6e64  new_tasks.append
+000272f0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+00027300: 2065 6c69 6620 6e6f 7420 7473 2e72 756e   elif not ts.run
+00027310: 5f73 7065 633a 0a20 2020 2020 2020 2020  _spec:.         
+00027320: 2020 2020 2020 2074 732e 7275 6e5f 7370         ts.run_sp
+00027330: 6563 203d 2064 736b 2e67 6574 286b 290a  ec = dsk.get(k).
+00027340: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00027350: 7473 2e72 756e 5f73 7065 633a 0a20 2020  ts.run_spec:.   
+00027360: 2020 2020 2020 2020 2020 2020 2072 756e               run
+00027370: 6e61 626c 652e 6170 7065 6e64 2874 7329  nable.append(ts)
+00027380: 0a20 2020 2020 2020 2020 2020 2074 6f75  .            tou
+00027390: 6368 6564 5f6b 6579 732e 6164 6428 6b29  ched_keys.add(k)
+000273a0: 0a20 2020 2020 2020 2020 2020 2074 6f75  .            tou
+000273b0: 6368 6564 5f74 6173 6b73 2e61 7070 656e  ched_tasks.appen
+000273c0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+000273d0: 2020 7374 6163 6b2e 6578 7465 6e64 2864    stack.extend(d
+000273e0: 6570 656e 6465 6e63 6965 732e 6765 7428  ependencies.get(
+000273f0: 6b2c 2028 2929 290a 0a20 2020 2020 2020  k, ()))..       
+00027400: 2023 2041 6464 2064 6570 656e 6465 6e63   # Add dependenc
+00027410: 6965 730a 2020 2020 2020 2020 666f 7220  ies.        for 
+00027420: 6b65 792c 2064 6570 7320 696e 2064 6570  key, deps in dep
+00027430: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
+00027440: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00027450: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+00027460: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+00027470: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+00027480: 6520 6f72 2074 732e 6465 7065 6e64 656e  e or ts.dependen
+00027490: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+000274a0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+000274b0: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
+000274c0: 6570 2069 6e20 6465 7073 3a0a 2020 2020  ep in deps:.    
+000274d0: 2020 2020 2020 2020 2020 2020 6474 7320              dts 
+000274e0: 3d20 7365 6c66 2e74 6173 6b73 5b64 6570  = self.tasks[dep
+000274f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00027500: 2020 7473 2e61 6464 5f64 6570 656e 6465    ts.add_depende
+00027510: 6e63 7928 6474 7329 0a0a 2020 2020 2020  ncy(dts)..      
+00027520: 2020 6966 206c 656e 2874 6f75 6368 6564    if len(touched
+00027530: 5f74 6173 6b73 2920 3c20 6c65 6e28 6b65  _tasks) < len(ke
+00027540: 7973 293a 0a20 2020 2020 2020 2020 2020  ys):.           
+00027550: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
+00027560: 2020 2020 2020 2020 2020 2020 2020 2253                "S
+00027570: 7562 6d69 7474 6564 2067 7261 7068 2077  ubmitted graph w
+00027580: 6974 6820 6c65 6e67 7468 2025 7320 6275  ith length %s bu
+00027590: 7420 7265 7175 6573 7465 6420 6772 6170  t requested grap
+000275a0: 6820 6f6e 6c79 2069 6e63 6c75 6465 7320  h only includes 
+000275b0: 2573 206b 6579 7322 2c0a 2020 2020 2020  %s keys",.      
+000275c0: 2020 2020 2020 2020 2020 6c65 6e28 746f            len(to
+000275d0: 7563 6865 645f 7461 736b 7329 2c0a 2020  uched_tasks),.  
+000275e0: 2020 2020 2020 2020 2020 2020 2020 6c65                le
+000275f0: 6e28 6b65 7973 292c 0a20 2020 2020 2020  n(keys),.       
+00027600: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00027610: 6574 7572 6e20 7275 6e6e 6162 6c65 2c20  eturn runnable, 
+00027620: 746f 7563 6865 645f 7461 736b 732c 206e  touched_tasks, n
+00027630: 6577 5f74 6173 6b73 0a0a 2020 2020 6465  ew_tasks..    de
+00027640: 6620 5f70 6172 7365 5f61 6e64 5f61 7070  f _parse_and_app
+00027650: 6c79 5f61 6e6e 6f74 6174 696f 6e73 280a  ly_annotations(.
+00027660: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00027670: 2020 2020 2020 7461 736b 733a 2049 7465        tasks: Ite
+00027680: 7261 626c 655b 5461 736b 5374 6174 655d  rable[TaskState]
+00027690: 2c0a 2020 2020 2020 2020 616e 6e6f 7461  ,.        annota
+000276a0: 7469 6f6e 733a 2064 6963 742c 0a20 2020  tions: dict,.   
+000276b0: 2020 2020 206c 6179 6572 5f61 6e6e 6f74       layer_annot
+000276c0: 6174 696f 6e73 3a20 6469 6374 5b73 7472  ations: dict[str
+000276d0: 2c20 6469 6374 5d2c 0a20 2020 2020 2020  , dict],.       
+000276e0: 2070 7265 5f73 7472 696e 6769 6669 6564   pre_stringified
+000276f0: 5f6b 6579 733a 2064 6963 745b 4861 7368  _keys: dict[Hash
+00027700: 6162 6c65 2c20 7374 725d 2c0a 2020 2020  able, str],.    
+00027710: 2920 2d3e 2064 6963 745b 7374 722c 2064  ) -> dict[str, d
+00027720: 6963 745b 7374 722c 2041 6e79 5d5d 3a0a  ict[str, Any]]:.
+00027730: 2020 2020 2020 2020 2222 2241 7070 6c79          """Apply
+00027740: 2074 6865 2070 726f 7669 6465 6420 616e   the provided an
+00027750: 6e6f 7461 7469 6f6e 7320 746f 2074 6865  notations to the
+00027760: 2070 726f 7669 6465 6420 6054 6173 6b53   provided `TaskS
+00027770: 7461 7465 6020 6f62 6a65 6374 732e 0a0a  tate` objects...
+00027780: 2020 2020 2020 2020 5468 6520 7261 7720          The raw 
+00027790: 616e 6e6f 7461 7469 6f6e 7320 7769 6c6c  annotations will
+000277a0: 2062 6520 7374 6f72 6564 2069 6e20 7468   be stored in th
+000277b0: 6520 6061 6e6e 6f74 6174 696f 6e73 6020  e `annotations` 
+000277c0: 6174 7472 6962 7574 652e 0a0a 2020 2020  attribute...    
+000277d0: 2020 2020 4c61 7965 7220 2f20 6b65 7920      Layer / key 
+000277e0: 7370 6563 6966 6963 2061 6e6e 6f74 6174  specific annotat
+000277f0: 696f 6e73 2077 696c 6c20 7461 6b65 2070  ions will take p
+00027800: 7265 6365 6465 6e63 6520 6f76 6572 2067  recedence over g
+00027810: 6c6f 6261 6c20 2f20 6765 6e65 7269 6320  lobal / generic 
+00027820: 616e 6e6f 7461 7469 6f6e 732e 0a0a 2020  annotations...  
+00027830: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+00027840: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00027850: 2d2d 2d0a 2020 2020 2020 2020 7461 736b  ---.        task
+00027860: 7320 3a20 4974 6572 6162 6c65 5b54 6173  s : Iterable[Tas
+00027870: 6b53 7461 7465 5d0a 2020 2020 2020 2020  kState].        
+00027880: 2020 2020 5f64 6573 6372 6970 7469 6f6e      _description
+00027890: 5f0a 2020 2020 2020 2020 616e 6e6f 7461  _.        annota
+000278a0: 7469 6f6e 7320 3a20 6469 6374 0a20 2020  tions : dict.   
+000278b0: 2020 2020 2020 2020 205f 6465 7363 7269           _descri
+000278c0: 7074 696f 6e5f 0a20 2020 2020 2020 206c  ption_.        l
+000278d0: 6179 6572 5f61 6e6e 6f74 6174 696f 6e73  ayer_annotations
+000278e0: 203a 2064 6963 745b 7374 722c 2064 6963   : dict[str, dic
+000278f0: 745d 0a20 2020 2020 2020 2020 2020 205f  t].            _
+00027900: 6465 7363 7269 7074 696f 6e5f 0a0a 2020  description_..  
+00027910: 2020 2020 2020 5265 7475 726e 730a 2020        Returns.  
+00027920: 2020 2020 2020 2d2d 2d2d 2d2d 2d0a 2020        -------.  
+00027930: 2020 2020 2020 7265 736f 6c76 6564 5f61        resolved_a
+00027940: 6e6e 6f74 6174 696f 6e73 3a20 6469 6374  nnotations: dict
+00027950: 0a20 2020 2020 2020 2020 2020 2041 206d  .            A m
+00027960: 6170 7069 6e67 206f 6620 616c 6c20 7265  apping of all re
+00027970: 736f 6c76 6564 2061 6e6e 6f74 6174 696f  solved annotatio
+00027980: 6e73 2069 6e20 7468 6520 666f 726d 6174  ns in the format
+00027990: 3a3a 0a0a 2020 2020 2020 2020 2020 2020  ::..            
+000279a0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+000279b0: 2020 2020 2020 2020 2020 2261 6e6e 6f74            "annot
+000279c0: 6174 696f 6e22 3a20 7b0a 2020 2020 2020  ation": {.      
+000279d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000279e0: 2020 226b 6579 223a 2076 616c 7565 2c0a    "key": value,.
+000279f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a00: 2020 2020 2020 2020 2e2e 2e0a 2020 2020          ....    
+00027a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a20: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00027a30: 2020 2020 2020 202e 2e2e 0a20 2020 2020         ....     
+00027a40: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00027a50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00027a60: 2072 6573 6f6c 7665 645f 616e 6e6f 7461   resolved_annota
+00027a70: 7469 6f6e 733a 2064 6566 6175 6c74 6469  tions: defaultdi
+00027a80: 6374 5b73 7472 2c20 6469 6374 5b73 7472  ct[str, dict[str
+00027a90: 2c20 416e 795d 5d20 3d20 6465 6661 756c  , Any]] = defaul
+00027aa0: 7464 6963 7428 6469 6374 290a 2020 2020  tdict(dict).    
+00027ab0: 2020 2020 666f 7220 7473 2069 6e20 7461      for ts in ta
+00027ac0: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00027ad0: 206b 6579 203d 2074 732e 6b65 790a 2020   key = ts.key.  
+00027ae0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+00027af0: 2063 6f75 6c64 2062 6520 6120 7479 7065   could be a type
+00027b00: 6420 6469 6374 0a20 2020 2020 2020 2020  d dict.         
+00027b10: 2020 2069 6620 6e6f 7420 616e 6e6f 7461     if not annota
+00027b20: 7469 6f6e 7320 616e 6420 6b65 7920 6e6f  tions and key no
+00027b30: 7420 696e 206c 6179 6572 5f61 6e6e 6f74  t in layer_annot
+00027b40: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
+00027b50: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00027b60: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00027b70: 203d 2061 6e6e 6f74 6174 696f 6e73 2e63   = annotations.c
+00027b80: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+00027b90: 2020 6f75 742e 7570 6461 7465 286c 6179    out.update(lay
+00027ba0: 6572 5f61 6e6e 6f74 6174 696f 6e73 2e67  er_annotations.g
+00027bb0: 6574 286b 6579 2c20 7b7d 2929 0a20 2020  et(key, {})).   
+00027bc0: 2020 2020 2020 2020 2066 6f72 2061 6e6e           for ann
+00027bd0: 6f74 2c20 7661 6c75 6520 696e 206f 7574  ot, value in out
+00027be0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00027bf0: 2020 2020 2020 2020 2020 2320 506f 7020            # Pop 
+00027c00: 7468 6520 6b65 7920 7369 6e63 6520 6e61  the key since na
+00027c10: 6d65 7320 646f 6e27 7420 616c 7761 7973  mes don't always
+00027c20: 206d 6174 6368 2061 7474 7269 6275 7465   match attribute
+00027c30: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00027c40: 2020 6966 2063 616c 6c61 626c 6528 7661    if callable(va
+00027c50: 6c75 6529 3a0a 2020 2020 2020 2020 2020  lue):.          
+00027c60: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
+00027c70: 3d20 7661 6c75 6528 7072 655f 7374 7269  = value(pre_stri
+00027c80: 6e67 6966 6965 645f 6b65 7973 5b6b 6579  ngified_keys[key
+00027c90: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00027ca0: 2020 206f 7574 5b61 6e6e 6f74 5d20 3d20     out[annot] = 
+00027cb0: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+00027cc0: 2020 2020 2020 7265 736f 6c76 6564 5f61        resolved_a
+00027cd0: 6e6e 6f74 6174 696f 6e73 5b61 6e6e 6f74  nnotations[annot
+00027ce0: 5d5b 6b65 795d 203d 2076 616c 7565 0a0a  ][key] = value..
+00027cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d00: 6966 2061 6e6e 6f74 2069 6e20 2822 7265  if annot in ("re
+00027d10: 7374 7269 6374 696f 6e73 222c 2022 776f  strictions", "wo
+00027d20: 726b 6572 7322 293a 0a20 2020 2020 2020  rkers"):.       
+00027d30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00027d40: 6e6f 7420 6973 696e 7374 616e 6365 2876  not isinstance(v
+00027d50: 616c 7565 2c20 286c 6973 742c 2074 7570  alue, (list, tup
+00027d60: 6c65 2c20 7365 7429 293a 0a20 2020 2020  le, set)):.     
+00027d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d80: 2020 2076 616c 7565 203d 205b 7661 6c75     value = [valu
+00027d90: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
+00027da0: 2020 2020 2020 2068 6f73 745f 7265 7374         host_rest
+00027db0: 7269 6374 696f 6e73 203d 2073 6574 2829  rictions = set()
+00027dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027dd0: 2020 2020 2077 6f72 6b65 725f 7265 7374       worker_rest
+00027de0: 7269 6374 696f 6e73 203d 2073 6574 2829  rictions = set()
+00027df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027e00: 2020 2020 2066 6f72 2077 2069 6e20 7661       for w in va
+00027e10: 6c75 653a 0a20 2020 2020 2020 2020 2020  lue:.           
+00027e20: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00027e30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00027e40: 2020 2020 2020 2020 2020 2020 2020 7720                w 
+00027e50: 3d20 7365 6c66 2e63 6f65 7263 655f 6164  = self.coerce_ad
+00027e60: 6472 6573 7328 7729 0a20 2020 2020 2020  dress(w).       
+00027e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e80: 2065 7863 6570 7420 5661 6c75 6545 7272   except ValueErr
+00027e90: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
 00027ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027eb0: 2020 2020 2020 686f 7374 5f72 6573 7472        host_restr
-00027ec0: 6963 7469 6f6e 732e 6164 6428 7729 0a20  ictions.add(w). 
-00027ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027ee0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00027ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f00: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
-00027f10: 7265 7374 7269 6374 696f 6e73 2e61 6464  restrictions.add
-00027f20: 2877 290a 2020 2020 2020 2020 2020 2020  (w).            
-00027f30: 2020 2020 2020 2020 6966 2068 6f73 745f          if host_
-00027f40: 7265 7374 7269 6374 696f 6e73 3a0a 2020  restrictions:.  
-00027f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027f60: 2020 2020 2020 7473 2e68 6f73 745f 7265        ts.host_re
-00027f70: 7374 7269 6374 696f 6e73 203d 2068 6f73  strictions = hos
-00027f80: 745f 7265 7374 7269 6374 696f 6e73 0a20  t_restrictions. 
-00027f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fa0: 2020 2069 6620 776f 726b 6572 5f72 6573     if worker_res
-00027fb0: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
-00027fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027fd0: 2020 2074 732e 776f 726b 6572 5f72 6573     ts.worker_res
-00027fe0: 7472 6963 7469 6f6e 7320 3d20 776f 726b  trictions = work
-00027ff0: 6572 5f72 6573 7472 6963 7469 6f6e 730a  er_restrictions.
-00028000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028010: 656c 6966 2061 6e6e 6f74 2069 6e20 2822  elif annot in ("
-00028020: 6c6f 6f73 655f 7265 7374 7269 6374 696f  loose_restrictio
-00028030: 6e73 222c 2022 616c 6c6f 775f 6f74 6865  ns", "allow_othe
-00028040: 725f 776f 726b 6572 7322 293a 0a20 2020  r_workers"):.   
-00028050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028060: 2074 732e 6c6f 6f73 655f 7265 7374 7269   ts.loose_restri
-00028070: 6374 696f 6e73 203d 2076 616c 7565 0a20  ctions = value. 
-00028080: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00028090: 6c69 6620 616e 6e6f 7420 3d3d 2022 7265  lif annot == "re
-000280a0: 736f 7572 6365 7322 3a0a 2020 2020 2020  sources":.      
-000280b0: 2020 2020 2020 2020 2020 2020 2020 6173                as
-000280c0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-000280d0: 7661 6c75 652c 2064 6963 7429 0a20 2020  value, dict).   
-000280e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000280f0: 2074 732e 7265 736f 7572 6365 5f72 6573   ts.resource_res
-00028100: 7472 6963 7469 6f6e 7320 3d20 7661 6c75  trictions = valu
-00028110: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00028120: 2020 656c 6966 2061 6e6e 6f74 203d 3d20    elif annot == 
-00028130: 2270 7269 6f72 6974 7922 3a0a 2020 2020  "priority":.    
-00028140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028150: 2320 5365 6520 5363 6865 6475 6c65 722e  # See Scheduler.
-00028160: 5f73 6574 5f70 7269 6f72 6974 6965 730a  _set_priorities.
-00028170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028180: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00028190: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-000281a0: 6620 616e 6e6f 7420 3d3d 2022 7265 7472  f annot == "retr
-000281b0: 6965 7322 3a0a 2020 2020 2020 2020 2020  ies":.          
-000281c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000281d0: 2069 7369 6e73 7461 6e63 6528 7661 6c75   isinstance(valu
-000281e0: 652c 2069 6e74 290a 2020 2020 2020 2020  e, int).        
-000281f0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
-00028200: 6574 7269 6573 203d 2076 616c 7565 0a20  etries = value. 
-00028210: 2020 2020 2020 2020 2020 2074 732e 616e             ts.an
-00028220: 6e6f 7461 7469 6f6e 7320 3d20 6f75 740a  notations = out.
-00028230: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00028240: 6963 7428 7265 736f 6c76 6564 5f61 6e6e  ict(resolved_ann
-00028250: 6f74 6174 696f 6e73 290a 0a20 2020 2064  otations)..    d
-00028260: 6566 205f 7365 745f 7072 696f 7269 7469  ef _set_prioriti
-00028270: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
-00028280: 2c0a 2020 2020 2020 2020 696e 7465 726e  ,.        intern
-00028290: 616c 5f70 7269 6f72 6974 793a 2064 6963  al_priority: dic
-000282a0: 745b 7374 722c 2069 6e74 5d20 7c20 4e6f  t[str, int] | No
-000282b0: 6e65 2c0a 2020 2020 2020 2020 7375 626d  ne,.        subm
-000282c0: 6974 7469 6e67 5f74 6173 6b3a 2073 7472  itting_task: str
-000282d0: 207c 204e 6f6e 652c 0a20 2020 2020 2020   | None,.       
-000282e0: 2075 7365 725f 7072 696f 7269 7479 3a20   user_priority: 
-000282f0: 696e 7420 7c20 6469 6374 5b73 7472 2c20  int | dict[str, 
-00028300: 696e 745d 2c0a 2020 2020 2020 2020 6669  int],.        fi
-00028310: 666f 5f74 696d 656f 7574 3a20 696e 7420  fo_timeout: int 
-00028320: 7c20 666c 6f61 7420 7c20 7374 722c 0a20  | float | str,. 
-00028330: 2020 2020 2020 2073 7461 7274 3a20 666c         start: fl
-00028340: 6f61 742c 0a20 2020 2020 2020 2064 736b  oat,.        dsk
-00028350: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
-00028360: 7461 736b 733a 206c 6973 745b 5461 736b  tasks: list[Task
-00028370: 5374 6174 655d 2c0a 2020 2020 2020 2020  State],.        
-00028380: 6465 7065 6e64 656e 6369 6573 3a20 6469  dependencies: di
-00028390: 6374 2c0a 2020 2020 2920 2d3e 204e 6f6e  ct,.    ) -> Non
-000283a0: 653a 0a20 2020 2020 2020 2066 6966 6f5f  e:.        fifo_
-000283b0: 7469 6d65 6f75 7420 3d20 7061 7273 655f  timeout = parse_
-000283c0: 7469 6d65 6465 6c74 6128 6669 666f 5f74  timedelta(fifo_t
-000283d0: 696d 656f 7574 290a 2020 2020 2020 2020  imeout).        
-000283e0: 6966 2073 7562 6d69 7474 696e 675f 7461  if submitting_ta
-000283f0: 736b 3a20 2023 2073 7562 2d74 6173 6b73  sk:  # sub-tasks
-00028400: 2067 6574 2062 6574 7465 7220 7072 696f   get better prio
-00028410: 7269 7479 2074 6861 6e20 7061 7265 6e74  rity than parent
-00028420: 2074 6173 6b73 0a20 2020 2020 2020 2020   tasks.         
-00028430: 2020 2073 7473 203d 2073 656c 662e 7461     sts = self.ta
-00028440: 736b 732e 6765 7428 7375 626d 6974 7469  sks.get(submitti
-00028450: 6e67 5f74 6173 6b29 0a20 2020 2020 2020  ng_task).       
-00028460: 2020 2020 2069 6620 7374 7320 6973 206e       if sts is n
-00028470: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00028480: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00028490: 7374 732e 7072 696f 7269 7479 0a20 2020  sts.priority.   
-000284a0: 2020 2020 2020 2020 2020 2020 2067 656e               gen
-000284b0: 6572 6174 696f 6e20 3d20 7374 732e 7072  eration = sts.pr
-000284c0: 696f 7269 7479 5b30 5d20 2d20 302e 3031  iority[0] - 0.01
-000284d0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000284e0: 653a 2020 2320 7375 7065 722d 7461 736b  e:  # super-task
-000284f0: 2061 6c72 6561 6479 2063 6c65 616e 6564   already cleaned
-00028500: 2075 700a 2020 2020 2020 2020 2020 2020   up.            
-00028510: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
-00028520: 2073 656c 662e 6765 6e65 7261 7469 6f6e   self.generation
-00028530: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-00028540: 6c66 2e5f 6c61 7374 5f74 696d 6520 2b20  lf._last_time + 
-00028550: 6669 666f 5f74 696d 656f 7574 203c 2073  fifo_timeout < s
-00028560: 7461 7274 3a0a 2020 2020 2020 2020 2020  tart:.          
-00028570: 2020 7365 6c66 2e67 656e 6572 6174 696f    self.generatio
-00028580: 6e20 2b3d 2031 2020 2320 6f6c 6465 7220  n += 1  # older 
-00028590: 6772 6170 6820 6765 6e65 7261 7469 6f6e  graph generation
-000285a0: 7320 7461 6b65 2070 7265 6365 6465 6e63  s take precedenc
-000285b0: 650a 2020 2020 2020 2020 2020 2020 6765  e.            ge
-000285c0: 6e65 7261 7469 6f6e 203d 2073 656c 662e  neration = self.
-000285d0: 6765 6e65 7261 7469 6f6e 0a20 2020 2020  generation.     
-000285e0: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-000285f0: 745f 7469 6d65 203d 2073 7461 7274 0a20  t_time = start. 
-00028600: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00028610: 2020 2020 2020 2020 2067 656e 6572 6174           generat
-00028620: 696f 6e20 3d20 7365 6c66 2e67 656e 6572  ion = self.gener
-00028630: 6174 696f 6e0a 0a20 2020 2020 2020 2069  ation..        i
-00028640: 6620 696e 7465 726e 616c 5f70 7269 6f72  f internal_prior
-00028650: 6974 7920 6973 204e 6f6e 653a 0a20 2020  ity is None:.   
-00028660: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
-00028670: 696e 6720 616c 6c20 6e6f 6e2d 6c6f 6361  ing all non-loca
-00028680: 6c20 6b65 7973 2062 6566 6f72 6520 6361  l keys before ca
-00028690: 6c6c 696e 6720 6f72 6465 7228 290a 2020  lling order().  
-000286a0: 2020 2020 2020 2020 2020 6473 6b5f 6b65            dsk_ke
-000286b0: 7973 203d 2073 6574 2864 736b 2920 2023  ys = set(dsk)  #
-000286c0: 2069 6e74 6572 7365 6374 696f 6e28 2920   intersection() 
-000286d0: 6f66 2073 6574 7320 6973 206d 7563 6820  of sets is much 
-000286e0: 6661 7374 6572 2074 6861 6e20 6469 6374  faster than dict
-000286f0: 5f6b 6579 730a 2020 2020 2020 2020 2020  _keys.          
-00028700: 2020 7374 7269 7070 6564 5f64 6570 7320    stripped_deps 
-00028710: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00028720: 2020 2020 6b3a 2076 2e69 6e74 6572 7365      k: v.interse
-00028730: 6374 696f 6e28 6473 6b5f 6b65 7973 290a  ction(dsk_keys).
-00028740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028750: 666f 7220 6b2c 2076 2069 6e20 6465 7065  for k, v in depe
-00028760: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
-00028770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028780: 2069 6620 6b20 696e 2064 736b 5f6b 6579   if k in dsk_key
-00028790: 730a 2020 2020 2020 2020 2020 2020 7d0a  s.            }.
-000287a0: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-000287b0: 726e 616c 5f70 7269 6f72 6974 7920 3d20  rnal_priority = 
-000287c0: 6461 736b 2e6f 7264 6572 2e6f 7264 6572  dask.order.order
-000287d0: 2864 736b 2c20 6465 7065 6e64 656e 6369  (dsk, dependenci
-000287e0: 6573 3d73 7472 6970 7065 645f 6465 7073  es=stripped_deps
-000287f0: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
-00028800: 7320 696e 2074 6173 6b73 3a0a 2020 2020  s in tasks:.    
-00028810: 2020 2020 2020 2020 2320 4e6f 7465 3a20          # Note: 
-00028820: 556e 6465 7220 7768 6963 6820 6369 7263  Under which circ
-00028830: 756d 7374 616e 6365 7320 776f 756c 6420  umstances would 
-00028840: 6120 7461 736b 206e 6f74 2068 6176 6520  a task not have 
-00028850: 610a 2020 2020 2020 2020 2020 2020 2320  a.            # 
-00028860: 7072 696f 7269 7469 7920 6173 7369 676e  prioritiy assign
-00028870: 6564 2062 7920 6e6f 773f 2041 7265 2074  ed by now? Are t
-00028880: 6865 7365 2073 6361 7474 6572 6564 2074  hese scattered t
-00028890: 6173 6b73 0a20 2020 2020 2020 2020 2020  asks.           
-000288a0: 2023 2065 7863 6c75 7369 7665 6c79 206f   # exclusively o
-000288b0: 7220 736f 6d65 7468 696e 6720 656c 7365  r something else
-000288c0: 3f0a 2020 2020 2020 2020 2020 2020 7461  ?.            ta
-000288d0: 736b 5f75 7365 725f 7072 696f 203d 2075  sk_user_prio = u
-000288e0: 7365 725f 7072 696f 7269 7479 0a20 2020  ser_priority.   
-000288f0: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
-00028900: 7374 616e 6365 2875 7365 725f 7072 696f  stance(user_prio
-00028910: 7269 7479 2c20 6469 6374 293a 0a20 2020  rity, dict):.   
-00028920: 2020 2020 2020 2020 2020 2020 2074 6173               tas
-00028930: 6b5f 7573 6572 5f70 7269 6f20 3d20 7573  k_user_prio = us
-00028940: 6572 5f70 7269 6f72 6974 792e 6765 7428  er_priority.get(
-00028950: 7473 2e6b 6579 2c20 3029 0a20 2020 2020  ts.key, 0).     
-00028960: 2020 2020 2020 2061 6e6e 6f74 6174 6564         annotated
-00028970: 5f70 7269 6f20 3d20 7473 2e61 6e6e 6f74  _prio = ts.annot
-00028980: 6174 696f 6e73 2e67 6574 2822 7072 696f  ations.get("prio
-00028990: 7269 7479 222c 207b 7d29 0a20 2020 2020  rity", {}).     
-000289a0: 2020 2020 2020 2069 6620 6e6f 7420 616e         if not an
-000289b0: 6e6f 7461 7465 645f 7072 696f 3a0a 2020  notated_prio:.  
-000289c0: 2020 2020 2020 2020 2020 2020 2020 616e                an
-000289d0: 6e6f 7461 7465 645f 7072 696f 203d 2074  notated_prio = t
-000289e0: 6173 6b5f 7573 6572 5f70 7269 6f0a 0a20  ask_user_prio.. 
-000289f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00028a00: 7420 7473 2e70 7269 6f72 6974 7920 616e  t ts.priority an
-00028a10: 6420 7473 2e6b 6579 2069 6e20 696e 7465  d ts.key in inte
-00028a20: 726e 616c 5f70 7269 6f72 6974 793a 0a20  rnal_priority:. 
-00028a30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00028a40: 732e 7072 696f 7269 7479 203d 2028 0a20  s.priority = (. 
-00028a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028a60: 2020 202d 616e 6e6f 7461 7465 645f 7072     -annotated_pr
-00028a70: 696f 2c0a 2020 2020 2020 2020 2020 2020  io,.            
-00028a80: 2020 2020 2020 2020 6765 6e65 7261 7469          generati
-00028a90: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
-00028aa0: 2020 2020 2020 2020 696e 7465 726e 616c          internal
-00028ab0: 5f70 7269 6f72 6974 795b 7473 2e6b 6579  _priority[ts.key
-00028ac0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00028ad0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-00028ae0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00028af0: 7465 2061 6e64 2074 732e 7275 6e5f 7370  te and ts.run_sp
-00028b00: 6563 3a0a 2020 2020 2020 2020 2020 2020  ec:.            
-00028b10: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00028b20: 7461 6e63 6528 7473 2e70 7269 6f72 6974  tance(ts.priorit
-00028b30: 792c 2074 7570 6c65 2920 616e 6420 616c  y, tuple) and al
-00028b40: 6c28 0a20 2020 2020 2020 2020 2020 2020  l(.             
-00028b50: 2020 2020 2020 2069 7369 6e73 7461 6e63         isinstanc
-00028b60: 6528 656c 2c20 2869 6e74 2c20 666c 6f61  e(el, (int, floa
-00028b70: 7429 2920 666f 7220 656c 2069 6e20 7473  t)) for el in ts
-00028b80: 2e70 7269 6f72 6974 790a 2020 2020 2020  .priority.      
-00028b90: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00028ba0: 2064 6566 205f 706f 705f 6c6f 7374 5f74   def _pop_lost_t
-00028bb0: 6173 6b73 280a 2020 2020 2020 2020 7365  asks(.        se
-00028bc0: 6c66 2c20 6473 6b3a 2064 6963 742c 2064  lf, dsk: dict, d
-00028bd0: 6570 656e 6465 6e63 6965 733a 2064 6963  ependencies: dic
-00028be0: 742c 206b 6579 733a 2073 6574 5b73 7472  t, keys: set[str
-00028bf0: 5d0a 2020 2020 2920 2d3e 2073 6574 5b73  ].    ) -> set[s
-00028c00: 7472 5d3a 0a20 2020 2020 2020 206e 203d  tr]:.        n =
-00028c10: 2030 0a20 2020 2020 2020 206f 7574 203d   0.        out =
-00028c20: 2073 6574 2829 0a20 2020 2020 2020 2077   set().        w
-00028c30: 6869 6c65 206c 656e 2864 736b 2920 213d  hile len(dsk) !=
-00028c40: 206e 3a20 2023 2077 616c 6b20 7468 726f   n:  # walk thro
-00028c50: 7567 6820 6e65 7720 7461 736b 732c 2063  ugh new tasks, c
-00028c60: 616e 6365 6c20 616e 7920 6261 6420 6465  ancel any bad de
-00028c70: 7073 0a20 2020 2020 2020 2020 2020 206e  ps.            n
-00028c80: 203d 206c 656e 2864 736b 290a 2020 2020   = len(dsk).    
-00028c90: 2020 2020 2020 2020 666f 7220 6b2c 2064          for k, d
-00028ca0: 6570 7320 696e 206c 6973 7428 6465 7065  eps in list(depe
-00028cb0: 6e64 656e 6369 6573 2e69 7465 6d73 2829  ndencies.items()
-00028cc0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00028cd0: 2020 2069 6620 616e 7928 0a20 2020 2020     if any(.     
-00028ce0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00028cf0: 6570 206e 6f74 2069 6e20 7365 6c66 2e74  ep not in self.t
-00028d00: 6173 6b73 2061 6e64 2064 6570 206e 6f74  asks and dep not
-00028d10: 2069 6e20 6473 6b20 666f 7220 6465 7020   in dsk for dep 
-00028d20: 696e 2064 6570 730a 2020 2020 2020 2020  in deps.        
-00028d30: 2020 2020 2020 2020 293a 2020 2320 6261          ):  # ba
-00028d40: 6420 6b65 790a 2020 2020 2020 2020 2020  d key.          
-00028d50: 2020 2020 2020 2020 2020 6f75 742e 6164            out.ad
-00028d60: 6428 6b29 0a20 2020 2020 2020 2020 2020  d(k).           
-00028d70: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00028d80: 696e 666f 2822 5573 6572 2061 736b 6564  info("User asked
-00028d90: 2066 6f72 2063 6f6d 7075 7461 7469 6f6e   for computation
-00028da0: 206f 6e20 6c6f 7374 2064 6174 612c 2025   on lost data, %
-00028db0: 7322 2c20 6b29 0a20 2020 2020 2020 2020  s", k).         
-00028dc0: 2020 2020 2020 2020 2020 2064 656c 2064             del d
-00028dd0: 736b 5b6b 5d0a 2020 2020 2020 2020 2020  sk[k].          
-00028de0: 2020 2020 2020 2020 2020 6465 6c20 6465            del de
-00028df0: 7065 6e64 656e 6369 6573 5b6b 5d0a 2020  pendencies[k].  
+00027eb0: 2320 4e6f 7420 6120 7661 6c69 6420 6164  # Not a valid ad
+00027ec0: 6472 6573 732c 2062 7574 2070 6572 6861  dress, but perha
+00027ed0: 7073 2069 7427 7320 6120 686f 7374 6e61  ps it's a hostna
+00027ee0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
+00027ef0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00027f00: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+00027f10: 2e61 6464 2877 290a 2020 2020 2020 2020  .add(w).        
+00027f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00027f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f50: 2020 776f 726b 6572 5f72 6573 7472 6963    worker_restric
+00027f60: 7469 6f6e 732e 6164 6428 7729 0a20 2020  tions.add(w).   
+00027f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f80: 2069 6620 686f 7374 5f72 6573 7472 6963   if host_restric
+00027f90: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00027fa0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00027fb0: 732e 686f 7374 5f72 6573 7472 6963 7469  s.host_restricti
+00027fc0: 6f6e 7320 3d20 686f 7374 5f72 6573 7472  ons = host_restr
+00027fd0: 6963 7469 6f6e 730a 2020 2020 2020 2020  ictions.        
+00027fe0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+00027ff0: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+00028000: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00028010: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+00028020: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+00028030: 6e73 203d 2077 6f72 6b65 725f 7265 7374  ns = worker_rest
+00028040: 7269 6374 696f 6e73 0a20 2020 2020 2020  rictions.       
+00028050: 2020 2020 2020 2020 2065 6c69 6620 616e           elif an
+00028060: 6e6f 7420 696e 2028 226c 6f6f 7365 5f72  not in ("loose_r
+00028070: 6573 7472 6963 7469 6f6e 7322 2c20 2261  estrictions", "a
+00028080: 6c6c 6f77 5f6f 7468 6572 5f77 6f72 6b65  llow_other_worke
+00028090: 7273 2229 3a0a 2020 2020 2020 2020 2020  rs"):.          
+000280a0: 2020 2020 2020 2020 2020 7473 2e6c 6f6f            ts.loo
+000280b0: 7365 5f72 6573 7472 6963 7469 6f6e 7320  se_restrictions 
+000280c0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+000280d0: 2020 2020 2020 2020 656c 6966 2061 6e6e          elif ann
+000280e0: 6f74 203d 3d20 2272 6573 6f75 7263 6573  ot == "resources
+000280f0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00028100: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00028110: 696e 7374 616e 6365 2876 616c 7565 2c20  instance(value, 
+00028120: 6469 6374 290a 2020 2020 2020 2020 2020  dict).          
+00028130: 2020 2020 2020 2020 2020 7473 2e72 6573            ts.res
+00028140: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+00028150: 6e73 203d 2076 616c 7565 0a20 2020 2020  ns = value.     
+00028160: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00028170: 616e 6e6f 7420 3d3d 2022 7072 696f 7269  annot == "priori
+00028180: 7479 223a 0a20 2020 2020 2020 2020 2020  ty":.           
+00028190: 2020 2020 2020 2020 2023 2053 6565 2053           # See S
+000281a0: 6368 6564 756c 6572 2e5f 7365 745f 7072  cheduler._set_pr
+000281b0: 696f 7269 7469 6573 0a20 2020 2020 2020  iorities.       
+000281c0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+000281d0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+000281e0: 2020 2020 2020 656c 6966 2061 6e6e 6f74        elif annot
+000281f0: 203d 3d20 2272 6574 7269 6573 223a 0a20   == "retries":. 
+00028200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028210: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00028220: 616e 6365 2876 616c 7565 2c20 696e 7429  ance(value, int)
+00028230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028240: 2020 2020 2074 732e 7265 7472 6965 7320       ts.retries 
+00028250: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
+00028260: 2020 2020 7473 2e61 6e6e 6f74 6174 696f      ts.annotatio
+00028270: 6e73 203d 206f 7574 0a20 2020 2020 2020  ns = out.       
+00028280: 2072 6574 7572 6e20 6469 6374 2872 6573   return dict(res
+00028290: 6f6c 7665 645f 616e 6e6f 7461 7469 6f6e  olved_annotation
+000282a0: 7329 0a0a 2020 2020 6465 6620 5f73 6574  s)..    def _set
+000282b0: 5f70 7269 6f72 6974 6965 7328 0a20 2020  _priorities(.   
+000282c0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000282d0: 2020 2069 6e74 6572 6e61 6c5f 7072 696f     internal_prio
+000282e0: 7269 7479 3a20 6469 6374 5b73 7472 2c20  rity: dict[str, 
+000282f0: 696e 745d 207c 204e 6f6e 652c 0a20 2020  int] | None,.   
+00028300: 2020 2020 2073 7562 6d69 7474 696e 675f       submitting_
+00028310: 7461 736b 3a20 7374 7220 7c20 4e6f 6e65  task: str | None
+00028320: 2c0a 2020 2020 2020 2020 7573 6572 5f70  ,.        user_p
+00028330: 7269 6f72 6974 793a 2069 6e74 207c 2064  riority: int | d
+00028340: 6963 745b 7374 722c 2069 6e74 5d2c 0a20  ict[str, int],. 
+00028350: 2020 2020 2020 2066 6966 6f5f 7469 6d65         fifo_time
+00028360: 6f75 743a 2069 6e74 207c 2066 6c6f 6174  out: int | float
+00028370: 207c 2073 7472 2c0a 2020 2020 2020 2020   | str,.        
+00028380: 7374 6172 743a 2066 6c6f 6174 2c0a 2020  start: float,.  
+00028390: 2020 2020 2020 6473 6b3a 2064 6963 742c        dsk: dict,
+000283a0: 0a20 2020 2020 2020 2074 6173 6b73 3a20  .        tasks: 
+000283b0: 6c69 7374 5b54 6173 6b53 7461 7465 5d2c  list[TaskState],
+000283c0: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
+000283d0: 6e63 6965 733a 2064 6963 742c 0a20 2020  ncies: dict,.   
+000283e0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+000283f0: 2020 2020 6669 666f 5f74 696d 656f 7574      fifo_timeout
+00028400: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+00028410: 7461 2866 6966 6f5f 7469 6d65 6f75 7429  ta(fifo_timeout)
+00028420: 0a20 2020 2020 2020 2069 6620 7375 626d  .        if subm
+00028430: 6974 7469 6e67 5f74 6173 6b3a 2020 2320  itting_task:  # 
+00028440: 7375 622d 7461 736b 7320 6765 7420 6265  sub-tasks get be
+00028450: 7474 6572 2070 7269 6f72 6974 7920 7468  tter priority th
+00028460: 616e 2070 6172 656e 7420 7461 736b 730a  an parent tasks.
+00028470: 2020 2020 2020 2020 2020 2020 7374 7320              sts 
+00028480: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+00028490: 2873 7562 6d69 7474 696e 675f 7461 736b  (submitting_task
+000284a0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000284b0: 2073 7473 2069 7320 6e6f 7420 4e6f 6e65   sts is not None
+000284c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000284d0: 2020 6173 7365 7274 2073 7473 2e70 7269    assert sts.pri
+000284e0: 6f72 6974 790a 2020 2020 2020 2020 2020  ority.          
+000284f0: 2020 2020 2020 6765 6e65 7261 7469 6f6e        generation
+00028500: 203d 2073 7473 2e70 7269 6f72 6974 795b   = sts.priority[
+00028510: 305d 202d 2030 2e30 310a 2020 2020 2020  0] - 0.01.      
+00028520: 2020 2020 2020 656c 7365 3a20 2023 2073        else:  # s
+00028530: 7570 6572 2d74 6173 6b20 616c 7265 6164  uper-task alread
+00028540: 7920 636c 6561 6e65 6420 7570 0a20 2020  y cleaned up.   
+00028550: 2020 2020 2020 2020 2020 2020 2067 656e               gen
+00028560: 6572 6174 696f 6e20 3d20 7365 6c66 2e67  eration = self.g
+00028570: 656e 6572 6174 696f 6e0a 2020 2020 2020  eneration.      
+00028580: 2020 656c 6966 2073 656c 662e 5f6c 6173    elif self._las
+00028590: 745f 7469 6d65 202b 2066 6966 6f5f 7469  t_time + fifo_ti
+000285a0: 6d65 6f75 7420 3c20 7374 6172 743a 0a20  meout < start:. 
+000285b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000285c0: 6765 6e65 7261 7469 6f6e 202b 3d20 3120  generation += 1 
+000285d0: 2023 206f 6c64 6572 2067 7261 7068 2067   # older graph g
+000285e0: 656e 6572 6174 696f 6e73 2074 616b 6520  enerations take 
+000285f0: 7072 6563 6564 656e 6365 0a20 2020 2020  precedence.     
+00028600: 2020 2020 2020 2067 656e 6572 6174 696f         generatio
+00028610: 6e20 3d20 7365 6c66 2e67 656e 6572 6174  n = self.generat
+00028620: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00028630: 7365 6c66 2e5f 6c61 7374 5f74 696d 6520  self._last_time 
+00028640: 3d20 7374 6172 740a 2020 2020 2020 2020  = start.        
+00028650: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00028660: 2020 6765 6e65 7261 7469 6f6e 203d 2073    generation = s
+00028670: 656c 662e 6765 6e65 7261 7469 6f6e 0a0a  elf.generation..
+00028680: 2020 2020 2020 2020 6966 2069 6e74 6572          if inter
+00028690: 6e61 6c5f 7072 696f 7269 7479 2069 7320  nal_priority is 
+000286a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000286b0: 2020 2320 5265 6d6f 7669 6e67 2061 6c6c    # Removing all
+000286c0: 206e 6f6e 2d6c 6f63 616c 206b 6579 7320   non-local keys 
+000286d0: 6265 666f 7265 2063 616c 6c69 6e67 206f  before calling o
+000286e0: 7264 6572 2829 0a20 2020 2020 2020 2020  rder().         
+000286f0: 2020 2064 736b 5f6b 6579 7320 3d20 7365     dsk_keys = se
+00028700: 7428 6473 6b29 2020 2320 696e 7465 7273  t(dsk)  # inters
+00028710: 6563 7469 6f6e 2829 206f 6620 7365 7473  ection() of sets
+00028720: 2069 7320 6d75 6368 2066 6173 7465 7220   is much faster 
+00028730: 7468 616e 2064 6963 745f 6b65 7973 0a20  than dict_keys. 
+00028740: 2020 2020 2020 2020 2020 2073 7472 6970             strip
+00028750: 7065 645f 6465 7073 203d 207b 0a20 2020  ped_deps = {.   
+00028760: 2020 2020 2020 2020 2020 2020 206b 3a20               k: 
+00028770: 762e 696e 7465 7273 6563 7469 6f6e 2864  v.intersection(d
+00028780: 736b 5f6b 6579 7329 0a20 2020 2020 2020  sk_keys).       
+00028790: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+000287a0: 7620 696e 2064 6570 656e 6465 6e63 6965  v in dependencie
+000287b0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+000287c0: 2020 2020 2020 2020 2020 6966 206b 2069            if k i
+000287d0: 6e20 6473 6b5f 6b65 7973 0a20 2020 2020  n dsk_keys.     
+000287e0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000287f0: 2020 2020 2069 6e74 6572 6e61 6c5f 7072       internal_pr
+00028800: 696f 7269 7479 203d 2064 6173 6b2e 6f72  iority = dask.or
+00028810: 6465 722e 6f72 6465 7228 6473 6b2c 2064  der.order(dsk, d
+00028820: 6570 656e 6465 6e63 6965 733d 7374 7269  ependencies=stri
+00028830: 7070 6564 5f64 6570 7329 0a0a 2020 2020  pped_deps)..    
+00028840: 2020 2020 666f 7220 7473 2069 6e20 7461      for ts in ta
+00028850: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00028860: 2023 204e 6f74 653a 2055 6e64 6572 2077   # Note: Under w
+00028870: 6869 6368 2063 6972 6375 6d73 7461 6e63  hich circumstanc
+00028880: 6573 2077 6f75 6c64 2061 2074 6173 6b20  es would a task 
+00028890: 6e6f 7420 6861 7665 2061 0a20 2020 2020  not have a.     
+000288a0: 2020 2020 2020 2023 2070 7269 6f72 6974         # priorit
+000288b0: 6979 2061 7373 6967 6e65 6420 6279 206e  iy assigned by n
+000288c0: 6f77 3f20 4172 6520 7468 6573 6520 7363  ow? Are these sc
+000288d0: 6174 7465 7265 6420 7461 736b 730a 2020  attered tasks.  
+000288e0: 2020 2020 2020 2020 2020 2320 6578 636c            # excl
+000288f0: 7573 6976 656c 7920 6f72 2073 6f6d 6574  usively or somet
+00028900: 6869 6e67 2065 6c73 653f 0a20 2020 2020  hing else?.     
+00028910: 2020 2020 2020 2074 6173 6b5f 7573 6572         task_user
+00028920: 5f70 7269 6f20 3d20 7573 6572 5f70 7269  _prio = user_pri
+00028930: 6f72 6974 790a 2020 2020 2020 2020 2020  ority.          
+00028940: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00028950: 7573 6572 5f70 7269 6f72 6974 792c 2064  user_priority, d
+00028960: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
+00028970: 2020 2020 2020 7461 736b 5f75 7365 725f        task_user_
+00028980: 7072 696f 203d 2075 7365 725f 7072 696f  prio = user_prio
+00028990: 7269 7479 2e67 6574 2874 732e 6b65 792c  rity.get(ts.key,
+000289a0: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
+000289b0: 616e 6e6f 7461 7465 645f 7072 696f 203d  annotated_prio =
+000289c0: 2074 732e 616e 6e6f 7461 7469 6f6e 732e   ts.annotations.
+000289d0: 6765 7428 2270 7269 6f72 6974 7922 2c20  get("priority", 
+000289e0: 7b7d 290a 2020 2020 2020 2020 2020 2020  {}).            
+000289f0: 6966 206e 6f74 2061 6e6e 6f74 6174 6564  if not annotated
+00028a00: 5f70 7269 6f3a 0a20 2020 2020 2020 2020  _prio:.         
+00028a10: 2020 2020 2020 2061 6e6e 6f74 6174 6564         annotated
+00028a20: 5f70 7269 6f20 3d20 7461 736b 5f75 7365  _prio = task_use
+00028a30: 725f 7072 696f 0a0a 2020 2020 2020 2020  r_prio..        
+00028a40: 2020 2020 6966 206e 6f74 2074 732e 7072      if not ts.pr
+00028a50: 696f 7269 7479 2061 6e64 2074 732e 6b65  iority and ts.ke
+00028a60: 7920 696e 2069 6e74 6572 6e61 6c5f 7072  y in internal_pr
+00028a70: 696f 7269 7479 3a0a 2020 2020 2020 2020  iority:.        
+00028a80: 2020 2020 2020 2020 7473 2e70 7269 6f72          ts.prior
+00028a90: 6974 7920 3d20 280a 2020 2020 2020 2020  ity = (.        
+00028aa0: 2020 2020 2020 2020 2020 2020 2d61 6e6e              -ann
+00028ab0: 6f74 6174 6564 5f70 7269 6f2c 0a20 2020  otated_prio,.   
+00028ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ad0: 2067 656e 6572 6174 696f 6e2c 0a20 2020   generation,.   
+00028ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028af0: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00028b00: 7479 5b74 732e 6b65 795d 2c0a 2020 2020  ty[ts.key],.    
+00028b10: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00028b20: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00028b30: 6c66 2e76 616c 6964 6174 6520 616e 6420  lf.validate and 
+00028b40: 7473 2e72 756e 5f73 7065 633a 0a20 2020  ts.run_spec:.   
+00028b50: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00028b60: 6572 7420 6973 696e 7374 616e 6365 2874  ert isinstance(t
+00028b70: 732e 7072 696f 7269 7479 2c20 7475 706c  s.priority, tupl
+00028b80: 6529 2061 6e64 2061 6c6c 280a 2020 2020  e) and all(.    
+00028b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028ba0: 6973 696e 7374 616e 6365 2865 6c2c 2028  isinstance(el, (
+00028bb0: 696e 742c 2066 6c6f 6174 2929 2066 6f72  int, float)) for
+00028bc0: 2065 6c20 696e 2074 732e 7072 696f 7269   el in ts.priori
+00028bd0: 7479 0a20 2020 2020 2020 2020 2020 2020  ty.             
+00028be0: 2020 2029 0a0a 2020 2020 6465 6620 5f70     )..    def _p
+00028bf0: 6f70 5f6c 6f73 745f 7461 736b 7328 0a20  op_lost_tasks(. 
+00028c00: 2020 2020 2020 2073 656c 662c 2064 736b         self, dsk
+00028c10: 3a20 6469 6374 2c20 6465 7065 6e64 656e  : dict, dependen
+00028c20: 6369 6573 3a20 6469 6374 2c20 6b65 7973  cies: dict, keys
+00028c30: 3a20 7365 745b 7374 725d 0a20 2020 2029  : set[str].    )
+00028c40: 202d 3e20 7365 745b 7374 725d 3a0a 2020   -> set[str]:.  
+00028c50: 2020 2020 2020 6e20 3d20 300a 2020 2020        n = 0.    
+00028c60: 2020 2020 6f75 7420 3d20 7365 7428 290a      out = set().
+00028c70: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
+00028c80: 6e28 6473 6b29 2021 3d20 6e3a 2020 2320  n(dsk) != n:  # 
+00028c90: 7761 6c6b 2074 6872 6f75 6768 206e 6577  walk through new
+00028ca0: 2074 6173 6b73 2c20 6361 6e63 656c 2061   tasks, cancel a
+00028cb0: 6e79 2062 6164 2064 6570 730a 2020 2020  ny bad deps.    
+00028cc0: 2020 2020 2020 2020 6e20 3d20 6c65 6e28          n = len(
+00028cd0: 6473 6b29 0a20 2020 2020 2020 2020 2020  dsk).           
+00028ce0: 2066 6f72 206b 2c20 6465 7073 2069 6e20   for k, deps in 
+00028cf0: 6c69 7374 2864 6570 656e 6465 6e63 6965  list(dependencie
+00028d00: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
+00028d10: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+00028d20: 6e79 280a 2020 2020 2020 2020 2020 2020  ny(.            
+00028d30: 2020 2020 2020 2020 6465 7020 6e6f 7420          dep not 
+00028d40: 696e 2073 656c 662e 7461 736b 7320 616e  in self.tasks an
+00028d50: 6420 6465 7020 6e6f 7420 696e 2064 736b  d dep not in dsk
+00028d60: 2066 6f72 2064 6570 2069 6e20 6465 7073   for dep in deps
+00028d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028d80: 2029 3a20 2023 2062 6164 206b 6579 0a20   ):  # bad key. 
+00028d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028da0: 2020 206f 7574 2e61 6464 286b 290a 2020     out.add(k).  
+00028db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028dc0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2255    logger.info("U
+00028dd0: 7365 7220 6173 6b65 6420 666f 7220 636f  ser asked for co
+00028de0: 6d70 7574 6174 696f 6e20 6f6e 206c 6f73  mputation on los
+00028df0: 7420 6461 7461 2c20 2573 222c 206b 290a  t data, %s", k).
 00028e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e10: 2020 6966 206b 2069 6e20 6b65 7973 3a0a    if k in keys:.
+00028e10: 2020 2020 6465 6c20 6473 6b5b 6b5d 0a20      del dsk[k]. 
 00028e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e30: 2020 2020 2020 2020 6b65 7973 2e72 656d          keys.rem
-00028e40: 6f76 6528 6b29 0a20 2020 2020 2020 2072  ove(k).        r
-00028e50: 6574 7572 6e20 6f75 740a 0a20 2020 2064  eturn out..    d
-00028e60: 6566 205f 706f 705f 6b6e 6f77 6e5f 7461  ef _pop_known_ta
-00028e70: 736b 7328 7365 6c66 2c20 6473 6b3a 2064  sks(self, dsk: d
-00028e80: 6963 742c 2064 6570 656e 6465 6e63 6965  ict, dependencie
-00028e90: 733a 2064 6963 7429 202d 3e20 7365 745b  s: dict) -> set[
-00028ea0: 7374 725d 3a0a 2020 2020 2020 2020 2320  str]:.        # 
-00028eb0: 4176 6f69 6420 636f 6d70 7574 6174 696f  Avoid computatio
-00028ec0: 6e20 7468 6174 2069 7320 616c 7265 6164  n that is alread
-00028ed0: 7920 6669 6e69 7368 6564 0a20 2020 2020  y finished.     
-00028ee0: 2020 2061 6c72 6561 6479 5f69 6e5f 6d65     already_in_me
-00028ef0: 6d6f 7279 203d 2073 6574 2829 2020 2320  mory = set()  # 
-00028f00: 7461 736b 7320 7468 6174 2061 7265 2061  tasks that are a
-00028f10: 6c72 6561 6479 2064 6f6e 650a 2020 2020  lready done.    
-00028f20: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-00028f30: 6465 7065 6e64 656e 6369 6573 2e69 7465  dependencies.ite
-00028f40: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00028f50: 2020 6966 2076 2061 6e64 206b 2069 6e20    if v and k in 
-00028f60: 7365 6c66 2e74 6173 6b73 3a0a 2020 2020  self.tasks:.    
-00028f70: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-00028f80: 2073 656c 662e 7461 736b 735b 6b5d 0a20   self.tasks[k]. 
-00028f90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00028fa0: 6620 7473 2e73 7461 7465 2069 6e20 2822  f ts.state in ("
-00028fb0: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
-00028fc0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00028fd0: 2020 2020 2020 2061 6c72 6561 6479 5f69         already_i
-00028fe0: 6e5f 6d65 6d6f 7279 2e61 6464 286b 290a  n_memory.add(k).
-00028ff0: 0a20 2020 2020 2020 2064 6f6e 6520 3d20  .        done = 
-00029000: 7365 7428 616c 7265 6164 795f 696e 5f6d  set(already_in_m
-00029010: 656d 6f72 7929 0a20 2020 2020 2020 2069  emory).        i
-00029020: 6620 616c 7265 6164 795f 696e 5f6d 656d  f already_in_mem
-00029030: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
-00029040: 2064 6570 656e 6465 6e74 7320 3d20 6461   dependents = da
-00029050: 736b 2e63 6f72 652e 7265 7665 7273 655f  sk.core.reverse_
-00029060: 6469 6374 2864 6570 656e 6465 6e63 6965  dict(dependencie
-00029070: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
-00029080: 7461 636b 203d 206c 6973 7428 616c 7265  tack = list(alre
-00029090: 6164 795f 696e 5f6d 656d 6f72 7929 0a20  ady_in_memory). 
-000290a0: 2020 2020 2020 2020 2020 2077 6869 6c65             while
-000290b0: 2073 7461 636b 3a20 2023 2072 656d 6f76   stack:  # remov
-000290c0: 6520 756e 6e65 6365 7373 6172 7920 6465  e unnecessary de
-000290d0: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
-000290e0: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-000290f0: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
-00029100: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00029110: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029120: 2020 2020 2020 6465 7073 203d 2064 6570        deps = dep
-00029130: 656e 6465 6e63 6965 735b 6b65 795d 0a20  endencies[key]. 
-00029140: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00029150: 7863 6570 7420 4b65 7945 7272 6f72 3a0a  xcept KeyError:.
-00029160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029170: 2020 2020 6465 7073 203d 2073 656c 662e      deps = self.
-00029180: 7461 736b 735b 6b65 795d 2e64 6570 656e  tasks[key].depen
-00029190: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-000291a0: 2020 2020 2020 2020 666f 7220 6465 7020          for dep 
-000291b0: 696e 2064 6570 733a 0a20 2020 2020 2020  in deps:.       
-000291c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000291d0: 6465 7020 696e 2064 6570 656e 6465 6e74  dep in dependent
-000291e0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000291f0: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-00029200: 5f64 6570 7320 3d20 6465 7065 6e64 656e  _deps = dependen
-00029210: 7473 5b64 6570 5d0a 2020 2020 2020 2020  ts[dep].        
-00029220: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00029230: 2064 6570 2069 6e20 7365 6c66 2e74 6173   dep in self.tas
-00029240: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
-00029250: 2020 2020 2020 2020 2020 2020 6368 696c              chil
-00029260: 645f 6465 7073 203d 2073 656c 662e 7461  d_deps = self.ta
-00029270: 736b 735b 6465 705d 2e64 6570 656e 6465  sks[dep].depende
-00029280: 6e63 6965 730a 2020 2020 2020 2020 2020  ncies.          
-00029290: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000292a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000292b0: 2020 2020 2020 2020 6368 696c 645f 6465          child_de
-000292c0: 7073 203d 2073 6574 2829 0a20 2020 2020  ps = set().     
-000292d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000292e0: 6620 616c 6c28 6420 696e 2064 6f6e 6520  f all(d in done 
-000292f0: 666f 7220 6420 696e 2063 6869 6c64 5f64  for d in child_d
-00029300: 6570 7329 3a0a 2020 2020 2020 2020 2020  eps):.          
-00029310: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00029320: 2064 6570 2069 6e20 7365 6c66 2e74 6173   dep in self.tas
-00029330: 6b73 2061 6e64 2064 6570 206e 6f74 2069  ks and dep not i
-00029340: 6e20 646f 6e65 3a0a 2020 2020 2020 2020  n done:.        
+00028e30: 2020 2064 656c 2064 6570 656e 6465 6e63     del dependenc
+00028e40: 6965 735b 6b5d 0a20 2020 2020 2020 2020  ies[k].         
+00028e50: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
+00028e60: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
+00028e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028e80: 206b 6579 732e 7265 6d6f 7665 286b 290a   keys.remove(k).
+00028e90: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+00028ea0: 7574 0a0a 2020 2020 6465 6620 5f70 6f70  ut..    def _pop
+00028eb0: 5f6b 6e6f 776e 5f74 6173 6b73 2873 656c  _known_tasks(sel
+00028ec0: 662c 2064 736b 3a20 6469 6374 2c20 6465  f, dsk: dict, de
+00028ed0: 7065 6e64 656e 6369 6573 3a20 6469 6374  pendencies: dict
+00028ee0: 2920 2d3e 2073 6574 5b73 7472 5d3a 0a20  ) -> set[str]:. 
+00028ef0: 2020 2020 2020 2023 2041 766f 6964 2063         # Avoid c
+00028f00: 6f6d 7075 7461 7469 6f6e 2074 6861 7420  omputation that 
+00028f10: 6973 2061 6c72 6561 6479 2066 696e 6973  is already finis
+00028f20: 6865 640a 2020 2020 2020 2020 616c 7265  hed.        alre
+00028f30: 6164 795f 696e 5f6d 656d 6f72 7920 3d20  ady_in_memory = 
+00028f40: 7365 7428 2920 2023 2074 6173 6b73 2074  set()  # tasks t
+00028f50: 6861 7420 6172 6520 616c 7265 6164 7920  hat are already 
+00028f60: 646f 6e65 0a20 2020 2020 2020 2066 6f72  done.        for
+00028f70: 206b 2c20 7620 696e 2064 6570 656e 6465   k, v in depende
+00028f80: 6e63 6965 732e 6974 656d 7328 293a 0a20  ncies.items():. 
+00028f90: 2020 2020 2020 2020 2020 2069 6620 7620             if v 
+00028fa0: 616e 6420 6b20 696e 2073 656c 662e 7461  and k in self.ta
+00028fb0: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+00028fc0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+00028fd0: 6173 6b73 5b6b 5d0a 2020 2020 2020 2020  asks[k].        
+00028fe0: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+00028ff0: 6174 6520 696e 2028 226d 656d 6f72 7922  ate in ("memory"
+00029000: 2c20 2265 7272 6564 2229 3a0a 2020 2020  , "erred"):.    
+00029010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029020: 616c 7265 6164 795f 696e 5f6d 656d 6f72  already_in_memor
+00029030: 792e 6164 6428 6b29 0a0a 2020 2020 2020  y.add(k)..      
+00029040: 2020 646f 6e65 203d 2073 6574 2861 6c72    done = set(alr
+00029050: 6561 6479 5f69 6e5f 6d65 6d6f 7279 290a  eady_in_memory).
+00029060: 2020 2020 2020 2020 6966 2061 6c72 6561          if alrea
+00029070: 6479 5f69 6e5f 6d65 6d6f 7279 3a0a 2020  dy_in_memory:.  
+00029080: 2020 2020 2020 2020 2020 6465 7065 6e64            depend
+00029090: 656e 7473 203d 2064 6173 6b2e 636f 7265  ents = dask.core
+000290a0: 2e72 6576 6572 7365 5f64 6963 7428 6465  .reverse_dict(de
+000290b0: 7065 6e64 656e 6369 6573 290a 2020 2020  pendencies).    
+000290c0: 2020 2020 2020 2020 7374 6163 6b20 3d20          stack = 
+000290d0: 6c69 7374 2861 6c72 6561 6479 5f69 6e5f  list(already_in_
+000290e0: 6d65 6d6f 7279 290a 2020 2020 2020 2020  memory).        
+000290f0: 2020 2020 7768 696c 6520 7374 6163 6b3a      while stack:
+00029100: 2020 2320 7265 6d6f 7665 2075 6e6e 6563    # remove unnec
+00029110: 6573 7361 7279 2064 6570 656e 6465 6e63  essary dependenc
+00029120: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+00029130: 2020 2020 6b65 7920 3d20 7374 6163 6b2e      key = stack.
+00029140: 706f 7028 290a 2020 2020 2020 2020 2020  pop().          
+00029150: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00029160: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00029170: 6570 7320 3d20 6465 7065 6e64 656e 6369  eps = dependenci
+00029180: 6573 5b6b 6579 5d0a 2020 2020 2020 2020  es[key].        
+00029190: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+000291a0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+000291b0: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+000291c0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+000291d0: 6579 5d2e 6465 7065 6e64 656e 6369 6573  ey].dependencies
+000291e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000291f0: 2066 6f72 2064 6570 2069 6e20 6465 7073   for dep in deps
+00029200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029210: 2020 2020 2020 6966 2064 6570 2069 6e20        if dep in 
+00029220: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00029230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029240: 2020 2020 6368 696c 645f 6465 7073 203d      child_deps =
+00029250: 2064 6570 656e 6465 6e74 735b 6465 705d   dependents[dep]
+00029260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029270: 2020 2020 2065 6c69 6620 6465 7020 696e       elif dep in
+00029280: 2073 656c 662e 7461 736b 733a 0a20 2020   self.tasks:.   
+00029290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292a0: 2020 2020 2063 6869 6c64 5f64 6570 7320       child_deps 
+000292b0: 3d20 7365 6c66 2e74 6173 6b73 5b64 6570  = self.tasks[dep
+000292c0: 5d2e 6465 7065 6e64 656e 6369 6573 0a20  ].dependencies. 
+000292d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000292e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000292f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029300: 2063 6869 6c64 5f64 6570 7320 3d20 7365   child_deps = se
+00029310: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00029320: 2020 2020 2020 2020 6966 2061 6c6c 2864          if all(d
+00029330: 2069 6e20 646f 6e65 2066 6f72 2064 2069   in done for d i
+00029340: 6e20 6368 696c 645f 6465 7073 293a 0a20  n child_deps):. 
 00029350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029360: 2020 2020 646f 6e65 2e61 6464 2864 6570      done.add(dep
-00029370: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00029380: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00029390: 6163 6b2e 6170 7065 6e64 2864 6570 290a  ack.append(dep).
-000293a0: 2020 2020 2020 2020 666f 7220 616e 6320          for anc 
-000293b0: 696e 2064 6f6e 653a 0a20 2020 2020 2020  in done:.       
-000293c0: 2020 2020 2064 736b 2e70 6f70 2861 6e63       dsk.pop(anc
-000293d0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-000293e0: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-000293f0: 2e70 6f70 2861 6e63 2c20 4e6f 6e65 290a  .pop(anc, None).
-00029400: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00029410: 6f6e 650a 0a20 2020 2040 7374 6174 6963  one..    @static
-00029420: 6d65 7468 6f64 0a20 2020 2064 6566 206d  method.    def m
-00029430: 6174 6572 6961 6c69 7a65 5f67 7261 7068  aterialize_graph
-00029440: 2868 6c67 3a20 4869 6768 4c65 7665 6c47  (hlg: HighLevelG
-00029450: 7261 7068 2920 2d3e 2074 7570 6c65 5b64  raph) -> tuple[d
-00029460: 6963 742c 2064 6963 742c 2064 6963 742c  ict, dict, dict,
-00029470: 2064 6963 745d 3a0a 2020 2020 2020 2020   dict]:.        
-00029480: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00029490: 2e77 6f72 6b65 7220 696d 706f 7274 2064  .worker import d
-000294a0: 756d 7073 5f74 6173 6b0a 0a20 2020 2020  umps_task..     
-000294b0: 2020 206b 6579 5f61 6e6e 6f74 6174 696f     key_annotatio
-000294c0: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
-000294d0: 6473 6b20 3d20 6461 736b 2e75 7469 6c73  dsk = dask.utils
-000294e0: 2e65 6e73 7572 655f 6469 6374 2868 6c67  .ensure_dict(hlg
-000294f0: 290a 0a20 2020 2020 2020 2066 6f72 206c  )..        for l
-00029500: 6179 6572 2069 6e20 686c 672e 6c61 7965  ayer in hlg.laye
-00029510: 7273 2e76 616c 7565 7328 293a 0a20 2020  rs.values():.   
-00029520: 2020 2020 2020 2020 2069 6620 6c61 7965           if laye
-00029530: 722e 616e 6e6f 7461 7469 6f6e 733a 0a20  r.annotations:. 
-00029540: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00029550: 6e6e 6f74 203d 206c 6179 6572 2e61 6e6e  nnot = layer.ann
-00029560: 6f74 6174 696f 6e73 0a20 2020 2020 2020  otations.       
-00029570: 2020 2020 2020 2020 206b 6579 5f61 6e6e           key_ann
-00029580: 6f74 6174 696f 6e73 2e75 7064 6174 6528  otations.update(
-00029590: 7b73 7472 696e 6769 6679 286b 293a 2061  {stringify(k): a
-000295a0: 6e6e 6f74 2066 6f72 206b 2069 6e20 6c61  nnot for k in la
-000295b0: 7965 727d 290a 0a20 2020 2020 2020 2064  yer})..        d
-000295c0: 6570 656e 6465 6e63 6965 732c 205f 203d  ependencies, _ =
-000295d0: 2067 6574 5f64 6570 7328 6473 6b29 0a0a   get_deps(dsk)..
-000295e0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-000295f0: 2060 4675 7475 7265 6020 6f62 6a65 6374   `Future` object
-00029600: 7320 6672 6f6d 2067 7261 7068 2061 6e64  s from graph and
-00029610: 206e 6f74 6520 616e 7920 6675 7475 7265   note any future
-00029620: 2064 6570 656e 6465 6e63 6965 730a 2020   dependencies.  
-00029630: 2020 2020 2020 6473 6b32 203d 207b 7d0a        dsk2 = {}.
-00029640: 2020 2020 2020 2020 6675 745f 6465 7073          fut_deps
-00029650: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
-00029660: 7220 6b2c 2076 2069 6e20 6473 6b2e 6974  r k, v in dsk.it
-00029670: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00029680: 2020 2064 736b 325b 6b5d 2c20 6675 7473     dsk2[k], futs
-00029690: 203d 2075 6e70 6163 6b5f 7265 6d6f 7465   = unpack_remote
-000296a0: 6461 7461 2876 2c20 6279 7465 5f6b 6579  data(v, byte_key
-000296b0: 733d 5472 7565 290a 2020 2020 2020 2020  s=True).        
-000296c0: 2020 2020 6966 2066 7574 733a 0a20 2020      if futs:.   
-000296d0: 2020 2020 2020 2020 2020 2020 2066 7574               fut
-000296e0: 5f64 6570 735b 6b5d 203d 2066 7574 730a  _deps[k] = futs.
-000296f0: 2020 2020 2020 2020 6473 6b20 3d20 6473          dsk = ds
-00029700: 6b32 0a0a 2020 2020 2020 2020 2320 2d20  k2..        # - 
-00029710: 4164 6420 696e 2064 6570 7320 666f 7220  Add in deps for 
-00029720: 616e 7920 7461 736b 7320 7468 6174 2064  any tasks that d
-00029730: 6570 656e 6420 6f6e 2066 7574 7572 6573  epend on futures
-00029740: 0a20 2020 2020 2020 2066 6f72 206b 2c20  .        for k, 
-00029750: 6675 7475 7265 7320 696e 2066 7574 5f64  futures in fut_d
-00029760: 6570 732e 6974 656d 7328 293a 0a20 2020  eps.items():.   
-00029770: 2020 2020 2020 2020 2064 6570 656e 6465           depende
-00029780: 6e63 6965 735b 6b5d 2e75 7064 6174 6528  ncies[k].update(
-00029790: 662e 6b65 7920 666f 7220 6620 696e 2066  f.key for f in f
-000297a0: 7574 7572 6573 290a 2020 2020 2020 2020  utures).        
-000297b0: 6e65 775f 6473 6b20 3d20 7b7d 0a20 2020  new_dsk = {}.   
-000297c0: 2020 2020 2023 2041 6e6e 6f74 6174 696f       # Annotatio
-000297d0: 6e20 6361 6c6c 6162 6c65 7320 6172 6520  n callables are 
-000297e0: 6576 616c 7561 7465 6420 6f6e 2074 6865  evaluated on the
-000297f0: 206e 6f6e 2d73 7472 696e 6769 6669 6564   non-stringified
-00029800: 2076 6572 7369 6f6e 206f 660a 2020 2020   version of.    
-00029810: 2020 2020 2320 7468 6520 6b65 7973 0a20      # the keys. 
-00029820: 2020 2020 2020 2070 7265 5f73 7472 696e         pre_strin
-00029830: 6769 6669 6564 5f6b 6579 7320 3d20 7b7d  gified_keys = {}
-00029840: 0a20 2020 2020 2020 2065 7863 6c75 7369  .        exclusi
-00029850: 7665 203d 2073 6574 2868 6c67 290a 2020  ve = set(hlg).  
-00029860: 2020 2020 2020 666f 7220 6b2c 2076 2069        for k, v i
-00029870: 6e20 6473 6b2e 6974 656d 7328 293a 0a20  n dsk.items():. 
-00029880: 2020 2020 2020 2020 2020 206e 6577 5f6b             new_k
-00029890: 203d 2073 7472 696e 6769 6679 286b 290a   = stringify(k).
-000298a0: 2020 2020 2020 2020 2020 2020 7072 655f              pre_
-000298b0: 7374 7269 6e67 6966 6965 645f 6b65 7973  stringified_keys
-000298c0: 5b6e 6577 5f6b 5d20 3d20 6b0a 2020 2020  [new_k] = k.    
-000298d0: 2020 2020 2020 2020 6e65 775f 6473 6b5b          new_dsk[
-000298e0: 6e65 775f 6b5d 203d 2073 7472 696e 6769  new_k] = stringi
-000298f0: 6679 2876 2c20 6578 636c 7573 6976 653d  fy(v, exclusive=
-00029900: 6578 636c 7573 6976 6529 0a20 2020 2020  exclusive).     
-00029910: 2020 2061 7373 6572 7420 6c65 6e28 6e65     assert len(ne
-00029920: 775f 6473 6b29 203d 3d20 6c65 6e28 7072  w_dsk) == len(pr
-00029930: 655f 7374 7269 6e67 6966 6965 645f 6b65  e_stringified_ke
-00029940: 7973 290a 2020 2020 2020 2020 6473 6b20  ys).        dsk 
-00029950: 3d20 6e65 775f 6473 6b0a 2020 2020 2020  = new_dsk.      
-00029960: 2020 6465 7065 6e64 656e 6369 6573 203d    dependencies =
-00029970: 207b 0a20 2020 2020 2020 2020 2020 2073   {.            s
-00029980: 7472 696e 6769 6679 286b 293a 207b 7374  tringify(k): {st
-00029990: 7269 6e67 6966 7928 6465 7029 2066 6f72  ringify(dep) for
-000299a0: 2064 6570 2069 6e20 6465 7073 7d0a 2020   dep in deps}.  
-000299b0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-000299c0: 2064 6570 7320 696e 2064 6570 656e 6465   deps in depende
-000299d0: 6e63 6965 732e 6974 656d 7328 290a 2020  ncies.items().  
-000299e0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000299f0: 2023 2052 656d 6f76 6520 616e 7920 7365   # Remove any se
-00029a00: 6c66 2d64 6570 656e 6465 6e63 6965 7320  lf-dependencies 
-00029a10: 2868 6170 7065 6e73 206f 6e20 7465 7374  (happens on test
-00029a20: 5f70 7562 6c69 7368 5f62 6167 2829 2061  _publish_bag() a
-00029a30: 6e64 206f 7468 6572 7329 0a20 2020 2020  nd others).     
-00029a40: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
-00029a50: 6570 656e 6465 6e63 6965 732e 6974 656d  ependencies.item
-00029a60: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00029a70: 2064 6570 7320 3d20 7365 7428 7629 0a20   deps = set(v). 
-00029a80: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
-00029a90: 696e 2064 6570 733a 0a20 2020 2020 2020  in deps:.       
-00029aa0: 2020 2020 2020 2020 2064 6570 732e 7265           deps.re
-00029ab0: 6d6f 7665 286b 290a 2020 2020 2020 2020  move(k).        
-00029ac0: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-00029ad0: 5b6b 5d20 3d20 6465 7073 0a0a 2020 2020  [k] = deps..    
-00029ae0: 2020 2020 2320 5265 6d6f 7665 2061 6c69      # Remove ali
-00029af0: 6173 6573 0a20 2020 2020 2020 2066 6f72  ases.        for
-00029b00: 206b 2069 6e20 6c69 7374 2864 736b 293a   k in list(dsk):
-00029b10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00029b20: 6473 6b5b 6b5d 2069 7320 6b3a 0a20 2020  dsk[k] is k:.   
-00029b30: 2020 2020 2020 2020 2020 2020 2064 656c               del
-00029b40: 2064 736b 5b6b 5d0a 2020 2020 2020 2020   dsk[k].        
-00029b50: 6473 6b20 3d20 7661 6c6d 6170 2864 756d  dsk = valmap(dum
-00029b60: 7073 5f74 6173 6b2c 2064 736b 290a 2020  ps_task, dsk).  
-00029b70: 2020 2020 2020 7265 7475 726e 2064 736b        return dsk
-00029b80: 2c20 6465 7065 6e64 656e 6369 6573 2c20  , dependencies, 
-00029b90: 6b65 795f 616e 6e6f 7461 7469 6f6e 732c  key_annotations,
-00029ba0: 2070 7265 5f73 7472 696e 6769 6669 6564   pre_stringified
-00029bb0: 5f6b 6579 730a 0a20 2020 2064 6566 2073  _keys..    def s
-00029bc0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
-00029bd0: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
-00029be0: 2873 656c 662c 202a 2c20 7374 696d 756c  (self, *, stimul
-00029bf0: 7573 5f69 643a 2073 7472 2920 2d3e 204e  us_id: str) -> N
-00029c00: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00029c10: 5265 7370 6f6e 6420 746f 2061 6e20 6576  Respond to an ev
-00029c20: 656e 7420 7768 6963 6820 6d61 7920 6861  ent which may ha
-00029c30: 7665 206f 7065 6e65 6420 7370 6f74 7320  ve opened spots 
-00029c40: 6f6e 2077 6f72 6b65 7220 7468 7265 6164  on worker thread
-00029c50: 706f 6f6c 730a 0a20 2020 2020 2020 2053  pools..        S
-00029c60: 656c 6563 7473 2074 6865 2061 7070 726f  elects the appro
-00029c70: 7072 6961 7465 206e 756d 6265 7220 6f66  priate number of
-00029c80: 2074 6173 6b73 2066 726f 6d20 7468 6520   tasks from the 
-00029c90: 6672 6f6e 7420 6f66 2074 6865 2071 7565  front of the que
-00029ca0: 7565 2061 6363 6f72 6469 6e67 2074 6f0a  ue according to.
-00029cb0: 2020 2020 2020 2020 7468 6520 746f 7461          the tota
-00029cc0: 6c20 6e75 6d62 6572 206f 6620 7461 736b  l number of task
-00029cd0: 2073 6c6f 7473 2061 7661 696c 6162 6c65   slots available
-00029ce0: 206f 6e20 776f 726b 6572 7320 2870 6f74   on workers (pot
-00029cf0: 656e 7469 616c 6c79 2030 292c 2061 6e64  entially 0), and
-00029d00: 0a20 2020 2020 2020 2074 7261 6e73 6974  .        transit
-00029d10: 696f 6e73 2074 6865 6d20 746f 2060 6070  ions them to ``p
-00029d20: 726f 6365 7373 696e 6760 602e 0a0a 2020  rocessing``...  
-00029d30: 2020 2020 2020 4e6f 7465 730a 2020 2020        Notes.    
-00029d40: 2020 2020 2d2d 2d2d 2d0a 2020 2020 2020      -----.      
-00029d50: 2020 4f74 6865 7220 7472 616e 7369 7469    Other transiti
-00029d60: 6f6e 7320 7265 6c61 7465 6420 746f 2074  ons related to t
-00029d70: 6869 7320 7374 696d 756c 7573 2073 686f  his stimulus sho
-00029d80: 756c 6420 6265 2066 756c 6c79 2070 726f  uld be fully pro
-00029d90: 6365 7373 6564 2062 6566 6f72 6568 616e  cessed beforehan
-00029da0: 642c 0a20 2020 2020 2020 2073 6f20 616e  d,.        so an
-00029db0: 7920 7461 736b 7320 7468 6174 2062 6563  y tasks that bec
-00029dc0: 616d 6520 7275 6e6e 6162 6c65 2061 7265  ame runnable are
-00029dd0: 2061 6c72 6561 6479 2069 6e20 6060 7072   already in ``pr
-00029de0: 6f63 6573 7369 6e67 6060 2e20 4f74 6865  ocessing``. Othe
-00029df0: 7277 6973 652c 0a20 2020 2020 2020 206f  rwise,.        o
-00029e00: 7665 7270 726f 6475 6374 696f 6e20 6361  verproduction ca
-00029e10: 6e20 6f63 6375 7220 6966 2071 7565 7565  n occur if queue
-00029e20: 6420 7461 736b 7320 6765 7420 7363 6865  d tasks get sche
-00029e30: 6475 6c65 6420 6265 666f 7265 2064 6f77  duled before dow
-00029e40: 6e73 7472 6561 6d20 7461 736b 732e 0a0a  nstream tasks...
-00029e50: 2020 2020 2020 2020 4d75 7374 2062 6520          Must be 
-00029e60: 6361 6c6c 6564 2061 6674 6572 2060 6368  called after `ch
-00029e70: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-00029e80: 6564 603b 2069 2e65 2e20 6069 646c 655f  ed`; i.e. `idle_
-00029e90: 7461 736b 5f63 6f75 6e74 6020 6d75 7374  task_count` must
-00029ea0: 2062 6520 7570 0a20 2020 2020 2020 2074   be up.        t
-00029eb0: 6f20 6461 7465 2e0a 2020 2020 2020 2020  o date..        
-00029ec0: 2222 220a 2020 2020 2020 2020 6966 206e  """.        if n
-00029ed0: 6f74 2073 656c 662e 7175 6575 6564 3a0a  ot self.queued:.
-00029ee0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00029ef0: 726e 0a20 2020 2020 2020 2073 6c6f 7473  rn.        slots
-00029f00: 5f61 7661 696c 6162 6c65 203d 2073 756d  _available = sum
-00029f10: 280a 2020 2020 2020 2020 2020 2020 5f74  (.            _t
-00029f20: 6173 6b5f 736c 6f74 735f 6176 6169 6c61  ask_slots_availa
-00029f30: 626c 6528 7773 2c20 7365 6c66 2e57 4f52  ble(ws, self.WOR
-00029f40: 4b45 525f 5341 5455 5241 5449 4f4e 290a  KER_SATURATION).
-00029f50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00029f60: 7773 2069 6e20 7365 6c66 2e69 646c 655f  ws in self.idle_
-00029f70: 7461 736b 5f63 6f75 6e74 0a20 2020 2020  task_count.     
-00029f80: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-00029f90: 736c 6f74 735f 6176 6169 6c61 626c 6520  slots_available 
-00029fa0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00029fb0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00029fc0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00029fd0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00029fe0: 2020 2020 2066 6f72 2071 7473 2069 6e20       for qts in 
-00029ff0: 7365 6c66 2e71 7565 7565 642e 7065 656b  self.queued.peek
-0002a000: 6e28 736c 6f74 735f 6176 6169 6c61 626c  n(slots_availabl
-0002a010: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-0002a020: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-0002a030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002a040: 2020 6173 7365 7274 2071 7473 2e73 7461    assert qts.sta
-0002a050: 7465 203d 3d20 2271 7565 7565 6422 2c20  te == "queued", 
-0002a060: 7174 732e 7374 6174 650a 2020 2020 2020  qts.state.      
-0002a070: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002a080: 206e 6f74 2071 7473 2e70 726f 6365 7373   not qts.process
-0002a090: 696e 675f 6f6e 2c20 2871 7473 2c20 7174  ing_on, (qts, qt
-0002a0a0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e29  s.processing_on)
-0002a0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a0c0: 2061 7373 6572 7420 6e6f 7420 7174 732e   assert not qts.
-0002a0d0: 7761 6974 696e 675f 6f6e 2c20 2871 7473  waiting_on, (qts
-0002a0e0: 2c20 7174 732e 7072 6f63 6573 7369 6e67  , qts.processing
-0002a0f0: 5f6f 6e29 0a20 2020 2020 2020 2020 2020  _on).           
-0002a100: 2020 2020 2061 7373 6572 7420 7174 732e       assert qts.
-0002a110: 7768 6f5f 7761 6e74 7320 6f72 2071 7473  who_wants or qts
-0002a120: 2e77 6169 7465 7273 2c20 7174 730a 2020  .waiters, qts.  
-0002a130: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0002a140: 656e 6461 7469 6f6e 735b 7174 732e 6b65  endations[qts.ke
-0002a150: 795d 203d 2022 7072 6f63 6573 7369 6e67  y] = "processing
-0002a160: 220a 0a20 2020 2020 2020 2073 656c 662e  "..        self.
-0002a170: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
-0002a180: 6d6d 656e 6461 7469 6f6e 732c 2073 7469  mmendations, sti
-0002a190: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
-0002a1a0: 6566 2073 7469 6d75 6c75 735f 7461 736b  ef stimulus_task
-0002a1b0: 5f66 696e 6973 6865 6428 7365 6c66 2c20  _finished(self, 
-0002a1c0: 6b65 792c 2077 6f72 6b65 722c 2073 7469  key, worker, sti
-0002a1d0: 6d75 6c75 735f 6964 2c20 7275 6e5f 6964  mulus_id, run_id
-0002a1e0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0002a1f0: 2020 2020 2022 2222 4d61 726b 2074 6861       """Mark tha
-0002a200: 7420 6120 7461 736b 2068 6173 2066 696e  t a task has fin
-0002a210: 6973 6865 6420 6578 6563 7574 696f 6e20  ished execution 
-0002a220: 6f6e 2061 2070 6172 7469 6375 6c61 7220  on a particular 
-0002a230: 776f 726b 6572 2222 220a 2020 2020 2020  worker""".      
-0002a240: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0002a250: 5374 696d 756c 7573 2074 6173 6b20 6669  Stimulus task fi
-0002a260: 6e69 7368 6564 2025 735b 2564 5d20 2573  nished %s[%d] %s
-0002a270: 222c 206b 6579 2c20 7275 6e5f 6964 2c20  ", key, run_id, 
-0002a280: 776f 726b 6572 290a 0a20 2020 2020 2020  worker)..       
-0002a290: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0002a2a0: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-0002a2b0: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-0002a2c0: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
-0002a2d0: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-0002a2e0: 4d73 6773 203d 207b 7d0a 0a20 2020 2020  Msgs = {}..     
-0002a2f0: 2020 2077 733a 2057 6f72 6b65 7253 7461     ws: WorkerSta
-0002a300: 7465 203d 2073 656c 662e 776f 726b 6572  te = self.worker
-0002a310: 735b 776f 726b 6572 5d0a 2020 2020 2020  s[worker].      
-0002a320: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002a330: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-0002a340: 286b 6579 290a 2020 2020 2020 2020 6966  (key).        if
-0002a350: 2074 7320 6973 204e 6f6e 6520 6f72 2074   ts is None or t
-0002a360: 732e 7374 6174 6520 696e 2028 2272 656c  s.state in ("rel
-0002a370: 6561 7365 6422 2c20 2271 7565 7565 6422  eased", "queued"
-0002a380: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
-0002a390: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-0002a3a0: 2020 2020 2020 2020 2020 2020 2022 5265               "Re
-0002a3b0: 6365 6976 6564 2061 6c72 6561 6479 2063  ceived already c
-0002a3c0: 6f6d 7075 7465 6420 7461 736b 2c20 776f  omputed task, wo
-0002a3d0: 726b 6572 3a20 2573 2c20 7374 6174 653a  rker: %s, state:
-0002a3e0: 2025 7322 0a20 2020 2020 2020 2020 2020   %s".           
-0002a3f0: 2020 2020 2022 2c20 6b65 793a 2025 732c       ", key: %s,
-0002a400: 2077 686f 5f68 6173 3a20 2573 222c 0a20   who_has: %s",. 
-0002a410: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0002a420: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-0002a430: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
-0002a440: 6966 2074 7320 656c 7365 2022 666f 7267  if ts else "forg
-0002a450: 6f74 7465 6e22 2c0a 2020 2020 2020 2020  otten",.        
-0002a460: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
-0002a470: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002a480: 7768 6f5f 6861 7320 6966 2074 7320 656c  who_has if ts el
-0002a490: 7365 207b 7d2c 0a20 2020 2020 2020 2020  se {},.         
-0002a4a0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0002a4b0: 2077 6f72 6b65 725f 6d73 6773 5b77 6f72   worker_msgs[wor
-0002a4c0: 6b65 725d 203d 205b 0a20 2020 2020 2020  ker] = [.       
-0002a4d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0002a4e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002a4f0: 6f70 223a 2022 6672 6565 2d6b 6579 7322  op": "free-keys"
-0002a500: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002a510: 2020 2020 2020 226b 6579 7322 3a20 5b6b        "keys": [k
-0002a520: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
-0002a530: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-0002a540: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-0002a550: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0002a560: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-0002a570: 2020 205d 0a20 2020 2020 2020 2065 6c69     ].        eli
-0002a580: 6620 7473 2e72 756e 5f69 6420 213d 2072  f ts.run_id != r
-0002a590: 756e 5f69 643a 0a20 2020 2020 2020 2020  un_id:.         
-0002a5a0: 2020 2069 6620 6e6f 7420 7473 2e70 726f     if not ts.pro
-0002a5b0: 6365 7373 696e 675f 6f6e 206f 7220 7473  cessing_on or ts
-0002a5c0: 2e70 726f 6365 7373 696e 675f 6f6e 2e61  .processing_on.a
-0002a5d0: 6464 7265 7373 2021 3d20 776f 726b 6572  ddress != worker
-0002a5e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002a5f0: 2020 6c6f 6767 6572 2e64 6562 7567 280a    logger.debug(.
-0002a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a610: 2020 2020 2252 6563 6569 7665 6420 7374      "Received st
-0002a620: 616c 6520 7461 736b 2072 756e 2c20 776f  ale task run, wo
-0002a630: 726b 6572 3a20 2573 2c20 6b65 793a 2025  rker: %s, key: %
-0002a640: 732c 2072 756e 5f69 643a 2025 6420 2825  s, run_id: %d (%
-0002a650: 6429 222c 0a20 2020 2020 2020 2020 2020  d)",.           
-0002a660: 2020 2020 2020 2020 2077 6f72 6b65 722c           worker,
-0002a670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a680: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
-0002a690: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-0002a6a0: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
-0002a6b0: 2020 2020 2020 2020 2020 7473 2e72 756e            ts.run
-0002a6c0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-0002a6d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002a6e0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-0002a6f0: 6773 5b77 6f72 6b65 725d 203d 205b 0a20  gs[worker] = [. 
-0002a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a710: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
-0002a720: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-0002a730: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
-0002a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a750: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-0002a760: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
-0002a770: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002a780: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-0002a790: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-0002a7a0: 2020 2020 2020 2020 2020 2020 2020 207d                 }
-0002a7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a7c0: 205d 0a20 2020 2020 2020 2020 2020 2065   ].            e
-0002a7d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002a7e0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002a7f0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-0002a800: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
-0002a810: 2020 656c 6966 2074 732e 7374 6174 6520    elif ts.state 
-0002a820: 3d3d 2022 6d65 6d6f 7279 223a 0a20 2020  == "memory":.   
-0002a830: 2020 2020 2020 2020 2073 656c 662e 6164           self.ad
-0002a840: 645f 6b65 7973 2877 6f72 6b65 723d 776f  d_keys(worker=wo
-0002a850: 726b 6572 2c20 6b65 7973 3d5b 6b65 795d  rker, keys=[key]
-0002a860: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0002a870: 2020 2020 2020 2020 2020 2020 7473 2e6d              ts.m
-0002a880: 6574 6164 6174 612e 7570 6461 7465 286b  etadata.update(k
-0002a890: 7761 7267 735b 226d 6574 6164 6174 6122  wargs["metadata"
-0002a8a0: 5d29 0a20 2020 2020 2020 2020 2020 2072  ]).            r
-0002a8b0: 3a20 7475 706c 6520 3d20 7365 6c66 2e5f  : tuple = self._
-0002a8c0: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
-0002a8d0: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
-0002a8e0: 2022 6d65 6d6f 7279 222c 2073 7469 6d75   "memory", stimu
-0002a8f0: 6c75 735f 6964 2c20 776f 726b 6572 3d77  lus_id, worker=w
-0002a900: 6f72 6b65 722c 202a 2a6b 7761 7267 730a  orker, **kwargs.
-0002a910: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002a920: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0002a930: 656e 6461 7469 6f6e 732c 2063 6c69 656e  endations, clien
-0002a940: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-0002a950: 7367 7320 3d20 720a 0a20 2020 2020 2020  sgs = r..       
-0002a960: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-0002a970: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
-0002a980: 2020 2020 2020 2020 2020 2020 2020 6173                as
-0002a990: 7365 7274 2077 7320 696e 2074 732e 7768  sert ws in ts.wh
-0002a9a0: 6f5f 6861 730a 2020 2020 2020 2020 7265  o_has.        re
-0002a9b0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
-0002a9c0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-0002a9d0: 732c 2077 6f72 6b65 725f 6d73 6773 0a0a  s, worker_msgs..
-0002a9e0: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
-0002a9f0: 5f74 6173 6b5f 6572 7265 6428 0a20 2020  _task_erred(.   
-0002aa00: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0002aa10: 2020 206b 6579 3d4e 6f6e 652c 0a20 2020     key=None,.   
-0002aa20: 2020 2020 2077 6f72 6b65 723d 4e6f 6e65       worker=None
-0002aa30: 2c0a 2020 2020 2020 2020 6578 6365 7074  ,.        except
-0002aa40: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
-0002aa50: 2020 7374 696d 756c 7573 5f69 643d 4e6f    stimulus_id=No
-0002aa60: 6e65 2c0a 2020 2020 2020 2020 7472 6163  ne,.        trac
-0002aa70: 6562 6163 6b3d 4e6f 6e65 2c0a 2020 2020  eback=None,.    
-0002aa80: 2020 2020 7275 6e5f 6964 3d4e 6f6e 652c      run_id=None,
-0002aa90: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-0002aaa0: 732c 0a20 2020 2029 3a0a 2020 2020 2020  s,.    ):.      
-0002aab0: 2020 2222 224d 6172 6b20 7468 6174 2061    """Mark that a
-0002aac0: 2074 6173 6b20 6861 7320 6572 7265 6420   task has erred 
-0002aad0: 6f6e 2061 2070 6172 7469 6375 6c61 7220  on a particular 
-0002aae0: 776f 726b 6572 2222 220a 2020 2020 2020  worker""".      
-0002aaf0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0002ab00: 5374 696d 756c 7573 2074 6173 6b20 6572  Stimulus task er
-0002ab10: 7265 6420 2573 2c20 2573 222c 206b 6579  red %s, %s", key
-0002ab20: 2c20 776f 726b 6572 290a 0a20 2020 2020  , worker)..     
-0002ab30: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-0002ab40: 203d 2073 656c 662e 7461 736b 732e 6765   = self.tasks.ge
-0002ab50: 7428 6b65 7929 0a20 2020 2020 2020 2069  t(key).        i
-0002ab60: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
-0002ab70: 7473 2e73 7461 7465 2021 3d20 2270 726f  ts.state != "pro
-0002ab80: 6365 7373 696e 6722 3a0a 2020 2020 2020  cessing":.      
-0002ab90: 2020 2020 2020 7265 7475 726e 207b 7d2c        return {},
-0002aba0: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
-0002abb0: 2069 6620 7473 2e72 756e 5f69 6420 213d   if ts.run_id !=
-0002abc0: 2072 756e 5f69 643a 0a20 2020 2020 2020   run_id:.       
-0002abd0: 2020 2020 2069 6620 7473 2e70 726f 6365       if ts.proce
-0002abe0: 7373 696e 675f 6f6e 2061 6e64 2074 732e  ssing_on and ts.
-0002abf0: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6164  processing_on.ad
-0002ac00: 6472 6573 7320 3d3d 2077 6f72 6b65 723a  dress == worker:
-0002ac10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ac20: 2072 6574 7572 6e20 7365 6c66 2e5f 7472   return self._tr
-0002ac30: 616e 7369 7469 6f6e 286b 6579 2c20 2272  ansition(key, "r
-0002ac40: 656c 6561 7365 6422 2c20 7374 696d 756c  eleased", stimul
-0002ac50: 7573 5f69 6429 0a20 2020 2020 2020 2020  us_id).         
-0002ac60: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
-0002ac70: 2c20 7b7d 0a0a 2020 2020 2020 2020 6966  , {}..        if
-0002ac80: 2074 732e 7265 7472 6965 7320 3e20 303a   ts.retries > 0:
-0002ac90: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
-0002aca0: 7265 7472 6965 7320 2d3d 2031 0a20 2020  retries -= 1.   
-0002acb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0002acc0: 7365 6c66 2e5f 7472 616e 7369 7469 6f6e  self._transition
-0002acd0: 286b 6579 2c20 2277 6169 7469 6e67 222c  (key, "waiting",
-0002ace0: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
-0002acf0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002ad00: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0002ad10: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
-0002ad20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ad30: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
-0002ad40: 2020 2020 2020 2265 7272 6564 222c 0a20        "erred",. 
-0002ad50: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002ad60: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
-0002ad70: 2020 2020 2020 2020 2020 2020 6361 7573              caus
-0002ad80: 653d 6b65 792c 0a20 2020 2020 2020 2020  e=key,.         
-0002ad90: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0002ada0: 3d65 7863 6570 7469 6f6e 2c0a 2020 2020  =exception,.    
-0002adb0: 2020 2020 2020 2020 2020 2020 7472 6163              trac
-0002adc0: 6562 6163 6b3d 7472 6163 6562 6163 6b2c  eback=traceback,
-0002add0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002ade0: 2077 6f72 6b65 723d 776f 726b 6572 2c0a   worker=worker,.
-0002adf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ae00: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-0002ae10: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0002ae20: 2073 7469 6d75 6c75 735f 7265 7472 7928   stimulus_retry(
-0002ae30: 7365 6c66 2c20 6b65 7973 2c20 636c 6965  self, keys, clie
-0002ae40: 6e74 3d4e 6f6e 6529 3a0a 2020 2020 2020  nt=None):.      
-0002ae50: 2020 6c6f 6767 6572 2e69 6e66 6f28 2243    logger.info("C
-0002ae60: 6c69 656e 7420 2573 2072 6571 7565 7374  lient %s request
-0002ae70: 7320 746f 2072 6574 7279 2025 6420 6b65  s to retry %d ke
-0002ae80: 7973 222c 2063 6c69 656e 742c 206c 656e  ys", client, len
-0002ae90: 286b 6579 7329 290a 2020 2020 2020 2020  (keys)).        
-0002aea0: 6966 2063 6c69 656e 743a 0a20 2020 2020  if client:.     
-0002aeb0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-0002aec0: 6576 656e 7428 636c 6965 6e74 2c20 7b22  event(client, {"
-0002aed0: 6163 7469 6f6e 223a 2022 7265 7472 7922  action": "retry"
-0002aee0: 2c20 2263 6f75 6e74 223a 206c 656e 286b  , "count": len(k
-0002aef0: 6579 7329 7d29 0a0a 2020 2020 2020 2020  eys)})..        
-0002af00: 7374 6163 6b20 3d20 6c69 7374 286b 6579  stack = list(key
-0002af10: 7329 0a20 2020 2020 2020 2073 6565 6e20  s).        seen 
-0002af20: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0002af30: 726f 6f74 7320 3d20 5b5d 0a20 2020 2020  roots = [].     
-0002af40: 2020 2077 6869 6c65 2073 7461 636b 3a0a     while stack:.
-0002af50: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
-0002af60: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
-0002af70: 2020 2020 2020 2020 2020 7365 656e 2e61            seen.a
-0002af80: 6464 286b 6579 290a 2020 2020 2020 2020  dd(key).        
-0002af90: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-0002afa0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-0002afb0: 2020 2020 2065 7272 6564 5f64 6570 7320       erred_deps 
-0002afc0: 3d20 5b64 7473 2e6b 6579 2066 6f72 2064  = [dts.key for d
-0002afd0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-0002afe0: 6e63 6965 7320 6966 2064 7473 2e73 7461  ncies if dts.sta
-0002aff0: 7465 203d 3d20 2265 7272 6564 225d 0a20  te == "erred"]. 
-0002b000: 2020 2020 2020 2020 2020 2069 6620 6572             if er
-0002b010: 7265 645f 6465 7073 3a0a 2020 2020 2020  red_deps:.      
-0002b020: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
-0002b030: 6578 7465 6e64 2865 7272 6564 5f64 6570  extend(erred_dep
-0002b040: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-0002b050: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002b060: 2020 2020 2072 6f6f 7473 2e61 7070 656e       roots.appen
-0002b070: 6428 6b65 7929 0a0a 2020 2020 2020 2020  d(key)..        
-0002b080: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-0002b090: 2052 6563 7320 3d20 7b6b 6579 3a20 2277   Recs = {key: "w
-0002b0a0: 6169 7469 6e67 2220 666f 7220 6b65 7920  aiting" for key 
-0002b0b0: 696e 2072 6f6f 7473 7d0a 2020 2020 2020  in roots}.      
-0002b0c0: 2020 7365 6c66 2e74 7261 6e73 6974 696f    self.transitio
-0002b0d0: 6e73 2872 6563 6f6d 6d65 6e64 6174 696f  ns(recommendatio
-0002b0e0: 6e73 2c20 6622 7374 696d 756c 7573 2d72  ns, f"stimulus-r
-0002b0f0: 6574 7279 2d7b 7469 6d65 2829 7d22 290a  etry-{time()}").
-0002b100: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0002b110: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0002b120: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-0002b130: 6e20 7365 656e 3a0a 2020 2020 2020 2020  n seen:.        
-0002b140: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0002b150: 6f74 2073 656c 662e 7461 736b 735b 6b65  ot self.tasks[ke
-0002b160: 795d 2e65 7863 6570 7469 6f6e 5f62 6c61  y].exception_bla
-0002b170: 6d65 0a0a 2020 2020 2020 2020 7265 7475  me..        retu
-0002b180: 726e 2074 7570 6c65 2873 6565 6e29 0a0a  rn tuple(seen)..
-0002b190: 2020 2020 6465 6620 636c 6f73 655f 776f      def close_wo
-0002b1a0: 726b 6572 2873 656c 662c 2077 6f72 6b65  rker(self, worke
-0002b1b0: 723a 2073 7472 2920 2d3e 204e 6f6e 653a  r: str) -> None:
-0002b1c0: 0a20 2020 2020 2020 2022 2222 4173 6b20  .        """Ask 
-0002b1d0: 6120 776f 726b 6572 2074 6f20 7368 7574  a worker to shut
-0002b1e0: 2069 7473 656c 6620 646f 776e 2e20 446f   itself down. Do
-0002b1f0: 206e 6f74 2077 6169 7420 666f 7220 6974   not wait for it
-0002b200: 2074 6f20 7461 6b65 2065 6666 6563 742e   to take effect.
-0002b210: 0a20 2020 2020 2020 204e 6f74 6520 7468  .        Note th
-0002b220: 6174 2074 6865 7265 2069 7320 6e6f 2067  at there is no g
-0002b230: 7561 7261 6e74 6565 2074 6861 7420 7468  uarantee that th
-0002b240: 6520 776f 726b 6572 2077 696c 6c20 6163  e worker will ac
-0002b250: 7475 616c 6c79 2061 6363 6570 7420 7468  tually accept th
-0002b260: 650a 2020 2020 2020 2020 636f 6d6d 616e  e.        comman
-0002b270: 642e 0a0a 2020 2020 2020 2020 4e6f 7465  d...        Note
-0002b280: 2074 6861 7420 3a6d 6574 683a 6072 656d   that :meth:`rem
-0002b290: 6f76 655f 776f 726b 6572 6020 7365 6e64  ove_worker` send
-0002b2a0: 7320 7468 6520 7361 6d65 2063 6f6d 6d61  s the same comma
-0002b2b0: 6e64 2069 6e74 6572 6e61 6c6c 7920 6966  nd internally if
-0002b2c0: 2063 6c6f 7365 3d54 7275 652e 0a0a 2020   close=True...  
-0002b2d0: 2020 2020 2020 5365 6520 616c 736f 0a20        See also. 
-0002b2e0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
-0002b2f0: 2020 2020 2020 2020 7265 7469 7265 5f77          retire_w
-0002b300: 6f72 6b65 7273 0a20 2020 2020 2020 2072  orkers.        r
-0002b310: 656d 6f76 655f 776f 726b 6572 0a20 2020  emove_worker.   
-0002b320: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0002b330: 2069 6620 776f 726b 6572 206e 6f74 2069   if worker not i
-0002b340: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a0a  n self.workers:.
-0002b350: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0002b360: 726e 0a0a 2020 2020 2020 2020 6c6f 6767  rn..        logg
-0002b370: 6572 2e69 6e66 6f28 2243 6c6f 7369 6e67  er.info("Closing
-0002b380: 2077 6f72 6b65 7220 2573 222c 2077 6f72   worker %s", wor
-0002b390: 6b65 7229 0a20 2020 2020 2020 2073 656c  ker).        sel
-0002b3a0: 662e 6c6f 675f 6576 656e 7428 776f 726b  f.log_event(work
-0002b3b0: 6572 2c20 7b22 6163 7469 6f6e 223a 2022  er, {"action": "
-0002b3c0: 636c 6f73 652d 776f 726b 6572 227d 290a  close-worker"}).
-0002b3d0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
-0002b3e0: 6b65 725f 7365 6e64 2877 6f72 6b65 722c  ker_send(worker,
-0002b3f0: 207b 226f 7022 3a20 2263 6c6f 7365 222c   {"op": "close",
-0002b400: 2022 7265 6173 6f6e 223a 2022 7363 6865   "reason": "sche
-0002b410: 6475 6c65 722d 636c 6f73 652d 776f 726b  duler-close-work
-0002b420: 6572 227d 290a 0a20 2020 2040 6c6f 675f  er"})..    @log_
-0002b430: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-0002b440: 2064 6566 2072 656d 6f76 655f 776f 726b   def remove_work
-0002b450: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
-0002b460: 2c20 6164 6472 6573 733a 2073 7472 2c20  , address: str, 
-0002b470: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
-0002b480: 7374 722c 2073 6166 653a 2062 6f6f 6c20  str, safe: bool 
-0002b490: 3d20 4661 6c73 652c 2063 6c6f 7365 3a20  = False, close: 
-0002b4a0: 626f 6f6c 203d 2054 7275 650a 2020 2020  bool = True.    
-0002b4b0: 2920 2d3e 204c 6974 6572 616c 5b22 4f4b  ) -> Literal["OK
-0002b4c0: 222c 2022 616c 7265 6164 792d 7265 6d6f  ", "already-remo
-0002b4d0: 7665 6422 5d3a 0a20 2020 2020 2020 2022  ved"]:.        "
-0002b4e0: 2222 5265 6d6f 7665 2077 6f72 6b65 7220  ""Remove worker 
-0002b4f0: 6672 6f6d 2063 6c75 7374 6572 2e0a 0a20  from cluster... 
-0002b500: 2020 2020 2020 2057 6520 646f 2074 6869         We do thi
-0002b510: 7320 7768 656e 2061 2077 6f72 6b65 7220  s when a worker 
-0002b520: 7265 706f 7274 7320 7468 6174 2069 7420  reports that it 
-0002b530: 706c 616e 7320 746f 206c 6561 7665 206f  plans to leave o
-0002b540: 7220 7768 656e 2069 7420 6170 7065 6172  r when it appear
-0002b550: 7320 746f 2062 650a 2020 2020 2020 2020  s to be.        
-0002b560: 756e 7265 7370 6f6e 7369 7665 2e20 5468  unresponsive. Th
-0002b570: 6973 206d 6179 2073 656e 6420 6974 7320  is may send its 
-0002b580: 7461 736b 7320 6261 636b 2074 6f20 6120  tasks back to a 
-0002b590: 7265 6c65 6173 6564 2073 7461 7465 2e0a  released state..
-0002b5a0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-0002b5b0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-0002b5c0: 2d2d 0a20 2020 2020 2020 2072 6574 6972  --.        retir
-0002b5d0: 655f 776f 726b 6572 730a 2020 2020 2020  e_workers.      
-0002b5e0: 2020 636c 6f73 655f 776f 726b 6572 0a20    close_worker. 
-0002b5f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002b600: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
-0002b610: 7320 3d3d 2053 7461 7475 732e 636c 6f73  s == Status.clos
-0002b620: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0002b630: 7265 7475 726e 2022 616c 7265 6164 792d  return "already-
-0002b640: 7265 6d6f 7665 6422 0a0a 2020 2020 2020  removed"..      
-0002b650: 2020 6164 6472 6573 7320 3d20 7365 6c66    address = self
-0002b660: 2e63 6f65 7263 655f 6164 6472 6573 7328  .coerce_address(
-0002b670: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
-0002b680: 2020 6966 2061 6464 7265 7373 206e 6f74    if address not
-0002b690: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0002b6a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0002b6b0: 7475 726e 2022 616c 7265 6164 792d 7265  turn "already-re
-0002b6c0: 6d6f 7665 6422 0a0a 2020 2020 2020 2020  moved"..        
-0002b6d0: 686f 7374 203d 2067 6574 5f61 6464 7265  host = get_addre
-0002b6e0: 7373 5f68 6f73 7428 6164 6472 6573 7329  ss_host(address)
-0002b6f0: 0a0a 2020 2020 2020 2020 7773 3a20 576f  ..        ws: Wo
-0002b700: 726b 6572 5374 6174 6520 3d20 7365 6c66  rkerState = self
-0002b710: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
-0002b720: 5d0a 0a20 2020 2020 2020 2065 7665 6e74  ]..        event
-0002b730: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
-0002b740: 2020 2020 2022 6163 7469 6f6e 223a 2022       "action": "
-0002b750: 7265 6d6f 7665 2d77 6f72 6b65 7222 2c0a  remove-worker",.
-0002b760: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
-0002b770: 6365 7373 696e 672d 7461 736b 7322 3a20  cessing-tasks": 
-0002b780: 7b74 732e 6b65 7920 666f 7220 7473 2069  {ts.key for ts i
-0002b790: 6e20 7773 2e70 726f 6365 7373 696e 677d  n ws.processing}
-0002b7a0: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-0002b7b0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-0002b7c0: 6e74 2861 6464 7265 7373 2c20 6576 656e  nt(address, even
-0002b7d0: 745f 6d73 672e 636f 7079 2829 290a 2020  t_msg.copy()).  
-0002b7e0: 2020 2020 2020 6576 656e 745f 6d73 675b        event_msg[
-0002b7f0: 2277 6f72 6b65 7222 5d20 3d20 6164 6472  "worker"] = addr
-0002b800: 6573 730a 2020 2020 2020 2020 7365 6c66  ess.        self
-0002b810: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
-0002b820: 2c20 6576 656e 745f 6d73 6729 0a0a 2020  , event_msg)..  
-0002b830: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-0002b840: 6f28 2252 656d 6f76 6520 776f 726b 6572  o("Remove worker
-0002b850: 2025 7322 2c20 7773 290a 2020 2020 2020   %s", ws).      
-0002b860: 2020 6966 2063 6c6f 7365 3a0a 2020 2020    if close:.    
-0002b870: 2020 2020 2020 2020 7769 7468 2073 7570          with sup
-0002b880: 7072 6573 7328 4174 7472 6962 7574 6545  press(AttributeE
-0002b890: 7272 6f72 2c20 436f 6d6d 436c 6f73 6564  rror, CommClosed
-0002b8a0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-0002b8b0: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-0002b8c0: 6561 6d5f 636f 6d6d 735b 6164 6472 6573  eam_comms[addres
-0002b8d0: 735d 2e73 656e 6428 0a20 2020 2020 2020  s].send(.       
-0002b8e0: 2020 2020 2020 2020 2020 2020 207b 226f               {"o
-0002b8f0: 7022 3a20 2263 6c6f 7365 222c 2022 7265  p": "close", "re
-0002b900: 6173 6f6e 223a 2022 7363 6865 6475 6c65  ason": "schedule
-0002b910: 722d 7265 6d6f 7665 2d77 6f72 6b65 7222  r-remove-worker"
-0002b920: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0002b930: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0002b940: 662e 7265 6d6f 7665 5f72 6573 6f75 7263  f.remove_resourc
-0002b950: 6573 2861 6464 7265 7373 290a 0a20 2020  es(address)..   
-0002b960: 2020 2020 2064 683a 2064 6963 7420 3d20       dh: dict = 
-0002b970: 7365 6c66 2e68 6f73 745f 696e 666f 5b68  self.host_info[h
-0002b980: 6f73 745d 0a20 2020 2020 2020 2064 685f  ost].        dh_
-0002b990: 6164 6472 6573 7365 733a 2073 6574 203d  addresses: set =
-0002b9a0: 2064 685b 2261 6464 7265 7373 6573 225d   dh["addresses"]
-0002b9b0: 0a20 2020 2020 2020 2064 685f 6164 6472  .        dh_addr
-0002b9c0: 6573 7365 732e 7265 6d6f 7665 2861 6464  esses.remove(add
-0002b9d0: 7265 7373 290a 2020 2020 2020 2020 6468  ress).        dh
-0002b9e0: 5b22 6e74 6872 6561 6473 225d 202d 3d20  ["nthreads"] -= 
-0002b9f0: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
-0002ba00: 2020 2020 7365 6c66 2e74 6f74 616c 5f6e      self.total_n
-0002ba10: 7468 7265 6164 7320 2d3d 2077 732e 6e74  threads -= ws.nt
-0002ba20: 6872 6561 6473 0a20 2020 2020 2020 2073  hreads.        s
-0002ba30: 656c 662e 746f 7461 6c5f 6e74 6872 6561  elf.total_nthrea
-0002ba40: 6473 5f68 6973 746f 7279 2e61 7070 656e  ds_history.appen
-0002ba50: 6428 2874 696d 6528 292c 2073 656c 662e  d((time(), self.
-0002ba60: 746f 7461 6c5f 6e74 6872 6561 6473 2929  total_nthreads))
-0002ba70: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0002ba80: 6468 5f61 6464 7265 7373 6573 3a0a 2020  dh_addresses:.  
-0002ba90: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-0002baa0: 6c66 2e68 6f73 745f 696e 666f 5b68 6f73  lf.host_info[hos
-0002bab0: 745d 0a0a 2020 2020 2020 2020 7365 6c66  t]..        self
-0002bac0: 2e72 7063 2e72 656d 6f76 6528 6164 6472  .rpc.remove(addr
-0002bad0: 6573 7329 0a20 2020 2020 2020 2064 656c  ess).        del
-0002bae0: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
-0002baf0: 6d73 5b61 6464 7265 7373 5d0a 2020 2020  ms[address].    
-0002bb00: 2020 2020 6465 6c20 7365 6c66 2e61 6c69      del self.ali
-0002bb10: 6173 6573 5b77 732e 6e61 6d65 5d0a 2020  ases[ws.name].  
-0002bb20: 2020 2020 2020 7365 6c66 2e69 646c 652e        self.idle.
-0002bb30: 706f 7028 7773 2e61 6464 7265 7373 2c20  pop(ws.address, 
-0002bb40: 4e6f 6e65 290a 2020 2020 2020 2020 7365  None).        se
-0002bb50: 6c66 2e69 646c 655f 7461 736b 5f63 6f75  lf.idle_task_cou
-0002bb60: 6e74 2e64 6973 6361 7264 2877 7329 0a20  nt.discard(ws). 
-0002bb70: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
-0002bb80: 7261 7465 642e 6469 7363 6172 6428 7773  rated.discard(ws
-0002bb90: 290a 2020 2020 2020 2020 6465 6c20 7365  ).        del se
-0002bba0: 6c66 2e77 6f72 6b65 7273 5b61 6464 7265  lf.workers[addre
-0002bbb0: 7373 5d0a 2020 2020 2020 2020 7773 2e73  ss].        ws.s
-0002bbc0: 7461 7475 7320 3d20 5374 6174 7573 2e63  tatus = Status.c
-0002bbd0: 6c6f 7365 640a 2020 2020 2020 2020 7365  losed.        se
-0002bbe0: 6c66 2e72 756e 6e69 6e67 2e64 6973 6361  lf.running.disca
-0002bbf0: 7264 2877 7329 0a0a 2020 2020 2020 2020  rd(ws)..        
-0002bc00: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-0002bc10: 2052 6563 7320 3d20 7b7d 0a0a 2020 2020   Recs = {}..    
-0002bc20: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
-0002bc30: 650a 2020 2020 2020 2020 666f 7220 7473  e.        for ts
-0002bc40: 2069 6e20 6c69 7374 2877 732e 7072 6f63   in list(ws.proc
-0002bc50: 6573 7369 6e67 293a 0a20 2020 2020 2020  essing):.       
-0002bc60: 2020 2020 206b 203d 2074 732e 6b65 790a       k = ts.key.
-0002bc70: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0002bc80: 6d6d 656e 6461 7469 6f6e 735b 6b5d 203d  mmendations[k] =
-0002bc90: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
-0002bca0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0002bcb0: 6166 653a 0a20 2020 2020 2020 2020 2020  afe:.           
-0002bcc0: 2020 2020 2074 732e 7375 7370 6963 696f       ts.suspicio
-0002bcd0: 7573 202b 3d20 310a 2020 2020 2020 2020  us += 1.        
-0002bce0: 2020 2020 2020 2020 7473 2e70 7265 6669          ts.prefi
-0002bcf0: 782e 7375 7370 6963 696f 7573 202b 3d20  x.suspicious += 
-0002bd00: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-0002bd10: 2020 6966 2074 732e 7375 7370 6963 696f    if ts.suspicio
-0002bd20: 7573 203e 2073 656c 662e 616c 6c6f 7765  us > self.allowe
-0002bd30: 645f 6661 696c 7572 6573 3a0a 2020 2020  d_failures:.    
-0002bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd50: 6465 6c20 7265 636f 6d6d 656e 6461 7469  del recommendati
-0002bd60: 6f6e 735b 6b5d 0a20 2020 2020 2020 2020  ons[k].         
-0002bd70: 2020 2020 2020 2020 2020 2065 203d 2070             e = p
-0002bd80: 6963 6b6c 652e 6475 6d70 7328 0a20 2020  ickle.dumps(.   
-0002bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bda0: 2020 2020 204b 696c 6c65 6457 6f72 6b65       KilledWorke
-0002bdb0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-0002bdc0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002bdd0: 6173 6b3d 6b2c 0a20 2020 2020 2020 2020  ask=k,.         
-0002bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bdf0: 2020 206c 6173 745f 776f 726b 6572 3d77     last_worker=w
-0002be00: 732e 636c 6561 6e28 292c 0a20 2020 2020  s.clean(),.     
+00029360: 2020 2020 2020 2069 6620 6465 7020 696e         if dep in
+00029370: 2073 656c 662e 7461 736b 7320 616e 6420   self.tasks and 
+00029380: 6465 7020 6e6f 7420 696e 2064 6f6e 653a  dep not in done:
+00029390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000293a0: 2020 2020 2020 2020 2020 2020 2064 6f6e               don
+000293b0: 652e 6164 6428 6465 7029 0a20 2020 2020  e.add(dep).     
+000293c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293d0: 2020 2020 2020 2073 7461 636b 2e61 7070         stack.app
+000293e0: 656e 6428 6465 7029 0a20 2020 2020 2020  end(dep).       
+000293f0: 2066 6f72 2061 6e63 2069 6e20 646f 6e65   for anc in done
+00029400: 3a0a 2020 2020 2020 2020 2020 2020 6473  :.            ds
+00029410: 6b2e 706f 7028 616e 632c 204e 6f6e 6529  k.pop(anc, None)
+00029420: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
+00029430: 656e 6465 6e63 6965 732e 706f 7028 616e  endencies.pop(an
+00029440: 632c 204e 6f6e 6529 0a20 2020 2020 2020  c, None).       
+00029450: 2072 6574 7572 6e20 646f 6e65 0a0a 2020   return done..  
+00029460: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
+00029470: 2020 2020 6465 6620 6d61 7465 7269 616c      def material
+00029480: 697a 655f 6772 6170 6828 686c 673a 2048  ize_graph(hlg: H
+00029490: 6967 684c 6576 656c 4772 6170 6829 202d  ighLevelGraph) -
+000294a0: 3e20 7475 706c 655b 6469 6374 2c20 6469  > tuple[dict, di
+000294b0: 6374 2c20 6469 6374 2c20 6469 6374 5d3a  ct, dict, dict]:
+000294c0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+000294d0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
+000294e0: 2069 6d70 6f72 7420 6475 6d70 735f 7461   import dumps_ta
+000294f0: 736b 0a0a 2020 2020 2020 2020 6b65 795f  sk..        key_
+00029500: 616e 6e6f 7461 7469 6f6e 7320 3d20 7b7d  annotations = {}
+00029510: 0a20 2020 2020 2020 2064 736b 203d 2064  .        dsk = d
+00029520: 6173 6b2e 7574 696c 732e 656e 7375 7265  ask.utils.ensure
+00029530: 5f64 6963 7428 686c 6729 0a0a 2020 2020  _dict(hlg)..    
+00029540: 2020 2020 666f 7220 6c61 7965 7220 696e      for layer in
+00029550: 2068 6c67 2e6c 6179 6572 732e 7661 6c75   hlg.layers.valu
+00029560: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+00029570: 2020 6966 206c 6179 6572 2e61 6e6e 6f74    if layer.annot
+00029580: 6174 696f 6e73 3a0a 2020 2020 2020 2020  ations:.        
+00029590: 2020 2020 2020 2020 616e 6e6f 7420 3d20          annot = 
+000295a0: 6c61 7965 722e 616e 6e6f 7461 7469 6f6e  layer.annotation
+000295b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000295c0: 2020 6b65 795f 616e 6e6f 7461 7469 6f6e    key_annotation
+000295d0: 732e 7570 6461 7465 287b 7374 7269 6e67  s.update({string
+000295e0: 6966 7928 6b29 3a20 616e 6e6f 7420 666f  ify(k): annot fo
+000295f0: 7220 6b20 696e 206c 6179 6572 7d29 0a0a  r k in layer})..
+00029600: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+00029610: 6369 6573 2c20 5f20 3d20 6765 745f 6465  cies, _ = get_de
+00029620: 7073 2864 736b 290a 0a20 2020 2020 2020  ps(dsk)..       
+00029630: 2023 2052 656d 6f76 6520 6046 7574 7572   # Remove `Futur
+00029640: 6560 206f 626a 6563 7473 2066 726f 6d20  e` objects from 
+00029650: 6772 6170 6820 616e 6420 6e6f 7465 2061  graph and note a
+00029660: 6e79 2066 7574 7572 6520 6465 7065 6e64  ny future depend
+00029670: 656e 6369 6573 0a20 2020 2020 2020 2064  encies.        d
+00029680: 736b 3220 3d20 7b7d 0a20 2020 2020 2020  sk2 = {}.       
+00029690: 2066 7574 5f64 6570 7320 3d20 7b7d 0a20   fut_deps = {}. 
+000296a0: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
+000296b0: 696e 2064 736b 2e69 7465 6d73 2829 3a0a  in dsk.items():.
+000296c0: 2020 2020 2020 2020 2020 2020 6473 6b32              dsk2
+000296d0: 5b6b 5d2c 2066 7574 7320 3d20 756e 7061  [k], futs = unpa
+000296e0: 636b 5f72 656d 6f74 6564 6174 6128 762c  ck_remotedata(v,
+000296f0: 2062 7974 655f 6b65 7973 3d54 7275 6529   byte_keys=True)
+00029700: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00029710: 6675 7473 3a0a 2020 2020 2020 2020 2020  futs:.          
+00029720: 2020 2020 2020 6675 745f 6465 7073 5b6b        fut_deps[k
+00029730: 5d20 3d20 6675 7473 0a20 2020 2020 2020  ] = futs.       
+00029740: 2064 736b 203d 2064 736b 320a 0a20 2020   dsk = dsk2..   
+00029750: 2020 2020 2023 202d 2041 6464 2069 6e20       # - Add in 
+00029760: 6465 7073 2066 6f72 2061 6e79 2074 6173  deps for any tas
+00029770: 6b73 2074 6861 7420 6465 7065 6e64 206f  ks that depend o
+00029780: 6e20 6675 7475 7265 730a 2020 2020 2020  n futures.      
+00029790: 2020 666f 7220 6b2c 2066 7574 7572 6573    for k, futures
+000297a0: 2069 6e20 6675 745f 6465 7073 2e69 7465   in fut_deps.ite
+000297b0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+000297c0: 2020 6465 7065 6e64 656e 6369 6573 5b6b    dependencies[k
+000297d0: 5d2e 7570 6461 7465 2866 2e6b 6579 2066  ].update(f.key f
+000297e0: 6f72 2066 2069 6e20 6675 7475 7265 7329  or f in futures)
+000297f0: 0a20 2020 2020 2020 206e 6577 5f64 736b  .        new_dsk
+00029800: 203d 207b 7d0a 2020 2020 2020 2020 2320   = {}.        # 
+00029810: 416e 6e6f 7461 7469 6f6e 2063 616c 6c61  Annotation calla
+00029820: 626c 6573 2061 7265 2065 7661 6c75 6174  bles are evaluat
+00029830: 6564 206f 6e20 7468 6520 6e6f 6e2d 7374  ed on the non-st
+00029840: 7269 6e67 6966 6965 6420 7665 7273 696f  ringified versio
+00029850: 6e20 6f66 0a20 2020 2020 2020 2023 2074  n of.        # t
+00029860: 6865 206b 6579 730a 2020 2020 2020 2020  he keys.        
+00029870: 7072 655f 7374 7269 6e67 6966 6965 645f  pre_stringified_
+00029880: 6b65 7973 203d 207b 7d0a 2020 2020 2020  keys = {}.      
+00029890: 2020 6578 636c 7573 6976 6520 3d20 7365    exclusive = se
+000298a0: 7428 686c 6729 0a20 2020 2020 2020 2066  t(hlg).        f
+000298b0: 6f72 206b 2c20 7620 696e 2064 736b 2e69  or k, v in dsk.i
+000298c0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+000298d0: 2020 2020 6e65 775f 6b20 3d20 7374 7269      new_k = stri
+000298e0: 6e67 6966 7928 6b29 0a20 2020 2020 2020  ngify(k).       
+000298f0: 2020 2020 2070 7265 5f73 7472 696e 6769       pre_stringi
+00029900: 6669 6564 5f6b 6579 735b 6e65 775f 6b5d  fied_keys[new_k]
+00029910: 203d 206b 0a20 2020 2020 2020 2020 2020   = k.           
+00029920: 206e 6577 5f64 736b 5b6e 6577 5f6b 5d20   new_dsk[new_k] 
+00029930: 3d20 7374 7269 6e67 6966 7928 762c 2065  = stringify(v, e
+00029940: 7863 6c75 7369 7665 3d65 7863 6c75 7369  xclusive=exclusi
+00029950: 7665 290a 2020 2020 2020 2020 6173 7365  ve).        asse
+00029960: 7274 206c 656e 286e 6577 5f64 736b 2920  rt len(new_dsk) 
+00029970: 3d3d 206c 656e 2870 7265 5f73 7472 696e  == len(pre_strin
+00029980: 6769 6669 6564 5f6b 6579 7329 0a20 2020  gified_keys).   
+00029990: 2020 2020 2064 736b 203d 206e 6577 5f64       dsk = new_d
+000299a0: 736b 0a20 2020 2020 2020 2064 6570 656e  sk.        depen
+000299b0: 6465 6e63 6965 7320 3d20 7b0a 2020 2020  dencies = {.    
+000299c0: 2020 2020 2020 2020 7374 7269 6e67 6966          stringif
+000299d0: 7928 6b29 3a20 7b73 7472 696e 6769 6679  y(k): {stringify
+000299e0: 2864 6570 2920 666f 7220 6465 7020 696e  (dep) for dep in
+000299f0: 2064 6570 737d 0a20 2020 2020 2020 2020   deps}.         
+00029a00: 2020 2066 6f72 206b 2c20 6465 7073 2069     for k, deps i
+00029a10: 6e20 6465 7065 6e64 656e 6369 6573 2e69  n dependencies.i
+00029a20: 7465 6d73 2829 0a20 2020 2020 2020 207d  tems().        }
+00029a30: 0a0a 2020 2020 2020 2020 2320 5265 6d6f  ..        # Remo
+00029a40: 7665 2061 6e79 2073 656c 662d 6465 7065  ve any self-depe
+00029a50: 6e64 656e 6369 6573 2028 6861 7070 656e  ndencies (happen
+00029a60: 7320 6f6e 2074 6573 745f 7075 626c 6973  s on test_publis
+00029a70: 685f 6261 6728 2920 616e 6420 6f74 6865  h_bag() and othe
+00029a80: 7273 290a 2020 2020 2020 2020 666f 7220  rs).        for 
+00029a90: 6b2c 2076 2069 6e20 6465 7065 6e64 656e  k, v in dependen
+00029aa0: 6369 6573 2e69 7465 6d73 2829 3a0a 2020  cies.items():.  
+00029ab0: 2020 2020 2020 2020 2020 6465 7073 203d            deps =
+00029ac0: 2073 6574 2876 290a 2020 2020 2020 2020   set(v).        
+00029ad0: 2020 2020 6966 206b 2069 6e20 6465 7073      if k in deps
+00029ae0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00029af0: 2020 6465 7073 2e72 656d 6f76 6528 6b29    deps.remove(k)
+00029b00: 0a20 2020 2020 2020 2020 2020 2064 6570  .            dep
+00029b10: 656e 6465 6e63 6965 735b 6b5d 203d 2064  endencies[k] = d
+00029b20: 6570 730a 0a20 2020 2020 2020 2023 2052  eps..        # R
+00029b30: 656d 6f76 6520 616c 6961 7365 730a 2020  emove aliases.  
+00029b40: 2020 2020 2020 666f 7220 6b20 696e 206c        for k in l
+00029b50: 6973 7428 6473 6b29 3a0a 2020 2020 2020  ist(dsk):.      
+00029b60: 2020 2020 2020 6966 2064 736b 5b6b 5d20        if dsk[k] 
+00029b70: 6973 206b 3a0a 2020 2020 2020 2020 2020  is k:.          
+00029b80: 2020 2020 2020 6465 6c20 6473 6b5b 6b5d        del dsk[k]
+00029b90: 0a20 2020 2020 2020 2064 736b 203d 2076  .        dsk = v
+00029ba0: 616c 6d61 7028 6475 6d70 735f 7461 736b  almap(dumps_task
+00029bb0: 2c20 6473 6b29 0a20 2020 2020 2020 2072  , dsk).        r
+00029bc0: 6574 7572 6e20 6473 6b2c 2064 6570 656e  eturn dsk, depen
+00029bd0: 6465 6e63 6965 732c 206b 6579 5f61 6e6e  dencies, key_ann
+00029be0: 6f74 6174 696f 6e73 2c20 7072 655f 7374  otations, pre_st
+00029bf0: 7269 6e67 6966 6965 645f 6b65 7973 0a0a  ringified_keys..
+00029c00: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
+00029c10: 5f71 7565 7565 5f73 6c6f 7473 5f6d 6179  _queue_slots_may
+00029c20: 6265 5f6f 7065 6e65 6428 7365 6c66 2c20  be_opened(self, 
+00029c30: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
+00029c40: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
+00029c50: 2020 2020 2020 2222 2252 6573 706f 6e64        """Respond
+00029c60: 2074 6f20 616e 2065 7665 6e74 2077 6869   to an event whi
+00029c70: 6368 206d 6179 2068 6176 6520 6f70 656e  ch may have open
+00029c80: 6564 2073 706f 7473 206f 6e20 776f 726b  ed spots on work
+00029c90: 6572 2074 6872 6561 6470 6f6f 6c73 0a0a  er threadpools..
+00029ca0: 2020 2020 2020 2020 5365 6c65 6374 7320          Selects 
+00029cb0: 7468 6520 6170 7072 6f70 7269 6174 6520  the appropriate 
+00029cc0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
+00029cd0: 6672 6f6d 2074 6865 2066 726f 6e74 206f  from the front o
+00029ce0: 6620 7468 6520 7175 6575 6520 6163 636f  f the queue acco
+00029cf0: 7264 696e 6720 746f 0a20 2020 2020 2020  rding to.       
+00029d00: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
+00029d10: 7220 6f66 2074 6173 6b20 736c 6f74 7320  r of task slots 
+00029d20: 6176 6169 6c61 626c 6520 6f6e 2077 6f72  available on wor
+00029d30: 6b65 7273 2028 706f 7465 6e74 6961 6c6c  kers (potentiall
+00029d40: 7920 3029 2c20 616e 640a 2020 2020 2020  y 0), and.      
+00029d50: 2020 7472 616e 7369 7469 6f6e 7320 7468    transitions th
+00029d60: 656d 2074 6f20 6060 7072 6f63 6573 7369  em to ``processi
+00029d70: 6e67 6060 2e0a 0a20 2020 2020 2020 204e  ng``...        N
+00029d80: 6f74 6573 0a20 2020 2020 2020 202d 2d2d  otes.        ---
+00029d90: 2d2d 0a20 2020 2020 2020 204f 7468 6572  --.        Other
+00029da0: 2074 7261 6e73 6974 696f 6e73 2072 656c   transitions rel
+00029db0: 6174 6564 2074 6f20 7468 6973 2073 7469  ated to this sti
+00029dc0: 6d75 6c75 7320 7368 6f75 6c64 2062 6520  mulus should be 
+00029dd0: 6675 6c6c 7920 7072 6f63 6573 7365 6420  fully processed 
+00029de0: 6265 666f 7265 6861 6e64 2c0a 2020 2020  beforehand,.    
+00029df0: 2020 2020 736f 2061 6e79 2074 6173 6b73      so any tasks
+00029e00: 2074 6861 7420 6265 6361 6d65 2072 756e   that became run
+00029e10: 6e61 626c 6520 6172 6520 616c 7265 6164  nable are alread
+00029e20: 7920 696e 2060 6070 726f 6365 7373 696e  y in ``processin
+00029e30: 6760 602e 204f 7468 6572 7769 7365 2c0a  g``. Otherwise,.
+00029e40: 2020 2020 2020 2020 6f76 6572 7072 6f64          overprod
+00029e50: 7563 7469 6f6e 2063 616e 206f 6363 7572  uction can occur
+00029e60: 2069 6620 7175 6575 6564 2074 6173 6b73   if queued tasks
+00029e70: 2067 6574 2073 6368 6564 756c 6564 2062   get scheduled b
+00029e80: 6566 6f72 6520 646f 776e 7374 7265 616d  efore downstream
+00029e90: 2074 6173 6b73 2e0a 0a20 2020 2020 2020   tasks...       
+00029ea0: 204d 7573 7420 6265 2063 616c 6c65 6420   Must be called 
+00029eb0: 6166 7465 7220 6063 6865 636b 5f69 646c  after `check_idl
+00029ec0: 655f 7361 7475 7261 7465 6460 3b20 692e  e_saturated`; i.
+00029ed0: 652e 2060 6964 6c65 5f74 6173 6b5f 636f  e. `idle_task_co
+00029ee0: 756e 7460 206d 7573 7420 6265 2075 700a  unt` must be up.
+00029ef0: 2020 2020 2020 2020 746f 2064 6174 652e          to date.
+00029f00: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00029f10: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00029f20: 2e71 7565 7565 643a 0a20 2020 2020 2020  .queued:.       
+00029f30: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00029f40: 2020 2020 736c 6f74 735f 6176 6169 6c61      slots_availa
+00029f50: 626c 6520 3d20 7375 6d28 0a20 2020 2020  ble = sum(.     
+00029f60: 2020 2020 2020 205f 7461 736b 5f73 6c6f         _task_slo
+00029f70: 7473 5f61 7661 696c 6162 6c65 2877 732c  ts_available(ws,
+00029f80: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
+00029f90: 5552 4154 494f 4e29 0a20 2020 2020 2020  URATION).       
+00029fa0: 2020 2020 2066 6f72 2077 7320 696e 2073       for ws in s
+00029fb0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+00029fc0: 756e 740a 2020 2020 2020 2020 290a 2020  unt.        ).  
+00029fd0: 2020 2020 2020 6966 2073 6c6f 7473 5f61        if slots_a
+00029fe0: 7661 696c 6162 6c65 203d 3d20 303a 0a20  vailable == 0:. 
+00029ff0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0002a000: 6e0a 0a20 2020 2020 2020 2072 6563 6f6d  n..        recom
+0002a010: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0002a020: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
+0002a030: 7220 7174 7320 696e 2073 656c 662e 7175  r qts in self.qu
+0002a040: 6575 6564 2e70 6565 6b6e 2873 6c6f 7473  eued.peekn(slots
+0002a050: 5f61 7661 696c 6162 6c65 293a 0a20 2020  _available):.   
+0002a060: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0002a070: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
+0002a080: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002a090: 7420 7174 732e 7374 6174 6520 3d3d 2022  t qts.state == "
+0002a0a0: 7175 6575 6564 222c 2071 7473 2e73 7461  queued", qts.sta
+0002a0b0: 7465 0a20 2020 2020 2020 2020 2020 2020  te.             
+0002a0c0: 2020 2061 7373 6572 7420 6e6f 7420 7174     assert not qt
+0002a0d0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e2c  s.processing_on,
+0002a0e0: 2028 7174 732c 2071 7473 2e70 726f 6365   (qts, qts.proce
+0002a0f0: 7373 696e 675f 6f6e 290a 2020 2020 2020  ssing_on).      
+0002a100: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002a110: 206e 6f74 2071 7473 2e77 6169 7469 6e67   not qts.waiting
+0002a120: 5f6f 6e2c 2028 7174 732c 2071 7473 2e70  _on, (qts, qts.p
+0002a130: 726f 6365 7373 696e 675f 6f6e 290a 2020  rocessing_on).  
+0002a140: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002a150: 7365 7274 2071 7473 2e77 686f 5f77 616e  sert qts.who_wan
+0002a160: 7473 206f 7220 7174 732e 7761 6974 6572  ts or qts.waiter
+0002a170: 732c 2071 7473 0a20 2020 2020 2020 2020  s, qts.         
+0002a180: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002a190: 6e73 5b71 7473 2e6b 6579 5d20 3d20 2270  ns[qts.key] = "p
+0002a1a0: 726f 6365 7373 696e 6722 0a0a 2020 2020  rocessing"..    
+0002a1b0: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
+0002a1c0: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
+0002a1d0: 696f 6e73 2c20 7374 696d 756c 7573 5f69  ions, stimulus_i
+0002a1e0: 6429 0a0a 2020 2020 6465 6620 7374 696d  d)..    def stim
+0002a1f0: 756c 7573 5f74 6173 6b5f 6669 6e69 7368  ulus_task_finish
+0002a200: 6564 2873 656c 662c 206b 6579 2c20 776f  ed(self, key, wo
+0002a210: 726b 6572 2c20 7374 696d 756c 7573 5f69  rker, stimulus_i
+0002a220: 642c 2072 756e 5f69 642c 202a 2a6b 7761  d, run_id, **kwa
+0002a230: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
+0002a240: 224d 6172 6b20 7468 6174 2061 2074 6173  "Mark that a tas
+0002a250: 6b20 6861 7320 6669 6e69 7368 6564 2065  k has finished e
+0002a260: 7865 6375 7469 6f6e 206f 6e20 6120 7061  xecution on a pa
+0002a270: 7274 6963 756c 6172 2077 6f72 6b65 7222  rticular worker"
+0002a280: 2222 0a20 2020 2020 2020 206c 6f67 6765  "".        logge
+0002a290: 722e 6465 6275 6728 2253 7469 6d75 6c75  r.debug("Stimulu
+0002a2a0: 7320 7461 736b 2066 696e 6973 6865 6420  s task finished 
+0002a2b0: 2573 5b25 645d 2025 7322 2c20 6b65 792c  %s[%d] %s", key,
+0002a2c0: 2072 756e 5f69 642c 2077 6f72 6b65 7229   run_id, worker)
+0002a2d0: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
+0002a2e0: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+0002a2f0: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
+0002a300: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
+0002a310: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+0002a320: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+0002a330: 7b7d 0a0a 2020 2020 2020 2020 7773 3a20  {}..        ws: 
+0002a340: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
+0002a350: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
+0002a360: 725d 0a20 2020 2020 2020 2074 733a 2054  r].        ts: T
+0002a370: 6173 6b53 7461 7465 203d 2073 656c 662e  askState = self.
+0002a380: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
+0002a390: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
+0002a3a0: 4e6f 6e65 206f 7220 7473 2e73 7461 7465  None or ts.state
+0002a3b0: 2069 6e20 2822 7265 6c65 6173 6564 222c   in ("released",
+0002a3c0: 2022 7175 6575 6564 2229 3a0a 2020 2020   "queued"):.    
+0002a3d0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0002a3e0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0002a3f0: 2020 2020 2020 2252 6563 6569 7665 6420        "Received 
+0002a400: 616c 7265 6164 7920 636f 6d70 7574 6564  already computed
+0002a410: 2074 6173 6b2c 2077 6f72 6b65 723a 2025   task, worker: %
+0002a420: 732c 2073 7461 7465 3a20 2573 220a 2020  s, state: %s".  
+0002a430: 2020 2020 2020 2020 2020 2020 2020 222c                ",
+0002a440: 206b 6579 3a20 2573 2c20 7768 6f5f 6861   key: %s, who_ha
+0002a450: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
+0002a460: 2020 2020 2020 2020 776f 726b 6572 2c0a          worker,.
+0002a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a480: 7473 2e73 7461 7465 2069 6620 7473 2065  ts.state if ts e
+0002a490: 6c73 6520 2266 6f72 676f 7474 656e 222c  lse "forgotten",
+0002a4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a4b0: 206b 6579 2c0a 2020 2020 2020 2020 2020   key,.          
+0002a4c0: 2020 2020 2020 7473 2e77 686f 5f68 6173        ts.who_has
+0002a4d0: 2069 6620 7473 2065 6c73 6520 7b7d 2c0a   if ts else {},.
+0002a4e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002a4f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0002a500: 5f6d 7367 735b 776f 726b 6572 5d20 3d20  _msgs[worker] = 
+0002a510: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0002a520: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
+0002a530: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
+0002a540: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
+0002a550: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002a560: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
+0002a570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a580: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0002a590: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+0002a5b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0002a5c0: 2020 2020 2020 656c 6966 2074 732e 7275        elif ts.ru
+0002a5d0: 6e5f 6964 2021 3d20 7275 6e5f 6964 3a0a  n_id != run_id:.
+0002a5e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002a5f0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
+0002a600: 5f6f 6e20 6f72 2074 732e 7072 6f63 6573  _on or ts.proces
+0002a610: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
+0002a620: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
+0002a630: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002a640: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
+0002a650: 2020 2020 2020 2020 2020 2020 2022 5265               "Re
+0002a660: 6365 6976 6564 2073 7461 6c65 2074 6173  ceived stale tas
+0002a670: 6b20 7275 6e2c 2077 6f72 6b65 723a 2025  k run, worker: %
+0002a680: 732c 206b 6579 3a20 2573 2c20 7275 6e5f  s, key: %s, run_
+0002a690: 6964 3a20 2564 2028 2564 2922 2c0a 2020  id: %d (%d)",.  
+0002a6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6b0: 2020 776f 726b 6572 2c0a 2020 2020 2020    worker,.      
+0002a6c0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+0002a6d0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+0002a6e0: 2020 2020 2020 2072 756e 5f69 642c 0a20         run_id,. 
+0002a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a700: 2020 2074 732e 7275 6e5f 6964 2c0a 2020     ts.run_id,.  
+0002a710: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a730: 776f 726b 6572 5f6d 7367 735b 776f 726b  worker_msgs[work
+0002a740: 6572 5d20 3d20 5b0a 2020 2020 2020 2020  er] = [.        
+0002a750: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0002a760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a770: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
+0002a780: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
+0002a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7a0: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a7c0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0002a7d0: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+0002a7e0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0002a7f0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0002a800: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+0002a810: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002a820: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002a830: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
+0002a840: 2e6b 6579 5d20 3d20 2272 656c 6561 7365  .key] = "release
+0002a850: 6422 0a20 2020 2020 2020 2065 6c69 6620  d".        elif 
+0002a860: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
+0002a870: 6f72 7922 3a0a 2020 2020 2020 2020 2020  ory":.          
+0002a880: 2020 7365 6c66 2e61 6464 5f6b 6579 7328    self.add_keys(
+0002a890: 776f 726b 6572 3d77 6f72 6b65 722c 206b  worker=worker, k
+0002a8a0: 6579 733d 5b6b 6579 5d29 0a20 2020 2020  eys=[key]).     
+0002a8b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002a8c0: 2020 2020 2074 732e 6d65 7461 6461 7461       ts.metadata
+0002a8d0: 2e75 7064 6174 6528 6b77 6172 6773 5b22  .update(kwargs["
+0002a8e0: 6d65 7461 6461 7461 225d 290a 2020 2020  metadata"]).    
+0002a8f0: 2020 2020 2020 2020 723a 2074 7570 6c65          r: tuple
+0002a900: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
+0002a910: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+0002a920: 2020 2020 206b 6579 2c20 226d 656d 6f72       key, "memor
+0002a930: 7922 2c20 7374 696d 756c 7573 5f69 642c  y", stimulus_id,
+0002a940: 2077 6f72 6b65 723d 776f 726b 6572 2c20   worker=worker, 
+0002a950: 2a2a 6b77 6172 6773 0a20 2020 2020 2020  **kwargs.       
+0002a960: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0002a970: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002a980: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
+0002a990: 2077 6f72 6b65 725f 6d73 6773 203d 2072   worker_msgs = r
+0002a9a0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0002a9b0: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+0002a9c0: 6d6f 7279 223a 0a20 2020 2020 2020 2020  mory":.         
+0002a9d0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0002a9e0: 2069 6e20 7473 2e77 686f 5f68 6173 0a20   in ts.who_has. 
+0002a9f0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0002aa00: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+0002aa10: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+0002aa20: 6572 5f6d 7367 730a 0a20 2020 2064 6566  er_msgs..    def
+0002aa30: 2073 7469 6d75 6c75 735f 7461 736b 5f65   stimulus_task_e
+0002aa40: 7272 6564 280a 2020 2020 2020 2020 7365  rred(.        se
+0002aa50: 6c66 2c0a 2020 2020 2020 2020 6b65 793d  lf,.        key=
+0002aa60: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+0002aa70: 726b 6572 3d4e 6f6e 652c 0a20 2020 2020  rker=None,.     
+0002aa80: 2020 2065 7863 6570 7469 6f6e 3d4e 6f6e     exception=Non
+0002aa90: 652c 0a20 2020 2020 2020 2073 7469 6d75  e,.        stimu
+0002aaa0: 6c75 735f 6964 3d4e 6f6e 652c 0a20 2020  lus_id=None,.   
+0002aab0: 2020 2020 2074 7261 6365 6261 636b 3d4e       traceback=N
+0002aac0: 6f6e 652c 0a20 2020 2020 2020 2072 756e  one,.        run
+0002aad0: 5f69 643d 4e6f 6e65 2c0a 2020 2020 2020  _id=None,.      
+0002aae0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+0002aaf0: 293a 0a20 2020 2020 2020 2022 2222 4d61  ):.        """Ma
+0002ab00: 726b 2074 6861 7420 6120 7461 736b 2068  rk that a task h
+0002ab10: 6173 2065 7272 6564 206f 6e20 6120 7061  as erred on a pa
+0002ab20: 7274 6963 756c 6172 2077 6f72 6b65 7222  rticular worker"
+0002ab30: 2222 0a20 2020 2020 2020 206c 6f67 6765  "".        logge
+0002ab40: 722e 6465 6275 6728 2253 7469 6d75 6c75  r.debug("Stimulu
+0002ab50: 7320 7461 736b 2065 7272 6564 2025 732c  s task erred %s,
+0002ab60: 2025 7322 2c20 6b65 792c 2077 6f72 6b65   %s", key, worke
+0002ab70: 7229 0a0a 2020 2020 2020 2020 7473 3a20  r)..        ts: 
+0002ab80: 5461 736b 5374 6174 6520 3d20 7365 6c66  TaskState = self
+0002ab90: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+0002aba0: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+0002abb0: 204e 6f6e 6520 6f72 2074 732e 7374 6174   None or ts.stat
+0002abc0: 6520 213d 2022 7072 6f63 6573 7369 6e67  e != "processing
+0002abd0: 223a 0a20 2020 2020 2020 2020 2020 2072  ":.            r
+0002abe0: 6574 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d  eturn {}, {}, {}
+0002abf0: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
+0002ac00: 7275 6e5f 6964 2021 3d20 7275 6e5f 6964  run_id != run_id
+0002ac10: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0002ac20: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002ac30: 6e20 616e 6420 7473 2e70 726f 6365 7373  n and ts.process
+0002ac40: 696e 675f 6f6e 2e61 6464 7265 7373 203d  ing_on.address =
+0002ac50: 3d20 776f 726b 6572 3a0a 2020 2020 2020  = worker:.      
+0002ac60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002ac70: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+0002ac80: 6e28 6b65 792c 2022 7265 6c65 6173 6564  n(key, "released
+0002ac90: 222c 2073 7469 6d75 6c75 735f 6964 290a  ", stimulus_id).
+0002aca0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0002acb0: 726e 207b 7d2c 207b 7d2c 207b 7d0a 0a20  rn {}, {}, {}.. 
+0002acc0: 2020 2020 2020 2069 6620 7473 2e72 6574         if ts.ret
+0002acd0: 7269 6573 203e 2030 3a0a 2020 2020 2020  ries > 0:.      
+0002ace0: 2020 2020 2020 7473 2e72 6574 7269 6573        ts.retries
+0002acf0: 202d 3d20 310a 2020 2020 2020 2020 2020   -= 1.          
+0002ad00: 2020 7265 7475 726e 2073 656c 662e 5f74    return self._t
+0002ad10: 7261 6e73 6974 696f 6e28 6b65 792c 2022  ransition(key, "
+0002ad20: 7761 6974 696e 6722 2c20 7374 696d 756c  waiting", stimul
+0002ad30: 7573 5f69 6429 0a20 2020 2020 2020 2065  us_id).        e
+0002ad40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002ad50: 2072 6574 7572 6e20 7365 6c66 2e5f 7472   return self._tr
+0002ad60: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+0002ad70: 2020 2020 2020 2020 2020 6b65 792c 0a20            key,. 
+0002ad80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002ad90: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+0002ada0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0002adb0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+0002adc0: 2020 2020 2063 6175 7365 3d6b 6579 2c0a       cause=key,.
+0002add0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ade0: 6578 6365 7074 696f 6e3d 6578 6365 7074  exception=except
+0002adf0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+0002ae00: 2020 2020 2074 7261 6365 6261 636b 3d74       traceback=t
+0002ae10: 7261 6365 6261 636b 2c0a 2020 2020 2020  raceback,.      
+0002ae20: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0002ae30: 3d77 6f72 6b65 722c 0a20 2020 2020 2020  =worker,.       
+0002ae40: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+0002ae50: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0002ae60: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
+0002ae70: 7573 5f72 6574 7279 2873 656c 662c 206b  us_retry(self, k
+0002ae80: 6579 732c 2063 6c69 656e 743d 4e6f 6e65  eys, client=None
+0002ae90: 293a 0a20 2020 2020 2020 206c 6f67 6765  ):.        logge
+0002aea0: 722e 696e 666f 2822 436c 6965 6e74 2025  r.info("Client %
+0002aeb0: 7320 7265 7175 6573 7473 2074 6f20 7265  s requests to re
+0002aec0: 7472 7920 2564 206b 6579 7322 2c20 636c  try %d keys", cl
+0002aed0: 6965 6e74 2c20 6c65 6e28 6b65 7973 2929  ient, len(keys))
+0002aee0: 0a20 2020 2020 2020 2069 6620 636c 6965  .        if clie
+0002aef0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+0002af00: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2863  self.log_event(c
+0002af10: 6c69 656e 742c 207b 2261 6374 696f 6e22  lient, {"action"
+0002af20: 3a20 2272 6574 7279 222c 2022 636f 756e  : "retry", "coun
+0002af30: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
+0002af40: 0a20 2020 2020 2020 2073 7461 636b 203d  .        stack =
+0002af50: 206c 6973 7428 6b65 7973 290a 2020 2020   list(keys).    
+0002af60: 2020 2020 7365 656e 203d 2073 6574 2829      seen = set()
+0002af70: 0a20 2020 2020 2020 2072 6f6f 7473 203d  .        roots =
+0002af80: 205b 5d0a 2020 2020 2020 2020 7768 696c   [].        whil
+0002af90: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
+0002afa0: 2020 2020 206b 6579 203d 2073 7461 636b       key = stack
+0002afb0: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
+0002afc0: 2020 2073 6565 6e2e 6164 6428 6b65 7929     seen.add(key)
+0002afd0: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+0002afe0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+0002aff0: 5d0a 2020 2020 2020 2020 2020 2020 6572  ].            er
+0002b000: 7265 645f 6465 7073 203d 205b 6474 732e  red_deps = [dts.
+0002b010: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
+0002b020: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+0002b030: 6620 6474 732e 7374 6174 6520 3d3d 2022  f dts.state == "
+0002b040: 6572 7265 6422 5d0a 2020 2020 2020 2020  erred"].        
+0002b050: 2020 2020 6966 2065 7272 6564 5f64 6570      if erred_dep
+0002b060: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002b070: 2020 2073 7461 636b 2e65 7874 656e 6428     stack.extend(
+0002b080: 6572 7265 645f 6465 7073 290a 2020 2020  erred_deps).    
+0002b090: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002b0a0: 2020 2020 2020 2020 2020 2020 2020 726f                ro
+0002b0b0: 6f74 732e 6170 7065 6e64 286b 6579 290a  ots.append(key).
+0002b0c0: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+0002b0d0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+0002b0e0: 207b 6b65 793a 2022 7761 6974 696e 6722   {key: "waiting"
+0002b0f0: 2066 6f72 206b 6579 2069 6e20 726f 6f74   for key in root
+0002b100: 737d 0a20 2020 2020 2020 2073 656c 662e  s}.        self.
+0002b110: 7472 616e 7369 7469 6f6e 7328 7265 636f  transitions(reco
+0002b120: 6d6d 656e 6461 7469 6f6e 732c 2066 2273  mmendations, f"s
+0002b130: 7469 6d75 6c75 732d 7265 7472 792d 7b74  timulus-retry-{t
+0002b140: 696d 6528 297d 2229 0a0a 2020 2020 2020  ime()}")..      
+0002b150: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+0002b160: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+0002b170: 666f 7220 6b65 7920 696e 2073 6565 6e3a  for key in seen:
+0002b180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b190: 2061 7373 6572 7420 6e6f 7420 7365 6c66   assert not self
+0002b1a0: 2e74 6173 6b73 5b6b 6579 5d2e 6578 6365  .tasks[key].exce
+0002b1b0: 7074 696f 6e5f 626c 616d 650a 0a20 2020  ption_blame..   
+0002b1c0: 2020 2020 2072 6574 7572 6e20 7475 706c       return tupl
+0002b1d0: 6528 7365 656e 290a 0a20 2020 2064 6566  e(seen)..    def
+0002b1e0: 2063 6c6f 7365 5f77 6f72 6b65 7228 7365   close_worker(se
+0002b1f0: 6c66 2c20 776f 726b 6572 3a20 7374 7229  lf, worker: str)
+0002b200: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0002b210: 2020 2222 2241 736b 2061 2077 6f72 6b65    """Ask a worke
+0002b220: 7220 746f 2073 6875 7420 6974 7365 6c66  r to shut itself
+0002b230: 2064 6f77 6e2e 2044 6f20 6e6f 7420 7761   down. Do not wa
+0002b240: 6974 2066 6f72 2069 7420 746f 2074 616b  it for it to tak
+0002b250: 6520 6566 6665 6374 2e0a 2020 2020 2020  e effect..      
+0002b260: 2020 4e6f 7465 2074 6861 7420 7468 6572    Note that ther
+0002b270: 6520 6973 206e 6f20 6775 6172 616e 7465  e is no guarante
+0002b280: 6520 7468 6174 2074 6865 2077 6f72 6b65  e that the worke
+0002b290: 7220 7769 6c6c 2061 6374 7561 6c6c 7920  r will actually 
+0002b2a0: 6163 6365 7074 2074 6865 0a20 2020 2020  accept the.     
+0002b2b0: 2020 2063 6f6d 6d61 6e64 2e0a 0a20 2020     command...   
+0002b2c0: 2020 2020 204e 6f74 6520 7468 6174 203a       Note that :
+0002b2d0: 6d65 7468 3a60 7265 6d6f 7665 5f77 6f72  meth:`remove_wor
+0002b2e0: 6b65 7260 2073 656e 6473 2074 6865 2073  ker` sends the s
+0002b2f0: 616d 6520 636f 6d6d 616e 6420 696e 7465  ame command inte
+0002b300: 726e 616c 6c79 2069 6620 636c 6f73 653d  rnally if close=
+0002b310: 5472 7565 2e0a 0a20 2020 2020 2020 2053  True...        S
+0002b320: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+0002b330: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+0002b340: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
+0002b350: 2020 2020 2020 2020 7265 6d6f 7665 5f77          remove_w
+0002b360: 6f72 6b65 720a 2020 2020 2020 2020 2222  orker.        ""
+0002b370: 220a 2020 2020 2020 2020 6966 2077 6f72  ".        if wor
+0002b380: 6b65 7220 6e6f 7420 696e 2073 656c 662e  ker not in self.
+0002b390: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0002b3a0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0002b3b0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002b3c0: 2822 436c 6f73 696e 6720 776f 726b 6572  ("Closing worker
+0002b3d0: 2025 7322 2c20 776f 726b 6572 290a 2020   %s", worker).  
+0002b3e0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+0002b3f0: 7665 6e74 2877 6f72 6b65 722c 207b 2261  vent(worker, {"a
+0002b400: 6374 696f 6e22 3a20 2263 6c6f 7365 2d77  ction": "close-w
+0002b410: 6f72 6b65 7222 7d29 0a20 2020 2020 2020  orker"}).       
+0002b420: 2073 656c 662e 776f 726b 6572 5f73 656e   self.worker_sen
+0002b430: 6428 776f 726b 6572 2c20 7b22 6f70 223a  d(worker, {"op":
+0002b440: 2022 636c 6f73 6522 2c20 2272 6561 736f   "close", "reaso
+0002b450: 6e22 3a20 2273 6368 6564 756c 6572 2d63  n": "scheduler-c
+0002b460: 6c6f 7365 2d77 6f72 6b65 7222 7d29 0a0a  lose-worker"})..
+0002b470: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+0002b480: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
+0002b490: 6d6f 7665 5f77 6f72 6b65 7228 0a20 2020  move_worker(.   
+0002b4a0: 2020 2020 2073 656c 662c 2061 6464 7265       self, addre
+0002b4b0: 7373 3a20 7374 722c 202a 2c20 7374 696d  ss: str, *, stim
+0002b4c0: 756c 7573 5f69 643a 2073 7472 2c20 7361  ulus_id: str, sa
+0002b4d0: 6665 3a20 626f 6f6c 203d 2046 616c 7365  fe: bool = False
+0002b4e0: 2c20 636c 6f73 653a 2062 6f6f 6c20 3d20  , close: bool = 
+0002b4f0: 5472 7565 0a20 2020 2029 202d 3e20 4c69  True.    ) -> Li
+0002b500: 7465 7261 6c5b 224f 4b22 2c20 2261 6c72  teral["OK", "alr
+0002b510: 6561 6479 2d72 656d 6f76 6564 225d 3a0a  eady-removed"]:.
+0002b520: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
+0002b530: 6520 776f 726b 6572 2066 726f 6d20 636c  e worker from cl
+0002b540: 7573 7465 722e 0a0a 2020 2020 2020 2020  uster...        
+0002b550: 5765 2064 6f20 7468 6973 2077 6865 6e20  We do this when 
+0002b560: 6120 776f 726b 6572 2072 6570 6f72 7473  a worker reports
+0002b570: 2074 6861 7420 6974 2070 6c61 6e73 2074   that it plans t
+0002b580: 6f20 6c65 6176 6520 6f72 2077 6865 6e20  o leave or when 
+0002b590: 6974 2061 7070 6561 7273 2074 6f20 6265  it appears to be
+0002b5a0: 0a20 2020 2020 2020 2075 6e72 6573 706f  .        unrespo
+0002b5b0: 6e73 6976 652e 2054 6869 7320 6d61 7920  nsive. This may 
+0002b5c0: 7365 6e64 2069 7473 2074 6173 6b73 2062  send its tasks b
+0002b5d0: 6163 6b20 746f 2061 2072 656c 6561 7365  ack to a release
+0002b5e0: 6420 7374 6174 652e 0a0a 2020 2020 2020  d state...      
+0002b5f0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+0002b600: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+0002b610: 2020 2020 7265 7469 7265 5f77 6f72 6b65      retire_worke
+0002b620: 7273 0a20 2020 2020 2020 2063 6c6f 7365  rs.        close
+0002b630: 5f77 6f72 6b65 720a 2020 2020 2020 2020  _worker.        
+0002b640: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+0002b650: 656c 662e 7374 6174 7573 203d 3d20 5374  elf.status == St
+0002b660: 6174 7573 2e63 6c6f 7365 643a 0a20 2020  atus.closed:.   
+0002b670: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0002b680: 2261 6c72 6561 6479 2d72 656d 6f76 6564  "already-removed
+0002b690: 220a 0a20 2020 2020 2020 2061 6464 7265  "..        addre
+0002b6a0: 7373 203d 2073 656c 662e 636f 6572 6365  ss = self.coerce
+0002b6b0: 5f61 6464 7265 7373 2861 6464 7265 7373  _address(address
+0002b6c0: 290a 0a20 2020 2020 2020 2069 6620 6164  )..        if ad
+0002b6d0: 6472 6573 7320 6e6f 7420 696e 2073 656c  dress not in sel
+0002b6e0: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
+0002b6f0: 2020 2020 2020 2072 6574 7572 6e20 2261         return "a
+0002b700: 6c72 6561 6479 2d72 656d 6f76 6564 220a  lready-removed".
+0002b710: 0a20 2020 2020 2020 2068 6f73 7420 3d20  .        host = 
+0002b720: 6765 745f 6164 6472 6573 735f 686f 7374  get_address_host
+0002b730: 2861 6464 7265 7373 290a 0a20 2020 2020  (address)..     
+0002b740: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
+0002b750: 6b65 7273 5b61 6464 7265 7373 5d0a 0a20  kers[address].. 
+0002b760: 2020 2020 2020 2065 7665 6e74 5f6d 7367         event_msg
+0002b770: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0002b780: 2022 6163 7469 6f6e 223a 2022 7265 6d6f   "action": "remo
+0002b790: 7665 2d77 6f72 6b65 7222 2c0a 2020 2020  ve-worker",.    
+0002b7a0: 2020 2020 2020 2020 2270 726f 6365 7373          "process
+0002b7b0: 696e 672d 7461 736b 7322 3a20 7b74 732e  ing-tasks": {ts.
+0002b7c0: 6b65 7920 666f 7220 7473 2069 6e20 7773  key for ts in ws
+0002b7d0: 2e70 726f 6365 7373 696e 677d 2c0a 2020  .processing},.  
+0002b7e0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+0002b7f0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2861  self.log_event(a
+0002b800: 6464 7265 7373 2c20 6576 656e 745f 6d73  ddress, event_ms
+0002b810: 672e 636f 7079 2829 290a 2020 2020 2020  g.copy()).      
+0002b820: 2020 6576 656e 745f 6d73 675b 2277 6f72    event_msg["wor
+0002b830: 6b65 7222 5d20 3d20 6164 6472 6573 730a  ker"] = address.
+0002b840: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0002b850: 5f65 7665 6e74 2822 616c 6c22 2c20 6576  _event("all", ev
+0002b860: 656e 745f 6d73 6729 0a0a 2020 2020 2020  ent_msg)..      
+0002b870: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+0002b880: 5265 6d6f 7665 2077 6f72 6b65 7220 7b77  Remove worker {w
+0002b890: 737d 2028 7b73 7469 6d75 6c75 735f 6964  s} ({stimulus_id
+0002b8a0: 3d7d 2922 290a 2020 2020 2020 2020 6966  =})").        if
+0002b8b0: 2063 6c6f 7365 3a0a 2020 2020 2020 2020   close:.        
+0002b8c0: 2020 2020 7769 7468 2073 7570 7072 6573      with suppres
+0002b8d0: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
+0002b8e0: 2c20 436f 6d6d 436c 6f73 6564 4572 726f  , CommClosedErro
+0002b8f0: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0002b900: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+0002b910: 636f 6d6d 735b 6164 6472 6573 735d 2e73  comms[address].s
+0002b920: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
+0002b930: 2020 2020 2020 2020 207b 226f 7022 3a20           {"op": 
+0002b940: 2263 6c6f 7365 222c 2022 7265 6173 6f6e  "close", "reason
+0002b950: 223a 2022 7363 6865 6475 6c65 722d 7265  ": "scheduler-re
+0002b960: 6d6f 7665 2d77 6f72 6b65 7222 7d0a 2020  move-worker"}.  
+0002b970: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002b980: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+0002b990: 6d6f 7665 5f72 6573 6f75 7263 6573 2861  move_resources(a
+0002b9a0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+0002b9b0: 2064 6820 3d20 7365 6c66 2e68 6f73 745f   dh = self.host_
+0002b9c0: 696e 666f 5b68 6f73 745d 0a20 2020 2020  info[host].     
+0002b9d0: 2020 2064 685f 6164 6472 6573 7365 733a     dh_addresses:
+0002b9e0: 2073 6574 203d 2064 685b 2261 6464 7265   set = dh["addre
+0002b9f0: 7373 6573 225d 0a20 2020 2020 2020 2064  sses"].        d
+0002ba00: 685f 6164 6472 6573 7365 732e 7265 6d6f  h_addresses.remo
+0002ba10: 7665 2861 6464 7265 7373 290a 2020 2020  ve(address).    
+0002ba20: 2020 2020 6468 5b22 6e74 6872 6561 6473      dh["nthreads
+0002ba30: 225d 202d 3d20 7773 2e6e 7468 7265 6164  "] -= ws.nthread
+0002ba40: 730a 2020 2020 2020 2020 7365 6c66 2e74  s.        self.t
+0002ba50: 6f74 616c 5f6e 7468 7265 6164 7320 2d3d  otal_nthreads -=
+0002ba60: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
+0002ba70: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
+0002ba80: 6e74 6872 6561 6473 5f68 6973 746f 7279  nthreads_history
+0002ba90: 2e61 7070 656e 6428 2874 696d 6528 292c  .append((time(),
+0002baa0: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+0002bab0: 6561 6473 2929 0a20 2020 2020 2020 2069  eads)).        i
+0002bac0: 6620 6e6f 7420 6468 5f61 6464 7265 7373  f not dh_address
+0002bad0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0002bae0: 6465 6c20 7365 6c66 2e68 6f73 745f 696e  del self.host_in
+0002baf0: 666f 5b68 6f73 745d 0a0a 2020 2020 2020  fo[host]..      
+0002bb00: 2020 7365 6c66 2e72 7063 2e72 656d 6f76    self.rpc.remov
+0002bb10: 6528 6164 6472 6573 7329 0a20 2020 2020  e(address).     
+0002bb20: 2020 2064 656c 2073 656c 662e 7374 7265     del self.stre
+0002bb30: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
+0002bb40: 5d0a 2020 2020 2020 2020 6465 6c20 7365  ].        del se
+0002bb50: 6c66 2e61 6c69 6173 6573 5b77 732e 6e61  lf.aliases[ws.na
+0002bb60: 6d65 5d0a 2020 2020 2020 2020 7365 6c66  me].        self
+0002bb70: 2e69 646c 652e 706f 7028 7773 2e61 6464  .idle.pop(ws.add
+0002bb80: 7265 7373 2c20 4e6f 6e65 290a 2020 2020  ress, None).    
+0002bb90: 2020 2020 7365 6c66 2e69 646c 655f 7461      self.idle_ta
+0002bba0: 736b 5f63 6f75 6e74 2e64 6973 6361 7264  sk_count.discard
+0002bbb0: 2877 7329 0a20 2020 2020 2020 2073 656c  (ws).        sel
+0002bbc0: 662e 7361 7475 7261 7465 642e 6469 7363  f.saturated.disc
+0002bbd0: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
+0002bbe0: 6465 6c20 7365 6c66 2e77 6f72 6b65 7273  del self.workers
+0002bbf0: 5b61 6464 7265 7373 5d0a 2020 2020 2020  [address].      
+0002bc00: 2020 7773 2e73 7461 7475 7320 3d20 5374    ws.status = St
+0002bc10: 6174 7573 2e63 6c6f 7365 640a 2020 2020  atus.closed.    
+0002bc20: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+0002bc30: 2e64 6973 6361 7264 2877 7329 0a0a 2020  .discard(ws)..  
+0002bc40: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
+0002bc50: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
+0002bc60: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
+0002bc70: 2069 6e20 6c69 7374 2877 732e 7072 6f63   in list(ws.proc
+0002bc80: 6573 7369 6e67 293a 0a20 2020 2020 2020  essing):.       
+0002bc90: 2020 2020 206b 203d 2074 732e 6b65 790a       k = ts.key.
+0002bca0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0002bcb0: 6d6d 656e 6461 7469 6f6e 735b 6b5d 203d  mmendations[k] =
+0002bcc0: 2022 7265 6c65 6173 6564 220a 2020 2020   "released".    
+0002bcd0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0002bce0: 6166 653a 0a20 2020 2020 2020 2020 2020  afe:.           
+0002bcf0: 2020 2020 2074 732e 7375 7370 6963 696f       ts.suspicio
+0002bd00: 7573 202b 3d20 310a 2020 2020 2020 2020  us += 1.        
+0002bd10: 2020 2020 2020 2020 7473 2e70 7265 6669          ts.prefi
+0002bd20: 782e 7375 7370 6963 696f 7573 202b 3d20  x.suspicious += 
+0002bd30: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0002bd40: 2020 6966 2074 732e 7375 7370 6963 696f    if ts.suspicio
+0002bd50: 7573 203e 2073 656c 662e 616c 6c6f 7765  us > self.allowe
+0002bd60: 645f 6661 696c 7572 6573 3a0a 2020 2020  d_failures:.    
+0002bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd80: 6465 6c20 7265 636f 6d6d 656e 6461 7469  del recommendati
+0002bd90: 6f6e 735b 6b5d 0a20 2020 2020 2020 2020  ons[k].         
+0002bda0: 2020 2020 2020 2020 2020 2065 203d 2070             e = p
+0002bdb0: 6963 6b6c 652e 6475 6d70 7328 0a20 2020  ickle.dumps(.   
+0002bdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bdd0: 2020 2020 204b 696c 6c65 6457 6f72 6b65       KilledWorke
+0002bde0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0002bdf0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002be00: 6173 6b3d 6b2c 0a20 2020 2020 2020 2020  ask=k,.         
 0002be10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be20: 2020 2020 2020 2061 6c6c 6f77 6564 5f66         allowed_f
-0002be30: 6169 6c75 7265 733d 7365 6c66 2e61 6c6c  ailures=self.all
-0002be40: 6f77 6564 5f66 6169 6c75 7265 732c 0a20  owed_failures,. 
-0002be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be60: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-0002be70: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002be20: 2020 206c 6173 745f 776f 726b 6572 3d77     last_worker=w
+0002be30: 732e 636c 6561 6e28 292c 0a20 2020 2020  s.clean(),.     
+0002be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002be50: 2020 2020 2020 2061 6c6c 6f77 6564 5f66         allowed_f
+0002be60: 6169 6c75 7265 733d 7365 6c66 2e61 6c6c  ailures=self.all
+0002be70: 6f77 6564 5f66 6169 6c75 7265 732c 0a20  owed_failures,. 
 0002be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be90: 2020 2020 7220 3d20 7365 6c66 2e74 7261      r = self.tra
-0002bea0: 6e73 6974 696f 6e28 0a20 2020 2020 2020  nsition(.       
+0002be90: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
+0002bea0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
 0002beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bec0: 206b 2c0a 2020 2020 2020 2020 2020 2020   k,.            
-0002bed0: 2020 2020 2020 2020 2020 2020 2265 7272              "err
-0002bee0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-0002bef0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0002bf00: 6570 7469 6f6e 3d65 2c0a 2020 2020 2020  eption=e,.      
-0002bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf20: 2020 6361 7573 653d 6b2c 0a20 2020 2020    cause=k,.     
-0002bf30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf40: 2020 2073 7469 6d75 6c75 735f 6964 3d73     stimulus_id=s
-0002bf50: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+0002bec0: 2020 2020 7220 3d20 7365 6c66 2e74 7261      r = self.tra
+0002bed0: 6e73 6974 696f 6e28 0a20 2020 2020 2020  nsition(.       
+0002bee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bef0: 206b 2c0a 2020 2020 2020 2020 2020 2020   k,.            
+0002bf00: 2020 2020 2020 2020 2020 2020 2265 7272              "err
+0002bf10: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+0002bf20: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+0002bf30: 6570 7469 6f6e 3d65 2c0a 2020 2020 2020  eption=e,.      
+0002bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bf50: 2020 6361 7573 653d 6b2c 0a20 2020 2020    cause=k,.     
 0002bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bf70: 2020 2020 776f 726b 6572 3d61 6464 7265      worker=addre
-0002bf80: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-0002bf90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002bfa0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0002bfb0: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
-0002bfc0: 6461 7465 2872 290a 2020 2020 2020 2020  date(r).        
-0002bfd0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002bfe0: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-0002bff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c000: 2022 5461 736b 2025 7320 6d61 726b 6564   "Task %s marked
-0002c010: 2061 7320 6661 696c 6564 2062 6563 6175   as failed becau
-0002c020: 7365 2025 6420 776f 726b 6572 7320 6469  se %d workers di
-0002c030: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-0002c040: 2020 2020 2020 2020 2020 2020 2220 7768              " wh
-0002c050: 696c 6520 7472 7969 6e67 2074 6f20 7275  ile trying to ru
-0002c060: 6e20 6974 222c 0a20 2020 2020 2020 2020  n it",.         
-0002c070: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002c080: 732e 6b65 792c 0a20 2020 2020 2020 2020  s.key,.         
-0002c090: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c0a0: 656c 662e 616c 6c6f 7765 645f 6661 696c  elf.allowed_fail
-0002c0b0: 7572 6573 2c0a 2020 2020 2020 2020 2020  ures,.          
-0002c0c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-0002c0d0: 2020 2020 2066 6f72 2074 7320 696e 206c       for ts in l
-0002c0e0: 6973 7428 7773 2e68 6173 5f77 6861 7429  ist(ws.has_what)
-0002c0f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0002c100: 6c66 2e72 656d 6f76 655f 7265 706c 6963  lf.remove_replic
-0002c110: 6128 7473 2c20 7773 290a 2020 2020 2020  a(ts, ws).      
-0002c120: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
-0002c130: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-0002c140: 2020 2020 2020 2020 2069 6620 7473 2e72           if ts.r
-0002c150: 756e 5f73 7065 633a 0a20 2020 2020 2020  un_spec:.       
-0002c160: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0002c170: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
-0002c180: 6b65 795d 203d 2022 7265 6c65 6173 6564  key] = "released
-0002c190: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002c1a0: 2020 656c 7365 3a20 2023 2070 7572 6520    else:  # pure 
-0002c1b0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-0002c1c0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0002c1d0: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
-0002c1e0: 203d 2022 666f 7267 6f74 7465 6e22 0a0a   = "forgotten"..
-0002c1f0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-0002c200: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
-0002c210: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
-0002c220: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-0002c230: 6429 0a0a 2020 2020 2020 2020 6177 6169  d)..        awai
-0002c240: 7461 626c 6573 203d 205b 5d0a 2020 2020  tables = [].    
-0002c250: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
-0002c260: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-0002c270: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
-0002c280: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002c290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c2a0: 7265 7375 6c74 203d 2070 6c75 6769 6e2e  result = plugin.
-0002c2b0: 7265 6d6f 7665 5f77 6f72 6b65 7228 7363  remove_worker(sc
-0002c2c0: 6865 6475 6c65 723d 7365 6c66 2c20 776f  heduler=self, wo
-0002c2d0: 726b 6572 3d61 6464 7265 7373 290a 2020  rker=address).  
-0002c2e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002c2f0: 2069 6e73 7065 6374 2e69 7361 7761 6974   inspect.isawait
-0002c300: 6162 6c65 2872 6573 756c 7429 3a0a 2020  able(result):.  
+0002bf70: 2020 2073 7469 6d75 6c75 735f 6964 3d73     stimulus_id=s
+0002bf80: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+0002bf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bfa0: 2020 2020 776f 726b 6572 3d61 6464 7265      worker=addre
+0002bfb0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+0002bfc0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002bfd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002bfe0: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
+0002bff0: 6461 7465 2872 290a 2020 2020 2020 2020  date(r).        
+0002c000: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+0002c010: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
+0002c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c030: 2022 5461 736b 2025 7320 6d61 726b 6564   "Task %s marked
+0002c040: 2061 7320 6661 696c 6564 2062 6563 6175   as failed becau
+0002c050: 7365 2025 6420 776f 726b 6572 7320 6469  se %d workers di
+0002c060: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
+0002c070: 2020 2020 2020 2020 2020 2020 2220 7768              " wh
+0002c080: 696c 6520 7472 7969 6e67 2074 6f20 7275  ile trying to ru
+0002c090: 6e20 6974 222c 0a20 2020 2020 2020 2020  n it",.         
+0002c0a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002c0b0: 732e 6b65 792c 0a20 2020 2020 2020 2020  s.key,.         
+0002c0c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002c0d0: 656c 662e 616c 6c6f 7765 645f 6661 696c  elf.allowed_fail
+0002c0e0: 7572 6573 2c0a 2020 2020 2020 2020 2020  ures,.          
+0002c0f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0002c100: 2020 2020 2066 6f72 2074 7320 696e 206c       for ts in l
+0002c110: 6973 7428 7773 2e68 6173 5f77 6861 7429  ist(ws.has_what)
+0002c120: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002c130: 6c66 2e72 656d 6f76 655f 7265 706c 6963  lf.remove_replic
+0002c140: 6128 7473 2c20 7773 290a 2020 2020 2020  a(ts, ws).      
+0002c150: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+0002c160: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
+0002c170: 2020 2020 2020 2020 2069 6620 7473 2e72           if ts.r
+0002c180: 756e 5f73 7065 633a 0a20 2020 2020 2020  un_spec:.       
+0002c190: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0002c1a0: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
+0002c1b0: 6b65 795d 203d 2022 7265 6c65 6173 6564  key] = "released
+0002c1c0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002c1d0: 2020 656c 7365 3a20 2023 2070 7572 6520    else:  # pure 
+0002c1e0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0002c1f0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0002c200: 6e64 6174 696f 6e73 5b74 732e 6b65 795d  ndations[ts.key]
+0002c210: 203d 2022 666f 7267 6f74 7465 6e22 0a0a   = "forgotten"..
+0002c220: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+0002c230: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
+0002c240: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
+0002c250: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
+0002c260: 6429 0a0a 2020 2020 2020 2020 6177 6169  d)..        awai
+0002c270: 7461 626c 6573 203d 205b 5d0a 2020 2020  tables = [].    
+0002c280: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
+0002c290: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+0002c2a0: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
+0002c2b0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002c2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c2d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002c2e0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+0002c2f0: 3d20 706c 7567 696e 2e72 656d 6f76 655f  = plugin.remove_
+0002c300: 776f 726b 6572 280a 2020 2020 2020 2020  worker(.        
 0002c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c320: 2020 6177 6169 7461 626c 6573 2e61 7070    awaitables.app
-0002c330: 656e 6428 7265 7375 6c74 290a 2020 2020  end(result).    
-0002c340: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-0002c350: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-0002c360: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002c370: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-0002c380: 6529 0a0a 2020 2020 2020 2020 706c 7567  e)..        plug
-0002c390: 696e 5f6d 7367 7320 3d20 6177 6169 7420  in_msgs = await 
-0002c3a0: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
-0002c3b0: 6177 6169 7461 626c 6573 2c20 7265 7475  awaitables, retu
-0002c3c0: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
-0002c3d0: 7565 290a 2020 2020 2020 2020 706c 7567  ue).        plug
-0002c3e0: 696e 735f 6578 6365 7074 696f 6e73 203d  ins_exceptions =
-0002c3f0: 205b 6d73 6720 666f 7220 6d73 6720 696e   [msg for msg in
-0002c400: 2070 6c75 6769 6e5f 6d73 6773 2069 6620   plugin_msgs if 
-0002c410: 6973 696e 7374 616e 6365 286d 7367 2c20  isinstance(msg, 
-0002c420: 4578 6365 7074 696f 6e29 5d0a 2020 2020  Exception)].    
-0002c430: 2020 2020 666f 7220 6578 6320 696e 2070      for exc in p
-0002c440: 6c75 6769 6e73 5f65 7863 6570 7469 6f6e  lugins_exception
-0002c450: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
-0002c460: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-0002c470: 6578 632c 2065 7863 5f69 6e66 6f3d 6578  exc, exc_info=ex
-0002c480: 6329 0a0a 2020 2020 2020 2020 6966 206e  c)..        if n
-0002c490: 6f74 2073 656c 662e 776f 726b 6572 733a  ot self.workers:
-0002c4a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0002c4b0: 6765 722e 696e 666f 2822 4c6f 7374 2061  ger.info("Lost a
-0002c4c0: 6c6c 2077 6f72 6b65 7273 2229 0a0a 2020  ll workers")..  
-0002c4d0: 2020 2020 2020 666f 7220 7720 696e 2073        for w in s
-0002c4e0: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
-0002c4f0: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
-0002c500: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
-0002c510: 706f 7028 2861 6464 7265 7373 2c20 7729  pop((address, w)
-0002c520: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
-0002c530: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
-0002c540: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
-0002c550: 772c 2061 6464 7265 7373 292c 204e 6f6e  w, address), Non
-0002c560: 6529 0a0a 2020 2020 2020 2020 6173 796e  e)..        asyn
-0002c570: 6320 6465 6620 7265 6d6f 7665 5f77 6f72  c def remove_wor
-0002c580: 6b65 725f 6672 6f6d 5f65 7665 6e74 7328  ker_from_events(
-0002c590: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002c5a0: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
-0002c5b0: 776f 726b 6572 2069 736e 2774 2072 6567  worker isn't reg
-0002c5c0: 6973 7465 7265 6420 616e 796d 6f72 6520  istered anymore 
-0002c5d0: 6166 7465 7220 7468 6520 6465 6c61 792c  after the delay,
-0002c5e0: 2072 656d 6f76 6520 6672 6f6d 2065 7665   remove from eve
-0002c5f0: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-0002c600: 6966 2061 6464 7265 7373 206e 6f74 2069  if address not i
-0002c610: 6e20 7365 6c66 2e77 6f72 6b65 7273 2061  n self.workers a
-0002c620: 6e64 2061 6464 7265 7373 2069 6e20 7365  nd address in se
-0002c630: 6c66 2e65 7665 6e74 733a 0a20 2020 2020  lf.events:.     
-0002c640: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-0002c650: 656c 662e 6576 656e 7473 5b61 6464 7265  elf.events[addre
-0002c660: 7373 5d0a 0a20 2020 2020 2020 2063 6c65  ss]..        cle
-0002c670: 616e 7570 5f64 656c 6179 203d 2070 6172  anup_delay = par
-0002c680: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
-0002c690: 2020 2020 2020 2020 2020 6461 736b 2e63            dask.c
-0002c6a0: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0002c6b0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
-0002c6c0: 2e65 7665 6e74 732d 636c 6561 6e75 702d  .events-cleanup-
-0002c6d0: 6465 6c61 7922 290a 2020 2020 2020 2020  delay").        
-0002c6e0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0002c6f0: 5f6f 6e67 6f69 6e67 5f62 6163 6b67 726f  _ongoing_backgro
-0002c700: 756e 645f 7461 736b 732e 6361 6c6c 5f6c  und_tasks.call_l
-0002c710: 6174 6572 280a 2020 2020 2020 2020 2020  ater(.          
-0002c720: 2020 636c 6561 6e75 705f 6465 6c61 792c    cleanup_delay,
-0002c730: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
-0002c740: 726f 6d5f 6576 656e 7473 0a20 2020 2020  rom_events.     
-0002c750: 2020 2029 0a20 2020 2020 2020 206c 6f67     ).        log
-0002c760: 6765 722e 6465 6275 6728 2252 656d 6f76  ger.debug("Remov
-0002c770: 6564 2077 6f72 6b65 7220 2573 222c 2077  ed worker %s", w
-0002c780: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
-0002c790: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
-0002c7a0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0002c7b0: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
-0002c7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c7d0: 2077 2c0a 2020 2020 2020 2020 2020 2020   w,.            
-0002c7e0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0002c7f0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-0002c800: 2272 656d 6f76 652d 776f 726b 6572 222c  "remove-worker",
-0002c810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002c820: 2020 2020 2022 776f 726b 6572 223a 2061       "worker": a
-0002c830: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-0002c840: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-0002c850: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-0002c860: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-0002c870: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
-0002c880: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0002c890: 2020 7265 7475 726e 2022 4f4b 220a 0a20    return "OK".. 
-0002c8a0: 2020 2064 6566 2073 7469 6d75 6c75 735f     def stimulus_
-0002c8b0: 6361 6e63 656c 280a 2020 2020 2020 2020  cancel(.        
-0002c8c0: 7365 6c66 2c20 6b65 7973 3a20 5365 7175  self, keys: Sequ
-0002c8d0: 656e 6365 5b73 7472 5d2c 2063 6c69 656e  ence[str], clien
-0002c8e0: 743a 2073 7472 2c20 666f 7263 653a 2062  t: str, force: b
-0002c8f0: 6f6f 6c20 3d20 4661 6c73 650a 2020 2020  ool = False.    
-0002c900: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002c910: 2020 2022 2222 5374 6f70 2065 7865 6375     """Stop execu
-0002c920: 7469 6f6e 206f 6e20 6120 6c69 7374 206f  tion on a list o
-0002c930: 6620 6b65 7973 2222 220a 2020 2020 2020  f keys""".      
-0002c940: 2020 6c6f 6767 6572 2e69 6e66 6f28 2243    logger.info("C
-0002c950: 6c69 656e 7420 2573 2072 6571 7565 7374  lient %s request
-0002c960: 7320 746f 2063 616e 6365 6c20 2564 206b  s to cancel %d k
-0002c970: 6579 7322 2c20 636c 6965 6e74 2c20 6c65  eys", client, le
-0002c980: 6e28 6b65 7973 2929 0a20 2020 2020 2020  n(keys)).       
-0002c990: 2069 6620 636c 6965 6e74 3a0a 2020 2020   if client:.    
-0002c9a0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0002c9b0: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-0002c9c0: 2020 2020 2020 2020 636c 6965 6e74 2c20          client, 
-0002c9d0: 7b22 6163 7469 6f6e 223a 2022 6361 6e63  {"action": "canc
-0002c9e0: 656c 222c 2022 636f 756e 7422 3a20 6c65  el", "count": le
-0002c9f0: 6e28 6b65 7973 292c 2022 666f 7263 6522  n(keys), "force"
-0002ca00: 3a20 666f 7263 657d 0a20 2020 2020 2020  : force}.       
-0002ca10: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
-0002ca20: 616e 6365 6c6c 6564 5f6b 6579 7320 3d20  ancelled_keys = 
-0002ca30: 5b5d 0a20 2020 2020 2020 2063 6c69 656e  [].        clien
-0002ca40: 7473 203d 205b 5d0a 2020 2020 2020 2020  ts = [].        
-0002ca50: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
-0002ca60: 0a20 2020 2020 2020 2020 2020 2074 733a  .            ts:
-0002ca70: 2054 6173 6b53 7461 7465 207c 204e 6f6e   TaskState | Non
-0002ca80: 6520 3d20 7365 6c66 2e74 6173 6b73 2e67  e = self.tasks.g
-0002ca90: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0002caa0: 2020 2020 6966 206e 6f74 2074 733a 0a20      if not ts:. 
-0002cab0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002cac0: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
-0002cad0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002cae0: 2020 2020 2020 2020 2063 733a 2043 6c69           cs: Cli
-0002caf0: 656e 7453 7461 7465 203d 2073 656c 662e  entState = self.
-0002cb00: 636c 6965 6e74 735b 636c 6965 6e74 5d0a  clients[client].
-0002cb10: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002cb20: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-0002cb30: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0002cb40: 7572 6e0a 0a20 2020 2020 2020 2020 2020  urn..           
-0002cb50: 2069 6620 666f 7263 6520 6f72 2074 732e   if force or ts.
-0002cb60: 7768 6f5f 7761 6e74 7320 3d3d 207b 6373  who_wants == {cs
-0002cb70: 7d3a 2020 2320 6e6f 206f 6e65 2065 6c73  }:  # no one els
-0002cb80: 6520 7761 6e74 7320 7468 6973 206b 6579  e wants this key
-0002cb90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cba0: 2069 6620 7473 2e64 6570 656e 6465 6e74   if ts.dependent
-0002cbb0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0002cbc0: 2020 2020 2020 2073 656c 662e 7374 696d         self.stim
-0002cbd0: 756c 7573 5f63 616e 6365 6c28 0a20 2020  ulus_cancel(.   
-0002cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cbf0: 2020 2020 205b 6474 732e 6b65 7920 666f       [dts.key fo
-0002cc00: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0002cc10: 6e64 656e 7473 5d2c 2063 6c69 656e 742c  ndents], client,
-0002cc20: 2066 6f72 6365 3d66 6f72 6365 0a20 2020   force=force.   
-0002cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc40: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0002cc50: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-0002cc60: 5363 6865 6475 6c65 7220 6361 6e63 656c  Scheduler cancel
-0002cc70: 7320 6b65 7920 2573 2e20 2046 6f72 6365  s key %s.  Force
-0002cc80: 3d25 7322 2c20 6b65 792c 2066 6f72 6365  =%s", key, force
-0002cc90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002cca0: 2020 6361 6e63 656c 6c65 645f 6b65 7973    cancelled_keys
-0002ccb0: 2e61 7070 656e 6428 6b65 7929 0a20 2020  .append(key).   
-0002ccc0: 2020 2020 2020 2020 2063 6c69 656e 7473           clients
-0002ccd0: 2e65 7874 656e 6428 6c69 7374 2874 732e  .extend(list(ts.
-0002cce0: 7768 6f5f 7761 6e74 7329 2069 6620 666f  who_wants) if fo
-0002ccf0: 7263 6520 656c 7365 205b 6373 5d29 0a20  rce else [cs]). 
-0002cd00: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
-0002cd10: 2063 6c69 656e 7473 3a0a 2020 2020 2020   clients:.      
-0002cd20: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0002cd30: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-0002cd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cd50: 206b 6579 733d 6361 6e63 656c 6c65 645f   keys=cancelled_
-0002cd60: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-0002cd70: 2020 2020 2020 636c 6965 6e74 3d63 732e        client=cs.
-0002cd80: 636c 6965 6e74 5f6b 6579 2c0a 2020 2020  client_key,.    
-0002cd90: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-0002cda0: 756c 7573 5f69 643d 6622 6361 6e63 656c  ulus_id=f"cancel
-0002cdb0: 2d6b 6579 2d7b 7469 6d65 2829 7d22 2c0a  -key-{time()}",.
-0002cdc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0002cdd0: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
-0002cde0: 7428 7b22 6f70 223a 2022 6361 6e63 656c  t({"op": "cancel
-0002cdf0: 6c65 642d 6b65 7973 222c 2022 6b65 7973  led-keys", "keys
-0002ce00: 223a 2063 616e 6365 6c6c 6564 5f6b 6579  ": cancelled_key
-0002ce10: 737d 290a 0a20 2020 2064 6566 2063 6c69  s})..    def cli
-0002ce20: 656e 745f 6465 7369 7265 735f 6b65 7973  ent_desires_keys
-0002ce30: 2873 656c 662c 206b 6579 733d 4e6f 6e65  (self, keys=None
-0002ce40: 2c20 636c 6965 6e74 3d4e 6f6e 6529 3a0a  , client=None):.
-0002ce50: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
-0002ce60: 6e74 5374 6174 6520 3d20 7365 6c66 2e63  ntState = self.c
-0002ce70: 6c69 656e 7473 2e67 6574 2863 6c69 656e  lients.get(clien
-0002ce80: 7429 0a20 2020 2020 2020 2069 6620 6373  t).        if cs
-0002ce90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002cea0: 2020 2020 2020 2320 466f 7220 7075 626c        # For publ
-0002ceb0: 6973 682c 2071 7565 7565 7320 6574 632e  ish, queues etc.
-0002cec0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002ced0: 662e 636c 6965 6e74 735b 636c 6965 6e74  f.clients[client
-0002cee0: 5d20 3d20 6373 203d 2043 6c69 656e 7453  ] = cs = ClientS
-0002cef0: 7461 7465 2863 6c69 656e 7429 0a20 2020  tate(client).   
-0002cf00: 2020 2020 2066 6f72 206b 2069 6e20 6b65       for k in ke
-0002cf10: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-0002cf20: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0002cf30: 6765 7428 6b29 0a20 2020 2020 2020 2020  get(k).         
-0002cf40: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
-0002cf50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002cf60: 2020 2320 466f 7220 7075 626c 6973 682c    # For publish,
-0002cf70: 2071 7565 7565 7320 6574 632e 0a20 2020   queues etc..   
-0002cf80: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
-0002cf90: 3d20 7365 6c66 2e6e 6577 5f74 6173 6b28  = self.new_task(
-0002cfa0: 6b2c 204e 6f6e 652c 2022 7265 6c65 6173  k, None, "releas
-0002cfb0: 6564 2229 0a20 2020 2020 2020 2020 2020  ed").           
-0002cfc0: 2074 732e 7768 6f5f 7761 6e74 732e 6164   ts.who_wants.ad
-0002cfd0: 6428 6373 290a 2020 2020 2020 2020 2020  d(cs).          
-0002cfe0: 2020 6373 2e77 616e 7473 5f77 6861 742e    cs.wants_what.
-0002cff0: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
-0002d000: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-0002d010: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
-0002d020: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
-0002d030: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-0002d040: 706f 7274 5f6f 6e5f 6b65 7928 7473 3d74  port_on_key(ts=t
-0002d050: 732c 2063 6c69 656e 743d 636c 6965 6e74  s, client=client
-0002d060: 290a 0a20 2020 2064 6566 2063 6c69 656e  )..    def clien
-0002d070: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-0002d080: 7365 6c66 2c20 6b65 7973 3d4e 6f6e 652c  self, keys=None,
-0002d090: 2063 6c69 656e 743d 4e6f 6e65 2c20 7374   client=None, st
-0002d0a0: 696d 756c 7573 5f69 643d 4e6f 6e65 293a  imulus_id=None):
-0002d0b0: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
-0002d0c0: 7665 206b 6579 7320 6672 6f6d 2063 6c69  ve keys from cli
-0002d0d0: 656e 7420 6465 7369 7265 6420 6c69 7374  ent desired list
-0002d0e0: 2222 220a 2020 2020 2020 2020 7374 696d  """.        stim
-0002d0f0: 756c 7573 5f69 6420 3d20 7374 696d 756c  ulus_id = stimul
-0002d100: 7573 5f69 6420 6f72 2066 2263 6c69 656e  us_id or f"clien
-0002d110: 742d 7265 6c65 6173 6573 2d6b 6579 732d  t-releases-keys-
-0002d120: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
-0002d130: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
-0002d140: 6e63 6528 6b65 7973 2c20 6c69 7374 293a  nce(keys, list):
-0002d150: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-0002d160: 7320 3d20 6c69 7374 286b 6579 7329 0a20  s = list(keys). 
-0002d170: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
-0002d180: 2e63 6c69 656e 7473 5b63 6c69 656e 745d  .clients[client]
-0002d190: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-0002d1a0: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-0002d1b0: 207b 7d0a 0a20 2020 2020 2020 2073 656c   {}..        sel
-0002d1c0: 662e 5f63 6c69 656e 745f 7265 6c65 6173  f._client_releas
-0002d1d0: 6573 5f6b 6579 7328 6b65 7973 3d6b 6579  es_keys(keys=key
-0002d1e0: 732c 2063 733d 6373 2c20 7265 636f 6d6d  s, cs=cs, recomm
-0002d1f0: 656e 6461 7469 6f6e 733d 7265 636f 6d6d  endations=recomm
-0002d200: 656e 6461 7469 6f6e 7329 0a20 2020 2020  endations).     
-0002d210: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-0002d220: 6f6e 7328 7265 636f 6d6d 656e 6461 7469  ons(recommendati
-0002d230: 6f6e 732c 2073 7469 6d75 6c75 735f 6964  ons, stimulus_id
-0002d240: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0002d250: 7374 696d 756c 7573 5f71 7565 7565 5f73  stimulus_queue_s
-0002d260: 6c6f 7473 5f6d 6179 6265 5f6f 7065 6e65  lots_maybe_opene
-0002d270: 6428 7374 696d 756c 7573 5f69 643d 7374  d(stimulus_id=st
-0002d280: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
-0002d290: 6465 6620 636c 6965 6e74 5f68 6561 7274  def client_heart
-0002d2a0: 6265 6174 2873 656c 662c 2063 6c69 656e  beat(self, clien
-0002d2b0: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
-0002d2c0: 2022 2222 4861 6e64 6c65 2068 6561 7274   """Handle heart
-0002d2d0: 6265 6174 7320 6672 6f6d 2043 6c69 656e  beats from Clien
-0002d2e0: 7422 2222 0a20 2020 2020 2020 2063 733a  t""".        cs:
-0002d2f0: 2043 6c69 656e 7453 7461 7465 203d 2073   ClientState = s
-0002d300: 656c 662e 636c 6965 6e74 735b 636c 6965  elf.clients[clie
-0002d310: 6e74 5d0a 2020 2020 2020 2020 6373 2e6c  nt].        cs.l
-0002d320: 6173 745f 7365 656e 203d 2074 696d 6528  ast_seen = time(
-0002d330: 290a 0a20 2020 2023 2323 2323 2323 2323  )..    #########
-0002d340: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-0002d350: 2054 6173 6b20 5661 6c69 6461 7469 6f6e   Task Validation
-0002d360: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
-0002d370: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
-0002d380: 6465 6620 7661 6c69 6461 7465 5f72 656c  def validate_rel
-0002d390: 6561 7365 6428 7365 6c66 2c20 6b65 793a  eased(self, key:
-0002d3a0: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-0002d3b0: 2020 2020 2020 2074 733a 2054 6173 6b53         ts: TaskS
-0002d3c0: 7461 7465 203d 2073 656c 662e 7461 736b  tate = self.task
-0002d3d0: 735b 6b65 795d 0a20 2020 2020 2020 2061  s[key].        a
-0002d3e0: 7373 6572 7420 7473 2e73 7461 7465 203d  ssert ts.state =
-0002d3f0: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
-0002d400: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002d410: 7473 2e77 6169 7465 7273 0a20 2020 2020  ts.waiters.     
-0002d420: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0002d430: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
-0002d440: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-0002d450: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0002d460: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-0002d470: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
-0002d480: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002d490: 2061 6e79 285b 7473 2069 6e20 6474 732e   any([ts in dts.
-0002d4a0: 7761 6974 6572 7320 666f 7220 6474 7320  waiters for dts 
-0002d4b0: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0002d4c0: 6573 5d29 0a20 2020 2020 2020 2061 7373  es]).        ass
-0002d4d0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-0002d4e0: 6c66 2e75 6e72 756e 6e61 626c 650a 2020  lf.unrunnable.  
-0002d4f0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002d500: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
-0002d510: 6564 0a0a 2020 2020 6465 6620 7661 6c69  ed..    def vali
-0002d520: 6461 7465 5f77 6169 7469 6e67 2873 656c  date_waiting(sel
-0002d530: 662c 206b 6579 3a20 7374 7229 202d 3e20  f, key: str) -> 
-0002d540: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-0002d550: 3a20 5461 736b 5374 6174 6520 3d20 7365  : TaskState = se
-0002d560: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-0002d570: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-0002d580: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
-0002d590: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0002d5a0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
-0002d5b0: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-0002d5c0: 726f 6365 7373 696e 675f 6f6e 0a20 2020  rocessing_on.   
-0002d5d0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-0002d5e0: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
-0002d5f0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
-0002d600: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
-0002d610: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
-0002d620: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-0002d630: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-0002d640: 2020 2020 2020 2020 2020 2023 2057 6520             # We 
-0002d650: 6172 6520 7761 6974 696e 6720 6f6e 2061  are waiting on a
-0002d660: 2064 6570 656e 6465 6e63 7920 6966 6620   dependency iff 
-0002d670: 6974 2773 206e 6f74 2073 746f 7265 640a  it's not stored.
-0002d680: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002d690: 7274 2062 6f6f 6c28 6474 732e 7768 6f5f  rt bool(dts.who_
-0002d6a0: 6861 7329 2021 3d20 2864 7473 2069 6e20  has) != (dts in 
-0002d6b0: 7473 2e77 6169 7469 6e67 5f6f 6e29 0a20  ts.waiting_on). 
-0002d6c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002d6d0: 7420 7473 2069 6e20 6474 732e 7761 6974  t ts in dts.wait
-0002d6e0: 6572 7320 2023 2058 5858 2065 7665 6e20  ers  # XXX even 
-0002d6f0: 6966 2064 7473 2e5f 7768 6f5f 6861 733f  if dts._who_has?
-0002d700: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002d710: 7465 5f71 7565 7565 6428 7365 6c66 2c20  te_queued(self, 
-0002d720: 6b65 793a 2073 7472 2920 2d3e 204e 6f6e  key: str) -> Non
-0002d730: 653a 0a20 2020 2020 2020 2074 733a 2054  e:.        ts: T
-0002d740: 6173 6b53 7461 7465 203d 2073 656c 662e  askState = self.
-0002d750: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-0002d760: 2020 2064 7473 3a20 5461 736b 5374 6174     dts: TaskStat
-0002d770: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-0002d780: 2074 7320 696e 2073 656c 662e 7175 6575   ts in self.queu
-0002d790: 6564 0a20 2020 2020 2020 2061 7373 6572  ed.        asser
-0002d7a0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-0002d7b0: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-0002d7c0: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
-0002d7d0: 730a 2020 2020 2020 2020 6173 7365 7274  s.        assert
-0002d7e0: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-0002d7f0: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0002d800: 7365 7274 206e 6f74 2028 0a20 2020 2020  sert not (.     
-0002d810: 2020 2020 2020 2074 732e 776f 726b 6572         ts.worker
-0002d820: 5f72 6573 7472 6963 7469 6f6e 7320 6f72  _restrictions or
-0002d830: 2074 732e 686f 7374 5f72 6573 7472 6963   ts.host_restric
-0002d840: 7469 6f6e 7320 6f72 2074 732e 7265 736f  tions or ts.reso
-0002d850: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
-0002d860: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
-0002d870: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-0002d880: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-0002d890: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002d8a0: 7274 2064 7473 2e77 686f 5f68 6173 0a20  rt dts.who_has. 
-0002d8b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002d8c0: 7420 7473 2069 6e20 6474 732e 7761 6974  t ts in dts.wait
-0002d8d0: 6572 730a 0a20 2020 2064 6566 2076 616c  ers..    def val
-0002d8e0: 6964 6174 655f 7072 6f63 6573 7369 6e67  idate_processing
-0002d8f0: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
-0002d900: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002d910: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002d920: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0002d930: 5d0a 2020 2020 2020 2020 6474 733a 2054  ].        dts: T
-0002d940: 6173 6b53 7461 7465 0a20 2020 2020 2020  askState.       
-0002d950: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-0002d960: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-0002d970: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
-0002d980: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0002d990: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
-0002d9a0: 2020 6173 7365 7274 2074 7320 696e 2077    assert ts in w
-0002d9b0: 732e 7072 6f63 6573 7369 6e67 0a20 2020  s.processing.   
-0002d9c0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002d9d0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0002d9e0: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002d9f0: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-0002da00: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0002da10: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0002da20: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0002da30: 6173 7365 7274 2064 7473 2e77 686f 5f68  assert dts.who_h
-0002da40: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
-0002da50: 7373 6572 7420 7473 2069 6e20 6474 732e  ssert ts in dts.
-0002da60: 7761 6974 6572 730a 0a20 2020 2064 6566  waiters..    def
-0002da70: 2076 616c 6964 6174 655f 6d65 6d6f 7279   validate_memory
-0002da80: 2873 656c 662c 206b 6579 3a20 7374 7229  (self, key: str)
-0002da90: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002daa0: 2020 7473 3a20 5461 736b 5374 6174 6520    ts: TaskState 
-0002dab0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-0002dac0: 5d0a 2020 2020 2020 2020 6474 733a 2054  ].        dts: T
-0002dad0: 6173 6b53 7461 7465 0a20 2020 2020 2020  askState.       
-0002dae0: 2061 7373 6572 7420 7473 2e77 686f 5f68   assert ts.who_h
-0002daf0: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
-0002db00: 7420 626f 6f6c 2874 7320 696e 2073 656c  t bool(ts in sel
-0002db10: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
-0002db20: 6b73 2920 3d3d 2028 6c65 6e28 7473 2e77  ks) == (len(ts.w
-0002db30: 686f 5f68 6173 2920 3e20 3129 0a20 2020  ho_has) > 1).   
-0002db40: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-0002db50: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0002db60: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002db70: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-0002db80: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
-0002db90: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-0002dba0: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
-0002dbb0: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
-0002dbc0: 2069 6e20 7365 6c66 2e71 7565 7565 640a   in self.queued.
-0002dbd0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
-0002dbe0: 696e 2074 732e 6465 7065 6e64 656e 7473  in ts.dependents
-0002dbf0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0002dc00: 7365 7274 2028 6474 7320 696e 2074 732e  sert (dts in ts.
-0002dc10: 7761 6974 6572 7329 203d 3d20 280a 2020  waiters) == (.  
-0002dc20: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0002dc30: 732e 7374 6174 6520 696e 2028 2277 6169  s.state in ("wai
-0002dc40: 7469 6e67 222c 2022 7175 6575 6564 222c  ting", "queued",
-0002dc50: 2022 7072 6f63 6573 7369 6e67 222c 2022   "processing", "
-0002dc60: 6e6f 2d77 6f72 6b65 7222 290a 2020 2020  no-worker").    
-0002dc70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002dc80: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-0002dc90: 6e6f 7420 696e 2064 7473 2e77 6169 7469  not in dts.waiti
-0002dca0: 6e67 5f6f 6e0a 0a20 2020 2064 6566 2076  ng_on..    def v
-0002dcb0: 616c 6964 6174 655f 6e6f 5f77 6f72 6b65  alidate_no_worke
-0002dcc0: 7228 7365 6c66 2c20 6b65 793a 2073 7472  r(self, key: str
-0002dcd0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0002dce0: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
-0002dcf0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-0002dd00: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
-0002dd10: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
-0002dd20: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
-0002dd30: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-0002dd40: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-0002dd50: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
-0002dd60: 6c66 2e75 6e72 756e 6e61 626c 650a 2020  lf.unrunnable.  
-0002dd70: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-0002dd80: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-0002dd90: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
-0002dda0: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
-0002ddb0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002ddc0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
-0002ddd0: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
-0002dde0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
-0002ddf0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
-0002de00: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
-0002de10: 7768 6f5f 6861 730a 0a20 2020 2064 6566  who_has..    def
-0002de20: 2076 616c 6964 6174 655f 6572 7265 6428   validate_erred(
-0002de30: 7365 6c66 2c20 6b65 793a 2073 7472 2920  self, key: str) 
-0002de40: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0002de50: 2074 733a 2054 6173 6b53 7461 7465 203d   ts: TaskState =
-0002de60: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-0002de70: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002de80: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-0002de90: 6d65 0a20 2020 2020 2020 2061 7373 6572  me.        asser
-0002dea0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-0002deb0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0002dec0: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
-0002ded0: 7565 7565 640a 0a20 2020 2064 6566 2076  ueued..    def v
-0002dee0: 616c 6964 6174 655f 6b65 7928 7365 6c66  alidate_key(self
-0002def0: 2c20 6b65 793a 2073 7472 2c20 7473 3a20  , key: str, ts: 
-0002df00: 5461 736b 5374 6174 6520 7c20 4e6f 6e65  TaskState | None
-0002df10: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
-0002df20: 3a0a 2020 2020 2020 2020 7472 793a 0a20  :.        try:. 
-0002df30: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002df40: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002df50: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-0002df60: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-0002df70: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-0002df80: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-0002df90: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0002dfa0: 6767 6572 2e64 6562 7567 2822 4b65 7920  gger.debug("Key 
-0002dfb0: 6c6f 7374 3a20 2573 222c 206b 6579 290a  lost: %s", key).
-0002dfc0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002dfd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002dfe0: 2020 7473 2e76 616c 6964 6174 6528 290a    ts.validate().
-0002dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e000: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002e010: 2020 2020 2020 2020 2066 756e 6320 3d20           func = 
-0002e020: 6765 7461 7474 7228 7365 6c66 2c20 2276  getattr(self, "v
-0002e030: 616c 6964 6174 655f 2220 2b20 7473 2e73  alidate_" + ts.s
-0002e040: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
-0002e050: 2c20 225f 2229 290a 2020 2020 2020 2020  , "_")).        
-0002e060: 2020 2020 2020 2020 6578 6365 7074 2041          except A
-0002e070: 7474 7269 6275 7465 4572 726f 723a 0a20  ttributeError:. 
-0002e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e090: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
-0002e0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e0b0: 2020 2020 2020 2020 2022 7365 6c66 2e76           "self.v
-0002e0c0: 616c 6964 6174 655f 2573 206e 6f74 2066  alidate_%s not f
-0002e0d0: 6f75 6e64 222c 2074 732e 7374 6174 652e  ound", ts.state.
-0002e0e0: 7265 706c 6163 6528 222d 222c 2022 5f22  replace("-", "_"
-0002e0f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002e100: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002e110: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002e120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e130: 2020 6675 6e63 286b 6579 290a 2020 2020    func(key).    
-0002e140: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0002e150: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-0002e160: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-0002e170: 6365 7074 696f 6e28 6529 0a20 2020 2020  ception(e).     
-0002e180: 2020 2020 2020 2069 6620 4c4f 475f 5044         if LOG_PD
-0002e190: 423a 0a20 2020 2020 2020 2020 2020 2020  B:.             
-0002e1a0: 2020 2069 6d70 6f72 7420 7064 620a 0a20     import pdb.. 
-0002e1b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002e1c0: 6462 2e73 6574 5f74 7261 6365 2829 0a20  db.set_trace(). 
-0002e1d0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-0002e1e0: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-0002e1f0: 7465 5f73 7461 7465 2873 656c 662c 2061  te_state(self, a
-0002e200: 6c6c 6f77 5f6f 7665 726c 6170 3a20 626f  llow_overlap: bo
-0002e210: 6f6c 203d 2046 616c 7365 2920 2d3e 204e  ol = False) -> N
-0002e220: 6f6e 653a 0a20 2020 2020 2020 2076 616c  one:.        val
-0002e230: 6964 6174 655f 7374 6174 6528 7365 6c66  idate_state(self
-0002e240: 2e74 6173 6b73 2c20 7365 6c66 2e77 6f72  .tasks, self.wor
-0002e250: 6b65 7273 2c20 7365 6c66 2e63 6c69 656e  kers, self.clien
-0002e260: 7473 290a 0a20 2020 2020 2020 2069 6620  ts)..        if 
-0002e270: 6e6f 7420 2873 6574 2873 656c 662e 776f  not (set(self.wo
-0002e280: 726b 6572 7329 203d 3d20 7365 7428 7365  rkers) == set(se
-0002e290: 6c66 2e73 7472 6561 6d5f 636f 6d6d 7329  lf.stream_comms)
-0002e2a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0002e2b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0002e2c0: 2257 6f72 6b65 7273 206e 6f74 2074 6865  "Workers not the
-0002e2d0: 2073 616d 6520 696e 2061 6c6c 2063 6f6c   same in all col
-0002e2e0: 6c65 6374 696f 6e73 2229 0a0a 2020 2020  lections")..    
-0002e2f0: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-0002e300: 7275 6e6e 696e 672e 6973 7375 7065 7273  running.issupers
-0002e310: 6574 2873 656c 662e 6964 6c65 2e76 616c  et(self.idle.val
-0002e320: 7565 7328 2929 2c20 280a 2020 2020 2020  ues()), (.      
-0002e330: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-0002e340: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-0002e350: 2020 2020 2020 2073 6574 2873 656c 662e         set(self.
-0002e360: 6964 6c65 2e76 616c 7565 7328 2929 2c0a  idle.values()),.
-0002e370: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0002e380: 2020 6173 7365 7274 2073 656c 662e 7275    assert self.ru
-0002e390: 6e6e 696e 672e 6973 7375 7065 7273 6574  nning.issuperset
-0002e3a0: 2873 656c 662e 6964 6c65 5f74 6173 6b5f  (self.idle_task_
-0002e3b0: 636f 756e 7429 2c20 280a 2020 2020 2020  count), (.      
-0002e3c0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
-0002e3d0: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
-0002e3e0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0002e3f0: 5f74 6173 6b5f 636f 756e 742e 636f 7079  _task_count.copy
-0002e400: 2829 2c0a 2020 2020 2020 2020 290a 2020  (),.        ).  
-0002e410: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0002e420: 662e 7275 6e6e 696e 672e 6973 7375 7065  f.running.issupe
-0002e430: 7273 6574 2873 656c 662e 7361 7475 7261  rset(self.satura
-0002e440: 7465 6429 2c20 280a 2020 2020 2020 2020  ted), (.        
-0002e450: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
-0002e460: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-0002e470: 2020 2020 2073 656c 662e 7361 7475 7261       self.satura
-0002e480: 7465 642e 636f 7079 2829 2c0a 2020 2020  ted.copy(),.    
-0002e490: 2020 2020 290a 2020 2020 2020 2020 6173      ).        as
-0002e4a0: 7365 7274 2073 656c 662e 7361 7475 7261  sert self.satura
-0002e4b0: 7465 642e 6973 6469 736a 6f69 6e74 2873  ted.isdisjoint(s
-0002e4c0: 656c 662e 6964 6c65 2e76 616c 7565 7328  elf.idle.values(
-0002e4d0: 2929 2c20 280a 2020 2020 2020 2020 2020  )), (.          
-0002e4e0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-0002e4f0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-0002e500: 2020 2020 2073 6574 2873 656c 662e 6964       set(self.id
-0002e510: 6c65 2e76 616c 7565 7328 2929 2c0a 2020  le.values()),.  
-0002e520: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0002e530: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
-0002e540: 6e74 733a 2064 6566 6175 6c74 6469 6374  nts: defaultdict
-0002e550: 5b73 7472 2c20 696e 745d 203d 2064 6566  [str, int] = def
-0002e560: 6175 6c74 6469 6374 2869 6e74 290a 2020  aultdict(int).  
-0002e570: 2020 2020 2020 666f 7220 772c 2077 7320        for w, ws 
-0002e580: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-0002e590: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0002e5a0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0002e5b0: 7374 616e 6365 2877 2c20 7374 7229 2c20  stance(w, str), 
-0002e5c0: 2874 7970 6528 7729 2c20 7729 0a20 2020  (type(w), w).   
-0002e5d0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002e5e0: 6973 696e 7374 616e 6365 2877 732c 2057  isinstance(ws, W
-0002e5f0: 6f72 6b65 7253 7461 7465 292c 2028 7479  orkerState), (ty
-0002e600: 7065 2877 7329 2c20 7773 290a 2020 2020  pe(ws), ws).    
-0002e610: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002e620: 732e 6164 6472 6573 7320 3d3d 2077 0a0a  s.address == w..
-0002e630: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-0002e640: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0002e650: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-0002e660: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002e670: 7274 2077 7320 696e 2073 656c 662e 7275  rt ws in self.ru
-0002e680: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002e690: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002e6a0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002e6b0: 7320 6e6f 7420 696e 2073 656c 662e 7275  s not in self.ru
-0002e6c0: 6e6e 696e 670a 2020 2020 2020 2020 2020  nning.          
-0002e6d0: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-0002e6e0: 6164 6472 6573 7320 6e6f 7420 696e 2073  address not in s
-0002e6f0: 656c 662e 6964 6c65 0a20 2020 2020 2020  elf.idle.       
-0002e700: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002e710: 7773 206e 6f74 2069 6e20 7365 6c66 2e73  ws not in self.s
-0002e720: 6174 7572 6174 6564 0a0a 2020 2020 2020  aturated..      
-0002e730: 2020 2020 2020 6173 7365 7274 2077 732e        assert ws.
-0002e740: 6c6f 6e67 5f72 756e 6e69 6e67 2e69 7373  long_running.iss
-0002e750: 7562 7365 7428 7773 2e70 726f 6365 7373  ubset(ws.process
-0002e760: 696e 6729 0a20 2020 2020 2020 2020 2020  ing).           
-0002e770: 2069 6620 6e6f 7420 7773 2e70 726f 6365   if not ws.proce
-0002e780: 7373 696e 673a 0a20 2020 2020 2020 2020  ssing:.         
-0002e790: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002e7a0: 7420 7773 2e6f 6363 7570 616e 6379 0a20  t ws.occupancy. 
-0002e7b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002e7c0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-0002e7d0: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-0002e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e7f0: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-0002e800: 7265 7373 2069 6e20 7365 6c66 2e69 646c  ress in self.idl
-0002e810: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-0002e820: 7365 7274 206e 6f74 2077 732e 6e65 6564  sert not ws.need
-0002e830: 735f 7768 6174 2e6b 6579 7328 2920 2620  s_what.keys() & 
-0002e840: 7773 2e68 6173 5f77 6861 740a 2020 2020  ws.has_what.    
-0002e850: 2020 2020 2020 2020 6163 7475 616c 5f6e          actual_n
-0002e860: 6565 6473 5f77 6861 743a 2064 6566 6175  eeds_what: defau
-0002e870: 6c74 6469 6374 5b54 6173 6b53 7461 7465  ltdict[TaskState
-0002e880: 2c20 696e 745d 203d 2064 6566 6175 6c74  , int] = default
-0002e890: 6469 6374 2869 6e74 290a 2020 2020 2020  dict(int).      
-0002e8a0: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0002e8b0: 7773 2e70 726f 6365 7373 696e 673a 0a20  ws.processing:. 
-0002e8c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002e8d0: 6f72 2074 7373 2069 6e20 7473 2e64 6570  or tss in ts.dep
-0002e8e0: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-0002e8f0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002e900: 6620 7473 7320 6e6f 7420 696e 2077 732e  f tss not in ws.
-0002e910: 6861 735f 7768 6174 3a0a 2020 2020 2020  has_what:.      
-0002e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e930: 2020 6163 7475 616c 5f6e 6565 6473 5f77    actual_needs_w
-0002e940: 6861 745b 7473 735d 202b 3d20 310a 2020  hat[tss] += 1.  
-0002e950: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002e960: 2061 6374 7561 6c5f 6e65 6564 735f 7768   actual_needs_wh
-0002e970: 6174 203d 3d20 7773 2e6e 6565 6473 5f77  at == ws.needs_w
-0002e980: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
-0002e990: 6173 7365 7274 2028 7773 2e73 7461 7475  assert (ws.statu
-0002e9a0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-0002e9b0: 696e 6729 203d 3d20 2877 7320 696e 2073  ing) == (ws in s
-0002e9c0: 656c 662e 7275 6e6e 696e 6729 0a20 2020  elf.running).   
-0002e9d0: 2020 2020 2020 2020 2066 6f72 206e 616d           for nam
-0002e9e0: 652c 2063 6f75 6e74 2069 6e20 7773 2e74  e, count in ws.t
-0002e9f0: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0002ea00: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0002ea10: 2020 2020 2020 2020 2020 7461 736b 5f70            task_p
-0002ea20: 7265 6669 785f 636f 756e 7473 5b6e 616d  refix_counts[nam
-0002ea30: 655d 202b 3d20 636f 756e 740a 0a20 2020  e] += count..   
-0002ea40: 2020 2020 2061 7373 6572 7420 7461 736b       assert task
-0002ea50: 5f70 7265 6669 785f 636f 756e 7473 2e6b  _prefix_counts.k
-0002ea60: 6579 7328 2920 3d3d 2073 656c 662e 5f74  eys() == self._t
-0002ea70: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-0002ea80: 5f67 6c6f 6261 6c2e 6b65 7973 2829 0a20  _global.keys(). 
-0002ea90: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
-0002eaa0: 2067 6c6f 6261 6c5f 636f 756e 7420 696e   global_count in
-0002eab0: 2073 656c 662e 5f74 6173 6b5f 7072 6566   self._task_pref
-0002eac0: 6978 5f63 6f75 6e74 5f67 6c6f 6261 6c2e  ix_count_global.
-0002ead0: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0002eae0: 2020 2020 2061 7373 6572 7420 280a 2020       assert (.  
-0002eaf0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-0002eb00: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
-0002eb10: 5b6e 616d 655d 203d 3d20 676c 6f62 616c  [name] == global
-0002eb20: 5f63 6f75 6e74 0a20 2020 2020 2020 2020  _count.         
-0002eb30: 2020 2029 2c20 6622 7b6e 616d 657d 3a20     ), f"{name}: 
-0002eb40: 7b74 6173 6b5f 7072 6566 6978 5f63 6f75  {task_prefix_cou
-0002eb50: 6e74 735b 6e61 6d65 5d7d 2028 7773 7329  nts[name]} (wss)
-0002eb60: 2c20 7b67 6c6f 6261 6c5f 636f 756e 747d  , {global_count}
-0002eb70: 2028 676c 6f62 616c 2922 0a0a 2020 2020   (global)"..    
-0002eb80: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-0002eb90: 6c66 2e72 756e 6e69 6e67 3a0a 2020 2020  lf.running:.    
-0002eba0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-0002ebb0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-0002ebc0: 7573 2e72 756e 6e69 6e67 0a20 2020 2020  us.running.     
-0002ebd0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-0002ebe0: 2e61 6464 7265 7373 2069 6e20 7365 6c66  .address in self
-0002ebf0: 2e77 6f72 6b65 7273 0a0a 2020 2020 2020  .workers..      
-0002ec00: 2020 666f 7220 6b2c 2074 7320 696e 2073    for k, ts in s
-0002ec10: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
-0002ec20: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-0002ec30: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0002ec40: 2874 732c 2054 6173 6b53 7461 7465 292c  (ts, TaskState),
-0002ec50: 2028 7479 7065 2874 7329 2c20 7473 290a   (type(ts), ts).
-0002ec60: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002ec70: 7274 2074 732e 6b65 7920 3d3d 206b 0a20  rt ts.key == k. 
-0002ec80: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002ec90: 7420 626f 6f6c 2874 7320 696e 2073 656c  t bool(ts in sel
-0002eca0: 662e 7265 706c 6963 6174 6564 5f74 6173  f.replicated_tas
-0002ecb0: 6b73 2920 3d3d 2028 6c65 6e28 7473 2e77  ks) == (len(ts.w
-0002ecc0: 686f 5f68 6173 2920 3e20 3129 0a20 2020  ho_has) > 1).   
-0002ecd0: 2020 2020 2020 2020 2073 656c 662e 7661           self.va
-0002ece0: 6c69 6461 7465 5f6b 6579 286b 2c20 7473  lidate_key(k, ts
-0002ecf0: 290a 0a20 2020 2020 2020 2066 6f72 2074  )..        for t
-0002ed00: 7320 696e 2073 656c 662e 7265 706c 6963  s in self.replic
-0002ed10: 6174 6564 5f74 6173 6b73 3a0a 2020 2020  ated_tasks:.    
-0002ed20: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0002ed30: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
-0002ed40: 7279 220a 2020 2020 2020 2020 2020 2020  ry".            
-0002ed50: 6173 7365 7274 2074 732e 6b65 7920 696e  assert ts.key in
-0002ed60: 2073 656c 662e 7461 736b 730a 0a20 2020   self.tasks..   
-0002ed70: 2020 2020 2066 6f72 2063 2c20 6373 2069       for c, cs i
-0002ed80: 6e20 7365 6c66 2e63 6c69 656e 7473 2e69  n self.clients.i
-0002ed90: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0002eda0: 2020 2020 2320 636c 6965 6e74 3d4e 6f6e      # client=Non
-0002edb0: 6520 6973 206f 6674 656e 2075 7365 6420  e is often used 
-0002edc0: 696e 2074 6573 7473 2e2e 2e0a 2020 2020  in tests....    
-0002edd0: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-0002ede0: 2069 7320 4e6f 6e65 206f 7220 7479 7065   is None or type
-0002edf0: 2863 2920 3d3d 2073 7472 2c20 2874 7970  (c) == str, (typ
-0002ee00: 6528 6329 2c20 6329 0a20 2020 2020 2020  e(c), c).       
-0002ee10: 2020 2020 2061 7373 6572 7420 7479 7065       assert type
-0002ee20: 2863 7329 203d 3d20 436c 6965 6e74 5374  (cs) == ClientSt
-0002ee30: 6174 652c 2028 7479 7065 2863 7329 2c20  ate, (type(cs), 
-0002ee40: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
-0002ee50: 6173 7365 7274 2063 732e 636c 6965 6e74  assert cs.client
-0002ee60: 5f6b 6579 203d 3d20 630a 0a20 2020 2020  _key == c..     
-0002ee70: 2020 2061 203d 207b 773a 2077 732e 6e62     a = {w: ws.nb
-0002ee80: 7974 6573 2066 6f72 2077 2c20 7773 2069  ytes for w, ws i
-0002ee90: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e69  n self.workers.i
-0002eea0: 7465 6d73 2829 7d0a 2020 2020 2020 2020  tems()}.        
-0002eeb0: 6220 3d20 7b0a 2020 2020 2020 2020 2020  b = {.          
-0002eec0: 2020 773a 2073 756d 2874 732e 6765 745f    w: sum(ts.get_
-0002eed0: 6e62 7974 6573 2829 2066 6f72 2074 7320  nbytes() for ts 
-0002eee0: 696e 2077 732e 6861 735f 7768 6174 290a  in ws.has_what).
-0002eef0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002ef00: 772c 2077 7320 696e 2073 656c 662e 776f  w, ws in self.wo
-0002ef10: 726b 6572 732e 6974 656d 7328 290a 2020  rkers.items().  
-0002ef20: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0002ef30: 6173 7365 7274 2061 203d 3d20 622c 2028  assert a == b, (
-0002ef40: 612c 2062 290a 0a20 2020 2020 2020 2069  a, b)..        i
-0002ef50: 6620 7365 6c66 2e74 7261 6e73 6974 696f  f self.transitio
-0002ef60: 6e5f 636f 756e 7465 725f 6d61 783a 0a20  n_counter_max:. 
-0002ef70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0002ef80: 7420 7365 6c66 2e74 7261 6e73 6974 696f  t self.transitio
-0002ef90: 6e5f 636f 756e 7465 7220 3c20 7365 6c66  n_counter < self
-0002efa0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
-0002efb0: 7465 725f 6d61 780a 0a20 2020 2023 2323  ter_max..    ###
-0002efc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002efd0: 0a20 2020 2023 204d 616e 6167 6520 4d65  .    # Manage Me
-0002efe0: 7373 6167 6573 2023 0a20 2020 2023 2323  ssages #.    ###
-0002eff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002f000: 0a0a 2020 2020 6465 6620 7265 706f 7274  ..    def report
-0002f010: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0002f020: 6d73 673a 2064 6963 742c 2074 733a 2054  msg: dict, ts: T
-0002f030: 6173 6b53 7461 7465 207c 204e 6f6e 6520  askState | None 
-0002f040: 3d20 4e6f 6e65 2c20 636c 6965 6e74 3a20  = None, client: 
-0002f050: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0002f060: 650a 2020 2020 2920 2d3e 204e 6f6e 653a  e.    ) -> None:
-0002f070: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0002f080: 2020 2020 2050 7562 6c69 7368 2075 7064       Publish upd
-0002f090: 6174 6573 2074 6f20 616c 6c20 6c69 7374  ates to all list
-0002f0a0: 656e 696e 6720 5175 6575 6573 2061 6e64  ening Queues and
-0002f0b0: 2043 6f6d 6d73 0a0a 2020 2020 2020 2020   Comms..        
-0002f0c0: 4966 2074 6865 206d 6573 7361 6765 2063  If the message c
-0002f0d0: 6f6e 7461 696e 7320 6120 6b65 7920 7468  ontains a key th
-0002f0e0: 656e 2077 6520 6f6e 6c79 2073 656e 6420  en we only send 
-0002f0f0: 7468 6520 6d65 7373 6167 6520 746f 2074  the message to t
-0002f100: 686f 7365 0a20 2020 2020 2020 2063 6f6d  hose.        com
-0002f110: 6d73 2074 6861 7420 6361 7265 2061 626f  ms that care abo
-0002f120: 7574 2074 6865 206b 6579 2e0a 2020 2020  ut the key..    
-0002f130: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002f140: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
-0002f150: 2020 2020 2020 2020 2020 206d 7367 5f6b             msg_k
-0002f160: 6579 203d 206d 7367 2e67 6574 2822 6b65  ey = msg.get("ke
-0002f170: 7922 290a 2020 2020 2020 2020 2020 2020  y").            
-0002f180: 6966 206d 7367 5f6b 6579 2069 7320 6e6f  if msg_key is no
-0002f190: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0002f1a0: 2020 2020 2020 2020 7461 736b 733a 2064          tasks: d
-0002f1b0: 6963 7420 3d20 7365 6c66 2e74 6173 6b73  ict = self.tasks
-0002f1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f1d0: 2074 7320 3d20 7461 736b 732e 6765 7428   ts = tasks.get(
-0002f1e0: 6d73 675f 6b65 7929 0a0a 2020 2020 2020  msg_key)..      
-0002f1f0: 2020 636c 6965 6e74 5f63 6f6d 6d73 3a20    client_comms: 
-0002f200: 6469 6374 203d 2073 656c 662e 636c 6965  dict = self.clie
-0002f210: 6e74 5f63 6f6d 6d73 0a20 2020 2020 2020  nt_comms.       
-0002f220: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
-0002f230: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-0002f240: 7469 6679 2061 6c6c 2063 6c69 656e 7473  tify all clients
-0002f250: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0002f260: 656e 745f 6b65 7973 203d 206c 6973 7428  ent_keys = list(
-0002f270: 636c 6965 6e74 5f63 6f6d 6d73 290a 2020  client_comms).  
-0002f280: 2020 2020 2020 656c 6966 2063 6c69 656e        elif clien
-0002f290: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
-0002f2a0: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
-0002f2b0: 636c 6965 6e74 7320 696e 7465 7265 7374  clients interest
-0002f2c0: 6564 2069 6e20 6b65 790a 2020 2020 2020  ed in key.      
-0002f2d0: 2020 2020 2020 636c 6965 6e74 5f6b 6579        client_key
-0002f2e0: 7320 3d20 5b63 732e 636c 6965 6e74 5f6b  s = [cs.client_k
-0002f2f0: 6579 2066 6f72 2063 7320 696e 2074 732e  ey for cs in ts.
-0002f300: 7768 6f5f 7761 6e74 735d 0a20 2020 2020  who_wants].     
-0002f310: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002f320: 2020 2020 2023 204e 6f74 6966 7920 636c       # Notify cl
-0002f330: 6965 6e74 7320 696e 7465 7265 7374 6564  ients interested
-0002f340: 2069 6e20 6b65 7920 2869 6e63 6c75 6469   in key (includi
-0002f350: 6e67 2060 636c 6965 6e74 6029 0a20 2020  ng `client`).   
-0002f360: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-0002f370: 6b65 7973 203d 205b 0a20 2020 2020 2020  keys = [.       
-0002f380: 2020 2020 2020 2020 2063 732e 636c 6965           cs.clie
-0002f390: 6e74 5f6b 6579 2066 6f72 2063 7320 696e  nt_key for cs in
-0002f3a0: 2074 732e 7768 6f5f 7761 6e74 7320 6966   ts.who_wants if
-0002f3b0: 2063 732e 636c 6965 6e74 5f6b 6579 2021   cs.client_key !
-0002f3c0: 3d20 636c 6965 6e74 0a20 2020 2020 2020  = client.       
-0002f3d0: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
-0002f3e0: 2020 2063 6c69 656e 745f 6b65 7973 2e61     client_keys.a
-0002f3f0: 7070 656e 6428 636c 6965 6e74 290a 0a20  ppend(client).. 
-0002f400: 2020 2020 2020 206b 3a20 7374 720a 2020         k: str.  
-0002f410: 2020 2020 2020 666f 7220 6b20 696e 2063        for k in c
-0002f420: 6c69 656e 745f 6b65 7973 3a0a 2020 2020  lient_keys:.    
-0002f430: 2020 2020 2020 2020 6320 3d20 636c 6965          c = clie
-0002f440: 6e74 5f63 6f6d 6d73 2e67 6574 286b 290a  nt_comms.get(k).
-0002f450: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-0002f460: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0002f470: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-0002f480: 7565 0a20 2020 2020 2020 2020 2020 2074  ue.            t
-0002f490: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002f4a0: 2020 2020 632e 7365 6e64 286d 7367 290a      c.send(msg).
-0002f4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4c0: 2320 6c6f 6767 6572 2e64 6562 7567 2822  # logger.debug("
-0002f4d0: 5363 6865 6475 6c65 7220 7365 6e64 7320  Scheduler sends 
-0002f4e0: 6d65 7373 6167 6520 746f 2063 6c69 656e  message to clien
-0002f4f0: 7420 2573 222c 206d 7367 290a 2020 2020  t %s", msg).    
-0002f500: 2020 2020 2020 2020 6578 6365 7074 2043          except C
-0002f510: 6f6d 6d43 6c6f 7365 6445 7272 6f72 3a0a  ommClosedError:.
-0002f520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f530: 6966 2073 656c 662e 7374 6174 7573 203d  if self.status =
-0002f540: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-0002f550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002f560: 2020 2020 2020 6c6f 6767 6572 2e63 7269        logger.cri
-0002f570: 7469 6361 6c28 0a20 2020 2020 2020 2020  tical(.         
-0002f580: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002f590: 436c 6f73 6564 2063 6f6d 6d20 2572 2077  Closed comm %r w
-0002f5a0: 6869 6c65 2074 7279 696e 6720 746f 2077  hile trying to w
-0002f5b0: 7269 7465 2025 7322 2c20 632c 206d 7367  rite %s", c, msg
-0002f5c0: 2c20 6578 635f 696e 666f 3d54 7275 650a  , exc_info=True.
-0002f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f5e0: 2020 2020 290a 0a20 2020 2061 7379 6e63      )..    async
-0002f5f0: 2064 6566 2061 6464 5f63 6c69 656e 7428   def add_client(
-0002f600: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
-0002f610: 6f6d 6d3a 2043 6f6d 6d2c 2063 6c69 656e  omm: Comm, clien
-0002f620: 743a 2073 7472 2c20 7665 7273 696f 6e73  t: str, versions
-0002f630: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-0002f640: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-0002f650: 2020 2020 2020 2020 2222 2241 6464 2063          """Add c
-0002f660: 6c69 656e 7420 746f 206e 6574 776f 726b  lient to network
-0002f670: 0a0a 2020 2020 2020 2020 5765 206c 6973  ..        We lis
-0002f680: 7465 6e20 746f 2061 6c6c 2066 7574 7572  ten to all futur
-0002f690: 6520 6d65 7373 6167 6573 2066 726f 6d20  e messages from 
-0002f6a0: 7468 6973 2043 6f6d 6d2e 0a20 2020 2020  this Comm..     
-0002f6b0: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
-0002f6c0: 7373 6572 7420 636c 6965 6e74 2069 7320  ssert client is 
-0002f6d0: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-0002f6e0: 2063 6f6d 6d2e 6e61 6d65 203d 2022 5363   comm.name = "Sc
-0002f6f0: 6865 6475 6c65 722d 3e43 6c69 656e 7422  heduler->Client"
-0002f700: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-0002f710: 696e 666f 2822 5265 6365 6976 6520 636c  info("Receive cl
-0002f720: 6965 6e74 2063 6f6e 6e65 6374 696f 6e3a  ient connection:
-0002f730: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
-0002f740: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-0002f750: 7665 6e74 285b 2261 6c6c 222c 2063 6c69  vent(["all", cli
-0002f760: 656e 745d 2c20 7b22 6163 7469 6f6e 223a  ent], {"action":
-0002f770: 2022 6164 642d 636c 6965 6e74 222c 2022   "add-client", "
-0002f780: 636c 6965 6e74 223a 2063 6c69 656e 747d  client": client}
-0002f790: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0002f7a0: 6c69 656e 7473 5b63 6c69 656e 745d 203d  lients[client] =
-0002f7b0: 2043 6c69 656e 7453 7461 7465 2863 6c69   ClientState(cli
-0002f7c0: 656e 742c 2076 6572 7369 6f6e 733d 7665  ent, versions=ve
-0002f7d0: 7273 696f 6e73 290a 0a20 2020 2020 2020  rsions)..       
-0002f7e0: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
-0002f7f0: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
-0002f800: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
-0002f810: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002f820: 2020 2020 2020 2020 2020 2020 2070 6c75               plu
-0002f830: 6769 6e2e 6164 645f 636c 6965 6e74 2873  gin.add_client(s
-0002f840: 6368 6564 756c 6572 3d73 656c 662c 2063  cheduler=self, c
-0002f850: 6c69 656e 743d 636c 6965 6e74 290a 2020  lient=client).  
-0002f860: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0002f870: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-0002f880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f890: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
-0002f8a0: 6e28 6529 0a0a 2020 2020 2020 2020 7472  n(e)..        tr
-0002f8b0: 793a 0a20 2020 2020 2020 2020 2020 2062  y:.            b
-0002f8c0: 636f 6d6d 203d 2042 6174 6368 6564 5365  comm = BatchedSe
-0002f8d0: 6e64 2869 6e74 6572 7661 6c3d 2232 6d73  nd(interval="2ms
-0002f8e0: 222c 206c 6f6f 703d 7365 6c66 2e6c 6f6f  ", loop=self.loo
-0002f8f0: 7029 0a20 2020 2020 2020 2020 2020 2062  p).            b
-0002f900: 636f 6d6d 2e73 7461 7274 2863 6f6d 6d29  comm.start(comm)
-0002f910: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002f920: 662e 636c 6965 6e74 5f63 6f6d 6d73 5b63  f.client_comms[c
-0002f930: 6c69 656e 745d 203d 2062 636f 6d6d 0a20  lient] = bcomm. 
-0002f940: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-0002f950: 207b 226f 7022 3a20 2273 7472 6561 6d2d   {"op": "stream-
-0002f960: 7374 6172 7422 7d0a 2020 2020 2020 2020  start"}.        
-0002f970: 2020 2020 7665 7273 696f 6e5f 7761 726e      version_warn
-0002f980: 696e 6720 3d20 7665 7273 696f 6e5f 6d6f  ing = version_mo
-0002f990: 6475 6c65 2e65 7272 6f72 5f6d 6573 7361  dule.error_messa
-0002f9a0: 6765 280a 2020 2020 2020 2020 2020 2020  ge(.            
-0002f9b0: 2020 2020 7665 7273 696f 6e5f 6d6f 6475      version_modu
-0002f9c0: 6c65 2e67 6574 5f76 6572 7369 6f6e 7328  le.get_versions(
-0002f9d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-0002f9e0: 2020 207b 773a 2077 732e 7665 7273 696f     {w: ws.versio
-0002f9f0: 6e73 2066 6f72 2077 2c20 7773 2069 6e20  ns for w, ws in 
-0002fa00: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
-0002fa10: 6d73 2829 7d2c 0a20 2020 2020 2020 2020  ms()},.         
-0002fa20: 2020 2020 2020 2076 6572 7369 6f6e 732c         versions,
-0002fa30: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0002fa40: 2020 2020 2020 2020 2020 206d 7367 2e75             msg.u
-0002fa50: 7064 6174 6528 7665 7273 696f 6e5f 7761  pdate(version_wa
-0002fa60: 726e 696e 6729 0a20 2020 2020 2020 2020  rning).         
-0002fa70: 2020 2062 636f 6d6d 2e73 656e 6428 6d73     bcomm.send(ms
-0002fa80: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
-0002fa90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002faa0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-0002fab0: 6861 6e64 6c65 5f73 7472 6561 6d28 636f  handle_stream(co
-0002fac0: 6d6d 3d63 6f6d 6d2c 2065 7874 7261 3d7b  mm=comm, extra={
-0002fad0: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
-0002fae0: 7d29 0a20 2020 2020 2020 2020 2020 2066  }).            f
-0002faf0: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
-0002fb00: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-0002fb10: 6f76 655f 636c 6965 6e74 2863 6c69 656e  ove_client(clien
-0002fb20: 743d 636c 6965 6e74 2c20 7374 696d 756c  t=client, stimul
-0002fb30: 7573 5f69 643d 6622 7265 6d6f 7665 2d63  us_id=f"remove-c
-0002fb40: 6c69 656e 742d 7b74 696d 6528 297d 2229  lient-{time()}")
-0002fb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fb60: 206c 6f67 6765 722e 6465 6275 6728 2246   logger.debug("F
-0002fb70: 696e 6973 6865 6420 6861 6e64 6c69 6e67  inished handling
-0002fb80: 2063 6c69 656e 7420 2573 222c 2063 6c69   client %s", cli
-0002fb90: 656e 7429 0a20 2020 2020 2020 2066 696e  ent).        fin
-0002fba0: 616c 6c79 3a0a 2020 2020 2020 2020 2020  ally:.          
-0002fbb0: 2020 6966 206e 6f74 2063 6f6d 6d2e 636c    if not comm.cl
-0002fbc0: 6f73 6564 2829 3a0a 2020 2020 2020 2020  osed():.        
-0002fbd0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002fbe0: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
-0002fbf0: 5d2e 7365 6e64 287b 226f 7022 3a20 2273  ].send({"op": "s
-0002fc00: 7472 6561 6d2d 636c 6f73 6564 227d 290a  tream-closed"}).
-0002fc10: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0002fc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fc30: 2069 6620 6e6f 7420 7379 732e 6973 5f66   if not sys.is_f
-0002fc40: 696e 616c 697a 696e 6728 293a 0a20 2020  inalizing():.   
-0002fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fc60: 2061 7761 6974 2073 656c 662e 636c 6965   await self.clie
-0002fc70: 6e74 5f63 6f6d 6d73 5b63 6c69 656e 745d  nt_comms[client]
-0002fc80: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
-0002fc90: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0002fca0: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-0002fcb0: 6d73 5b63 6c69 656e 745d 0a20 2020 2020  ms[client].     
-0002fcc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002fcd0: 6620 7365 6c66 2e73 7461 7475 7320 3d3d  f self.status ==
-0002fce0: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-0002fcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fd00: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002fd10: 696e 666f 2822 436c 6f73 6520 636c 6965  info("Close clie
-0002fd20: 6e74 2063 6f6e 6e65 6374 696f 6e3a 2025  nt connection: %
-0002fd30: 7322 2c20 636c 6965 6e74 290a 2020 2020  s", client).    
-0002fd40: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0002fd50: 7970 6545 7272 6f72 3a20 2023 2063 6f6d  ypeError:  # com
-0002fd60: 6d20 6265 636f 6d65 7320 4e6f 6e65 2064  m becomes None d
-0002fd70: 7572 696e 6720 4743 0a20 2020 2020 2020  uring GC.       
-0002fd80: 2020 2020 2020 2020 2070 6173 730a 0a20           pass.. 
-0002fd90: 2020 2064 6566 2072 656d 6f76 655f 636c     def remove_cl
-0002fda0: 6965 6e74 2873 656c 662c 2063 6c69 656e  ient(self, clien
-0002fdb0: 743a 2073 7472 2c20 7374 696d 756c 7573  t: str, stimulus
-0002fdc0: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
-0002fdd0: 3d20 4e6f 6e65 2920 2d3e 204e 6f6e 653a  = None) -> None:
-0002fde0: 0a20 2020 2020 2020 2022 2222 5265 6d6f  .        """Remo
-0002fdf0: 7665 2063 6c69 656e 7420 6672 6f6d 206e  ve client from n
-0002fe00: 6574 776f 726b 2222 220a 2020 2020 2020  etwork""".      
-0002fe10: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-0002fe20: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-0002fe30: 2272 656d 6f76 652d 636c 6965 6e74 2d7b  "remove-client-{
-0002fe40: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
-0002fe50: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
-0002fe60: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
-0002fe70: 673a 0a20 2020 2020 2020 2020 2020 206c  g:.            l
-0002fe80: 6f67 6765 722e 696e 666f 2822 5265 6d6f  ogger.info("Remo
-0002fe90: 7665 2063 6c69 656e 7420 2573 222c 2063  ve client %s", c
-0002fea0: 6c69 656e 7429 0a20 2020 2020 2020 2073  lient).        s
-0002feb0: 656c 662e 6c6f 675f 6576 656e 7428 5b22  elf.log_event(["
-0002fec0: 616c 6c22 2c20 636c 6965 6e74 5d2c 207b  all", client], {
-0002fed0: 2261 6374 696f 6e22 3a20 2272 656d 6f76  "action": "remov
-0002fee0: 652d 636c 6965 6e74 222c 2022 636c 6965  e-client", "clie
-0002fef0: 6e74 223a 2063 6c69 656e 747d 290a 2020  nt": client}).  
-0002ff00: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002ff10: 2020 2020 2020 2063 733a 2043 6c69 656e         cs: Clien
-0002ff20: 7453 7461 7465 203d 2073 656c 662e 636c  tState = self.cl
-0002ff30: 6965 6e74 735b 636c 6965 6e74 5d0a 2020  ients[client].  
-0002ff40: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-0002ff50: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0002ff60: 2020 2023 2058 5858 2069 7320 7468 6973     # XXX is this
-0002ff70: 2061 206c 6567 6974 696d 6174 6520 636f   a legitimate co
-0002ff80: 6e64 6974 696f 6e3f 0a20 2020 2020 2020  ndition?.       
-0002ff90: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-0002ffa0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002ffb0: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
-0002ffc0: 7265 6c65 6173 6573 5f6b 6579 7328 0a20  releases_keys(. 
-0002ffd0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-0002ffe0: 6579 733d 5b74 732e 6b65 7920 666f 7220  eys=[ts.key for 
-0002fff0: 7473 2069 6e20 6373 2e77 616e 7473 5f77  ts in cs.wants_w
-00030000: 6861 745d 2c0a 2020 2020 2020 2020 2020  hat],.          
-00030010: 2020 2020 2020 636c 6965 6e74 3d63 732e        client=cs.
-00030020: 636c 6965 6e74 5f6b 6579 2c0a 2020 2020  client_key,.    
-00030030: 2020 2020 2020 2020 2020 2020 7374 696d              stim
-00030040: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00030050: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-00030060: 2029 0a20 2020 2020 2020 2020 2020 2064   ).            d
-00030070: 656c 2073 656c 662e 636c 6965 6e74 735b  el self.clients[
-00030080: 636c 6965 6e74 5d0a 0a20 2020 2020 2020  client]..       
-00030090: 2020 2020 2066 6f72 2070 6c75 6769 6e20       for plugin 
-000300a0: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
-000300b0: 6769 6e73 2e76 616c 7565 7328 2929 3a0a  gins.values()):.
-000300c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300d0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000300e0: 2020 2020 2020 2020 2070 6c75 6769 6e2e           plugin.
-000300f0: 7265 6d6f 7665 5f63 6c69 656e 7428 7363  remove_client(sc
-00030100: 6865 6475 6c65 723d 7365 6c66 2c20 636c  heduler=self, cl
-00030110: 6965 6e74 3d63 6c69 656e 7429 0a20 2020  ient=client).   
-00030120: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00030130: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-00030140: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-00030150: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00030160: 7863 6570 7469 6f6e 2865 290a 0a20 2020  xception(e)..   
-00030170: 2020 2020 2061 7379 6e63 2064 6566 2072       async def r
-00030180: 656d 6f76 655f 636c 6965 6e74 5f66 726f  emove_client_fro
-00030190: 6d5f 6576 656e 7473 2829 3a0a 2020 2020  m_events():.    
-000301a0: 2020 2020 2020 2020 2320 4966 2074 6865          # If the
-000301b0: 2063 6c69 656e 7420 6973 6e27 7420 7265   client isn't re
-000301c0: 6769 7374 6572 6564 2061 6e79 6d6f 7265  gistered anymore
-000301d0: 2061 6674 6572 2074 6865 2064 656c 6179   after the delay
-000301e0: 2c20 7265 6d6f 7665 2066 726f 6d20 6576  , remove from ev
-000301f0: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
-00030200: 2069 6620 636c 6965 6e74 206e 6f74 2069   if client not i
-00030210: 6e20 7365 6c66 2e63 6c69 656e 7473 2061  n self.clients a
-00030220: 6e64 2063 6c69 656e 7420 696e 2073 656c  nd client in sel
-00030230: 662e 6576 656e 7473 3a0a 2020 2020 2020  f.events:.      
-00030240: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
-00030250: 6c66 2e65 7665 6e74 735b 636c 6965 6e74  lf.events[client
-00030260: 5d0a 0a20 2020 2020 2020 2063 6c65 616e  ]..        clean
-00030270: 7570 5f64 656c 6179 203d 2070 6172 7365  up_delay = parse
-00030280: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
-00030290: 2020 2020 2020 2020 6461 736b 2e63 6f6e          dask.con
-000302a0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-000302b0: 7574 6564 2e73 6368 6564 756c 6572 2e65  uted.scheduler.e
-000302c0: 7665 6e74 732d 636c 6561 6e75 702d 6465  vents-cleanup-de
-000302d0: 6c61 7922 290a 2020 2020 2020 2020 290a  lay").        ).
-000302e0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-000302f0: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-00030300: 6b67 726f 756e 645f 7461 736b 732e 636c  kground_tasks.cl
-00030310: 6f73 6564 3a0a 2020 2020 2020 2020 2020  osed:.          
-00030320: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
-00030330: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
-00030340: 2e63 616c 6c5f 6c61 7465 7228 0a20 2020  .call_later(.   
-00030350: 2020 2020 2020 2020 2020 2020 2063 6c65               cle
-00030360: 616e 7570 5f64 656c 6179 2c20 7265 6d6f  anup_delay, remo
-00030370: 7665 5f63 6c69 656e 745f 6672 6f6d 5f65  ve_client_from_e
-00030380: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
-00030390: 2020 290a 0a20 2020 2064 6566 2073 656e    )..    def sen
-000303a0: 645f 7461 736b 5f74 6f5f 776f 726b 6572  d_task_to_worker
-000303b0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-000303c0: 776f 726b 6572 3a20 7374 722c 2074 733a  worker: str, ts:
-000303d0: 2054 6173 6b53 7461 7465 2c20 6475 7261   TaskState, dura
-000303e0: 7469 6f6e 3a20 666c 6f61 7420 3d20 2d31  tion: float = -1
-000303f0: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00030400: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
-00030410: 6120 7369 6e67 6c65 2063 6f6d 7075 7461  a single computa
-00030420: 7469 6f6e 616c 2074 6173 6b20 746f 2061  tional task to a
-00030430: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
-00030440: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00030450: 2020 2020 6d73 673a 2064 6963 7420 3d20      msg: dict = 
-00030460: 7365 6c66 2e5f 7461 736b 5f74 6f5f 6d73  self._task_to_ms
-00030470: 6728 7473 2c20 6475 7261 7469 6f6e 290a  g(ts, duration).
-00030480: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00030490: 2e77 6f72 6b65 725f 7365 6e64 2877 6f72  .worker_send(wor
-000304a0: 6b65 722c 206d 7367 290a 2020 2020 2020  ker, msg).      
-000304b0: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-000304c0: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-000304d0: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
-000304e0: 7074 696f 6e28 6529 0a20 2020 2020 2020  ption(e).       
-000304f0: 2020 2020 2069 6620 4c4f 475f 5044 423a       if LOG_PDB:
-00030500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030510: 2069 6d70 6f72 7420 7064 620a 0a20 2020   import pdb..   
-00030520: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
-00030530: 2e73 6574 5f74 7261 6365 2829 0a20 2020  .set_trace().   
-00030540: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-00030550: 2020 2020 6465 6620 6861 6e64 6c65 5f75      def handle_u
-00030560: 6e63 6175 6768 745f 6572 726f 7228 7365  ncaught_error(se
-00030570: 6c66 2c20 2a2a 6d73 673a 2041 6e79 2920  lf, **msg: Any) 
-00030580: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00030590: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
-000305a0: 6e28 636c 6561 6e5f 6578 6365 7074 696f  n(clean_exceptio
-000305b0: 6e28 2a2a 6d73 6729 5b31 5d29 0a0a 2020  n(**msg)[1])..  
-000305c0: 2020 6465 6620 6861 6e64 6c65 5f74 6173    def handle_tas
-000305d0: 6b5f 6669 6e69 7368 6564 280a 2020 2020  k_finished(.    
-000305e0: 2020 2020 7365 6c66 2c20 6b65 793a 2073      self, key: s
-000305f0: 7472 2c20 776f 726b 6572 3a20 7374 722c  tr, worker: str,
-00030600: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00030610: 722c 202a 2a6d 7367 3a20 416e 790a 2020  r, **msg: Any.  
-00030620: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
-00030630: 2020 2020 2069 6620 776f 726b 6572 206e       if worker n
-00030640: 6f74 2069 6e20 7365 6c66 2e77 6f72 6b65  ot in self.worke
-00030650: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00030660: 7265 7475 726e 0a20 2020 2020 2020 2076  return.        v
-00030670: 616c 6964 6174 655f 6b65 7928 6b65 7929  alidate_key(key)
-00030680: 0a0a 2020 2020 2020 2020 723a 2074 7570  ..        r: tup
-00030690: 6c65 203d 2073 656c 662e 7374 696d 756c  le = self.stimul
-000306a0: 7573 5f74 6173 6b5f 6669 6e69 7368 6564  us_task_finished
-000306b0: 280a 2020 2020 2020 2020 2020 2020 6b65  (.            ke
-000306c0: 793d 6b65 792c 2077 6f72 6b65 723d 776f  y=key, worker=wo
-000306d0: 726b 6572 2c20 7374 696d 756c 7573 5f69  rker, stimulus_i
-000306e0: 643d 7374 696d 756c 7573 5f69 642c 202a  d=stimulus_id, *
-000306f0: 2a6d 7367 0a20 2020 2020 2020 2029 0a20  *msg.        ). 
-00030700: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00030710: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00030720: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00030730: 203d 2072 0a20 2020 2020 2020 2073 656c   = r.        sel
-00030740: 662e 5f74 7261 6e73 6974 696f 6e73 2872  f._transitions(r
-00030750: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00030760: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-00030770: 6b65 725f 6d73 6773 2c20 7374 696d 756c  ker_msgs, stimul
-00030780: 7573 5f69 6429 0a20 2020 2020 2020 2073  us_id).        s
-00030790: 656c 662e 7365 6e64 5f61 6c6c 2863 6c69  elf.send_all(cli
-000307a0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-000307b0: 5f6d 7367 7329 0a0a 2020 2020 2020 2020  _msgs)..        
-000307c0: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
-000307d0: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
-000307e0: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
-000307f0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00030800: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-00030810: 7461 736b 5f65 7272 6564 2873 656c 662c  task_erred(self,
-00030820: 206b 6579 3a20 7374 722c 2073 7469 6d75   key: str, stimu
-00030830: 6c75 735f 6964 3a20 7374 722c 202a 2a6d  lus_id: str, **m
-00030840: 7367 3a20 416e 7929 202d 3e20 4e6f 6e65  sg: Any) -> None
-00030850: 3a0a 2020 2020 2020 2020 723a 2074 7570  :.        r: tup
-00030860: 6c65 203d 2073 656c 662e 7374 696d 756c  le = self.stimul
-00030870: 7573 5f74 6173 6b5f 6572 7265 6428 6b65  us_task_erred(ke
-00030880: 793d 6b65 792c 2073 7469 6d75 6c75 735f  y=key, stimulus_
-00030890: 6964 3d73 7469 6d75 6c75 735f 6964 2c20  id=stimulus_id, 
-000308a0: 2a2a 6d73 6729 0a20 2020 2020 2020 2072  **msg).        r
-000308b0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-000308c0: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-000308d0: 6b65 725f 6d73 6773 203d 2072 0a20 2020  ker_msgs = r.   
-000308e0: 2020 2020 2073 656c 662e 5f74 7261 6e73       self._trans
-000308f0: 6974 696f 6e73 2872 6563 6f6d 6d65 6e64  itions(recommend
-00030900: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
-00030910: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
-00030920: 2c20 7374 696d 756c 7573 5f69 6429 0a20  , stimulus_id). 
-00030930: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
-00030940: 5f61 6c6c 2863 6c69 656e 745f 6d73 6773  _all(client_msgs
-00030950: 2c20 776f 726b 6572 5f6d 7367 7329 0a0a  , worker_msgs)..
-00030960: 2020 2020 2020 2020 7365 6c66 2e73 7469          self.sti
-00030970: 6d75 6c75 735f 7175 6575 655f 736c 6f74  mulus_queue_slot
-00030980: 735f 6d61 7962 655f 6f70 656e 6564 2873  s_maybe_opened(s
-00030990: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-000309a0: 6c75 735f 6964 290a 0a20 2020 2064 6566  lus_id)..    def
-000309b0: 2072 656c 6561 7365 5f77 6f72 6b65 725f   release_worker_
-000309c0: 6461 7461 2873 656c 662c 206b 6579 3a20  data(self, key: 
-000309d0: 7374 722c 2077 6f72 6b65 723a 2073 7472  str, worker: str
-000309e0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-000309f0: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-00030a00: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00030a10: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-00030a20: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00030a30: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
-00030a40: 6572 290a 2020 2020 2020 2020 6966 206e  er).        if n
-00030a50: 6f74 2074 7320 6f72 206e 6f74 2077 7320  ot ts or not ws 
-00030a60: 6f72 2077 7320 6e6f 7420 696e 2074 732e  or ws not in ts.
-00030a70: 7768 6f5f 6861 733a 0a20 2020 2020 2020  who_has:.       
-00030a80: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00030a90: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
-00030aa0: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
-00030ab0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00030ac0: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-00030ad0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-00030ae0: 6e73 6974 696f 6e73 287b 6b65 793a 2022  nsitions({key: "
-00030af0: 7265 6c65 6173 6564 227d 2c20 7374 696d  released"}, stim
-00030b00: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
-00030b10: 6620 6861 6e64 6c65 5f6c 6f6e 675f 7275  f handle_long_ru
-00030b20: 6e6e 696e 6728 0a20 2020 2020 2020 2073  nning(.        s
-00030b30: 656c 662c 206b 6579 3a20 7374 722c 2077  elf, key: str, w
-00030b40: 6f72 6b65 723a 2073 7472 2c20 636f 6d70  orker: str, comp
-00030b50: 7574 655f 6475 7261 7469 6f6e 3a20 666c  ute_duration: fl
-00030b60: 6f61 7420 7c20 4e6f 6e65 2c20 7374 696d  oat | None, stim
-00030b70: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
-00030b80: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00030b90: 2020 2020 2222 2241 2074 6173 6b20 6861      """A task ha
-00030ba0: 7320 7365 6365 6465 6420 6672 6f6d 2074  s seceded from t
-00030bb0: 6865 2074 6872 6561 6420 706f 6f6c 0a0a  he thread pool..
-00030bc0: 2020 2020 2020 2020 5765 2073 746f 7020          We stop 
-00030bd0: 7468 6520 7461 736b 2066 726f 6d20 6265  the task from be
-00030be0: 696e 6720 7374 6f6c 656e 2069 6e20 7468  ing stolen in th
-00030bf0: 6520 6675 7475 7265 2c20 616e 6420 6368  e future, and ch
-00030c00: 616e 6765 2074 6173 6b0a 2020 2020 2020  ange task.      
-00030c10: 2020 6475 7261 7469 6f6e 2061 6363 6f75    duration accou
-00030c20: 6e74 696e 6720 6173 2069 6620 7468 6520  nting as if the 
-00030c30: 7461 736b 2068 6173 2073 746f 7070 6564  task has stopped
-00030c40: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00030c50: 2020 2020 2020 6966 206b 6579 206e 6f74        if key not
-00030c60: 2069 6e20 7365 6c66 2e74 6173 6b73 3a0a   in self.tasks:.
-00030c70: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00030c80: 6572 2e64 6562 7567 2822 536b 6970 7069  er.debug("Skippi
-00030c90: 6e67 206c 6f6e 675f 7275 6e6e 696e 6720  ng long_running 
-00030ca0: 7369 6e63 6520 6b65 7920 2573 2077 6173  since key %s was
-00030cb0: 2061 6c72 6561 6479 2072 656c 6561 7365   already release
-00030cc0: 6422 2c20 6b65 7929 0a20 2020 2020 2020  d", key).       
-00030cd0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00030ce0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00030cf0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-00030d00: 2073 7465 616c 203d 2073 656c 662e 6578   steal = self.ex
-00030d10: 7465 6e73 696f 6e73 2e67 6574 2822 7374  tensions.get("st
-00030d20: 6561 6c69 6e67 2229 0a20 2020 2020 2020  ealing").       
-00030d30: 2069 6620 7374 6561 6c20 6973 206e 6f74   if steal is not
-00030d40: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00030d50: 2020 2073 7465 616c 2e72 656d 6f76 655f     steal.remove_
-00030d60: 6b65 795f 6672 6f6d 5f73 7465 616c 6162  key_from_stealab
-00030d70: 6c65 2874 7329 0a0a 2020 2020 2020 2020  le(ts)..        
-00030d80: 7773 203d 2074 732e 7072 6f63 6573 7369  ws = ts.processi
-00030d90: 6e67 5f6f 6e0a 2020 2020 2020 2020 6966  ng_on.        if
-00030da0: 2077 7320 6973 204e 6f6e 653a 0a20 2020   ws is None:.   
-00030db0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00030dc0: 6465 6275 6728 2252 6563 6569 7665 6420  debug("Received 
-00030dd0: 6c6f 6e67 2d72 756e 6e69 6e67 2073 6967  long-running sig
-00030de0: 6e61 6c20 6672 6f6d 2064 7570 6c69 6361  nal from duplica
-00030df0: 7465 2074 6173 6b2e 2049 676e 6f72 696e  te task. Ignorin
-00030e00: 672e 2229 0a20 2020 2020 2020 2020 2020  g.").           
-00030e10: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-00030e20: 2069 6620 636f 6d70 7574 655f 6475 7261   if compute_dura
-00030e30: 7469 6f6e 2069 7320 6e6f 7420 4e6f 6e65  tion is not None
-00030e40: 3a0a 2020 2020 2020 2020 2020 2020 6f6c  :.            ol
-00030e50: 645f 6475 7261 7469 6f6e 203d 2074 732e  d_duration = ts.
-00030e60: 7072 6566 6978 2e64 7572 6174 696f 6e5f  prefix.duration_
-00030e70: 6176 6572 6167 650a 2020 2020 2020 2020  average.        
-00030e80: 2020 2020 6966 206f 6c64 5f64 7572 6174      if old_durat
-00030e90: 696f 6e20 3c20 303a 0a20 2020 2020 2020  ion < 0:.       
-00030ea0: 2020 2020 2020 2020 2074 732e 7072 6566           ts.pref
-00030eb0: 6978 2e64 7572 6174 696f 6e5f 6176 6572  ix.duration_aver
-00030ec0: 6167 6520 3d20 636f 6d70 7574 655f 6475  age = compute_du
-00030ed0: 7261 7469 6f6e 0a20 2020 2020 2020 2020  ration.         
-00030ee0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00030ef0: 2020 2020 2020 2020 2074 732e 7072 6566           ts.pref
-00030f00: 6978 2e64 7572 6174 696f 6e5f 6176 6572  ix.duration_aver
-00030f10: 6167 6520 3d20 286f 6c64 5f64 7572 6174  age = (old_durat
-00030f20: 696f 6e20 2b20 636f 6d70 7574 655f 6475  ion + compute_du
-00030f30: 7261 7469 6f6e 2920 2f20 320a 0a20 2020  ration) / 2..   
-00030f40: 2020 2020 2077 732e 6164 645f 746f 5f6c       ws.add_to_l
-00030f50: 6f6e 675f 7275 6e6e 696e 6728 7473 290a  ong_running(ts).
-00030f60: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
-00030f70: 636b 5f69 646c 655f 7361 7475 7261 7465  ck_idle_saturate
-00030f80: 6428 7773 290a 0a20 2020 2020 2020 2073  d(ws)..        s
-00030f90: 656c 662e 7374 696d 756c 7573 5f71 7565  elf.stimulus_que
-00030fa0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
-00030fb0: 7065 6e65 6428 7374 696d 756c 7573 5f69  pened(stimulus_i
-00030fc0: 643d 7374 696d 756c 7573 5f69 6429 0a0a  d=stimulus_id)..
-00030fd0: 2020 2020 6465 6620 6861 6e64 6c65 5f77      def handle_w
-00030fe0: 6f72 6b65 725f 7374 6174 7573 5f63 6861  orker_status_cha
-00030ff0: 6e67 6528 0a20 2020 2020 2020 2073 656c  nge(.        sel
-00031000: 662c 2073 7461 7475 733a 2073 7472 207c  f, status: str |
-00031010: 2053 7461 7475 732c 2077 6f72 6b65 723a   Status, worker:
-00031020: 2073 7472 207c 2057 6f72 6b65 7253 7461   str | WorkerSta
-00031030: 7465 2c20 7374 696d 756c 7573 5f69 643a  te, stimulus_id:
-00031040: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
-00031050: 6e65 3a0a 2020 2020 2020 2020 7773 203d  ne:.        ws =
-00031060: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00031070: 7428 776f 726b 6572 2920 6966 2069 7369  t(worker) if isi
-00031080: 6e73 7461 6e63 6528 776f 726b 6572 2c20  nstance(worker, 
-00031090: 7374 7229 2065 6c73 6520 776f 726b 6572  str) else worker
-000310a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000310b0: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
-000310c0: 7265 7475 726e 0a20 2020 2020 2020 2070  return.        p
-000310d0: 7265 765f 7374 6174 7573 203d 2077 732e  rev_status = ws.
-000310e0: 7374 6174 7573 0a20 2020 2020 2020 2077  status.        w
-000310f0: 732e 7374 6174 7573 203d 2053 7461 7475  s.status = Statu
-00031100: 735b 7374 6174 7573 5d20 6966 2069 7369  s[status] if isi
-00031110: 6e73 7461 6e63 6528 7374 6174 7573 2c20  nstance(status, 
-00031120: 7374 7229 2065 6c73 6520 7374 6174 7573  str) else status
-00031130: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
-00031140: 7461 7475 7320 3d3d 2070 7265 765f 7374  tatus == prev_st
-00031150: 6174 7573 3a0a 2020 2020 2020 2020 2020  atus:.          
-00031160: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00031170: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00031180: 280a 2020 2020 2020 2020 2020 2020 7773  (.            ws
-00031190: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
-000311a0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-000311b0: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
-000311c0: 3a20 2277 6f72 6b65 722d 7374 6174 7573  : "worker-status
-000311d0: 2d63 6861 6e67 6522 2c0a 2020 2020 2020  -change",.      
-000311e0: 2020 2020 2020 2020 2020 2270 7265 762d            "prev-
-000311f0: 7374 6174 7573 223a 2070 7265 765f 7374  status": prev_st
-00031200: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
-00031210: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
-00031220: 7573 223a 2077 732e 7374 6174 7573 2e6e  us": ws.status.n
-00031230: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00031240: 207d 2c0a 2020 2020 2020 2020 290a 2020   },.        ).  
-00031250: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-00031260: 7567 2866 2257 6f72 6b65 7220 7374 6174  ug(f"Worker stat
-00031270: 7573 207b 7072 6576 5f73 7461 7475 732e  us {prev_status.
-00031280: 6e61 6d65 7d20 2d3e 207b 7374 6174 7573  name} -> {status
-00031290: 7d20 2d20 7b77 737d 2229 0a0a 2020 2020  } - {ws}")..    
-000312a0: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
-000312b0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
-000312c0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-000312d0: 7365 6c66 2e72 756e 6e69 6e67 2e61 6464  self.running.add
-000312e0: 2877 7329 0a20 2020 2020 2020 2020 2020  (ws).           
-000312f0: 2073 656c 662e 6368 6563 6b5f 6964 6c65   self.check_idle
-00031300: 5f73 6174 7572 6174 6564 2877 7329 0a20  _saturated(ws). 
-00031310: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00031320: 7472 616e 7369 7469 6f6e 7328 0a20 2020  transitions(.   
-00031330: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00031340: 662e 6275 6c6b 5f73 6368 6564 756c 655f  f.bulk_schedule_
-00031350: 756e 7275 6e6e 6162 6c65 5f61 6674 6572  unrunnable_after
-00031360: 5f61 6464 696e 675f 776f 726b 6572 2877  _adding_worker(w
-00031370: 7329 2c20 7374 696d 756c 7573 5f69 640a  s), stimulus_id.
-00031380: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00031390: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-000313a0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
-000313b0: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
-000313c0: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
-000313d0: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-000313e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000313f0: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
-00031400: 2e64 6973 6361 7264 2877 7329 0a20 2020  .discard(ws).   
-00031410: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00031420: 6c65 2e70 6f70 2877 732e 6164 6472 6573  le.pop(ws.addres
-00031430: 732c 204e 6f6e 6529 0a20 2020 2020 2020  s, None).       
-00031440: 2020 2020 2073 656c 662e 6964 6c65 5f74       self.idle_t
-00031450: 6173 6b5f 636f 756e 742e 6469 7363 6172  ask_count.discar
-00031460: 6428 7773 290a 2020 2020 2020 2020 2020  d(ws).          
-00031470: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-00031480: 2e64 6973 6361 7264 2877 7329 0a0a 2020  .discard(ws)..  
-00031490: 2020 6173 796e 6320 6465 6620 6861 6e64    async def hand
-000314a0: 6c65 5f72 6571 7565 7374 5f72 6566 7265  le_request_refre
-000314b0: 7368 5f77 686f 5f68 6173 280a 2020 2020  sh_who_has(.    
-000314c0: 2020 2020 7365 6c66 2c20 6b65 7973 3a20      self, keys: 
-000314d0: 4974 6572 6162 6c65 5b73 7472 5d2c 2077  Iterable[str], w
-000314e0: 6f72 6b65 723a 2073 7472 2c20 7374 696d  orker: str, stim
-000314f0: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
-00031500: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00031510: 2020 2020 2222 2241 7379 6e63 6872 6f6e      """Asynchron
-00031520: 6f75 7320 7265 7175 6573 7420 2874 6872  ous request (thr
-00031530: 6f75 6768 2062 756c 6b20 636f 6d6d 7329  ough bulk comms)
-00031540: 2066 726f 6d20 6120 576f 726b 6572 2074   from a Worker t
-00031550: 6f20 7265 6672 6573 6820 7468 650a 2020  o refresh the.  
-00031560: 2020 2020 2020 7768 6f5f 6861 7320 666f        who_has fo
-00031570: 7220 736f 6d65 206b 6579 732e 204e 6f74  r some keys. Not
-00031580: 2074 6f20 6265 2063 6f6e 6675 7365 6420   to be confused 
-00031590: 7769 7468 2073 6368 6564 756c 6572 2e77  with scheduler.w
-000315a0: 686f 5f68 6173 2c20 7768 6963 6820 6973  ho_has, which is
-000315b0: 2061 0a20 2020 2020 2020 2073 796e 6368   a.        synch
-000315c0: 726f 6e6f 7573 2052 5043 2072 6571 7565  ronous RPC reque
-000315d0: 7374 2066 726f 6d20 6120 436c 6965 6e74  st from a Client
-000315e0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-000315f0: 2020 2020 2020 7768 6f5f 6861 7320 3d20        who_has = 
-00031600: 7b7d 0a20 2020 2020 2020 2066 7265 655f  {}.        free_
-00031610: 6b65 7973 203d 205b 5d0a 2020 2020 2020  keys = [].      
-00031620: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00031630: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00031640: 6620 6b65 7920 696e 2073 656c 662e 7461  f key in self.ta
-00031650: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
-00031660: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
-00031670: 5d20 3d20 5b77 732e 6164 6472 6573 7320  ] = [ws.address 
-00031680: 666f 7220 7773 2069 6e20 7365 6c66 2e74  for ws in self.t
-00031690: 6173 6b73 5b6b 6579 5d2e 7768 6f5f 6861  asks[key].who_ha
-000316a0: 735d 0a20 2020 2020 2020 2020 2020 2065  s].            e
-000316b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000316c0: 2020 2020 2066 7265 655f 6b65 7973 2e61       free_keys.a
-000316d0: 7070 656e 6428 6b65 7929 0a0a 2020 2020  ppend(key)..    
-000316e0: 2020 2020 6966 2077 686f 5f68 6173 3a0a      if who_has:.
-000316f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031700: 2e73 7472 6561 6d5f 636f 6d6d 735b 776f  .stream_comms[wo
-00031710: 726b 6572 5d2e 7365 6e64 280a 2020 2020  rker].send(.    
-00031720: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-00031730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031740: 2020 226f 7022 3a20 2272 6566 7265 7368    "op": "refresh
-00031750: 2d77 686f 2d68 6173 222c 0a20 2020 2020  -who-has",.     
-00031760: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00031770: 7768 6f5f 6861 7322 3a20 7768 6f5f 6861  who_has": who_ha
-00031780: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00031790: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-000317a0: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-000317b0: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-000317c0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000317d0: 2029 0a20 2020 2020 2020 2069 6620 6672   ).        if fr
-000317e0: 6565 5f6b 6579 733a 0a20 2020 2020 2020  ee_keys:.       
-000317f0: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
-00031800: 5f63 6f6d 6d73 5b77 6f72 6b65 725d 2e73  _comms[worker].s
-00031810: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-00031820: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00031830: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-00031840: 2022 6672 6565 2d6b 6579 7322 2c0a 2020   "free-keys",.  
-00031850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031860: 2020 226b 6579 7322 3a20 6672 6565 5f6b    "keys": free_k
-00031870: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-00031880: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
-00031890: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
-000318a0: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
-000318b0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
-000318c0: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-000318d0: 6465 6620 6861 6e64 6c65 5f77 6f72 6b65  def handle_worke
-000318e0: 7228 7365 6c66 2c20 636f 6d6d 3a20 436f  r(self, comm: Co
-000318f0: 6d6d 2c20 776f 726b 6572 3a20 7374 7229  mm, worker: str)
-00031900: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00031910: 2020 2222 220a 2020 2020 2020 2020 4c69    """.        Li
-00031920: 7374 656e 2074 6f20 7265 7370 6f6e 7365  sten to response
-00031930: 7320 6672 6f6d 2061 2073 696e 676c 6520  s from a single 
-00031940: 776f 726b 6572 0a0a 2020 2020 2020 2020  worker..        
-00031950: 5468 6973 2069 7320 7468 6520 6d61 696e  This is the main
-00031960: 206c 6f6f 7020 666f 7220 7363 6865 6475   loop for schedu
-00031970: 6c65 722d 776f 726b 6572 2069 6e74 6572  ler-worker inter
-00031980: 6163 7469 6f6e 0a0a 2020 2020 2020 2020  action..        
-00031990: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
-000319a0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-000319b0: 2020 5363 6865 6475 6c65 722e 6861 6e64    Scheduler.hand
-000319c0: 6c65 5f63 6c69 656e 743a 2045 7175 6976  le_client: Equiv
-000319d0: 616c 656e 7420 636f 726f 7574 696e 6520  alent coroutine 
-000319e0: 666f 7220 636c 6965 6e74 730a 2020 2020  for clients.    
-000319f0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00031a00: 636f 6d6d 2e6e 616d 6520 3d20 2253 6368  comm.name = "Sch
-00031a10: 6564 756c 6572 2063 6f6e 6e65 6374 696f  eduler connectio
-00031a20: 6e20 746f 2077 6f72 6b65 7222 0a20 2020  n to worker".   
-00031a30: 2020 2020 2077 6f72 6b65 725f 636f 6d6d       worker_comm
-00031a40: 203d 2073 656c 662e 7374 7265 616d 5f63   = self.stream_c
-00031a50: 6f6d 6d73 5b77 6f72 6b65 725d 0a20 2020  omms[worker].   
-00031a60: 2020 2020 2077 6f72 6b65 725f 636f 6d6d       worker_comm
-00031a70: 2e73 7461 7274 2863 6f6d 6d29 0a20 2020  .start(comm).   
-00031a80: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00031a90: 2822 5374 6172 7469 6e67 2077 6f72 6b65  ("Starting worke
-00031aa0: 7220 636f 6d70 7574 6520 7374 7265 616d  r compute stream
-00031ab0: 2c20 2573 222c 2077 6f72 6b65 7229 0a20  , %s", worker). 
-00031ac0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00031ad0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00031ae0: 6c66 2e68 616e 646c 655f 7374 7265 616d  lf.handle_stream
-00031af0: 2863 6f6d 6d3d 636f 6d6d 2c20 6578 7472  (comm=comm, extr
-00031b00: 613d 7b22 776f 726b 6572 223a 2077 6f72  a={"worker": wor
-00031b10: 6b65 727d 290a 2020 2020 2020 2020 6669  ker}).        fi
-00031b20: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00031b30: 2020 2069 6620 776f 726b 6572 2069 6e20     if worker in 
-00031b40: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00031b50: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00031b60: 2020 2077 6f72 6b65 725f 636f 6d6d 2e61     worker_comm.a
-00031b70: 626f 7274 2829 0a20 2020 2020 2020 2020  bort().         
-00031b80: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
-00031b90: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
-00031ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031bb0: 2020 2020 2077 6f72 6b65 722c 2073 7469       worker, sti
-00031bc0: 6d75 6c75 735f 6964 3d66 2268 616e 646c  mulus_id=f"handl
-00031bd0: 652d 776f 726b 6572 2d63 6c65 616e 7570  e-worker-cleanup
-00031be0: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-00031bf0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00031c00: 2020 6465 6620 6164 645f 706c 7567 696e    def add_plugin
-00031c10: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00031c20: 2020 2020 2020 2020 706c 7567 696e 3a20          plugin: 
-00031c30: 5363 6865 6475 6c65 7250 6c75 6769 6e2c  SchedulerPlugin,
-00031c40: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00031c50: 2020 2020 6964 656d 706f 7465 6e74 3a20      idempotent: 
-00031c60: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-00031c70: 2020 2020 2020 6e61 6d65 3a20 7374 7220        name: str 
-00031c80: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00031c90: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-00031ca0: 2041 6e79 2c0a 2020 2020 2920 2d3e 204e   Any,.    ) -> N
-00031cb0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00031cc0: 4164 6420 6578 7465 726e 616c 2070 6c75  Add external plu
-00031cd0: 6769 6e20 746f 2073 6368 6564 756c 6572  gin to scheduler
-00031ce0: 2e0a 0a20 2020 2020 2020 2053 6565 2068  ...        See h
-00031cf0: 7474 7073 3a2f 2f64 6973 7472 6962 7574  ttps://distribut
-00031d00: 6564 2e72 6561 6474 6865 646f 6373 2e69  ed.readthedocs.i
-00031d10: 6f2f 656e 2f6c 6174 6573 742f 706c 7567  o/en/latest/plug
-00031d20: 696e 732e 6874 6d6c 0a0a 2020 2020 2020  ins.html..      
-00031d30: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
-00031d40: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
-00031d50: 2020 2020 2020 2020 706c 7567 696e 203a          plugin :
-00031d60: 2053 6368 6564 756c 6572 506c 7567 696e   SchedulerPlugin
-00031d70: 0a20 2020 2020 2020 2020 2020 2053 6368  .            Sch
-00031d80: 6564 756c 6572 506c 7567 696e 2069 6e73  edulerPlugin ins
-00031d90: 7461 6e63 6520 746f 2061 6464 0a20 2020  tance to add.   
-00031da0: 2020 2020 2069 6465 6d70 6f74 656e 7420       idempotent 
-00031db0: 3a20 626f 6f6c 0a20 2020 2020 2020 2020  : bool.         
-00031dc0: 2020 2049 6620 7472 7565 2c20 7468 6520     If true, the 
-00031dd0: 706c 7567 696e 2069 7320 6173 7375 6d65  plugin is assume
-00031de0: 6420 746f 2061 6c72 6561 6479 2065 7869  d to already exi
-00031df0: 7374 2061 6e64 206e 6f0a 2020 2020 2020  st and no.      
-00031e00: 2020 2020 2020 6163 7469 6f6e 2069 7320        action is 
-00031e10: 7461 6b65 6e2e 0a20 2020 2020 2020 206e  taken..        n
-00031e20: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
-00031e30: 2020 2020 2020 4120 6e61 6d65 2066 6f72        A name for
-00031e40: 2074 6865 2070 6c75 6769 6e2c 2069 6620   the plugin, if 
-00031e50: 4e6f 6e65 2c20 7468 6520 6e61 6d65 2061  None, the name a
-00031e60: 7474 7269 6275 7465 2069 730a 2020 2020  ttribute is.    
-00031e70: 2020 2020 2020 2020 6368 6563 6b65 6420          checked 
-00031e80: 6f6e 2074 6865 2050 6c75 6769 6e20 696e  on the Plugin in
-00031e90: 7374 616e 6365 2061 6e64 2067 656e 6572  stance and gener
-00031ea0: 6174 6564 2069 6620 6e6f 740a 2020 2020  ated if not.    
-00031eb0: 2020 2020 2020 2020 6469 7363 6f76 6572          discover
-00031ec0: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
-00031ed0: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00031ee0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00031ef0: 2020 2020 206e 616d 6520 3d20 5f67 6574       name = _get
-00031f00: 5f70 6c75 6769 6e5f 6e61 6d65 2870 6c75  _plugin_name(plu
-00031f10: 6769 6e29 0a0a 2020 2020 2020 2020 6966  gin)..        if
-00031f20: 206e 616d 6520 696e 2073 656c 662e 706c   name in self.pl
-00031f30: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
-00031f40: 2020 2069 6620 6964 656d 706f 7465 6e74     if idempotent
-00031f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031f60: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00031f70: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-00031f80: 726e 280a 2020 2020 2020 2020 2020 2020  rn(.            
-00031f90: 2020 2020 6622 5363 6865 6475 6c65 7220      f"Scheduler 
-00031fa0: 616c 7265 6164 7920 636f 6e74 6169 6e73  already contains
-00031fb0: 2061 2070 6c75 6769 6e20 7769 7468 206e   a plugin with n
-00031fc0: 616d 6520 7b6e 616d 657d 3b20 6f76 6572  ame {name}; over
-00031fd0: 7772 6974 696e 672e 222c 0a20 2020 2020  writing.",.     
-00031fe0: 2020 2020 2020 2020 2020 2063 6174 6567             categ
-00031ff0: 6f72 793d 5573 6572 5761 726e 696e 672c  ory=UserWarning,
-00032000: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00032010: 2020 2020 2020 2020 7365 6c66 2e70 6c75          self.plu
-00032020: 6769 6e73 5b6e 616d 655d 203d 2070 6c75  gins[name] = plu
-00032030: 6769 6e0a 0a20 2020 2064 6566 2072 656d  gin..    def rem
-00032040: 6f76 655f 706c 7567 696e 280a 2020 2020  ove_plugin(.    
-00032050: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-00032060: 2020 6e61 6d65 3a20 7374 7220 7c20 4e6f    name: str | No
-00032070: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00032080: 2020 2070 6c75 6769 6e3a 2053 6368 6564     plugin: Sched
-00032090: 756c 6572 506c 7567 696e 207c 204e 6f6e  ulerPlugin | Non
-000320a0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
-000320b0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000320c0: 2022 2222 5265 6d6f 7665 2065 7874 6572   """Remove exter
-000320d0: 6e61 6c20 706c 7567 696e 2066 726f 6d20  nal plugin from 
-000320e0: 7363 6865 6475 6c65 720a 0a20 2020 2020  scheduler..     
-000320f0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-00032100: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-00032110: 0a20 2020 2020 2020 206e 616d 6520 3a20  .        name : 
-00032120: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-00032130: 4e61 6d65 206f 6620 7468 6520 706c 7567  Name of the plug
-00032140: 696e 2074 6f20 7265 6d6f 7665 0a20 2020  in to remove.   
-00032150: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00032160: 2061 7373 6572 7420 6e61 6d65 2069 7320   assert name is 
-00032170: 6e6f 7420 4e6f 6e65 0a0a 2020 2020 2020  not None..      
-00032180: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00032190: 2020 2064 656c 2073 656c 662e 706c 7567     del self.plug
-000321a0: 696e 735b 6e61 6d65 5d0a 2020 2020 2020  ins[name].      
-000321b0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-000321c0: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-000321d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-000321e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000321f0: 2066 2243 6f75 6c64 206e 6f74 2066 696e   f"Could not fin
-00032200: 6420 706c 7567 696e 207b 6e61 6d65 2172  d plugin {name!r
-00032210: 7d20 616d 6f6e 6720 7468 6520 6375 7272  } among the curr
-00032220: 656e 7420 7363 6865 6475 6c65 7220 706c  ent scheduler pl
-00032230: 7567 696e 7322 0a20 2020 2020 2020 2020  ugins".         
-00032240: 2020 2029 0a0a 2020 2020 6173 796e 6320     )..    async 
-00032250: 6465 6620 7265 6769 7374 6572 5f73 6368  def register_sch
-00032260: 6564 756c 6572 5f70 6c75 6769 6e28 0a20  eduler_plugin(. 
-00032270: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00032280: 2020 2020 2070 6c75 6769 6e3a 2062 7974       plugin: byt
-00032290: 6573 207c 2053 6368 6564 756c 6572 506c  es | SchedulerPl
-000322a0: 7567 696e 2c0a 2020 2020 2020 2020 6e61  ugin,.        na
-000322b0: 6d65 3a20 7374 7220 7c20 4e6f 6e65 203d  me: str | None =
-000322c0: 204e 6f6e 652c 0a20 2020 2020 2020 2069   None,.        i
-000322d0: 6465 6d70 6f74 656e 743a 2062 6f6f 6c20  dempotent: bool 
-000322e0: 3d20 4661 6c73 652c 0a20 2020 2029 202d  = False,.    ) -
-000322f0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00032300: 2222 2252 6567 6973 7465 7220 6120 706c  """Register a pl
-00032310: 7567 696e 206f 6e20 7468 6520 7363 6865  ugin on the sche
-00032320: 6475 6c65 722e 2222 220a 2020 2020 2020  duler.""".      
-00032330: 2020 6966 206e 6f74 2064 6173 6b2e 636f    if not dask.co
-00032340: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-00032350: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-00032360: 7069 636b 6c65 2229 3a0a 2020 2020 2020  pickle"):.      
-00032370: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
-00032380: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
-00032390: 2020 2020 2020 2020 2243 616e 6e6f 7420          "Cannot 
-000323a0: 7265 6769 7374 6572 2061 2073 6368 6564  register a sched
-000323b0: 756c 6572 2070 6c75 6769 6e20 6173 2074  uler plugin as t
-000323c0: 6865 2073 6368 6564 756c 6572 2022 0a20  he scheduler ". 
-000323d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000323e0: 6861 7320 6265 656e 2065 7870 6c69 6369  has been explici
-000323f0: 746c 7920 6469 7361 6c6c 6f77 6564 2066  tly disallowed f
-00032400: 726f 6d20 6465 7365 7269 616c 697a 696e  rom deserializin
-00032410: 6720 220a 2020 2020 2020 2020 2020 2020  g ".            
-00032420: 2020 2020 2261 7262 6974 7261 7279 2062      "arbitrary b
-00032430: 7974 6573 7472 696e 6773 2075 7369 6e67  ytestrings using
-00032440: 2070 6963 6b6c 6520 7669 6120 7468 6520   pickle via the 
-00032450: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00032460: 2020 2227 6469 7374 7269 6275 7465 642e    "'distributed.
-00032470: 7363 6865 6475 6c65 722e 7069 636b 6c65  scheduler.pickle
-00032480: 2720 636f 6e66 6967 7572 6174 696f 6e20  ' configuration 
-00032490: 7365 7474 696e 672e 220a 2020 2020 2020  setting.".      
-000324a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000324b0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-000324c0: 6528 706c 7567 696e 2c20 5363 6865 6475  e(plugin, Schedu
-000324d0: 6c65 7250 6c75 6769 6e29 3a0a 2020 2020  lerPlugin):.    
-000324e0: 2020 2020 2020 2020 706c 7567 696e 203d          plugin =
-000324f0: 206c 6f61 6473 2870 6c75 6769 6e29 0a20   loads(plugin). 
-00032500: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00032510: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
-00032520: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
-00032530: 7567 696e 290a 0a20 2020 2020 2020 2069  ugin)..        i
-00032540: 6620 6e61 6d65 2069 7320 4e6f 6e65 3a0a  f name is None:.
-00032550: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
-00032560: 203d 205f 6765 745f 706c 7567 696e 5f6e   = _get_plugin_n
-00032570: 616d 6528 706c 7567 696e 290a 0a20 2020  ame(plugin)..   
-00032580: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
-00032590: 7365 6c66 2e70 6c75 6769 6e73 2061 6e64  self.plugins and
-000325a0: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
-000325b0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-000325c0: 0a20 2020 2020 2020 2069 6620 6861 7361  .        if hasa
-000325d0: 7474 7228 706c 7567 696e 2c20 2273 7461  ttr(plugin, "sta
-000325e0: 7274 2229 3a0a 2020 2020 2020 2020 2020  rt"):.          
-000325f0: 2020 7265 7375 6c74 203d 2070 6c75 6769    result = plugi
-00032600: 6e2e 7374 6172 7428 7365 6c66 290a 2020  n.start(self).  
-00032610: 2020 2020 2020 2020 2020 6966 2069 6e73            if ins
-00032620: 7065 6374 2e69 7361 7761 6974 6162 6c65  pect.isawaitable
-00032630: 2872 6573 756c 7429 3a0a 2020 2020 2020  (result):.      
-00032640: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00032650: 7265 7375 6c74 0a0a 2020 2020 2020 2020  result..        
-00032660: 7365 6c66 2e61 6464 5f70 6c75 6769 6e28  self.add_plugin(
-00032670: 706c 7567 696e 2c20 6e61 6d65 3d6e 616d  plugin, name=nam
-00032680: 652c 2069 6465 6d70 6f74 656e 743d 6964  e, idempotent=id
-00032690: 656d 706f 7465 6e74 290a 0a20 2020 2064  empotent)..    d
-000326a0: 6566 2077 6f72 6b65 725f 7365 6e64 2873  ef worker_send(s
-000326b0: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-000326c0: 2c20 6d73 673a 2064 6963 745b 7374 722c  , msg: dict[str,
-000326d0: 2041 6e79 5d29 202d 3e20 4e6f 6e65 3a0a   Any]) -> None:.
-000326e0: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
-000326f0: 6d65 7373 6167 6520 746f 2077 6f72 6b65  message to worke
-00032700: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-00032710: 616c 736f 2068 616e 646c 6573 2063 6f6e  also handles con
-00032720: 6e65 6374 696f 6e20 6661 696c 7572 6573  nection failures
-00032730: 2062 7920 6164 6469 6e67 2061 2063 616c   by adding a cal
-00032740: 6c62 6163 6b20 746f 2072 656d 6f76 650a  lback to remove.
-00032750: 2020 2020 2020 2020 7468 6520 776f 726b          the work
-00032760: 6572 206f 6e20 7468 6520 6e65 7874 2063  er on the next c
-00032770: 7963 6c65 2e0a 2020 2020 2020 2020 2222  ycle..        ""
-00032780: 220a 2020 2020 2020 2020 7374 7265 616d  ".        stream
-00032790: 5f63 6f6d 6d73 3a20 6469 6374 203d 2073  _comms: dict = s
-000327a0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-000327b0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000327c0: 2020 2020 2020 2020 2020 7374 7265 616d            stream
-000327d0: 5f63 6f6d 6d73 5b77 6f72 6b65 725d 2e73  _comms[worker].s
-000327e0: 656e 6428 6d73 6729 0a20 2020 2020 2020  end(msg).       
-000327f0: 2065 7863 6570 7420 2843 6f6d 6d43 6c6f   except (CommClo
-00032800: 7365 6445 7272 6f72 2c20 4174 7472 6962  sedError, Attrib
-00032810: 7574 6545 7272 6f72 293a 0a20 2020 2020  uteError):.     
-00032820: 2020 2020 2020 2073 656c 662e 5f6f 6e67         self._ong
-00032830: 6f69 6e67 5f62 6163 6b67 726f 756e 645f  oing_background_
-00032840: 7461 736b 732e 6361 6c6c 5f73 6f6f 6e28  tasks.call_soon(
-00032850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032860: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-00032870: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-00032880: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
-00032890: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-000328a0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
-000328b0: 3d66 2277 6f72 6b65 722d 7365 6e64 2d63  =f"worker-send-c
-000328c0: 6f6d 6d2d 6661 696c 2d7b 7469 6d65 2829  omm-fail-{time()
-000328d0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-000328e0: 290a 0a20 2020 2064 6566 2063 6c69 656e  )..    def clien
-000328f0: 745f 7365 6e64 2873 656c 662c 2063 6c69  t_send(self, cli
-00032900: 656e 742c 206d 7367 293a 0a20 2020 2020  ent, msg):.     
-00032910: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
-00032920: 6765 2074 6f20 636c 6965 6e74 2222 220a  ge to client""".
-00032930: 2020 2020 2020 2020 636c 6965 6e74 5f63          client_c
-00032940: 6f6d 6d73 3a20 6469 6374 203d 2073 656c  omms: dict = sel
-00032950: 662e 636c 6965 6e74 5f63 6f6d 6d73 0a20  f.client_comms. 
-00032960: 2020 2020 2020 2063 203d 2063 6c69 656e         c = clien
-00032970: 745f 636f 6d6d 732e 6765 7428 636c 6965  t_comms.get(clie
-00032980: 6e74 290a 2020 2020 2020 2020 6966 2063  nt).        if c
-00032990: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000329a0: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
-000329b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000329c0: 2020 2020 2020 632e 7365 6e64 286d 7367        c.send(msg
-000329d0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-000329e0: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
-000329f0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00032a00: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
-00032a10: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-00032a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a30: 6c6f 6767 6572 2e63 7269 7469 6361 6c28  logger.critical(
-00032a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032a50: 2020 2020 2022 436c 6f73 6564 2063 6f6d       "Closed com
-00032a60: 6d20 2572 2077 6869 6c65 2074 7279 696e  m %r while tryin
-00032a70: 6720 746f 2077 7269 7465 2025 7322 2c20  g to write %s", 
-00032a80: 632c 206d 7367 2c20 6578 635f 696e 666f  c, msg, exc_info
-00032a90: 3d54 7275 650a 2020 2020 2020 2020 2020  =True.          
-00032aa0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00032ab0: 2073 656e 645f 616c 6c28 7365 6c66 2c20   send_all(self, 
-00032ac0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
-00032ad0: 732c 2077 6f72 6b65 725f 6d73 6773 3a20  s, worker_msgs: 
-00032ae0: 4d73 6773 2920 2d3e 204e 6f6e 653a 0a20  Msgs) -> None:. 
-00032af0: 2020 2020 2020 2022 2222 5365 6e64 206d         """Send m
-00032b00: 6573 7361 6765 7320 746f 2063 6c69 656e  essages to clien
-00032b10: 7420 616e 6420 776f 726b 6572 7322 2222  t and workers"""
-00032b20: 0a0a 2020 2020 2020 2020 666f 7220 636c  ..        for cl
-00032b30: 6965 6e74 2c20 6d73 6773 2069 6e20 636c  ient, msgs in cl
-00032b40: 6965 6e74 5f6d 7367 732e 6974 656d 7328  ient_msgs.items(
-00032b50: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00032b60: 203d 2073 656c 662e 636c 6965 6e74 5f63   = self.client_c
-00032b70: 6f6d 6d73 2e67 6574 2863 6c69 656e 7429  omms.get(client)
-00032b80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00032b90: 6320 6973 204e 6f6e 653a 0a20 2020 2020  c is None:.     
-00032ba0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-00032bb0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-00032bc0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00032bd0: 2020 2020 2063 2e73 656e 6428 2a6d 7367       c.send(*msg
-00032be0: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
-00032bf0: 7863 6570 7420 436f 6d6d 436c 6f73 6564  xcept CommClosed
-00032c00: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00032c10: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-00032c20: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-00032c30: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00032c40: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00032c50: 6765 722e 6372 6974 6963 616c 280a 2020  ger.critical(.  
-00032c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032c70: 2020 2020 2020 2243 6c6f 7365 6420 636f        "Closed co
-00032c80: 6d6d 2025 7220 7768 696c 6520 7472 7969  mm %r while tryi
-00032c90: 6e67 2074 6f20 7772 6974 6520 2573 222c  ng to write %s",
-00032ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032cb0: 2020 2020 2020 2020 2063 2c0a 2020 2020           c,.    
-00032cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032cd0: 2020 2020 6d73 6773 2c0a 2020 2020 2020      msgs,.      
+0002c320: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+0002c330: 776f 726b 6572 3d61 6464 7265 7373 2c20  worker=address, 
+0002c340: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+0002c350: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
+0002c360: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002c370: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0002c380: 6365 7074 2054 7970 6545 7272 6f72 3a0a  cept TypeError:.
+0002c390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c3a0: 2020 2020 7061 7261 6d65 7465 7273 203d      parameters =
+0002c3b0: 2069 6e73 7065 6374 2e73 6967 6e61 7475   inspect.signatu
+0002c3c0: 7265 2870 6c75 6769 6e2e 7265 6d6f 7665  re(plugin.remove
+0002c3d0: 5f77 6f72 6b65 7229 2e70 6172 616d 6574  _worker).paramet
+0002c3e0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0002c3f0: 2020 2020 2020 2020 6966 2022 7374 696d          if "stim
+0002c400: 756c 7573 5f69 6422 206e 6f74 2069 6e20  ulus_id" not in 
+0002c410: 7061 7261 6d65 7465 7273 2061 6e64 206e  parameters and n
+0002c420: 6f74 2061 6e79 280a 2020 2020 2020 2020  ot any(.        
+0002c430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c440: 702e 6b69 6e64 2069 7320 702e 5641 525f  p.kind is p.VAR_
+0002c450: 4b45 5957 4f52 4420 666f 7220 7020 696e  KEYWORD for p in
+0002c460: 2070 6172 616d 6574 6572 732e 7661 6c75   parameters.valu
+0002c470: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+0002c480: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+0002c490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c4a0: 2020 2020 2320 4465 7072 6563 6174 6564      # Deprecated
+0002c4b0: 2028 7365 6520 6164 645f 706c 7567 696e   (see add_plugin
+0002c4c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002c4d0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+0002c4e0: 203d 2070 6c75 6769 6e2e 7265 6d6f 7665   = plugin.remove
+0002c4f0: 5f77 6f72 6b65 7228 7363 6865 6475 6c65  _worker(schedule
+0002c500: 723d 7365 6c66 2c20 776f 726b 6572 3d61  r=self, worker=a
+0002c510: 6464 7265 7373 2920 2023 2074 7970 653a  ddress)  # type:
+0002c520: 2069 676e 6f72 650a 2020 2020 2020 2020   ignore.        
+0002c530: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002c540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002c550: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+0002c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c570: 6966 2069 6e73 7065 6374 2e69 7361 7761  if inspect.isawa
+0002c580: 6974 6162 6c65 2872 6573 756c 7429 3a0a  itable(result):.
+0002c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c5a0: 2020 2020 6177 6169 7461 626c 6573 2e61      awaitables.a
+0002c5b0: 7070 656e 6428 7265 7375 6c74 290a 2020  ppend(result).  
+0002c5c0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002c5d0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
+0002c5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002c5f0: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
+0002c600: 6e28 6529 0a0a 2020 2020 2020 2020 706c  n(e)..        pl
+0002c610: 7567 696e 5f6d 7367 7320 3d20 6177 6169  ugin_msgs = awai
+0002c620: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0002c630: 282a 6177 6169 7461 626c 6573 2c20 7265  (*awaitables, re
+0002c640: 7475 726e 5f65 7863 6570 7469 6f6e 733d  turn_exceptions=
+0002c650: 5472 7565 290a 2020 2020 2020 2020 706c  True).        pl
+0002c660: 7567 696e 735f 6578 6365 7074 696f 6e73  ugins_exceptions
+0002c670: 203d 205b 6d73 6720 666f 7220 6d73 6720   = [msg for msg 
+0002c680: 696e 2070 6c75 6769 6e5f 6d73 6773 2069  in plugin_msgs i
+0002c690: 6620 6973 696e 7374 616e 6365 286d 7367  f isinstance(msg
+0002c6a0: 2c20 4578 6365 7074 696f 6e29 5d0a 2020  , Exception)].  
+0002c6b0: 2020 2020 2020 666f 7220 6578 6320 696e        for exc in
+0002c6c0: 2070 6c75 6769 6e73 5f65 7863 6570 7469   plugins_excepti
+0002c6d0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+0002c6e0: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
+0002c6f0: 6e28 6578 632c 2065 7863 5f69 6e66 6f3d  n(exc, exc_info=
+0002c700: 6578 6329 0a0a 2020 2020 2020 2020 6966  exc)..        if
+0002c710: 206e 6f74 2073 656c 662e 776f 726b 6572   not self.worker
+0002c720: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+0002c730: 6f67 6765 722e 696e 666f 2822 4c6f 7374  ogger.info("Lost
+0002c740: 2061 6c6c 2077 6f72 6b65 7273 2229 0a0a   all workers")..
+0002c750: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
+0002c760: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
+0002c770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002c780: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+0002c790: 732e 706f 7028 2861 6464 7265 7373 2c20  s.pop((address, 
+0002c7a0: 7729 2c20 4e6f 6e65 290a 2020 2020 2020  w), None).      
+0002c7b0: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
+0002c7c0: 6964 7468 5f77 6f72 6b65 7273 2e70 6f70  idth_workers.pop
+0002c7d0: 2828 772c 2061 6464 7265 7373 292c 204e  ((w, address), N
+0002c7e0: 6f6e 6529 0a0a 2020 2020 2020 2020 6173  one)..        as
+0002c7f0: 796e 6320 6465 6620 7265 6d6f 7665 5f77  ync def remove_w
+0002c800: 6f72 6b65 725f 6672 6f6d 5f65 7665 6e74  orker_from_event
+0002c810: 7328 2920 2d3e 204e 6f6e 653a 0a20 2020  s() -> None:.   
+0002c820: 2020 2020 2020 2020 2023 2049 6620 7468           # If th
+0002c830: 6520 776f 726b 6572 2069 736e 2774 2072  e worker isn't r
+0002c840: 6567 6973 7465 7265 6420 616e 796d 6f72  egistered anymor
+0002c850: 6520 6166 7465 7220 7468 6520 6465 6c61  e after the dela
+0002c860: 792c 2072 656d 6f76 6520 6672 6f6d 2065  y, remove from e
+0002c870: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
+0002c880: 2020 6966 2061 6464 7265 7373 206e 6f74    if address not
+0002c890: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002c8a0: 2061 6e64 2061 6464 7265 7373 2069 6e20   and address in 
+0002c8b0: 7365 6c66 2e65 7665 6e74 733a 0a20 2020  self.events:.   
+0002c8c0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0002c8d0: 2073 656c 662e 6576 656e 7473 5b61 6464   self.events[add
+0002c8e0: 7265 7373 5d0a 0a20 2020 2020 2020 2063  ress]..        c
+0002c8f0: 6c65 616e 7570 5f64 656c 6179 203d 2070  leanup_delay = p
+0002c900: 6172 7365 5f74 696d 6564 656c 7461 280a  arse_timedelta(.
+0002c910: 2020 2020 2020 2020 2020 2020 6461 736b              dask
+0002c920: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+0002c930: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+0002c940: 6572 2e65 7665 6e74 732d 636c 6561 6e75  er.events-cleanu
+0002c950: 702d 6465 6c61 7922 290a 2020 2020 2020  p-delay").      
+0002c960: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+0002c970: 662e 5f6f 6e67 6f69 6e67 5f62 6163 6b67  f._ongoing_backg
+0002c980: 726f 756e 645f 7461 736b 732e 6361 6c6c  round_tasks.call
+0002c990: 5f6c 6174 6572 280a 2020 2020 2020 2020  _later(.        
+0002c9a0: 2020 2020 636c 6561 6e75 705f 6465 6c61      cleanup_dela
+0002c9b0: 792c 2072 656d 6f76 655f 776f 726b 6572  y, remove_worker
+0002c9c0: 5f66 726f 6d5f 6576 656e 7473 0a20 2020  _from_events.   
+0002c9d0: 2020 2020 2029 0a20 2020 2020 2020 206c       ).        l
+0002c9e0: 6f67 6765 722e 6465 6275 6728 2252 656d  ogger.debug("Rem
+0002c9f0: 6f76 6564 2077 6f72 6b65 7220 2573 222c  oved worker %s",
+0002ca00: 2077 7329 0a0a 2020 2020 2020 2020 666f   ws)..        fo
+0002ca10: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
+0002ca20: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+0002ca30: 2073 656c 662e 776f 726b 6572 5f73 656e   self.worker_sen
+0002ca40: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
+0002ca50: 2020 2077 2c0a 2020 2020 2020 2020 2020     w,.          
+0002ca60: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0002ca70: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+0002ca80: 3a20 2272 656d 6f76 652d 776f 726b 6572  : "remove-worker
+0002ca90: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002caa0: 2020 2020 2020 2022 776f 726b 6572 223a         "worker":
+0002cab0: 2061 6464 7265 7373 2c0a 2020 2020 2020   address,.      
+0002cac0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0002cad0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0002cae0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0002caf0: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
+0002cb00: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0002cb10: 2020 2020 7265 7475 726e 2022 4f4b 220a      return "OK".
+0002cb20: 0a20 2020 2064 6566 2073 7469 6d75 6c75  .    def stimulu
+0002cb30: 735f 6361 6e63 656c 280a 2020 2020 2020  s_cancel(.      
+0002cb40: 2020 7365 6c66 2c20 6b65 7973 3a20 5365    self, keys: Se
+0002cb50: 7175 656e 6365 5b73 7472 5d2c 2063 6c69  quence[str], cli
+0002cb60: 656e 743a 2073 7472 2c20 666f 7263 653a  ent: str, force:
+0002cb70: 2062 6f6f 6c20 3d20 4661 6c73 650a 2020   bool = False.  
+0002cb80: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0002cb90: 2020 2020 2022 2222 5374 6f70 2065 7865       """Stop exe
+0002cba0: 6375 7469 6f6e 206f 6e20 6120 6c69 7374  cution on a list
+0002cbb0: 206f 6620 6b65 7973 2222 220a 2020 2020   of keys""".    
+0002cbc0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002cbd0: 2243 6c69 656e 7420 2573 2072 6571 7565  "Client %s reque
+0002cbe0: 7374 7320 746f 2063 616e 6365 6c20 2564  sts to cancel %d
+0002cbf0: 206b 6579 7322 2c20 636c 6965 6e74 2c20   keys", client, 
+0002cc00: 6c65 6e28 6b65 7973 2929 0a20 2020 2020  len(keys)).     
+0002cc10: 2020 2069 6620 636c 6965 6e74 3a0a 2020     if client:.  
+0002cc20: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0002cc30: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
+0002cc40: 2020 2020 2020 2020 2020 636c 6965 6e74            client
+0002cc50: 2c20 7b22 6163 7469 6f6e 223a 2022 6361  , {"action": "ca
+0002cc60: 6e63 656c 222c 2022 636f 756e 7422 3a20  ncel", "count": 
+0002cc70: 6c65 6e28 6b65 7973 292c 2022 666f 7263  len(keys), "forc
+0002cc80: 6522 3a20 666f 7263 657d 0a20 2020 2020  e": force}.     
+0002cc90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0002cca0: 2063 616e 6365 6c6c 6564 5f6b 6579 7320   cancelled_keys 
+0002ccb0: 3d20 5b5d 0a20 2020 2020 2020 2063 6c69  = [].        cli
+0002ccc0: 656e 7473 203d 205b 5d0a 2020 2020 2020  ents = [].      
+0002ccd0: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+0002cce0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
+0002ccf0: 733a 2054 6173 6b53 7461 7465 207c 204e  s: TaskState | N
+0002cd00: 6f6e 6520 3d20 7365 6c66 2e74 6173 6b73  one = self.tasks
+0002cd10: 2e67 6574 286b 6579 290a 2020 2020 2020  .get(key).      
+0002cd20: 2020 2020 2020 6966 206e 6f74 2074 733a        if not ts:
+0002cd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cd40: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
+0002cd50: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002cd60: 2020 2020 2020 2020 2020 2063 733a 2043             cs: C
+0002cd70: 6c69 656e 7453 7461 7465 203d 2073 656c  lientState = sel
+0002cd80: 662e 636c 6965 6e74 735b 636c 6965 6e74  f.clients[client
+0002cd90: 5d0a 2020 2020 2020 2020 2020 2020 6578  ].            ex
+0002cda0: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+0002cdb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0002cdc0: 6574 7572 6e0a 0a20 2020 2020 2020 2020  eturn..         
+0002cdd0: 2020 2069 6620 666f 7263 6520 6f72 2074     if force or t
+0002cde0: 732e 7768 6f5f 7761 6e74 7320 3d3d 207b  s.who_wants == {
+0002cdf0: 6373 7d3a 2020 2320 6e6f 206f 6e65 2065  cs}:  # no one e
+0002ce00: 6c73 6520 7761 6e74 7320 7468 6973 206b  lse wants this k
+0002ce10: 6579 0a20 2020 2020 2020 2020 2020 2020  ey.             
+0002ce20: 2020 2069 6620 7473 2e64 6570 656e 6465     if ts.depende
+0002ce30: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0002ce40: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+0002ce50: 696d 756c 7573 5f63 616e 6365 6c28 0a20  imulus_cancel(. 
+0002ce60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce70: 2020 2020 2020 205b 6474 732e 6b65 7920         [dts.key 
+0002ce80: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0002ce90: 7065 6e64 656e 7473 5d2c 2063 6c69 656e  pendents], clien
+0002cea0: 742c 2066 6f72 6365 3d66 6f72 6365 0a20  t, force=force. 
+0002ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cec0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002ced0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002cee0: 2822 5363 6865 6475 6c65 7220 6361 6e63  ("Scheduler canc
+0002cef0: 656c 7320 6b65 7920 2573 2e20 2046 6f72  els key %s.  For
+0002cf00: 6365 3d25 7322 2c20 6b65 792c 2066 6f72  ce=%s", key, for
+0002cf10: 6365 290a 2020 2020 2020 2020 2020 2020  ce).            
+0002cf20: 2020 2020 6361 6e63 656c 6c65 645f 6b65      cancelled_ke
+0002cf30: 7973 2e61 7070 656e 6428 6b65 7929 0a20  ys.append(key). 
+0002cf40: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0002cf50: 7473 2e65 7874 656e 6428 6c69 7374 2874  ts.extend(list(t
+0002cf60: 732e 7768 6f5f 7761 6e74 7329 2069 6620  s.who_wants) if 
+0002cf70: 666f 7263 6520 656c 7365 205b 6373 5d29  force else [cs])
+0002cf80: 0a20 2020 2020 2020 2066 6f72 2063 7320  .        for cs 
+0002cf90: 696e 2063 6c69 656e 7473 3a0a 2020 2020  in clients:.    
+0002cfa0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
+0002cfb0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
+0002cfc0: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
+0002cfd0: 2020 206b 6579 733d 6361 6e63 656c 6c65     keys=cancelle
+0002cfe0: 645f 6b65 7973 2c0a 2020 2020 2020 2020  d_keys,.        
+0002cff0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
+0002d000: 732e 636c 6965 6e74 5f6b 6579 2c0a 2020  s.client_key,.  
+0002d010: 2020 2020 2020 2020 2020 2020 2020 7374                st
+0002d020: 696d 756c 7573 5f69 643d 6622 6361 6e63  imulus_id=f"canc
+0002d030: 656c 2d6b 6579 2d7b 7469 6d65 2829 7d22  el-key-{time()}"
+0002d040: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0002d050: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+0002d060: 6f72 7428 7b22 6f70 223a 2022 6361 6e63  ort({"op": "canc
+0002d070: 656c 6c65 642d 6b65 7973 222c 2022 6b65  elled-keys", "ke
+0002d080: 7973 223a 2063 616e 6365 6c6c 6564 5f6b  ys": cancelled_k
+0002d090: 6579 737d 290a 0a20 2020 2064 6566 2063  eys})..    def c
+0002d0a0: 6c69 656e 745f 6465 7369 7265 735f 6b65  lient_desires_ke
+0002d0b0: 7973 2873 656c 662c 206b 6579 733d 4e6f  ys(self, keys=No
+0002d0c0: 6e65 2c20 636c 6965 6e74 3d4e 6f6e 6529  ne, client=None)
+0002d0d0: 3a0a 2020 2020 2020 2020 6373 3a20 436c  :.        cs: Cl
+0002d0e0: 6965 6e74 5374 6174 6520 3d20 7365 6c66  ientState = self
+0002d0f0: 2e63 6c69 656e 7473 2e67 6574 2863 6c69  .clients.get(cli
+0002d100: 656e 7429 0a20 2020 2020 2020 2069 6620  ent).        if 
+0002d110: 6373 2069 7320 4e6f 6e65 3a0a 2020 2020  cs is None:.    
+0002d120: 2020 2020 2020 2020 2320 466f 7220 7075          # For pu
+0002d130: 626c 6973 682c 2071 7565 7565 7320 6574  blish, queues et
+0002d140: 632e 0a20 2020 2020 2020 2020 2020 2073  c..            s
+0002d150: 656c 662e 636c 6965 6e74 735b 636c 6965  elf.clients[clie
+0002d160: 6e74 5d20 3d20 6373 203d 2043 6c69 656e  nt] = cs = Clien
+0002d170: 7453 7461 7465 2863 6c69 656e 7429 0a20  tState(client). 
+0002d180: 2020 2020 2020 2066 6f72 206b 2069 6e20         for k in 
+0002d190: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
+0002d1a0: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
+0002d1b0: 732e 6765 7428 6b29 0a20 2020 2020 2020  s.get(k).       
+0002d1c0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+0002d1d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0002d1e0: 2020 2020 2320 466f 7220 7075 626c 6973      # For publis
+0002d1f0: 682c 2071 7565 7565 7320 6574 632e 0a20  h, queues etc.. 
+0002d200: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002d210: 7320 3d20 7365 6c66 2e6e 6577 5f74 6173  s = self.new_tas
+0002d220: 6b28 6b2c 204e 6f6e 652c 2022 7265 6c65  k(k, None, "rele
+0002d230: 6173 6564 2229 0a20 2020 2020 2020 2020  ased").         
+0002d240: 2020 2074 732e 7768 6f5f 7761 6e74 732e     ts.who_wants.
+0002d250: 6164 6428 6373 290a 2020 2020 2020 2020  add(cs).        
+0002d260: 2020 2020 6373 2e77 616e 7473 5f77 6861      cs.wants_wha
+0002d270: 742e 6164 6428 7473 290a 0a20 2020 2020  t.add(ts)..     
+0002d280: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+0002d290: 7465 2069 6e20 2822 6d65 6d6f 7279 222c  te in ("memory",
+0002d2a0: 2022 6572 7265 6422 293a 0a20 2020 2020   "erred"):.     
+0002d2b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002d2c0: 7265 706f 7274 5f6f 6e5f 6b65 7928 7473  report_on_key(ts
+0002d2d0: 3d74 732c 2063 6c69 656e 743d 636c 6965  =ts, client=clie
+0002d2e0: 6e74 290a 0a20 2020 2064 6566 2063 6c69  nt)..    def cli
+0002d2f0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
+0002d300: 7328 7365 6c66 2c20 6b65 7973 3d4e 6f6e  s(self, keys=Non
+0002d310: 652c 2063 6c69 656e 743d 4e6f 6e65 2c20  e, client=None, 
+0002d320: 7374 696d 756c 7573 5f69 643d 4e6f 6e65  stimulus_id=None
+0002d330: 293a 0a20 2020 2020 2020 2022 2222 5265  ):.        """Re
+0002d340: 6d6f 7665 206b 6579 7320 6672 6f6d 2063  move keys from c
+0002d350: 6c69 656e 7420 6465 7369 7265 6420 6c69  lient desired li
+0002d360: 7374 2222 220a 2020 2020 2020 2020 7374  st""".        st
+0002d370: 696d 756c 7573 5f69 6420 3d20 7374 696d  imulus_id = stim
+0002d380: 756c 7573 5f69 6420 6f72 2066 2263 6c69  ulus_id or f"cli
+0002d390: 656e 742d 7265 6c65 6173 6573 2d6b 6579  ent-releases-key
+0002d3a0: 732d 7b74 696d 6528 297d 220a 2020 2020  s-{time()}".    
+0002d3b0: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+0002d3c0: 7461 6e63 6528 6b65 7973 2c20 6c69 7374  tance(keys, list
+0002d3d0: 293a 0a20 2020 2020 2020 2020 2020 206b  ):.            k
+0002d3e0: 6579 7320 3d20 6c69 7374 286b 6579 7329  eys = list(keys)
+0002d3f0: 0a20 2020 2020 2020 2063 7320 3d20 7365  .        cs = se
+0002d400: 6c66 2e63 6c69 656e 7473 5b63 6c69 656e  lf.clients[clien
+0002d410: 745d 0a20 2020 2020 2020 2072 6563 6f6d  t].        recom
+0002d420: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0002d430: 203d 207b 7d0a 0a20 2020 2020 2020 2073   = {}..        s
+0002d440: 656c 662e 5f63 6c69 656e 745f 7265 6c65  elf._client_rele
+0002d450: 6173 6573 5f6b 6579 7328 6b65 7973 3d6b  ases_keys(keys=k
+0002d460: 6579 732c 2063 733d 6373 2c20 7265 636f  eys, cs=cs, reco
+0002d470: 6d6d 656e 6461 7469 6f6e 733d 7265 636f  mmendations=reco
+0002d480: 6d6d 656e 6461 7469 6f6e 7329 0a20 2020  mmendations).   
+0002d490: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
+0002d4a0: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
+0002d4b0: 7469 6f6e 732c 2073 7469 6d75 6c75 735f  tions, stimulus_
+0002d4c0: 6964 290a 0a20 2020 2020 2020 2073 656c  id)..        sel
+0002d4d0: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
+0002d4e0: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
+0002d4f0: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
+0002d500: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+0002d510: 2020 6465 6620 636c 6965 6e74 5f68 6561    def client_hea
+0002d520: 7274 6265 6174 2873 656c 662c 2063 6c69  rtbeat(self, cli
+0002d530: 656e 743d 4e6f 6e65 293a 0a20 2020 2020  ent=None):.     
+0002d540: 2020 2022 2222 4861 6e64 6c65 2068 6561     """Handle hea
+0002d550: 7274 6265 6174 7320 6672 6f6d 2043 6c69  rtbeats from Cli
+0002d560: 656e 7422 2222 0a20 2020 2020 2020 2063  ent""".        c
+0002d570: 733a 2043 6c69 656e 7453 7461 7465 203d  s: ClientState =
+0002d580: 2073 656c 662e 636c 6965 6e74 735b 636c   self.clients[cl
+0002d590: 6965 6e74 5d0a 2020 2020 2020 2020 6373  ient].        cs
+0002d5a0: 2e6c 6173 745f 7365 656e 203d 2074 696d  .last_seen = tim
+0002d5b0: 6528 290a 0a20 2020 2023 2323 2323 2323  e()..    #######
+0002d5c0: 2323 2323 2323 2323 2323 2323 0a20 2020  ############.   
+0002d5d0: 2023 2054 6173 6b20 5661 6c69 6461 7469   # Task Validati
+0002d5e0: 6f6e 2023 0a20 2020 2023 2323 2323 2323  on #.    #######
+0002d5f0: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
+0002d600: 2020 6465 6620 7661 6c69 6461 7465 5f72    def validate_r
+0002d610: 656c 6561 7365 6428 7365 6c66 2c20 6b65  eleased(self, ke
+0002d620: 793a 2073 7472 2920 2d3e 204e 6f6e 653a  y: str) -> None:
+0002d630: 0a20 2020 2020 2020 2074 733a 2054 6173  .        ts: Tas
+0002d640: 6b53 7461 7465 203d 2073 656c 662e 7461  kState = self.ta
+0002d650: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+0002d660: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
+0002d670: 203d 3d20 2272 656c 6561 7365 6422 0a20   == "released". 
+0002d680: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002d690: 7420 7473 2e77 6169 7465 7273 0a20 2020  t ts.waiters.   
+0002d6a0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002d6b0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
+0002d6c0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0002d6d0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+0002d6e0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+0002d6f0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+0002d700: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002d710: 6f74 2061 6e79 285b 7473 2069 6e20 6474  ot any([ts in dt
+0002d720: 732e 7761 6974 6572 7320 666f 7220 6474  s.waiters for dt
+0002d730: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002d740: 6369 6573 5d29 0a20 2020 2020 2020 2061  cies]).        a
+0002d750: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
+0002d760: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
+0002d770: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002d780: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+0002d790: 6575 6564 0a0a 2020 2020 6465 6620 7661  eued..    def va
+0002d7a0: 6c69 6461 7465 5f77 6169 7469 6e67 2873  lidate_waiting(s
+0002d7b0: 656c 662c 206b 6579 3a20 7374 7229 202d  elf, key: str) -
+0002d7c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0002d7d0: 7473 3a20 5461 736b 5374 6174 6520 3d20  ts: TaskState = 
+0002d7e0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+0002d7f0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002d800: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+0002d810: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002d820: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+0002d830: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+0002d840: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+0002d850: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0002d860: 206e 6f74 2069 6e20 7365 6c66 2e75 6e72   not in self.unr
+0002d870: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
+0002d880: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+0002d890: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
+0002d8a0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+0002d8b0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+0002d8c0: 0a20 2020 2020 2020 2020 2020 2023 2057  .            # W
+0002d8d0: 6520 6172 6520 7761 6974 696e 6720 6f6e  e are waiting on
+0002d8e0: 2061 2064 6570 656e 6465 6e63 7920 6966   a dependency if
+0002d8f0: 6620 6974 2773 206e 6f74 2073 746f 7265  f it's not store
+0002d900: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
+0002d910: 7365 7274 2062 6f6f 6c28 6474 732e 7768  sert bool(dts.wh
+0002d920: 6f5f 6861 7329 2021 3d20 2864 7473 2069  o_has) != (dts i
+0002d930: 6e20 7473 2e77 6169 7469 6e67 5f6f 6e29  n ts.waiting_on)
+0002d940: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002d950: 6572 7420 7473 2069 6e20 6474 732e 7761  ert ts in dts.wa
+0002d960: 6974 6572 7320 2023 2058 5858 2065 7665  iters  # XXX eve
+0002d970: 6e20 6966 2064 7473 2e5f 7768 6f5f 6861  n if dts._who_ha
+0002d980: 733f 0a0a 2020 2020 6465 6620 7661 6c69  s?..    def vali
+0002d990: 6461 7465 5f71 7565 7565 6428 7365 6c66  date_queued(self
+0002d9a0: 2c20 6b65 793a 2073 7472 2920 2d3e 204e  , key: str) -> N
+0002d9b0: 6f6e 653a 0a20 2020 2020 2020 2074 733a  one:.        ts:
+0002d9c0: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
+0002d9d0: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+0002d9e0: 2020 2020 2064 7473 3a20 5461 736b 5374       dts: TaskSt
+0002d9f0: 6174 650a 2020 2020 2020 2020 6173 7365  ate.        asse
+0002da00: 7274 2074 7320 696e 2073 656c 662e 7175  rt ts in self.qu
+0002da10: 6575 6564 0a20 2020 2020 2020 2061 7373  eued.        ass
+0002da20: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+0002da30: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0002da40: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+0002da50: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0002da60: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+0002da70: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0002da80: 6173 7365 7274 206e 6f74 2028 0a20 2020  assert not (.   
+0002da90: 2020 2020 2020 2020 2074 732e 776f 726b           ts.work
+0002daa0: 6572 5f72 6573 7472 6963 7469 6f6e 7320  er_restrictions 
+0002dab0: 6f72 2074 732e 686f 7374 5f72 6573 7472  or ts.host_restr
+0002dac0: 6963 7469 6f6e 7320 6f72 2074 732e 7265  ictions or ts.re
+0002dad0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+0002dae0: 6f6e 730a 2020 2020 2020 2020 290a 2020  ons.        ).  
+0002daf0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+0002db00: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+0002db10: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+0002db20: 7365 7274 2064 7473 2e77 686f 5f68 6173  sert dts.who_has
+0002db30: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002db40: 6572 7420 7473 2069 6e20 6474 732e 7761  ert ts in dts.wa
+0002db50: 6974 6572 730a 0a20 2020 2064 6566 2076  iters..    def v
+0002db60: 616c 6964 6174 655f 7072 6f63 6573 7369  alidate_processi
+0002db70: 6e67 2873 656c 662c 206b 6579 3a20 7374  ng(self, key: st
+0002db80: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+0002db90: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+0002dba0: 6520 3d20 7365 6c66 2e74 6173 6b73 5b6b  e = self.tasks[k
+0002dbb0: 6579 5d0a 2020 2020 2020 2020 6474 733a  ey].        dts:
+0002dbc0: 2054 6173 6b53 7461 7465 0a20 2020 2020   TaskState.     
+0002dbd0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+0002dbe0: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+0002dbf0: 2020 2020 7773 203d 2074 732e 7072 6f63      ws = ts.proc
+0002dc00: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+0002dc10: 2020 6173 7365 7274 2077 730a 2020 2020    assert ws.    
+0002dc20: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+0002dc30: 2077 732e 7072 6f63 6573 7369 6e67 0a20   ws.processing. 
+0002dc40: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002dc50: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+0002dc60: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0002dc70: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
+0002dc80: 640a 2020 2020 2020 2020 666f 7220 6474  d.        for dt
+0002dc90: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002dca0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+0002dcb0: 2020 6173 7365 7274 2064 7473 2e77 686f    assert dts.who
+0002dcc0: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+0002dcd0: 2061 7373 6572 7420 7473 2069 6e20 6474   assert ts in dt
+0002dce0: 732e 7761 6974 6572 730a 0a20 2020 2064  s.waiters..    d
+0002dcf0: 6566 2076 616c 6964 6174 655f 6d65 6d6f  ef validate_memo
+0002dd00: 7279 2873 656c 662c 206b 6579 3a20 7374  ry(self, key: st
+0002dd10: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+0002dd20: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+0002dd30: 6520 3d20 7365 6c66 2e74 6173 6b73 5b6b  e = self.tasks[k
+0002dd40: 6579 5d0a 2020 2020 2020 2020 6474 733a  ey].        dts:
+0002dd50: 2054 6173 6b53 7461 7465 0a20 2020 2020   TaskState.     
+0002dd60: 2020 2061 7373 6572 7420 7473 2e77 686f     assert ts.who
+0002dd70: 5f68 6173 0a20 2020 2020 2020 2061 7373  _has.        ass
+0002dd80: 6572 7420 626f 6f6c 2874 7320 696e 2073  ert bool(ts in s
+0002dd90: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
+0002dda0: 6173 6b73 2920 3d3d 2028 6c65 6e28 7473  asks) == (len(ts
+0002ddb0: 2e77 686f 5f68 6173 2920 3e20 3129 0a20  .who_has) > 1). 
+0002ddc0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+0002ddd0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+0002dde0: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+0002ddf0: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
+0002de00: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
+0002de10: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+0002de20: 662e 756e 7275 6e6e 6162 6c65 0a20 2020  f.unrunnable.   
+0002de30: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+0002de40: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
+0002de50: 640a 2020 2020 2020 2020 666f 7220 6474  d.        for dt
+0002de60: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002de70: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0002de80: 6173 7365 7274 2028 6474 7320 696e 2074  assert (dts in t
+0002de90: 732e 7761 6974 6572 7329 203d 3d20 280a  s.waiters) == (.
+0002dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002deb0: 6474 732e 7374 6174 6520 696e 2028 2277  dts.state in ("w
+0002dec0: 6169 7469 6e67 222c 2022 7175 6575 6564  aiting", "queued
+0002ded0: 222c 2022 7072 6f63 6573 7369 6e67 222c  ", "processing",
+0002dee0: 2022 6e6f 2d77 6f72 6b65 7222 290a 2020   "no-worker").  
+0002def0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002df00: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+0002df10: 7320 6e6f 7420 696e 2064 7473 2e77 6169  s not in dts.wai
+0002df20: 7469 6e67 5f6f 6e0a 0a20 2020 2064 6566  ting_on..    def
+0002df30: 2076 616c 6964 6174 655f 6e6f 5f77 6f72   validate_no_wor
+0002df40: 6b65 7228 7365 6c66 2c20 6b65 793a 2073  ker(self, key: s
+0002df50: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+0002df60: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+0002df70: 7465 203d 2073 656c 662e 7461 736b 735b  te = self.tasks[
+0002df80: 6b65 795d 0a20 2020 2020 2020 2061 7373  key].        ass
+0002df90: 6572 7420 7473 2069 6e20 7365 6c66 2e75  ert ts in self.u
+0002dfa0: 6e72 756e 6e61 626c 650a 2020 2020 2020  nrunnable.      
+0002dfb0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0002dfc0: 7761 6974 696e 675f 6f6e 0a20 2020 2020  waiting_on.     
+0002dfd0: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+0002dfe0: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
+0002dff0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+0002e000: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
+0002e010: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
+0002e020: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+0002e030: 730a 2020 2020 2020 2020 6173 7365 7274  s.        assert
+0002e040: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
+0002e050: 7175 6575 6564 0a20 2020 2020 2020 2066  queued.        f
+0002e060: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0002e070: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0002e080: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+0002e090: 732e 7768 6f5f 6861 730a 0a20 2020 2064  s.who_has..    d
+0002e0a0: 6566 2076 616c 6964 6174 655f 6572 7265  ef validate_erre
+0002e0b0: 6428 7365 6c66 2c20 6b65 793a 2073 7472  d(self, key: str
+0002e0c0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002e0d0: 2020 2074 733a 2054 6173 6b53 7461 7465     ts: TaskState
+0002e0e0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+0002e0f0: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
+0002e100: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
+0002e110: 6c61 6d65 0a20 2020 2020 2020 2061 7373  lame.        ass
+0002e120: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+0002e130: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
+0002e140: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+0002e150: 2e71 7565 7565 640a 0a20 2020 2064 6566  .queued..    def
+0002e160: 2076 616c 6964 6174 655f 6b65 7928 7365   validate_key(se
+0002e170: 6c66 2c20 6b65 793a 2073 7472 2c20 7473  lf, key: str, ts
+0002e180: 3a20 5461 736b 5374 6174 6520 7c20 4e6f  : TaskState | No
+0002e190: 6e65 203d 204e 6f6e 6529 202d 3e20 4e6f  ne = None) -> No
+0002e1a0: 6e65 3a0a 2020 2020 2020 2020 7472 793a  ne:.        try:
+0002e1b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002e1c0: 7473 2069 7320 4e6f 6e65 3a0a 2020 2020  ts is None:.    
+0002e1d0: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+0002e1e0: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
+0002e1f0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+0002e200: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
+0002e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e220: 6c6f 6767 6572 2e64 6562 7567 2822 4b65  logger.debug("Ke
+0002e230: 7920 6c6f 7374 3a20 2573 222c 206b 6579  y lost: %s", key
+0002e240: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0002e250: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002e260: 2020 2020 7473 2e76 616c 6964 6174 6528      ts.validate(
+0002e270: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002e280: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002e290: 2020 2020 2020 2020 2020 2066 756e 6320             func 
+0002e2a0: 3d20 6765 7461 7474 7228 7365 6c66 2c20  = getattr(self, 
+0002e2b0: 2276 616c 6964 6174 655f 2220 2b20 7473  "validate_" + ts
+0002e2c0: 2e73 7461 7465 2e72 6570 6c61 6365 2822  .state.replace("
+0002e2d0: 2d22 2c20 225f 2229 290a 2020 2020 2020  -", "_")).      
+0002e2e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002e2f0: 2041 7474 7269 6275 7465 4572 726f 723a   AttributeError:
+0002e300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e310: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+0002e320: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0002e330: 2020 2020 2020 2020 2020 2022 7365 6c66             "self
+0002e340: 2e76 616c 6964 6174 655f 2573 206e 6f74  .validate_%s not
+0002e350: 2066 6f75 6e64 222c 2074 732e 7374 6174   found", ts.stat
+0002e360: 652e 7265 706c 6163 6528 222d 222c 2022  e.replace("-", "
+0002e370: 5f22 290a 2020 2020 2020 2020 2020 2020  _").            
+0002e380: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002e390: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002e3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3b0: 2020 2020 6675 6e63 286b 6579 290a 2020      func(key).  
+0002e3c0: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+0002e3d0: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+0002e3e0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0002e3f0: 6578 6365 7074 696f 6e28 6529 0a20 2020  exception(e).   
+0002e400: 2020 2020 2020 2020 2069 6620 4c4f 475f           if LOG_
+0002e410: 5044 423a 0a20 2020 2020 2020 2020 2020  PDB:.           
+0002e420: 2020 2020 2069 6d70 6f72 7420 7064 620a       import pdb.
+0002e430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e440: 2070 6462 2e73 6574 5f74 7261 6365 2829   pdb.set_trace()
+0002e450: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0002e460: 7365 0a0a 2020 2020 6465 6620 7661 6c69  se..    def vali
+0002e470: 6461 7465 5f73 7461 7465 2873 656c 662c  date_state(self,
+0002e480: 2061 6c6c 6f77 5f6f 7665 726c 6170 3a20   allow_overlap: 
+0002e490: 626f 6f6c 203d 2046 616c 7365 2920 2d3e  bool = False) ->
+0002e4a0: 204e 6f6e 653a 0a20 2020 2020 2020 2076   None:.        v
+0002e4b0: 616c 6964 6174 655f 7374 6174 6528 7365  alidate_state(se
+0002e4c0: 6c66 2e74 6173 6b73 2c20 7365 6c66 2e77  lf.tasks, self.w
+0002e4d0: 6f72 6b65 7273 2c20 7365 6c66 2e63 6c69  orkers, self.cli
+0002e4e0: 656e 7473 290a 0a20 2020 2020 2020 2069  ents)..        i
+0002e4f0: 6620 6e6f 7420 2873 6574 2873 656c 662e  f not (set(self.
+0002e500: 776f 726b 6572 7329 203d 3d20 7365 7428  workers) == set(
+0002e510: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+0002e520: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+0002e530: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+0002e540: 7228 2257 6f72 6b65 7273 206e 6f74 2074  r("Workers not t
+0002e550: 6865 2073 616d 6520 696e 2061 6c6c 2063  he same in all c
+0002e560: 6f6c 6c65 6374 696f 6e73 2229 0a0a 2020  ollections")..  
+0002e570: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0002e580: 662e 7275 6e6e 696e 672e 6973 7375 7065  f.running.issupe
+0002e590: 7273 6574 2873 656c 662e 6964 6c65 2e76  rset(self.idle.v
+0002e5a0: 616c 7565 7328 2929 2c20 280a 2020 2020  alues()), (.    
+0002e5b0: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+0002e5c0: 6e69 6e67 2e63 6f70 7928 292c 0a20 2020  ning.copy(),.   
+0002e5d0: 2020 2020 2020 2020 2073 6574 2873 656c           set(sel
+0002e5e0: 662e 6964 6c65 2e76 616c 7565 7328 2929  f.idle.values())
+0002e5f0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0002e600: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+0002e610: 7275 6e6e 696e 672e 6973 7375 7065 7273  running.issupers
+0002e620: 6574 2873 656c 662e 6964 6c65 5f74 6173  et(self.idle_tas
+0002e630: 6b5f 636f 756e 7429 2c20 280a 2020 2020  k_count), (.    
+0002e640: 2020 2020 2020 2020 7365 6c66 2e72 756e          self.run
+0002e650: 6e69 6e67 2e63 6f70 7928 292c 0a20 2020  ning.copy(),.   
+0002e660: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
+0002e670: 6c65 5f74 6173 6b5f 636f 756e 742e 636f  le_task_count.co
+0002e680: 7079 2829 2c0a 2020 2020 2020 2020 290a  py(),.        ).
+0002e690: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+0002e6a0: 656c 662e 7275 6e6e 696e 672e 6973 7375  elf.running.issu
+0002e6b0: 7065 7273 6574 2873 656c 662e 7361 7475  perset(self.satu
+0002e6c0: 7261 7465 6429 2c20 280a 2020 2020 2020  rated), (.      
+0002e6d0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+0002e6e0: 6e67 2e63 6f70 7928 292c 0a20 2020 2020  ng.copy(),.     
+0002e6f0: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
+0002e700: 7261 7465 642e 636f 7079 2829 2c0a 2020  rated.copy(),.  
+0002e710: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002e720: 6173 7365 7274 2073 656c 662e 7361 7475  assert self.satu
+0002e730: 7261 7465 642e 6973 6469 736a 6f69 6e74  rated.isdisjoint
+0002e740: 2873 656c 662e 6964 6c65 2e76 616c 7565  (self.idle.value
+0002e750: 7328 2929 2c20 280a 2020 2020 2020 2020  s()), (.        
+0002e760: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
+0002e770: 6564 2e63 6f70 7928 292c 0a20 2020 2020  ed.copy(),.     
+0002e780: 2020 2020 2020 2073 6574 2873 656c 662e         set(self.
+0002e790: 6964 6c65 2e76 616c 7565 7328 2929 2c0a  idle.values()),.
+0002e7a0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0002e7b0: 2020 2074 6173 6b5f 7072 6566 6978 5f63     task_prefix_c
+0002e7c0: 6f75 6e74 733a 2064 6566 6175 6c74 6469  ounts: defaultdi
+0002e7d0: 6374 5b73 7472 2c20 696e 745d 203d 2064  ct[str, int] = d
+0002e7e0: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
+0002e7f0: 2020 2020 2020 2020 666f 7220 772c 2077          for w, w
+0002e800: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0002e810: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0002e820: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0002e830: 696e 7374 616e 6365 2877 2c20 7374 7229  instance(w, str)
+0002e840: 2c20 2874 7970 6528 7729 2c20 7729 0a20  , (type(w), w). 
+0002e850: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002e860: 7420 6973 696e 7374 616e 6365 2877 732c  t isinstance(ws,
+0002e870: 2057 6f72 6b65 7253 7461 7465 292c 2028   WorkerState), (
+0002e880: 7479 7065 2877 7329 2c20 7773 290a 2020  type(ws), ws).  
+0002e890: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e8a0: 2077 732e 6164 6472 6573 7320 3d3d 2077   ws.address == w
+0002e8b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0002e8c0: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
+0002e8d0: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
+0002e8e0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002e8f0: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
+0002e900: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+0002e910: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0002e920: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002e930: 2077 7320 6e6f 7420 696e 2073 656c 662e   ws not in self.
+0002e940: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
+0002e950: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+0002e960: 732e 6164 6472 6573 7320 6e6f 7420 696e  s.address not in
+0002e970: 2073 656c 662e 6964 6c65 0a20 2020 2020   self.idle.     
+0002e980: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002e990: 7420 7773 206e 6f74 2069 6e20 7365 6c66  t ws not in self
+0002e9a0: 2e73 6174 7572 6174 6564 0a0a 2020 2020  .saturated..    
+0002e9b0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+0002e9c0: 732e 6c6f 6e67 5f72 756e 6e69 6e67 2e69  s.long_running.i
+0002e9d0: 7373 7562 7365 7428 7773 2e70 726f 6365  ssubset(ws.proce
+0002e9e0: 7373 696e 6729 0a20 2020 2020 2020 2020  ssing).         
+0002e9f0: 2020 2069 6620 6e6f 7420 7773 2e70 726f     if not ws.pro
+0002ea00: 6365 7373 696e 673a 0a20 2020 2020 2020  cessing:.       
+0002ea10: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002ea20: 6e6f 7420 7773 2e6f 6363 7570 616e 6379  not ws.occupancy
+0002ea30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ea40: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
+0002ea50: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+0002ea60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ea70: 2020 2020 2061 7373 6572 7420 7773 2e61       assert ws.a
+0002ea80: 6464 7265 7373 2069 6e20 7365 6c66 2e69  ddress in self.i
+0002ea90: 646c 650a 2020 2020 2020 2020 2020 2020  dle.            
+0002eaa0: 6173 7365 7274 206e 6f74 2077 732e 6e65  assert not ws.ne
+0002eab0: 6564 735f 7768 6174 2e6b 6579 7328 2920  eds_what.keys() 
+0002eac0: 2620 7773 2e68 6173 5f77 6861 740a 2020  & ws.has_what.  
+0002ead0: 2020 2020 2020 2020 2020 6163 7475 616c            actual
+0002eae0: 5f6e 6565 6473 5f77 6861 743a 2064 6566  _needs_what: def
+0002eaf0: 6175 6c74 6469 6374 5b54 6173 6b53 7461  aultdict[TaskSta
+0002eb00: 7465 2c20 696e 745d 203d 2064 6566 6175  te, int] = defau
+0002eb10: 6c74 6469 6374 2869 6e74 290a 2020 2020  ltdict(int).    
+0002eb20: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+0002eb30: 6e20 7773 2e70 726f 6365 7373 696e 673a  n ws.processing:
+0002eb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002eb50: 2066 6f72 2074 7373 2069 6e20 7473 2e64   for tss in ts.d
+0002eb60: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+0002eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eb80: 2069 6620 7473 7320 6e6f 7420 696e 2077   if tss not in w
+0002eb90: 732e 6861 735f 7768 6174 3a0a 2020 2020  s.has_what:.    
+0002eba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ebb0: 2020 2020 6163 7475 616c 5f6e 6565 6473      actual_needs
+0002ebc0: 5f77 6861 745b 7473 735d 202b 3d20 310a  _what[tss] += 1.
+0002ebd0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002ebe0: 7274 2061 6374 7561 6c5f 6e65 6564 735f  rt actual_needs_
+0002ebf0: 7768 6174 203d 3d20 7773 2e6e 6565 6473  what == ws.needs
+0002ec00: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
+0002ec10: 2020 6173 7365 7274 2028 7773 2e73 7461    assert (ws.sta
+0002ec20: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+0002ec30: 6e6e 696e 6729 203d 3d20 2877 7320 696e  nning) == (ws in
+0002ec40: 2073 656c 662e 7275 6e6e 696e 6729 0a20   self.running). 
+0002ec50: 2020 2020 2020 2020 2020 2066 6f72 206e             for n
+0002ec60: 616d 652c 2063 6f75 6e74 2069 6e20 7773  ame, count in ws
+0002ec70: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+0002ec80: 6e74 2e69 7465 6d73 2829 3a0a 2020 2020  nt.items():.    
+0002ec90: 2020 2020 2020 2020 2020 2020 7461 736b              task
+0002eca0: 5f70 7265 6669 785f 636f 756e 7473 5b6e  _prefix_counts[n
+0002ecb0: 616d 655d 202b 3d20 636f 756e 740a 0a20  ame] += count.. 
+0002ecc0: 2020 2020 2020 2061 7373 6572 7420 7461         assert ta
+0002ecd0: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
+0002ece0: 2e6b 6579 7328 2920 3d3d 2073 656c 662e  .keys() == self.
+0002ecf0: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+0002ed00: 6e74 5f67 6c6f 6261 6c2e 6b65 7973 2829  nt_global.keys()
+0002ed10: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+0002ed20: 652c 2067 6c6f 6261 6c5f 636f 756e 7420  e, global_count 
+0002ed30: 696e 2073 656c 662e 5f74 6173 6b5f 7072  in self._task_pr
+0002ed40: 6566 6978 5f63 6f75 6e74 5f67 6c6f 6261  efix_count_globa
+0002ed50: 6c2e 6974 656d 7328 293a 0a20 2020 2020  l.items():.     
+0002ed60: 2020 2020 2020 2061 7373 6572 7420 280a         assert (.
+0002ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ed80: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+0002ed90: 7473 5b6e 616d 655d 203d 3d20 676c 6f62  ts[name] == glob
+0002eda0: 616c 5f63 6f75 6e74 0a20 2020 2020 2020  al_count.       
+0002edb0: 2020 2020 2029 2c20 6622 7b6e 616d 657d       ), f"{name}
+0002edc0: 3a20 7b74 6173 6b5f 7072 6566 6978 5f63  : {task_prefix_c
+0002edd0: 6f75 6e74 735b 6e61 6d65 5d7d 2028 7773  ounts[name]} (ws
+0002ede0: 7329 2c20 7b67 6c6f 6261 6c5f 636f 756e  s), {global_coun
+0002edf0: 747d 2028 676c 6f62 616c 2922 0a0a 2020  t} (global)"..  
+0002ee00: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0002ee10: 7365 6c66 2e72 756e 6e69 6e67 3a0a 2020  self.running:.  
+0002ee20: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002ee30: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
+0002ee40: 6174 7573 2e72 756e 6e69 6e67 0a20 2020  atus.running.   
+0002ee50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0002ee60: 7773 2e61 6464 7265 7373 2069 6e20 7365  ws.address in se
+0002ee70: 6c66 2e77 6f72 6b65 7273 0a0a 2020 2020  lf.workers..    
+0002ee80: 2020 2020 666f 7220 6b2c 2074 7320 696e      for k, ts in
+0002ee90: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
+0002eea0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0002eeb0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+0002eec0: 6365 2874 732c 2054 6173 6b53 7461 7465  ce(ts, TaskState
+0002eed0: 292c 2028 7479 7065 2874 7329 2c20 7473  ), (type(ts), ts
+0002eee0: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+0002eef0: 7365 7274 2074 732e 6b65 7920 3d3d 206b  sert ts.key == k
+0002ef00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002ef10: 6572 7420 626f 6f6c 2874 7320 696e 2073  ert bool(ts in s
+0002ef20: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
+0002ef30: 6173 6b73 2920 3d3d 2028 6c65 6e28 7473  asks) == (len(ts
+0002ef40: 2e77 686f 5f68 6173 2920 3e20 3129 0a20  .who_has) > 1). 
+0002ef50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002ef60: 7661 6c69 6461 7465 5f6b 6579 286b 2c20  validate_key(k, 
+0002ef70: 7473 290a 0a20 2020 2020 2020 2066 6f72  ts)..        for
+0002ef80: 2074 7320 696e 2073 656c 662e 7265 706c   ts in self.repl
+0002ef90: 6963 6174 6564 5f74 6173 6b73 3a0a 2020  icated_tasks:.  
+0002efa0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002efb0: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
+0002efc0: 6d6f 7279 220a 2020 2020 2020 2020 2020  mory".          
+0002efd0: 2020 6173 7365 7274 2074 732e 6b65 7920    assert ts.key 
+0002efe0: 696e 2073 656c 662e 7461 736b 730a 0a20  in self.tasks.. 
+0002eff0: 2020 2020 2020 2066 6f72 2063 2c20 6373         for c, cs
+0002f000: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
+0002f010: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0002f020: 2020 2020 2020 2320 636c 6965 6e74 3d4e        # client=N
+0002f030: 6f6e 6520 6973 206f 6674 656e 2075 7365  one is often use
+0002f040: 6420 696e 2074 6573 7473 2e2e 2e0a 2020  d in tests....  
+0002f050: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0002f060: 2063 2069 7320 4e6f 6e65 206f 7220 7479   c is None or ty
+0002f070: 7065 2863 2920 3d3d 2073 7472 2c20 2874  pe(c) == str, (t
+0002f080: 7970 6528 6329 2c20 6329 0a20 2020 2020  ype(c), c).     
+0002f090: 2020 2020 2020 2061 7373 6572 7420 7479         assert ty
+0002f0a0: 7065 2863 7329 203d 3d20 436c 6965 6e74  pe(cs) == Client
+0002f0b0: 5374 6174 652c 2028 7479 7065 2863 7329  State, (type(cs)
+0002f0c0: 2c20 6373 290a 2020 2020 2020 2020 2020  , cs).          
+0002f0d0: 2020 6173 7365 7274 2063 732e 636c 6965    assert cs.clie
+0002f0e0: 6e74 5f6b 6579 203d 3d20 630a 0a20 2020  nt_key == c..   
+0002f0f0: 2020 2020 2061 203d 207b 773a 2077 732e       a = {w: ws.
+0002f100: 6e62 7974 6573 2066 6f72 2077 2c20 7773  nbytes for w, ws
+0002f110: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0002f120: 2e69 7465 6d73 2829 7d0a 2020 2020 2020  .items()}.      
+0002f130: 2020 6220 3d20 7b0a 2020 2020 2020 2020    b = {.        
+0002f140: 2020 2020 773a 2073 756d 2874 732e 6765      w: sum(ts.ge
+0002f150: 745f 6e62 7974 6573 2829 2066 6f72 2074  t_nbytes() for t
+0002f160: 7320 696e 2077 732e 6861 735f 7768 6174  s in ws.has_what
+0002f170: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0002f180: 7220 772c 2077 7320 696e 2073 656c 662e  r w, ws in self.
+0002f190: 776f 726b 6572 732e 6974 656d 7328 290a  workers.items().
+0002f1a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0002f1b0: 2020 6173 7365 7274 2061 203d 3d20 622c    assert a == b,
+0002f1c0: 2028 612c 2062 290a 0a20 2020 2020 2020   (a, b)..       
+0002f1d0: 2069 6620 7365 6c66 2e74 7261 6e73 6974   if self.transit
+0002f1e0: 696f 6e5f 636f 756e 7465 725f 6d61 783a  ion_counter_max:
+0002f1f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0002f200: 6572 7420 7365 6c66 2e74 7261 6e73 6974  ert self.transit
+0002f210: 696f 6e5f 636f 756e 7465 7220 3c20 7365  ion_counter < se
+0002f220: 6c66 2e74 7261 6e73 6974 696f 6e5f 636f  lf.transition_co
+0002f230: 756e 7465 725f 6d61 780a 0a20 2020 2023  unter_max..    #
+0002f240: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002f250: 2323 0a20 2020 2023 204d 616e 6167 6520  ##.    # Manage 
+0002f260: 4d65 7373 6167 6573 2023 0a20 2020 2023  Messages #.    #
+0002f270: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0002f280: 2323 0a0a 2020 2020 6465 6620 7265 706f  ##..    def repo
+0002f290: 7274 280a 2020 2020 2020 2020 7365 6c66  rt(.        self
+0002f2a0: 2c20 6d73 673a 2064 6963 742c 2074 733a  , msg: dict, ts:
+0002f2b0: 2054 6173 6b53 7461 7465 207c 204e 6f6e   TaskState | Non
+0002f2c0: 6520 3d20 4e6f 6e65 2c20 636c 6965 6e74  e = None, client
+0002f2d0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+0002f2e0: 6f6e 650a 2020 2020 2920 2d3e 204e 6f6e  one.    ) -> Non
+0002f2f0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+0002f300: 2020 2020 2020 2050 7562 6c69 7368 2075         Publish u
+0002f310: 7064 6174 6573 2074 6f20 616c 6c20 6c69  pdates to all li
+0002f320: 7374 656e 696e 6720 5175 6575 6573 2061  stening Queues a
+0002f330: 6e64 2043 6f6d 6d73 0a0a 2020 2020 2020  nd Comms..      
+0002f340: 2020 4966 2074 6865 206d 6573 7361 6765    If the message
+0002f350: 2063 6f6e 7461 696e 7320 6120 6b65 7920   contains a key 
+0002f360: 7468 656e 2077 6520 6f6e 6c79 2073 656e  then we only sen
+0002f370: 6420 7468 6520 6d65 7373 6167 6520 746f  d the message to
+0002f380: 2074 686f 7365 0a20 2020 2020 2020 2063   those.        c
+0002f390: 6f6d 6d73 2074 6861 7420 6361 7265 2061  omms that care a
+0002f3a0: 626f 7574 2074 6865 206b 6579 2e0a 2020  bout the key..  
+0002f3b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0002f3c0: 2020 6966 2074 7320 6973 204e 6f6e 653a    if ts is None:
+0002f3d0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0002f3e0: 5f6b 6579 203d 206d 7367 2e67 6574 2822  _key = msg.get("
+0002f3f0: 6b65 7922 290a 2020 2020 2020 2020 2020  key").          
+0002f400: 2020 6966 206d 7367 5f6b 6579 2069 7320    if msg_key is 
+0002f410: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0002f420: 2020 2020 2020 2020 2020 7461 736b 733a            tasks:
+0002f430: 2064 6963 7420 3d20 7365 6c66 2e74 6173   dict = self.tas
+0002f440: 6b73 0a20 2020 2020 2020 2020 2020 2020  ks.             
+0002f450: 2020 2074 7320 3d20 7461 736b 732e 6765     ts = tasks.ge
+0002f460: 7428 6d73 675f 6b65 7929 0a0a 2020 2020  t(msg_key)..    
+0002f470: 2020 2020 636c 6965 6e74 5f63 6f6d 6d73      client_comms
+0002f480: 3a20 6469 6374 203d 2073 656c 662e 636c  : dict = self.cl
+0002f490: 6965 6e74 5f63 6f6d 6d73 0a20 2020 2020  ient_comms.     
+0002f4a0: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
+0002f4b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0002f4c0: 4e6f 7469 6679 2061 6c6c 2063 6c69 656e  Notify all clien
+0002f4d0: 7473 0a20 2020 2020 2020 2020 2020 2063  ts.            c
+0002f4e0: 6c69 656e 745f 6b65 7973 203d 206c 6973  lient_keys = lis
+0002f4f0: 7428 636c 6965 6e74 5f63 6f6d 6d73 290a  t(client_comms).
+0002f500: 2020 2020 2020 2020 656c 6966 2063 6c69          elif cli
+0002f510: 656e 7420 6973 204e 6f6e 653a 0a20 2020  ent is None:.   
+0002f520: 2020 2020 2020 2020 2023 204e 6f74 6966           # Notif
+0002f530: 7920 636c 6965 6e74 7320 696e 7465 7265  y clients intere
+0002f540: 7374 6564 2069 6e20 6b65 790a 2020 2020  sted in key.    
+0002f550: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
+0002f560: 6579 7320 3d20 5b63 732e 636c 6965 6e74  eys = [cs.client
+0002f570: 5f6b 6579 2066 6f72 2063 7320 696e 2074  _key for cs in t
+0002f580: 732e 7768 6f5f 7761 6e74 735d 0a20 2020  s.who_wants].   
+0002f590: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002f5a0: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
+0002f5b0: 636c 6965 6e74 7320 696e 7465 7265 7374  clients interest
+0002f5c0: 6564 2069 6e20 6b65 7920 2869 6e63 6c75  ed in key (inclu
+0002f5d0: 6469 6e67 2060 636c 6965 6e74 6029 0a20  ding `client`). 
+0002f5e0: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+0002f5f0: 745f 6b65 7973 203d 205b 0a20 2020 2020  t_keys = [.     
+0002f600: 2020 2020 2020 2020 2020 2063 732e 636c             cs.cl
+0002f610: 6965 6e74 5f6b 6579 2066 6f72 2063 7320  ient_key for cs 
+0002f620: 696e 2074 732e 7768 6f5f 7761 6e74 7320  in ts.who_wants 
+0002f630: 6966 2063 732e 636c 6965 6e74 5f6b 6579  if cs.client_key
+0002f640: 2021 3d20 636c 6965 6e74 0a20 2020 2020   != client.     
+0002f650: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+0002f660: 2020 2020 2063 6c69 656e 745f 6b65 7973       client_keys
+0002f670: 2e61 7070 656e 6428 636c 6965 6e74 290a  .append(client).
+0002f680: 0a20 2020 2020 2020 206b 3a20 7374 720a  .        k: str.
+0002f690: 2020 2020 2020 2020 666f 7220 6b20 696e          for k in
+0002f6a0: 2063 6c69 656e 745f 6b65 7973 3a0a 2020   client_keys:.  
+0002f6b0: 2020 2020 2020 2020 2020 6320 3d20 636c            c = cl
+0002f6c0: 6965 6e74 5f63 6f6d 6d73 2e67 6574 286b  ient_comms.get(k
+0002f6d0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0002f6e0: 2063 2069 7320 4e6f 6e65 3a0a 2020 2020   c is None:.    
+0002f6f0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0002f700: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+0002f710: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002f720: 2020 2020 2020 632e 7365 6e64 286d 7367        c.send(msg
+0002f730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002f740: 2020 2320 6c6f 6767 6572 2e64 6562 7567    # logger.debug
+0002f750: 2822 5363 6865 6475 6c65 7220 7365 6e64  ("Scheduler send
+0002f760: 7320 6d65 7373 6167 6520 746f 2063 6c69  s message to cli
+0002f770: 656e 7420 2573 222c 206d 7367 290a 2020  ent %s", msg).  
+0002f780: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002f790: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
+0002f7a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f7b0: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+0002f7c0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0002f7d0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+0002f7e0: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
+0002f7f0: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
+0002f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f810: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
+0002f820: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
+0002f830: 2077 7269 7465 2025 7322 2c20 632c 206d   write %s", c, m
+0002f840: 7367 2c20 6578 635f 696e 666f 3d54 7275  sg, exc_info=Tru
+0002f850: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0002f860: 2020 2020 2020 290a 0a20 2020 2061 7379        )..    asy
+0002f870: 6e63 2064 6566 2061 6464 5f63 6c69 656e  nc def add_clien
+0002f880: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+0002f890: 2063 6f6d 6d3a 2043 6f6d 6d2c 2063 6c69   comm: Comm, cli
+0002f8a0: 656e 743a 2073 7472 2c20 7665 7273 696f  ent: str, versio
+0002f8b0: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
+0002f8c0: 795d 0a20 2020 2029 202d 3e20 4e6f 6e65  y].    ) -> None
+0002f8d0: 3a0a 2020 2020 2020 2020 2222 2241 6464  :.        """Add
+0002f8e0: 2063 6c69 656e 7420 746f 206e 6574 776f   client to netwo
+0002f8f0: 726b 0a0a 2020 2020 2020 2020 5765 206c  rk..        We l
+0002f900: 6973 7465 6e20 746f 2061 6c6c 2066 7574  isten to all fut
+0002f910: 7572 6520 6d65 7373 6167 6573 2066 726f  ure messages fro
+0002f920: 6d20 7468 6973 2043 6f6d 6d2e 0a20 2020  m this Comm..   
+0002f930: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002f940: 2061 7373 6572 7420 636c 6965 6e74 2069   assert client i
+0002f950: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+0002f960: 2020 2063 6f6d 6d2e 6e61 6d65 203d 2022     comm.name = "
+0002f970: 5363 6865 6475 6c65 722d 3e43 6c69 656e  Scheduler->Clien
+0002f980: 7422 0a20 2020 2020 2020 206c 6f67 6765  t".        logge
+0002f990: 722e 696e 666f 2822 5265 6365 6976 6520  r.info("Receive 
+0002f9a0: 636c 6965 6e74 2063 6f6e 6e65 6374 696f  client connectio
+0002f9b0: 6e3a 2025 7322 2c20 636c 6965 6e74 290a  n: %s", client).
+0002f9c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0002f9d0: 5f65 7665 6e74 285b 2261 6c6c 222c 2063  _event(["all", c
+0002f9e0: 6c69 656e 745d 2c20 7b22 6163 7469 6f6e  lient], {"action
+0002f9f0: 223a 2022 6164 642d 636c 6965 6e74 222c  ": "add-client",
+0002fa00: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
+0002fa10: 747d 290a 2020 2020 2020 2020 7365 6c66  t}).        self
+0002fa20: 2e63 6c69 656e 7473 5b63 6c69 656e 745d  .clients[client]
+0002fa30: 203d 2043 6c69 656e 7453 7461 7465 2863   = ClientState(c
+0002fa40: 6c69 656e 742c 2076 6572 7369 6f6e 733d  lient, versions=
+0002fa50: 7665 7273 696f 6e73 290a 0a20 2020 2020  versions)..     
+0002fa60: 2020 2066 6f72 2070 6c75 6769 6e20 696e     for plugin in
+0002fa70: 206c 6973 7428 7365 6c66 2e70 6c75 6769   list(self.plugi
+0002fa80: 6e73 2e76 616c 7565 7328 2929 3a0a 2020  ns.values()):.  
+0002fa90: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0002faa0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0002fab0: 6c75 6769 6e2e 6164 645f 636c 6965 6e74  lugin.add_client
+0002fac0: 2873 6368 6564 756c 6572 3d73 656c 662c  (scheduler=self,
+0002fad0: 2063 6c69 656e 743d 636c 6965 6e74 290a   client=client).
+0002fae0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002faf0: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+0002fb00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002fb10: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+0002fb20: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
+0002fb30: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0002fb40: 2062 636f 6d6d 203d 2042 6174 6368 6564   bcomm = Batched
+0002fb50: 5365 6e64 2869 6e74 6572 7661 6c3d 2232  Send(interval="2
+0002fb60: 6d73 222c 206c 6f6f 703d 7365 6c66 2e6c  ms", loop=self.l
+0002fb70: 6f6f 7029 0a20 2020 2020 2020 2020 2020  oop).           
+0002fb80: 2062 636f 6d6d 2e73 7461 7274 2863 6f6d   bcomm.start(com
+0002fb90: 6d29 0a20 2020 2020 2020 2020 2020 2073  m).            s
+0002fba0: 656c 662e 636c 6965 6e74 5f63 6f6d 6d73  elf.client_comms
+0002fbb0: 5b63 6c69 656e 745d 203d 2062 636f 6d6d  [client] = bcomm
+0002fbc0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0002fbd0: 203d 207b 226f 7022 3a20 2273 7472 6561   = {"op": "strea
+0002fbe0: 6d2d 7374 6172 7422 7d0a 2020 2020 2020  m-start"}.      
+0002fbf0: 2020 2020 2020 7665 7273 696f 6e5f 7761        version_wa
+0002fc00: 726e 696e 6720 3d20 7665 7273 696f 6e5f  rning = version_
+0002fc10: 6d6f 6475 6c65 2e65 7272 6f72 5f6d 6573  module.error_mes
+0002fc20: 7361 6765 280a 2020 2020 2020 2020 2020  sage(.          
+0002fc30: 2020 2020 2020 7665 7273 696f 6e5f 6d6f        version_mo
+0002fc40: 6475 6c65 2e67 6574 5f76 6572 7369 6f6e  dule.get_version
+0002fc50: 7328 292c 0a20 2020 2020 2020 2020 2020  s(),.           
+0002fc60: 2020 2020 207b 773a 2077 732e 7665 7273       {w: ws.vers
+0002fc70: 696f 6e73 2066 6f72 2077 2c20 7773 2069  ions for w, ws i
+0002fc80: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e69  n self.workers.i
+0002fc90: 7465 6d73 2829 7d2c 0a20 2020 2020 2020  tems()},.       
+0002fca0: 2020 2020 2020 2020 2076 6572 7369 6f6e           version
+0002fcb0: 732c 0a20 2020 2020 2020 2020 2020 2029  s,.            )
+0002fcc0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0002fcd0: 2e75 7064 6174 6528 7665 7273 696f 6e5f  .update(version_
+0002fce0: 7761 726e 696e 6729 0a20 2020 2020 2020  warning).       
+0002fcf0: 2020 2020 2062 636f 6d6d 2e73 656e 6428       bcomm.send(
+0002fd00: 6d73 6729 0a0a 2020 2020 2020 2020 2020  msg)..          
+0002fd10: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0002fd20: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+0002fd30: 662e 6861 6e64 6c65 5f73 7472 6561 6d28  f.handle_stream(
+0002fd40: 636f 6d6d 3d63 6f6d 6d2c 2065 7874 7261  comm=comm, extra
+0002fd50: 3d7b 2263 6c69 656e 7422 3a20 636c 6965  ={"client": clie
+0002fd60: 6e74 7d29 0a20 2020 2020 2020 2020 2020  nt}).           
+0002fd70: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+0002fd80: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+0002fd90: 656d 6f76 655f 636c 6965 6e74 2863 6c69  emove_client(cli
+0002fda0: 656e 743d 636c 6965 6e74 2c20 7374 696d  ent=client, stim
+0002fdb0: 756c 7573 5f69 643d 6622 7265 6d6f 7665  ulus_id=f"remove
+0002fdc0: 2d63 6c69 656e 742d 7b74 696d 6528 297d  -client-{time()}
+0002fdd0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0002fde0: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+0002fdf0: 2246 696e 6973 6865 6420 6861 6e64 6c69  "Finished handli
+0002fe00: 6e67 2063 6c69 656e 7420 2573 222c 2063  ng client %s", c
+0002fe10: 6c69 656e 7429 0a20 2020 2020 2020 2066  lient).        f
+0002fe20: 696e 616c 6c79 3a0a 2020 2020 2020 2020  inally:.        
+0002fe30: 2020 2020 6966 206e 6f74 2063 6f6d 6d2e      if not comm.
+0002fe40: 636c 6f73 6564 2829 3a0a 2020 2020 2020  closed():.      
+0002fe50: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0002fe60: 6c69 656e 745f 636f 6d6d 735b 636c 6965  lient_comms[clie
+0002fe70: 6e74 5d2e 7365 6e64 287b 226f 7022 3a20  nt].send({"op": 
+0002fe80: 2273 7472 6561 6d2d 636c 6f73 6564 227d  "stream-closed"}
+0002fe90: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
+0002fea0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002feb0: 2020 2069 6620 6e6f 7420 7379 732e 6973     if not sys.is
+0002fec0: 5f66 696e 616c 697a 696e 6728 293a 0a20  _finalizing():. 
+0002fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fee0: 2020 2061 7761 6974 2073 656c 662e 636c     await self.cl
+0002fef0: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
+0002ff00: 745d 2e63 6c6f 7365 2829 0a20 2020 2020  t].close().     
+0002ff10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002ff20: 656c 2073 656c 662e 636c 6965 6e74 5f63  el self.client_c
+0002ff30: 6f6d 6d73 5b63 6c69 656e 745d 0a20 2020  omms[client].   
+0002ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ff50: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+0002ff60: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+0002ff70: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0002ff80: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+0002ff90: 722e 696e 666f 2822 436c 6f73 6520 636c  r.info("Close cl
+0002ffa0: 6965 6e74 2063 6f6e 6e65 6374 696f 6e3a  ient connection:
+0002ffb0: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
+0002ffc0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002ffd0: 2054 7970 6545 7272 6f72 3a20 2023 2063   TypeError:  # c
+0002ffe0: 6f6d 6d20 6265 636f 6d65 7320 4e6f 6e65  omm becomes None
+0002fff0: 2064 7572 696e 6720 4743 0a20 2020 2020   during GC.     
+00030000: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00030010: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00030020: 636c 6965 6e74 2873 656c 662c 2063 6c69  client(self, cli
+00030030: 656e 743a 2073 7472 2c20 7374 696d 756c  ent: str, stimul
+00030040: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
+00030050: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
+00030060: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00030070: 6d6f 7665 2063 6c69 656e 7420 6672 6f6d  move client from
+00030080: 206e 6574 776f 726b 2222 220a 2020 2020   network""".    
+00030090: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+000300a0: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
+000300b0: 2066 2272 656d 6f76 652d 636c 6965 6e74   f"remove-client
+000300c0: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
+000300d0: 2020 2069 6620 7365 6c66 2e73 7461 7475     if self.statu
+000300e0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
+000300f0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00030100: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+00030110: 6d6f 7665 2063 6c69 656e 7420 2573 222c  move client %s",
+00030120: 2063 6c69 656e 7429 0a20 2020 2020 2020   client).       
+00030130: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00030140: 5b22 616c 6c22 2c20 636c 6965 6e74 5d2c  ["all", client],
+00030150: 207b 2261 6374 696f 6e22 3a20 2272 656d   {"action": "rem
+00030160: 6f76 652d 636c 6965 6e74 222c 2022 636c  ove-client", "cl
+00030170: 6965 6e74 223a 2063 6c69 656e 747d 290a  ient": client}).
+00030180: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00030190: 2020 2020 2020 2020 2063 733a 2043 6c69           cs: Cli
+000301a0: 656e 7453 7461 7465 203d 2073 656c 662e  entState = self.
+000301b0: 636c 6965 6e74 735b 636c 6965 6e74 5d0a  clients[client].
+000301c0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+000301d0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+000301e0: 2020 2020 2023 2058 5858 2069 7320 7468       # XXX is th
+000301f0: 6973 2061 206c 6567 6974 696d 6174 6520  is a legitimate 
+00030200: 636f 6e64 6974 696f 6e3f 0a20 2020 2020  condition?.     
+00030210: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+00030220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030230: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
+00030240: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
+00030250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030260: 206b 6579 733d 5b74 732e 6b65 7920 666f   keys=[ts.key fo
+00030270: 7220 7473 2069 6e20 6373 2e77 616e 7473  r ts in cs.wants
+00030280: 5f77 6861 745d 2c0a 2020 2020 2020 2020  _what],.        
+00030290: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
+000302a0: 732e 636c 6965 6e74 5f6b 6579 2c0a 2020  s.client_key,.  
+000302b0: 2020 2020 2020 2020 2020 2020 2020 7374                st
+000302c0: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+000302d0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+000302e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000302f0: 2064 656c 2073 656c 662e 636c 6965 6e74   del self.client
+00030300: 735b 636c 6965 6e74 5d0a 0a20 2020 2020  s[client]..     
+00030310: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
+00030320: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
+00030330: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
+00030340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00030350: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00030360: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+00030370: 6e2e 7265 6d6f 7665 5f63 6c69 656e 7428  n.remove_client(
+00030380: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+00030390: 636c 6965 6e74 3d63 6c69 656e 7429 0a20  client=client). 
+000303a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000303b0: 7863 6570 7420 4578 6365 7074 696f 6e20  xcept Exception 
+000303c0: 6173 2065 3a0a 2020 2020 2020 2020 2020  as e:.          
+000303d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+000303e0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+000303f0: 2020 2020 2020 2061 7379 6e63 2064 6566         async def
+00030400: 2072 656d 6f76 655f 636c 6965 6e74 5f66   remove_client_f
+00030410: 726f 6d5f 6576 656e 7473 2829 3a0a 2020  rom_events():.  
+00030420: 2020 2020 2020 2020 2020 2320 4966 2074            # If t
+00030430: 6865 2063 6c69 656e 7420 6973 6e27 7420  he client isn't 
+00030440: 7265 6769 7374 6572 6564 2061 6e79 6d6f  registered anymo
+00030450: 7265 2061 6674 6572 2074 6865 2064 656c  re after the del
+00030460: 6179 2c20 7265 6d6f 7665 2066 726f 6d20  ay, remove from 
+00030470: 6576 656e 7473 0a20 2020 2020 2020 2020  events.         
+00030480: 2020 2069 6620 636c 6965 6e74 206e 6f74     if client not
+00030490: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
+000304a0: 2061 6e64 2063 6c69 656e 7420 696e 2073   and client in s
+000304b0: 656c 662e 6576 656e 7473 3a0a 2020 2020  elf.events:.    
+000304c0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+000304d0: 7365 6c66 2e65 7665 6e74 735b 636c 6965  self.events[clie
+000304e0: 6e74 5d0a 0a20 2020 2020 2020 2063 6c65  nt]..        cle
+000304f0: 616e 7570 5f64 656c 6179 203d 2070 6172  anup_delay = par
+00030500: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
+00030510: 2020 2020 2020 2020 2020 6461 736b 2e63            dask.c
+00030520: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+00030530: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+00030540: 2e65 7665 6e74 732d 636c 6561 6e75 702d  .events-cleanup-
+00030550: 6465 6c61 7922 290a 2020 2020 2020 2020  delay").        
+00030560: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+00030570: 2073 656c 662e 5f6f 6e67 6f69 6e67 5f62   self._ongoing_b
+00030580: 6163 6b67 726f 756e 645f 7461 736b 732e  ackground_tasks.
+00030590: 636c 6f73 6564 3a0a 2020 2020 2020 2020  closed:.        
+000305a0: 2020 2020 7365 6c66 2e5f 6f6e 676f 696e      self._ongoin
+000305b0: 675f 6261 636b 6772 6f75 6e64 5f74 6173  g_background_tas
+000305c0: 6b73 2e63 616c 6c5f 6c61 7465 7228 0a20  ks.call_later(. 
+000305d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000305e0: 6c65 616e 7570 5f64 656c 6179 2c20 7265  leanup_delay, re
+000305f0: 6d6f 7665 5f63 6c69 656e 745f 6672 6f6d  move_client_from
+00030600: 5f65 7665 6e74 730a 2020 2020 2020 2020  _events.        
+00030610: 2020 2020 290a 0a20 2020 2064 6566 2073      )..    def s
+00030620: 656e 645f 7461 736b 5f74 6f5f 776f 726b  end_task_to_work
+00030630: 6572 280a 2020 2020 2020 2020 7365 6c66  er(.        self
+00030640: 2c20 776f 726b 6572 3a20 7374 722c 2074  , worker: str, t
+00030650: 733a 2054 6173 6b53 7461 7465 2c20 6475  s: TaskState, du
+00030660: 7261 7469 6f6e 3a20 666c 6f61 7420 3d20  ration: float = 
+00030670: 2d31 0a20 2020 2029 202d 3e20 4e6f 6e65  -1.    ) -> None
+00030680: 3a0a 2020 2020 2020 2020 2222 2253 656e  :.        """Sen
+00030690: 6420 6120 7369 6e67 6c65 2063 6f6d 7075  d a single compu
+000306a0: 7461 7469 6f6e 616c 2074 6173 6b20 746f  tational task to
+000306b0: 2061 2077 6f72 6b65 7222 2222 0a20 2020   a worker""".   
+000306c0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+000306d0: 2020 2020 2020 6d73 673a 2064 6963 7420        msg: dict 
+000306e0: 3d20 7365 6c66 2e5f 7461 736b 5f74 6f5f  = self._task_to_
+000306f0: 6d73 6728 7473 2c20 6475 7261 7469 6f6e  msg(ts, duration
+00030700: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00030710: 6c66 2e77 6f72 6b65 725f 7365 6e64 2877  lf.worker_send(w
+00030720: 6f72 6b65 722c 206d 7367 290a 2020 2020  orker, msg).    
+00030730: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00030740: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00030750: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+00030760: 6365 7074 696f 6e28 6529 0a20 2020 2020  ception(e).     
+00030770: 2020 2020 2020 2069 6620 4c4f 475f 5044         if LOG_PD
+00030780: 423a 0a20 2020 2020 2020 2020 2020 2020  B:.             
+00030790: 2020 2069 6d70 6f72 7420 7064 620a 0a20     import pdb.. 
+000307a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000307b0: 6462 2e73 6574 5f74 7261 6365 2829 0a20  db.set_trace(). 
+000307c0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000307d0: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
+000307e0: 5f75 6e63 6175 6768 745f 6572 726f 7228  _uncaught_error(
+000307f0: 7365 6c66 2c20 2a2a 6d73 673a 2041 6e79  self, **msg: Any
+00030800: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00030810: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+00030820: 696f 6e28 636c 6561 6e5f 6578 6365 7074  ion(clean_except
+00030830: 696f 6e28 2a2a 6d73 6729 5b31 5d29 0a0a  ion(**msg)[1])..
+00030840: 2020 2020 6465 6620 6861 6e64 6c65 5f74      def handle_t
+00030850: 6173 6b5f 6669 6e69 7368 6564 280a 2020  ask_finished(.  
+00030860: 2020 2020 2020 7365 6c66 2c20 6b65 793a        self, key:
+00030870: 2073 7472 2c20 776f 726b 6572 3a20 7374   str, worker: st
+00030880: 722c 2073 7469 6d75 6c75 735f 6964 3a20  r, stimulus_id: 
+00030890: 7374 722c 202a 2a6d 7367 3a20 416e 790a  str, **msg: Any.
+000308a0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+000308b0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+000308c0: 206e 6f74 2069 6e20 7365 6c66 2e77 6f72   not in self.wor
+000308d0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+000308e0: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+000308f0: 2076 616c 6964 6174 655f 6b65 7928 6b65   validate_key(ke
+00030900: 7929 0a0a 2020 2020 2020 2020 723a 2074  y)..        r: t
+00030910: 7570 6c65 203d 2073 656c 662e 7374 696d  uple = self.stim
+00030920: 756c 7573 5f74 6173 6b5f 6669 6e69 7368  ulus_task_finish
+00030930: 6564 280a 2020 2020 2020 2020 2020 2020  ed(.            
+00030940: 6b65 793d 6b65 792c 2077 6f72 6b65 723d  key=key, worker=
+00030950: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
+00030960: 5f69 643d 7374 696d 756c 7573 5f69 642c  _id=stimulus_id,
+00030970: 202a 2a6d 7367 0a20 2020 2020 2020 2029   **msg.        )
+00030980: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00030990: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+000309a0: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+000309b0: 6773 203d 2072 0a20 2020 2020 2020 2073  gs = r.        s
+000309c0: 656c 662e 5f74 7261 6e73 6974 696f 6e73  elf._transitions
+000309d0: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
+000309e0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+000309f0: 6f72 6b65 725f 6d73 6773 2c20 7374 696d  orker_msgs, stim
+00030a00: 756c 7573 5f69 6429 0a20 2020 2020 2020  ulus_id).       
+00030a10: 2073 656c 662e 7365 6e64 5f61 6c6c 2863   self.send_all(c
+00030a20: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+00030a30: 6572 5f6d 7367 7329 0a0a 2020 2020 2020  er_msgs)..      
+00030a40: 2020 7365 6c66 2e73 7469 6d75 6c75 735f    self.stimulus_
+00030a50: 7175 6575 655f 736c 6f74 735f 6d61 7962  queue_slots_mayb
+00030a60: 655f 6f70 656e 6564 2873 7469 6d75 6c75  e_opened(stimulu
+00030a70: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+00030a80: 290a 0a20 2020 2064 6566 2068 616e 646c  )..    def handl
+00030a90: 655f 7461 736b 5f65 7272 6564 2873 656c  e_task_erred(sel
+00030aa0: 662c 206b 6579 3a20 7374 722c 2073 7469  f, key: str, sti
+00030ab0: 6d75 6c75 735f 6964 3a20 7374 722c 202a  mulus_id: str, *
+00030ac0: 2a6d 7367 3a20 416e 7929 202d 3e20 4e6f  *msg: Any) -> No
+00030ad0: 6e65 3a0a 2020 2020 2020 2020 723a 2074  ne:.        r: t
+00030ae0: 7570 6c65 203d 2073 656c 662e 7374 696d  uple = self.stim
+00030af0: 756c 7573 5f74 6173 6b5f 6572 7265 6428  ulus_task_erred(
+00030b00: 6b65 793d 6b65 792c 2073 7469 6d75 6c75  key=key, stimulu
+00030b10: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+00030b20: 2c20 2a2a 6d73 6729 0a20 2020 2020 2020  , **msg).       
+00030b30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00030b40: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
+00030b50: 6f72 6b65 725f 6d73 6773 203d 2072 0a20  orker_msgs = r. 
+00030b60: 2020 2020 2020 2073 656c 662e 5f74 7261         self._tra
+00030b70: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
+00030b80: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+00030b90: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
+00030ba0: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
+00030bb0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00030bc0: 6e64 5f61 6c6c 2863 6c69 656e 745f 6d73  nd_all(client_ms
+00030bd0: 6773 2c20 776f 726b 6572 5f6d 7367 7329  gs, worker_msgs)
+00030be0: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00030bf0: 7469 6d75 6c75 735f 7175 6575 655f 736c  timulus_queue_sl
+00030c00: 6f74 735f 6d61 7962 655f 6f70 656e 6564  ots_maybe_opened
+00030c10: 2873 7469 6d75 6c75 735f 6964 3d73 7469  (stimulus_id=sti
+00030c20: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
+00030c30: 6566 2072 656c 6561 7365 5f77 6f72 6b65  ef release_worke
+00030c40: 725f 6461 7461 2873 656c 662c 206b 6579  r_data(self, key
+00030c50: 3a20 7374 722c 2077 6f72 6b65 723a 2073  : str, worker: s
+00030c60: 7472 2c20 7374 696d 756c 7573 5f69 643a  tr, stimulus_id:
+00030c70: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+00030c80: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00030c90: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+00030ca0: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+00030cb0: 662e 776f 726b 6572 732e 6765 7428 776f  f.workers.get(wo
+00030cc0: 726b 6572 290a 2020 2020 2020 2020 6966  rker).        if
+00030cd0: 206e 6f74 2074 7320 6f72 206e 6f74 2077   not ts or not w
+00030ce0: 7320 6f72 2077 7320 6e6f 7420 696e 2074  s or ws not in t
+00030cf0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+00030d00: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00030d10: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+00030d20: 7665 5f72 6570 6c69 6361 2874 732c 2077  ve_replica(ts, w
+00030d30: 7329 0a20 2020 2020 2020 2069 6620 6e6f  s).        if no
+00030d40: 7420 7473 2e77 686f 5f68 6173 3a0a 2020  t ts.who_has:.  
+00030d50: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
+00030d60: 7261 6e73 6974 696f 6e73 287b 6b65 793a  ransitions({key:
+00030d70: 2022 7265 6c65 6173 6564 227d 2c20 7374   "released"}, st
+00030d80: 696d 756c 7573 5f69 6429 0a0a 2020 2020  imulus_id)..    
+00030d90: 6465 6620 6861 6e64 6c65 5f6c 6f6e 675f  def handle_long_
+00030da0: 7275 6e6e 696e 6728 0a20 2020 2020 2020  running(.       
+00030db0: 2073 656c 662c 206b 6579 3a20 7374 722c   self, key: str,
+00030dc0: 2077 6f72 6b65 723a 2073 7472 2c20 636f   worker: str, co
+00030dd0: 6d70 7574 655f 6475 7261 7469 6f6e 3a20  mpute_duration: 
+00030de0: 666c 6f61 7420 7c20 4e6f 6e65 2c20 7374  float | None, st
+00030df0: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00030e00: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00030e10: 2020 2020 2020 2222 2241 2074 6173 6b20        """A task 
+00030e20: 6861 7320 7365 6365 6465 6420 6672 6f6d  has seceded from
+00030e30: 2074 6865 2074 6872 6561 6420 706f 6f6c   the thread pool
+00030e40: 0a0a 2020 2020 2020 2020 5765 2073 746f  ..        We sto
+00030e50: 7020 7468 6520 7461 736b 2066 726f 6d20  p the task from 
+00030e60: 6265 696e 6720 7374 6f6c 656e 2069 6e20  being stolen in 
+00030e70: 7468 6520 6675 7475 7265 2c20 616e 6420  the future, and 
+00030e80: 6368 616e 6765 2074 6173 6b0a 2020 2020  change task.    
+00030e90: 2020 2020 6475 7261 7469 6f6e 2061 6363      duration acc
+00030ea0: 6f75 6e74 696e 6720 6173 2069 6620 7468  ounting as if th
+00030eb0: 6520 7461 736b 2068 6173 2073 746f 7070  e task has stopp
+00030ec0: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+00030ed0: 2020 2020 2020 2020 6966 206b 6579 206e          if key n
+00030ee0: 6f74 2069 6e20 7365 6c66 2e74 6173 6b73  ot in self.tasks
+00030ef0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00030f00: 6767 6572 2e64 6562 7567 2822 536b 6970  gger.debug("Skip
+00030f10: 7069 6e67 206c 6f6e 675f 7275 6e6e 696e  ping long_runnin
+00030f20: 6720 7369 6e63 6520 6b65 7920 2573 2077  g since key %s w
+00030f30: 6173 2061 6c72 6561 6479 2072 656c 6561  as already relea
+00030f40: 7365 6422 2c20 6b65 7929 0a20 2020 2020  sed", key).     
+00030f50: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00030f60: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00030f70: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00030f80: 2020 2073 7465 616c 203d 2073 656c 662e     steal = self.
+00030f90: 6578 7465 6e73 696f 6e73 2e67 6574 2822  extensions.get("
+00030fa0: 7374 6561 6c69 6e67 2229 0a20 2020 2020  stealing").     
+00030fb0: 2020 2069 6620 7374 6561 6c20 6973 206e     if steal is n
+00030fc0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00030fd0: 2020 2020 2073 7465 616c 2e72 656d 6f76       steal.remov
+00030fe0: 655f 6b65 795f 6672 6f6d 5f73 7465 616c  e_key_from_steal
+00030ff0: 6162 6c65 2874 7329 0a0a 2020 2020 2020  able(ts)..      
+00031000: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
+00031010: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00031020: 6966 2077 7320 6973 204e 6f6e 653a 0a20  if ws is None:. 
+00031030: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00031040: 722e 6465 6275 6728 2252 6563 6569 7665  r.debug("Receive
+00031050: 6420 6c6f 6e67 2d72 756e 6e69 6e67 2073  d long-running s
+00031060: 6967 6e61 6c20 6672 6f6d 2064 7570 6c69  ignal from dupli
+00031070: 6361 7465 2074 6173 6b2e 2049 676e 6f72  cate task. Ignor
+00031080: 696e 672e 2229 0a20 2020 2020 2020 2020  ing.").         
+00031090: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+000310a0: 2020 2069 6620 636f 6d70 7574 655f 6475     if compute_du
+000310b0: 7261 7469 6f6e 2069 7320 6e6f 7420 4e6f  ration is not No
+000310c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000310d0: 6f6c 645f 6475 7261 7469 6f6e 203d 2074  old_duration = t
+000310e0: 732e 7072 6566 6978 2e64 7572 6174 696f  s.prefix.duratio
+000310f0: 6e5f 6176 6572 6167 650a 2020 2020 2020  n_average.      
+00031100: 2020 2020 2020 6966 206f 6c64 5f64 7572        if old_dur
+00031110: 6174 696f 6e20 3c20 303a 0a20 2020 2020  ation < 0:.     
+00031120: 2020 2020 2020 2020 2020 2074 732e 7072             ts.pr
+00031130: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
+00031140: 6572 6167 6520 3d20 636f 6d70 7574 655f  erage = compute_
+00031150: 6475 7261 7469 6f6e 0a20 2020 2020 2020  duration.       
+00031160: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00031170: 2020 2020 2020 2020 2020 2074 732e 7072             ts.pr
+00031180: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
+00031190: 6572 6167 6520 3d20 286f 6c64 5f64 7572  erage = (old_dur
+000311a0: 6174 696f 6e20 2b20 636f 6d70 7574 655f  ation + compute_
+000311b0: 6475 7261 7469 6f6e 2920 2f20 320a 0a20  duration) / 2.. 
+000311c0: 2020 2020 2020 2077 732e 6164 645f 746f         ws.add_to
+000311d0: 5f6c 6f6e 675f 7275 6e6e 696e 6728 7473  _long_running(ts
+000311e0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+000311f0: 6865 636b 5f69 646c 655f 7361 7475 7261  heck_idle_satura
+00031200: 7465 6428 7773 290a 0a20 2020 2020 2020  ted(ws)..       
+00031210: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
+00031220: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
+00031230: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
+00031240: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00031250: 0a0a 2020 2020 6465 6620 6861 6e64 6c65  ..    def handle
+00031260: 5f77 6f72 6b65 725f 7374 6174 7573 5f63  _worker_status_c
+00031270: 6861 6e67 6528 0a20 2020 2020 2020 2073  hange(.        s
+00031280: 656c 662c 2073 7461 7475 733a 2073 7472  elf, status: str
+00031290: 207c 2053 7461 7475 732c 2077 6f72 6b65   | Status, worke
+000312a0: 723a 2073 7472 207c 2057 6f72 6b65 7253  r: str | WorkerS
+000312b0: 7461 7465 2c20 7374 696d 756c 7573 5f69  tate, stimulus_i
+000312c0: 643a 2073 7472 0a20 2020 2029 202d 3e20  d: str.    ) -> 
+000312d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7773  None:.        ws
+000312e0: 203d 2073 656c 662e 776f 726b 6572 732e   = self.workers.
+000312f0: 6765 7428 776f 726b 6572 2920 6966 2069  get(worker) if i
+00031300: 7369 6e73 7461 6e63 6528 776f 726b 6572  sinstance(worker
+00031310: 2c20 7374 7229 2065 6c73 6520 776f 726b  , str) else work
+00031320: 6572 0a20 2020 2020 2020 2069 6620 6e6f  er.        if no
+00031330: 7420 7773 3a0a 2020 2020 2020 2020 2020  t ws:.          
+00031340: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
+00031350: 2070 7265 765f 7374 6174 7573 203d 2077   prev_status = w
+00031360: 732e 7374 6174 7573 0a20 2020 2020 2020  s.status.       
+00031370: 2077 732e 7374 6174 7573 203d 2053 7461   ws.status = Sta
+00031380: 7475 735b 7374 6174 7573 5d20 6966 2069  tus[status] if i
+00031390: 7369 6e73 7461 6e63 6528 7374 6174 7573  sinstance(status
+000313a0: 2c20 7374 7229 2065 6c73 6520 7374 6174  , str) else stat
+000313b0: 7573 0a20 2020 2020 2020 2069 6620 7773  us.        if ws
+000313c0: 2e73 7461 7475 7320 3d3d 2070 7265 765f  .status == prev_
+000313d0: 7374 6174 7573 3a0a 2020 2020 2020 2020  status:.        
+000313e0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+000313f0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+00031400: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+00031410: 7773 2e61 6464 7265 7373 2c0a 2020 2020  ws.address,.    
+00031420: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00031430: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+00031440: 6e22 3a20 2277 6f72 6b65 722d 7374 6174  n": "worker-stat
+00031450: 7573 2d63 6861 6e67 6522 2c0a 2020 2020  us-change",.    
+00031460: 2020 2020 2020 2020 2020 2020 2270 7265              "pre
+00031470: 762d 7374 6174 7573 223a 2070 7265 765f  v-status": prev_
+00031480: 7374 6174 7573 2e6e 616d 652c 0a20 2020  status.name,.   
+00031490: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+000314a0: 6174 7573 223a 2077 732e 7374 6174 7573  atus": ws.status
+000314b0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+000314c0: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
+000314d0: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+000314e0: 6562 7567 2866 2257 6f72 6b65 7220 7374  ebug(f"Worker st
+000314f0: 6174 7573 207b 7072 6576 5f73 7461 7475  atus {prev_statu
+00031500: 732e 6e61 6d65 7d20 2d3e 207b 7374 6174  s.name} -> {stat
+00031510: 7573 7d20 2d20 7b77 737d 2229 0a0a 2020  us} - {ws}")..  
+00031520: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
+00031530: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+00031540: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00031550: 2020 7365 6c66 2e72 756e 6e69 6e67 2e61    self.running.a
+00031560: 6464 2877 7329 0a20 2020 2020 2020 2020  dd(ws).         
+00031570: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
+00031580: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
+00031590: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000315a0: 662e 7472 616e 7369 7469 6f6e 7328 0a20  f.transitions(. 
+000315b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000315c0: 656c 662e 6275 6c6b 5f73 6368 6564 756c  elf.bulk_schedul
+000315d0: 655f 756e 7275 6e6e 6162 6c65 5f61 6674  e_unrunnable_aft
+000315e0: 6572 5f61 6464 696e 675f 776f 726b 6572  er_adding_worker
+000315f0: 2877 7329 2c20 7374 696d 756c 7573 5f69  (ws), stimulus_i
+00031600: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
+00031610: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031620: 2e73 7469 6d75 6c75 735f 7175 6575 655f  .stimulus_queue_
+00031630: 736c 6f74 735f 6d61 7962 655f 6f70 656e  slots_maybe_open
+00031640: 6564 2873 7469 6d75 6c75 735f 6964 3d73  ed(stimulus_id=s
+00031650: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
+00031660: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00031670: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+00031680: 6e67 2e64 6973 6361 7264 2877 7329 0a20  ng.discard(ws). 
+00031690: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000316a0: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
+000316b0: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
+000316c0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+000316d0: 5f74 6173 6b5f 636f 756e 742e 6469 7363  _task_count.disc
+000316e0: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
+000316f0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
+00031700: 6564 2e64 6973 6361 7264 2877 7329 0a0a  ed.discard(ws)..
+00031710: 2020 2020 6173 796e 6320 6465 6620 6861      async def ha
+00031720: 6e64 6c65 5f72 6571 7565 7374 5f72 6566  ndle_request_ref
+00031730: 7265 7368 5f77 686f 5f68 6173 280a 2020  resh_who_has(.  
+00031740: 2020 2020 2020 7365 6c66 2c20 6b65 7973        self, keys
+00031750: 3a20 4974 6572 6162 6c65 5b73 7472 5d2c  : Iterable[str],
+00031760: 2077 6f72 6b65 723a 2073 7472 2c20 7374   worker: str, st
+00031770: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00031780: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00031790: 2020 2020 2020 2222 2241 7379 6e63 6872        """Asynchr
+000317a0: 6f6e 6f75 7320 7265 7175 6573 7420 2874  onous request (t
+000317b0: 6872 6f75 6768 2062 756c 6b20 636f 6d6d  hrough bulk comm
+000317c0: 7329 2066 726f 6d20 6120 576f 726b 6572  s) from a Worker
+000317d0: 2074 6f20 7265 6672 6573 6820 7468 650a   to refresh the.
+000317e0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
+000317f0: 666f 7220 736f 6d65 206b 6579 732e 204e  for some keys. N
+00031800: 6f74 2074 6f20 6265 2063 6f6e 6675 7365  ot to be confuse
+00031810: 6420 7769 7468 2073 6368 6564 756c 6572  d with scheduler
+00031820: 2e77 686f 5f68 6173 2c20 7768 6963 6820  .who_has, which 
+00031830: 6973 2061 0a20 2020 2020 2020 2073 796e  is a.        syn
+00031840: 6368 726f 6e6f 7573 2052 5043 2072 6571  chronous RPC req
+00031850: 7565 7374 2066 726f 6d20 6120 436c 6965  uest from a Clie
+00031860: 6e74 2e0a 2020 2020 2020 2020 2222 220a  nt..        """.
+00031870: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
+00031880: 3d20 7b7d 0a20 2020 2020 2020 2066 7265  = {}.        fre
+00031890: 655f 6b65 7973 203d 205b 5d0a 2020 2020  e_keys = [].    
+000318a0: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
+000318b0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+000318c0: 2069 6620 6b65 7920 696e 2073 656c 662e   if key in self.
+000318d0: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+000318e0: 2020 2020 2020 2077 686f 5f68 6173 5b6b         who_has[k
+000318f0: 6579 5d20 3d20 5b77 732e 6164 6472 6573  ey] = [ws.addres
+00031900: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
+00031910: 2e74 6173 6b73 5b6b 6579 5d2e 7768 6f5f  .tasks[key].who_
+00031920: 6861 735d 0a20 2020 2020 2020 2020 2020  has].           
+00031930: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00031940: 2020 2020 2020 2066 7265 655f 6b65 7973         free_keys
+00031950: 2e61 7070 656e 6428 6b65 7929 0a0a 2020  .append(key)..  
+00031960: 2020 2020 2020 6966 2077 686f 5f68 6173        if who_has
+00031970: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00031980: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+00031990: 776f 726b 6572 5d2e 7365 6e64 280a 2020  worker].send(.  
+000319a0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+000319b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319c0: 2020 2020 226f 7022 3a20 2272 6566 7265      "op": "refre
+000319d0: 7368 2d77 686f 2d68 6173 222c 0a20 2020  sh-who-has",.   
+000319e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319f0: 2022 7768 6f5f 6861 7322 3a20 7768 6f5f   "who_has": who_
+00031a00: 6861 732c 0a20 2020 2020 2020 2020 2020  has,.           
+00031a10: 2020 2020 2020 2020 2022 7374 696d 756c           "stimul
+00031a20: 7573 5f69 6422 3a20 7374 696d 756c 7573  us_id": stimulus
+00031a30: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00031a40: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+00031a50: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+00031a60: 6672 6565 5f6b 6579 733a 0a20 2020 2020  free_keys:.     
+00031a70: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+00031a80: 616d 5f63 6f6d 6d73 5b77 6f72 6b65 725d  am_comms[worker]
+00031a90: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
+00031aa0: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00031ab0: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+00031ac0: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
+00031ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ae0: 2020 2020 226b 6579 7322 3a20 6672 6565      "keys": free
+00031af0: 5f6b 6579 732c 0a20 2020 2020 2020 2020  _keys,.         
+00031b00: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+00031b10: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+00031b20: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+00031b30: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00031b40: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+00031b50: 6320 6465 6620 6861 6e64 6c65 5f77 6f72  c def handle_wor
+00031b60: 6b65 7228 7365 6c66 2c20 636f 6d6d 3a20  ker(self, comm: 
+00031b70: 436f 6d6d 2c20 776f 726b 6572 3a20 7374  Comm, worker: st
+00031b80: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
+00031b90: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00031ba0: 4c69 7374 656e 2074 6f20 7265 7370 6f6e  Listen to respon
+00031bb0: 7365 7320 6672 6f6d 2061 2073 696e 676c  ses from a singl
+00031bc0: 6520 776f 726b 6572 0a0a 2020 2020 2020  e worker..      
+00031bd0: 2020 5468 6973 2069 7320 7468 6520 6d61    This is the ma
+00031be0: 696e 206c 6f6f 7020 666f 7220 7363 6865  in loop for sche
+00031bf0: 6475 6c65 722d 776f 726b 6572 2069 6e74  duler-worker int
+00031c00: 6572 6163 7469 6f6e 0a0a 2020 2020 2020  eraction..      
+00031c10: 2020 5365 6520 416c 736f 0a20 2020 2020    See Also.     
+00031c20: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00031c30: 2020 2020 5363 6865 6475 6c65 722e 6861      Scheduler.ha
+00031c40: 6e64 6c65 5f63 6c69 656e 743a 2045 7175  ndle_client: Equ
+00031c50: 6976 616c 656e 7420 636f 726f 7574 696e  ivalent coroutin
+00031c60: 6520 666f 7220 636c 6965 6e74 730a 2020  e for clients.  
+00031c70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00031c80: 2020 636f 6d6d 2e6e 616d 6520 3d20 2253    comm.name = "S
+00031c90: 6368 6564 756c 6572 2063 6f6e 6e65 6374  cheduler connect
+00031ca0: 696f 6e20 746f 2077 6f72 6b65 7222 0a20  ion to worker". 
+00031cb0: 2020 2020 2020 2077 6f72 6b65 725f 636f         worker_co
+00031cc0: 6d6d 203d 2073 656c 662e 7374 7265 616d  mm = self.stream
+00031cd0: 5f63 6f6d 6d73 5b77 6f72 6b65 725d 0a20  _comms[worker]. 
+00031ce0: 2020 2020 2020 2077 6f72 6b65 725f 636f         worker_co
+00031cf0: 6d6d 2e73 7461 7274 2863 6f6d 6d29 0a20  mm.start(comm). 
+00031d00: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00031d10: 666f 2822 5374 6172 7469 6e67 2077 6f72  fo("Starting wor
+00031d20: 6b65 7220 636f 6d70 7574 6520 7374 7265  ker compute stre
+00031d30: 616d 2c20 2573 222c 2077 6f72 6b65 7229  am, %s", worker)
+00031d40: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00031d50: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00031d60: 7365 6c66 2e68 616e 646c 655f 7374 7265  self.handle_stre
+00031d70: 616d 2863 6f6d 6d3d 636f 6d6d 2c20 6578  am(comm=comm, ex
+00031d80: 7472 613d 7b22 776f 726b 6572 223a 2077  tra={"worker": w
+00031d90: 6f72 6b65 727d 290a 2020 2020 2020 2020  orker}).        
+00031da0: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00031db0: 2020 2020 2069 6620 776f 726b 6572 2069       if worker i
+00031dc0: 6e20 7365 6c66 2e73 7472 6561 6d5f 636f  n self.stream_co
+00031dd0: 6d6d 733a 0a20 2020 2020 2020 2020 2020  mms:.           
+00031de0: 2020 2020 2077 6f72 6b65 725f 636f 6d6d       worker_comm
+00031df0: 2e61 626f 7274 2829 0a20 2020 2020 2020  .abort().       
+00031e00: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00031e10: 656c 662e 7265 6d6f 7665 5f77 6f72 6b65  elf.remove_worke
+00031e20: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00031e30: 2020 2020 2020 2077 6f72 6b65 722c 2073         worker, s
+00031e40: 7469 6d75 6c75 735f 6964 3d66 2268 616e  timulus_id=f"han
+00031e50: 646c 652d 776f 726b 6572 2d63 6c65 616e  dle-worker-clean
+00031e60: 7570 2d7b 7469 6d65 2829 7d22 0a20 2020  up-{time()}".   
+00031e70: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+00031e80: 2020 2020 6465 6620 6164 645f 706c 7567      def add_plug
+00031e90: 696e 280a 2020 2020 2020 2020 7365 6c66  in(.        self
+00031ea0: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
+00031eb0: 3a20 5363 6865 6475 6c65 7250 6c75 6769  : SchedulerPlugi
+00031ec0: 6e2c 0a20 2020 2020 2020 202a 2c0a 2020  n,.        *,.  
+00031ed0: 2020 2020 2020 6964 656d 706f 7465 6e74        idempotent
+00031ee0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00031ef0: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
+00031f00: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+00031f10: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00031f20: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
+00031f30: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00031f40: 2222 4164 6420 6578 7465 726e 616c 2070  ""Add external p
+00031f50: 6c75 6769 6e20 746f 2073 6368 6564 756c  lugin to schedul
+00031f60: 6572 2e0a 0a20 2020 2020 2020 2053 6565  er...        See
+00031f70: 2068 7474 7073 3a2f 2f64 6973 7472 6962   https://distrib
+00031f80: 7574 6564 2e72 6561 6474 6865 646f 6373  uted.readthedocs
+00031f90: 2e69 6f2f 656e 2f6c 6174 6573 742f 706c  .io/en/latest/pl
+00031fa0: 7567 696e 732e 6874 6d6c 0a0a 2020 2020  ugins.html..    
+00031fb0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
+00031fc0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
+00031fd0: 2d0a 2020 2020 2020 2020 706c 7567 696e  -.        plugin
+00031fe0: 203a 2053 6368 6564 756c 6572 506c 7567   : SchedulerPlug
+00031ff0: 696e 0a20 2020 2020 2020 2020 2020 2053  in.            S
+00032000: 6368 6564 756c 6572 506c 7567 696e 2069  chedulerPlugin i
+00032010: 6e73 7461 6e63 6520 746f 2061 6464 0a20  nstance to add. 
+00032020: 2020 2020 2020 2069 6465 6d70 6f74 656e         idempoten
+00032030: 7420 3a20 626f 6f6c 0a20 2020 2020 2020  t : bool.       
+00032040: 2020 2020 2049 6620 7472 7565 2c20 7468       If true, th
+00032050: 6520 706c 7567 696e 2069 7320 6173 7375  e plugin is assu
+00032060: 6d65 6420 746f 2061 6c72 6561 6479 2065  med to already e
+00032070: 7869 7374 2061 6e64 206e 6f0a 2020 2020  xist and no.    
+00032080: 2020 2020 2020 2020 6163 7469 6f6e 2069          action i
+00032090: 7320 7461 6b65 6e2e 0a20 2020 2020 2020  s taken..       
+000320a0: 206e 616d 6520 3a20 7374 720a 2020 2020   name : str.    
+000320b0: 2020 2020 2020 2020 4120 6e61 6d65 2066          A name f
+000320c0: 6f72 2074 6865 2070 6c75 6769 6e2c 2069  or the plugin, i
+000320d0: 6620 4e6f 6e65 2c20 7468 6520 6e61 6d65  f None, the name
+000320e0: 2061 7474 7269 6275 7465 2069 730a 2020   attribute is.  
+000320f0: 2020 2020 2020 2020 2020 6368 6563 6b65            checke
+00032100: 6420 6f6e 2074 6865 2050 6c75 6769 6e20  d on the Plugin 
+00032110: 696e 7374 616e 6365 2061 6e64 2067 656e  instance and gen
+00032120: 6572 6174 6564 2069 6620 6e6f 740a 2020  erated if not.  
+00032130: 2020 2020 2020 2020 2020 6469 7363 6f76            discov
+00032140: 6572 6564 2e0a 2020 2020 2020 2020 2222  ered..        ""
+00032150: 220a 2020 2020 2020 2020 6966 206e 616d  ".        if nam
+00032160: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+00032170: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+00032180: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
+00032190: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
+000321a0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+000321b0: 706c 7567 696e 733a 0a20 2020 2020 2020  plugins:.       
+000321c0: 2020 2020 2069 6620 6964 656d 706f 7465       if idempote
+000321d0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
+000321e0: 2020 2020 7265 7475 726e 0a20 2020 2020      return.     
+000321f0: 2020 2020 2020 2077 6172 6e69 6e67 732e         warnings.
+00032200: 7761 726e 280a 2020 2020 2020 2020 2020  warn(.          
+00032210: 2020 2020 2020 6622 5363 6865 6475 6c65        f"Schedule
+00032220: 7220 616c 7265 6164 7920 636f 6e74 6169  r already contai
+00032230: 6e73 2061 2070 6c75 6769 6e20 7769 7468  ns a plugin with
+00032240: 206e 616d 6520 7b6e 616d 657d 3b20 6f76   name {name}; ov
+00032250: 6572 7772 6974 696e 672e 222c 0a20 2020  erwriting.",.   
+00032260: 2020 2020 2020 2020 2020 2020 2063 6174               cat
+00032270: 6567 6f72 793d 5573 6572 5761 726e 696e  egory=UserWarnin
+00032280: 672c 0a20 2020 2020 2020 2020 2020 2029  g,.            )
+00032290: 0a0a 2020 2020 2020 2020 7061 7261 6d65  ..        parame
+000322a0: 7465 7273 203d 2069 6e73 7065 6374 2e73  ters = inspect.s
+000322b0: 6967 6e61 7475 7265 2870 6c75 6769 6e2e  ignature(plugin.
+000322c0: 7265 6d6f 7665 5f77 6f72 6b65 7229 2e70  remove_worker).p
+000322d0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+000322e0: 2020 6966 206e 6f74 2061 6e79 2870 2e6b    if not any(p.k
+000322f0: 696e 6420 6973 2070 2e56 4152 5f4b 4559  ind is p.VAR_KEY
+00032300: 574f 5244 2066 6f72 2070 2069 6e20 7061  WORD for p in pa
+00032310: 7261 6d65 7465 7273 2e76 616c 7565 7328  rameters.values(
+00032320: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00032330: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
+00032340: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00032350: 5468 6520 7369 676e 6174 7572 6520 6f66  The signature of
+00032360: 2060 5363 6865 6475 6c65 7250 6c75 6769   `SchedulerPlugi
+00032370: 6e2e 7265 6d6f 7665 5f77 6f72 6b65 7260  n.remove_worker`
+00032380: 206e 6f77 2072 6571 7569 7265 7320 602a   now requires `*
+00032390: 2a6b 7761 7267 7360 2022 0a20 2020 2020  *kwargs` ".     
+000323a0: 2020 2020 2020 2020 2020 2022 746f 2065             "to e
+000323b0: 6e73 7572 6520 7468 6174 2070 6c75 6769  nsure that plugi
+000323c0: 6e73 2072 656d 6169 6e20 666f 7277 6172  ns remain forwar
+000323d0: 642d 636f 6d70 6174 6962 6c65 2e20 4e6f  d-compatible. No
+000323e0: 7420 696e 636c 7564 696e 6720 220a 2020  t including ".  
+000323f0: 2020 2020 2020 2020 2020 2020 2020 2260                "`
+00032400: 2a2a 6b77 6172 6773 6020 696e 2074 6865  **kwargs` in the
+00032410: 2073 6967 6e61 7475 7265 2077 696c 6c20   signature will 
+00032420: 6e6f 206c 6f6e 6765 7220 6265 2073 7570  no longer be sup
+00032430: 706f 7274 6564 2069 6e20 6675 7475 7265  ported in future
+00032440: 2076 6572 7369 6f6e 732e 222c 0a20 2020   versions.",.   
+00032450: 2020 2020 2020 2020 2020 2020 2046 7574               Fut
+00032460: 7572 6557 6172 6e69 6e67 2c0a 2020 2020  ureWarning,.    
+00032470: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00032480: 2020 2073 656c 662e 706c 7567 696e 735b     self.plugins[
+00032490: 6e61 6d65 5d20 3d20 706c 7567 696e 0a0a  name] = plugin..
+000324a0: 2020 2020 6465 6620 7265 6d6f 7665 5f70      def remove_p
+000324b0: 6c75 6769 6e28 0a20 2020 2020 2020 2073  lugin(.        s
+000324c0: 656c 662c 0a20 2020 2020 2020 206e 616d  elf,.        nam
+000324d0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+000324e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 706c  None,.        pl
+000324f0: 7567 696e 3a20 5363 6865 6475 6c65 7250  ugin: SchedulerP
+00032500: 6c75 6769 6e20 7c20 4e6f 6e65 203d 204e  lugin | None = N
+00032510: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
+00032520: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00032530: 656d 6f76 6520 6578 7465 726e 616c 2070  emove external p
+00032540: 6c75 6769 6e20 6672 6f6d 2073 6368 6564  lugin from sched
+00032550: 756c 6572 0a0a 2020 2020 2020 2020 5061  uler..        Pa
+00032560: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+00032570: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+00032580: 2020 2020 6e61 6d65 203a 2073 7472 0a20      name : str. 
+00032590: 2020 2020 2020 2020 2020 204e 616d 6520             Name 
+000325a0: 6f66 2074 6865 2070 6c75 6769 6e20 746f  of the plugin to
+000325b0: 2072 656d 6f76 650a 2020 2020 2020 2020   remove.        
+000325c0: 2222 220a 2020 2020 2020 2020 6173 7365  """.        asse
+000325d0: 7274 206e 616d 6520 6973 206e 6f74 204e  rt name is not N
+000325e0: 6f6e 650a 0a20 2020 2020 2020 2074 7279  one..        try
+000325f0: 3a0a 2020 2020 2020 2020 2020 2020 6465  :.            de
+00032600: 6c20 7365 6c66 2e70 6c75 6769 6e73 5b6e  l self.plugins[n
+00032610: 616d 655d 0a20 2020 2020 2020 2065 7863  ame].        exc
+00032620: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00032630: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00032640: 5661 6c75 6545 7272 6f72 280a 2020 2020  ValueError(.    
+00032650: 2020 2020 2020 2020 2020 2020 6622 436f              f"Co
+00032660: 756c 6420 6e6f 7420 6669 6e64 2070 6c75  uld not find plu
+00032670: 6769 6e20 7b6e 616d 6521 727d 2061 6d6f  gin {name!r} amo
+00032680: 6e67 2074 6865 2063 7572 7265 6e74 2073  ng the current s
+00032690: 6368 6564 756c 6572 2070 6c75 6769 6e73  cheduler plugins
+000326a0: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+000326b0: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+000326c0: 6567 6973 7465 725f 7363 6865 6475 6c65  egister_schedule
+000326d0: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
+000326e0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000326f0: 706c 7567 696e 3a20 6279 7465 7320 7c20  plugin: bytes | 
+00032700: 5363 6865 6475 6c65 7250 6c75 6769 6e2c  SchedulerPlugin,
+00032710: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
+00032720: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00032730: 2c0a 2020 2020 2020 2020 6964 656d 706f  ,.        idempo
+00032740: 7465 6e74 3a20 626f 6f6c 203d 2046 616c  tent: bool = Fal
+00032750: 7365 2c0a 2020 2020 2920 2d3e 204e 6f6e  se,.    ) -> Non
+00032760: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
+00032770: 6769 7374 6572 2061 2070 6c75 6769 6e20  gister a plugin 
+00032780: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
+00032790: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
+000327a0: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
+000327b0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+000327c0: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
+000327d0: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
+000327e0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000327f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00032800: 2020 2022 4361 6e6e 6f74 2072 6567 6973     "Cannot regis
+00032810: 7465 7220 6120 7363 6865 6475 6c65 7220  ter a scheduler 
+00032820: 706c 7567 696e 2061 7320 7468 6520 7363  plugin as the sc
+00032830: 6865 6475 6c65 7220 220a 2020 2020 2020  heduler ".      
+00032840: 2020 2020 2020 2020 2020 2268 6173 2062            "has b
+00032850: 6565 6e20 6578 706c 6963 6974 6c79 2064  een explicitly d
+00032860: 6973 616c 6c6f 7765 6420 6672 6f6d 2064  isallowed from d
+00032870: 6573 6572 6961 6c69 7a69 6e67 2022 0a20  eserializing ". 
+00032880: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00032890: 6172 6269 7472 6172 7920 6279 7465 7374  arbitrary bytest
+000328a0: 7269 6e67 7320 7573 696e 6720 7069 636b  rings using pick
+000328b0: 6c65 2076 6961 2074 6865 2022 0a20 2020  le via the ".   
+000328c0: 2020 2020 2020 2020 2020 2020 2022 2764               "'d
+000328d0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+000328e0: 756c 6572 2e70 6963 6b6c 6527 2063 6f6e  uler.pickle' con
+000328f0: 6669 6775 7261 7469 6f6e 2073 6574 7469  figuration setti
+00032900: 6e67 2e22 0a20 2020 2020 2020 2020 2020  ng.".           
+00032910: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
+00032920: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
+00032930: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
+00032940: 7567 696e 293a 0a20 2020 2020 2020 2020  ugin):.         
+00032950: 2020 2070 6c75 6769 6e20 3d20 6c6f 6164     plugin = load
+00032960: 7328 706c 7567 696e 290a 2020 2020 2020  s(plugin).      
+00032970: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00032980: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
+00032990: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
+000329a0: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+000329b0: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+000329c0: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+000329d0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
+000329e0: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
+000329f0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+00032a00: 706c 7567 696e 7320 616e 6420 6964 656d  plugins and idem
+00032a10: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
+00032a20: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00032a30: 2020 2020 6966 2068 6173 6174 7472 2870      if hasattr(p
+00032a40: 6c75 6769 6e2c 2022 7374 6172 7422 293a  lugin, "start"):
+00032a50: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00032a60: 756c 7420 3d20 706c 7567 696e 2e73 7461  ult = plugin.sta
+00032a70: 7274 2873 656c 6629 0a20 2020 2020 2020  rt(self).       
+00032a80: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+00032a90: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
+00032aa0: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
+00032ab0: 2020 2020 2061 7761 6974 2072 6573 756c       await resul
+00032ac0: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+00032ad0: 6164 645f 706c 7567 696e 2870 6c75 6769  add_plugin(plugi
+00032ae0: 6e2c 206e 616d 653d 6e61 6d65 2c20 6964  n, name=name, id
+00032af0: 656d 706f 7465 6e74 3d69 6465 6d70 6f74  empotent=idempot
+00032b00: 656e 7429 0a0a 2020 2020 6465 6620 776f  ent)..    def wo
+00032b10: 726b 6572 5f73 656e 6428 7365 6c66 2c20  rker_send(self, 
+00032b20: 776f 726b 6572 3a20 7374 722c 206d 7367  worker: str, msg
+00032b30: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00032b40: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00032b50: 2020 2022 2222 5365 6e64 206d 6573 7361     """Send messa
+00032b60: 6765 2074 6f20 776f 726b 6572 0a0a 2020  ge to worker..  
+00032b70: 2020 2020 2020 5468 6973 2061 6c73 6f20        This also 
+00032b80: 6861 6e64 6c65 7320 636f 6e6e 6563 7469  handles connecti
+00032b90: 6f6e 2066 6169 6c75 7265 7320 6279 2061  on failures by a
+00032ba0: 6464 696e 6720 6120 6361 6c6c 6261 636b  dding a callback
+00032bb0: 2074 6f20 7265 6d6f 7665 0a20 2020 2020   to remove.     
+00032bc0: 2020 2074 6865 2077 6f72 6b65 7220 6f6e     the worker on
+00032bd0: 2074 6865 206e 6578 7420 6379 636c 652e   the next cycle.
+00032be0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00032bf0: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
+00032c00: 733a 2064 6963 7420 3d20 7365 6c66 2e73  s: dict = self.s
+00032c10: 7472 6561 6d5f 636f 6d6d 730a 2020 2020  tream_comms.    
+00032c20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00032c30: 2020 2020 2073 7472 6561 6d5f 636f 6d6d       stream_comm
+00032c40: 735b 776f 726b 6572 5d2e 7365 6e64 286d  s[worker].send(m
+00032c50: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
+00032c60: 7074 2028 436f 6d6d 436c 6f73 6564 4572  pt (CommClosedEr
+00032c70: 726f 722c 2041 7474 7269 6275 7465 4572  ror, AttributeEr
+00032c80: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+00032c90: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
+00032ca0: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
+00032cb0: 2e63 616c 6c5f 736f 6f6e 280a 2020 2020  .call_soon(.    
+00032cc0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00032cd0: 2e72 656d 6f76 655f 776f 726b 6572 2c0a  .remove_worker,.
 00032ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032cf0: 2020 6578 635f 696e 666f 3d54 7275 652c    exc_info=True,
-00032d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032d10: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00032d20: 666f 7220 776f 726b 6572 2c20 6d73 6773  for worker, msgs
-00032d30: 2069 6e20 776f 726b 6572 5f6d 7367 732e   in worker_msgs.
-00032d40: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00032d50: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00032d60: 2020 2020 2020 2020 2020 7720 3d20 7365            w = se
-00032d70: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-00032d80: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00032d90: 2020 2020 2020 2020 772e 7365 6e64 282a          w.send(*
-00032da0: 6d73 6773 290a 2020 2020 2020 2020 2020  msgs).          
-00032db0: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00032dc0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00032dd0: 2020 2023 2077 6f72 6b65 7220 616c 7265     # worker alre
-00032de0: 6164 7920 676f 6e65 0a20 2020 2020 2020  ady gone.       
-00032df0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-00032e00: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00032e10: 2028 436f 6d6d 436c 6f73 6564 4572 726f   (CommClosedErro
-00032e20: 722c 2041 7474 7269 6275 7465 4572 726f  r, AttributeErro
-00032e30: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00032e40: 2020 2020 7365 6c66 2e5f 6f6e 676f 696e      self._ongoin
-00032e50: 675f 6261 636b 6772 6f75 6e64 5f74 6173  g_background_tas
-00032e60: 6b73 2e63 616c 6c5f 736f 6f6e 280a 2020  ks.call_soon(.  
-00032e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032e80: 2020 7365 6c66 2e72 656d 6f76 655f 776f    self.remove_wo
-00032e90: 726b 6572 2c0a 2020 2020 2020 2020 2020  rker,.          
-00032ea0: 2020 2020 2020 2020 2020 6164 6472 6573            addres
-00032eb0: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
-00032ec0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00032ed0: 696d 756c 7573 5f69 643d 6622 7365 6e64  imulus_id=f"send
-00032ee0: 2d61 6c6c 2d63 6f6d 6d2d 6661 696c 2d7b  -all-comm-fail-{
-00032ef0: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
-00032f00: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00032f10: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00032f20: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-00032f30: 2020 2320 4c65 7373 2063 6f6d 6d6f 6e20    # Less common 
-00032f40: 696e 7465 7261 6374 696f 6e73 2023 0a20  interactions #. 
-00032f50: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00032f60: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00032f70: 0a20 2020 2061 7379 6e63 2064 6566 2073  .    async def s
-00032f80: 6361 7474 6572 280a 2020 2020 2020 2020  catter(.        
-00032f90: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
-00032fa0: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
-00032fb0: 2064 6174 613d 4e6f 6e65 2c0a 2020 2020   data=None,.    
-00032fc0: 2020 2020 776f 726b 6572 733d 4e6f 6e65      workers=None
-00032fd0: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
-00032fe0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2062  =None,.        b
-00032ff0: 726f 6164 6361 7374 3d46 616c 7365 2c0a  roadcast=False,.
-00033000: 2020 2020 2020 2020 7469 6d65 6f75 743d          timeout=
-00033010: 322c 0a20 2020 2029 3a0a 2020 2020 2020  2,.    ):.      
-00033020: 2020 2222 2253 656e 6420 6461 7461 206f    """Send data o
-00033030: 7574 2074 6f20 776f 726b 6572 730a 0a20  ut to workers.. 
-00033040: 2020 2020 2020 2053 6565 2061 6c73 6f0a         See also.
-00033050: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00033060: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
-00033070: 6572 2e62 726f 6164 6361 7374 3a0a 2020  er.broadcast:.  
-00033080: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00033090: 2020 7374 6172 7420 3d20 7469 6d65 2829    start = time()
-000330a0: 0a20 2020 2020 2020 2077 6869 6c65 2054  .        while T
-000330b0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-000330c0: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-000330d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000330e0: 2020 2020 2077 7373 203d 2073 656c 662e       wss = self.
-000330f0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00033100: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00033110: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00033120: 7320 3d20 5b73 656c 662e 636f 6572 6365  s = [self.coerce
-00033130: 5f61 6464 7265 7373 2877 2920 666f 7220  _address(w) for 
-00033140: 7720 696e 2077 6f72 6b65 7273 5d0a 2020  w in workers].  
-00033150: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00033160: 7320 3d20 7b73 656c 662e 776f 726b 6572  s = {self.worker
-00033170: 735b 775d 2066 6f72 2077 2069 6e20 776f  s[w] for w in wo
-00033180: 726b 6572 737d 0a20 2020 2020 2020 2020  rkers}.         
-00033190: 2020 2020 2020 2077 7373 203d 207b 7773         wss = {ws
-000331a0: 2066 6f72 2077 7320 696e 2077 7373 2069   for ws in wss i
-000331b0: 6620 7773 2e73 7461 7475 7320 3d3d 2053  f ws.status == S
-000331c0: 7461 7475 732e 7275 6e6e 696e 677d 0a0a  tatus.running}..
-000331d0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000331e0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
-000331f0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00033200: 2020 2020 2020 6966 2074 696d 6528 2920        if time() 
-00033210: 3e20 7374 6172 7420 2b20 7469 6d65 6f75  > start + timeou
-00033220: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00033230: 2020 2072 6169 7365 2054 696d 656f 7574     raise Timeout
-00033240: 4572 726f 7228 224e 6f20 7661 6c69 6420  Error("No valid 
-00033250: 776f 726b 6572 7320 666f 756e 6422 290a  workers found").
-00033260: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00033270: 7420 6173 796e 6369 6f2e 736c 6565 7028  t asyncio.sleep(
-00033280: 302e 3129 0a0a 2020 2020 2020 2020 6e74  0.1)..        nt
-00033290: 6872 6561 6473 203d 207b 7773 2e61 6464  hreads = {ws.add
-000332a0: 7265 7373 3a20 7773 2e6e 7468 7265 6164  ress: ws.nthread
-000332b0: 7320 666f 7220 7773 2069 6e20 7773 737d  s for ws in wss}
-000332c0: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
-000332d0: 2069 7369 6e73 7461 6e63 6528 6461 7461   isinstance(data
-000332e0: 2c20 6469 6374 290a 0a20 2020 2020 2020  , dict)..       
-000332f0: 206b 6579 732c 2077 686f 5f68 6173 2c20   keys, who_has, 
-00033300: 6e62 7974 6573 203d 2061 7761 6974 2073  nbytes = await s
-00033310: 6361 7474 6572 5f74 6f5f 776f 726b 6572  catter_to_worker
-00033320: 7328 6e74 6872 6561 6473 2c20 6461 7461  s(nthreads, data
-00033330: 2c20 7270 633d 7365 6c66 2e72 7063 290a  , rpc=self.rpc).
-00033340: 0a20 2020 2020 2020 2073 656c 662e 7570  .        self.up
-00033350: 6461 7465 5f64 6174 6128 7768 6f5f 6861  date_data(who_ha
-00033360: 733d 7768 6f5f 6861 732c 206e 6279 7465  s=who_has, nbyte
-00033370: 733d 6e62 7974 6573 2c20 636c 6965 6e74  s=nbytes, client
-00033380: 3d63 6c69 656e 7429 0a0a 2020 2020 2020  =client)..      
-00033390: 2020 6966 2062 726f 6164 6361 7374 3a0a    if broadcast:.
-000333a0: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-000333b0: 6c65 6e28 6e74 6872 6561 6473 2920 6966  len(nthreads) if
-000333c0: 2062 726f 6164 6361 7374 2069 7320 5472   broadcast is Tr
-000333d0: 7565 2065 6c73 6520 6272 6f61 6463 6173  ue else broadcas
-000333e0: 740a 2020 2020 2020 2020 2020 2020 6177  t.            aw
-000333f0: 6169 7420 7365 6c66 2e72 6570 6c69 6361  ait self.replica
-00033400: 7465 286b 6579 733d 6b65 7973 2c20 776f  te(keys=keys, wo
-00033410: 726b 6572 733d 776f 726b 6572 732c 206e  rkers=workers, n
-00033420: 3d6e 290a 0a20 2020 2020 2020 2073 656c  =n)..        sel
-00033430: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
-00033440: 2020 2020 2020 2020 205b 636c 6965 6e74           [client
-00033450: 2c20 2261 6c6c 225d 2c20 7b22 6163 7469  , "all"], {"acti
-00033460: 6f6e 223a 2022 7363 6174 7465 7222 2c20  on": "scatter", 
-00033470: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
-00033480: 2c20 2263 6f75 6e74 223a 206c 656e 2864  , "count": len(d
-00033490: 6174 6129 7d0a 2020 2020 2020 2020 290a  ata)}.        ).
-000334a0: 2020 2020 2020 2020 7265 7475 726e 206b          return k
-000334b0: 6579 730a 0a20 2020 2061 7379 6e63 2064  eys..    async d
-000334c0: 6566 2067 6174 6865 7228 7365 6c66 2c20  ef gather(self, 
-000334d0: 6b65 7973 2c20 7365 7269 616c 697a 6572  keys, serializer
-000334e0: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
-000334f0: 2022 2222 436f 6c6c 6563 7420 6461 7461   """Collect data
-00033500: 2066 726f 6d20 776f 726b 6572 7320 746f   from workers to
-00033510: 2074 6865 2073 6368 6564 756c 6572 2222   the scheduler""
-00033520: 220a 2020 2020 2020 2020 7374 696d 756c  ".        stimul
-00033530: 7573 5f69 6420 3d20 6622 6761 7468 6572  us_id = f"gather
-00033540: 2d7b 7469 6d65 2829 7d22 0a20 2020 2020  -{time()}".     
-00033550: 2020 206b 6579 7320 3d20 6c69 7374 286b     keys = list(k
-00033560: 6579 7329 0a20 2020 2020 2020 2077 686f  eys).        who
-00033570: 5f68 6173 203d 207b 7d0a 2020 2020 2020  _has = {}.      
-00033580: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-00033590: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-000335a0: 733a 2054 6173 6b53 7461 7465 203d 2073  s: TaskState = s
-000335b0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
-000335c0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
-000335d0: 6620 7473 2069 7320 6e6f 7420 4e6f 6e65  f ts is not None
-000335e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000335f0: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
-00033600: 205b 7773 2e61 6464 7265 7373 2066 6f72   [ws.address for
-00033610: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
-00033620: 735d 0a20 2020 2020 2020 2020 2020 2065  s].            e
-00033630: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00033640: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
-00033650: 5d20 3d20 5b5d 0a0a 2020 2020 2020 2020  ] = []..        
-00033660: 6461 7461 2c20 6d69 7373 696e 675f 6b65  data, missing_ke
-00033670: 7973 2c20 6d69 7373 696e 675f 776f 726b  ys, missing_work
-00033680: 6572 7320 3d20 6177 6169 7420 6761 7468  ers = await gath
-00033690: 6572 5f66 726f 6d5f 776f 726b 6572 7328  er_from_workers(
-000336a0: 0a20 2020 2020 2020 2020 2020 2077 686f  .            who
-000336b0: 5f68 6173 2c20 7270 633d 7365 6c66 2e72  _has, rpc=self.r
-000336c0: 7063 2c20 636c 6f73 653d 4661 6c73 652c  pc, close=False,
-000336d0: 2073 6572 6961 6c69 7a65 7273 3d73 6572   serializers=ser
-000336e0: 6961 6c69 7a65 7273 0a20 2020 2020 2020  ializers.       
-000336f0: 2029 0a20 2020 2020 2020 2069 6620 6e6f   ).        if no
-00033700: 7420 6d69 7373 696e 675f 6b65 7973 3a0a  t missing_keys:.
-00033710: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00033720: 6c74 203d 207b 2273 7461 7475 7322 3a20  lt = {"status": 
-00033730: 224f 4b22 2c20 2264 6174 6122 3a20 6461  "OK", "data": da
-00033740: 7461 7d0a 2020 2020 2020 2020 656c 7365  ta}.        else
-00033750: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
-00033760: 7373 696e 675f 7374 6174 6573 203d 205b  ssing_states = [
-00033770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033780: 2028 7365 6c66 2e74 6173 6b73 5b6b 6579   (self.tasks[key
-00033790: 5d2e 7374 6174 6520 6966 206b 6579 2069  ].state if key i
-000337a0: 6e20 7365 6c66 2e74 6173 6b73 2065 6c73  n self.tasks els
-000337b0: 6520 4e6f 6e65 290a 2020 2020 2020 2020  e None).        
-000337c0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-000337d0: 696e 206d 6973 7369 6e67 5f6b 6579 730a  in missing_keys.
-000337e0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000337f0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00033800: 2e65 7863 6570 7469 6f6e 280a 2020 2020  .exception(.    
-00033810: 2020 2020 2020 2020 2020 2020 2243 6f75              "Cou
-00033820: 6c64 6e27 7420 6761 7468 6572 206b 6579  ldn't gather key
-00033830: 7320 2573 2073 7461 7465 3a20 2573 2077  s %s state: %s w
-00033840: 6f72 6b65 7273 3a20 2573 222c 0a20 2020  orkers: %s",.   
-00033850: 2020 2020 2020 2020 2020 2020 206d 6973               mis
-00033860: 7369 6e67 5f6b 6579 732c 0a20 2020 2020  sing_keys,.     
-00033870: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-00033880: 6e67 5f73 7461 7465 732c 0a20 2020 2020  ng_states,.     
-00033890: 2020 2020 2020 2020 2020 206d 6973 7369             missi
-000338a0: 6e67 5f77 6f72 6b65 7273 2c0a 2020 2020  ng_workers,.    
-000338b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000338c0: 2020 2020 2020 7265 7375 6c74 203d 207b        result = {
-000338d0: 2273 7461 7475 7322 3a20 2265 7272 6f72  "status": "error
-000338e0: 222c 2022 6b65 7973 223a 206d 6973 7369  ", "keys": missi
-000338f0: 6e67 5f6b 6579 737d 0a20 2020 2020 2020  ng_keys}.       
-00033900: 2020 2020 2077 6974 6820 6c6f 675f 6572       with log_er
-00033910: 726f 7273 2829 3a0a 2020 2020 2020 2020  rors():.        
-00033920: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-00033930: 2073 7573 7069 6369 6f75 7320 776f 726b   suspicious work
-00033940: 6572 7320 6672 6f6d 2074 6865 2073 6368  ers from the sch
-00033950: 6564 756c 6572 2061 6e64 2073 6875 7420  eduler and shut 
-00033960: 7468 656d 2064 6f77 6e2e 0a20 2020 2020  them down..     
-00033970: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00033980: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00033990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000339a0: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-000339b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000339c0: 7365 6c66 2e72 656d 6f76 655f 776f 726b  self.remove_work
-000339d0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-000339e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000339f0: 6164 6472 6573 733d 776f 726b 6572 2c20  address=worker, 
-00033a00: 636c 6f73 653d 5472 7565 2c20 7374 696d  close=True, stim
-00033a10: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00033a20: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-00033a30: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00033a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033a50: 2020 2020 2020 666f 7220 776f 726b 6572        for worker
-00033a60: 2069 6e20 6d69 7373 696e 675f 776f 726b   in missing_work
-00033a70: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-00033a80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00033a90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00033aa0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00033ab0: 6b65 792c 2077 6f72 6b65 7273 2069 6e20  key, workers in 
-00033ac0: 6d69 7373 696e 675f 6b65 7973 2e69 7465  missing_keys.ite
-00033ad0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00033ae0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00033af0: 2e65 7863 6570 7469 6f6e 280a 2020 2020  .exception(.    
-00033b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b10: 2020 2020 2253 6875 7420 646f 776e 2077      "Shut down w
-00033b20: 6f72 6b65 7273 2074 6861 7420 646f 6e27  orkers that don'
-00033b30: 7420 6861 7665 2070 726f 6d69 7365 6420  t have promised 
-00033b40: 6b65 793a 2025 732c 2025 7322 2c0a 2020  key: %s, %s",.  
-00033b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033b60: 2020 2020 2020 7374 7228 776f 726b 6572        str(worker
-00033b70: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-00033b80: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00033b90: 6b65 7929 2c0a 2020 2020 2020 2020 2020  key),.          
-00033ba0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00033bb0: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00033bc0: 656e 7428 2261 6c6c 222c 207b 2261 6374  ent("all", {"act
-00033bd0: 696f 6e22 3a20 2267 6174 6865 7222 2c20  ion": "gather", 
-00033be0: 2263 6f75 6e74 223a 206c 656e 286b 6579  "count": len(key
-00033bf0: 7329 7d29 0a20 2020 2020 2020 2072 6574  s)}).        ret
-00033c00: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-00033c10: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00033c20: 6173 796e 6320 6465 6620 7265 7374 6172  async def restar
-00033c30: 7428 7365 6c66 2c20 636c 6965 6e74 3d4e  t(self, client=N
-00033c40: 6f6e 652c 2074 696d 656f 7574 3d33 302c  one, timeout=30,
-00033c50: 2077 6169 745f 666f 725f 776f 726b 6572   wait_for_worker
-00033c60: 733d 5472 7565 293a 0a20 2020 2020 2020  s=True):.       
-00033c70: 2022 2222 0a20 2020 2020 2020 2052 6573   """.        Res
-00033c80: 7461 7274 2061 6c6c 2077 6f72 6b65 7273  tart all workers
-00033c90: 2e20 5265 7365 7420 6c6f 6361 6c20 7374  . Reset local st
-00033ca0: 6174 652e 204f 7074 696f 6e61 6c6c 7920  ate. Optionally 
-00033cb0: 7761 6974 2066 6f72 2077 6f72 6b65 7273  wait for workers
-00033cc0: 2074 6f20 7265 7475 726e 2e0a 0a20 2020   to return...   
-00033cd0: 2020 2020 2057 6f72 6b65 7273 2077 6974       Workers wit
-00033ce0: 686f 7574 206e 616e 6e69 6573 2061 7265  hout nannies are
-00033cf0: 2073 6875 7420 646f 776e 2c20 686f 7069   shut down, hopi
-00033d00: 6e67 2061 6e20 6578 7465 726e 616c 2064  ng an external d
-00033d10: 6570 6c6f 796d 656e 7420 7379 7374 656d  eployment system
-00033d20: 0a20 2020 2020 2020 2077 696c 6c20 7265  .        will re
-00033d30: 7374 6172 7420 7468 656d 2e20 5468 6572  start them. Ther
-00033d40: 6566 6f72 652c 2069 6620 6e6f 7420 7573  efore, if not us
-00033d50: 696e 6720 6e61 6e6e 6965 7320 616e 6420  ing nannies and 
-00033d60: 796f 7572 2064 6570 6c6f 796d 656e 7420  your deployment 
-00033d70: 7379 7374 656d 0a20 2020 2020 2020 2064  system.        d
-00033d80: 6f65 7320 6e6f 7420 6175 746f 6d61 7469  oes not automati
-00033d90: 6361 6c6c 7920 7265 7374 6172 7420 776f  cally restart wo
-00033da0: 726b 6572 732c 2060 6072 6573 7461 7274  rkers, ``restart
-00033db0: 6060 2077 696c 6c20 6a75 7374 2073 6875  `` will just shu
-00033dc0: 7420 646f 776e 2061 6c6c 0a20 2020 2020  t down all.     
-00033dd0: 2020 2077 6f72 6b65 7273 2c20 7468 656e     workers, then
-00033de0: 2074 696d 6520 6f75 7421 0a0a 2020 2020   time out!..    
-00033df0: 2020 2020 4166 7465 7220 6060 7265 7374      After ``rest
-00033e00: 6172 7460 602c 2061 6c6c 2063 6f6e 6e65  art``, all conne
-00033e10: 6374 6564 2077 6f72 6b65 7273 2061 7265  cted workers are
-00033e20: 206e 6577 2c20 7265 6761 7264 6c65 7373   new, regardless
-00033e30: 206f 6620 7768 6574 6865 7220 6060 5469   of whether ``Ti
-00033e40: 6d65 6f75 7445 7272 6f72 6060 0a20 2020  meoutError``.   
-00033e50: 2020 2020 2077 6173 2072 6169 7365 642e       was raised.
-00033e60: 2041 6e79 2077 6f72 6b65 7273 2074 6861   Any workers tha
-00033e70: 7420 6661 696c 6564 2074 6f20 7368 7574  t failed to shut
-00033e80: 2064 6f77 6e20 696e 2074 696d 6520 6172   down in time ar
-00033e90: 6520 7265 6d6f 7665 642c 2061 6e64 0a20  e removed, and. 
-00033ea0: 2020 2020 2020 206d 6179 206f 7220 6d61         may or ma
-00033eb0: 7920 6e6f 7420 7368 7574 2064 6f77 6e20  y not shut down 
-00033ec0: 6f6e 2074 6865 6972 206f 776e 2069 6e20  on their own in 
-00033ed0: 7468 6520 6675 7475 7265 2e0a 0a20 2020  the future...   
-00033ee0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
-00033ef0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-00033f00: 2d2d 0a20 2020 2020 2020 2074 696d 656f  --.        timeo
-00033f10: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-00033f20: 486f 7720 6c6f 6e67 2074 6f20 7761 6974  How long to wait
-00033f30: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
-00033f40: 7368 7574 2064 6f77 6e20 616e 6420 636f  shut down and co
-00033f50: 6d65 2062 6163 6b2c 2069 6620 6060 7761  me back, if ``wa
-00033f60: 6974 5f66 6f72 5f77 6f72 6b65 7273 6060  it_for_workers``
-00033f70: 0a20 2020 2020 2020 2020 2020 2069 7320  .            is 
-00033f80: 5472 7565 2c20 6f74 6865 7277 6973 6520  True, otherwise 
-00033f90: 6a75 7374 2068 6f77 206c 6f6e 6720 746f  just how long to
-00033fa0: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
-00033fb0: 7320 746f 2073 6875 7420 646f 776e 2e0a  s to shut down..
-00033fc0: 2020 2020 2020 2020 2020 2020 5261 6973              Rais
-00033fd0: 6573 2060 6061 7379 6e63 696f 2e54 696d  es ``asyncio.Tim
-00033fe0: 656f 7574 4572 726f 7260 6020 6966 2074  eoutError`` if t
-00033ff0: 6869 7320 6973 2065 7863 6565 6465 642e  his is exceeded.
-00034000: 0a20 2020 2020 2020 2077 6169 745f 666f  .        wait_fo
-00034010: 725f 776f 726b 6572 733a 0a20 2020 2020  r_workers:.     
-00034020: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
-00034030: 6f20 7761 6974 2066 6f72 2061 6c6c 2077  o wait for all w
-00034040: 6f72 6b65 7273 2074 6f20 7265 636f 6e6e  orkers to reconn
-00034050: 6563 742c 206f 7220 6a75 7374 2066 6f72  ect, or just for
-00034060: 2074 6865 6d20 746f 2073 6875 7420 646f   them to shut do
-00034070: 776e 0a20 2020 2020 2020 2020 2020 2028  wn.            (
-00034080: 6465 6661 756c 7420 5472 7565 292e 2055  default True). U
-00034090: 7365 2060 6072 6573 7461 7274 2877 6169  se ``restart(wai
-000340a0: 745f 666f 725f 776f 726b 6572 733d 4661  t_for_workers=Fa
-000340b0: 6c73 6529 6060 2063 6f6d 6269 6e65 6420  lse)`` combined 
-000340c0: 7769 7468 0a20 2020 2020 2020 2020 2020  with.           
-000340d0: 203a 6d65 7468 3a60 436c 6965 6e74 2e77   :meth:`Client.w
-000340e0: 6169 745f 666f 725f 776f 726b 6572 7360  ait_for_workers`
-000340f0: 2066 6f72 2067 7261 6e75 6c61 7220 636f   for granular co
-00034100: 6e74 726f 6c20 6f76 6572 2068 6f77 206d  ntrol over how m
-00034110: 616e 7920 776f 726b 6572 7320 746f 0a20  any workers to. 
-00034120: 2020 2020 2020 2020 2020 2077 6169 7420             wait 
-00034130: 666f 722e 0a0a 2020 2020 2020 2020 5365  for...        Se
-00034140: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-00034150: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00034160: 436c 6965 6e74 2e72 6573 7461 7274 0a20  Client.restart. 
-00034170: 2020 2020 2020 2043 6c69 656e 742e 7265         Client.re
-00034180: 7374 6172 745f 776f 726b 6572 730a 2020  start_workers.  
-00034190: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000341a0: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-000341b0: 6622 7265 7374 6172 742d 7b74 696d 6528  f"restart-{time(
-000341c0: 297d 220a 0a20 2020 2020 2020 206c 6f67  )}"..        log
-000341d0: 6765 722e 696e 666f 2822 5265 7374 6172  ger.info("Restar
-000341e0: 7469 6e67 2077 6f72 6b65 7273 2061 6e64  ting workers and
-000341f0: 2072 656c 6561 7369 6e67 2061 6c6c 206b   releasing all k
-00034200: 6579 732e 2229 0a20 2020 2020 2020 2066  eys.").        f
-00034210: 6f72 2063 7320 696e 2073 656c 662e 636c  or cs in self.cl
-00034220: 6965 6e74 732e 7661 6c75 6573 2829 3a0a  ients.values():.
-00034230: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00034240: 2e63 6c69 656e 745f 7265 6c65 6173 6573  .client_releases
-00034250: 5f6b 6579 7328 0a20 2020 2020 2020 2020  _keys(.         
-00034260: 2020 2020 2020 206b 6579 733d 5b74 732e         keys=[ts.
-00034270: 6b65 7920 666f 7220 7473 2069 6e20 6373  key for ts in cs
-00034280: 2e77 616e 7473 5f77 6861 745d 2c0a 2020  .wants_what],.  
-00034290: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-000342a0: 6965 6e74 3d63 732e 636c 6965 6e74 5f6b  ient=cs.client_k
-000342b0: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
-000342c0: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
-000342d0: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
-000342e0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000342f0: 2020 2020 7365 6c66 2e5f 636c 6561 725f      self._clear_
-00034300: 7461 736b 5f73 7461 7465 2829 0a20 2020  task_state().   
-00034310: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00034320: 7365 6c66 2e74 6173 6b73 0a20 2020 2020  self.tasks.     
-00034330: 2020 2073 656c 662e 7265 706f 7274 287b     self.report({
-00034340: 226f 7022 3a20 2272 6573 7461 7274 227d  "op": "restart"}
-00034350: 290a 0a20 2020 2020 2020 2066 6f72 2070  )..        for p
-00034360: 6c75 6769 6e20 696e 206c 6973 7428 7365  lugin in list(se
-00034370: 6c66 2e70 6c75 6769 6e73 2e76 616c 7565  lf.plugins.value
-00034380: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00034390: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000343a0: 2020 2020 2020 2070 6c75 6769 6e2e 7265         plugin.re
-000343b0: 7374 6172 7428 7365 6c66 290a 2020 2020  start(self).    
-000343c0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
-000343d0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
-000343e0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000343f0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
-00034400: 6529 0a0a 2020 2020 2020 2020 6e5f 776f  e)..        n_wo
-00034410: 726b 6572 7320 3d20 6c65 6e28 7365 6c66  rkers = len(self
-00034420: 2e77 6f72 6b65 7273 290a 2020 2020 2020  .workers).      
-00034430: 2020 6e61 6e6e 795f 776f 726b 6572 7320    nanny_workers 
-00034440: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00034450: 6164 6472 3a20 7773 2e6e 616e 6e79 2066  addr: ws.nanny f
-00034460: 6f72 2061 6464 722c 2077 7320 696e 2073  or addr, ws in s
-00034470: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
-00034480: 7328 2920 6966 2077 732e 6e61 6e6e 790a  s() if ws.nanny.
-00034490: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-000344a0: 2020 2320 436c 6f73 6520 6e6f 6e2d 4e61    # Close non-Na
-000344b0: 6e6e 7920 776f 726b 6572 732e 2057 6520  nny workers. We 
-000344c0: 6861 7665 206e 6f20 7761 7920 746f 2072  have no way to r
-000344d0: 6573 7461 7274 2074 6865 6d2c 2073 6f20  estart them, so 
-000344e0: 7765 206a 7573 7420 6c65 7420 7468 656d  we just let them
-000344f0: 2067 6f2c 0a20 2020 2020 2020 2023 2061   go,.        # a
-00034500: 6e64 2061 7373 756d 6520 6120 6465 706c  nd assume a depl
-00034510: 6f79 6d65 6e74 2073 7973 7465 6d20 6973  oyment system is
-00034520: 2067 6f69 6e67 2074 6f20 7265 7374 6172   going to restar
-00034530: 7420 7468 656d 2066 6f72 2075 732e 0a20  t them for us.. 
-00034540: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-00034550: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-00034560: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
-00034570: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00034580: 2e72 656d 6f76 655f 776f 726b 6572 2861  .remove_worker(a
-00034590: 6464 7265 7373 3d61 6464 722c 2073 7469  ddress=addr, sti
-000345a0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-000345b0: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
-000345c0: 2020 2020 2020 666f 7220 6164 6472 2069        for addr i
-000345d0: 6e20 7365 6c66 2e77 6f72 6b65 7273 0a20  n self.workers. 
-000345e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000345f0: 6620 6164 6472 206e 6f74 2069 6e20 6e61  f addr not in na
-00034600: 6e6e 795f 776f 726b 6572 730a 2020 2020  nny_workers.    
-00034610: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00034620: 2020 290a 0a20 2020 2020 2020 206c 6f67    )..        log
-00034630: 6765 722e 6465 6275 6728 2253 656e 6420  ger.debug("Send 
-00034640: 6b69 6c6c 2073 6967 6e61 6c20 746f 206e  kill signal to n
-00034650: 616e 6e69 6573 3a20 2573 222c 206e 616e  annies: %s", nan
-00034660: 6e79 5f77 6f72 6b65 7273 290a 2020 2020  ny_workers).    
-00034670: 2020 2020 6173 796e 6320 7769 7468 2063      async with c
-00034680: 6f6e 7465 7874 6c69 622e 4173 796e 6345  ontextlib.AsyncE
-00034690: 7869 7453 7461 636b 2829 2061 7320 7374  xitStack() as st
-000346a0: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
-000346b0: 206e 616e 6e69 6573 203d 2061 7761 6974   nannies = await
-000346c0: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-000346d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000346e0: 202a 280a 2020 2020 2020 2020 2020 2020   *(.            
-000346f0: 2020 2020 2020 2020 7374 6163 6b2e 656e          stack.en
-00034700: 7465 725f 6173 796e 635f 636f 6e74 6578  ter_async_contex
-00034710: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00034720: 2020 2020 2020 2020 2020 2072 7063 286e             rpc(n
-00034730: 616e 6e79 5f61 6464 7265 7373 2c20 636f  anny_address, co
-00034740: 6e6e 6563 7469 6f6e 5f61 7267 733d 7365  nnection_args=se
-00034750: 6c66 2e63 6f6e 6e65 6374 696f 6e5f 6172  lf.connection_ar
-00034760: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
-00034770: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00034780: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00034790: 7220 6e61 6e6e 795f 6164 6472 6573 7320  r nanny_address 
-000347a0: 696e 206e 616e 6e79 5f77 6f72 6b65 7273  in nanny_workers
-000347b0: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-000347c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-000347d0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-000347e0: 2020 2020 2020 2073 7461 7274 203d 206d         start = m
-000347f0: 6f6e 6f74 6f6e 6963 2829 0a20 2020 2020  onotonic().     
-00034800: 2020 2020 2020 2072 6573 7073 203d 2061         resps = a
-00034810: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
-00034820: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
-00034830: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
-00034840: 2020 2020 2020 2020 2020 2020 7761 6974              wait
-00034850: 5f66 6f72 280a 2020 2020 2020 2020 2020  _for(.          
-00034860: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00034870: 4649 584d 4520 646f 6573 206e 6f74 2072  FIXME does not r
-00034880: 6169 7365 2069 6620 7468 6520 7072 6f63  aise if the proc
-00034890: 6573 7320 6661 696c 7320 746f 2073 6875  ess fails to shu
-000348a0: 7420 646f 776e 2c0a 2020 2020 2020 2020  t down,.        
-000348b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000348c0: 2320 7365 6520 6874 7470 733a 2f2f 6769  # see https://gi
-000348d0: 7468 7562 2e63 6f6d 2f64 6173 6b2f 6469  thub.com/dask/di
-000348e0: 7374 7269 6275 7465 642f 7075 6c6c 2f36  stributed/pull/6
-000348f0: 3432 372f 6669 6c65 7323 7238 3934 3931  427/files#r89491
-00034900: 3734 3234 0a20 2020 2020 2020 2020 2020  7424.           
-00034910: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-00034920: 4f54 453a 204e 616e 6e79 2077 696c 6c20  OTE: Nanny will 
-00034930: 6175 746f 6d61 7469 6361 6c6c 7920 7265  automatically re
-00034940: 7374 6172 7420 776f 726b 6572 2070 726f  start worker pro
-00034950: 6365 7373 2077 6865 6e20 6974 2773 206b  cess when it's k
-00034960: 696c 6c65 640a 2020 2020 2020 2020 2020  illed.          
-00034970: 2020 2020 2020 2020 2020 2020 2020 6e61                na
-00034980: 6e6e 792e 6b69 6c6c 280a 2020 2020 2020  nny.kill(.      
-00034990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000349a0: 2020 2020 2020 7265 6173 6f6e 3d22 7363        reason="sc
-000349b0: 6865 6475 6c65 722d 7265 7374 6172 7422  heduler-restart"
-000349c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000349d0: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-000349e0: 6d65 6f75 743d 7469 6d65 6f75 742c 0a20  meout=timeout,. 
-000349f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a00: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00034a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a20: 2020 7469 6d65 6f75 742c 0a20 2020 2020    timeout,.     
-00034a30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00034a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034a50: 2020 2020 2066 6f72 206e 616e 6e79 2069       for nanny i
-00034a60: 6e20 6e61 6e6e 6965 730a 2020 2020 2020  n nannies.      
-00034a70: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00034a80: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00034a90: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
-00034aa0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
-00034ab0: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
-00034ac0: 204e 4f54 453a 2074 6865 2060 576f 726b   NOTE: the `Work
-00034ad0: 6572 5374 6174 6560 2065 6e74 7269 6573  erState` entries
-00034ae0: 2066 6f72 2074 6865 7365 2077 6f72 6b65   for these worke
-00034af0: 7273 2077 696c 6c20 6265 2072 656d 6f76  rs will be remov
-00034b00: 6564 0a20 2020 2020 2020 2020 2020 2023  ed.            #
-00034b10: 206e 6174 7572 616c 6c79 2077 6865 6e20   naturally when 
-00034b20: 7468 6579 2064 6973 636f 6e6e 6563 7420  they disconnect 
-00034b30: 6672 6f6d 2074 6865 2073 6368 6564 756c  from the schedul
-00034b40: 6572 2e0a 0a20 2020 2020 2020 2020 2020  er...           
-00034b50: 2023 2052 656d 6f76 6520 616e 7920 776f   # Remove any wo
-00034b60: 726b 6572 7320 7468 6174 2066 6169 6c65  rkers that faile
-00034b70: 6420 746f 2073 6875 7420 646f 776e 2c20  d to shut down, 
-00034b80: 736f 2077 6520 6361 6e20 6775 6172 616e  so we can guaran
-00034b90: 7465 650a 2020 2020 2020 2020 2020 2020  tee.            
-00034ba0: 2320 7468 6174 2061 6674 6572 2060 7265  # that after `re
-00034bb0: 7374 6172 7460 2c20 7468 6572 6520 6172  start`, there ar
-00034bc0: 6520 6e6f 206f 6c64 2077 6f72 6b65 7273  e no old workers
-00034bd0: 2061 726f 756e 642e 0a20 2020 2020 2020   around..       
-00034be0: 2020 2020 2062 6164 5f6e 616e 6e69 6573       bad_nannies
-00034bf0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-00034c00: 2020 2020 2061 6464 7220 666f 7220 6164       addr for ad
-00034c10: 6472 2c20 7265 7370 2069 6e20 7a69 7028  dr, resp in zip(
-00034c20: 6e61 6e6e 795f 776f 726b 6572 732c 2072  nanny_workers, r
-00034c30: 6573 7073 2920 6966 2072 6573 7020 6973  esps) if resp is
-00034c40: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
-00034c50: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00034c60: 2020 2020 6966 2062 6164 5f6e 616e 6e69      if bad_nanni
-00034c70: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00034c80: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-00034c90: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00034ca0: 2020 2020 2020 2020 2020 2020 2020 2a28                *(
-00034cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034cc0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00034cd0: 6d6f 7665 5f77 6f72 6b65 7228 6164 6472  move_worker(addr
-00034ce0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-00034cf0: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
-00034d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034d10: 2020 2066 6f72 2061 6464 7220 696e 2062     for addr in b
-00034d20: 6164 5f6e 616e 6e69 6573 0a20 2020 2020  ad_nannies.     
-00034d30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00034d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034d50: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00034d60: 2020 2020 7261 6973 6520 5469 6d65 6f75      raise Timeou
-00034d70: 7445 7272 6f72 280a 2020 2020 2020 2020  tError(.        
-00034d80: 2020 2020 2020 2020 2020 2020 6622 7b6c              f"{l
-00034d90: 656e 2862 6164 5f6e 616e 6e69 6573 297d  en(bad_nannies)}
-00034da0: 2f7b 6c65 6e28 6e61 6e6e 6965 7329 7d20  /{len(nannies)} 
-00034db0: 6e61 6e6e 7920 776f 726b 6572 2873 2920  nanny worker(s) 
-00034dc0: 6469 6420 6e6f 7420 7368 7574 2064 6f77  did not shut dow
-00034dd0: 6e20 7769 7468 696e 207b 7469 6d65 6f75  n within {timeou
-00034de0: 747d 7322 0a20 2020 2020 2020 2020 2020  t}s".           
-00034df0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00034e00: 7365 6c66 2e6c 6f67 5f65 7665 6e74 285b  self.log_event([
-00034e10: 636c 6965 6e74 2c20 2261 6c6c 225d 2c20  client, "all"], 
-00034e20: 7b22 6163 7469 6f6e 223a 2022 7265 7374  {"action": "rest
-00034e30: 6172 7422 2c20 2263 6c69 656e 7422 3a20  art", "client": 
-00034e40: 636c 6965 6e74 7d29 0a0a 2020 2020 2020  client})..      
-00034e50: 2020 6966 2077 6169 745f 666f 725f 776f    if wait_for_wo
-00034e60: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
-00034e70: 2020 2077 6869 6c65 206c 656e 2873 656c     while len(sel
-00034e80: 662e 776f 726b 6572 7329 203c 206e 5f77  f.workers) < n_w
-00034e90: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00034ea0: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
-00034eb0: 6966 206e 6577 2028 756e 7265 6c61 7465  if new (unrelate
-00034ec0: 6429 2077 6f72 6b65 7273 206a 6f69 6e20  d) workers join 
-00034ed0: 7768 696c 6520 7765 2772 6520 7761 6974  while we're wait
-00034ee0: 696e 672c 2077 6520 6d61 7920 7265 7475  ing, we may retu
-00034ef0: 726e 2062 6566 6f72 650a 2020 2020 2020  rn before.      
-00034f00: 2020 2020 2020 2020 2020 2320 6f75 7220            # our 
-00034f10: 7368 7574 2d64 6f77 6e20 776f 726b 6572  shut-down worker
-00034f20: 7320 6861 7665 2063 6f6d 6520 6261 636b  s have come back
-00034f30: 2075 702e 2054 6861 7427 7320 6669 6e65   up. That's fine
-00034f40: 3b20 776f 726b 6572 7320 6172 6520 696e  ; workers are in
-00034f50: 7465 7263 6861 6e67 6561 626c 652e 0a20  terchangeable.. 
-00034f60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00034f70: 6620 6d6f 6e6f 746f 6e69 6328 2920 3c20  f monotonic() < 
-00034f80: 7374 6172 7420 2b20 7469 6d65 6f75 743a  start + timeout:
-00034f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034fa0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-00034fb0: 696f 2e73 6c65 6570 2830 2e32 290a 2020  io.sleep(0.2).  
-00034fc0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00034fd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00034fe0: 2020 2020 2020 2020 6d73 6720 3d20 280a          msg = (.
-00034ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035000: 2020 2020 2020 2020 6622 5761 6974 6564          f"Waited
-00035010: 2066 6f72 207b 6e5f 776f 726b 6572 737d   for {n_workers}
-00035020: 2077 6f72 6b65 7228 7329 2074 6f20 7265   worker(s) to re
-00035030: 636f 6e6e 6563 7420 6166 7465 7220 7265  connect after re
-00035040: 7374 6172 7469 6e67 2c20 220a 2020 2020  starting, ".    
-00035050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035060: 2020 2020 6622 6275 7420 6166 7465 7220      f"but after 
-00035070: 7b74 696d 656f 7574 7d73 2c20 6f6e 6c79  {timeout}s, only
-00035080: 207b 6c65 6e28 7365 6c66 2e77 6f72 6b65   {len(self.worke
-00035090: 7273 297d 2068 6176 6520 7265 7475 726e  rs)} have return
-000350a0: 6564 2e20 220a 2020 2020 2020 2020 2020  ed. ".          
-000350b0: 2020 2020 2020 2020 2020 2020 2020 2243                "C
-000350c0: 6f6e 7369 6465 7220 6120 6c6f 6e67 6572  onsider a longer
-000350d0: 2074 696d 656f 7574 2c20 6f72 2060 7761   timeout, or `wa
-000350e0: 6974 5f66 6f72 5f77 6f72 6b65 7273 3d46  it_for_workers=F
-000350f0: 616c 7365 602e 220a 2020 2020 2020 2020  alse`.".        
-00035100: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-00035110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035120: 2020 2069 6620 286e 5f6e 616e 6e79 203a     if (n_nanny :
-00035130: 3d20 6c65 6e28 6e61 6e6e 795f 776f 726b  = len(nanny_work
-00035140: 6572 7329 2920 3c20 6e5f 776f 726b 6572  ers)) < n_worker
-00035150: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00035160: 2020 2020 2020 2020 2020 206d 7367 202b             msg +
-00035170: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
-00035180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035190: 6622 2054 6865 207b 6e5f 776f 726b 6572  f" The {n_worker
-000351a0: 7320 2d20 6e5f 6e61 6e6e 797d 2077 6f72  s - n_nanny} wor
-000351b0: 6b65 7228 7329 206e 6f74 2075 7369 6e67  ker(s) not using
-000351c0: 204e 616e 6e69 6573 2077 6572 6520 6a75   Nannies were ju
-000351d0: 7374 2073 6875 7420 220a 2020 2020 2020  st shut ".      
-000351e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000351f0: 2020 2020 2020 2264 6f77 6e20 696e 7374        "down inst
-00035200: 6561 6420 6f66 2072 6573 7461 7274 6564  ead of restarted
-00035210: 2028 7265 7374 6172 7420 6973 206f 6e6c   (restart is onl
-00035220: 7920 706f 7373 6962 6c65 2077 6974 6820  y possible with 
-00035230: 4e61 6e6e 6965 7329 2e20 4966 2022 0a20  Nannies). If ". 
-00035240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035250: 2020 2020 2020 2020 2020 2022 796f 7572             "your
-00035260: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
-00035270: 656d 2064 6f65 7320 6e6f 7420 6175 746f  em does not auto
-00035280: 6d61 7469 6361 6c6c 7920 7265 2d6c 6175  matically re-lau
-00035290: 6e63 6820 7465 726d 696e 6174 6564 2022  nch terminated "
-000352a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000352b0: 2020 2020 2020 2020 2020 2020 2022 7072               "pr
-000352c0: 6f63 6573 7365 732c 2074 6865 6e20 7468  ocesses, then th
-000352d0: 6f73 6520 776f 726b 6572 7320 7769 6c6c  ose workers will
-000352e0: 206e 6576 6572 2063 6f6d 6520 6261 636b   never come back
-000352f0: 2c20 616e 6420 6043 6c69 656e 742e 7265  , and `Client.re
-00035300: 7374 6172 7460 2022 0a20 2020 2020 2020  start` ".       
-00035310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035320: 2020 2020 2022 7769 6c6c 2061 6c77 6179       "will alway
-00035330: 7320 7469 6d65 206f 7574 2e20 446f 206e  s time out. Do n
-00035340: 6f74 2075 7365 2060 436c 6965 6e74 2e72  ot use `Client.r
-00035350: 6573 7461 7274 6020 696e 2074 6861 7420  estart` in that 
-00035360: 6361 7365 2e22 0a20 2020 2020 2020 2020  case.".         
-00035370: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00035380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035390: 2020 2020 2072 6169 7365 2054 696d 656f       raise Timeo
-000353a0: 7574 4572 726f 7228 6d73 6729 2066 726f  utError(msg) fro
-000353b0: 6d20 4e6f 6e65 0a20 2020 2020 2020 206c  m None.        l
-000353c0: 6f67 6765 722e 696e 666f 2822 5265 7374  ogger.info("Rest
-000353d0: 6172 7469 6e67 2066 696e 6973 6865 642e  arting finished.
-000353e0: 2229 0a0a 2020 2020 6173 796e 6320 6465  ")..    async de
-000353f0: 6620 6272 6f61 6463 6173 7428 0a20 2020  f broadcast(.   
-00035400: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00035410: 2020 202a 2c0a 2020 2020 2020 2020 6d73     *,.        ms
-00035420: 673a 2064 6963 742c 0a20 2020 2020 2020  g: dict,.       
-00035430: 2077 6f72 6b65 7273 3a20 6c69 7374 5b73   workers: list[s
-00035440: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
-00035450: 652c 0a20 2020 2020 2020 2068 6f73 7473  e,.        hosts
-00035460: 3a20 6c69 7374 5b73 7472 5d20 7c20 4e6f  : list[str] | No
-00035470: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00035480: 2020 206e 616e 6e79 3a20 626f 6f6c 203d     nanny: bool =
-00035490: 2046 616c 7365 2c0a 2020 2020 2020 2020   False,.        
-000354a0: 7365 7269 616c 697a 6572 733a 2041 6e79  serializers: Any
-000354b0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000354c0: 206f 6e5f 6572 726f 723a 2022 4c69 7465   on_error: "Lite
-000354d0: 7261 6c5b 2772 6169 7365 272c 2027 7265  ral['raise', 're
-000354e0: 7475 726e 272c 2027 7265 7475 726e 5f70  turn', 'return_p
-000354f0: 6963 6b6c 6527 2c20 2769 676e 6f72 6527  ickle', 'ignore'
-00035500: 5d22 203d 2022 7261 6973 6522 2c0a 2020  ]" = "raise",.  
-00035510: 2020 2920 2d3e 2064 6963 743a 2020 2320    ) -> dict:  # 
-00035520: 6469 6374 5b73 7472 2c20 416e 795d 0a20  dict[str, Any]. 
-00035530: 2020 2020 2020 2022 2222 4272 6f61 6463         """Broadc
-00035540: 6173 7420 6d65 7373 6167 6520 746f 2077  ast message to w
-00035550: 6f72 6b65 7273 2c20 7265 7475 726e 2061  orkers, return a
-00035560: 6c6c 2072 6573 756c 7473 2222 220a 2020  ll results""".  
-00035570: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
-00035580: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-00035590: 2020 2020 2020 6966 2068 6f73 7473 2069        if hosts i
-000355a0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000355b0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-000355c0: 3d20 6c69 7374 2873 656c 662e 776f 726b  = list(self.work
-000355d0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-000355e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000355f0: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00035600: 205b 5d0a 2020 2020 2020 2020 6966 2068   [].        if h
-00035610: 6f73 7473 2069 7320 6e6f 7420 4e6f 6e65  osts is not None
-00035620: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00035630: 7220 686f 7374 2069 6e20 686f 7374 733a  r host in hosts:
-00035640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035650: 2064 683a 2064 6963 7420 3d20 7365 6c66   dh: dict = self
-00035660: 2e68 6f73 745f 696e 666f 2e67 6574 2868  .host_info.get(h
-00035670: 6f73 7429 2020 2320 7479 7065 3a20 6967  ost)  # type: ig
-00035680: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-00035690: 2020 2020 2069 6620 6468 2069 7320 6e6f       if dh is no
-000356a0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000356b0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000356c0: 6572 732e 6578 7465 6e64 2864 685b 2261  ers.extend(dh["a
-000356d0: 6464 7265 7373 6573 225d 290a 2020 2020  ddresses"]).    
-000356e0: 2020 2020 2320 544f 444f 2072 6570 6c61      # TODO repla
-000356f0: 6365 2077 6974 6820 776f 726b 6572 5f6c  ce with worker_l
-00035700: 6973 740a 0a20 2020 2020 2020 2069 6620  ist..        if 
-00035710: 6e61 6e6e 793a 0a20 2020 2020 2020 2020  nanny:.         
-00035720: 2020 2061 6464 7265 7373 6573 203d 205b     addresses = [
-00035730: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d2e  self.workers[w].
-00035740: 6e61 6e6e 7920 666f 7220 7720 696e 2077  nanny for w in w
-00035750: 6f72 6b65 7273 5d0a 2020 2020 2020 2020  orkers].        
-00035760: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00035770: 2020 6164 6472 6573 7365 7320 3d20 776f    addresses = wo
-00035780: 726b 6572 730a 0a20 2020 2020 2020 2045  rkers..        E
-00035790: 5252 4f52 203d 206f 626a 6563 7428 290a  RROR = object().
-000357a0: 0a20 2020 2020 2020 2061 7379 6e63 2064  .        async d
-000357b0: 6566 2073 656e 645f 6d65 7373 6167 6528  ef send_message(
-000357c0: 6164 6472 293a 0a20 2020 2020 2020 2020  addr):.         
-000357d0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000357e0: 2020 2020 2020 2020 636f 6d6d 203d 2061          comm = a
-000357f0: 7761 6974 2073 656c 662e 7270 632e 636f  wait self.rpc.co
-00035800: 6e6e 6563 7428 6164 6472 290a 2020 2020  nnect(addr).    
-00035810: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
-00035820: 2e6e 616d 6520 3d20 2253 6368 6564 756c  .name = "Schedul
-00035830: 6572 2042 726f 6164 6361 7374 220a 2020  er Broadcast".  
-00035840: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-00035850: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00035860: 2020 2020 2020 2072 6573 7020 3d20 6177         resp = aw
-00035870: 6169 7420 7365 6e64 5f72 6563 7628 0a20  ait send_recv(. 
-00035880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035890: 2020 2020 2020 2063 6f6d 6d2c 2063 6c6f         comm, clo
-000358a0: 7365 3d54 7275 652c 2073 6572 6961 6c69  se=True, seriali
-000358b0: 7a65 7273 3d73 6572 6961 6c69 7a65 7273  zers=serializers
-000358c0: 2c20 2a2a 6d73 670a 2020 2020 2020 2020  , **msg.        
-000358d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000358e0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-000358f0: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
-00035900: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00035910: 7270 632e 7265 7573 6528 6164 6472 2c20  rpc.reuse(addr, 
-00035920: 636f 6d6d 290a 2020 2020 2020 2020 2020  comm).          
-00035930: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00035940: 700a 2020 2020 2020 2020 2020 2020 6578  p.            ex
-00035950: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00035960: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00035970: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
-00035980: 7228 6622 6272 6f61 6463 6173 7420 746f  r(f"broadcast to
-00035990: 207b 6164 6472 7d20 6661 696c 6564 3a20   {addr} failed: 
-000359a0: 7b65 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e  {e.__class__.__n
-000359b0: 616d 655f 5f7d 3a20 7b65 7d22 290a 2020  ame__}: {e}").  
-000359c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000359d0: 206f 6e5f 6572 726f 7220 3d3d 2022 7261   on_error == "ra
-000359e0: 6973 6522 3a0a 2020 2020 2020 2020 2020  ise":.          
-000359f0: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-00035a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035a10: 656c 6966 206f 6e5f 6572 726f 7220 3d3d  elif on_error ==
-00035a20: 2022 7265 7475 726e 223a 0a20 2020 2020   "return":.     
-00035a30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00035a40: 6574 7572 6e20 650a 2020 2020 2020 2020  eturn e.        
-00035a50: 2020 2020 2020 2020 656c 6966 206f 6e5f          elif on_
-00035a60: 6572 726f 7220 3d3d 2022 7265 7475 726e  error == "return
-00035a70: 5f70 6963 6b6c 6522 3a0a 2020 2020 2020  _pickle":.      
-00035a80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00035a90: 7475 726e 2064 756d 7073 2865 290a 2020  turn dumps(e).  
-00035aa0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00035ab0: 6966 206f 6e5f 6572 726f 7220 3d3d 2022  if on_error == "
-00035ac0: 6967 6e6f 7265 223a 0a20 2020 2020 2020  ignore":.       
-00035ad0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00035ae0: 7572 6e20 4552 524f 520a 2020 2020 2020  urn ERROR.      
-00035af0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00035b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b10: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00035b20: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
-00035b30: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-00035b40: 6e5f 6572 726f 7220 6d75 7374 2062 6520  n_error must be 
-00035b50: 2772 6169 7365 272c 2027 7265 7475 726e  'raise', 'return
-00035b60: 272c 2027 7265 7475 726e 5f70 6963 6b6c  ', 'return_pickl
-00035b70: 6527 2c20 220a 2020 2020 2020 2020 2020  e', ".          
-00035b80: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00035b90: 6f72 2027 6967 6e6f 7265 273b 2067 6f74  or 'ignore'; got
-00035ba0: 207b 6f6e 5f65 7272 6f72 2172 7d22 0a20   {on_error!r}". 
-00035bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035bc0: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-00035bd0: 7375 6c74 7320 3d20 6177 6169 7420 416c  sults = await Al
-00035be0: 6c28 0a20 2020 2020 2020 2020 2020 205b  l(.            [
-00035bf0: 7365 6e64 5f6d 6573 7361 6765 2861 6464  send_message(add
-00035c00: 7265 7373 2920 666f 7220 6164 6472 6573  ress) for addres
-00035c10: 7320 696e 2061 6464 7265 7373 6573 2069  s in addresses i
-00035c20: 6620 6164 6472 6573 7320 6973 206e 6f74  f address is not
-00035c30: 204e 6f6e 655d 0a20 2020 2020 2020 2029   None].        )
-00035c40: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00035c50: 207b 6b3a 2076 2066 6f72 206b 2c20 7620   {k: v for k, v 
-00035c60: 696e 207a 6970 2877 6f72 6b65 7273 2c20  in zip(workers, 
-00035c70: 7265 7375 6c74 7329 2069 6620 7620 6973  results) if v is
-00035c80: 206e 6f74 2045 5252 4f52 7d0a 0a20 2020   not ERROR}..   
-00035c90: 2061 7379 6e63 2064 6566 2070 726f 7879   async def proxy
-00035ca0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00035cb0: 2020 2020 2020 2020 6d73 673a 2064 6963          msg: dic
-00035cc0: 742c 0a20 2020 2020 2020 2077 6f72 6b65  t,.        worke
-00035cd0: 723a 2073 7472 2c0a 2020 2020 2020 2020  r: str,.        
-00035ce0: 7365 7269 616c 697a 6572 733a 2041 6e79  serializers: Any
-00035cf0: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
-00035d00: 3e20 416e 793a 0a20 2020 2020 2020 2022  > Any:.        "
-00035d10: 2222 5072 6f78 7920 6120 636f 6d6d 756e  ""Proxy a commun
-00035d20: 6963 6174 696f 6e20 7468 726f 7567 6820  ication through 
-00035d30: 7468 6520 7363 6865 6475 6c65 7220 746f  the scheduler to
-00035d40: 2073 6f6d 6520 6f74 6865 7220 776f 726b   some other work
-00035d50: 6572 2222 220a 2020 2020 2020 2020 6420  er""".        d 
-00035d60: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00035d70: 6164 6361 7374 286d 7367 3d6d 7367 2c20  adcast(msg=msg, 
-00035d80: 776f 726b 6572 733d 5b77 6f72 6b65 725d  workers=[worker]
-00035d90: 2c20 7365 7269 616c 697a 6572 733d 7365  , serializers=se
-00035da0: 7269 616c 697a 6572 7329 0a20 2020 2020  rializers).     
-00035db0: 2020 2072 6574 7572 6e20 645b 776f 726b     return d[work
-00035dc0: 6572 5d0a 0a20 2020 2061 7379 6e63 2064  er]..    async d
-00035dd0: 6566 2067 6174 6865 725f 6f6e 5f77 6f72  ef gather_on_wor
-00035de0: 6b65 7228 0a20 2020 2020 2020 2073 656c  ker(.        sel
-00035df0: 662c 2077 6f72 6b65 725f 6164 6472 6573  f, worker_addres
-00035e00: 733a 2073 7472 2c20 7768 6f5f 6861 733a  s: str, who_has:
-00035e10: 2022 6469 6374 5b73 7472 2c20 6c69 7374   "dict[str, list
-00035e20: 5b73 7472 5d5d 220a 2020 2020 2920 2d3e  [str]]".    ) ->
-00035e30: 2073 6574 3a0a 2020 2020 2020 2020 2222   set:.        ""
-00035e40: 2250 6565 722d 746f 2d70 6565 7220 636f  "Peer-to-peer co
-00035e50: 7079 206f 6620 6b65 7973 2066 726f 6d20  py of keys from 
-00035e60: 6d75 6c74 6970 6c65 2077 6f72 6b65 7273  multiple workers
-00035e70: 2074 6f20 6120 7369 6e67 6c65 2077 6f72   to a single wor
-00035e80: 6b65 720a 0a20 2020 2020 2020 2050 6172  ker..        Par
-00035e90: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00035ea0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00035eb0: 2020 2077 6f72 6b65 725f 6164 6472 6573     worker_addres
-00035ec0: 733a 2073 7472 0a20 2020 2020 2020 2020  s: str.         
-00035ed0: 2020 2052 6563 6970 6965 6e74 2077 6f72     Recipient wor
-00035ee0: 6b65 7220 6164 6472 6573 7320 746f 2063  ker address to c
-00035ef0: 6f70 7920 6b65 7973 2074 6f0a 2020 2020  opy keys to.    
-00035f00: 2020 2020 7768 6f5f 6861 733a 2064 6963      who_has: dic
-00035f10: 745b 4861 7368 6162 6c65 2c20 6c69 7374  t[Hashable, list
-00035f20: 5b73 7472 5d5d 0a20 2020 2020 2020 2020  [str]].         
-00035f30: 2020 207b 6b65 793a 205b 7365 6e64 6572     {key: [sender
-00035f40: 2061 6464 7265 7373 2c20 7365 6e64 6572   address, sender
-00035f50: 2061 6464 7265 7373 2c20 2e2e 2e5d 2c20   address, ...], 
-00035f60: 6b65 793a 202e 2e2e 7d0a 0a20 2020 2020  key: ...}..     
-00035f70: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
-00035f80: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
-00035f90: 2020 2072 6574 7572 6e73 3a0a 2020 2020     returns:.    
-00035fa0: 2020 2020 2020 2020 7365 7420 6f66 206b          set of k
-00035fb0: 6579 7320 7468 6174 2066 6169 6c65 6420  eys that failed 
-00035fc0: 746f 2062 6520 636f 7069 6564 0a20 2020  to be copied.   
-00035fd0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00035fe0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00035ff0: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
-00036000: 2072 6574 7279 5f6f 7065 7261 7469 6f6e   retry_operation
-00036010: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00036020: 2020 7365 6c66 2e72 7063 2861 6464 723d    self.rpc(addr=
-00036030: 776f 726b 6572 5f61 6464 7265 7373 292e  worker_address).
-00036040: 6761 7468 6572 2c20 7768 6f5f 6861 733d  gather, who_has=
-00036050: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-00036060: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
-00036070: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
-00036080: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00036090: 2054 6869 7320 6361 6e20 6861 7070 656e   This can happen
-000360a0: 2065 2e67 2e20 6966 2074 6865 2077 6f72   e.g. if the wor
-000360b0: 6b65 7220 6973 2067 6f69 6e67 2074 6872  ker is going thr
-000360c0: 6f75 6768 2063 6f6e 7472 6f6c 6c65 6420  ough controlled 
-000360d0: 7368 7574 646f 776e 3b0a 2020 2020 2020  shutdown;.      
-000360e0: 2020 2020 2020 2320 6974 2064 6f65 736e        # it doesn
-000360f0: 2774 206e 6563 6573 7361 7269 6c79 206d  't necessarily m
-00036100: 6561 6e20 7468 6174 2069 7420 7765 6e74  ean that it went
-00036110: 2075 6e65 7870 6563 7465 646c 7920 6d69   unexpectedly mi
-00036120: 7373 696e 670a 2020 2020 2020 2020 2020  ssing.          
-00036130: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-00036140: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00036150: 2020 6622 436f 6d6d 756e 6963 6174 696f    f"Communicatio
-00036160: 6e20 7769 7468 2077 6f72 6b65 7220 7b77  n with worker {w
-00036170: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
-00036180: 6169 6c65 6420 6475 7269 6e67 2022 0a20  ailed during ". 
-00036190: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000361a0: 2272 6570 6c69 6361 7469 6f6e 3a20 7b65  "replication: {e
-000361b0: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
-000361c0: 655f 5f7d 3a20 7b65 7d22 0a20 2020 2020  e__}: {e}".     
-000361d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000361e0: 2020 2020 2072 6574 7572 6e20 7365 7428       return set(
-000361f0: 7768 6f5f 6861 7329 0a0a 2020 2020 2020  who_has)..      
-00036200: 2020 7773 203d 2073 656c 662e 776f 726b    ws = self.work
-00036210: 6572 732e 6765 7428 776f 726b 6572 5f61  ers.get(worker_a
-00036220: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-00036230: 2069 6620 6e6f 7420 7773 3a0a 2020 2020   if not ws:.    
-00036240: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-00036250: 6172 6e69 6e67 2866 2257 6f72 6b65 7220  arning(f"Worker 
-00036260: 7b77 6f72 6b65 725f 6164 6472 6573 737d  {worker_address}
-00036270: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
-00036280: 6c69 6361 7469 6f6e 2229 0a20 2020 2020  lication").     
-00036290: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000362a0: 7428 7768 6f5f 6861 7329 0a20 2020 2020  t(who_has).     
-000362b0: 2020 2065 6c69 6620 7265 7375 6c74 5b22     elif result["
-000362c0: 7374 6174 7573 225d 203d 3d20 224f 4b22  status"] == "OK"
-000362d0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
-000362e0: 7973 5f66 6169 6c65 6420 3d20 7365 7428  ys_failed = set(
-000362f0: 290a 2020 2020 2020 2020 2020 2020 6b65  ).            ke
-00036300: 7973 5f6f 6b3a 2053 6574 203d 2077 686f  ys_ok: Set = who
-00036310: 5f68 6173 2e6b 6579 7328 290a 2020 2020  _has.keys().    
-00036320: 2020 2020 656c 6966 2072 6573 756c 745b      elif result[
-00036330: 2273 7461 7475 7322 5d20 3d3d 2022 7061  "status"] == "pa
-00036340: 7274 6961 6c2d 6661 696c 223a 0a20 2020  rtial-fail":.   
-00036350: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
-00036360: 696c 6564 203d 2073 6574 2872 6573 756c  iled = set(resul
-00036370: 745b 226b 6579 7322 5d29 0a20 2020 2020  t["keys"]).     
-00036380: 2020 2020 2020 206b 6579 735f 6f6b 203d         keys_ok =
-00036390: 2077 686f 5f68 6173 2e6b 6579 7328 2920   who_has.keys() 
-000363a0: 2d20 6b65 7973 5f66 6169 6c65 640a 2020  - keys_failed.  
-000363b0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000363c0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
-000363d0: 2020 2020 2020 2020 2020 6622 576f 726b            f"Work
-000363e0: 6572 207b 776f 726b 6572 5f61 6464 7265  er {worker_addre
-000363f0: 7373 7d20 6661 696c 6564 2074 6f20 6163  ss} failed to ac
-00036400: 7175 6972 6520 6b65 7973 3a20 7b72 6573  quire keys: {res
-00036410: 756c 745b 276b 6579 7327 5d7d 220a 2020  ult['keys']}".  
-00036420: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00036430: 2020 2020 656c 7365 3a20 2023 2070 7261      else:  # pra
-00036440: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
-00036450: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-00036460: 616c 7565 4572 726f 7228 6622 556e 6578  alueError(f"Unex
-00036470: 7065 6374 6564 206d 6573 7361 6765 2066  pected message f
-00036480: 726f 6d20 7b77 6f72 6b65 725f 6164 6472  rom {worker_addr
-00036490: 6573 737d 3a20 7b72 6573 756c 747d 2229  ess}: {result}")
-000364a0: 0a0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
-000364b0: 7920 696e 206b 6579 735f 6f6b 3a0a 2020  y in keys_ok:.  
-000364c0: 2020 2020 2020 2020 2020 7473 3a20 5461            ts: Ta
-000364d0: 736b 5374 6174 6520 3d20 7365 6c66 2e74  skState = self.t
-000364e0: 6173 6b73 2e67 6574 286b 6579 2920 2023  asks.get(key)  #
-000364f0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-00036500: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-00036510: 6973 204e 6f6e 6520 6f72 2074 732e 7374  is None or ts.st
-00036520: 6174 6520 213d 2022 6d65 6d6f 7279 223a  ate != "memory":
-00036530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036540: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
-00036550: 6622 4b65 7920 6c6f 7374 2064 7572 696e  f"Key lost durin
-00036560: 6720 7265 706c 6963 6174 696f 6e3a 207b  g replication: {
-00036570: 6b65 797d 2229 0a20 2020 2020 2020 2020  key}").         
-00036580: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00036590: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000365a0: 7320 6e6f 7420 696e 2074 732e 7768 6f5f  s not in ts.who_
-000365b0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-000365c0: 2020 2020 2073 656c 662e 6164 645f 7265       self.add_re
-000365d0: 706c 6963 6128 7473 2c20 7773 290a 0a20  plica(ts, ws).. 
-000365e0: 2020 2020 2020 2072 6574 7572 6e20 6b65         return ke
-000365f0: 7973 5f66 6169 6c65 640a 0a20 2020 2061  ys_failed..    a
-00036600: 7379 6e63 2064 6566 2064 656c 6574 655f  sync def delete_
-00036610: 776f 726b 6572 5f64 6174 6128 0a20 2020  worker_data(.   
-00036620: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-00036630: 725f 6164 6472 6573 733a 2073 7472 2c20  r_address: str, 
-00036640: 6b65 7973 3a20 2243 6f6c 6c65 6374 696f  keys: "Collectio
-00036650: 6e5b 7374 725d 222c 2073 7469 6d75 6c75  n[str]", stimulu
-00036660: 735f 6964 3a20 7374 720a 2020 2020 2920  s_id: str.    ) 
-00036670: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00036680: 2022 2222 4465 6c65 7465 2064 6174 6120   """Delete data 
-00036690: 6672 6f6d 2061 2077 6f72 6b65 7220 616e  from a worker an
-000366a0: 6420 7570 6461 7465 2074 6865 2063 6f72  d update the cor
-000366b0: 7265 7370 6f6e 6469 6e67 2077 6f72 6b65  responding worke
-000366c0: 722f 7461 736b 2073 7461 7465 730a 0a20  r/task states.. 
-000366d0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-000366e0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-000366f0: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
-00036700: 6b65 725f 6164 6472 6573 733a 2073 7472  ker_address: str
-00036710: 0a20 2020 2020 2020 2020 2020 2057 6f72  .            Wor
-00036720: 6b65 7220 6164 6472 6573 7320 746f 2064  ker address to d
-00036730: 656c 6574 6520 6b65 7973 2066 726f 6d0a  elete keys from.
-00036740: 2020 2020 2020 2020 6b65 7973 3a20 6c69          keys: li
-00036750: 7374 5b73 7472 5d0a 2020 2020 2020 2020  st[str].        
-00036760: 2020 2020 4c69 7374 206f 6620 6b65 7973      List of keys
-00036770: 2074 6f20 6465 6c65 7465 206f 6e20 7468   to delete on th
-00036780: 6520 7370 6563 6966 6965 6420 776f 726b  e specified work
-00036790: 6572 0a20 2020 2020 2020 2022 2222 0a20  er.        """. 
-000367a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000367b0: 2020 2020 2020 2020 6177 6169 7420 7265          await re
-000367c0: 7472 795f 6f70 6572 6174 696f 6e28 0a20  try_operation(. 
-000367d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000367e0: 656c 662e 7270 6328 6164 6472 3d77 6f72  elf.rpc(addr=wor
-000367f0: 6b65 725f 6164 6472 6573 7329 2e66 7265  ker_address).fre
-00036800: 655f 6b65 7973 2c0a 2020 2020 2020 2020  e_keys,.        
-00036810: 2020 2020 2020 2020 6b65 7973 3d6c 6973          keys=lis
-00036820: 7428 6b65 7973 292c 0a20 2020 2020 2020  t(keys),.       
-00036830: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-00036840: 735f 6964 3d66 2264 656c 6574 652d 6461  s_id=f"delete-da
-00036850: 7461 2d7b 7469 6d65 2829 7d22 2c0a 2020  ta-{time()}",.  
-00036860: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00036870: 2020 2020 6578 6365 7074 204f 5345 7272      except OSErr
-00036880: 6f72 2061 7320 653a 0a20 2020 2020 2020  or as e:.       
-00036890: 2020 2020 2023 2054 6869 7320 6361 6e20       # This can 
-000368a0: 6861 7070 656e 2065 2e67 2e20 6966 2074  happen e.g. if t
-000368b0: 6865 2077 6f72 6b65 7220 6973 2067 6f69  he worker is goi
-000368c0: 6e67 2074 6872 6f75 6768 2063 6f6e 7472  ng through contr
-000368d0: 6f6c 6c65 6420 7368 7574 646f 776e 3b0a  olled shutdown;.
-000368e0: 2020 2020 2020 2020 2020 2020 2320 6974              # it
-000368f0: 2064 6f65 736e 2774 206e 6563 6573 7361   doesn't necessa
-00036900: 7269 6c79 206d 6561 6e20 7468 6174 2069  rily mean that i
-00036910: 7420 7765 6e74 2075 6e65 7870 6563 7465  t went unexpecte
-00036920: 646c 7920 6d69 7373 696e 670a 2020 2020  dly missing.    
-00036930: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-00036940: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-00036950: 2020 2020 2020 2020 6622 436f 6d6d 756e          f"Commun
-00036960: 6963 6174 696f 6e20 7769 7468 2077 6f72  ication with wor
-00036970: 6b65 7220 7b77 6f72 6b65 725f 6164 6472  ker {worker_addr
-00036980: 6573 737d 2066 6169 6c65 6420 6475 7269  ess} failed duri
-00036990: 6e67 2022 0a20 2020 2020 2020 2020 2020  ng ".           
-000369a0: 2020 2020 2066 2272 6570 6c69 6361 7469       f"replicati
-000369b0: 6f6e 3a20 7b65 2e5f 5f63 6c61 7373 5f5f  on: {e.__class__
-000369c0: 2e5f 5f6e 616d 655f 5f7d 3a20 7b65 7d22  .__name__}: {e}"
-000369d0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-000369e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000369f0: 6e0a 0a20 2020 2020 2020 2077 7320 3d20  n..        ws = 
-00036a00: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
-00036a10: 2877 6f72 6b65 725f 6164 6472 6573 7329  (worker_address)
-00036a20: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00036a30: 7773 3a0a 2020 2020 2020 2020 2020 2020  ws:.            
-00036a40: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00036a50: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
-00036a60: 0a20 2020 2020 2020 2020 2020 2074 733a  .            ts:
-00036a70: 2054 6173 6b53 7461 7465 203d 2073 656c   TaskState = sel
-00036a80: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-00036a90: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-00036aa0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00036ab0: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
-00036ac0: 6e64 2077 7320 696e 2074 732e 7768 6f5f  nd ws in ts.who_
-00036ad0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-00036ae0: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
-00036af0: 7461 7465 203d 3d20 226d 656d 6f72 7922  tate == "memory"
-00036b00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036b10: 2073 656c 662e 7265 6d6f 7665 5f72 6570   self.remove_rep
-00036b20: 6c69 6361 2874 732c 2077 7329 0a20 2020  lica(ts, ws).   
-00036b30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00036b40: 6e6f 7420 7473 2e77 686f 5f68 6173 3a0a  not ts.who_has:.
-00036b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036b60: 2020 2020 2320 4c61 7374 2063 6f70 7920      # Last copy 
-00036b70: 6465 6c65 7465 640a 2020 2020 2020 2020  deleted.        
-00036b80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00036b90: 2e74 7261 6e73 6974 696f 6e73 287b 6b65  .transitions({ke
-00036ba0: 793a 2022 7265 6c65 6173 6564 227d 2c20  y: "released"}, 
-00036bb0: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-00036bc0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-00036bd0: 7665 6e74 2877 732e 6164 6472 6573 732c  vent(ws.address,
-00036be0: 207b 2261 6374 696f 6e22 3a20 2272 656d   {"action": "rem
-00036bf0: 6f76 652d 776f 726b 6572 2d64 6174 6122  ove-worker-data"
-00036c00: 2c20 226b 6579 7322 3a20 6b65 7973 7d29  , "keys": keys})
-00036c10: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-00036c20: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
-00036c30: 7265 6261 6c61 6e63 6528 0a20 2020 2020  rebalance(.     
-00036c40: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00036c50: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
-00036c60: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
-00036c70: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
-00036c80: 6572 733a 2049 7465 7261 626c 655b 7374  ers: Iterable[st
-00036c90: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
-00036ca0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-00036cb0: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
-00036cc0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
-00036cd0: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-00036ce0: 2022 2222 5265 6261 6c61 6e63 6520 6b65   """Rebalance ke
-00036cf0: 7973 2073 6f20 7468 6174 2065 6163 6820  ys so that each 
-00036d00: 776f 726b 6572 2065 6e64 7320 7570 2077  worker ends up w
-00036d10: 6974 6820 726f 7567 686c 7920 7468 6520  ith roughly the 
-00036d20: 7361 6d65 2070 726f 6365 7373 0a20 2020  same process.   
-00036d30: 2020 2020 206d 656d 6f72 7920 286d 616e       memory (man
-00036d40: 6167 6564 2b75 6e6d 616e 6167 6564 292e  aged+unmanaged).
-00036d50: 0a0a 2020 2020 2020 2020 2e2e 2077 6172  ..        .. war
-00036d60: 6e69 6e67 3a3a 0a20 2020 2020 2020 2020  ning::.         
-00036d70: 2020 5468 6973 206f 7065 7261 7469 6f6e    This operation
-00036d80: 2069 7320 6765 6e65 7261 6c6c 7920 6e6f   is generally no
-00036d90: 7420 7765 6c6c 2074 6573 7465 6420 6167  t well tested ag
-00036da0: 6169 6e73 7420 6e6f 726d 616c 206f 7065  ainst normal ope
-00036db0: 7261 7469 6f6e 206f 6620 7468 650a 2020  ration of the.  
-00036dc0: 2020 2020 2020 2020 2073 6368 6564 756c           schedul
-00036dd0: 6572 2e20 4974 2069 7320 6e6f 7420 7265  er. It is not re
-00036de0: 636f 6d6d 656e 6465 6420 746f 2075 7365  commended to use
-00036df0: 2069 7420 7768 696c 6520 7761 6974 696e   it while waitin
-00036e00: 6720 6f6e 2063 6f6d 7075 7461 7469 6f6e  g on computation
-00036e10: 732e 0a0a 2020 2020 2020 2020 2a2a 416c  s...        **Al
-00036e20: 676f 7269 7468 6d2a 2a0a 0a20 2020 2020  gorithm**..     
-00036e30: 2020 2023 2e20 4669 6e64 2074 6865 206d     #. Find the m
-00036e40: 6561 6e20 6f63 6375 7061 6e63 7920 6f66  ean occupancy of
-00036e50: 2074 6865 2063 6c75 7374 6572 2c20 6465   the cluster, de
-00036e60: 6669 6e65 6420 6173 2064 6174 6120 6d61  fined as data ma
-00036e70: 6e61 6765 6420 6279 2064 6173 6b20 2b0a  naged by dask +.
-00036e80: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-00036e90: 6167 6564 2070 726f 6365 7373 206d 656d  aged process mem
-00036ea0: 6f72 7920 7468 6174 2068 6173 2062 6565  ory that has bee
-00036eb0: 6e20 7468 6572 6520 666f 7220 6174 206c  n there for at l
-00036ec0: 6561 7374 2033 3020 7365 636f 6e64 730a  east 30 seconds.
-00036ed0: 2020 2020 2020 2020 2020 2028 6060 6469             (``di
-00036ee0: 7374 7269 6275 7465 642e 776f 726b 6572  stributed.worker
-00036ef0: 2e6d 656d 6f72 792e 7265 6365 6e74 2d74  .memory.recent-t
-00036f00: 6f2d 6f6c 642d 7469 6d65 6060 292e 0a20  o-old-time``).. 
-00036f10: 2020 2020 2020 2020 2020 5468 6973 206c            This l
-00036f20: 6574 7320 7573 2069 676e 6f72 6520 7465  ets us ignore te
-00036f30: 6d70 6f72 6172 7920 7370 696b 6573 2063  mporary spikes c
-00036f40: 6175 7365 6420 6279 2074 6173 6b20 6865  aused by task he
-00036f50: 6170 2075 7361 6765 2e0a 0a20 2020 2020  ap usage...     
-00036f60: 2020 2020 2020 416c 7465 726e 6174 6976        Alternativ
-00036f70: 656c 792c 2079 6f75 206d 6179 2063 6861  ely, you may cha
-00036f80: 6e67 6520 686f 7720 6d65 6d6f 7279 2069  nge how memory i
-00036f90: 7320 6d65 6173 7572 6564 2062 6f74 6820  s measured both 
-00036fa0: 666f 7220 7468 6520 696e 6469 7669 6475  for the individu
-00036fb0: 616c 0a20 2020 2020 2020 2020 2020 776f  al.           wo
-00036fc0: 726b 6572 7320 6173 2077 656c 6c20 6173  rkers as well as
-00036fd0: 2074 6f20 6361 6c63 756c 6174 6520 7468   to calculate th
-00036fe0: 6520 6d65 616e 2074 6872 6f75 6768 0a20  e mean through. 
-00036ff0: 2020 2020 2020 2020 2020 6060 6469 7374            ``dist
-00037000: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
-00037010: 656d 6f72 792e 7265 6261 6c61 6e63 652e  emory.rebalance.
-00037020: 6d65 6173 7572 6560 602e 204e 616d 656c  measure``. Namel
-00037030: 792c 2074 6869 7320 6361 6e20 6265 2075  y, this can be u
-00037040: 7365 6675 6c0a 2020 2020 2020 2020 2020  seful.          
-00037050: 2074 6f20 6469 7372 6567 6172 6420 696e   to disregard in
-00037060: 6163 6375 7261 7465 204f 5320 6d65 6d6f  accurate OS memo
-00037070: 7279 206d 6561 7375 7265 6d65 6e74 732e  ry measurements.
-00037080: 0a0a 2020 2020 2020 2020 232e 2044 6973  ..        #. Dis
-00037090: 6361 7264 2077 6f72 6b65 7273 2077 686f  card workers who
-000370a0: 7365 206f 6363 7570 616e 6379 2069 7320  se occupancy is 
-000370b0: 7769 7468 696e 2035 2520 6f66 2074 6865  within 5% of the
-000370c0: 206d 6561 6e20 636c 7573 7465 7220 6f63   mean cluster oc
-000370d0: 6375 7061 6e63 790a 2020 2020 2020 2020  cupancy.        
-000370e0: 2020 2028 6060 6469 7374 7269 6275 7465     (``distribute
-000370f0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-00037100: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
-00037110: 2d72 6563 6970 6965 6e74 2d67 6170 6060  -recipient-gap``
-00037120: 202f 2032 292e 0a20 2020 2020 2020 2020   / 2)..         
-00037130: 2020 5468 6973 2068 656c 7073 2061 766f    This helps avo
-00037140: 6964 2064 6174 6120 6672 6f6d 2062 6f75  id data from bou
-00037150: 6e63 696e 6720 6172 6f75 6e64 2074 6865  ncing around the
-00037160: 2063 6c75 7374 6572 2072 6570 6561 7465   cluster repeate
-00037170: 646c 792e 0a20 2020 2020 2020 2023 2e20  dly..        #. 
-00037180: 576f 726b 6572 7320 6162 6f76 6520 7468  Workers above th
-00037190: 6520 6d65 616e 2061 7265 2073 656e 6465  e mean are sende
-000371a0: 7273 3b20 7468 6f73 6520 6265 6c6f 7720  rs; those below 
-000371b0: 6172 6520 7265 6369 7069 656e 7473 2e0a  are recipients..
-000371c0: 2020 2020 2020 2020 232e 2044 6973 6361          #. Disca
-000371d0: 7264 2073 656e 6465 7273 2077 686f 7365  rd senders whose
-000371e0: 2061 6273 6f6c 7574 6520 6f63 6375 7061   absolute occupa
-000371f0: 6e63 7920 6973 2062 656c 6f77 2033 3025  ncy is below 30%
-00037200: 0a20 2020 2020 2020 2020 2020 2860 6064  .           (``d
-00037210: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-00037220: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-00037230: 6365 2e73 656e 6465 722d 6d69 6e60 6029  ce.sender-min``)
-00037240: 2e20 496e 206f 7468 6572 2077 6f72 6473  . In other words
-00037250: 2c20 6e6f 2064 6174 610a 2020 2020 2020  , no data.      
-00037260: 2020 2020 2069 7320 6d6f 7665 6420 7265       is moved re
-00037270: 6761 7264 6c65 7373 206f 6620 696d 6261  gardless of imba
-00037280: 6c61 6e63 696e 6720 6173 206c 6f6e 6720  lancing as long 
-00037290: 6173 2061 6c6c 2077 6f72 6b65 7273 2061  as all workers a
-000372a0: 7265 2062 656c 6f77 2033 3025 2e0a 2020  re below 30%..  
-000372b0: 2020 2020 2020 232e 2044 6973 6361 7264        #. Discard
-000372c0: 2072 6563 6970 6965 6e74 7320 7768 6f73   recipients whos
-000372d0: 6520 6162 736f 6c75 7465 206f 6363 7570  e absolute occup
-000372e0: 616e 6379 2069 7320 6162 6f76 6520 3630  ancy is above 60
-000372f0: 250a 2020 2020 2020 2020 2020 2028 6060  %.           (``
-00037300: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-00037310: 6572 2e6d 656d 6f72 792e 7265 6261 6c61  er.memory.rebala
-00037320: 6e63 652e 7265 6369 7069 656e 742d 6d61  nce.recipient-ma
-00037330: 7860 6029 2e0a 2020 2020 2020 2020 2020  x``)..          
-00037340: 204e 6f74 6520 7468 6174 2074 6869 7320   Note that this 
-00037350: 7468 7265 7368 6f6c 6420 6279 2064 6566  threshold by def
-00037360: 6175 6c74 2069 7320 7468 6520 7361 6d65  ault is the same
-00037370: 2061 730a 2020 2020 2020 2020 2020 2060   as.           `
-00037380: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
-00037390: 6b65 722e 6d65 6d6f 7279 2e74 6172 6765  ker.memory.targe
-000373a0: 7460 6020 746f 2070 7265 7665 6e74 2077  t`` to prevent w
-000373b0: 6f72 6b65 7273 2066 726f 6d20 6163 6365  orkers from acce
-000373c0: 7074 696e 6720 6461 7461 0a20 2020 2020  pting data.     
-000373d0: 2020 2020 2020 616e 6420 696d 6d65 6469        and immedi
-000373e0: 6174 656c 7920 7370 696c 6c69 6e67 2069  ately spilling i
-000373f0: 7420 6f75 7420 746f 2064 6973 6b2e 0a20  t out to disk.. 
-00037400: 2020 2020 2020 2023 2e20 4974 6572 6174         #. Iterat
-00037410: 6976 656c 7920 7069 636b 2074 6865 2073  ively pick the s
-00037420: 656e 6465 7220 616e 6420 7265 6369 7069  ender and recipi
-00037430: 656e 7420 7468 6174 2061 7265 2066 6172  ent that are far
-00037440: 7468 6573 7420 6672 6f6d 2074 6865 206d  thest from the m
-00037450: 6561 6e20 616e 640a 2020 2020 2020 2020  ean and.        
-00037460: 2020 206d 6f76 6520 7468 6520 2a6c 6561     move the *lea
-00037470: 7374 2072 6563 656e 746c 7920 696e 7365  st recently inse
-00037480: 7274 6564 2a20 6b65 7920 6265 7477 6565  rted* key betwee
-00037490: 6e20 7468 6520 7477 6f2c 2075 6e74 696c  n the two, until
-000374a0: 2065 6974 6865 7220 616c 6c0a 2020 2020   either all.    
-000374b0: 2020 2020 2020 2073 656e 6465 7273 206f         senders o
-000374c0: 7220 616c 6c20 7265 6369 7069 656e 7473  r all recipients
-000374d0: 2066 616c 6c20 7769 7468 696e 2035 2520   fall within 5% 
-000374e0: 6f66 2074 6865 206d 6561 6e2e 0a0a 2020  of the mean...  
-000374f0: 2020 2020 2020 2020 2041 2072 6563 6970           A recip
-00037500: 6965 6e74 2077 696c 6c20 6265 2073 6b69  ient will be ski
-00037510: 7070 6564 2069 6620 6974 2061 6c72 6561  pped if it alrea
-00037520: 6479 2068 6173 2061 2063 6f70 7920 6f66  dy has a copy of
-00037530: 2074 6865 2064 6174 612e 2049 6e20 6f74   the data. In ot
-00037540: 6865 720a 2020 2020 2020 2020 2020 2077  her.           w
-00037550: 6f72 6473 2c20 7468 6973 206d 6574 686f  ords, this metho
-00037560: 6420 646f 6573 206e 6f74 2064 6567 7261  d does not degra
-00037570: 6465 2072 6570 6c69 6361 7469 6f6e 2e0a  de replication..
-00037580: 2020 2020 2020 2020 2020 2041 206b 6579             A key
-00037590: 2077 696c 6c20 6265 2073 6b69 7070 6564   will be skipped
-000375a0: 2069 6620 7468 6572 6520 6172 6520 6e6f   if there are no
-000375b0: 2072 6563 6970 6965 6e74 7320 6176 6169   recipients avai
-000375c0: 6c61 626c 6520 7769 7468 2065 6e6f 7567  lable with enoug
-000375d0: 6820 6d65 6d6f 7279 0a20 2020 2020 2020  h memory.       
-000375e0: 2020 2020 746f 2061 6363 6570 7420 7468      to accept th
-000375f0: 6520 6b65 7920 616e 6420 7468 6174 2064  e key and that d
-00037600: 6f6e 2774 2061 6c72 6561 6479 2068 6f6c  on't already hol
-00037610: 6420 6120 636f 7079 2e0a 0a20 2020 2020  d a copy...     
-00037620: 2020 2054 6865 206c 6561 7374 2072 6563     The least rec
-00037630: 656e 746c 7920 696e 7365 7274 6420 284c  ently insertd (L
-00037640: 5249 2920 706f 6c69 6379 2069 7320 6120  RI) policy is a 
-00037650: 6772 6565 6479 2063 686f 6963 6520 7769  greedy choice wi
-00037660: 7468 2074 6865 2061 6476 616e 7461 6765  th the advantage
-00037670: 206f 660a 2020 2020 2020 2020 6265 696e   of.        bein
-00037680: 6720 4f28 3129 2c20 7472 6976 6961 6c20  g O(1), trivial 
-00037690: 746f 2069 6d70 6c65 6d65 6e74 2028 6974  to implement (it
-000376a0: 2072 656c 6965 7320 6f6e 2070 7974 686f   relies on pytho
-000376b0: 6e20 6469 6374 2069 6e73 6572 7469 6f6e  n dict insertion
-000376c0: 2d73 6f72 7469 6e67 290a 2020 2020 2020  -sorting).      
-000376d0: 2020 616e 6420 686f 7065 6675 6c6c 7920    and hopefully 
-000376e0: 676f 6f64 2065 6e6f 7567 6820 696e 206d  good enough in m
-000376f0: 6f73 7420 6361 7365 732e 2044 6973 6361  ost cases. Disca
-00037700: 7264 6564 2061 6c74 6572 6e61 7469 7665  rded alternative
-00037710: 2070 6f6c 6963 6965 7320 7765 7265 3a0a   policies were:.
-00037720: 0a20 2020 2020 2020 202d 204c 6172 6765  .        - Large
-00037730: 7374 2066 6972 7374 2e20 4f28 6e2a 6c6f  st first. O(n*lo
-00037740: 6728 6e29 2920 7361 7665 2066 6f72 206e  g(n)) save for n
-00037750: 6f6e 2d74 7269 7669 616c 2061 6464 6974  on-trivial addit
-00037760: 696f 6e61 6c20 6461 7461 2073 7472 7563  ional data struc
-00037770: 7475 7265 7320 616e 640a 2020 2020 2020  tures and.      
-00037780: 2020 2020 7269 736b 7320 6361 7573 696e      risks causin
-00037790: 6720 7468 6520 6c61 7267 6573 7420 6368  g the largest ch
-000377a0: 756e 6b73 206f 6620 6461 7461 2074 6f20  unks of data to 
-000377b0: 7265 7065 6174 6564 6c79 206d 6f76 6520  repeatedly move 
-000377c0: 6172 6f75 6e64 2074 6865 0a20 2020 2020  around the.     
-000377d0: 2020 2020 2063 6c75 7374 6572 206c 696b       cluster lik
-000377e0: 6520 7069 6e62 616c 6c73 2e0a 2020 2020  e pinballs..    
-000377f0: 2020 2020 2d20 4c65 6173 7420 7265 6365      - Least rece
-00037800: 6e74 6c79 2075 7365 6420 284c 5255 292e  ntly used (LRU).
-00037810: 2054 6869 7320 696e 666f 726d 6174 696f   This informatio
-00037820: 6e20 6973 2063 7572 7265 6e74 6c79 2061  n is currently a
-00037830: 7661 696c 6162 6c65 206f 6e20 7468 650a  vailable on the.
-00037840: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-00037850: 7320 6f6e 6c79 2061 6e64 206e 6f74 2074  s only and not t
-00037860: 7269 7669 616c 2074 6f20 7265 706c 6963  rivial to replic
-00037870: 6174 6520 6f6e 2074 6865 2073 6368 6564  ate on the sched
-00037880: 756c 6572 3b20 7472 616e 736d 6974 7469  uler; transmitti
-00037890: 6e67 2069 740a 2020 2020 2020 2020 2020  ng it.          
-000378a0: 6f76 6572 2074 6865 206e 6574 776f 726b  over the network
-000378b0: 2077 6f75 6c64 2062 6520 7665 7279 2065   would be very e
-000378c0: 7870 656e 7369 7665 2e20 416c 736f 2c20  xpensive. Also, 
-000378d0: 6e6f 7465 2074 6861 7420 6461 736b 2077  note that dask w
-000378e0: 696c 6c20 676f 206f 7574 206f 660a 2020  ill go out of.  
-000378f0: 2020 2020 2020 2020 6974 7320 7761 7920          its way 
-00037900: 746f 206d 696e 696d 6973 6520 7468 6520  to minimise the 
-00037910: 616d 6f75 6e74 206f 6620 7469 6d65 2069  amount of time i
-00037920: 6e74 6572 6d65 6469 6174 6520 6b65 7973  ntermediate keys
-00037930: 2061 7265 2068 656c 6420 696e 206d 656d   are held in mem
-00037940: 6f72 792c 0a20 2020 2020 2020 2020 2073  ory,.          s
-00037950: 6f20 696e 2073 7563 6820 6120 6361 7365  o in such a case
-00037960: 204c 5249 2069 7320 6120 636c 6f73 6520   LRI is a close 
-00037970: 6170 7072 6f78 696d 6174 696f 6e20 6f66  approximation of
-00037980: 204c 5255 2e0a 0a20 2020 2020 2020 2050   LRU...        P
-00037990: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-000379a0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-000379b0: 2020 2020 206b 6579 733a 206f 7074 696f       keys: optio
-000379c0: 6e61 6c0a 2020 2020 2020 2020 2020 2020  nal.            
-000379d0: 616c 6c6f 776c 6973 7420 6f66 2064 6173  allowlist of das
-000379e0: 6b20 6b65 7973 2074 6861 7420 7368 6f75  k keys that shou
-000379f0: 6c64 2062 6520 636f 6e73 6964 6572 6564  ld be considered
-00037a00: 2066 6f72 206d 6f76 696e 672e 2041 6c6c   for moving. All
-00037a10: 206f 7468 6572 206b 6579 730a 2020 2020   other keys.    
-00037a20: 2020 2020 2020 2020 7769 6c6c 2062 6520          will be 
-00037a30: 6967 6e6f 7265 642e 204e 6f74 6520 7468  ignored. Note th
-00037a40: 6174 2074 6869 7320 6f66 6665 7273 206e  at this offers n
-00037a50: 6f20 6775 6172 616e 7465 6520 7468 6174  o guarantee that
-00037a60: 2061 206b 6579 2077 696c 6c20 6163 7475   a key will actu
-00037a70: 616c 6c79 0a20 2020 2020 2020 2020 2020  ally.           
-00037a80: 2062 6520 6d6f 7665 6420 2865 2e67 2e20   be moved (e.g. 
-00037a90: 6265 6361 7573 6520 6974 2069 7320 756e  because it is un
-00037aa0: 6e65 6365 7373 6172 7920 6f72 2062 6563  necessary or bec
-00037ab0: 6175 7365 2074 6865 7265 2061 7265 206e  ause there are n
-00037ac0: 6f20 7669 6162 6c65 0a20 2020 2020 2020  o viable.       
-00037ad0: 2020 2020 2072 6563 6970 6965 6e74 2077       recipient w
-00037ae0: 6f72 6b65 7273 2066 6f72 2069 7429 2e0a  orkers for it)..
-00037af0: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-00037b00: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
-00037b10: 2020 2020 2020 616c 6c6f 776c 6973 7420        allowlist 
-00037b20: 6f66 2077 6f72 6b65 7273 2061 6464 7265  of workers addre
-00037b30: 7373 6573 2074 6f20 6265 2063 6f6e 7369  sses to be consi
-00037b40: 6465 7265 6420 6173 2073 656e 6465 7273  dered as senders
-00037b50: 206f 7220 7265 6369 7069 656e 7473 2e0a   or recipients..
-00037b60: 2020 2020 2020 2020 2020 2020 416c 6c20              All 
-00037b70: 6f74 6865 7220 776f 726b 6572 7320 7769  other workers wi
-00037b80: 6c6c 2062 6520 6967 6e6f 7265 642e 2054  ll be ignored. T
-00037b90: 6865 206d 6561 6e20 636c 7573 7465 7220  he mean cluster 
-00037ba0: 6f63 6375 7061 6e63 7920 7769 6c6c 2062  occupancy will b
-00037bb0: 650a 2020 2020 2020 2020 2020 2020 6361  e.            ca
-00037bc0: 6c63 756c 6174 6564 206f 6e6c 7920 7573  lculated only us
-00037bd0: 696e 6720 7468 6520 616c 6c6f 7765 6420  ing the allowed 
-00037be0: 776f 726b 6572 732e 0a20 2020 2020 2020  workers..       
-00037bf0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
-00037c00: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
-00037c10: 6c75 735f 6964 206f 7220 6622 7265 6261  lus_id or f"reba
-00037c20: 6c61 6e63 652d 7b74 696d 6528 297d 220a  lance-{time()}".
-00037c30: 0a20 2020 2020 2020 2077 7373 3a20 436f  .        wss: Co
-00037c40: 6c6c 6563 7469 6f6e 5b57 6f72 6b65 7253  llection[WorkerS
-00037c50: 7461 7465 5d0a 2020 2020 2020 2020 6966  tate].        if
-00037c60: 2077 6f72 6b65 7273 2069 7320 6e6f 7420   workers is not 
-00037c70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00037c80: 2020 7773 7320 3d20 5b73 656c 662e 776f    wss = [self.wo
-00037c90: 726b 6572 735b 775d 2066 6f72 2077 2069  rkers[w] for w i
-00037ca0: 6e20 776f 726b 6572 735d 0a20 2020 2020  n workers].     
-00037cb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00037cc0: 2020 2020 2077 7373 203d 2073 656c 662e       wss = self.
-00037cd0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00037ce0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00037cf0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
-00037d00: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
-00037d10: 223a 2022 4f4b 227d 0a0a 2020 2020 2020  ": "OK"}..      
-00037d20: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
-00037d30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00037d40: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-00037d50: 616e 6365 286b 6579 732c 2053 6574 293a  ance(keys, Set):
-00037d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037d70: 206b 6579 7320 3d20 7365 7428 6b65 7973   keys = set(keys
-00037d80: 2920 2023 2075 6e6c 6573 7320 616c 7265  )  # unless alre
-00037d90: 6164 7920 6120 7365 742d 6c69 6b65 0a20  ady a set-like. 
-00037da0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00037db0: 7420 6b65 7973 3a0a 2020 2020 2020 2020  t keys:.        
-00037dc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00037dd0: 2273 7461 7475 7322 3a20 224f 4b22 7d0a  "status": "OK"}.
-00037de0: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
-00037df0: 696e 675f 6461 7461 203d 205b 0a20 2020  ing_data = [.   
-00037e00: 2020 2020 2020 2020 2020 2020 206b 2066               k f
-00037e10: 6f72 206b 2069 6e20 6b65 7973 2069 6620  or k in keys if 
-00037e20: 6b20 6e6f 7420 696e 2073 656c 662e 7461  k not in self.ta
-00037e30: 736b 7320 6f72 206e 6f74 2073 656c 662e  sks or not self.
-00037e40: 7461 736b 735b 6b5d 2e77 686f 5f68 6173  tasks[k].who_has
-00037e50: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-00037e60: 2020 2020 2020 2020 2020 2069 6620 6d69             if mi
-00037e70: 7373 696e 675f 6461 7461 3a0a 2020 2020  ssing_data:.    
-00037e80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00037e90: 726e 207b 2273 7461 7475 7322 3a20 2270  rn {"status": "p
-00037ea0: 6172 7469 616c 2d66 6169 6c22 2c20 226b  artial-fail", "k
-00037eb0: 6579 7322 3a20 6d69 7373 696e 675f 6461  eys": missing_da
-00037ec0: 7461 7d0a 0a20 2020 2020 2020 206d 7367  ta}..        msg
-00037ed0: 7320 3d20 7365 6c66 2e5f 7265 6261 6c61  s = self._rebala
-00037ee0: 6e63 655f 6669 6e64 5f6d 7367 7328 6b65  nce_find_msgs(ke
-00037ef0: 7973 2c20 7773 7329 0a20 2020 2020 2020  ys, wss).       
-00037f00: 2069 6620 6e6f 7420 6d73 6773 3a0a 2020   if not msgs:.  
-00037f10: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00037f20: 207b 2273 7461 7475 7322 3a20 224f 4b22   {"status": "OK"
-00037f30: 7d0a 0a20 2020 2020 2020 2061 7379 6e63  }..        async
-00037f40: 2077 6974 6820 7365 6c66 2e5f 6c6f 636b   with self._lock
-00037f50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00037f60: 7375 6c74 203d 2061 7761 6974 2073 656c  sult = await sel
-00037f70: 662e 5f72 6562 616c 616e 6365 5f6d 6f76  f._rebalance_mov
-00037f80: 655f 6461 7461 286d 7367 732c 2073 7469  e_data(msgs, sti
-00037f90: 6d75 6c75 735f 6964 290a 2020 2020 2020  mulus_id).      
-00037fa0: 2020 2020 2020 6966 2072 6573 756c 745b        if result[
-00037fb0: 2273 7461 7475 7322 5d20 3d3d 2022 7061  "status"] == "pa
-00037fc0: 7274 6961 6c2d 6661 696c 2220 616e 6420  rtial-fail" and 
-00037fd0: 6b65 7973 2069 7320 4e6f 6e65 3a0a 2020  keys is None:.  
-00037fe0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00037ff0: 4f6e 6c79 2072 6574 7572 6e20 6661 696c  Only return fail
-00038000: 6564 206b 6579 7320 6966 2074 6865 2063  ed keys if the c
-00038010: 6c69 656e 7420 6578 706c 6963 6974 6c79  lient explicitly
-00038020: 2061 736b 6564 2066 6f72 2074 6865 6d0a   asked for them.
-00038030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038040: 7265 7375 6c74 203d 207b 2273 7461 7475  result = {"statu
-00038050: 7322 3a20 224f 4b22 7d0a 2020 2020 2020  s": "OK"}.      
-00038060: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-00038070: 756c 740a 0a20 2020 2064 6566 205f 7265  ult..    def _re
-00038080: 6261 6c61 6e63 655f 6669 6e64 5f6d 7367  balance_find_msg
-00038090: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-000380a0: 0a20 2020 2020 2020 206b 6579 733a 2053  .        keys: S
-000380b0: 6574 5b48 6173 6861 626c 655d 207c 204e  et[Hashable] | N
-000380c0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
-000380d0: 6b65 7273 3a20 4974 6572 6162 6c65 5b57  kers: Iterable[W
-000380e0: 6f72 6b65 7253 7461 7465 5d2c 0a20 2020  orkerState],.   
-000380f0: 2029 202d 3e20 6c69 7374 5b74 7570 6c65   ) -> list[tuple
-00038100: 5b57 6f72 6b65 7253 7461 7465 2c20 576f  [WorkerState, Wo
-00038110: 726b 6572 5374 6174 652c 2054 6173 6b53  rkerState, TaskS
-00038120: 7461 7465 5d5d 3a0a 2020 2020 2020 2020  tate]]:.        
-00038130: 2222 2249 6465 6e74 6966 7920 776f 726b  """Identify work
-00038140: 6572 7320 7468 6174 206e 6565 6420 746f  ers that need to
-00038150: 206c 6f73 6520 6b65 7973 2061 6e64 2074   lose keys and t
-00038160: 686f 7365 2074 6861 7420 6361 6e20 7265  hose that can re
-00038170: 6365 6976 6520 7468 656d 2c0a 2020 2020  ceive them,.    
-00038180: 2020 2020 746f 6765 7468 6572 2077 6974      together wit
-00038190: 6820 686f 7720 6d61 6e79 2062 7974 6573  h how many bytes
-000381a0: 2065 6163 6820 6e65 6564 7320 746f 206c   each needs to l
-000381b0: 6f73 652f 7265 6365 6976 652e 2054 6865  ose/receive. The
-000381c0: 6e2c 2070 6169 7220 6120 7365 6e64 6572  n, pair a sender
-000381d0: 0a20 2020 2020 2020 2077 6f72 6b65 7220  .        worker 
-000381e0: 7769 7468 2061 2072 6563 6970 6965 6e74  with a recipient
-000381f0: 2077 6f72 6b65 7220 666f 7220 6561 6368   worker for each
-00038200: 206b 6579 2c20 756e 7469 6c20 7468 6520   key, until the 
-00038210: 636c 7573 7465 7220 6973 2072 6562 616c  cluster is rebal
-00038220: 616e 6365 642e 0a0a 2020 2020 2020 2020  anced...        
-00038230: 5468 6973 206d 6574 686f 6420 6f6e 6c79  This method only
-00038240: 2064 6566 696e 6573 2074 6865 2077 6f72   defines the wor
-00038250: 6b20 746f 2062 6520 7065 7266 6f72 6d65  k to be performe
-00038260: 643b 2069 7420 646f 6573 206e 6f74 2073  d; it does not s
-00038270: 7461 7274 2061 6e79 206e 6574 776f 726b  tart any network
-00038280: 0a20 2020 2020 2020 2074 7261 6e73 6665  .        transfe
-00038290: 7273 2069 7473 656c 662e 0a0a 2020 2020  rs itself...    
-000382a0: 2020 2020 5468 6520 6269 672d 4f20 636f      The big-O co
-000382b0: 6d70 6c65 7869 7479 2069 7320 4f28 7774  mplexity is O(wt
-000382c0: 202b 206b 652a 6c6f 6728 7765 2929 2c20   + ke*log(we)), 
-000382d0: 7768 6572 650a 0a20 2020 2020 2020 202d  where..        -
-000382e0: 2077 7420 6973 2074 6865 2074 6f74 616c   wt is the total
-000382f0: 206e 756d 6265 7220 6f66 2077 6f72 6b65   number of worke
-00038300: 7273 206f 6e20 7468 6520 636c 7573 7465  rs on the cluste
-00038310: 7220 286f 7220 7468 6520 6e75 6d62 6572  r (or the number
-00038320: 206f 6620 616c 6c6f 7765 640a 2020 2020   of allowed.    
-00038330: 2020 2020 2020 776f 726b 6572 732c 2069        workers, i
-00038340: 6620 6578 706c 6963 6974 6c79 2073 7461  f explicitly sta
-00038350: 7465 6420 6279 2074 6865 2075 7365 7229  ted by the user)
-00038360: 0a20 2020 2020 2020 202d 2077 6520 6973  .        - we is
-00038370: 2074 6865 206e 756d 6265 7220 6f66 2077   the number of w
-00038380: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
-00038390: 656c 6967 6962 6c65 2074 6f20 6265 2073  eligible to be s
-000383a0: 656e 6465 7273 206f 7220 7265 6369 7069  enders or recipi
-000383b0: 656e 7473 0a20 2020 2020 2020 202d 206b  ents.        - k
-000383c0: 7420 6973 2074 6865 2074 6f74 616c 206e  t is the total n
-000383d0: 756d 6265 7220 6f66 206b 6579 7320 6f6e  umber of keys on
-000383e0: 2074 6865 2063 6c75 7374 6572 2028 6f72   the cluster (or
-000383f0: 206f 6e20 7468 6520 616c 6c6f 7765 6420   on the allowed 
-00038400: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
-00038410: 202d 206b 6520 6973 2074 6865 206e 756d   - ke is the num
-00038420: 6265 7220 6f66 206b 6579 7320 7468 6174  ber of keys that
-00038430: 206e 6565 6420 746f 2062 6520 6d6f 7665   need to be move
-00038440: 6420 696e 206f 7264 6572 2074 6f20 6163  d in order to ac
-00038450: 6869 6576 6520 6120 6261 6c61 6e63 6564  hieve a balanced
-00038460: 0a20 2020 2020 2020 2020 2063 6c75 7374  .          clust
-00038470: 6572 0a0a 2020 2020 2020 2020 5468 6572  er..        Ther
-00038480: 6520 6973 2061 2064 6567 656e 6572 6174  e is a degenerat
-00038490: 6520 6564 6765 2063 6173 6520 4f28 7774  e edge case O(wt
-000384a0: 202b 206b 742a 6c6f 6728 7765 2929 2077   + kt*log(we)) w
-000384b0: 6865 6e20 6b74 2069 7320 6d75 6368 2067  hen kt is much g
-000384c0: 7265 6174 6572 2074 6861 6e0a 2020 2020  reater than.    
-000384d0: 2020 2020 7468 6520 6e75 6d62 6572 206f      the number o
-000384e0: 6620 616c 6c6f 7765 6420 6b65 7973 2c20  f allowed keys, 
-000384f0: 6f72 2077 6865 6e20 6d6f 7374 206b 6579  or when most key
-00038500: 7320 6172 6520 7265 706c 6963 6174 6564  s are replicated
-00038510: 206f 7220 6361 6e6e 6f74 2062 650a 2020   or cannot be.  
-00038520: 2020 2020 2020 6d6f 7665 6420 666f 7220        moved for 
-00038530: 736f 6d65 206f 7468 6572 2072 6561 736f  some other reaso
-00038540: 6e2e 0a0a 2020 2020 2020 2020 5265 7475  n...        Retu
-00038550: 726e 7320 6c69 7374 206f 6620 7475 706c  rns list of tupl
-00038560: 6573 2074 6f20 6665 6564 2069 6e74 6f20  es to feed into 
-00038570: 5f72 6562 616c 616e 6365 5f6d 6f76 655f  _rebalance_move_
-00038580: 6461 7461 3a0a 0a20 2020 2020 2020 202d  data:..        -
-00038590: 2073 656e 6465 7220 776f 726b 6572 0a20   sender worker. 
-000385a0: 2020 2020 2020 202d 2072 6563 6970 6965         - recipie
-000385b0: 6e74 2077 6f72 6b65 720a 2020 2020 2020  nt worker.      
-000385c0: 2020 2d20 7461 736b 2074 6f20 6265 2074    - task to be t
-000385d0: 7261 6e73 6665 7272 6564 0a20 2020 2020  ransferred.     
-000385e0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-000385f0: 2048 6561 7073 206f 6620 776f 726b 6572   Heaps of worker
-00038600: 732c 206d 616e 6167 6564 2062 7920 7468  s, managed by th
-00038610: 6520 6865 6170 7120 6d6f 6475 6c65 2c20  e heapq module, 
-00038620: 7468 6174 206e 6565 6420 746f 2073 656e  that need to sen
-00038630: 642f 7265 6365 6976 6520 6461 7461 2c0a  d/receive data,.
-00038640: 2020 2020 2020 2020 2320 7769 7468 2068          # with h
-00038650: 6f77 206d 616e 7920 6279 7465 7320 6561  ow many bytes ea
-00038660: 6368 206e 6565 6473 2074 6f20 7365 6e64  ch needs to send
-00038670: 2f72 6563 6569 7665 2e0a 2020 2020 2020  /receive..      
-00038680: 2020 230a 2020 2020 2020 2020 2320 4561    #.        # Ea
-00038690: 6368 2065 6c65 6d65 6e74 206f 6620 7468  ch element of th
-000386a0: 6520 6865 6170 2069 7320 6120 7475 706c  e heap is a tupl
-000386b0: 6520 636f 6e73 7472 7563 7465 6420 6173  e constructed as
-000386c0: 2066 6f6c 6c6f 7773 3a0a 2020 2020 2020   follows:.      
-000386d0: 2020 2320 2d20 736e 645f 6279 7465 735f    # - snd_bytes_
-000386e0: 6d61 782f 7265 635f 6279 7465 735f 6d61  max/rec_bytes_ma
-000386f0: 783a 206d 6178 696d 756d 206e 756d 6265  x: maximum numbe
-00038700: 7220 6f66 2062 7974 6573 2074 6f20 7365  r of bytes to se
-00038710: 6e64 206f 7220 7265 6365 6976 652e 0a20  nd or receive.. 
-00038720: 2020 2020 2020 2023 2020 2054 6869 7320         #   This 
-00038730: 6e75 6d62 6572 2069 7320 6e65 6761 7469  number is negati
-00038740: 7665 2c20 736f 2074 6861 7420 7468 6520  ve, so that the 
-00038750: 776f 726b 6572 7320 6661 7274 6865 7374  workers farthest
-00038760: 2066 726f 6d20 7468 6520 636c 7573 7465   from the cluste
-00038770: 7220 6d65 616e 0a20 2020 2020 2020 2023  r mean.        #
-00038780: 2020 2061 7265 2061 7420 7468 6520 746f     are at the to
-00038790: 7020 6f66 2074 6865 2073 6d61 6c6c 6573  p of the smalles
-000387a0: 742d 6669 7273 7420 6865 6170 732e 0a20  t-first heaps.. 
-000387b0: 2020 2020 2020 2023 202d 2073 6e64 5f62         # - snd_b
-000387c0: 7974 6573 5f6d 696e 2f72 6563 5f62 7974  ytes_min/rec_byt
-000387d0: 6573 5f6d 696e 3a20 6d69 6e69 6d75 6d20  es_min: minimum 
-000387e0: 6e75 6d62 6572 206f 6620 6279 7465 7320  number of bytes 
-000387f0: 6166 7465 7220 7365 6e64 696e 672f 7265  after sending/re
-00038800: 6365 6976 696e 670a 2020 2020 2020 2020  ceiving.        
-00038810: 2320 2020 7768 6963 6820 7468 6520 776f  #   which the wo
-00038820: 726b 6572 2073 686f 756c 6420 6e6f 7420  rker should not 
-00038830: 6265 2063 6f6e 7369 6465 7265 6420 616e  be considered an
-00038840: 796d 6f72 652e 2054 6869 7320 6973 2061  ymore. This is a
-00038850: 6c73 6f20 6e65 6761 7469 7665 2e0a 2020  lso negative..  
-00038860: 2020 2020 2020 2320 2d20 6172 6269 7472        # - arbitr
-00038870: 6172 7920 756e 6971 7565 206e 756d 6265  ary unique numbe
-00038880: 722c 2074 6865 7265 206a 7573 7420 746f  r, there just to
-00038890: 2074 6f20 6d61 6b65 2073 7572 6520 7468   to make sure th
-000388a0: 6174 2057 6f72 6b65 7253 7461 7465 206f  at WorkerState o
-000388b0: 626a 6563 7473 0a20 2020 2020 2020 2023  bjects.        #
-000388c0: 2020 2061 7265 206e 6576 6572 2075 7365     are never use
-000388d0: 6420 666f 7220 736f 7274 696e 6720 696e  d for sorting in
-000388e0: 2074 6865 2075 6e6c 696b 656c 7920 6576   the unlikely ev
-000388f0: 656e 7420 7468 6174 2074 776f 2070 726f  ent that two pro
-00038900: 6365 7373 6573 2068 6176 650a 2020 2020  cesses have.    
-00038910: 2020 2020 2320 2020 6578 6163 746c 7920      #   exactly 
-00038920: 7468 6520 7361 6d65 206e 756d 6265 7220  the same number 
-00038930: 6f66 2062 7974 6573 2061 6c6c 6f63 6174  of bytes allocat
-00038940: 6564 2e0a 2020 2020 2020 2020 2320 2d20  ed..        # - 
-00038950: 576f 726b 6572 5374 6174 650a 2020 2020  WorkerState.    
-00038960: 2020 2020 2320 2d20 6974 6572 6174 6f72      # - iterator
-00038970: 206f 6620 616c 6c20 7461 736b 7320 696e   of all tasks in
-00038980: 206d 656d 6f72 7920 6f6e 2074 6865 2077   memory on the w
-00038990: 6f72 6b65 7220 2873 656e 6465 7273 206f  orker (senders o
-000389a0: 6e6c 7929 2c20 696e 7365 7274 696f 6e0a  nly), insertion.
-000389b0: 2020 2020 2020 2020 2320 2020 736f 7274          #   sort
-000389c0: 6564 2028 6c65 6173 7420 7265 6365 6e74  ed (least recent
-000389d0: 6c79 2069 6e73 6572 7465 6420 6669 7273  ly inserted firs
-000389e0: 7429 2e0a 2020 2020 2020 2020 2320 2020  t)..        #   
-000389f0: 4e6f 7465 2074 6861 7420 7468 6973 2069  Note that this i
-00038a00: 7465 7261 746f 7220 7769 6c6c 2074 7970  terator will typ
-00038a10: 6963 616c 6c79 202a 6e6f 742a 2062 6520  ically *not* be 
-00038a20: 6578 6861 7573 7465 642e 2049 7420 7769  exhausted. It wi
-00038a30: 6c6c 206f 6e6c 7920 6265 0a20 2020 2020  ll only be.     
-00038a40: 2020 2023 2020 2065 7868 6175 7374 6564     #   exhausted
-00038a50: 2069 662c 2061 6674 6572 206d 6f76 696e   if, after movin
-00038a60: 6720 6177 6179 2066 726f 6d20 7468 6520  g away from the 
-00038a70: 776f 726b 6572 2061 6c6c 206b 6579 7320  worker all keys 
-00038a80: 7468 6174 2063 616e 2062 6520 6d6f 7665  that can be move
-00038a90: 642c 0a20 2020 2020 2020 2023 2020 2069  d,.        #   i
-00038aa0: 7320 696e 7375 6666 6963 6965 6e74 2074  s insufficient t
-00038ab0: 6f20 6472 6f70 2073 6e64 5f62 7974 6573  o drop snd_bytes
-00038ac0: 5f6d 696e 2061 626f 7665 2030 2e0a 2020  _min above 0..  
-00038ad0: 2020 2020 2020 7365 6e64 6572 733a 206c        senders: l
-00038ae0: 6973 745b 7475 706c 655b 696e 742c 2069  ist[tuple[int, i
-00038af0: 6e74 2c20 696e 742c 2057 6f72 6b65 7253  nt, int, WorkerS
-00038b00: 7461 7465 2c20 4974 6572 6174 6f72 5b54  tate, Iterator[T
-00038b10: 6173 6b53 7461 7465 5d5d 5d20 3d20 5b5d  askState]]] = []
-00038b20: 0a20 2020 2020 2020 2072 6563 6970 6965  .        recipie
-00038b30: 6e74 733a 206c 6973 745b 7475 706c 655b  nts: list[tuple[
-00038b40: 696e 742c 2069 6e74 2c20 696e 742c 2057  int, int, int, W
-00038b50: 6f72 6b65 7253 7461 7465 5d5d 203d 205b  orkerState]] = [
-00038b60: 5d0a 0a20 2020 2020 2020 2023 204f 7574  ]..        # Out
-00038b70: 7075 743a 205b 2873 656e 6465 722c 2072  put: [(sender, r
-00038b80: 6563 6970 6965 6e74 2c20 7461 736b 292c  ecipient, task),
-00038b90: 202e 2e2e 5d0a 2020 2020 2020 2020 6d73   ...].        ms
-00038ba0: 6773 3a20 6c69 7374 5b74 7570 6c65 5b57  gs: list[tuple[W
-00038bb0: 6f72 6b65 7253 7461 7465 2c20 576f 726b  orkerState, Work
-00038bc0: 6572 5374 6174 652c 2054 6173 6b53 7461  erState, TaskSta
-00038bd0: 7465 5d5d 203d 205b 5d0a 0a20 2020 2020  te]] = []..     
-00038be0: 2020 2023 2042 7920 6465 6661 756c 742c     # By default,
-00038bf0: 2074 6869 7320 6973 2074 6865 206f 7074   this is the opt
-00038c00: 696d 6973 7469 6320 6d65 6d6f 7279 2c20  imistic memory, 
-00038c10: 6d65 616e 696e 6720 746f 7461 6c20 7072  meaning total pr
-00038c20: 6f63 6573 7320 6d65 6d6f 7279 206d 696e  ocess memory min
-00038c30: 7573 0a20 2020 2020 2020 2023 2075 6e6d  us.        # unm
-00038c40: 616e 6167 6564 206d 656d 6f72 7920 7468  anaged memory th
-00038c50: 6174 2061 7070 6561 7265 6420 6f76 6572  at appeared over
-00038c60: 2074 6865 206c 6173 7420 3330 2073 6563   the last 30 sec
-00038c70: 6f6e 6473 0a20 2020 2020 2020 2023 2028  onds.        # (
-00038c80: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
-00038c90: 6572 2e6d 656d 6f72 792e 7265 6365 6e74  er.memory.recent
-00038ca0: 2d74 6f2d 6f6c 642d 7469 6d65 292e 0a20  -to-old-time).. 
-00038cb0: 2020 2020 2020 2023 2054 6869 7320 6c65         # This le
-00038cc0: 7473 2075 7320 6967 6e6f 7265 2074 656d  ts us ignore tem
-00038cd0: 706f 7261 7279 2073 7069 6b65 7320 6361  porary spikes ca
-00038ce0: 7573 6564 2062 7920 7461 736b 2068 6561  used by task hea
-00038cf0: 7020 7573 6167 652e 0a20 2020 2020 2020  p usage..       
-00038d00: 206d 656d 6f72 795f 6279 5f77 6f72 6b65   memory_by_worke
-00038d10: 7220 3d20 5b0a 2020 2020 2020 2020 2020  r = [.          
-00038d20: 2020 2877 732c 2067 6574 6174 7472 2877    (ws, getattr(w
-00038d30: 732e 6d65 6d6f 7279 2c20 7365 6c66 2e4d  s.memory, self.M
-00038d40: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-00038d50: 4d45 4153 5552 4529 2920 666f 7220 7773  MEASURE)) for ws
-00038d60: 2069 6e20 776f 726b 6572 730a 2020 2020   in workers.    
-00038d70: 2020 2020 5d0a 2020 2020 2020 2020 6d65      ].        me
-00038d80: 616e 5f6d 656d 6f72 7920 3d20 7375 6d28  an_memory = sum(
-00038d90: 6d20 666f 7220 5f2c 206d 2069 6e20 6d65  m for _, m in me
-00038da0: 6d6f 7279 5f62 795f 776f 726b 6572 2920  mory_by_worker) 
-00038db0: 2f2f 206c 656e 286d 656d 6f72 795f 6279  // len(memory_by
-00038dc0: 5f77 6f72 6b65 7229 0a0a 2020 2020 2020  _worker)..      
-00038dd0: 2020 666f 7220 7773 2c20 7773 5f6d 656d    for ws, ws_mem
-00038de0: 6f72 7920 696e 206d 656d 6f72 795f 6279  ory in memory_by
-00038df0: 5f77 6f72 6b65 723a 0a20 2020 2020 2020  _worker:.       
-00038e00: 2020 2020 2069 6620 7773 2e6d 656d 6f72       if ws.memor
-00038e10: 795f 6c69 6d69 743a 0a20 2020 2020 2020  y_limit:.       
-00038e20: 2020 2020 2020 2020 2068 616c 665f 6761           half_ga
-00038e30: 7020 3d20 696e 7428 7365 6c66 2e4d 454d  p = int(self.MEM
-00038e40: 4f52 595f 5245 4241 4c41 4e43 455f 4841  ORY_REBALANCE_HA
-00038e50: 4c46 5f47 4150 202a 2077 732e 6d65 6d6f  LF_GAP * ws.memo
-00038e60: 7279 5f6c 696d 6974 290a 2020 2020 2020  ry_limit).      
-00038e70: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
-00038e80: 5f6d 696e 203d 2073 656c 662e 4d45 4d4f  _min = self.MEMO
-00038e90: 5259 5f52 4542 414c 414e 4345 5f53 454e  RY_REBALANCE_SEN
-00038ea0: 4445 525f 4d49 4e20 2a20 7773 2e6d 656d  DER_MIN * ws.mem
-00038eb0: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
-00038ec0: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-00038ed0: 656e 745f 6d61 7820 3d20 7365 6c66 2e4d  ent_max = self.M
-00038ee0: 454d 4f52 595f 5245 4241 4c41 4e43 455f  EMORY_REBALANCE_
-00038ef0: 5245 4349 5049 454e 545f 4d41 5820 2a20  RECIPIENT_MAX * 
-00038f00: 7773 2e6d 656d 6f72 795f 6c69 6d69 740a  ws.memory_limit.
-00038f10: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00038f20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00038f30: 2020 6861 6c66 5f67 6170 203d 2030 0a20    half_gap = 0. 
-00038f40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00038f50: 656e 6465 725f 6d69 6e20 3d20 302e 300a  ender_min = 0.0.
-00038f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038f70: 7265 6369 7069 656e 745f 6d61 7820 3d20  recipient_max = 
-00038f80: 6d61 7468 2e69 6e66 0a0a 2020 2020 2020  math.inf..      
-00038f90: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-00038fa0: 2020 2020 2020 2020 2020 2077 732e 5f68             ws._h
-00038fb0: 6173 5f77 6861 740a 2020 2020 2020 2020  as_what.        
-00038fc0: 2020 2020 2020 2020 616e 6420 7773 5f6d          and ws_m
-00038fd0: 656d 6f72 7920 3e3d 206d 6561 6e5f 6d65  emory >= mean_me
-00038fe0: 6d6f 7279 202b 2068 616c 665f 6761 700a  mory + half_gap.
-00038ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039000: 616e 6420 7773 5f6d 656d 6f72 7920 3e3d  and ws_memory >=
-00039010: 2073 656e 6465 725f 6d69 6e0a 2020 2020   sender_min.    
-00039020: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
-00039030: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
-00039040: 7320 6d61 7920 7365 6e64 2074 6865 2077  s may send the w
-00039050: 6f72 6b65 7220 6265 6c6f 7720 7365 6e64  orker below send
-00039060: 6572 5f6d 696e 2028 6279 2064 6573 6967  er_min (by desig
-00039070: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-00039080: 2020 2073 6e64 5f62 7974 6573 5f6d 6178     snd_bytes_max
-00039090: 203d 206d 6561 6e5f 6d65 6d6f 7279 202d   = mean_memory -
-000390a0: 2077 735f 6d65 6d6f 7279 2020 2320 6e65   ws_memory  # ne
-000390b0: 6761 7469 7665 0a20 2020 2020 2020 2020  gative.         
-000390c0: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
-000390d0: 5f6d 696e 203d 2073 6e64 5f62 7974 6573  _min = snd_bytes
-000390e0: 5f6d 6178 202b 2068 616c 665f 6761 7020  _max + half_gap 
-000390f0: 2023 206e 6567 6174 6976 650a 2020 2020   # negative.    
-00039100: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-00039110: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
-00039120: 7365 6e64 6572 7320 6162 6f76 650a 2020  senders above.  
-00039130: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00039140: 6e64 6572 732e 6170 7065 6e64 280a 2020  nders.append(.  
-00039150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039160: 2020 2873 6e64 5f62 7974 6573 5f6d 6178    (snd_bytes_max
-00039170: 2c20 736e 645f 6279 7465 735f 6d69 6e2c  , snd_bytes_min,
-00039180: 2069 6428 7773 292c 2077 732c 2069 7465   id(ws), ws, ite
-00039190: 7228 7773 2e5f 6861 735f 7768 6174 2929  r(ws._has_what))
-000391a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000391b0: 2029 0a20 2020 2020 2020 2020 2020 2065   ).            e
-000391c0: 6c69 6620 7773 5f6d 656d 6f72 7920 3c20  lif ws_memory < 
-000391d0: 6d65 616e 5f6d 656d 6f72 7920 2d20 6861  mean_memory - ha
-000391e0: 6c66 5f67 6170 2061 6e64 2077 735f 6d65  lf_gap and ws_me
-000391f0: 6d6f 7279 203c 2072 6563 6970 6965 6e74  mory < recipient
-00039200: 5f6d 6178 3a0a 2020 2020 2020 2020 2020  _max:.          
-00039210: 2020 2020 2020 2320 5468 6973 206d 6179        # This may
-00039220: 2073 656e 6420 7468 6520 776f 726b 6572   send the worker
-00039230: 2061 626f 7665 2072 6563 6970 6965 6e74   above recipient
-00039240: 5f6d 6178 2028 6279 2064 6573 6967 6e29  _max (by design)
-00039250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039260: 2072 6563 5f62 7974 6573 5f6d 6178 203d   rec_bytes_max =
-00039270: 2077 735f 6d65 6d6f 7279 202d 206d 6561   ws_memory - mea
-00039280: 6e5f 6d65 6d6f 7279 2020 2320 6e65 6761  n_memory  # nega
-00039290: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
-000392a0: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
-000392b0: 696e 203d 2072 6563 5f62 7974 6573 5f6d  in = rec_bytes_m
-000392c0: 6178 202b 2068 616c 665f 6761 7020 2023  ax + half_gap  #
-000392d0: 206e 6567 6174 6976 650a 2020 2020 2020   negative.      
-000392e0: 2020 2020 2020 2020 2020 2320 5365 6520            # See 
-000392f0: 6465 6669 6e69 7469 6f6e 206f 6620 7265  definition of re
-00039300: 6369 7069 656e 7473 2061 626f 7665 0a20  cipients above. 
-00039310: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00039320: 6563 6970 6965 6e74 732e 6170 7065 6e64  ecipients.append
-00039330: 2828 7265 635f 6279 7465 735f 6d61 782c  ((rec_bytes_max,
-00039340: 2072 6563 5f62 7974 6573 5f6d 696e 2c20   rec_bytes_min, 
-00039350: 6964 2877 7329 2c20 7773 2929 0a0a 2020  id(ws), ws))..  
-00039360: 2020 2020 2020 2320 4661 7374 2065 7869        # Fast exi
-00039370: 7420 696e 2063 6173 6520 6e6f 2074 7261  t in case no tra
-00039380: 6e73 6665 7273 2061 7265 206e 6563 6573  nsfers are neces
-00039390: 7361 7279 206f 7220 706f 7373 6962 6c65  sary or possible
-000393a0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-000393b0: 7365 6e64 6572 7320 6f72 206e 6f74 2072  senders or not r
-000393c0: 6563 6970 6965 6e74 733a 0a20 2020 2020  ecipients:.     
-000393d0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-000393e0: 6576 656e 7428 0a20 2020 2020 2020 2020  event(.         
-000393f0: 2020 2020 2020 2022 616c 6c22 2c0a 2020         "all",.  
-00039400: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-00039410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039420: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
-00039430: 6562 616c 616e 6365 222c 0a20 2020 2020  ebalance",.     
-00039440: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00039450: 7365 6e64 6572 7322 3a20 6c65 6e28 7365  senders": len(se
-00039460: 6e64 6572 7329 2c0a 2020 2020 2020 2020  nders),.        
-00039470: 2020 2020 2020 2020 2020 2020 2272 6563              "rec
-00039480: 6970 6965 6e74 7322 3a20 6c65 6e28 7265  ipients": len(re
-00039490: 6369 7069 656e 7473 292c 0a20 2020 2020  cipients),.     
-000394a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000394b0: 6d6f 7665 645f 6b65 7973 223a 2030 2c0a  moved_keys": 0,.
-000394c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394d0: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
-000394e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000394f0: 7572 6e20 5b5d 0a0a 2020 2020 2020 2020  urn []..        
-00039500: 6865 6170 712e 6865 6170 6966 7928 7365  heapq.heapify(se
-00039510: 6e64 6572 7329 0a20 2020 2020 2020 2068  nders).        h
-00039520: 6561 7071 2e68 6561 7069 6679 2872 6563  eapq.heapify(rec
-00039530: 6970 6965 6e74 7329 0a0a 2020 2020 2020  ipients)..      
-00039540: 2020 7768 696c 6520 7365 6e64 6572 7320    while senders 
-00039550: 616e 6420 7265 6369 7069 656e 7473 3a0a  and recipients:.
-00039560: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
-00039570: 6279 7465 735f 6d61 782c 2073 6e64 5f62  bytes_max, snd_b
-00039580: 7974 6573 5f6d 696e 2c20 5f2c 2073 6e64  ytes_min, _, snd
-00039590: 5f77 732c 2074 735f 6974 6572 203d 2073  _ws, ts_iter = s
-000395a0: 656e 6465 7273 5b30 5d0a 0a20 2020 2020  enders[0]..     
-000395b0: 2020 2020 2020 2023 2049 7465 7261 7465         # Iterate
-000395c0: 2074 6872 6f75 6768 2074 6173 6b73 2069   through tasks i
-000395d0: 6e20 6d65 6d6f 7279 2c20 6c65 6173 7420  n memory, least 
-000395e0: 7265 6365 6e74 6c79 2069 6e73 6572 7465  recently inserte
-000395f0: 6420 6669 7273 740a 2020 2020 2020 2020  d first.        
-00039600: 2020 2020 666f 7220 7473 2069 6e20 7473      for ts in ts
-00039610: 5f69 7465 723a 0a20 2020 2020 2020 2020  _iter:.         
-00039620: 2020 2020 2020 2069 6620 6b65 7973 2069         if keys i
-00039630: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
-00039640: 732e 6b65 7920 6e6f 7420 696e 206b 6579  s.key not in key
-00039650: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00039660: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-00039670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039680: 6e62 7974 6573 203d 2074 732e 6e62 7974  nbytes = ts.nbyt
-00039690: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-000396a0: 2020 2069 6620 6e62 7974 6573 202b 2073     if nbytes + s
-000396b0: 6e64 5f62 7974 6573 5f6d 6178 203e 2030  nd_bytes_max > 0
-000396c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000396d0: 2020 2020 2020 2320 4d6f 7669 6e67 2074        # Moving t
-000396e0: 6869 7320 7461 736b 2077 6f75 6c64 2063  his task would c
-000396f0: 6175 7365 2074 6865 2073 656e 6465 7220  ause the sender 
-00039700: 746f 2067 6f20 6265 6c6f 7720 6d65 616e  to go below mean
-00039710: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
-00039720: 2020 2020 2020 2020 2023 2070 6f74 656e           # poten
-00039730: 7469 616c 6c79 2072 6973 6b20 6265 636f  tially risk beco
-00039740: 6d69 6e67 2061 2072 6563 6970 6965 6e74  ming a recipient
-00039750: 2c20 7768 6963 6820 776f 756c 6420 6361  , which would ca
-00039760: 7573 6520 7461 736b 7320 746f 0a20 2020  use tasks to.   
-00039770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039780: 2023 2062 6f75 6e63 6520 6172 6f75 6e64   # bounce around
-00039790: 2e20 4d6f 7665 206f 6e20 746f 2074 6865  . Move on to the
-000397a0: 206e 6578 7420 7461 736b 206f 6620 7468   next task of th
-000397b0: 6520 7361 6d65 2073 656e 6465 722e 0a20  e same sender.. 
-000397c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397d0: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-000397e0: 2020 2020 2020 2020 2020 2020 2023 2046               # F
-000397f0: 696e 6420 7468 6520 7265 6369 7069 656e  ind the recipien
-00039800: 742c 2066 6172 7468 6573 7420 6672 6f6d  t, farthest from
-00039810: 2074 6865 206d 6561 6e2c 2077 6869 6368   the mean, which
-00039820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039830: 2023 2031 2e20 6861 7320 656e 6f75 6768   # 1. has enough
-00039840: 2061 7661 696c 6162 6c65 2052 414d 2066   available RAM f
-00039850: 6f72 2074 6869 7320 7461 736b 2c20 616e  or this task, an
-00039860: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00039870: 2020 2320 322e 2064 6f65 736e 2774 2068    # 2. doesn't h
-00039880: 6f6c 6420 6120 636f 7079 206f 6620 7468  old a copy of th
-00039890: 6973 2074 6173 6b20 616c 7265 6164 790a  is task already.
-000398a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000398b0: 2320 5468 6572 6520 6d61 7920 6e6f 7420  # There may not 
-000398c0: 6265 2061 6e79 2074 6861 7420 7361 7469  be any that sati
-000398d0: 7366 6965 7320 7468 6573 6520 636f 6e64  sfies these cond
-000398e0: 6974 696f 6e73 3b20 696e 2074 6869 7320  itions; in this 
-000398f0: 6361 7365 0a20 2020 2020 2020 2020 2020  case.           
-00039900: 2020 2020 2023 2074 6869 7320 7461 736b       # this task
-00039910: 2077 6f6e 2774 2062 6520 6d6f 7665 642e   won't be moved.
-00039920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039930: 2073 6b69 7070 6564 5f72 6563 6970 6965   skipped_recipie
-00039940: 6e74 7320 3d20 5b5d 0a20 2020 2020 2020  nts = [].       
-00039950: 2020 2020 2020 2020 2075 7365 5f72 6563           use_rec
-00039960: 6970 6965 6e74 203d 2046 616c 7365 0a20  ipient = False. 
-00039970: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00039980: 6869 6c65 2072 6563 6970 6965 6e74 7320  hile recipients 
-00039990: 616e 6420 6e6f 7420 7573 655f 7265 6369  and not use_reci
-000399a0: 7069 656e 743a 0a20 2020 2020 2020 2020  pient:.         
-000399b0: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
-000399c0: 7974 6573 5f6d 6178 2c20 7265 635f 6279  ytes_max, rec_by
-000399d0: 7465 735f 6d69 6e2c 205f 2c20 7265 635f  tes_min, _, rec_
-000399e0: 7773 203d 2072 6563 6970 6965 6e74 735b  ws = recipients[
-000399f0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-00039a00: 2020 2020 2020 2069 6620 6e62 7974 6573         if nbytes
-00039a10: 202b 2072 6563 5f62 7974 6573 5f6d 6178   + rec_bytes_max
-00039a20: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00039a30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00039a40: 7265 6369 7069 656e 7473 2061 7265 2073  recipients are s
-00039a50: 6f72 7465 6420 6279 2072 6563 5f62 7974  orted by rec_byt
-00039a60: 6573 5f6d 6178 2e0a 2020 2020 2020 2020  es_max..        
-00039a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039a80: 2320 5468 6520 6e65 7874 206f 6e65 7320  # The next ones 
-00039a90: 7769 6c6c 2062 6520 776f 7273 653b 206e  will be worse; n
-00039aa0: 6f20 7265 6173 6f6e 2074 6f20 636f 6e74  o reason to cont
-00039ab0: 696e 7565 2069 7465 7261 7469 6e67 0a20  inue iterating. 
+00032cf0: 6164 6472 6573 733d 776f 726b 6572 2c0a  address=worker,.
+00032d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032d10: 7374 696d 756c 7573 5f69 643d 6622 776f  stimulus_id=f"wo
+00032d20: 726b 6572 2d73 656e 642d 636f 6d6d 2d66  rker-send-comm-f
+00032d30: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
+00032d40: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00032d50: 2020 6465 6620 636c 6965 6e74 5f73 656e    def client_sen
+00032d60: 6428 7365 6c66 2c20 636c 6965 6e74 2c20  d(self, client, 
+00032d70: 6d73 6729 3a0a 2020 2020 2020 2020 2222  msg):.        ""
+00032d80: 2253 656e 6420 6d65 7373 6167 6520 746f  "Send message to
+00032d90: 2063 6c69 656e 7422 2222 0a20 2020 2020   client""".     
+00032da0: 2020 2063 6c69 656e 745f 636f 6d6d 733a     client_comms:
+00032db0: 2064 6963 7420 3d20 7365 6c66 2e63 6c69   dict = self.cli
+00032dc0: 656e 745f 636f 6d6d 730a 2020 2020 2020  ent_comms.      
+00032dd0: 2020 6320 3d20 636c 6965 6e74 5f63 6f6d    c = client_com
+00032de0: 6d73 2e67 6574 2863 6c69 656e 7429 0a20  ms.get(client). 
+00032df0: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
+00032e00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00032e10: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00032e20: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00032e30: 2063 2e73 656e 6428 6d73 6729 0a20 2020   c.send(msg).   
+00032e40: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
+00032e50: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
+00032e60: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00032e70: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00032e80: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
+00032e90: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00032ea0: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
+00032eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032ec0: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+00032ed0: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+00032ee0: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
+00032ef0: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
+00032f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032f10: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
+00032f20: 5f61 6c6c 2873 656c 662c 2063 6c69 656e  _all(self, clien
+00032f30: 745f 6d73 6773 3a20 4d73 6773 2c20 776f  t_msgs: Msgs, wo
+00032f40: 726b 6572 5f6d 7367 733a 204d 7367 7329  rker_msgs: Msgs)
+00032f50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00032f60: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
+00032f70: 6573 2074 6f20 636c 6965 6e74 2061 6e64  es to client and
+00032f80: 2077 6f72 6b65 7273 2222 220a 0a20 2020   workers"""..   
+00032f90: 2020 2020 2066 6f72 2063 6c69 656e 742c       for client,
+00032fa0: 206d 7367 7320 696e 2063 6c69 656e 745f   msgs in client_
+00032fb0: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
+00032fc0: 2020 2020 2020 2020 2020 6320 3d20 7365            c = se
+00032fd0: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
+00032fe0: 6765 7428 636c 6965 6e74 290a 2020 2020  get(client).    
+00032ff0: 2020 2020 2020 2020 6966 2063 2069 7320          if c is 
+00033000: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00033010: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00033020: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00033030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033040: 632e 7365 6e64 282a 6d73 6773 290a 2020  c.send(*msgs).  
+00033050: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00033060: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
+00033070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00033080: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+00033090: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+000330a0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+000330b0: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
+000330c0: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
+000330d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330e0: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
+000330f0: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
+00033100: 2077 7269 7465 2025 7322 2c0a 2020 2020   write %s",.    
+00033110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033120: 2020 2020 632c 0a20 2020 2020 2020 2020      c,.         
+00033130: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00033140: 7367 732c 0a20 2020 2020 2020 2020 2020  sgs,.           
+00033150: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00033160: 5f69 6e66 6f3d 5472 7565 2c0a 2020 2020  _info=True,.    
+00033170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033180: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
+00033190: 6f72 6b65 722c 206d 7367 7320 696e 2077  orker, msgs in w
+000331a0: 6f72 6b65 725f 6d73 6773 2e69 7465 6d73  orker_msgs.items
+000331b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000331c0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000331d0: 2020 2020 2077 203d 2073 656c 662e 7374       w = self.st
+000331e0: 7265 616d 5f63 6f6d 6d73 5b77 6f72 6b65  ream_comms[worke
+000331f0: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
+00033200: 2020 2077 2e73 656e 6428 2a6d 7367 7329     w.send(*msgs)
+00033210: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00033220: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00033230: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00033240: 776f 726b 6572 2061 6c72 6561 6479 2067  worker already g
+00033250: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00033260: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00033270: 2020 2020 2065 7863 6570 7420 2843 6f6d       except (Com
+00033280: 6d43 6c6f 7365 6445 7272 6f72 2c20 4174  mClosedError, At
+00033290: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+000332a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000332b0: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
+000332c0: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
+000332d0: 6c6c 5f73 6f6f 6e28 0a20 2020 2020 2020  ll_soon(.       
+000332e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000332f0: 662e 7265 6d6f 7665 5f77 6f72 6b65 722c  f.remove_worker,
+00033300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033310: 2020 2020 2061 6464 7265 7373 3d77 6f72       address=wor
+00033320: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+00033330: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
+00033340: 735f 6964 3d66 2273 656e 642d 616c 6c2d  s_id=f"send-all-
+00033350: 636f 6d6d 2d66 6169 6c2d 7b74 696d 6528  comm-fail-{time(
+00033360: 297d 222c 0a20 2020 2020 2020 2020 2020  )}",.           
+00033370: 2020 2020 2029 0a0a 2020 2020 2323 2323       )..    ####
+00033380: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00033390: 2323 2323 2323 2323 0a20 2020 2023 204c  ########.    # L
+000333a0: 6573 7320 636f 6d6d 6f6e 2069 6e74 6572  ess common inter
+000333b0: 6163 7469 6f6e 7320 230a 2020 2020 2323  actions #.    ##
+000333c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+000333d0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+000333e0: 6173 796e 6320 6465 6620 7363 6174 7465  async def scatte
+000333f0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+00033400: 0a20 2020 2020 2020 2063 6f6d 6d3d 4e6f  .        comm=No
+00033410: 6e65 2c0a 2020 2020 2020 2020 6461 7461  ne,.        data
+00033420: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
+00033430: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
+00033440: 2020 2020 2063 6c69 656e 743d 4e6f 6e65       client=None
+00033450: 2c0a 2020 2020 2020 2020 6272 6f61 6463  ,.        broadc
+00033460: 6173 743d 4661 6c73 652c 0a20 2020 2020  ast=False,.     
+00033470: 2020 2074 696d 656f 7574 3d32 2c0a 2020     timeout=2,.  
+00033480: 2020 293a 0a20 2020 2020 2020 2022 2222    ):.        """
+00033490: 5365 6e64 2064 6174 6120 6f75 7420 746f  Send data out to
+000334a0: 2077 6f72 6b65 7273 0a0a 2020 2020 2020   workers..      
+000334b0: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+000334c0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+000334d0: 2020 2020 5363 6865 6475 6c65 722e 6272      Scheduler.br
+000334e0: 6f61 6463 6173 743a 0a20 2020 2020 2020  oadcast:.       
+000334f0: 2022 2222 0a20 2020 2020 2020 2073 7461   """.        sta
+00033500: 7274 203d 2074 696d 6528 290a 2020 2020  rt = time().    
+00033510: 2020 2020 7768 696c 6520 5472 7565 3a0a      while True:.
+00033520: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+00033530: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+00033540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033550: 7773 7320 3d20 7365 6c66 2e72 756e 6e69  wss = self.runni
+00033560: 6e67 0a20 2020 2020 2020 2020 2020 2065  ng.            e
+00033570: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00033580: 2020 2020 2077 6f72 6b65 7273 203d 205b       workers = [
+00033590: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
+000335a0: 6573 7328 7729 2066 6f72 2077 2069 6e20  ess(w) for w in 
+000335b0: 776f 726b 6572 735d 0a20 2020 2020 2020  workers].       
+000335c0: 2020 2020 2020 2020 2077 7373 203d 207b           wss = {
+000335d0: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d20  self.workers[w] 
+000335e0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+000335f0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00033600: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
+00033610: 7773 2069 6e20 7773 7320 6966 2077 732e  ws in wss if ws.
+00033620: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00033630: 2e72 756e 6e69 6e67 7d0a 0a20 2020 2020  .running}..     
+00033640: 2020 2020 2020 2069 6620 7773 733a 0a20         if wss:. 
+00033650: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00033660: 7265 616b 0a20 2020 2020 2020 2020 2020  reak.           
+00033670: 2069 6620 7469 6d65 2829 203e 2073 7461   if time() > sta
+00033680: 7274 202b 2074 696d 656f 7574 3a0a 2020  rt + timeout:.  
+00033690: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+000336a0: 6973 6520 5469 6d65 6f75 7445 7272 6f72  ise TimeoutError
+000336b0: 2822 4e6f 2076 616c 6964 2077 6f72 6b65  ("No valid worke
+000336c0: 7273 2066 6f75 6e64 2229 0a20 2020 2020  rs found").     
+000336d0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+000336e0: 6e63 696f 2e73 6c65 6570 2830 2e31 290a  ncio.sleep(0.1).
+000336f0: 0a20 2020 2020 2020 206e 7468 7265 6164  .        nthread
+00033700: 7320 3d20 7b77 732e 6164 6472 6573 733a  s = {ws.address:
+00033710: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
+00033720: 2077 7320 696e 2077 7373 7d0a 0a20 2020   ws in wss}..   
+00033730: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00033740: 7374 616e 6365 2864 6174 612c 2064 6963  stance(data, dic
+00033750: 7429 0a0a 2020 2020 2020 2020 6b65 7973  t)..        keys
+00033760: 2c20 7768 6f5f 6861 732c 206e 6279 7465  , who_has, nbyte
+00033770: 7320 3d20 6177 6169 7420 7363 6174 7465  s = await scatte
+00033780: 725f 746f 5f77 6f72 6b65 7273 286e 7468  r_to_workers(nth
+00033790: 7265 6164 732c 2064 6174 612c 2072 7063  reads, data, rpc
+000337a0: 3d73 656c 662e 7270 6329 0a0a 2020 2020  =self.rpc)..    
+000337b0: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
+000337c0: 6461 7461 2877 686f 5f68 6173 3d77 686f  data(who_has=who
+000337d0: 5f68 6173 2c20 6e62 7974 6573 3d6e 6279  _has, nbytes=nby
+000337e0: 7465 732c 2063 6c69 656e 743d 636c 6965  tes, client=clie
+000337f0: 6e74 290a 0a20 2020 2020 2020 2069 6620  nt)..        if 
+00033800: 6272 6f61 6463 6173 743a 0a20 2020 2020  broadcast:.     
+00033810: 2020 2020 2020 206e 203d 206c 656e 286e         n = len(n
+00033820: 7468 7265 6164 7329 2069 6620 6272 6f61  threads) if broa
+00033830: 6463 6173 7420 6973 2054 7275 6520 656c  dcast is True el
+00033840: 7365 2062 726f 6164 6361 7374 0a20 2020  se broadcast.   
+00033850: 2020 2020 2020 2020 2061 7761 6974 2073           await s
+00033860: 656c 662e 7265 706c 6963 6174 6528 6b65  elf.replicate(ke
+00033870: 7973 3d6b 6579 732c 2077 6f72 6b65 7273  ys=keys, workers
+00033880: 3d77 6f72 6b65 7273 2c20 6e3d 6e29 0a0a  =workers, n=n)..
+00033890: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+000338a0: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+000338b0: 2020 2020 5b63 6c69 656e 742c 2022 616c      [client, "al
+000338c0: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
+000338d0: 2273 6361 7474 6572 222c 2022 636c 6965  "scatter", "clie
+000338e0: 6e74 223a 2063 6c69 656e 742c 2022 636f  nt": client, "co
+000338f0: 756e 7422 3a20 6c65 6e28 6461 7461 297d  unt": len(data)}
+00033900: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00033910: 2020 2072 6574 7572 6e20 6b65 7973 0a0a     return keys..
+00033920: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
+00033930: 7468 6572 2873 656c 662c 206b 6579 732c  ther(self, keys,
+00033940: 2073 6572 6961 6c69 7a65 7273 3d4e 6f6e   serializers=Non
+00033950: 6529 3a0a 2020 2020 2020 2020 2222 2243  e):.        """C
+00033960: 6f6c 6c65 6374 2064 6174 6120 6672 6f6d  ollect data from
+00033970: 2077 6f72 6b65 7273 2074 6f20 7468 6520   workers to the 
+00033980: 7363 6865 6475 6c65 7222 2222 0a20 2020  scheduler""".   
+00033990: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+000339a0: 203d 2066 2267 6174 6865 722d 7b74 696d   = f"gather-{tim
+000339b0: 6528 297d 220a 2020 2020 2020 2020 6b65  e()}".        ke
+000339c0: 7973 203d 206c 6973 7428 6b65 7973 290a  ys = list(keys).
+000339d0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
+000339e0: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+000339f0: 206b 6579 2069 6e20 6b65 7973 3a0a 2020   key in keys:.  
+00033a00: 2020 2020 2020 2020 2020 7473 3a20 5461            ts: Ta
+00033a10: 736b 5374 6174 6520 3d20 7365 6c66 2e74  skState = self.t
+00033a20: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+00033a30: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
+00033a40: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00033a50: 2020 2020 2020 2020 2020 2020 2077 686f               who
+00033a60: 5f68 6173 5b6b 6579 5d20 3d20 5b77 732e  _has[key] = [ws.
+00033a70: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
+00033a80: 6e20 7473 2e77 686f 5f68 6173 5d0a 2020  n ts.who_has].  
+00033a90: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00033aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ab0: 7768 6f5f 6861 735b 6b65 795d 203d 205b  who_has[key] = [
+00033ac0: 5d0a 0a20 2020 2020 2020 2064 6174 612c  ]..        data,
+00033ad0: 206d 6973 7369 6e67 5f6b 6579 732c 206d   missing_keys, m
+00033ae0: 6973 7369 6e67 5f77 6f72 6b65 7273 203d  issing_workers =
+00033af0: 2061 7761 6974 2067 6174 6865 725f 6672   await gather_fr
+00033b00: 6f6d 5f77 6f72 6b65 7273 280a 2020 2020  om_workers(.    
+00033b10: 2020 2020 2020 2020 7768 6f5f 6861 732c          who_has,
+00033b20: 2072 7063 3d73 656c 662e 7270 632c 2063   rpc=self.rpc, c
+00033b30: 6c6f 7365 3d46 616c 7365 2c20 7365 7269  lose=False, seri
+00033b40: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
+00033b50: 6572 730a 2020 2020 2020 2020 290a 2020  ers.        ).  
+00033b60: 2020 2020 2020 6966 206e 6f74 206d 6973        if not mis
+00033b70: 7369 6e67 5f6b 6579 733a 0a20 2020 2020  sing_keys:.     
+00033b80: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00033b90: 7b22 7374 6174 7573 223a 2022 4f4b 222c  {"status": "OK",
+00033ba0: 2022 6461 7461 223a 2064 6174 617d 0a20   "data": data}. 
+00033bb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00033bc0: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
+00033bd0: 5f73 7461 7465 7320 3d20 5b0a 2020 2020  _states = [.    
+00033be0: 2020 2020 2020 2020 2020 2020 2873 656c              (sel
+00033bf0: 662e 7461 736b 735b 6b65 795d 2e73 7461  f.tasks[key].sta
+00033c00: 7465 2069 6620 6b65 7920 696e 2073 656c  te if key in sel
+00033c10: 662e 7461 736b 7320 656c 7365 204e 6f6e  f.tasks else Non
+00033c20: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00033c30: 2020 2066 6f72 206b 6579 2069 6e20 6d69     for key in mi
+00033c40: 7373 696e 675f 6b65 7973 0a20 2020 2020  ssing_keys.     
+00033c50: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+00033c60: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00033c70: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+00033c80: 2020 2020 2020 2022 436f 756c 646e 2774         "Couldn't
+00033c90: 2067 6174 6865 7220 6b65 7973 2025 7320   gather keys %s 
+00033ca0: 7374 6174 653a 2025 7320 776f 726b 6572  state: %s worker
+00033cb0: 733a 2025 7322 2c0a 2020 2020 2020 2020  s: %s",.        
+00033cc0: 2020 2020 2020 2020 6d69 7373 696e 675f          missing_
+00033cd0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
+00033ce0: 2020 2020 2020 6d69 7373 696e 675f 7374        missing_st
+00033cf0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00033d00: 2020 2020 2020 6d69 7373 696e 675f 776f        missing_wo
+00033d10: 726b 6572 732c 0a20 2020 2020 2020 2020  rkers,.         
+00033d20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00033d30: 2072 6573 756c 7420 3d20 7b22 7374 6174   result = {"stat
+00033d40: 7573 223a 2022 6572 726f 7222 2c20 226b  us": "error", "k
+00033d50: 6579 7322 3a20 6d69 7373 696e 675f 6b65  eys": missing_ke
+00033d60: 7973 7d0a 2020 2020 2020 2020 2020 2020  ys}.            
+00033d70: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
+00033d80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00033d90: 2020 2023 2052 656d 6f76 6520 7375 7370     # Remove susp
+00033da0: 6963 696f 7573 2077 6f72 6b65 7273 2066  icious workers f
+00033db0: 726f 6d20 7468 6520 7363 6865 6475 6c65  rom the schedule
+00033dc0: 7220 616e 6420 7368 7574 2074 6865 6d20  r and shut them 
+00033dd0: 646f 776e 2e0a 2020 2020 2020 2020 2020  down..          
+00033de0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00033df0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+00033e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e10: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+00033e20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00033e30: 7265 6d6f 7665 5f77 6f72 6b65 7228 0a20  remove_worker(. 
+00033e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e50: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00033e60: 7373 3d77 6f72 6b65 722c 2063 6c6f 7365  ss=worker, close
+00033e70: 3d54 7275 652c 2073 7469 6d75 6c75 735f  =True, stimulus_
+00033e80: 6964 3d73 7469 6d75 6c75 735f 6964 0a20  id=stimulus_id. 
+00033e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ea0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00033eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ec0: 2066 6f72 2077 6f72 6b65 7220 696e 206d   for worker in m
+00033ed0: 6973 7369 6e67 5f77 6f72 6b65 7273 0a20  issing_workers. 
+00033ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ef0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00033f00: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00033f10: 2020 2020 2020 2066 6f72 206b 6579 2c20         for key, 
+00033f20: 776f 726b 6572 7320 696e 206d 6973 7369  workers in missi
+00033f30: 6e67 5f6b 6579 732e 6974 656d 7328 293a  ng_keys.items():
+00033f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033f50: 2020 2020 206c 6f67 6765 722e 6578 6365       logger.exce
+00033f60: 7074 696f 6e28 0a20 2020 2020 2020 2020  ption(.         
+00033f70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00033f80: 5368 7574 2064 6f77 6e20 776f 726b 6572  Shut down worker
+00033f90: 7320 7468 6174 2064 6f6e 2774 2068 6176  s that don't hav
+00033fa0: 6520 7072 6f6d 6973 6564 206b 6579 3a20  e promised key: 
+00033fb0: 2573 2c20 2573 222c 0a20 2020 2020 2020  %s, %s",.       
+00033fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033fd0: 2073 7472 2877 6f72 6b65 7273 292c 0a20   str(workers),. 
+00033fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033ff0: 2020 2020 2020 2073 7472 286b 6579 292c         str(key),
+00034000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034010: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00034020: 7365 6c66 2e6c 6f67 5f65 7665 6e74 2822  self.log_event("
+00034030: 616c 6c22 2c20 7b22 6163 7469 6f6e 223a  all", {"action":
+00034040: 2022 6761 7468 6572 222c 2022 636f 756e   "gather", "coun
+00034050: 7422 3a20 6c65 6e28 6b65 7973 297d 290a  t": len(keys)}).
+00034060: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00034070: 6573 756c 740a 0a20 2020 2040 6c6f 675f  esult..    @log_
+00034080: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
+00034090: 2064 6566 2072 6573 7461 7274 2873 656c   def restart(sel
+000340a0: 662c 2063 6c69 656e 743d 4e6f 6e65 2c20  f, client=None, 
+000340b0: 7469 6d65 6f75 743d 3330 2c20 7761 6974  timeout=30, wait
+000340c0: 5f66 6f72 5f77 6f72 6b65 7273 3d54 7275  _for_workers=Tru
+000340d0: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
+000340e0: 2020 2020 2020 2020 5265 7374 6172 7420          Restart 
+000340f0: 616c 6c20 776f 726b 6572 732e 2052 6573  all workers. Res
+00034100: 6574 206c 6f63 616c 2073 7461 7465 2e20  et local state. 
+00034110: 4f70 7469 6f6e 616c 6c79 2077 6169 7420  Optionally wait 
+00034120: 666f 7220 776f 726b 6572 7320 746f 2072  for workers to r
+00034130: 6574 7572 6e2e 0a0a 2020 2020 2020 2020  eturn...        
+00034140: 576f 726b 6572 7320 7769 7468 6f75 7420  Workers without 
+00034150: 6e61 6e6e 6965 7320 6172 6520 7368 7574  nannies are shut
+00034160: 2064 6f77 6e2c 2068 6f70 696e 6720 616e   down, hoping an
+00034170: 2065 7874 6572 6e61 6c20 6465 706c 6f79   external deploy
+00034180: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
+00034190: 2020 2020 7769 6c6c 2072 6573 7461 7274      will restart
+000341a0: 2074 6865 6d2e 2054 6865 7265 666f 7265   them. Therefore
+000341b0: 2c20 6966 206e 6f74 2075 7369 6e67 206e  , if not using n
+000341c0: 616e 6e69 6573 2061 6e64 2079 6f75 7220  annies and your 
+000341d0: 6465 706c 6f79 6d65 6e74 2073 7973 7465  deployment syste
+000341e0: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
+000341f0: 6f74 2061 7574 6f6d 6174 6963 616c 6c79  ot automatically
+00034200: 2072 6573 7461 7274 2077 6f72 6b65 7273   restart workers
+00034210: 2c20 6060 7265 7374 6172 7460 6020 7769  , ``restart`` wi
+00034220: 6c6c 206a 7573 7420 7368 7574 2064 6f77  ll just shut dow
+00034230: 6e20 616c 6c0a 2020 2020 2020 2020 776f  n all.        wo
+00034240: 726b 6572 732c 2074 6865 6e20 7469 6d65  rkers, then time
+00034250: 206f 7574 210a 0a20 2020 2020 2020 2041   out!..        A
+00034260: 6674 6572 2060 6072 6573 7461 7274 6060  fter ``restart``
+00034270: 2c20 616c 6c20 636f 6e6e 6563 7465 6420  , all connected 
+00034280: 776f 726b 6572 7320 6172 6520 6e65 772c  workers are new,
+00034290: 2072 6567 6172 646c 6573 7320 6f66 2077   regardless of w
+000342a0: 6865 7468 6572 2060 6054 696d 656f 7574  hether ``Timeout
+000342b0: 4572 726f 7260 600a 2020 2020 2020 2020  Error``.        
+000342c0: 7761 7320 7261 6973 6564 2e20 416e 7920  was raised. Any 
+000342d0: 776f 726b 6572 7320 7468 6174 2066 6169  workers that fai
+000342e0: 6c65 6420 746f 2073 6875 7420 646f 776e  led to shut down
+000342f0: 2069 6e20 7469 6d65 2061 7265 2072 656d   in time are rem
+00034300: 6f76 6564 2c20 616e 640a 2020 2020 2020  oved, and.      
+00034310: 2020 6d61 7920 6f72 206d 6179 206e 6f74    may or may not
+00034320: 2073 6875 7420 646f 776e 206f 6e20 7468   shut down on th
+00034330: 6569 7220 6f77 6e20 696e 2074 6865 2066  eir own in the f
+00034340: 7574 7572 652e 0a0a 2020 2020 2020 2020  uture...        
+00034350: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+00034360: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+00034370: 2020 2020 2020 7469 6d65 6f75 743a 0a20        timeout:. 
+00034380: 2020 2020 2020 2020 2020 2048 6f77 206c             How l
+00034390: 6f6e 6720 746f 2077 6169 7420 666f 7220  ong to wait for 
+000343a0: 776f 726b 6572 7320 746f 2073 6875 7420  workers to shut 
+000343b0: 646f 776e 2061 6e64 2063 6f6d 6520 6261  down and come ba
+000343c0: 636b 2c20 6966 2060 6077 6169 745f 666f  ck, if ``wait_fo
+000343d0: 725f 776f 726b 6572 7360 600a 2020 2020  r_workers``.    
+000343e0: 2020 2020 2020 2020 6973 2054 7275 652c          is True,
+000343f0: 206f 7468 6572 7769 7365 206a 7573 7420   otherwise just 
+00034400: 686f 7720 6c6f 6e67 2074 6f20 7761 6974  how long to wait
+00034410: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
+00034420: 7368 7574 2064 6f77 6e2e 0a20 2020 2020  shut down..     
+00034430: 2020 2020 2020 2052 6169 7365 7320 6060         Raises ``
+00034440: 6173 796e 6369 6f2e 5469 6d65 6f75 7445  asyncio.TimeoutE
+00034450: 7272 6f72 6060 2069 6620 7468 6973 2069  rror`` if this i
+00034460: 7320 6578 6365 6564 6564 2e0a 2020 2020  s exceeded..    
+00034470: 2020 2020 7761 6974 5f66 6f72 5f77 6f72      wait_for_wor
+00034480: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+00034490: 2020 5768 6574 6865 7220 746f 2077 6169    Whether to wai
+000344a0: 7420 666f 7220 616c 6c20 776f 726b 6572  t for all worker
+000344b0: 7320 746f 2072 6563 6f6e 6e65 6374 2c20  s to reconnect, 
+000344c0: 6f72 206a 7573 7420 666f 7220 7468 656d  or just for them
+000344d0: 2074 6f20 7368 7574 2064 6f77 6e0a 2020   to shut down.  
+000344e0: 2020 2020 2020 2020 2020 2864 6566 6175            (defau
+000344f0: 6c74 2054 7275 6529 2e20 5573 6520 6060  lt True). Use ``
+00034500: 7265 7374 6172 7428 7761 6974 5f66 6f72  restart(wait_for
+00034510: 5f77 6f72 6b65 7273 3d46 616c 7365 2960  _workers=False)`
+00034520: 6020 636f 6d62 696e 6564 2077 6974 680a  ` combined with.
+00034530: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
+00034540: 683a 6043 6c69 656e 742e 7761 6974 5f66  h:`Client.wait_f
+00034550: 6f72 5f77 6f72 6b65 7273 6020 666f 7220  or_workers` for 
+00034560: 6772 616e 756c 6172 2063 6f6e 7472 6f6c  granular control
+00034570: 206f 7665 7220 686f 7720 6d61 6e79 2077   over how many w
+00034580: 6f72 6b65 7273 2074 6f0a 2020 2020 2020  orkers to.      
+00034590: 2020 2020 2020 7761 6974 2066 6f72 2e0a        wait for..
+000345a0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+000345b0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+000345c0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
+000345d0: 742e 7265 7374 6172 740a 2020 2020 2020  t.restart.      
+000345e0: 2020 436c 6965 6e74 2e72 6573 7461 7274    Client.restart
+000345f0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00034600: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
+00034610: 6d75 6c75 735f 6964 203d 2066 2272 6573  mulus_id = f"res
+00034620: 7461 7274 2d7b 7469 6d65 2829 7d22 0a0a  tart-{time()}"..
+00034630: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00034640: 6e66 6f28 2252 6573 7461 7274 696e 6720  nfo("Restarting 
+00034650: 776f 726b 6572 7320 616e 6420 7265 6c65  workers and rele
+00034660: 6173 696e 6720 616c 6c20 6b65 7973 2e22  asing all keys."
+00034670: 290a 2020 2020 2020 2020 666f 7220 6373  ).        for cs
+00034680: 2069 6e20 7365 6c66 2e63 6c69 656e 7473   in self.clients
+00034690: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+000346a0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+000346b0: 6e74 5f72 656c 6561 7365 735f 6b65 7973  nt_releases_keys
+000346c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000346d0: 2020 6b65 7973 3d5b 7473 2e6b 6579 2066    keys=[ts.key f
+000346e0: 6f72 2074 7320 696e 2063 732e 7761 6e74  or ts in cs.want
+000346f0: 735f 7768 6174 5d2c 0a20 2020 2020 2020  s_what],.       
+00034700: 2020 2020 2020 2020 2063 6c69 656e 743d           client=
+00034710: 6373 2e63 6c69 656e 745f 6b65 792c 0a20  cs.client_key,. 
+00034720: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00034730: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00034740: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00034750: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00034760: 656c 662e 5f63 6c65 6172 5f74 6173 6b5f  elf._clear_task_
+00034770: 7374 6174 6528 290a 2020 2020 2020 2020  state().        
+00034780: 6173 7365 7274 206e 6f74 2073 656c 662e  assert not self.
+00034790: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
+000347a0: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
+000347b0: 2022 7265 7374 6172 7422 7d29 0a0a 2020   "restart"})..  
+000347c0: 2020 2020 2020 666f 7220 706c 7567 696e        for plugin
+000347d0: 2069 6e20 6c69 7374 2873 656c 662e 706c   in list(self.pl
+000347e0: 7567 696e 732e 7661 6c75 6573 2829 293a  ugins.values()):
+000347f0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+00034800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034810: 2020 706c 7567 696e 2e72 6573 7461 7274    plugin.restart
+00034820: 2873 656c 6629 0a20 2020 2020 2020 2020  (self).         
+00034830: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00034840: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00034850: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00034860: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
+00034870: 2020 2020 2020 206e 5f77 6f72 6b65 7273         n_workers
+00034880: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
+00034890: 6572 7329 0a20 2020 2020 2020 206e 616e  ers).        nan
+000348a0: 6e79 5f77 6f72 6b65 7273 203d 207b 0a20  ny_workers = {. 
+000348b0: 2020 2020 2020 2020 2020 2061 6464 723a             addr:
+000348c0: 2077 732e 6e61 6e6e 7920 666f 7220 6164   ws.nanny for ad
+000348d0: 6472 2c20 7773 2069 6e20 7365 6c66 2e77  dr, ws in self.w
+000348e0: 6f72 6b65 7273 2e69 7465 6d73 2829 2069  orkers.items() i
+000348f0: 6620 7773 2e6e 616e 6e79 0a20 2020 2020  f ws.nanny.     
+00034900: 2020 207d 0a20 2020 2020 2020 2023 2043     }.        # C
+00034910: 6c6f 7365 206e 6f6e 2d4e 616e 6e79 2077  lose non-Nanny w
+00034920: 6f72 6b65 7273 2e20 5765 2068 6176 6520  orkers. We have 
+00034930: 6e6f 2077 6179 2074 6f20 7265 7374 6172  no way to restar
+00034940: 7420 7468 656d 2c20 736f 2077 6520 6a75  t them, so we ju
+00034950: 7374 206c 6574 2074 6865 6d20 676f 2c0a  st let them go,.
+00034960: 2020 2020 2020 2020 2320 616e 6420 6173          # and as
+00034970: 7375 6d65 2061 2064 6570 6c6f 796d 656e  sume a deploymen
+00034980: 7420 7379 7374 656d 2069 7320 676f 696e  t system is goin
+00034990: 6720 746f 2072 6573 7461 7274 2074 6865  g to restart the
+000349a0: 6d20 666f 7220 7573 2e0a 2020 2020 2020  m for us..      
+000349b0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+000349c0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+000349d0: 2020 2020 2a28 0a20 2020 2020 2020 2020      *(.         
+000349e0: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+000349f0: 7665 5f77 6f72 6b65 7228 6164 6472 6573  ve_worker(addres
+00034a00: 733d 6164 6472 2c20 7374 696d 756c 7573  s=addr, stimulus
+00034a10: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+00034a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034a30: 2066 6f72 2061 6464 7220 696e 2073 656c   for addr in sel
+00034a40: 662e 776f 726b 6572 730a 2020 2020 2020  f.workers.      
+00034a50: 2020 2020 2020 2020 2020 6966 2061 6464            if add
+00034a60: 7220 6e6f 7420 696e 206e 616e 6e79 5f77  r not in nanny_w
+00034a70: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+00034a80: 2020 2029 0a20 2020 2020 2020 2029 0a0a     ).        )..
+00034a90: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00034aa0: 6562 7567 2822 5365 6e64 206b 696c 6c20  ebug("Send kill 
+00034ab0: 7369 676e 616c 2074 6f20 6e61 6e6e 6965  signal to nannie
+00034ac0: 733a 2025 7322 2c20 6e61 6e6e 795f 776f  s: %s", nanny_wo
+00034ad0: 726b 6572 7329 0a20 2020 2020 2020 2061  rkers).        a
+00034ae0: 7379 6e63 2077 6974 6820 636f 6e74 6578  sync with contex
+00034af0: 746c 6962 2e41 7379 6e63 4578 6974 5374  tlib.AsyncExitSt
+00034b00: 6163 6b28 2920 6173 2073 7461 636b 3a0a  ack() as stack:.
+00034b10: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
+00034b20: 6965 7320 3d20 6177 6169 7420 6173 796e  ies = await asyn
+00034b30: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+00034b40: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
+00034b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034b60: 2020 2073 7461 636b 2e65 6e74 6572 5f61     stack.enter_a
+00034b70: 7379 6e63 5f63 6f6e 7465 7874 280a 2020  sync_context(.  
+00034b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034b90: 2020 2020 2020 7270 6328 6e61 6e6e 795f        rpc(nanny_
+00034ba0: 6164 6472 6573 732c 2063 6f6e 6e65 6374  address, connect
+00034bb0: 696f 6e5f 6172 6773 3d73 656c 662e 636f  ion_args=self.co
+00034bc0: 6e6e 6563 7469 6f6e 5f61 7267 7329 0a20  nnection_args). 
+00034bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034be0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00034bf0: 2020 2020 2020 2020 2066 6f72 206e 616e           for nan
+00034c00: 6e79 5f61 6464 7265 7373 2069 6e20 6e61  ny_address in na
+00034c10: 6e6e 795f 776f 726b 6572 732e 7661 6c75  nny_workers.valu
+00034c20: 6573 2829 0a20 2020 2020 2020 2020 2020  es().           
+00034c30: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00034c40: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
+00034c50: 2020 7374 6172 7420 3d20 6d6f 6e6f 746f    start = monoto
+00034c60: 6e69 6328 290a 2020 2020 2020 2020 2020  nic().          
+00034c70: 2020 7265 7370 7320 3d20 6177 6169 7420    resps = await 
+00034c80: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
+00034c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ca0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+00034cb0: 2020 2020 2020 2077 6169 745f 666f 7228         wait_for(
+00034cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034cd0: 2020 2020 2020 2020 2023 2046 4958 4d45           # FIXME
+00034ce0: 2064 6f65 7320 6e6f 7420 7261 6973 6520   does not raise 
+00034cf0: 6966 2074 6865 2070 726f 6365 7373 2066  if the process f
+00034d00: 6169 6c73 2074 6f20 7368 7574 2064 6f77  ails to shut dow
+00034d10: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+00034d20: 2020 2020 2020 2020 2020 2023 2073 6565             # see
+00034d30: 2068 7474 7073 3a2f 2f67 6974 6875 622e   https://github.
+00034d40: 636f 6d2f 6461 736b 2f64 6973 7472 6962  com/dask/distrib
+00034d50: 7574 6564 2f70 756c 6c2f 3634 3237 2f66  uted/pull/6427/f
+00034d60: 696c 6573 2372 3839 3439 3137 3432 340a  iles#r894917424.
+00034d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034d80: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
+00034d90: 4e61 6e6e 7920 7769 6c6c 2061 7574 6f6d  Nanny will autom
+00034da0: 6174 6963 616c 6c79 2072 6573 7461 7274  atically restart
+00034db0: 2077 6f72 6b65 7220 7072 6f63 6573 7320   worker process 
+00034dc0: 7768 656e 2069 7427 7320 6b69 6c6c 6564  when it's killed
+00034dd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034de0: 2020 2020 2020 2020 206e 616e 6e79 2e6b           nanny.k
+00034df0: 696c 6c28 0a20 2020 2020 2020 2020 2020  ill(.           
+00034e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e10: 2072 6561 736f 6e3d 2273 6368 6564 756c   reason="schedul
+00034e20: 6572 2d72 6573 7461 7274 222c 0a20 2020  er-restart",.   
+00034e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e40: 2020 2020 2020 2020 2074 696d 656f 7574           timeout
+00034e50: 3d74 696d 656f 7574 2c0a 2020 2020 2020  =timeout,.      
+00034e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034e70: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
+00034e80: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00034e90: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
+00034ea0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00034eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034ec0: 666f 7220 6e61 6e6e 7920 696e 206e 616e  for nanny in nan
+00034ed0: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
+00034ee0: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00034ef0: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+00034f00: 7863 6570 7469 6f6e 733d 5472 7565 2c0a  xceptions=True,.
+00034f10: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00034f20: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00034f30: 3a20 7468 6520 6057 6f72 6b65 7253 7461  : the `WorkerSta
+00034f40: 7465 6020 656e 7472 6965 7320 666f 7220  te` entries for 
+00034f50: 7468 6573 6520 776f 726b 6572 7320 7769  these workers wi
+00034f60: 6c6c 2062 6520 7265 6d6f 7665 640a 2020  ll be removed.  
+00034f70: 2020 2020 2020 2020 2020 2320 6e61 7475            # natu
+00034f80: 7261 6c6c 7920 7768 656e 2074 6865 7920  rally when they 
+00034f90: 6469 7363 6f6e 6e65 6374 2066 726f 6d20  disconnect from 
+00034fa0: 7468 6520 7363 6865 6475 6c65 722e 0a0a  the scheduler...
+00034fb0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00034fc0: 6d6f 7665 2061 6e79 2077 6f72 6b65 7273  move any workers
+00034fd0: 2074 6861 7420 6661 696c 6564 2074 6f20   that failed to 
+00034fe0: 7368 7574 2064 6f77 6e2c 2073 6f20 7765  shut down, so we
+00034ff0: 2063 616e 2067 7561 7261 6e74 6565 0a20   can guarantee. 
+00035000: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
+00035010: 7420 6166 7465 7220 6072 6573 7461 7274  t after `restart
+00035020: 602c 2074 6865 7265 2061 7265 206e 6f20  `, there are no 
+00035030: 6f6c 6420 776f 726b 6572 7320 6172 6f75  old workers arou
+00035040: 6e64 2e0a 2020 2020 2020 2020 2020 2020  nd..            
+00035050: 6261 645f 6e61 6e6e 6965 7320 3d20 5b0a  bad_nannies = [.
+00035060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035070: 6164 6472 2066 6f72 2061 6464 722c 2072  addr for addr, r
+00035080: 6573 7020 696e 207a 6970 286e 616e 6e79  esp in zip(nanny
+00035090: 5f77 6f72 6b65 7273 2c20 7265 7370 7329  _workers, resps)
+000350a0: 2069 6620 7265 7370 2069 7320 6e6f 7420   if resp is not 
+000350b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+000350c0: 205d 0a20 2020 2020 2020 2020 2020 2069   ].            i
+000350d0: 6620 6261 645f 6e61 6e6e 6965 733a 0a20  f bad_nannies:. 
+000350e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000350f0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+00035100: 6865 7228 0a20 2020 2020 2020 2020 2020  her(.           
+00035110: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
+00035120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035130: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+00035140: 776f 726b 6572 2861 6464 722c 2073 7469  worker(addr, sti
+00035150: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00035160: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
+00035170: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00035180: 7220 6164 6472 2069 6e20 6261 645f 6e61  r addr in bad_na
+00035190: 6e6e 6965 730a 2020 2020 2020 2020 2020  nnies.          
+000351a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000351b0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000351c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000351d0: 6169 7365 2054 696d 656f 7574 4572 726f  aise TimeoutErro
+000351e0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000351f0: 2020 2020 2020 2066 227b 6c65 6e28 6261         f"{len(ba
+00035200: 645f 6e61 6e6e 6965 7329 7d2f 7b6c 656e  d_nannies)}/{len
+00035210: 286e 616e 6e69 6573 297d 206e 616e 6e79  (nannies)} nanny
+00035220: 2077 6f72 6b65 7228 7329 2064 6964 206e   worker(s) did n
+00035230: 6f74 2073 6875 7420 646f 776e 2077 6974  ot shut down wit
+00035240: 6869 6e20 7b74 696d 656f 7574 7d73 220a  hin {timeout}s".
+00035250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035260: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00035270: 6c6f 675f 6576 656e 7428 5b63 6c69 656e  log_event([clien
+00035280: 742c 2022 616c 6c22 5d2c 207b 2261 6374  t, "all"], {"act
+00035290: 696f 6e22 3a20 2272 6573 7461 7274 222c  ion": "restart",
+000352a0: 2022 636c 6965 6e74 223a 2063 6c69 656e   "client": clien
+000352b0: 747d 290a 0a20 2020 2020 2020 2069 6620  t})..        if 
+000352c0: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
+000352d0: 3a0a 2020 2020 2020 2020 2020 2020 7768  :.            wh
+000352e0: 696c 6520 6c65 6e28 7365 6c66 2e77 6f72  ile len(self.wor
+000352f0: 6b65 7273 2920 3c20 6e5f 776f 726b 6572  kers) < n_worker
+00035300: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00035310: 2020 2023 204e 4f54 453a 2069 6620 6e65     # NOTE: if ne
+00035320: 7720 2875 6e72 656c 6174 6564 2920 776f  w (unrelated) wo
+00035330: 726b 6572 7320 6a6f 696e 2077 6869 6c65  rkers join while
+00035340: 2077 6527 7265 2077 6169 7469 6e67 2c20   we're waiting, 
+00035350: 7765 206d 6179 2072 6574 7572 6e20 6265  we may return be
+00035360: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
+00035370: 2020 2020 2023 206f 7572 2073 6875 742d       # our shut-
+00035380: 646f 776e 2077 6f72 6b65 7273 2068 6176  down workers hav
+00035390: 6520 636f 6d65 2062 6163 6b20 7570 2e20  e come back up. 
+000353a0: 5468 6174 2773 2066 696e 653b 2077 6f72  That's fine; wor
+000353b0: 6b65 7273 2061 7265 2069 6e74 6572 6368  kers are interch
+000353c0: 616e 6765 6162 6c65 2e0a 2020 2020 2020  angeable..      
+000353d0: 2020 2020 2020 2020 2020 6966 206d 6f6e            if mon
+000353e0: 6f74 6f6e 6963 2829 203c 2073 7461 7274  otonic() < start
+000353f0: 202b 2074 696d 656f 7574 3a0a 2020 2020   + timeout:.    
+00035400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035410: 6177 6169 7420 6173 796e 6369 6f2e 736c  await asyncio.sl
+00035420: 6565 7028 302e 3229 0a20 2020 2020 2020  eep(0.2).       
+00035430: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00035440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035450: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
+00035460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035470: 2020 2066 2257 6169 7465 6420 666f 7220     f"Waited for 
+00035480: 7b6e 5f77 6f72 6b65 7273 7d20 776f 726b  {n_workers} work
+00035490: 6572 2873 2920 746f 2072 6563 6f6e 6e65  er(s) to reconne
+000354a0: 6374 2061 6674 6572 2072 6573 7461 7274  ct after restart
+000354b0: 696e 672c 2022 0a20 2020 2020 2020 2020  ing, ".         
+000354c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000354d0: 2262 7574 2061 6674 6572 207b 7469 6d65  "but after {time
+000354e0: 6f75 747d 732c 206f 6e6c 7920 7b6c 656e  out}s, only {len
+000354f0: 2873 656c 662e 776f 726b 6572 7329 7d20  (self.workers)} 
+00035500: 6861 7665 2072 6574 7572 6e65 642e 2022  have returned. "
+00035510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035520: 2020 2020 2020 2020 2022 436f 6e73 6964           "Consid
+00035530: 6572 2061 206c 6f6e 6765 7220 7469 6d65  er a longer time
+00035540: 6f75 742c 206f 7220 6077 6169 745f 666f  out, or `wait_fo
+00035550: 725f 776f 726b 6572 733d 4661 6c73 6560  r_workers=False`
+00035560: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00035570: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00035580: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00035590: 2028 6e5f 6e61 6e6e 7920 3a3d 206c 656e   (n_nanny := len
+000355a0: 286e 616e 6e79 5f77 6f72 6b65 7273 2929  (nanny_workers))
+000355b0: 203c 206e 5f77 6f72 6b65 7273 3a0a 2020   < n_workers:.  
+000355c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355d0: 2020 2020 2020 6d73 6720 2b3d 2028 0a20        msg += (. 
+000355e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355f0: 2020 2020 2020 2020 2020 2066 2220 5468             f" Th
+00035600: 6520 7b6e 5f77 6f72 6b65 7273 202d 206e  e {n_workers - n
+00035610: 5f6e 616e 6e79 7d20 776f 726b 6572 2873  _nanny} worker(s
+00035620: 2920 6e6f 7420 7573 696e 6720 4e61 6e6e  ) not using Nann
+00035630: 6965 7320 7765 7265 206a 7573 7420 7368  ies were just sh
+00035640: 7574 2022 0a20 2020 2020 2020 2020 2020  ut ".           
+00035650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035660: 2022 646f 776e 2069 6e73 7465 6164 206f   "down instead o
+00035670: 6620 7265 7374 6172 7465 6420 2872 6573  f restarted (res
+00035680: 7461 7274 2069 7320 6f6e 6c79 2070 6f73  tart is only pos
+00035690: 7369 626c 6520 7769 7468 204e 616e 6e69  sible with Nanni
+000356a0: 6573 292e 2049 6620 220a 2020 2020 2020  es). If ".      
+000356b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000356c0: 2020 2020 2020 2279 6f75 7220 6465 706c        "your depl
+000356d0: 6f79 6d65 6e74 2073 7973 7465 6d20 646f  oyment system do
+000356e0: 6573 206e 6f74 2061 7574 6f6d 6174 6963  es not automatic
+000356f0: 616c 6c79 2072 652d 6c61 756e 6368 2074  ally re-launch t
+00035700: 6572 6d69 6e61 7465 6420 220a 2020 2020  erminated ".    
+00035710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035720: 2020 2020 2020 2020 2270 726f 6365 7373          "process
+00035730: 6573 2c20 7468 656e 2074 686f 7365 2077  es, then those w
+00035740: 6f72 6b65 7273 2077 696c 6c20 6e65 7665  orkers will neve
+00035750: 7220 636f 6d65 2062 6163 6b2c 2061 6e64  r come back, and
+00035760: 2060 436c 6965 6e74 2e72 6573 7461 7274   `Client.restart
+00035770: 6020 220a 2020 2020 2020 2020 2020 2020  ` ".            
+00035780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035790: 2277 696c 6c20 616c 7761 7973 2074 696d  "will always tim
+000357a0: 6520 6f75 742e 2044 6f20 6e6f 7420 7573  e out. Do not us
+000357b0: 6520 6043 6c69 656e 742e 7265 7374 6172  e `Client.restar
+000357c0: 7460 2069 6e20 7468 6174 2063 6173 652e  t` in that case.
+000357d0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000357e0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000357f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035800: 7261 6973 6520 5469 6d65 6f75 7445 7272  raise TimeoutErr
+00035810: 6f72 286d 7367 2920 6672 6f6d 204e 6f6e  or(msg) from Non
+00035820: 650a 2020 2020 2020 2020 6c6f 6767 6572  e.        logger
+00035830: 2e69 6e66 6f28 2252 6573 7461 7274 696e  .info("Restartin
+00035840: 6720 6669 6e69 7368 6564 2e22 290a 0a20  g finished.").. 
+00035850: 2020 2061 7379 6e63 2064 6566 2062 726f     async def bro
+00035860: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
+00035870: 7365 6c66 2c0a 2020 2020 2020 2020 2a2c  self,.        *,
+00035880: 0a20 2020 2020 2020 206d 7367 3a20 6469  .        msg: di
+00035890: 6374 2c0a 2020 2020 2020 2020 776f 726b  ct,.        work
+000358a0: 6572 733a 206c 6973 745b 7374 725d 207c  ers: list[str] |
+000358b0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+000358c0: 2020 2020 2020 686f 7374 733a 206c 6973        hosts: lis
+000358d0: 745b 7374 725d 207c 204e 6f6e 6520 3d20  t[str] | None = 
+000358e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e61  None,.        na
+000358f0: 6e6e 793a 2062 6f6f 6c20 3d20 4661 6c73  nny: bool = Fals
+00035900: 652c 0a20 2020 2020 2020 2073 6572 6961  e,.        seria
+00035910: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
+00035920: 6e65 2c0a 2020 2020 2020 2020 6f6e 5f65  ne,.        on_e
+00035930: 7272 6f72 3a20 224c 6974 6572 616c 5b27  rror: "Literal['
+00035940: 7261 6973 6527 2c20 2772 6574 7572 6e27  raise', 'return'
+00035950: 2c20 2772 6574 7572 6e5f 7069 636b 6c65  , 'return_pickle
+00035960: 272c 2027 6967 6e6f 7265 275d 2220 3d20  ', 'ignore']" = 
+00035970: 2272 6169 7365 222c 0a20 2020 2029 202d  "raise",.    ) -
+00035980: 3e20 6469 6374 3a20 2023 2064 6963 745b  > dict:  # dict[
+00035990: 7374 722c 2041 6e79 5d0a 2020 2020 2020  str, Any].      
+000359a0: 2020 2222 2242 726f 6164 6361 7374 206d    """Broadcast m
+000359b0: 6573 7361 6765 2074 6f20 776f 726b 6572  essage to worker
+000359c0: 732c 2072 6574 7572 6e20 616c 6c20 7265  s, return all re
+000359d0: 7375 6c74 7322 2222 0a20 2020 2020 2020  sults""".       
+000359e0: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
+000359f0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00035a00: 2069 6620 686f 7374 7320 6973 204e 6f6e   if hosts is Non
+00035a10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00035a20: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
+00035a30: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
+00035a40: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00035a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035a60: 2020 776f 726b 6572 7320 3d20 5b5d 0a20    workers = []. 
+00035a70: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
+00035a80: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00035a90: 2020 2020 2020 2020 2066 6f72 2068 6f73           for hos
+00035aa0: 7420 696e 2068 6f73 7473 3a0a 2020 2020  t in hosts:.    
+00035ab0: 2020 2020 2020 2020 2020 2020 6468 3a20              dh: 
+00035ac0: 6469 6374 203d 2073 656c 662e 686f 7374  dict = self.host
+00035ad0: 5f69 6e66 6f2e 6765 7428 686f 7374 2920  _info.get(host) 
+00035ae0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+00035af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b00: 6966 2064 6820 6973 206e 6f74 204e 6f6e  if dh is not Non
+00035b10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00035b20: 2020 2020 2020 2077 6f72 6b65 7273 2e65         workers.e
+00035b30: 7874 656e 6428 6468 5b22 6164 6472 6573  xtend(dh["addres
+00035b40: 7365 7322 5d29 0a20 2020 2020 2020 2023  ses"]).        #
+00035b50: 2054 4f44 4f20 7265 706c 6163 6520 7769   TODO replace wi
+00035b60: 7468 2077 6f72 6b65 725f 6c69 7374 0a0a  th worker_list..
+00035b70: 2020 2020 2020 2020 6966 206e 616e 6e79          if nanny
+00035b80: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
+00035b90: 6472 6573 7365 7320 3d20 5b73 656c 662e  dresses = [self.
+00035ba0: 776f 726b 6572 735b 775d 2e6e 616e 6e79  workers[w].nanny
+00035bb0: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+00035bc0: 735d 0a20 2020 2020 2020 2065 6c73 653a  s].        else:
+00035bd0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
+00035be0: 7265 7373 6573 203d 2077 6f72 6b65 7273  resses = workers
+00035bf0: 0a0a 2020 2020 2020 2020 4552 524f 5220  ..        ERROR 
+00035c00: 3d20 6f62 6a65 6374 2829 0a0a 2020 2020  = object()..    
+00035c10: 2020 2020 6173 796e 6320 6465 6620 7365      async def se
+00035c20: 6e64 5f6d 6573 7361 6765 2861 6464 7229  nd_message(addr)
+00035c30: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00035c40: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00035c50: 2020 2063 6f6d 6d20 3d20 6177 6169 7420     comm = await 
+00035c60: 7365 6c66 2e72 7063 2e63 6f6e 6e65 6374  self.rpc.connect
+00035c70: 2861 6464 7229 0a20 2020 2020 2020 2020  (addr).         
+00035c80: 2020 2020 2020 2063 6f6d 6d2e 6e61 6d65         comm.name
+00035c90: 203d 2022 5363 6865 6475 6c65 7220 4272   = "Scheduler Br
+00035ca0: 6f61 6463 6173 7422 0a20 2020 2020 2020  oadcast".       
+00035cb0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00035cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035cd0: 2020 7265 7370 203d 2061 7761 6974 2073    resp = await s
+00035ce0: 656e 645f 7265 6376 280a 2020 2020 2020  end_recv(.      
+00035cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d00: 2020 636f 6d6d 2c20 636c 6f73 653d 5472    comm, close=Tr
+00035d10: 7565 2c20 7365 7269 616c 697a 6572 733d  ue, serializers=
+00035d20: 7365 7269 616c 697a 6572 732c 202a 2a6d  serializers, **m
+00035d30: 7367 0a20 2020 2020 2020 2020 2020 2020  sg.             
+00035d40: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00035d50: 2020 2020 2020 2020 2066 696e 616c 6c79           finally
+00035d60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035d70: 2020 2020 2020 7365 6c66 2e72 7063 2e72        self.rpc.r
+00035d80: 6575 7365 2861 6464 722c 2063 6f6d 6d29  euse(addr, comm)
+00035d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035da0: 2072 6574 7572 6e20 7265 7370 0a20 2020   return resp.   
+00035db0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00035dc0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00035dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035de0: 6c6f 6767 6572 2e65 7272 6f72 2866 2262  logger.error(f"b
+00035df0: 726f 6164 6361 7374 2074 6f20 7b61 6464  roadcast to {add
+00035e00: 727d 2066 6169 6c65 643a 207b 652e 5f5f  r} failed: {e.__
+00035e10: 636c 6173 735f 5f2e 5f5f 6e61 6d65 5f5f  class__.__name__
+00035e20: 7d3a 207b 657d 2229 0a20 2020 2020 2020  }: {e}").       
+00035e30: 2020 2020 2020 2020 2069 6620 6f6e 5f65           if on_e
+00035e40: 7272 6f72 203d 3d20 2272 6169 7365 223a  rror == "raise":
+00035e50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035e60: 2020 2020 2072 6169 7365 0a20 2020 2020       raise.     
+00035e70: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00035e80: 6f6e 5f65 7272 6f72 203d 3d20 2272 6574  on_error == "ret
+00035e90: 7572 6e22 3a0a 2020 2020 2020 2020 2020  urn":.          
+00035ea0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00035eb0: 2065 0a20 2020 2020 2020 2020 2020 2020   e.             
+00035ec0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
+00035ed0: 203d 3d20 2272 6574 7572 6e5f 7069 636b   == "return_pick
+00035ee0: 6c65 223a 0a20 2020 2020 2020 2020 2020  le":.           
+00035ef0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00035f00: 6475 6d70 7328 6529 0a20 2020 2020 2020  dumps(e).       
+00035f10: 2020 2020 2020 2020 2065 6c69 6620 6f6e           elif on
+00035f20: 5f65 7272 6f72 203d 3d20 2269 676e 6f72  _error == "ignor
+00035f30: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00035f40: 2020 2020 2020 2020 7265 7475 726e 2045          return E
+00035f50: 5252 4f52 0a20 2020 2020 2020 2020 2020  RROR.           
+00035f60: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00035f70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00035f80: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00035f90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035fa0: 2020 2020 2020 2020 2022 6f6e 5f65 7272           "on_err
+00035fb0: 6f72 206d 7573 7420 6265 2027 7261 6973  or must be 'rais
+00035fc0: 6527 2c20 2772 6574 7572 6e27 2c20 2772  e', 'return', 'r
+00035fd0: 6574 7572 6e5f 7069 636b 6c65 272c 2022  eturn_pickle', "
+00035fe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035ff0: 2020 2020 2020 2020 2066 226f 7220 2769           f"or 'i
+00036000: 676e 6f72 6527 3b20 676f 7420 7b6f 6e5f  gnore'; got {on_
+00036010: 6572 726f 7221 727d 220a 2020 2020 2020  error!r}".      
+00036020: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00036030: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
+00036040: 203d 2061 7761 6974 2041 6c6c 280a 2020   = await All(.  
+00036050: 2020 2020 2020 2020 2020 5b73 656e 645f            [send_
+00036060: 6d65 7373 6167 6528 6164 6472 6573 7329  message(address)
+00036070: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
+00036080: 6164 6472 6573 7365 7320 6966 2061 6464  addresses if add
+00036090: 7265 7373 2069 7320 6e6f 7420 4e6f 6e65  ress is not None
+000360a0: 5d0a 2020 2020 2020 2020 290a 0a20 2020  ].        )..   
+000360b0: 2020 2020 2072 6574 7572 6e20 7b6b 3a20       return {k: 
+000360c0: 7620 666f 7220 6b2c 2076 2069 6e20 7a69  v for k, v in zi
+000360d0: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
+000360e0: 7473 2920 6966 2076 2069 7320 6e6f 7420  ts) if v is not 
+000360f0: 4552 524f 527d 0a0a 2020 2020 6173 796e  ERROR}..    asyn
+00036100: 6320 6465 6620 7072 6f78 7928 0a20 2020  c def proxy(.   
+00036110: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00036120: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
+00036130: 2020 2020 2020 776f 726b 6572 3a20 7374        worker: st
+00036140: 722c 0a20 2020 2020 2020 2073 6572 6961  r,.        seria
+00036150: 6c69 7a65 7273 3a20 416e 7920 3d20 4e6f  lizers: Any = No
+00036160: 6e65 2c0a 2020 2020 2920 2d3e 2041 6e79  ne,.    ) -> Any
+00036170: 3a0a 2020 2020 2020 2020 2222 2250 726f  :.        """Pro
+00036180: 7879 2061 2063 6f6d 6d75 6e69 6361 7469  xy a communicati
+00036190: 6f6e 2074 6872 6f75 6768 2074 6865 2073  on through the s
+000361a0: 6368 6564 756c 6572 2074 6f20 736f 6d65  cheduler to some
+000361b0: 206f 7468 6572 2077 6f72 6b65 7222 2222   other worker"""
+000361c0: 0a20 2020 2020 2020 2064 203d 2061 7761  .        d = awa
+000361d0: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+000361e0: 7428 6d73 673d 6d73 672c 2077 6f72 6b65  t(msg=msg, worke
+000361f0: 7273 3d5b 776f 726b 6572 5d2c 2073 6572  rs=[worker], ser
+00036200: 6961 6c69 7a65 7273 3d73 6572 6961 6c69  ializers=seriali
+00036210: 7a65 7273 290a 2020 2020 2020 2020 7265  zers).        re
+00036220: 7475 726e 2064 5b77 6f72 6b65 725d 0a0a  turn d[worker]..
+00036230: 2020 2020 6173 796e 6320 6465 6620 6761      async def ga
+00036240: 7468 6572 5f6f 6e5f 776f 726b 6572 280a  ther_on_worker(.
+00036250: 2020 2020 2020 2020 7365 6c66 2c20 776f          self, wo
+00036260: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
+00036270: 722c 2077 686f 5f68 6173 3a20 2264 6963  r, who_has: "dic
+00036280: 745b 7374 722c 206c 6973 745b 7374 725d  t[str, list[str]
+00036290: 5d22 0a20 2020 2029 202d 3e20 7365 743a  ]".    ) -> set:
+000362a0: 0a20 2020 2020 2020 2022 2222 5065 6572  .        """Peer
+000362b0: 2d74 6f2d 7065 6572 2063 6f70 7920 6f66  -to-peer copy of
+000362c0: 206b 6579 7320 6672 6f6d 206d 756c 7469   keys from multi
+000362d0: 706c 6520 776f 726b 6572 7320 746f 2061  ple workers to a
+000362e0: 2073 696e 676c 6520 776f 726b 6572 0a0a   single worker..
+000362f0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+00036300: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+00036310: 2d2d 2d2d 2d0a 2020 2020 2020 2020 776f  -----.        wo
+00036320: 726b 6572 5f61 6464 7265 7373 3a20 7374  rker_address: st
+00036330: 720a 2020 2020 2020 2020 2020 2020 5265  r.            Re
+00036340: 6369 7069 656e 7420 776f 726b 6572 2061  cipient worker a
+00036350: 6464 7265 7373 2074 6f20 636f 7079 206b  ddress to copy k
+00036360: 6579 7320 746f 0a20 2020 2020 2020 2077  eys to.        w
+00036370: 686f 5f68 6173 3a20 6469 6374 5b48 6173  ho_has: dict[Has
+00036380: 6861 626c 652c 206c 6973 745b 7374 725d  hable, list[str]
+00036390: 5d0a 2020 2020 2020 2020 2020 2020 7b6b  ].            {k
+000363a0: 6579 3a20 5b73 656e 6465 7220 6164 6472  ey: [sender addr
+000363b0: 6573 732c 2073 656e 6465 7220 6164 6472  ess, sender addr
+000363c0: 6573 732c 202e 2e2e 5d2c 206b 6579 3a20  ess, ...], key: 
+000363d0: 2e2e 2e7d 0a0a 2020 2020 2020 2020 5265  ...}..        Re
+000363e0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
+000363f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 7265  -----.        re
+00036400: 7475 726e 733a 0a20 2020 2020 2020 2020  turns:.         
+00036410: 2020 2073 6574 206f 6620 6b65 7973 2074     set of keys t
+00036420: 6861 7420 6661 696c 6564 2074 6f20 6265  hat failed to be
+00036430: 2063 6f70 6965 640a 2020 2020 2020 2020   copied.        
+00036440: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+00036450: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00036460: 756c 7420 3d20 6177 6169 7420 7265 7472  ult = await retr
+00036470: 795f 6f70 6572 6174 696f 6e28 0a20 2020  y_operation(.   
+00036480: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00036490: 662e 7270 6328 6164 6472 3d77 6f72 6b65  f.rpc(addr=worke
+000364a0: 725f 6164 6472 6573 7329 2e67 6174 6865  r_address).gathe
+000364b0: 722c 2077 686f 5f68 6173 3d77 686f 5f68  r, who_has=who_h
+000364c0: 6173 0a20 2020 2020 2020 2020 2020 2029  as.            )
+000364d0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000364e0: 4f53 4572 726f 7220 6173 2065 3a0a 2020  OSError as e:.  
+000364f0: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+00036500: 2063 616e 2068 6170 7065 6e20 652e 672e   can happen e.g.
+00036510: 2069 6620 7468 6520 776f 726b 6572 2069   if the worker i
+00036520: 7320 676f 696e 6720 7468 726f 7567 6820  s going through 
+00036530: 636f 6e74 726f 6c6c 6564 2073 6875 7464  controlled shutd
+00036540: 6f77 6e3b 0a20 2020 2020 2020 2020 2020  own;.           
+00036550: 2023 2069 7420 646f 6573 6e27 7420 6e65   # it doesn't ne
+00036560: 6365 7373 6172 696c 7920 6d65 616e 2074  cessarily mean t
+00036570: 6861 7420 6974 2077 656e 7420 756e 6578  hat it went unex
+00036580: 7065 6374 6564 6c79 206d 6973 7369 6e67  pectedly missing
+00036590: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+000365a0: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+000365b0: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
+000365c0: 6f6d 6d75 6e69 6361 7469 6f6e 2077 6974  ommunication wit
+000365d0: 6820 776f 726b 6572 207b 776f 726b 6572  h worker {worker
+000365e0: 5f61 6464 7265 7373 7d20 6661 696c 6564  _address} failed
+000365f0: 2064 7572 696e 6720 220a 2020 2020 2020   during ".      
+00036600: 2020 2020 2020 2020 2020 6622 7265 706c            f"repl
+00036610: 6963 6174 696f 6e3a 207b 652e 5f5f 636c  ication: {e.__cl
+00036620: 6173 735f 5f2e 5f5f 6e61 6d65 5f5f 7d3a  ass__.__name__}:
+00036630: 207b 657d 220a 2020 2020 2020 2020 2020   {e}".          
+00036640: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00036650: 7265 7475 726e 2073 6574 2877 686f 5f68  return set(who_h
+00036660: 6173 290a 0a20 2020 2020 2020 2077 7320  as)..        ws 
+00036670: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e67  = self.workers.g
+00036680: 6574 2877 6f72 6b65 725f 6164 6472 6573  et(worker_addres
+00036690: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
+000366a0: 6f74 2077 733a 0a20 2020 2020 2020 2020  ot ws:.         
+000366b0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+000366c0: 6728 6622 576f 726b 6572 207b 776f 726b  g(f"Worker {work
+000366d0: 6572 5f61 6464 7265 7373 7d20 6c6f 7374  er_address} lost
+000366e0: 2064 7572 696e 6720 7265 706c 6963 6174   during replicat
+000366f0: 696f 6e22 290a 2020 2020 2020 2020 2020  ion").          
+00036700: 2020 7265 7475 726e 2073 6574 2877 686f    return set(who
+00036710: 5f68 6173 290a 2020 2020 2020 2020 656c  _has).        el
+00036720: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
+00036730: 7322 5d20 3d3d 2022 4f4b 223a 0a20 2020  s"] == "OK":.   
+00036740: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
+00036750: 696c 6564 203d 2073 6574 2829 0a20 2020  iled = set().   
+00036760: 2020 2020 2020 2020 206b 6579 735f 6f6b           keys_ok
+00036770: 3a20 5365 7420 3d20 7768 6f5f 6861 732e  : Set = who_has.
+00036780: 6b65 7973 2829 0a20 2020 2020 2020 2065  keys().        e
+00036790: 6c69 6620 7265 7375 6c74 5b22 7374 6174  lif result["stat
+000367a0: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
+000367b0: 2d66 6169 6c22 3a0a 2020 2020 2020 2020  -fail":.        
+000367c0: 2020 2020 6b65 7973 5f66 6169 6c65 6420      keys_failed 
+000367d0: 3d20 7365 7428 7265 7375 6c74 5b22 6b65  = set(result["ke
+000367e0: 7973 225d 290a 2020 2020 2020 2020 2020  ys"]).          
+000367f0: 2020 6b65 7973 5f6f 6b20 3d20 7768 6f5f    keys_ok = who_
+00036800: 6861 732e 6b65 7973 2829 202d 206b 6579  has.keys() - key
+00036810: 735f 6661 696c 6564 0a20 2020 2020 2020  s_failed.       
+00036820: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00036830: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00036840: 2020 2020 2066 2257 6f72 6b65 7220 7b77       f"Worker {w
+00036850: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
+00036860: 6169 6c65 6420 746f 2061 6371 7569 7265  ailed to acquire
+00036870: 206b 6579 733a 207b 7265 7375 6c74 5b27   keys: {result['
+00036880: 6b65 7973 275d 7d22 0a20 2020 2020 2020  keys']}".       
+00036890: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+000368a0: 6c73 653a 2020 2320 7072 6167 6d61 3a20  lse:  # pragma: 
+000368b0: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
+000368c0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000368d0: 7272 6f72 2866 2255 6e65 7870 6563 7465  rror(f"Unexpecte
+000368e0: 6420 6d65 7373 6167 6520 6672 6f6d 207b  d message from {
+000368f0: 776f 726b 6572 5f61 6464 7265 7373 7d3a  worker_address}:
+00036900: 207b 7265 7375 6c74 7d22 290a 0a20 2020   {result}")..   
+00036910: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
+00036920: 6b65 7973 5f6f 6b3a 0a20 2020 2020 2020  keys_ok:.       
+00036930: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
+00036940: 7465 203d 2073 656c 662e 7461 736b 732e  te = self.tasks.
+00036950: 6765 7428 6b65 7929 2020 2320 7479 7065  get(key)  # type
+00036960: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+00036970: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
+00036980: 6e65 206f 7220 7473 2e73 7461 7465 2021  ne or ts.state !
+00036990: 3d20 226d 656d 6f72 7922 3a0a 2020 2020  = "memory":.    
+000369a0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000369b0: 6572 2e77 6172 6e69 6e67 2866 224b 6579  er.warning(f"Key
+000369c0: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
+000369d0: 6c69 6361 7469 6f6e 3a20 7b6b 6579 7d22  lication: {key}"
+000369e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000369f0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00036a00: 2020 2020 2020 2069 6620 7773 206e 6f74         if ws not
+00036a10: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
+00036a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036a30: 7365 6c66 2e61 6464 5f72 6570 6c69 6361  self.add_replica
+00036a40: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
+00036a50: 2020 7265 7475 726e 206b 6579 735f 6661    return keys_fa
+00036a60: 696c 6564 0a0a 2020 2020 6173 796e 6320  iled..    async 
+00036a70: 6465 6620 6465 6c65 7465 5f77 6f72 6b65  def delete_worke
+00036a80: 725f 6461 7461 280a 2020 2020 2020 2020  r_data(.        
+00036a90: 7365 6c66 2c20 776f 726b 6572 5f61 6464  self, worker_add
+00036aa0: 7265 7373 3a20 7374 722c 206b 6579 733a  ress: str, keys:
+00036ab0: 2022 436f 6c6c 6563 7469 6f6e 5b73 7472   "Collection[str
+00036ac0: 5d22 2c20 7374 696d 756c 7573 5f69 643a  ]", stimulus_id:
+00036ad0: 2073 7472 0a20 2020 2029 202d 3e20 4e6f   str.    ) -> No
+00036ae0: 6e65 3a0a 2020 2020 2020 2020 2222 2244  ne:.        """D
+00036af0: 656c 6574 6520 6461 7461 2066 726f 6d20  elete data from 
+00036b00: 6120 776f 726b 6572 2061 6e64 2075 7064  a worker and upd
+00036b10: 6174 6520 7468 6520 636f 7272 6573 706f  ate the correspo
+00036b20: 6e64 696e 6720 776f 726b 6572 2f74 6173  nding worker/tas
+00036b30: 6b20 7374 6174 6573 0a0a 2020 2020 2020  k states..      
+00036b40: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00036b50: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+00036b60: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
+00036b70: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
+00036b80: 2020 2020 2020 2020 576f 726b 6572 2061          Worker a
+00036b90: 6464 7265 7373 2074 6f20 6465 6c65 7465  ddress to delete
+00036ba0: 206b 6579 7320 6672 6f6d 0a20 2020 2020   keys from.     
+00036bb0: 2020 206b 6579 733a 206c 6973 745b 7374     keys: list[st
+00036bc0: 725d 0a20 2020 2020 2020 2020 2020 204c  r].            L
+00036bd0: 6973 7420 6f66 206b 6579 7320 746f 2064  ist of keys to d
+00036be0: 656c 6574 6520 6f6e 2074 6865 2073 7065  elete on the spe
+00036bf0: 6369 6669 6564 2077 6f72 6b65 720a 2020  cified worker.  
+00036c00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00036c10: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00036c20: 2020 2061 7761 6974 2072 6574 7279 5f6f     await retry_o
+00036c30: 7065 7261 7469 6f6e 280a 2020 2020 2020  peration(.      
+00036c40: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00036c50: 7063 2861 6464 723d 776f 726b 6572 5f61  pc(addr=worker_a
+00036c60: 6464 7265 7373 292e 6672 6565 5f6b 6579  ddress).free_key
+00036c70: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00036c80: 2020 206b 6579 733d 6c69 7374 286b 6579     keys=list(key
+00036c90: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00036ca0: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
+00036cb0: 6622 6465 6c65 7465 2d64 6174 612d 7b74  f"delete-data-{t
+00036cc0: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
+00036cd0: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00036ce0: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+00036cf0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+00036d00: 2320 5468 6973 2063 616e 2068 6170 7065  # This can happe
+00036d10: 6e20 652e 672e 2069 6620 7468 6520 776f  n e.g. if the wo
+00036d20: 726b 6572 2069 7320 676f 696e 6720 7468  rker is going th
+00036d30: 726f 7567 6820 636f 6e74 726f 6c6c 6564  rough controlled
+00036d40: 2073 6875 7464 6f77 6e3b 0a20 2020 2020   shutdown;.     
+00036d50: 2020 2020 2020 2023 2069 7420 646f 6573         # it does
+00036d60: 6e27 7420 6e65 6365 7373 6172 696c 7920  n't necessarily 
+00036d70: 6d65 616e 2074 6861 7420 6974 2077 656e  mean that it wen
+00036d80: 7420 756e 6578 7065 6374 6564 6c79 206d  t unexpectedly m
+00036d90: 6973 7369 6e67 0a20 2020 2020 2020 2020  issing.         
+00036da0: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00036db0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00036dc0: 2020 2066 2243 6f6d 6d75 6e69 6361 7469     f"Communicati
+00036dd0: 6f6e 2077 6974 6820 776f 726b 6572 207b  on with worker {
+00036de0: 776f 726b 6572 5f61 6464 7265 7373 7d20  worker_address} 
+00036df0: 6661 696c 6564 2064 7572 696e 6720 220a  failed during ".
+00036e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036e10: 6622 7265 706c 6963 6174 696f 6e3a 207b  f"replication: {
+00036e20: 652e 5f5f 636c 6173 735f 5f2e 5f5f 6e61  e.__class__.__na
+00036e30: 6d65 5f5f 7d3a 207b 657d 220a 2020 2020  me__}: {e}".    
+00036e40: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00036e50: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00036e60: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
+00036e70: 776f 726b 6572 732e 6765 7428 776f 726b  workers.get(work
+00036e80: 6572 5f61 6464 7265 7373 290a 2020 2020  er_address).    
+00036e90: 2020 2020 6966 206e 6f74 2077 733a 0a20      if not ws:. 
+00036ea0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00036eb0: 6e0a 0a20 2020 2020 2020 2066 6f72 206b  n..        for k
+00036ec0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
+00036ed0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+00036ee0: 5374 6174 6520 3d20 7365 6c66 2e74 6173  State = self.tas
+00036ef0: 6b73 2e67 6574 286b 6579 2920 2023 2074  ks.get(key)  # t
+00036f00: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00036f10: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+00036f20: 206e 6f74 204e 6f6e 6520 616e 6420 7773   not None and ws
+00036f30: 2069 6e20 7473 2e77 686f 5f68 6173 3a0a   in ts.who_has:.
+00036f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036f50: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
+00036f60: 3d3d 2022 6d65 6d6f 7279 220a 2020 2020  == "memory".    
+00036f70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00036f80: 2e72 656d 6f76 655f 7265 706c 6963 6128  .remove_replica(
+00036f90: 7473 2c20 7773 290a 2020 2020 2020 2020  ts, ws).        
+00036fa0: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
+00036fb0: 732e 7768 6f5f 6861 733a 0a20 2020 2020  s.who_has:.     
+00036fc0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00036fd0: 204c 6173 7420 636f 7079 2064 656c 6574   Last copy delet
+00036fe0: 6564 0a20 2020 2020 2020 2020 2020 2020  ed.             
+00036ff0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+00037000: 7369 7469 6f6e 7328 7b6b 6579 3a20 2272  sitions({key: "r
+00037010: 656c 6561 7365 6422 7d2c 2073 7469 6d75  eleased"}, stimu
+00037020: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
+00037030: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+00037040: 7773 2e61 6464 7265 7373 2c20 7b22 6163  ws.address, {"ac
+00037050: 7469 6f6e 223a 2022 7265 6d6f 7665 2d77  tion": "remove-w
+00037060: 6f72 6b65 722d 6461 7461 222c 2022 6b65  orker-data", "ke
+00037070: 7973 223a 206b 6579 737d 290a 0a20 2020  ys": keys})..   
+00037080: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00037090: 2061 7379 6e63 2064 6566 2072 6562 616c   async def rebal
+000370a0: 616e 6365 280a 2020 2020 2020 2020 7365  ance(.        se
+000370b0: 6c66 2c0a 2020 2020 2020 2020 6b65 7973  lf,.        keys
+000370c0: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
+000370d0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+000370e0: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
+000370f0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+00037100: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00037110: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00037120: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00037130: 6f6e 652c 0a20 2020 2029 202d 3e20 6469  one,.    ) -> di
+00037140: 6374 3a0a 2020 2020 2020 2020 2222 2252  ct:.        """R
+00037150: 6562 616c 616e 6365 206b 6579 7320 736f  ebalance keys so
+00037160: 2074 6861 7420 6561 6368 2077 6f72 6b65   that each worke
+00037170: 7220 656e 6473 2075 7020 7769 7468 2072  r ends up with r
+00037180: 6f75 6768 6c79 2074 6865 2073 616d 6520  oughly the same 
+00037190: 7072 6f63 6573 730a 2020 2020 2020 2020  process.        
+000371a0: 6d65 6d6f 7279 2028 6d61 6e61 6765 642b  memory (managed+
+000371b0: 756e 6d61 6e61 6765 6429 2e0a 0a20 2020  unmanaged)...   
+000371c0: 2020 2020 202e 2e20 7761 726e 696e 673a       .. warning:
+000371d0: 3a0a 2020 2020 2020 2020 2020 2054 6869  :.           Thi
+000371e0: 7320 6f70 6572 6174 696f 6e20 6973 2067  s operation is g
+000371f0: 656e 6572 616c 6c79 206e 6f74 2077 656c  enerally not wel
+00037200: 6c20 7465 7374 6564 2061 6761 696e 7374  l tested against
+00037210: 206e 6f72 6d61 6c20 6f70 6572 6174 696f   normal operatio
+00037220: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
+00037230: 2020 2020 7363 6865 6475 6c65 722e 2049      scheduler. I
+00037240: 7420 6973 206e 6f74 2072 6563 6f6d 6d65  t is not recomme
+00037250: 6e64 6564 2074 6f20 7573 6520 6974 2077  nded to use it w
+00037260: 6869 6c65 2077 6169 7469 6e67 206f 6e20  hile waiting on 
+00037270: 636f 6d70 7574 6174 696f 6e73 2e0a 0a20  computations... 
+00037280: 2020 2020 2020 202a 2a41 6c67 6f72 6974         **Algorit
+00037290: 686d 2a2a 0a0a 2020 2020 2020 2020 232e  hm**..        #.
+000372a0: 2046 696e 6420 7468 6520 6d65 616e 206f   Find the mean o
+000372b0: 6363 7570 616e 6379 206f 6620 7468 6520  ccupancy of the 
+000372c0: 636c 7573 7465 722c 2064 6566 696e 6564  cluster, defined
+000372d0: 2061 7320 6461 7461 206d 616e 6167 6564   as data managed
+000372e0: 2062 7920 6461 736b 202b 0a20 2020 2020   by dask +.     
+000372f0: 2020 2020 2020 756e 6d61 6e61 6765 6420        unmanaged 
+00037300: 7072 6f63 6573 7320 6d65 6d6f 7279 2074  process memory t
+00037310: 6861 7420 6861 7320 6265 656e 2074 6865  hat has been the
+00037320: 7265 2066 6f72 2061 7420 6c65 6173 7420  re for at least 
+00037330: 3330 2073 6563 6f6e 6473 0a20 2020 2020  30 seconds.     
+00037340: 2020 2020 2020 2860 6064 6973 7472 6962        (``distrib
+00037350: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
+00037360: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
+00037370: 2d74 696d 6560 6029 2e0a 2020 2020 2020  -time``)..      
+00037380: 2020 2020 2054 6869 7320 6c65 7473 2075       This lets u
+00037390: 7320 6967 6e6f 7265 2074 656d 706f 7261  s ignore tempora
+000373a0: 7279 2073 7069 6b65 7320 6361 7573 6564  ry spikes caused
+000373b0: 2062 7920 7461 736b 2068 6561 7020 7573   by task heap us
+000373c0: 6167 652e 0a0a 2020 2020 2020 2020 2020  age...          
+000373d0: 2041 6c74 6572 6e61 7469 7665 6c79 2c20   Alternatively, 
+000373e0: 796f 7520 6d61 7920 6368 616e 6765 2068  you may change h
+000373f0: 6f77 206d 656d 6f72 7920 6973 206d 6561  ow memory is mea
+00037400: 7375 7265 6420 626f 7468 2066 6f72 2074  sured both for t
+00037410: 6865 2069 6e64 6976 6964 7561 6c0a 2020  he individual.  
+00037420: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00037430: 2061 7320 7765 6c6c 2061 7320 746f 2063   as well as to c
+00037440: 616c 6375 6c61 7465 2074 6865 206d 6561  alculate the mea
+00037450: 6e20 7468 726f 7567 680a 2020 2020 2020  n through.      
+00037460: 2020 2020 2060 6064 6973 7472 6962 7574       ``distribut
+00037470: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+00037480: 2e72 6562 616c 616e 6365 2e6d 6561 7375  .rebalance.measu
+00037490: 7265 6060 2e20 4e61 6d65 6c79 2c20 7468  re``. Namely, th
+000374a0: 6973 2063 616e 2062 6520 7573 6566 756c  is can be useful
+000374b0: 0a20 2020 2020 2020 2020 2020 746f 2064  .           to d
+000374c0: 6973 7265 6761 7264 2069 6e61 6363 7572  isregard inaccur
+000374d0: 6174 6520 4f53 206d 656d 6f72 7920 6d65  ate OS memory me
+000374e0: 6173 7572 656d 656e 7473 2e0a 0a20 2020  asurements...   
+000374f0: 2020 2020 2023 2e20 4469 7363 6172 6420       #. Discard 
+00037500: 776f 726b 6572 7320 7768 6f73 6520 6f63  workers whose oc
+00037510: 6375 7061 6e63 7920 6973 2077 6974 6869  cupancy is withi
+00037520: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
+00037530: 2063 6c75 7374 6572 206f 6363 7570 616e   cluster occupan
+00037540: 6379 0a20 2020 2020 2020 2020 2020 2860  cy.           (`
+00037550: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
+00037560: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
+00037570: 616e 6365 2e73 656e 6465 722d 7265 6369  ance.sender-reci
+00037580: 7069 656e 742d 6761 7060 6020 2f20 3229  pient-gap`` / 2)
+00037590: 2e0a 2020 2020 2020 2020 2020 2054 6869  ..           Thi
+000375a0: 7320 6865 6c70 7320 6176 6f69 6420 6461  s helps avoid da
+000375b0: 7461 2066 726f 6d20 626f 756e 6369 6e67  ta from bouncing
+000375c0: 2061 726f 756e 6420 7468 6520 636c 7573   around the clus
+000375d0: 7465 7220 7265 7065 6174 6564 6c79 2e0a  ter repeatedly..
+000375e0: 2020 2020 2020 2020 232e 2057 6f72 6b65          #. Worke
+000375f0: 7273 2061 626f 7665 2074 6865 206d 6561  rs above the mea
+00037600: 6e20 6172 6520 7365 6e64 6572 733b 2074  n are senders; t
+00037610: 686f 7365 2062 656c 6f77 2061 7265 2072  hose below are r
+00037620: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
+00037630: 2020 2023 2e20 4469 7363 6172 6420 7365     #. Discard se
+00037640: 6e64 6572 7320 7768 6f73 6520 6162 736f  nders whose abso
+00037650: 6c75 7465 206f 6363 7570 616e 6379 2069  lute occupancy i
+00037660: 7320 6265 6c6f 7720 3330 250a 2020 2020  s below 30%.    
+00037670: 2020 2020 2020 2028 6060 6469 7374 7269         (``distri
+00037680: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+00037690: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+000376a0: 6e64 6572 2d6d 696e 6060 292e 2049 6e20  nder-min``). In 
+000376b0: 6f74 6865 7220 776f 7264 732c 206e 6f20  other words, no 
+000376c0: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+000376d0: 6973 206d 6f76 6564 2072 6567 6172 646c  is moved regardl
+000376e0: 6573 7320 6f66 2069 6d62 616c 616e 6369  ess of imbalanci
+000376f0: 6e67 2061 7320 6c6f 6e67 2061 7320 616c  ng as long as al
+00037700: 6c20 776f 726b 6572 7320 6172 6520 6265  l workers are be
+00037710: 6c6f 7720 3330 252e 0a20 2020 2020 2020  low 30%..       
+00037720: 2023 2e20 4469 7363 6172 6420 7265 6369   #. Discard reci
+00037730: 7069 656e 7473 2077 686f 7365 2061 6273  pients whose abs
+00037740: 6f6c 7574 6520 6f63 6375 7061 6e63 7920  olute occupancy 
+00037750: 6973 2061 626f 7665 2036 3025 0a20 2020  is above 60%.   
+00037760: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
+00037770: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+00037780: 6d6f 7279 2e72 6562 616c 616e 6365 2e72  mory.rebalance.r
+00037790: 6563 6970 6965 6e74 2d6d 6178 6060 292e  ecipient-max``).
+000377a0: 0a20 2020 2020 2020 2020 2020 4e6f 7465  .           Note
+000377b0: 2074 6861 7420 7468 6973 2074 6872 6573   that this thres
+000377c0: 686f 6c64 2062 7920 6465 6661 756c 7420  hold by default 
+000377d0: 6973 2074 6865 2073 616d 6520 6173 0a20  is the same as. 
+000377e0: 2020 2020 2020 2020 2020 6060 6469 7374            ``dist
+000377f0: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+00037800: 656d 6f72 792e 7461 7267 6574 6060 2074  emory.target`` t
+00037810: 6f20 7072 6576 656e 7420 776f 726b 6572  o prevent worker
+00037820: 7320 6672 6f6d 2061 6363 6570 7469 6e67  s from accepting
+00037830: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+00037840: 2061 6e64 2069 6d6d 6564 6961 7465 6c79   and immediately
+00037850: 2073 7069 6c6c 696e 6720 6974 206f 7574   spilling it out
+00037860: 2074 6f20 6469 736b 2e0a 2020 2020 2020   to disk..      
+00037870: 2020 232e 2049 7465 7261 7469 7665 6c79    #. Iteratively
+00037880: 2070 6963 6b20 7468 6520 7365 6e64 6572   pick the sender
+00037890: 2061 6e64 2072 6563 6970 6965 6e74 2074   and recipient t
+000378a0: 6861 7420 6172 6520 6661 7274 6865 7374  hat are farthest
+000378b0: 2066 726f 6d20 7468 6520 6d65 616e 2061   from the mean a
+000378c0: 6e64 0a20 2020 2020 2020 2020 2020 6d6f  nd.           mo
+000378d0: 7665 2074 6865 202a 6c65 6173 7420 7265  ve the *least re
+000378e0: 6365 6e74 6c79 2069 6e73 6572 7465 642a  cently inserted*
+000378f0: 206b 6579 2062 6574 7765 656e 2074 6865   key between the
+00037900: 2074 776f 2c20 756e 7469 6c20 6569 7468   two, until eith
+00037910: 6572 2061 6c6c 0a20 2020 2020 2020 2020  er all.         
+00037920: 2020 7365 6e64 6572 7320 6f72 2061 6c6c    senders or all
+00037930: 2072 6563 6970 6965 6e74 7320 6661 6c6c   recipients fall
+00037940: 2077 6974 6869 6e20 3525 206f 6620 7468   within 5% of th
+00037950: 6520 6d65 616e 2e0a 0a20 2020 2020 2020  e mean...       
+00037960: 2020 2020 4120 7265 6369 7069 656e 7420      A recipient 
+00037970: 7769 6c6c 2062 6520 736b 6970 7065 6420  will be skipped 
+00037980: 6966 2069 7420 616c 7265 6164 7920 6861  if it already ha
+00037990: 7320 6120 636f 7079 206f 6620 7468 6520  s a copy of the 
+000379a0: 6461 7461 2e20 496e 206f 7468 6572 0a20  data. In other. 
+000379b0: 2020 2020 2020 2020 2020 776f 7264 732c            words,
+000379c0: 2074 6869 7320 6d65 7468 6f64 2064 6f65   this method doe
+000379d0: 7320 6e6f 7420 6465 6772 6164 6520 7265  s not degrade re
+000379e0: 706c 6963 6174 696f 6e2e 0a20 2020 2020  plication..     
+000379f0: 2020 2020 2020 4120 6b65 7920 7769 6c6c        A key will
+00037a00: 2062 6520 736b 6970 7065 6420 6966 2074   be skipped if t
+00037a10: 6865 7265 2061 7265 206e 6f20 7265 6369  here are no reci
+00037a20: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
+00037a30: 2077 6974 6820 656e 6f75 6768 206d 656d   with enough mem
+00037a40: 6f72 790a 2020 2020 2020 2020 2020 2074  ory.           t
+00037a50: 6f20 6163 6365 7074 2074 6865 206b 6579  o accept the key
+00037a60: 2061 6e64 2074 6861 7420 646f 6e27 7420   and that don't 
+00037a70: 616c 7265 6164 7920 686f 6c64 2061 2063  already hold a c
+00037a80: 6f70 792e 0a0a 2020 2020 2020 2020 5468  opy...        Th
+00037a90: 6520 6c65 6173 7420 7265 6365 6e74 6c79  e least recently
+00037aa0: 2069 6e73 6572 7464 2028 4c52 4929 2070   insertd (LRI) p
+00037ab0: 6f6c 6963 7920 6973 2061 2067 7265 6564  olicy is a greed
+00037ac0: 7920 6368 6f69 6365 2077 6974 6820 7468  y choice with th
+00037ad0: 6520 6164 7661 6e74 6167 6520 6f66 0a20  e advantage of. 
+00037ae0: 2020 2020 2020 2062 6569 6e67 204f 2831         being O(1
+00037af0: 292c 2074 7269 7669 616c 2074 6f20 696d  ), trivial to im
+00037b00: 706c 656d 656e 7420 2869 7420 7265 6c69  plement (it reli
+00037b10: 6573 206f 6e20 7079 7468 6f6e 2064 6963  es on python dic
+00037b20: 7420 696e 7365 7274 696f 6e2d 736f 7274  t insertion-sort
+00037b30: 696e 6729 0a20 2020 2020 2020 2061 6e64  ing).        and
+00037b40: 2068 6f70 6566 756c 6c79 2067 6f6f 6420   hopefully good 
+00037b50: 656e 6f75 6768 2069 6e20 6d6f 7374 2063  enough in most c
+00037b60: 6173 6573 2e20 4469 7363 6172 6465 6420  ases. Discarded 
+00037b70: 616c 7465 726e 6174 6976 6520 706f 6c69  alternative poli
+00037b80: 6369 6573 2077 6572 653a 0a0a 2020 2020  cies were:..    
+00037b90: 2020 2020 2d20 4c61 7267 6573 7420 6669      - Largest fi
+00037ba0: 7273 742e 204f 286e 2a6c 6f67 286e 2929  rst. O(n*log(n))
+00037bb0: 2073 6176 6520 666f 7220 6e6f 6e2d 7472   save for non-tr
+00037bc0: 6976 6961 6c20 6164 6469 7469 6f6e 616c  ivial additional
+00037bd0: 2064 6174 6120 7374 7275 6374 7572 6573   data structures
+00037be0: 2061 6e64 0a20 2020 2020 2020 2020 2072   and.          r
+00037bf0: 6973 6b73 2063 6175 7369 6e67 2074 6865  isks causing the
+00037c00: 206c 6172 6765 7374 2063 6875 6e6b 7320   largest chunks 
+00037c10: 6f66 2064 6174 6120 746f 2072 6570 6561  of data to repea
+00037c20: 7465 646c 7920 6d6f 7665 2061 726f 756e  tedly move aroun
+00037c30: 6420 7468 650a 2020 2020 2020 2020 2020  d the.          
+00037c40: 636c 7573 7465 7220 6c69 6b65 2070 696e  cluster like pin
+00037c50: 6261 6c6c 732e 0a20 2020 2020 2020 202d  balls..        -
+00037c60: 204c 6561 7374 2072 6563 656e 746c 7920   Least recently 
+00037c70: 7573 6564 2028 4c52 5529 2e20 5468 6973  used (LRU). This
+00037c80: 2069 6e66 6f72 6d61 7469 6f6e 2069 7320   information is 
+00037c90: 6375 7272 656e 746c 7920 6176 6169 6c61  currently availa
+00037ca0: 626c 6520 6f6e 2074 6865 0a20 2020 2020  ble on the.     
+00037cb0: 2020 2020 2077 6f72 6b65 7273 206f 6e6c       workers onl
+00037cc0: 7920 616e 6420 6e6f 7420 7472 6976 6961  y and not trivia
+00037cd0: 6c20 746f 2072 6570 6c69 6361 7465 206f  l to replicate o
+00037ce0: 6e20 7468 6520 7363 6865 6475 6c65 723b  n the scheduler;
+00037cf0: 2074 7261 6e73 6d69 7474 696e 6720 6974   transmitting it
+00037d00: 0a20 2020 2020 2020 2020 206f 7665 7220  .          over 
+00037d10: 7468 6520 6e65 7477 6f72 6b20 776f 756c  the network woul
+00037d20: 6420 6265 2076 6572 7920 6578 7065 6e73  d be very expens
+00037d30: 6976 652e 2041 6c73 6f2c 206e 6f74 6520  ive. Also, note 
+00037d40: 7468 6174 2064 6173 6b20 7769 6c6c 2067  that dask will g
+00037d50: 6f20 6f75 7420 6f66 0a20 2020 2020 2020  o out of.       
+00037d60: 2020 2069 7473 2077 6179 2074 6f20 6d69     its way to mi
+00037d70: 6e69 6d69 7365 2074 6865 2061 6d6f 756e  nimise the amoun
+00037d80: 7420 6f66 2074 696d 6520 696e 7465 726d  t of time interm
+00037d90: 6564 6961 7465 206b 6579 7320 6172 6520  ediate keys are 
+00037da0: 6865 6c64 2069 6e20 6d65 6d6f 7279 2c0a  held in memory,.
+00037db0: 2020 2020 2020 2020 2020 736f 2069 6e20            so in 
+00037dc0: 7375 6368 2061 2063 6173 6520 4c52 4920  such a case LRI 
+00037dd0: 6973 2061 2063 6c6f 7365 2061 7070 726f  is a close appro
+00037de0: 7869 6d61 7469 6f6e 206f 6620 4c52 552e  ximation of LRU.
+00037df0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+00037e00: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+00037e10: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00037e20: 6b65 7973 3a20 6f70 7469 6f6e 616c 0a20  keys: optional. 
+00037e30: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
+00037e40: 6c69 7374 206f 6620 6461 736b 206b 6579  list of dask key
+00037e50: 7320 7468 6174 2073 686f 756c 6420 6265  s that should be
+00037e60: 2063 6f6e 7369 6465 7265 6420 666f 7220   considered for 
+00037e70: 6d6f 7669 6e67 2e20 416c 6c20 6f74 6865  moving. All othe
+00037e80: 7220 6b65 7973 0a20 2020 2020 2020 2020  r keys.         
+00037e90: 2020 2077 696c 6c20 6265 2069 676e 6f72     will be ignor
+00037ea0: 6564 2e20 4e6f 7465 2074 6861 7420 7468  ed. Note that th
+00037eb0: 6973 206f 6666 6572 7320 6e6f 2067 7561  is offers no gua
+00037ec0: 7261 6e74 6565 2074 6861 7420 6120 6b65  rantee that a ke
+00037ed0: 7920 7769 6c6c 2061 6374 7561 6c6c 790a  y will actually.
+00037ee0: 2020 2020 2020 2020 2020 2020 6265 206d              be m
+00037ef0: 6f76 6564 2028 652e 672e 2062 6563 6175  oved (e.g. becau
+00037f00: 7365 2069 7420 6973 2075 6e6e 6563 6573  se it is unneces
+00037f10: 7361 7279 206f 7220 6265 6361 7573 6520  sary or because 
+00037f20: 7468 6572 6520 6172 6520 6e6f 2076 6961  there are no via
+00037f30: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
+00037f40: 7265 6369 7069 656e 7420 776f 726b 6572  recipient worker
+00037f50: 7320 666f 7220 6974 292e 0a20 2020 2020  s for it)..     
+00037f60: 2020 2077 6f72 6b65 7273 3a20 6f70 7469     workers: opti
+00037f70: 6f6e 616c 0a20 2020 2020 2020 2020 2020  onal.           
+00037f80: 2061 6c6c 6f77 6c69 7374 206f 6620 776f   allowlist of wo
+00037f90: 726b 6572 7320 6164 6472 6573 7365 7320  rkers addresses 
+00037fa0: 746f 2062 6520 636f 6e73 6964 6572 6564  to be considered
+00037fb0: 2061 7320 7365 6e64 6572 7320 6f72 2072   as senders or r
+00037fc0: 6563 6970 6965 6e74 732e 0a20 2020 2020  ecipients..     
+00037fd0: 2020 2020 2020 2041 6c6c 206f 7468 6572         All other
+00037fe0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
+00037ff0: 2069 676e 6f72 6564 2e20 5468 6520 6d65   ignored. The me
+00038000: 616e 2063 6c75 7374 6572 206f 6363 7570  an cluster occup
+00038010: 616e 6379 2077 696c 6c20 6265 0a20 2020  ancy will be.   
+00038020: 2020 2020 2020 2020 2063 616c 6375 6c61           calcula
+00038030: 7465 6420 6f6e 6c79 2075 7369 6e67 2074  ted only using t
+00038040: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
+00038050: 7273 2e0a 2020 2020 2020 2020 2222 220a  rs..        """.
+00038060: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00038070: 5f69 6420 3d20 7374 696d 756c 7573 5f69  _id = stimulus_i
+00038080: 6420 6f72 2066 2272 6562 616c 616e 6365  d or f"rebalance
+00038090: 2d7b 7469 6d65 2829 7d22 0a0a 2020 2020  -{time()}"..    
+000380a0: 2020 2020 7773 733a 2043 6f6c 6c65 6374      wss: Collect
+000380b0: 696f 6e5b 576f 726b 6572 5374 6174 655d  ion[WorkerState]
+000380c0: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+000380d0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+000380e0: 0a20 2020 2020 2020 2020 2020 2077 7373  .            wss
+000380f0: 203d 205b 7365 6c66 2e77 6f72 6b65 7273   = [self.workers
+00038100: 5b77 5d20 666f 7220 7720 696e 2077 6f72  [w] for w in wor
+00038110: 6b65 7273 5d0a 2020 2020 2020 2020 656c  kers].        el
+00038120: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00038130: 7773 7320 3d20 7365 6c66 2e77 6f72 6b65  wss = self.worke
+00038140: 7273 2e76 616c 7565 7328 290a 2020 2020  rs.values().    
+00038150: 2020 2020 6966 206e 6f74 2077 7373 3a0a      if not wss:.
+00038160: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00038170: 726e 207b 2273 7461 7475 7322 3a20 224f  rn {"status": "O
+00038180: 4b22 7d0a 0a20 2020 2020 2020 2069 6620  K"}..        if 
+00038190: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
+000381a0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000381b0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
+000381c0: 6b65 7973 2c20 5365 7429 3a0a 2020 2020  keys, Set):.    
+000381d0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
+000381e0: 203d 2073 6574 286b 6579 7329 2020 2320   = set(keys)  # 
+000381f0: 756e 6c65 7373 2061 6c72 6561 6479 2061  unless already a
+00038200: 2073 6574 2d6c 696b 650a 2020 2020 2020   set-like.      
+00038210: 2020 2020 2020 6966 206e 6f74 206b 6579        if not key
+00038220: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00038230: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
+00038240: 7573 223a 2022 4f4b 227d 0a20 2020 2020  us": "OK"}.     
+00038250: 2020 2020 2020 206d 6973 7369 6e67 5f64         missing_d
+00038260: 6174 6120 3d20 5b0a 2020 2020 2020 2020  ata = [.        
+00038270: 2020 2020 2020 2020 6b20 666f 7220 6b20          k for k 
+00038280: 696e 206b 6579 7320 6966 206b 206e 6f74  in keys if k not
+00038290: 2069 6e20 7365 6c66 2e74 6173 6b73 206f   in self.tasks o
+000382a0: 7220 6e6f 7420 7365 6c66 2e74 6173 6b73  r not self.tasks
+000382b0: 5b6b 5d2e 7768 6f5f 6861 730a 2020 2020  [k].who_has.    
+000382c0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+000382d0: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
+000382e0: 5f64 6174 613a 0a20 2020 2020 2020 2020  _data:.         
+000382f0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00038300: 7374 6174 7573 223a 2022 7061 7274 6961  status": "partia
+00038310: 6c2d 6661 696c 222c 2022 6b65 7973 223a  l-fail", "keys":
+00038320: 206d 6973 7369 6e67 5f64 6174 617d 0a0a   missing_data}..
+00038330: 2020 2020 2020 2020 6d73 6773 203d 2073          msgs = s
+00038340: 656c 662e 5f72 6562 616c 616e 6365 5f66  elf._rebalance_f
+00038350: 696e 645f 6d73 6773 286b 6579 732c 2077  ind_msgs(keys, w
+00038360: 7373 290a 2020 2020 2020 2020 6966 206e  ss).        if n
+00038370: 6f74 206d 7367 733a 0a20 2020 2020 2020  ot msgs:.       
+00038380: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
+00038390: 6174 7573 223a 2022 4f4b 227d 0a0a 2020  atus": "OK"}..  
+000383a0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+000383b0: 2073 656c 662e 5f6c 6f63 6b3a 0a20 2020   self._lock:.   
+000383c0: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+000383d0: 3d20 6177 6169 7420 7365 6c66 2e5f 7265  = await self._re
+000383e0: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
+000383f0: 6128 6d73 6773 2c20 7374 696d 756c 7573  a(msgs, stimulus
+00038400: 5f69 6429 0a20 2020 2020 2020 2020 2020  _id).           
+00038410: 2069 6620 7265 7375 6c74 5b22 7374 6174   if result["stat
+00038420: 7573 225d 203d 3d20 2270 6172 7469 616c  us"] == "partial
+00038430: 2d66 6169 6c22 2061 6e64 206b 6579 7320  -fail" and keys 
+00038440: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00038450: 2020 2020 2020 2020 2023 204f 6e6c 7920           # Only 
+00038460: 7265 7475 726e 2066 6169 6c65 6420 6b65  return failed ke
+00038470: 7973 2069 6620 7468 6520 636c 6965 6e74  ys if the client
+00038480: 2065 7870 6c69 6369 746c 7920 6173 6b65   explicitly aske
+00038490: 6420 666f 7220 7468 656d 0a20 2020 2020  d for them.     
+000384a0: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+000384b0: 7420 3d20 7b22 7374 6174 7573 223a 2022  t = {"status": "
+000384c0: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
+000384d0: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+000384e0: 2020 2020 6465 6620 5f72 6562 616c 616e      def _rebalan
+000384f0: 6365 5f66 696e 645f 6d73 6773 280a 2020  ce_find_msgs(.  
+00038500: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00038510: 2020 2020 6b65 7973 3a20 5365 745b 4861      keys: Set[Ha
+00038520: 7368 6162 6c65 5d20 7c20 4e6f 6e65 2c0a  shable] | None,.
+00038530: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+00038540: 2049 7465 7261 626c 655b 576f 726b 6572   Iterable[Worker
+00038550: 5374 6174 655d 2c0a 2020 2020 2920 2d3e  State],.    ) ->
+00038560: 206c 6973 745b 7475 706c 655b 576f 726b   list[tuple[Work
+00038570: 6572 5374 6174 652c 2057 6f72 6b65 7253  erState, WorkerS
+00038580: 7461 7465 2c20 5461 736b 5374 6174 655d  tate, TaskState]
+00038590: 5d3a 0a20 2020 2020 2020 2022 2222 4964  ]:.        """Id
+000385a0: 656e 7469 6679 2077 6f72 6b65 7273 2074  entify workers t
+000385b0: 6861 7420 6e65 6564 2074 6f20 6c6f 7365  hat need to lose
+000385c0: 206b 6579 7320 616e 6420 7468 6f73 6520   keys and those 
+000385d0: 7468 6174 2063 616e 2072 6563 6569 7665  that can receive
+000385e0: 2074 6865 6d2c 0a20 2020 2020 2020 2074   them,.        t
+000385f0: 6f67 6574 6865 7220 7769 7468 2068 6f77  ogether with how
+00038600: 206d 616e 7920 6279 7465 7320 6561 6368   many bytes each
+00038610: 206e 6565 6473 2074 6f20 6c6f 7365 2f72   needs to lose/r
+00038620: 6563 6569 7665 2e20 5468 656e 2c20 7061  eceive. Then, pa
+00038630: 6972 2061 2073 656e 6465 720a 2020 2020  ir a sender.    
+00038640: 2020 2020 776f 726b 6572 2077 6974 6820      worker with 
+00038650: 6120 7265 6369 7069 656e 7420 776f 726b  a recipient work
+00038660: 6572 2066 6f72 2065 6163 6820 6b65 792c  er for each key,
+00038670: 2075 6e74 696c 2074 6865 2063 6c75 7374   until the clust
+00038680: 6572 2069 7320 7265 6261 6c61 6e63 6564  er is rebalanced
+00038690: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
+000386a0: 6d65 7468 6f64 206f 6e6c 7920 6465 6669  method only defi
+000386b0: 6e65 7320 7468 6520 776f 726b 2074 6f20  nes the work to 
+000386c0: 6265 2070 6572 666f 726d 6564 3b20 6974  be performed; it
+000386d0: 2064 6f65 7320 6e6f 7420 7374 6172 7420   does not start 
+000386e0: 616e 7920 6e65 7477 6f72 6b0a 2020 2020  any network.    
+000386f0: 2020 2020 7472 616e 7366 6572 7320 6974      transfers it
+00038700: 7365 6c66 2e0a 0a20 2020 2020 2020 2054  self...        T
+00038710: 6865 2062 6967 2d4f 2063 6f6d 706c 6578  he big-O complex
+00038720: 6974 7920 6973 204f 2877 7420 2b20 6b65  ity is O(wt + ke
+00038730: 2a6c 6f67 2877 6529 292c 2077 6865 7265  *log(we)), where
+00038740: 0a0a 2020 2020 2020 2020 2d20 7774 2069  ..        - wt i
+00038750: 7320 7468 6520 746f 7461 6c20 6e75 6d62  s the total numb
+00038760: 6572 206f 6620 776f 726b 6572 7320 6f6e  er of workers on
+00038770: 2074 6865 2063 6c75 7374 6572 2028 6f72   the cluster (or
+00038780: 2074 6865 206e 756d 6265 7220 6f66 2061   the number of a
+00038790: 6c6c 6f77 6564 0a20 2020 2020 2020 2020  llowed.         
+000387a0: 2077 6f72 6b65 7273 2c20 6966 2065 7870   workers, if exp
+000387b0: 6c69 6369 746c 7920 7374 6174 6564 2062  licitly stated b
+000387c0: 7920 7468 6520 7573 6572 290a 2020 2020  y the user).    
+000387d0: 2020 2020 2d20 7765 2069 7320 7468 6520      - we is the 
+000387e0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
+000387f0: 7320 7468 6174 2061 7265 2065 6c69 6769  s that are eligi
+00038800: 626c 6520 746f 2062 6520 7365 6e64 6572  ble to be sender
+00038810: 7320 6f72 2072 6563 6970 6965 6e74 730a  s or recipients.
+00038820: 2020 2020 2020 2020 2d20 6b74 2069 7320          - kt is 
+00038830: 7468 6520 746f 7461 6c20 6e75 6d62 6572  the total number
+00038840: 206f 6620 6b65 7973 206f 6e20 7468 6520   of keys on the 
+00038850: 636c 7573 7465 7220 286f 7220 6f6e 2074  cluster (or on t
+00038860: 6865 2061 6c6c 6f77 6564 2077 6f72 6b65  he allowed worke
+00038870: 7273 290a 2020 2020 2020 2020 2d20 6b65  rs).        - ke
+00038880: 2069 7320 7468 6520 6e75 6d62 6572 206f   is the number o
+00038890: 6620 6b65 7973 2074 6861 7420 6e65 6564  f keys that need
+000388a0: 2074 6f20 6265 206d 6f76 6564 2069 6e20   to be moved in 
+000388b0: 6f72 6465 7220 746f 2061 6368 6965 7665  order to achieve
+000388c0: 2061 2062 616c 616e 6365 640a 2020 2020   a balanced.    
+000388d0: 2020 2020 2020 636c 7573 7465 720a 0a20        cluster.. 
+000388e0: 2020 2020 2020 2054 6865 7265 2069 7320         There is 
+000388f0: 6120 6465 6765 6e65 7261 7465 2065 6467  a degenerate edg
+00038900: 6520 6361 7365 204f 2877 7420 2b20 6b74  e case O(wt + kt
+00038910: 2a6c 6f67 2877 6529 2920 7768 656e 206b  *log(we)) when k
+00038920: 7420 6973 206d 7563 6820 6772 6561 7465  t is much greate
+00038930: 7220 7468 616e 0a20 2020 2020 2020 2074  r than.        t
+00038940: 6865 206e 756d 6265 7220 6f66 2061 6c6c  he number of all
+00038950: 6f77 6564 206b 6579 732c 206f 7220 7768  owed keys, or wh
+00038960: 656e 206d 6f73 7420 6b65 7973 2061 7265  en most keys are
+00038970: 2072 6570 6c69 6361 7465 6420 6f72 2063   replicated or c
+00038980: 616e 6e6f 7420 6265 0a20 2020 2020 2020  annot be.       
+00038990: 206d 6f76 6564 2066 6f72 2073 6f6d 6520   moved for some 
+000389a0: 6f74 6865 7220 7265 6173 6f6e 2e0a 0a20  other reason... 
+000389b0: 2020 2020 2020 2052 6574 7572 6e73 206c         Returns l
+000389c0: 6973 7420 6f66 2074 7570 6c65 7320 746f  ist of tuples to
+000389d0: 2066 6565 6420 696e 746f 205f 7265 6261   feed into _reba
+000389e0: 6c61 6e63 655f 6d6f 7665 5f64 6174 613a  lance_move_data:
+000389f0: 0a0a 2020 2020 2020 2020 2d20 7365 6e64  ..        - send
+00038a00: 6572 2077 6f72 6b65 720a 2020 2020 2020  er worker.      
+00038a10: 2020 2d20 7265 6369 7069 656e 7420 776f    - recipient wo
+00038a20: 726b 6572 0a20 2020 2020 2020 202d 2074  rker.        - t
+00038a30: 6173 6b20 746f 2062 6520 7472 616e 7366  ask to be transf
+00038a40: 6572 7265 640a 2020 2020 2020 2020 2222  erred.        ""
+00038a50: 220a 2020 2020 2020 2020 2320 4865 6170  ".        # Heap
+00038a60: 7320 6f66 2077 6f72 6b65 7273 2c20 6d61  s of workers, ma
+00038a70: 6e61 6765 6420 6279 2074 6865 2068 6561  naged by the hea
+00038a80: 7071 206d 6f64 756c 652c 2074 6861 7420  pq module, that 
+00038a90: 6e65 6564 2074 6f20 7365 6e64 2f72 6563  need to send/rec
+00038aa0: 6569 7665 2064 6174 612c 0a20 2020 2020  eive data,.     
+00038ab0: 2020 2023 2077 6974 6820 686f 7720 6d61     # with how ma
+00038ac0: 6e79 2062 7974 6573 2065 6163 6820 6e65  ny bytes each ne
+00038ad0: 6564 7320 746f 2073 656e 642f 7265 6365  eds to send/rece
+00038ae0: 6976 652e 0a20 2020 2020 2020 2023 0a20  ive..        #. 
+00038af0: 2020 2020 2020 2023 2045 6163 6820 656c         # Each el
+00038b00: 656d 656e 7420 6f66 2074 6865 2068 6561  ement of the hea
+00038b10: 7020 6973 2061 2074 7570 6c65 2063 6f6e  p is a tuple con
+00038b20: 7374 7275 6374 6564 2061 7320 666f 6c6c  structed as foll
+00038b30: 6f77 733a 0a20 2020 2020 2020 2023 202d  ows:.        # -
+00038b40: 2073 6e64 5f62 7974 6573 5f6d 6178 2f72   snd_bytes_max/r
+00038b50: 6563 5f62 7974 6573 5f6d 6178 3a20 6d61  ec_bytes_max: ma
+00038b60: 7869 6d75 6d20 6e75 6d62 6572 206f 6620  ximum number of 
+00038b70: 6279 7465 7320 746f 2073 656e 6420 6f72  bytes to send or
+00038b80: 2072 6563 6569 7665 2e0a 2020 2020 2020   receive..      
+00038b90: 2020 2320 2020 5468 6973 206e 756d 6265    #   This numbe
+00038ba0: 7220 6973 206e 6567 6174 6976 652c 2073  r is negative, s
+00038bb0: 6f20 7468 6174 2074 6865 2077 6f72 6b65  o that the worke
+00038bc0: 7273 2066 6172 7468 6573 7420 6672 6f6d  rs farthest from
+00038bd0: 2074 6865 2063 6c75 7374 6572 206d 6561   the cluster mea
+00038be0: 6e0a 2020 2020 2020 2020 2320 2020 6172  n.        #   ar
+00038bf0: 6520 6174 2074 6865 2074 6f70 206f 6620  e at the top of 
+00038c00: 7468 6520 736d 616c 6c65 7374 2d66 6972  the smallest-fir
+00038c10: 7374 2068 6561 7073 2e0a 2020 2020 2020  st heaps..      
+00038c20: 2020 2320 2d20 736e 645f 6279 7465 735f    # - snd_bytes_
+00038c30: 6d69 6e2f 7265 635f 6279 7465 735f 6d69  min/rec_bytes_mi
+00038c40: 6e3a 206d 696e 696d 756d 206e 756d 6265  n: minimum numbe
+00038c50: 7220 6f66 2062 7974 6573 2061 6674 6572  r of bytes after
+00038c60: 2073 656e 6469 6e67 2f72 6563 6569 7669   sending/receivi
+00038c70: 6e67 0a20 2020 2020 2020 2023 2020 2077  ng.        #   w
+00038c80: 6869 6368 2074 6865 2077 6f72 6b65 7220  hich the worker 
+00038c90: 7368 6f75 6c64 206e 6f74 2062 6520 636f  should not be co
+00038ca0: 6e73 6964 6572 6564 2061 6e79 6d6f 7265  nsidered anymore
+00038cb0: 2e20 5468 6973 2069 7320 616c 736f 206e  . This is also n
+00038cc0: 6567 6174 6976 652e 0a20 2020 2020 2020  egative..       
+00038cd0: 2023 202d 2061 7262 6974 7261 7279 2075   # - arbitrary u
+00038ce0: 6e69 7175 6520 6e75 6d62 6572 2c20 7468  nique number, th
+00038cf0: 6572 6520 6a75 7374 2074 6f20 746f 206d  ere just to to m
+00038d00: 616b 6520 7375 7265 2074 6861 7420 576f  ake sure that Wo
+00038d10: 726b 6572 5374 6174 6520 6f62 6a65 6374  rkerState object
+00038d20: 730a 2020 2020 2020 2020 2320 2020 6172  s.        #   ar
+00038d30: 6520 6e65 7665 7220 7573 6564 2066 6f72  e never used for
+00038d40: 2073 6f72 7469 6e67 2069 6e20 7468 6520   sorting in the 
+00038d50: 756e 6c69 6b65 6c79 2065 7665 6e74 2074  unlikely event t
+00038d60: 6861 7420 7477 6f20 7072 6f63 6573 7365  hat two processe
+00038d70: 7320 6861 7665 0a20 2020 2020 2020 2023  s have.        #
+00038d80: 2020 2065 7861 6374 6c79 2074 6865 2073     exactly the s
+00038d90: 616d 6520 6e75 6d62 6572 206f 6620 6279  ame number of by
+00038da0: 7465 7320 616c 6c6f 6361 7465 642e 0a20  tes allocated.. 
+00038db0: 2020 2020 2020 2023 202d 2057 6f72 6b65         # - Worke
+00038dc0: 7253 7461 7465 0a20 2020 2020 2020 2023  rState.        #
+00038dd0: 202d 2069 7465 7261 746f 7220 6f66 2061   - iterator of a
+00038de0: 6c6c 2074 6173 6b73 2069 6e20 6d65 6d6f  ll tasks in memo
+00038df0: 7279 206f 6e20 7468 6520 776f 726b 6572  ry on the worker
+00038e00: 2028 7365 6e64 6572 7320 6f6e 6c79 292c   (senders only),
+00038e10: 2069 6e73 6572 7469 6f6e 0a20 2020 2020   insertion.     
+00038e20: 2020 2023 2020 2073 6f72 7465 6420 286c     #   sorted (l
+00038e30: 6561 7374 2072 6563 656e 746c 7920 696e  east recently in
+00038e40: 7365 7274 6564 2066 6972 7374 292e 0a20  serted first).. 
+00038e50: 2020 2020 2020 2023 2020 204e 6f74 6520         #   Note 
+00038e60: 7468 6174 2074 6869 7320 6974 6572 6174  that this iterat
+00038e70: 6f72 2077 696c 6c20 7479 7069 6361 6c6c  or will typicall
+00038e80: 7920 2a6e 6f74 2a20 6265 2065 7868 6175  y *not* be exhau
+00038e90: 7374 6564 2e20 4974 2077 696c 6c20 6f6e  sted. It will on
+00038ea0: 6c79 2062 650a 2020 2020 2020 2020 2320  ly be.        # 
+00038eb0: 2020 6578 6861 7573 7465 6420 6966 2c20    exhausted if, 
+00038ec0: 6166 7465 7220 6d6f 7669 6e67 2061 7761  after moving awa
+00038ed0: 7920 6672 6f6d 2074 6865 2077 6f72 6b65  y from the worke
+00038ee0: 7220 616c 6c20 6b65 7973 2074 6861 7420  r all keys that 
+00038ef0: 6361 6e20 6265 206d 6f76 6564 2c0a 2020  can be moved,.  
+00038f00: 2020 2020 2020 2320 2020 6973 2069 6e73        #   is ins
+00038f10: 7566 6669 6369 656e 7420 746f 2064 726f  ufficient to dro
+00038f20: 7020 736e 645f 6279 7465 735f 6d69 6e20  p snd_bytes_min 
+00038f30: 6162 6f76 6520 302e 0a20 2020 2020 2020  above 0..       
+00038f40: 2073 656e 6465 7273 3a20 6c69 7374 5b74   senders: list[t
+00038f50: 7570 6c65 5b69 6e74 2c20 696e 742c 2069  uple[int, int, i
+00038f60: 6e74 2c20 576f 726b 6572 5374 6174 652c  nt, WorkerState,
+00038f70: 2049 7465 7261 746f 725b 5461 736b 5374   Iterator[TaskSt
+00038f80: 6174 655d 5d5d 203d 205b 5d0a 2020 2020  ate]]] = [].    
+00038f90: 2020 2020 7265 6369 7069 656e 7473 3a20      recipients: 
+00038fa0: 6c69 7374 5b74 7570 6c65 5b69 6e74 2c20  list[tuple[int, 
+00038fb0: 696e 742c 2069 6e74 2c20 576f 726b 6572  int, int, Worker
+00038fc0: 5374 6174 655d 5d20 3d20 5b5d 0a0a 2020  State]] = []..  
+00038fd0: 2020 2020 2020 2320 4f75 7470 7574 3a20        # Output: 
+00038fe0: 5b28 7365 6e64 6572 2c20 7265 6369 7069  [(sender, recipi
+00038ff0: 656e 742c 2074 6173 6b29 2c20 2e2e 2e5d  ent, task), ...]
+00039000: 0a20 2020 2020 2020 206d 7367 733a 206c  .        msgs: l
+00039010: 6973 745b 7475 706c 655b 576f 726b 6572  ist[tuple[Worker
+00039020: 5374 6174 652c 2057 6f72 6b65 7253 7461  State, WorkerSta
+00039030: 7465 2c20 5461 736b 5374 6174 655d 5d20  te, TaskState]] 
+00039040: 3d20 5b5d 0a0a 2020 2020 2020 2020 2320  = []..        # 
+00039050: 4279 2064 6566 6175 6c74 2c20 7468 6973  By default, this
+00039060: 2069 7320 7468 6520 6f70 7469 6d69 7374   is the optimist
+00039070: 6963 206d 656d 6f72 792c 206d 6561 6e69  ic memory, meani
+00039080: 6e67 2074 6f74 616c 2070 726f 6365 7373  ng total process
+00039090: 206d 656d 6f72 7920 6d69 6e75 730a 2020   memory minus.  
+000390a0: 2020 2020 2020 2320 756e 6d61 6e61 6765        # unmanage
+000390b0: 6420 6d65 6d6f 7279 2074 6861 7420 6170  d memory that ap
+000390c0: 7065 6172 6564 206f 7665 7220 7468 6520  peared over the 
+000390d0: 6c61 7374 2033 3020 7365 636f 6e64 730a  last 30 seconds.
+000390e0: 2020 2020 2020 2020 2320 2864 6973 7472          # (distr
+000390f0: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
+00039100: 6d6f 7279 2e72 6563 656e 742d 746f 2d6f  mory.recent-to-o
+00039110: 6c64 2d74 696d 6529 2e0a 2020 2020 2020  ld-time)..      
+00039120: 2020 2320 5468 6973 206c 6574 7320 7573    # This lets us
+00039130: 2069 676e 6f72 6520 7465 6d70 6f72 6172   ignore temporar
+00039140: 7920 7370 696b 6573 2063 6175 7365 6420  y spikes caused 
+00039150: 6279 2074 6173 6b20 6865 6170 2075 7361  by task heap usa
+00039160: 6765 2e0a 2020 2020 2020 2020 6d65 6d6f  ge..        memo
+00039170: 7279 5f62 795f 776f 726b 6572 203d 205b  ry_by_worker = [
+00039180: 0a20 2020 2020 2020 2020 2020 2028 7773  .            (ws
+00039190: 2c20 6765 7461 7474 7228 7773 2e6d 656d  , getattr(ws.mem
+000391a0: 6f72 792c 2073 656c 662e 4d45 4d4f 5259  ory, self.MEMORY
+000391b0: 5f52 4542 414c 414e 4345 5f4d 4541 5355  _REBALANCE_MEASU
+000391c0: 5245 2929 2066 6f72 2077 7320 696e 2077  RE)) for ws in w
+000391d0: 6f72 6b65 7273 0a20 2020 2020 2020 205d  orkers.        ]
+000391e0: 0a20 2020 2020 2020 206d 6561 6e5f 6d65  .        mean_me
+000391f0: 6d6f 7279 203d 2073 756d 286d 2066 6f72  mory = sum(m for
+00039200: 205f 2c20 6d20 696e 206d 656d 6f72 795f   _, m in memory_
+00039210: 6279 5f77 6f72 6b65 7229 202f 2f20 6c65  by_worker) // le
+00039220: 6e28 6d65 6d6f 7279 5f62 795f 776f 726b  n(memory_by_work
+00039230: 6572 290a 0a20 2020 2020 2020 2066 6f72  er)..        for
+00039240: 2077 732c 2077 735f 6d65 6d6f 7279 2069   ws, ws_memory i
+00039250: 6e20 6d65 6d6f 7279 5f62 795f 776f 726b  n memory_by_work
+00039260: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00039270: 6966 2077 732e 6d65 6d6f 7279 5f6c 696d  if ws.memory_lim
+00039280: 6974 3a0a 2020 2020 2020 2020 2020 2020  it:.            
+00039290: 2020 2020 6861 6c66 5f67 6170 203d 2069      half_gap = i
+000392a0: 6e74 2873 656c 662e 4d45 4d4f 5259 5f52  nt(self.MEMORY_R
+000392b0: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
+000392c0: 5020 2a20 7773 2e6d 656d 6f72 795f 6c69  P * ws.memory_li
+000392d0: 6d69 7429 0a20 2020 2020 2020 2020 2020  mit).           
+000392e0: 2020 2020 2073 656e 6465 725f 6d69 6e20       sender_min 
+000392f0: 3d20 7365 6c66 2e4d 454d 4f52 595f 5245  = self.MEMORY_RE
+00039300: 4241 4c41 4e43 455f 5345 4e44 4552 5f4d  BALANCE_SENDER_M
+00039310: 494e 202a 2077 732e 6d65 6d6f 7279 5f6c  IN * ws.memory_l
+00039320: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
+00039330: 2020 2020 2072 6563 6970 6965 6e74 5f6d       recipient_m
+00039340: 6178 203d 2073 656c 662e 4d45 4d4f 5259  ax = self.MEMORY
+00039350: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
+00039360: 4945 4e54 5f4d 4158 202a 2077 732e 6d65  IENT_MAX * ws.me
+00039370: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
+00039380: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00039390: 2020 2020 2020 2020 2020 2020 2068 616c               hal
+000393a0: 665f 6761 7020 3d20 300a 2020 2020 2020  f_gap = 0.      
+000393b0: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+000393c0: 5f6d 696e 203d 2030 2e30 0a20 2020 2020  _min = 0.0.     
+000393d0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+000393e0: 6965 6e74 5f6d 6178 203d 206d 6174 682e  ient_max = math.
+000393f0: 696e 660a 0a20 2020 2020 2020 2020 2020  inf..           
+00039400: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+00039410: 2020 2020 2020 7773 2e5f 6861 735f 7768        ws._has_wh
+00039420: 6174 0a20 2020 2020 2020 2020 2020 2020  at.             
+00039430: 2020 2061 6e64 2077 735f 6d65 6d6f 7279     and ws_memory
+00039440: 203e 3d20 6d65 616e 5f6d 656d 6f72 7920   >= mean_memory 
+00039450: 2b20 6861 6c66 5f67 6170 0a20 2020 2020  + half_gap.     
+00039460: 2020 2020 2020 2020 2020 2061 6e64 2077             and w
+00039470: 735f 6d65 6d6f 7279 203e 3d20 7365 6e64  s_memory >= send
+00039480: 6572 5f6d 696e 0a20 2020 2020 2020 2020  er_min.         
+00039490: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+000394a0: 2020 2020 2020 2320 5468 6973 206d 6179        # This may
+000394b0: 2073 656e 6420 7468 6520 776f 726b 6572   send the worker
+000394c0: 2062 656c 6f77 2073 656e 6465 725f 6d69   below sender_mi
+000394d0: 6e20 2862 7920 6465 7369 676e 290a 2020  n (by design).  
+000394e0: 2020 2020 2020 2020 2020 2020 2020 736e                sn
+000394f0: 645f 6279 7465 735f 6d61 7820 3d20 6d65  d_bytes_max = me
+00039500: 616e 5f6d 656d 6f72 7920 2d20 7773 5f6d  an_memory - ws_m
+00039510: 656d 6f72 7920 2023 206e 6567 6174 6976  emory  # negativ
+00039520: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00039530: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
+00039540: 3d20 736e 645f 6279 7465 735f 6d61 7820  = snd_bytes_max 
+00039550: 2b20 6861 6c66 5f67 6170 2020 2320 6e65  + half_gap  # ne
+00039560: 6761 7469 7665 0a20 2020 2020 2020 2020  gative.         
+00039570: 2020 2020 2020 2023 2053 6565 2064 6566         # See def
+00039580: 696e 6974 696f 6e20 6f66 2073 656e 6465  inition of sende
+00039590: 7273 2061 626f 7665 0a20 2020 2020 2020  rs above.       
+000395a0: 2020 2020 2020 2020 2073 656e 6465 7273           senders
+000395b0: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+000395c0: 2020 2020 2020 2020 2020 2020 2028 736e               (sn
+000395d0: 645f 6279 7465 735f 6d61 782c 2073 6e64  d_bytes_max, snd
+000395e0: 5f62 7974 6573 5f6d 696e 2c20 6964 2877  _bytes_min, id(w
+000395f0: 7329 2c20 7773 2c20 6974 6572 2877 732e  s), ws, iter(ws.
+00039600: 5f68 6173 5f77 6861 7429 290a 2020 2020  _has_what)).    
+00039610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00039620: 2020 2020 2020 2020 2020 656c 6966 2077            elif w
+00039630: 735f 6d65 6d6f 7279 203c 206d 6561 6e5f  s_memory < mean_
+00039640: 6d65 6d6f 7279 202d 2068 616c 665f 6761  memory - half_ga
+00039650: 7020 616e 6420 7773 5f6d 656d 6f72 7920  p and ws_memory 
+00039660: 3c20 7265 6369 7069 656e 745f 6d61 783a  < recipient_max:
+00039670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039680: 2023 2054 6869 7320 6d61 7920 7365 6e64   # This may send
+00039690: 2074 6865 2077 6f72 6b65 7220 6162 6f76   the worker abov
+000396a0: 6520 7265 6369 7069 656e 745f 6d61 7820  e recipient_max 
+000396b0: 2862 7920 6465 7369 676e 290a 2020 2020  (by design).    
+000396c0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
+000396d0: 6279 7465 735f 6d61 7820 3d20 7773 5f6d  bytes_max = ws_m
+000396e0: 656d 6f72 7920 2d20 6d65 616e 5f6d 656d  emory - mean_mem
+000396f0: 6f72 7920 2023 206e 6567 6174 6976 650a  ory  # negative.
+00039700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039710: 7265 635f 6279 7465 735f 6d69 6e20 3d20  rec_bytes_min = 
+00039720: 7265 635f 6279 7465 735f 6d61 7820 2b20  rec_bytes_max + 
+00039730: 6861 6c66 5f67 6170 2020 2320 6e65 6761  half_gap  # nega
+00039740: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
+00039750: 2020 2020 2023 2053 6565 2064 6566 696e       # See defin
+00039760: 6974 696f 6e20 6f66 2072 6563 6970 6965  ition of recipie
+00039770: 6e74 7320 6162 6f76 650a 2020 2020 2020  nts above.      
+00039780: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
+00039790: 656e 7473 2e61 7070 656e 6428 2872 6563  ents.append((rec
+000397a0: 5f62 7974 6573 5f6d 6178 2c20 7265 635f  _bytes_max, rec_
+000397b0: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
+000397c0: 292c 2077 7329 290a 0a20 2020 2020 2020  ), ws))..       
+000397d0: 2023 2046 6173 7420 6578 6974 2069 6e20   # Fast exit in 
+000397e0: 6361 7365 206e 6f20 7472 616e 7366 6572  case no transfer
+000397f0: 7320 6172 6520 6e65 6365 7373 6172 7920  s are necessary 
+00039800: 6f72 2070 6f73 7369 626c 650a 2020 2020  or possible.    
+00039810: 2020 2020 6966 206e 6f74 2073 656e 6465      if not sende
+00039820: 7273 206f 7220 6e6f 7420 7265 6369 7069  rs or not recipi
+00039830: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+00039840: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00039850: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039860: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
+00039870: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00039880: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00039890: 6163 7469 6f6e 223a 2022 7265 6261 6c61  action": "rebala
+000398a0: 6e63 6522 2c0a 2020 2020 2020 2020 2020  nce",.          
+000398b0: 2020 2020 2020 2020 2020 2273 656e 6465            "sende
+000398c0: 7273 223a 206c 656e 2873 656e 6465 7273  rs": len(senders
+000398d0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000398e0: 2020 2020 2020 2022 7265 6369 7069 656e         "recipien
+000398f0: 7473 223a 206c 656e 2872 6563 6970 6965  ts": len(recipie
+00039900: 6e74 7329 2c0a 2020 2020 2020 2020 2020  nts),.          
+00039910: 2020 2020 2020 2020 2020 226d 6f76 6564            "moved
+00039920: 5f6b 6579 7322 3a20 302c 0a20 2020 2020  _keys": 0,.     
+00039930: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
+00039940: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00039950: 2020 2020 2020 2020 7265 7475 726e 205b          return [
+00039960: 5d0a 0a20 2020 2020 2020 2068 6561 7071  ]..        heapq
+00039970: 2e68 6561 7069 6679 2873 656e 6465 7273  .heapify(senders
+00039980: 290a 2020 2020 2020 2020 6865 6170 712e  ).        heapq.
+00039990: 6865 6170 6966 7928 7265 6369 7069 656e  heapify(recipien
+000399a0: 7473 290a 0a20 2020 2020 2020 2077 6869  ts)..        whi
+000399b0: 6c65 2073 656e 6465 7273 2061 6e64 2072  le senders and r
+000399c0: 6563 6970 6965 6e74 733a 0a20 2020 2020  ecipients:.     
+000399d0: 2020 2020 2020 2073 6e64 5f62 7974 6573         snd_bytes
+000399e0: 5f6d 6178 2c20 736e 645f 6279 7465 735f  _max, snd_bytes_
+000399f0: 6d69 6e2c 205f 2c20 736e 645f 7773 2c20  min, _, snd_ws, 
+00039a00: 7473 5f69 7465 7220 3d20 7365 6e64 6572  ts_iter = sender
+00039a10: 735b 305d 0a0a 2020 2020 2020 2020 2020  s[0]..          
+00039a20: 2020 2320 4974 6572 6174 6520 7468 726f    # Iterate thro
+00039a30: 7567 6820 7461 736b 7320 696e 206d 656d  ugh tasks in mem
+00039a40: 6f72 792c 206c 6561 7374 2072 6563 656e  ory, least recen
+00039a50: 746c 7920 696e 7365 7274 6564 2066 6972  tly inserted fir
+00039a60: 7374 0a20 2020 2020 2020 2020 2020 2066  st.            f
+00039a70: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
+00039a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039a90: 2020 6966 206b 6579 7320 6973 206e 6f74    if keys is not
+00039aa0: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
+00039ab0: 206e 6f74 2069 6e20 6b65 7973 3a0a 2020   not in keys:.  
 00039ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039ad0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-00039ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039af0: 2075 7365 5f72 6563 6970 6965 6e74 203d   use_recipient =
-00039b00: 2074 7320 6e6f 7420 696e 2072 6563 5f77   ts not in rec_w
-00039b10: 732e 5f68 6173 5f77 6861 740a 2020 2020  s._has_what.    
-00039b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039b30: 6966 206e 6f74 2075 7365 5f72 6563 6970  if not use_recip
-00039b40: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
-00039b50: 2020 2020 2020 2020 2020 2020 2020 736b                sk
-00039b60: 6970 7065 645f 7265 6369 7069 656e 7473  ipped_recipients
-00039b70: 2e61 7070 656e 6428 6865 6170 712e 6865  .append(heapq.he
-00039b80: 6170 706f 7028 7265 6369 7069 656e 7473  appop(recipients
-00039b90: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00039ba0: 2020 2020 666f 7220 7265 6369 7069 656e      for recipien
-00039bb0: 7420 696e 2073 6b69 7070 6564 5f72 6563  t in skipped_rec
-00039bc0: 6970 6965 6e74 733a 0a20 2020 2020 2020  ipients:.       
-00039bd0: 2020 2020 2020 2020 2020 2020 2068 6561               hea
-00039be0: 7071 2e68 6561 7070 7573 6828 7265 6369  pq.heappush(reci
-00039bf0: 7069 656e 7473 2c20 7265 6369 7069 656e  pients, recipien
-00039c00: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00039c10: 2020 2020 6966 206e 6f74 2075 7365 5f72      if not use_r
-00039c20: 6563 6970 6965 6e74 3a0a 2020 2020 2020  ecipient:.      
-00039c30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00039c40: 5468 6973 2074 6173 6b20 6861 7320 6e6f  This task has no
-00039c50: 2072 6563 6970 6965 6e74 7320 6176 6169   recipients avai
-00039c60: 6c61 626c 652e 204c 6561 7665 2069 7420  lable. Leave it 
-00039c70: 6f6e 2074 6865 2073 656e 6465 7220 616e  on the sender an
-00039c80: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00039c90: 2020 2020 2020 2320 6d6f 7665 206f 6e20        # move on 
-00039ca0: 746f 2074 6865 206e 6578 7420 7461 736b  to the next task
-00039cb0: 206f 6620 7468 6520 7361 6d65 2073 656e   of the same sen
-00039cc0: 6465 722e 0a20 2020 2020 2020 2020 2020  der..           
-00039cd0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
-00039ce0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
-00039cf0: 2020 2023 2053 6368 6564 756c 6520 7461     # Schedule ta
-00039d00: 736b 2066 6f72 2074 7261 6e73 6665 7220  sk for transfer 
-00039d10: 6672 6f6d 2073 656e 6465 7220 746f 2072  from sender to r
-00039d20: 6563 6970 6965 6e74 0a20 2020 2020 2020  ecipient.       
-00039d30: 2020 2020 2020 2020 206d 7367 732e 6170           msgs.ap
-00039d40: 7065 6e64 2828 736e 645f 7773 2c20 7265  pend((snd_ws, re
-00039d50: 635f 7773 2c20 7473 2929 0a0a 2020 2020  c_ws, ts))..    
-00039d60: 2020 2020 2020 2020 2020 2020 2320 2a5f              # *_
-00039d70: 6279 7465 735f 6d61 782f 6d69 6e20 6172  bytes_max/min ar
-00039d80: 6520 616c 6c20 6e65 6761 7469 7665 2066  e all negative f
-00039d90: 6f72 2068 6561 7020 736f 7274 696e 670a  or heap sorting.
-00039da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039db0: 736e 645f 6279 7465 735f 6d61 7820 2b3d  snd_bytes_max +=
-00039dc0: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
-00039dd0: 2020 2020 2020 2020 736e 645f 6279 7465          snd_byte
-00039de0: 735f 6d69 6e20 2b3d 206e 6279 7465 730a  s_min += nbytes.
-00039df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039e00: 7265 635f 6279 7465 735f 6d61 7820 2b3d  rec_bytes_max +=
-00039e10: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
-00039e20: 2020 2020 2020 2020 7265 635f 6279 7465          rec_byte
-00039e30: 735f 6d69 6e20 2b3d 206e 6279 7465 730a  s_min += nbytes.
-00039e40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039e50: 2023 2053 746f 7020 6974 6572 6174 696e   # Stop iteratin
-00039e60: 6720 6f6e 2074 6865 2074 6173 6b73 206f  g on the tasks o
-00039e70: 6620 7468 6973 2073 656e 6465 7220 666f  f this sender fo
-00039e80: 7220 6e6f 7720 616e 642c 2069 6620 6974  r now and, if it
-00039e90: 2073 7469 6c6c 0a20 2020 2020 2020 2020   still.         
-00039ea0: 2020 2020 2020 2023 2068 6173 2062 7974         # has byt
-00039eb0: 6573 2074 6f20 6c6f 7365 2c20 7075 7368  es to lose, push
-00039ec0: 2069 7420 6261 636b 2069 6e74 6f20 7468   it back into th
-00039ed0: 6520 7365 6e64 6572 7320 6865 6170 3b20  e senders heap; 
-00039ee0: 6974 206d 6179 206f 7220 6d61 790a 2020  it may or may.  
-00039ef0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00039f00: 6e6f 7420 636f 6d65 2062 6163 6b20 6f6e  not come back on
-00039f10: 2074 6f70 2061 6761 696e 2e0a 2020 2020   top again..    
-00039f20: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00039f30: 6e64 5f62 7974 6573 5f6d 696e 203c 2030  nd_bytes_min < 0
-00039f40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00039f50: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
-00039f60: 6e69 7469 6f6e 206f 6620 7365 6e64 6572  nition of sender
-00039f70: 7320 6162 6f76 650a 2020 2020 2020 2020  s above.        
-00039f80: 2020 2020 2020 2020 2020 2020 6865 6170              heap
-00039f90: 712e 6865 6170 7265 706c 6163 6528 0a20  q.heapreplace(. 
-00039fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039fb0: 2020 2020 2020 2073 656e 6465 7273 2c0a         senders,.
-00039fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039fd0: 2020 2020 2020 2020 2873 6e64 5f62 7974          (snd_byt
-00039fe0: 6573 5f6d 6178 2c20 736e 645f 6279 7465  es_max, snd_byte
-00039ff0: 735f 6d69 6e2c 2069 6428 736e 645f 7773  s_min, id(snd_ws
-0003a000: 292c 2073 6e64 5f77 732c 2074 735f 6974  ), snd_ws, ts_it
-0003a010: 6572 292c 0a20 2020 2020 2020 2020 2020  er),.           
-0003a020: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003a030: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0003a040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a050: 2020 2020 2068 6561 7071 2e68 6561 7070       heapq.heapp
-0003a060: 6f70 2873 656e 6465 7273 290a 0a20 2020  op(senders)..   
-0003a070: 2020 2020 2020 2020 2020 2020 2023 2049               # I
-0003a080: 6620 7265 6369 7069 656e 7420 7374 696c  f recipient stil
-0003a090: 6c20 6861 7320 6279 7465 7320 746f 2067  l has bytes to g
-0003a0a0: 6169 6e2c 2070 7573 6820 6974 2062 6163  ain, push it bac
-0003a0b0: 6b20 696e 746f 2074 6865 2072 6563 6970  k into the recip
-0003a0c0: 6965 6e74 730a 2020 2020 2020 2020 2020  ients.          
-0003a0d0: 2020 2020 2020 2320 6865 6170 3b20 6974        # heap; it
-0003a0e0: 206d 6179 206f 7220 6d61 7920 6e6f 7420   may or may not 
-0003a0f0: 636f 6d65 2062 6163 6b20 6f6e 2074 6f70  come back on top
-0003a100: 2061 6761 696e 2e0a 2020 2020 2020 2020   again..        
-0003a110: 2020 2020 2020 2020 6966 2072 6563 5f62          if rec_b
-0003a120: 7974 6573 5f6d 696e 203c 2030 3a0a 2020  ytes_min < 0:.  
+00039ad0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00039ae0: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+00039af0: 7320 3d20 7473 2e6e 6279 7465 730a 2020  s = ts.nbytes.  
+00039b00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00039b10: 206e 6279 7465 7320 2b20 736e 645f 6279   nbytes + snd_by
+00039b20: 7465 735f 6d61 7820 3e20 303a 0a20 2020  tes_max > 0:.   
+00039b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b40: 2023 204d 6f76 696e 6720 7468 6973 2074   # Moving this t
+00039b50: 6173 6b20 776f 756c 6420 6361 7573 6520  ask would cause 
+00039b60: 7468 6520 7365 6e64 6572 2074 6f20 676f  the sender to go
+00039b70: 2062 656c 6f77 206d 6561 6e20 616e 640a   below mean and.
+00039b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039b90: 2020 2020 2320 706f 7465 6e74 6961 6c6c      # potentiall
+00039ba0: 7920 7269 736b 2062 6563 6f6d 696e 6720  y risk becoming 
+00039bb0: 6120 7265 6369 7069 656e 742c 2077 6869  a recipient, whi
+00039bc0: 6368 2077 6f75 6c64 2063 6175 7365 2074  ch would cause t
+00039bd0: 6173 6b73 2074 6f0a 2020 2020 2020 2020  asks to.        
+00039be0: 2020 2020 2020 2020 2020 2020 2320 626f              # bo
+00039bf0: 756e 6365 2061 726f 756e 642e 204d 6f76  unce around. Mov
+00039c00: 6520 6f6e 2074 6f20 7468 6520 6e65 7874  e on to the next
+00039c10: 2074 6173 6b20 6f66 2074 6865 2073 616d   task of the sam
+00039c20: 6520 7365 6e64 6572 2e0a 2020 2020 2020  e sender..      
+00039c30: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00039c40: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
+00039c50: 2020 2020 2020 2020 2320 4669 6e64 2074          # Find t
+00039c60: 6865 2072 6563 6970 6965 6e74 2c20 6661  he recipient, fa
+00039c70: 7274 6865 7374 2066 726f 6d20 7468 6520  rthest from the 
+00039c80: 6d65 616e 2c20 7768 6963 680a 2020 2020  mean, which.    
+00039c90: 2020 2020 2020 2020 2020 2020 2320 312e              # 1.
+00039ca0: 2068 6173 2065 6e6f 7567 6820 6176 6169   has enough avai
+00039cb0: 6c61 626c 6520 5241 4d20 666f 7220 7468  lable RAM for th
+00039cc0: 6973 2074 6173 6b2c 2061 6e64 0a20 2020  is task, and.   
+00039cd0: 2020 2020 2020 2020 2020 2020 2023 2032               # 2
+00039ce0: 2e20 646f 6573 6e27 7420 686f 6c64 2061  . doesn't hold a
+00039cf0: 2063 6f70 7920 6f66 2074 6869 7320 7461   copy of this ta
+00039d00: 736b 2061 6c72 6561 6479 0a20 2020 2020  sk already.     
+00039d10: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00039d20: 7265 206d 6179 206e 6f74 2062 6520 616e  re may not be an
+00039d30: 7920 7468 6174 2073 6174 6973 6669 6573  y that satisfies
+00039d40: 2074 6865 7365 2063 6f6e 6469 7469 6f6e   these condition
+00039d50: 733b 2069 6e20 7468 6973 2063 6173 650a  s; in this case.
+00039d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039d70: 2320 7468 6973 2074 6173 6b20 776f 6e27  # this task won'
+00039d80: 7420 6265 206d 6f76 6564 2e0a 2020 2020  t be moved..    
+00039d90: 2020 2020 2020 2020 2020 2020 736b 6970              skip
+00039da0: 7065 645f 7265 6369 7069 656e 7473 203d  ped_recipients =
+00039db0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00039dc0: 2020 2020 7573 655f 7265 6369 7069 656e      use_recipien
+00039dd0: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
+00039de0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
+00039df0: 7265 6369 7069 656e 7473 2061 6e64 206e  recipients and n
+00039e00: 6f74 2075 7365 5f72 6563 6970 6965 6e74  ot use_recipient
+00039e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039e20: 2020 2020 2020 7265 635f 6279 7465 735f        rec_bytes_
+00039e30: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
+00039e40: 696e 2c20 5f2c 2072 6563 5f77 7320 3d20  in, _, rec_ws = 
+00039e50: 7265 6369 7069 656e 7473 5b30 5d0a 2020  recipients[0].  
+00039e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039e70: 2020 6966 206e 6279 7465 7320 2b20 7265    if nbytes + re
+00039e80: 635f 6279 7465 735f 6d61 7820 3e20 303a  c_bytes_max > 0:
+00039e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039ea0: 2020 2020 2020 2020 2023 2072 6563 6970           # recip
+00039eb0: 6965 6e74 7320 6172 6520 736f 7274 6564  ients are sorted
+00039ec0: 2062 7920 7265 635f 6279 7465 735f 6d61   by rec_bytes_ma
+00039ed0: 782e 0a20 2020 2020 2020 2020 2020 2020  x..             
+00039ee0: 2020 2020 2020 2020 2020 2023 2054 6865             # The
+00039ef0: 206e 6578 7420 6f6e 6573 2077 696c 6c20   next ones will 
+00039f00: 6265 2077 6f72 7365 3b20 6e6f 2072 6561  be worse; no rea
+00039f10: 736f 6e20 746f 2063 6f6e 7469 6e75 6520  son to continue 
+00039f20: 6974 6572 6174 696e 670a 2020 2020 2020  iterating.      
+00039f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039f40: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00039f50: 2020 2020 2020 2020 2020 2020 7573 655f              use_
+00039f60: 7265 6369 7069 656e 7420 3d20 7473 206e  recipient = ts n
+00039f70: 6f74 2069 6e20 7265 635f 7773 2e5f 6861  ot in rec_ws._ha
+00039f80: 735f 7768 6174 0a20 2020 2020 2020 2020  s_what.         
+00039f90: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00039fa0: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
+00039fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039fc0: 2020 2020 2020 2020 2073 6b69 7070 6564           skipped
+00039fd0: 5f72 6563 6970 6965 6e74 732e 6170 7065  _recipients.appe
+00039fe0: 6e64 2868 6561 7071 2e68 6561 7070 6f70  nd(heapq.heappop
+00039ff0: 2872 6563 6970 6965 6e74 7329 290a 0a20  (recipients)).. 
+0003a000: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003a010: 6f72 2072 6563 6970 6965 6e74 2069 6e20  or recipient in 
+0003a020: 736b 6970 7065 645f 7265 6369 7069 656e  skipped_recipien
+0003a030: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+0003a040: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
+0003a050: 6170 7075 7368 2872 6563 6970 6965 6e74  appush(recipient
+0003a060: 732c 2072 6563 6970 6965 6e74 290a 0a20  s, recipient).. 
+0003a070: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003a080: 6620 6e6f 7420 7573 655f 7265 6369 7069  f not use_recipi
+0003a090: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+0003a0a0: 2020 2020 2020 2020 2023 2054 6869 7320           # This 
+0003a0b0: 7461 736b 2068 6173 206e 6f20 7265 6369  task has no reci
+0003a0c0: 7069 656e 7473 2061 7661 696c 6162 6c65  pients available
+0003a0d0: 2e20 4c65 6176 6520 6974 206f 6e20 7468  . Leave it on th
+0003a0e0: 6520 7365 6e64 6572 2061 6e64 0a20 2020  e sender and.   
+0003a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a100: 2023 206d 6f76 6520 6f6e 2074 6f20 7468   # move on to th
+0003a110: 6520 6e65 7874 2074 6173 6b20 6f66 2074  e next task of t
+0003a120: 6865 2073 616d 6520 7365 6e64 6572 2e0a  he same sender..
 0003a130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a140: 2020 2320 5365 6520 6465 6669 6e69 7469    # See definiti
-0003a150: 6f6e 206f 6620 7265 6369 7069 656e 7473  on of recipients
-0003a160: 2061 626f 7665 0a20 2020 2020 2020 2020   above.         
-0003a170: 2020 2020 2020 2020 2020 2068 6561 7071             heapq
-0003a180: 2e68 6561 7072 6570 6c61 6365 280a 2020  .heapreplace(.  
-0003a190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a1a0: 2020 2020 2020 7265 6369 7069 656e 7473        recipients
-0003a1b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003a1c0: 2020 2020 2020 2020 2020 2872 6563 5f62            (rec_b
-0003a1d0: 7974 6573 5f6d 6178 2c20 7265 635f 6279  ytes_max, rec_by
-0003a1e0: 7465 735f 6d69 6e2c 2069 6428 7265 635f  tes_min, id(rec_
-0003a1f0: 7773 292c 2072 6563 5f77 7329 2c0a 2020  ws), rec_ws),.  
-0003a200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a210: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003a220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003a230: 2020 2020 2020 2020 2020 2020 2020 6865                he
-0003a240: 6170 712e 6865 6170 706f 7028 7265 6369  apq.heappop(reci
-0003a250: 7069 656e 7473 290a 0a20 2020 2020 2020  pients)..       
-0003a260: 2020 2020 2020 2020 2023 204d 6f76 6520           # Move 
-0003a270: 746f 206e 6578 7420 7365 6e64 6572 2077  to next sender w
-0003a280: 6974 6820 7468 6520 6d6f 7374 2064 6174  ith the most dat
-0003a290: 6120 746f 206c 6f73 652e 0a20 2020 2020  a to lose..     
-0003a2a0: 2020 2020 2020 2020 2020 2023 2049 7420             # It 
-0003a2b0: 6d61 7920 6f72 206d 6179 206e 6f74 2062  may or may not b
-0003a2c0: 6520 7468 6520 7361 6d65 2073 656e 6465  e the same sende
-0003a2d0: 7220 6167 6169 6e2e 0a20 2020 2020 2020  r again..       
-0003a2e0: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
-0003a2f0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003a300: 3a20 2023 2066 6f72 2074 7320 696e 2074  :  # for ts in t
-0003a310: 735f 6974 6572 0a20 2020 2020 2020 2020  s_iter.         
-0003a320: 2020 2020 2020 2023 2045 7868 6175 7374         # Exhaust
-0003a330: 6564 2074 6173 6b73 206f 6e20 7468 6973  ed tasks on this
-0003a340: 2073 656e 6465 720a 2020 2020 2020 2020   sender.        
-0003a350: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
-0003a360: 6170 706f 7028 7365 6e64 6572 7329 0a0a  appop(senders)..
-0003a370: 2020 2020 2020 2020 7265 7475 726e 206d          return m
-0003a380: 7367 730a 0a20 2020 2061 7379 6e63 2064  sgs..    async d
-0003a390: 6566 205f 7265 6261 6c61 6e63 655f 6d6f  ef _rebalance_mo
-0003a3a0: 7665 5f64 6174 6128 0a20 2020 2020 2020  ve_data(.       
-0003a3b0: 2073 656c 662c 206d 7367 733a 2022 6c69   self, msgs: "li
-0003a3c0: 7374 5b74 7570 6c65 5b57 6f72 6b65 7253  st[tuple[WorkerS
-0003a3d0: 7461 7465 2c20 576f 726b 6572 5374 6174  tate, WorkerStat
-0003a3e0: 652c 2054 6173 6b53 7461 7465 5d5d 222c  e, TaskState]]",
-0003a3f0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-0003a400: 720a 2020 2020 2920 2d3e 2064 6963 743a  r.    ) -> dict:
-0003a410: 0a20 2020 2020 2020 2022 2222 5065 7266  .        """Perf
-0003a420: 6f72 6d20 7468 6520 6163 7475 616c 2074  orm the actual t
-0003a430: 7261 6e73 6665 7220 6f66 2064 6174 6120  ransfer of data 
-0003a440: 6163 726f 7373 2074 6865 206e 6574 776f  across the netwo
-0003a450: 726b 2069 6e20 7265 6261 6c61 6e63 6528  rk in rebalance(
-0003a460: 292e 0a20 2020 2020 2020 2054 616b 6573  )..        Takes
-0003a470: 2069 6e20 696e 7075 7420 7468 6520 6f75   in input the ou
-0003a480: 7470 7574 206f 6620 5f72 6562 616c 616e  tput of _rebalan
-0003a490: 6365 5f66 696e 645f 6d73 6773 2829 2c20  ce_find_msgs(), 
-0003a4a0: 7468 6174 2069 7320 6120 6c69 7374 206f  that is a list o
-0003a4b0: 6620 7475 706c 6573 3a0a 0a20 2020 2020  f tuples:..     
-0003a4c0: 2020 202d 2073 656e 6465 7220 776f 726b     - sender work
-0003a4d0: 6572 0a20 2020 2020 2020 202d 2072 6563  er.        - rec
-0003a4e0: 6970 6965 6e74 2077 6f72 6b65 720a 2020  ipient worker.  
-0003a4f0: 2020 2020 2020 2d20 7461 736b 2074 6f20        - task to 
-0003a500: 6265 2074 7261 6e73 6665 7272 6564 0a0a  be transferred..
-0003a510: 2020 2020 2020 2020 4649 584d 4520 7468          FIXME th
-0003a520: 6973 206d 6574 686f 6420 6973 206e 6f74  is method is not
-0003a530: 2072 6f62 7573 7420 7768 656e 2074 6865   robust when the
-0003a540: 2063 6c75 7374 6572 2069 7320 6e6f 7420   cluster is not 
-0003a550: 6964 6c65 2e0a 2020 2020 2020 2020 2222  idle..        ""
-0003a560: 220a 2020 2020 2020 2020 746f 5f72 6563  ".        to_rec
-0003a570: 6970 6965 6e74 733a 2064 6566 6175 6c74  ipients: default
-0003a580: 6469 6374 5b73 7472 2c20 6465 6661 756c  dict[str, defaul
-0003a590: 7464 6963 745b 7374 722c 206c 6973 745b  tdict[str, list[
-0003a5a0: 7374 725d 5d5d 203d 2064 6566 6175 6c74  str]]] = default
-0003a5b0: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-0003a5c0: 2020 6c61 6d62 6461 3a20 6465 6661 756c    lambda: defaul
-0003a5d0: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
-0003a5e0: 2020 2020 290a 2020 2020 2020 2020 666f      ).        fo
-0003a5f0: 7220 736e 645f 7773 2c20 7265 635f 7773  r snd_ws, rec_ws
-0003a600: 2c20 7473 2069 6e20 6d73 6773 3a0a 2020  , ts in msgs:.  
-0003a610: 2020 2020 2020 2020 2020 746f 5f72 6563            to_rec
-0003a620: 6970 6965 6e74 735b 7265 635f 7773 2e61  ipients[rec_ws.a
-0003a630: 6464 7265 7373 5d5b 7473 2e6b 6579 5d2e  ddress][ts.key].
-0003a640: 6170 7065 6e64 2873 6e64 5f77 732e 6164  append(snd_ws.ad
-0003a650: 6472 6573 7329 0a20 2020 2020 2020 2066  dress).        f
-0003a660: 6169 6c65 645f 6b65 7973 5f62 795f 7265  ailed_keys_by_re
-0003a670: 6369 7069 656e 7420 3d20 6469 6374 280a  cipient = dict(.
-0003a680: 2020 2020 2020 2020 2020 2020 7a69 7028              zip(
-0003a690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a6a0: 2074 6f5f 7265 6369 7069 656e 7473 2c0a   to_recipients,.
-0003a6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6c0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-0003a6d0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-0003a6e0: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
-0003a6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a700: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
-0003a710: 7320 6e65 7665 7220 7261 6973 6573 2065  s never raises e
-0003a720: 7863 6570 7469 6f6e 730a 2020 2020 2020  xceptions.      
-0003a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a740: 2020 7365 6c66 2e67 6174 6865 725f 6f6e    self.gather_on
-0003a750: 5f77 6f72 6b65 7228 772c 2077 686f 5f68  _worker(w, who_h
-0003a760: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
-0003a770: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0003a780: 772c 2077 686f 5f68 6173 2069 6e20 746f  w, who_has in to
-0003a790: 5f72 6563 6970 6965 6e74 732e 6974 656d  _recipients.item
-0003a7a0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-0003a7b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0003a7c0: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-0003a7d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003a7e0: 2020 2029 0a0a 2020 2020 2020 2020 746f     )..        to
-0003a7f0: 5f73 656e 6465 7273 203d 2064 6566 6175  _senders = defau
-0003a800: 6c74 6469 6374 286c 6973 7429 0a20 2020  ltdict(list).   
-0003a810: 2020 2020 2066 6f72 2073 6e64 5f77 732c       for snd_ws,
-0003a820: 2072 6563 5f77 732c 2074 7320 696e 206d   rec_ws, ts in m
-0003a830: 7367 733a 0a20 2020 2020 2020 2020 2020  sgs:.           
-0003a840: 2069 6620 7473 2e6b 6579 206e 6f74 2069   if ts.key not i
-0003a850: 6e20 6661 696c 6564 5f6b 6579 735f 6279  n failed_keys_by
-0003a860: 5f72 6563 6970 6965 6e74 5b72 6563 5f77  _recipient[rec_w
-0003a870: 732e 6164 6472 6573 735d 3a0a 2020 2020  s.address]:.    
-0003a880: 2020 2020 2020 2020 2020 2020 746f 5f73              to_s
-0003a890: 656e 6465 7273 5b73 6e64 5f77 732e 6164  enders[snd_ws.ad
-0003a8a0: 6472 6573 735d 2e61 7070 656e 6428 7473  dress].append(ts
-0003a8b0: 2e6b 6579 290a 0a20 2020 2020 2020 2023  .key)..        #
-0003a8c0: 204e 6f74 653a 2074 6869 7320 6e65 7665   Note: this neve
-0003a8d0: 7220 7261 6973 6573 2065 7863 6570 7469  r raises excepti
-0003a8e0: 6f6e 730a 2020 2020 2020 2020 6177 6169  ons.        awai
-0003a8f0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0003a900: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-0003a910: 7365 6c66 2e64 656c 6574 655f 776f 726b  self.delete_work
-0003a920: 6572 5f64 6174 6128 722c 2076 2c20 7374  er_data(r, v, st
-0003a930: 696d 756c 7573 5f69 6429 2066 6f72 2072  imulus_id) for r
-0003a940: 2c20 7620 696e 2074 6f5f 7365 6e64 6572  , v in to_sender
-0003a950: 732e 6974 656d 7328 2929 0a20 2020 2020  s.items()).     
-0003a960: 2020 2029 0a0a 2020 2020 2020 2020 666f     )..        fo
-0003a970: 7220 722c 2076 2069 6e20 746f 5f72 6563  r r, v in to_rec
-0003a980: 6970 6965 6e74 732e 6974 656d 7328 293a  ipients.items():
-0003a990: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0003a9a0: 662e 6c6f 675f 6576 656e 7428 722c 207b  f.log_event(r, {
-0003a9b0: 2261 6374 696f 6e22 3a20 2272 6562 616c  "action": "rebal
-0003a9c0: 616e 6365 222c 2022 7768 6f5f 6861 7322  ance", "who_has"
-0003a9d0: 3a20 767d 290a 2020 2020 2020 2020 7365  : v}).        se
-0003a9e0: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
-0003a9f0: 2020 2020 2020 2020 2020 2261 6c6c 222c            "all",
-0003aa00: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-0003aa10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003aa20: 6163 7469 6f6e 223a 2022 7265 6261 6c61  action": "rebala
-0003aa30: 6e63 6522 2c0a 2020 2020 2020 2020 2020  nce",.          
-0003aa40: 2020 2020 2020 2273 656e 6465 7273 223a        "senders":
-0003aa50: 2076 616c 6d61 7028 6c65 6e2c 2074 6f5f   valmap(len, to_
-0003aa60: 7365 6e64 6572 7329 2c0a 2020 2020 2020  senders),.      
-0003aa70: 2020 2020 2020 2020 2020 2272 6563 6970            "recip
-0003aa80: 6965 6e74 7322 3a20 7661 6c6d 6170 286c  ients": valmap(l
-0003aa90: 656e 2c20 746f 5f72 6563 6970 6965 6e74  en, to_recipient
-0003aaa0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0003aab0: 2020 2020 226d 6f76 6564 5f6b 6579 7322      "moved_keys"
-0003aac0: 3a20 6c65 6e28 6d73 6773 292c 0a20 2020  : len(msgs),.   
-0003aad0: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
-0003aae0: 2020 2020 290a 0a20 2020 2020 2020 206d      )..        m
-0003aaf0: 6973 7369 6e67 5f6b 6579 7320 3d20 7b6b  issing_keys = {k
-0003ab00: 2066 6f72 2072 2069 6e20 6661 696c 6564   for r in failed
-0003ab10: 5f6b 6579 735f 6279 5f72 6563 6970 6965  _keys_by_recipie
-0003ab20: 6e74 2e76 616c 7565 7328 2920 666f 7220  nt.values() for 
-0003ab30: 6b20 696e 2072 7d0a 2020 2020 2020 2020  k in r}.        
-0003ab40: 6966 206d 6973 7369 6e67 5f6b 6579 733a  if missing_keys:
-0003ab50: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003ab60: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
-0003ab70: 7061 7274 6961 6c2d 6661 696c 222c 2022  partial-fail", "
-0003ab80: 6b65 7973 223a 206c 6973 7428 6d69 7373  keys": list(miss
-0003ab90: 696e 675f 6b65 7973 297d 0a20 2020 2020  ing_keys)}.     
-0003aba0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003abb0: 2020 2020 2072 6574 7572 6e20 7b22 7374       return {"st
-0003abc0: 6174 7573 223a 2022 4f4b 227d 0a0a 2020  atus": "OK"}..  
-0003abd0: 2020 6173 796e 6320 6465 6620 7265 706c    async def repl
-0003abe0: 6963 6174 6528 0a20 2020 2020 2020 2073  icate(.        s
-0003abf0: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
-0003ac00: 6d3d 4e6f 6e65 2c0a 2020 2020 2020 2020  m=None,.        
-0003ac10: 6b65 7973 3d4e 6f6e 652c 0a20 2020 2020  keys=None,.     
-0003ac20: 2020 206e 3d4e 6f6e 652c 0a20 2020 2020     n=None,.     
-0003ac30: 2020 2077 6f72 6b65 7273 3d4e 6f6e 652c     workers=None,
-0003ac40: 0a20 2020 2020 2020 2062 7261 6e63 6869  .        branchi
-0003ac50: 6e67 5f66 6163 746f 723d 322c 0a20 2020  ng_factor=2,.   
-0003ac60: 2020 2020 2064 656c 6574 653d 5472 7565       delete=True
-0003ac70: 2c0a 2020 2020 2020 2020 6c6f 636b 3d54  ,.        lock=T
-0003ac80: 7275 652c 0a20 2020 2020 2020 2073 7469  rue,.        sti
-0003ac90: 6d75 6c75 735f 6964 3d4e 6f6e 652c 0a20  mulus_id=None,. 
-0003aca0: 2020 2029 3a0a 2020 2020 2020 2020 2222     ):.        ""
-0003acb0: 2252 6570 6c69 6361 7465 2064 6174 6120  "Replicate data 
-0003acc0: 7468 726f 7567 686f 7574 2063 6c75 7374  throughout clust
-0003acd0: 6572 0a0a 2020 2020 2020 2020 5468 6973  er..        This
-0003ace0: 2070 6572 666f 726d 7320 6120 7472 6565   performs a tree
-0003acf0: 2063 6f70 7920 6f66 2074 6865 2064 6174   copy of the dat
-0003ad00: 6120 7468 726f 7567 686f 7574 2074 6865  a throughout the
-0003ad10: 206e 6574 776f 726b 0a20 2020 2020 2020   network.       
-0003ad20: 2069 6e64 6976 6964 7561 6c6c 7920 6f6e   individually on
-0003ad30: 2065 6163 6820 7069 6563 6520 6f66 2064   each piece of d
-0003ad40: 6174 612e 0a0a 2020 2020 2020 2020 5061  ata...        Pa
-0003ad50: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0003ad60: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0003ad70: 2020 2020 6b65 7973 3a20 4974 6572 6162      keys: Iterab
-0003ad80: 6c65 0a20 2020 2020 2020 2020 2020 206c  le.            l
-0003ad90: 6973 7420 6f66 206b 6579 7320 746f 2072  ist of keys to r
-0003ada0: 6570 6c69 6361 7465 0a20 2020 2020 2020  eplicate.       
-0003adb0: 206e 3a20 696e 740a 2020 2020 2020 2020   n: int.        
-0003adc0: 2020 2020 4e75 6d62 6572 206f 6620 7265      Number of re
-0003add0: 706c 6963 6174 696f 6e73 2077 6520 6578  plications we ex
-0003ade0: 7065 6374 2074 6f20 7365 6520 7769 7468  pect to see with
-0003adf0: 696e 2074 6865 2063 6c75 7374 6572 0a20  in the cluster. 
-0003ae00: 2020 2020 2020 2062 7261 6e63 6869 6e67         branching
-0003ae10: 5f66 6163 746f 723a 2069 6e74 2c20 6f70  _factor: int, op
-0003ae20: 7469 6f6e 616c 0a20 2020 2020 2020 2020  tional.         
-0003ae30: 2020 2054 6865 206e 756d 6265 7220 6f66     The number of
-0003ae40: 2077 6f72 6b65 7273 2074 6861 7420 6361   workers that ca
-0003ae50: 6e20 636f 7079 2064 6174 6120 696e 2065  n copy data in e
-0003ae60: 6163 6820 6765 6e65 7261 7469 6f6e 2e0a  ach generation..
-0003ae70: 2020 2020 2020 2020 2020 2020 5468 6520              The 
-0003ae80: 6c61 7267 6572 2074 6865 2062 7261 6e63  larger the branc
-0003ae90: 6869 6e67 2066 6163 746f 722c 2074 6865  hing factor, the
-0003aea0: 206d 6f72 6520 6461 7461 2077 6520 636f   more data we co
-0003aeb0: 7079 2069 6e0a 2020 2020 2020 2020 2020  py in.          
-0003aec0: 2020 6120 7369 6e67 6c65 2073 7465 702c    a single step,
-0003aed0: 2062 7574 2074 6865 206d 6f72 6520 6120   but the more a 
-0003aee0: 6769 7665 6e20 776f 726b 6572 2072 6973  given worker ris
-0003aef0: 6b73 2062 6569 6e67 0a20 2020 2020 2020  ks being.       
-0003af00: 2020 2020 2073 7761 6d70 6564 2062 7920       swamped by 
-0003af10: 6461 7461 2072 6571 7565 7374 732e 0a0a  data requests...
-0003af20: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-0003af30: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003af40: 2d0a 2020 2020 2020 2020 5363 6865 6475  -.        Schedu
-0003af50: 6c65 722e 7265 6261 6c61 6e63 650a 2020  ler.rebalance.  
-0003af60: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003af70: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-0003af80: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-0003af90: 2272 6570 6c69 6361 7465 2d7b 7469 6d65  "replicate-{time
-0003afa0: 2829 7d22 0a20 2020 2020 2020 2061 7373  ()}".        ass
-0003afb0: 6572 7420 6272 616e 6368 696e 675f 6661  ert branching_fa
-0003afc0: 6374 6f72 203e 2030 0a20 2020 2020 2020  ctor > 0.       
-0003afd0: 2061 7379 6e63 2077 6974 6820 7365 6c66   async with self
-0003afe0: 2e5f 6c6f 636b 2069 6620 6c6f 636b 2065  ._lock if lock e
-0003aff0: 6c73 6520 656d 7074 795f 636f 6e74 6578  lse empty_contex
-0003b000: 743a 0a20 2020 2020 2020 2020 2020 2069  t:.            i
-0003b010: 6620 776f 726b 6572 7320 6973 206e 6f74  f workers is not
-0003b020: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003b030: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-0003b040: 207b 7365 6c66 2e77 6f72 6b65 7273 5b77   {self.workers[w
-0003b050: 5d20 666f 7220 7720 696e 2073 656c 662e  ] for w in self.
-0003b060: 776f 726b 6572 735f 6c69 7374 2877 6f72  workers_list(wor
-0003b070: 6b65 7273 297d 0a20 2020 2020 2020 2020  kers)}.         
-0003b080: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-0003b090: 207b 7773 2066 6f72 2077 7320 696e 2077   {ws for ws in w
-0003b0a0: 6f72 6b65 7273 2069 6620 7773 2e73 7461  orkers if ws.sta
-0003b0b0: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
-0003b0c0: 6e6e 696e 677d 0a20 2020 2020 2020 2020  nning}.         
-0003b0d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003b0e0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003b0f0: 203d 2073 656c 662e 7275 6e6e 696e 670a   = self.running.
-0003b100: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003b110: 6e20 6973 204e 6f6e 653a 0a20 2020 2020  n is None:.     
-0003b120: 2020 2020 2020 2020 2020 206e 203d 206c             n = l
-0003b130: 656e 2877 6f72 6b65 7273 290a 2020 2020  en(workers).    
-0003b140: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003b150: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
-0003b160: 3d20 6d69 6e28 6e2c 206c 656e 2877 6f72  = min(n, len(wor
-0003b170: 6b65 7273 2929 0a20 2020 2020 2020 2020  kers)).         
-0003b180: 2020 2069 6620 6e20 3d3d 2030 3a0a 2020     if n == 0:.  
-0003b190: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-0003b1a0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-0003b1b0: 4361 6e20 6e6f 7420 7573 6520 7265 706c  Can not use repl
-0003b1c0: 6963 6174 6520 746f 2064 656c 6574 6520  icate to delete 
-0003b1d0: 6461 7461 2229 0a0a 2020 2020 2020 2020  data")..        
-0003b1e0: 2020 2020 7461 736b 7320 3d20 7b73 656c      tasks = {sel
-0003b1f0: 662e 7461 736b 735b 6b5d 2066 6f72 206b  f.tasks[k] for k
-0003b200: 2069 6e20 6b65 7973 7d0a 2020 2020 2020   in keys}.      
-0003b210: 2020 2020 2020 6d69 7373 696e 675f 6461        missing_da
-0003b220: 7461 203d 205b 7473 2e6b 6579 2066 6f72  ta = [ts.key for
-0003b230: 2074 7320 696e 2074 6173 6b73 2069 6620   ts in tasks if 
-0003b240: 6e6f 7420 7473 2e77 686f 5f68 6173 5d0a  not ts.who_has].
-0003b250: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-0003b260: 6973 7369 6e67 5f64 6174 613a 0a20 2020  issing_data:.   
-0003b270: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0003b280: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
-0003b290: 7061 7274 6961 6c2d 6661 696c 222c 2022  partial-fail", "
-0003b2a0: 6b65 7973 223a 206d 6973 7369 6e67 5f64  keys": missing_d
-0003b2b0: 6174 617d 0a0a 2020 2020 2020 2020 2020  ata}..          
-0003b2c0: 2020 2320 4465 6c65 7465 2065 7874 7261    # Delete extra
-0003b2d0: 6e65 6f75 7320 6461 7461 0a20 2020 2020  neous data.     
-0003b2e0: 2020 2020 2020 2069 6620 6465 6c65 7465         if delete
-0003b2f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003b300: 2020 6465 6c5f 776f 726b 6572 5f74 6173    del_worker_tas
-0003b310: 6b73 203d 2064 6566 6175 6c74 6469 6374  ks = defaultdict
-0003b320: 2873 6574 290a 2020 2020 2020 2020 2020  (set).          
-0003b330: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0003b340: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
-0003b350: 2020 2020 2020 2020 2020 2064 656c 5f63             del_c
-0003b360: 616e 6469 6461 7465 7320 3d20 7475 706c  andidates = tupl
-0003b370: 6528 7473 2e77 686f 5f68 6173 2026 2077  e(ts.who_has & w
-0003b380: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
-0003b390: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0003b3a0: 656e 2864 656c 5f63 616e 6469 6461 7465  en(del_candidate
-0003b3b0: 7329 203e 206e 3a0a 2020 2020 2020 2020  s) > n:.        
-0003b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b3d0: 666f 7220 7773 2069 6e20 7261 6e64 6f6d  for ws in random
-0003b3e0: 2e73 616d 706c 6528 0a20 2020 2020 2020  .sample(.       
-0003b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b400: 2020 2020 2064 656c 5f63 616e 6469 6461       del_candida
-0003b410: 7465 732c 206c 656e 2864 656c 5f63 616e  tes, len(del_can
-0003b420: 6469 6461 7465 7329 202d 206e 0a20 2020  didates) - n.   
-0003b430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b440: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-0003b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b460: 2020 2020 6465 6c5f 776f 726b 6572 5f74      del_worker_t
-0003b470: 6173 6b73 5b77 735d 2e61 6464 2874 7329  asks[ws].add(ts)
-0003b480: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003b490: 2020 2320 4e6f 7465 3a20 7468 6973 206e    # Note: this n
-0003b4a0: 6576 6572 2072 6169 7365 7320 6578 6365  ever raises exce
-0003b4b0: 7074 696f 6e73 0a20 2020 2020 2020 2020  ptions.         
-0003b4c0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-0003b4d0: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
-0003b4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b4f0: 202a 5b0a 2020 2020 2020 2020 2020 2020   *[.            
-0003b500: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003b510: 2e64 656c 6574 655f 776f 726b 6572 5f64  .delete_worker_d
-0003b520: 6174 6128 0a20 2020 2020 2020 2020 2020  ata(.           
-0003b530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b540: 2077 732e 6164 6472 6573 732c 205b 742e   ws.address, [t.
-0003b550: 6b65 7920 666f 7220 7420 696e 2074 6173  key for t in tas
-0003b560: 6b73 5d2c 2073 7469 6d75 6c75 735f 6964  ks], stimulus_id
-0003b570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b580: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b5a0: 2020 2066 6f72 2077 732c 2074 6173 6b73     for ws, tasks
-0003b5b0: 2069 6e20 6465 6c5f 776f 726b 6572 5f74   in del_worker_t
-0003b5c0: 6173 6b73 2e69 7465 6d73 2829 0a20 2020  asks.items().   
-0003b5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b5e0: 205d 0a20 2020 2020 2020 2020 2020 2020   ].             
-0003b5f0: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0003b600: 2020 2320 436f 7079 206e 6f74 2d79 6574    # Copy not-yet
-0003b610: 2d66 696c 6c65 6420 6461 7461 0a20 2020  -filled data.   
-0003b620: 2020 2020 2020 2020 2077 6869 6c65 2074           while t
-0003b630: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
-0003b640: 2020 2020 2020 6761 7468 6572 7320 3d20        gathers = 
-0003b650: 6465 6661 756c 7464 6963 7428 6469 6374  defaultdict(dict
-0003b660: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003b670: 2020 666f 7220 7473 2069 6e20 6c69 7374    for ts in list
-0003b680: 2874 6173 6b73 293a 0a20 2020 2020 2020  (tasks):.       
-0003b690: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003b6a0: 7473 2e73 7461 7465 203d 3d20 2266 6f72  ts.state == "for
-0003b6b0: 676f 7474 656e 223a 0a20 2020 2020 2020  gotten":.       
-0003b6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b6d0: 2023 2074 6173 6b20 6973 206e 6f20 6c6f   # task is no lo
-0003b6e0: 6e67 6572 206e 6565 6465 6420 6279 2061  nger needed by a
-0003b6f0: 6e79 2063 6c69 656e 7420 6f72 2064 6570  ny client or dep
-0003b700: 656e 6465 6e74 2074 6173 6b0a 2020 2020  endent task.    
-0003b710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b720: 2020 2020 7461 736b 732e 7265 6d6f 7665      tasks.remove
-0003b730: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0003b740: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0003b750: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-0003b760: 2020 2020 2020 2020 2020 6e5f 6d69 7373            n_miss
-0003b770: 696e 6720 3d20 6e20 2d20 6c65 6e28 7473  ing = n - len(ts
-0003b780: 2e77 686f 5f68 6173 2026 2077 6f72 6b65  .who_has & worke
-0003b790: 7273 290a 2020 2020 2020 2020 2020 2020  rs).            
-0003b7a0: 2020 2020 2020 2020 6966 206e 5f6d 6973          if n_mis
-0003b7b0: 7369 6e67 203c 3d20 303a 0a20 2020 2020  sing <= 0:.     
-0003b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b7d0: 2020 2023 2041 6c72 6561 6479 2072 6570     # Already rep
-0003b7e0: 6c69 6361 7465 6420 656e 6f75 6768 0a20  licated enough. 
-0003b7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b800: 2020 2020 2020 2074 6173 6b73 2e72 656d         tasks.rem
-0003b810: 6f76 6528 7473 290a 2020 2020 2020 2020  ove(ts).        
-0003b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b830: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
-0003b840: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0003b850: 756e 7420 3d20 6d69 6e28 6e5f 6d69 7373  unt = min(n_miss
-0003b860: 696e 672c 2062 7261 6e63 6869 6e67 5f66  ing, branching_f
-0003b870: 6163 746f 7220 2a20 6c65 6e28 7473 2e77  actor * len(ts.w
-0003b880: 686f 5f68 6173 2929 0a20 2020 2020 2020  ho_has)).       
-0003b890: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0003b8a0: 6572 7420 636f 756e 7420 3e20 300a 0a20  ert count > 0.. 
-0003b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b8c0: 2020 2066 6f72 2077 7320 696e 2072 616e     for ws in ran
-0003b8d0: 646f 6d2e 7361 6d70 6c65 2874 7570 6c65  dom.sample(tuple
-0003b8e0: 2877 6f72 6b65 7273 202d 2074 732e 7768  (workers - ts.wh
-0003b8f0: 6f5f 6861 7329 2c20 636f 756e 7429 3a0a  o_has), count):.
-0003b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b910: 2020 2020 2020 2020 6761 7468 6572 735b          gathers[
-0003b920: 7773 2e61 6464 7265 7373 5d5b 7473 2e6b  ws.address][ts.k
-0003b930: 6579 5d20 3d20 5b0a 2020 2020 2020 2020  ey] = [.        
-0003b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b950: 2020 2020 7777 732e 6164 6472 6573 7320      wws.address 
-0003b960: 666f 7220 7777 7320 696e 2074 732e 7768  for wws in ts.wh
-0003b970: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-0003b980: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
-0003b990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003b9a0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-0003b9b0: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-0003b9c0: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
-0003b9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b9e0: 2020 2020 2020 2320 4e6f 7465 3a20 7468        # Note: th
-0003b9f0: 6973 206e 6576 6572 2072 6169 7365 7320  is never raises 
-0003ba00: 6578 6365 7074 696f 6e73 0a20 2020 2020  exceptions.     
-0003ba10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba20: 2020 2073 656c 662e 6761 7468 6572 5f6f     self.gather_o
-0003ba30: 6e5f 776f 726b 6572 2877 2c20 7768 6f5f  n_worker(w, who_
-0003ba40: 6861 7329 0a20 2020 2020 2020 2020 2020  has).           
-0003ba50: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003ba60: 2077 2c20 7768 6f5f 6861 7320 696e 2067   w, who_has in g
-0003ba70: 6174 6865 7273 2e69 7465 6d73 2829 0a20  athers.items(). 
-0003ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ba90: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0003baa0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0003bab0: 2020 2020 2020 2066 6f72 2072 2c20 7620         for r, v 
-0003bac0: 696e 2067 6174 6865 7273 2e69 7465 6d73  in gathers.items
-0003bad0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0003bae0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0003baf0: 5f65 7665 6e74 2872 2c20 7b22 6163 7469  _event(r, {"acti
-0003bb00: 6f6e 223a 2022 7265 706c 6963 6174 652d  on": "replicate-
-0003bb10: 6164 6422 2c20 2277 686f 5f68 6173 223a  add", "who_has":
-0003bb20: 2076 7d29 0a0a 2020 2020 2020 2020 2020   v})..          
-0003bb30: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-0003bb40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003bb50: 2020 2261 6c6c 222c 0a20 2020 2020 2020    "all",.       
-0003bb60: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-0003bb70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003bb80: 6163 7469 6f6e 223a 2022 7265 706c 6963  action": "replic
-0003bb90: 6174 6522 2c0a 2020 2020 2020 2020 2020  ate",.          
-0003bba0: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-0003bbb0: 7273 223a 206c 6973 7428 776f 726b 6572  rs": list(worker
-0003bbc0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0003bbd0: 2020 2020 2020 2020 226b 6579 2d63 6f75          "key-cou
-0003bbe0: 6e74 223a 206c 656e 286b 6579 7329 2c0a  nt": len(keys),.
-0003bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bc00: 2020 2020 2262 7261 6e63 6869 6e67 2d66      "branching-f
-0003bc10: 6163 746f 7222 3a20 6272 616e 6368 696e  actor": branchin
-0003bc20: 675f 6661 6374 6f72 2c0a 2020 2020 2020  g_factor,.      
-0003bc30: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0003bc40: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0003bc50: 6465 6620 776f 726b 6572 735f 746f 5f63  def workers_to_c
-0003bc60: 6c6f 7365 280a 2020 2020 2020 2020 7365  lose(.        se
-0003bc70: 6c66 2c0a 2020 2020 2020 2020 6d65 6d6f  lf,.        memo
-0003bc80: 7279 5f72 6174 696f 3a20 696e 7420 7c20  ry_ratio: int | 
-0003bc90: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
-0003bca0: 6f6e 652c 0a20 2020 2020 2020 206e 3a20  one,.        n: 
-0003bcb0: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-0003bcc0: 652c 0a20 2020 2020 2020 206b 6579 3a20  e,.        key: 
-0003bcd0: 4361 6c6c 6162 6c65 5b5b 576f 726b 6572  Callable[[Worker
-0003bce0: 5374 6174 655d 2c20 4861 7368 6162 6c65  State], Hashable
-0003bcf0: 5d20 7c20 6279 7465 7320 7c20 4e6f 6e65  ] | bytes | None
-0003bd00: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0003bd10: 206d 696e 696d 756d 3a20 696e 7420 7c20   minimum: int | 
-0003bd20: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-0003bd30: 2020 2020 2074 6172 6765 743a 2069 6e74       target: int
-0003bd40: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003bd50: 2020 2020 2020 2020 6174 7472 6962 7574          attribut
-0003bd60: 653a 2073 7472 203d 2022 6164 6472 6573  e: str = "addres
-0003bd70: 7322 2c0a 2020 2020 2920 2d3e 206c 6973  s",.    ) -> lis
-0003bd80: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
-0003bd90: 2222 220a 2020 2020 2020 2020 4669 6e64  """.        Find
-0003bda0: 2077 6f72 6b65 7273 2074 6861 7420 7765   workers that we
-0003bdb0: 2063 616e 2063 6c6f 7365 2077 6974 6820   can close with 
-0003bdc0: 6c6f 7720 636f 7374 0a0a 2020 2020 2020  low cost..      
-0003bdd0: 2020 5468 6973 2072 6574 7572 6e73 2061    This returns a
-0003bde0: 206c 6973 7420 6f66 2077 6f72 6b65 7273   list of workers
-0003bdf0: 2074 6861 7420 6172 6520 676f 6f64 2063   that are good c
-0003be00: 616e 6469 6461 7465 7320 746f 2072 6574  andidates to ret
-0003be10: 6972 652e 0a20 2020 2020 2020 2054 6865  ire..        The
-0003be20: 7365 2077 6f72 6b65 7273 2061 7265 206e  se workers are n
-0003be30: 6f74 2072 756e 6e69 6e67 2061 6e79 7468  ot running anyth
-0003be40: 696e 6720 616e 6420 6172 6520 7374 6f72  ing and are stor
-0003be50: 696e 670a 2020 2020 2020 2020 7265 6c61  ing.        rela
-0003be60: 7469 7665 6c79 206c 6974 746c 6520 6461  tively little da
-0003be70: 7461 2072 656c 6174 6976 6520 746f 2074  ta relative to t
-0003be80: 6865 6972 2070 6565 7273 2e20 2049 6620  heir peers.  If 
-0003be90: 616c 6c20 776f 726b 6572 7320 6172 650a  all workers are.
-0003bea0: 2020 2020 2020 2020 6964 6c65 2074 6865          idle the
-0003beb0: 6e20 7765 2073 7469 6c6c 206d 6169 6e74  n we still maint
-0003bec0: 6169 6e20 656e 6f75 6768 2077 6f72 6b65  ain enough worke
-0003bed0: 7273 2074 6f20 6861 7665 2065 6e6f 7567  rs to have enoug
-0003bee0: 6820 5241 4d20 746f 2073 746f 7265 0a20  h RAM to store. 
-0003bef0: 2020 2020 2020 206f 7572 2064 6174 612c         our data,
-0003bf00: 2077 6974 6820 6120 636f 6d66 6f72 7461   with a comforta
-0003bf10: 626c 6520 6275 6666 6572 2e0a 0a20 2020  ble buffer...   
-0003bf20: 2020 2020 2054 6869 7320 6973 2066 6f72       This is for
-0003bf30: 2075 7365 2077 6974 6820 7379 7374 656d   use with system
-0003bf40: 7320 6c69 6b65 2060 6064 6973 7472 6962  s like ``distrib
-0003bf50: 7574 6564 2e64 6570 6c6f 792e 6164 6170  uted.deploy.adap
-0003bf60: 7469 7665 6060 2e0a 0a20 2020 2020 2020  tive``...       
-0003bf70: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-0003bf80: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-0003bf90: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
-0003bfa0: 7469 6f20 3a20 4e75 6d62 6572 0a20 2020  tio : Number.   
-0003bfb0: 2020 2020 2020 2020 2041 6d6f 756e 7420           Amount 
-0003bfc0: 6f66 2065 7874 7261 2073 7061 6365 2077  of extra space w
-0003bfd0: 6520 7761 6e74 2074 6f20 6861 7665 2066  e want to have f
-0003bfe0: 6f72 206f 7572 2073 746f 7265 6420 6461  or our stored da
-0003bff0: 7461 2e0a 2020 2020 2020 2020 2020 2020  ta..            
-0003c000: 4465 6661 756c 7473 2074 6f20 322c 206f  Defaults to 2, o
-0003c010: 7220 7468 6174 2077 6520 7761 6e74 2074  r that we want t
-0003c020: 6f20 6861 7665 2074 7769 6365 2061 7320  o have twice as 
-0003c030: 6d75 6368 206d 656d 6f72 7920 6173 2077  much memory as w
-0003c040: 650a 2020 2020 2020 2020 2020 2020 6375  e.            cu
-0003c050: 7272 656e 746c 7920 6861 7665 2064 6174  rrently have dat
-0003c060: 612e 0a20 2020 2020 2020 206e 203a 2069  a..        n : i
-0003c070: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
-0003c080: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-0003c090: 2074 6f20 636c 6f73 650a 2020 2020 2020   to close.      
-0003c0a0: 2020 6d69 6e69 6d75 6d20 3a20 696e 740a    minimum : int.
-0003c0b0: 2020 2020 2020 2020 2020 2020 4d69 6e69              Mini
-0003c0c0: 6d75 6d20 6e75 6d62 6572 206f 6620 776f  mum number of wo
-0003c0d0: 726b 6572 7320 746f 206b 6565 7020 6172  rkers to keep ar
-0003c0e0: 6f75 6e64 0a20 2020 2020 2020 206b 6579  ound.        key
-0003c0f0: 203a 2043 616c 6c61 626c 6528 576f 726b   : Callable(Work
-0003c100: 6572 5374 6174 6529 0a20 2020 2020 2020  erState).       
-0003c110: 2020 2020 2041 6e20 6f70 7469 6f6e 616c       An optional
-0003c120: 2063 616c 6c61 626c 6520 6d61 7070 696e   callable mappin
-0003c130: 6720 6120 576f 726b 6572 5374 6174 6520  g a WorkerState 
-0003c140: 6f62 6a65 6374 2074 6f20 6120 6772 6f75  object to a grou
-0003c150: 700a 2020 2020 2020 2020 2020 2020 6166  p.            af
-0003c160: 6669 6c69 6174 696f 6e2e 2047 726f 7570  filiation. Group
-0003c170: 7320 7769 6c6c 2062 6520 636c 6f73 6564  s will be closed
-0003c180: 2074 6f67 6574 6865 722e 2054 6869 7320   together. This 
-0003c190: 6973 2075 7365 6675 6c20 7768 656e 0a20  is useful when. 
-0003c1a0: 2020 2020 2020 2020 2020 2063 6c6f 7369             closi
-0003c1b0: 6e67 2077 6f72 6b65 7273 206d 7573 7420  ng workers must 
-0003c1c0: 6265 2064 6f6e 6520 636f 6c6c 6563 7469  be done collecti
-0003c1d0: 7665 6c79 2c20 7375 6368 2061 7320 6279  vely, such as by
-0003c1e0: 2068 6f73 746e 616d 652e 0a20 2020 2020   hostname..     
-0003c1f0: 2020 2074 6172 6765 7420 3a20 696e 740a     target : int.
-0003c200: 2020 2020 2020 2020 2020 2020 5461 7267              Targ
-0003c210: 6574 206e 756d 6265 7220 6f66 2077 6f72  et number of wor
-0003c220: 6b65 7273 2074 6f20 6861 7665 2061 6674  kers to have aft
-0003c230: 6572 2077 6520 636c 6f73 650a 2020 2020  er we close.    
-0003c240: 2020 2020 6174 7472 6962 7574 6520 3a20      attribute : 
-0003c250: 7374 720a 2020 2020 2020 2020 2020 2020  str.            
-0003c260: 5468 6520 6174 7472 6962 7574 6520 6f66  The attribute of
-0003c270: 2074 6865 2057 6f72 6b65 7253 7461 7465   the WorkerState
-0003c280: 206f 626a 6563 7420 746f 2072 6574 7572   object to retur
-0003c290: 6e2c 206c 696b 6520 2261 6464 7265 7373  n, like "address
-0003c2a0: 220a 2020 2020 2020 2020 2020 2020 6f72  ".            or
-0003c2b0: 2022 6e61 6d65 222e 2020 4465 6661 756c   "name".  Defaul
-0003c2c0: 7473 2074 6f20 2261 6464 7265 7373 222e  ts to "address".
-0003c2d0: 0a0a 2020 2020 2020 2020 4578 616d 706c  ..        Exampl
-0003c2e0: 6573 0a20 2020 2020 2020 202d 2d2d 2d2d  es.        -----
-0003c2f0: 2d2d 2d0a 2020 2020 2020 2020 3e3e 3e20  ---.        >>> 
-0003c300: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-0003c310: 735f 746f 5f63 6c6f 7365 2829 0a20 2020  s_to_close().   
-0003c320: 2020 2020 205b 2774 6370 3a2f 2f31 3932       ['tcp://192
-0003c330: 2e31 3638 2e30 2e31 3a31 3233 3427 2c20  .168.0.1:1234', 
-0003c340: 2774 6370 3a2f 2f31 3932 2e31 3638 2e30  'tcp://192.168.0
-0003c350: 2e32 3a31 3233 3427 5d0a 0a20 2020 2020  .2:1234']..     
-0003c360: 2020 2047 726f 7570 2077 6f72 6b65 7273     Group workers
-0003c370: 2062 7920 686f 7374 6e61 6d65 2070 7269   by hostname pri
-0003c380: 6f72 2074 6f20 636c 6f73 696e 670a 0a20  or to closing.. 
-0003c390: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
-0003c3a0: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
-0003c3b0: 636c 6f73 6528 6b65 793d 6c61 6d62 6461  close(key=lambda
-0003c3c0: 2077 733a 2077 732e 686f 7374 290a 2020   ws: ws.host).  
-0003c3d0: 2020 2020 2020 5b27 7463 703a 2f2f 3139        ['tcp://19
-0003c3e0: 322e 3136 382e 302e 313a 3132 3334 272c  2.168.0.1:1234',
-0003c3f0: 2027 7463 703a 2f2f 3139 322e 3136 382e   'tcp://192.168.
-0003c400: 302e 313a 3435 3637 275d 0a0a 2020 2020  0.1:4567']..    
-0003c410: 2020 2020 5265 6d6f 7665 2074 776f 2077      Remove two w
-0003c420: 6f72 6b65 7273 0a0a 2020 2020 2020 2020  orkers..        
-0003c430: 3e3e 3e20 7363 6865 6475 6c65 722e 776f  >>> scheduler.wo
-0003c440: 726b 6572 735f 746f 5f63 6c6f 7365 286e  rkers_to_close(n
-0003c450: 3d32 290a 0a20 2020 2020 2020 204b 6565  =2)..        Kee
-0003c460: 7020 656e 6f75 6768 2077 6f72 6b65 7273  p enough workers
-0003c470: 2074 6f20 6861 7665 2074 7769 6365 2061   to have twice a
-0003c480: 7320 6d75 6368 206d 656d 6f72 7920 6173  s much memory as
-0003c490: 2077 6520 7765 206e 6565 642e 0a0a 2020   we we need...  
-0003c4a0: 2020 2020 2020 3e3e 3e20 7363 6865 6475        >>> schedu
-0003c4b0: 6c65 722e 776f 726b 6572 735f 746f 5f63  ler.workers_to_c
-0003c4c0: 6c6f 7365 286d 656d 6f72 795f 7261 7469  lose(memory_rati
-0003c4d0: 6f3d 3229 0a0a 2020 2020 2020 2020 5265  o=2)..        Re
-0003c4e0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-0003c4f0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 746f  -----.        to
-0003c500: 5f63 6c6f 7365 3a20 6c69 7374 206f 6620  _close: list of 
-0003c510: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
-0003c520: 2074 6861 7420 6172 6520 4f4b 2074 6f20   that are OK to 
-0003c530: 636c 6f73 650a 0a20 2020 2020 2020 2053  close..        S
-0003c540: 6565 2041 6c73 6f0a 2020 2020 2020 2020  ee Also.        
-0003c550: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
-0003c560: 2053 6368 6564 756c 6572 2e72 6574 6972   Scheduler.retir
-0003c570: 655f 776f 726b 6572 730a 2020 2020 2020  e_workers.      
-0003c580: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-0003c590: 2074 6172 6765 7420 6973 206e 6f74 204e   target is not N
-0003c5a0: 6f6e 6520 616e 6420 6e20 6973 204e 6f6e  one and n is Non
-0003c5b0: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
-0003c5c0: 203d 206c 656e 2873 656c 662e 776f 726b   = len(self.work
-0003c5d0: 6572 7329 202d 2074 6172 6765 740a 2020  ers) - target.  
-0003c5e0: 2020 2020 2020 6966 206e 2069 7320 6e6f        if n is no
-0003c5f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0003c600: 2020 2020 6966 206e 203c 2030 3a0a 2020      if n < 0:.  
-0003c610: 2020 2020 2020 2020 2020 2020 2020 6e20                n 
-0003c620: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-0003c630: 7461 7267 6574 203d 206c 656e 2873 656c  target = len(sel
-0003c640: 662e 776f 726b 6572 7329 202d 206e 0a0a  f.workers) - n..
-0003c650: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-0003c660: 4e6f 6e65 2061 6e64 206d 656d 6f72 795f  None and memory_
-0003c670: 7261 7469 6f20 6973 204e 6f6e 653a 0a20  ratio is None:. 
-0003c680: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-0003c690: 795f 7261 7469 6f20 3d20 320a 0a20 2020  y_ratio = 2..   
-0003c6a0: 2020 2020 2077 6974 6820 6c6f 675f 6572       with log_er
-0003c6b0: 726f 7273 2829 3a0a 2020 2020 2020 2020  rors():.        
-0003c6c0: 2020 2020 6966 206e 6f74 206e 2061 6e64      if not n and
-0003c6d0: 2061 6c6c 285b 7773 2e70 726f 6365 7373   all([ws.process
-0003c6e0: 696e 6720 666f 7220 7773 2069 6e20 7365  ing for ws in se
-0003c6f0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
-0003c700: 7328 295d 293a 0a20 2020 2020 2020 2020  s()]):.         
-0003c710: 2020 2020 2020 2072 6574 7572 6e20 5b5d         return []
-0003c720: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0003c730: 206b 6579 2069 7320 4e6f 6e65 3a0a 2020   key is None:.  
-0003c740: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-0003c750: 7920 3d20 6f70 6572 6174 6f72 2e61 7474  y = operator.att
-0003c760: 7267 6574 7465 7228 2261 6464 7265 7373  rgetter("address
-0003c770: 2229 0a20 2020 2020 2020 2020 2020 2069  ").            i
-0003c780: 6620 6973 696e 7374 616e 6365 286b 6579  f isinstance(key
-0003c790: 2c20 6279 7465 7329 2061 6e64 2064 6173  , bytes) and das
-0003c7a0: 6b2e 636f 6e66 6967 2e67 6574 280a 2020  k.config.get(.  
-0003c7b0: 2020 2020 2020 2020 2020 2020 2020 2264                "d
-0003c7c0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0003c7d0: 756c 6572 2e70 6963 6b6c 6522 0a20 2020  uler.pickle".   
-0003c7e0: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
-0003c7f0: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
-0003c800: 3d20 7069 636b 6c65 2e6c 6f61 6473 286b  = pickle.loads(k
-0003c810: 6579 290a 0a20 2020 2020 2020 2020 2020  ey)..           
-0003c820: 2067 726f 7570 7320 3d20 6772 6f75 7062   groups = groupb
-0003c830: 7928 6b65 792c 2073 656c 662e 776f 726b  y(key, self.work
-0003c840: 6572 732e 7661 6c75 6573 2829 290a 0a20  ers.values()).. 
-0003c850: 2020 2020 2020 2020 2020 206c 696d 6974             limit
-0003c860: 5f62 7974 6573 203d 207b 0a20 2020 2020  _bytes = {.     
-0003c870: 2020 2020 2020 2020 2020 206b 3a20 7375             k: su
-0003c880: 6d28 7773 2e6d 656d 6f72 795f 6c69 6d69  m(ws.memory_limi
-0003c890: 7420 666f 7220 7773 2069 6e20 7629 2066  t for ws in v) f
-0003c8a0: 6f72 206b 2c20 7620 696e 2067 726f 7570  or k, v in group
-0003c8b0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
-0003c8c0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003c8d0: 2020 2020 6772 6f75 705f 6279 7465 7320      group_bytes 
-0003c8e0: 3d20 7b6b 3a20 7375 6d28 7773 2e6e 6279  = {k: sum(ws.nby
-0003c8f0: 7465 7320 666f 7220 7773 2069 6e20 7629  tes for ws in v)
-0003c900: 2066 6f72 206b 2c20 7620 696e 2067 726f   for k, v in gro
-0003c910: 7570 732e 6974 656d 7328 297d 0a0a 2020  ups.items()}..  
-0003c920: 2020 2020 2020 2020 2020 6c69 6d69 7420            limit 
-0003c930: 3d20 7375 6d28 6c69 6d69 745f 6279 7465  = sum(limit_byte
-0003c940: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-0003c950: 2020 2020 2020 2020 746f 7461 6c20 3d20          total = 
-0003c960: 7375 6d28 6772 6f75 705f 6279 7465 732e  sum(group_bytes.
-0003c970: 7661 6c75 6573 2829 290a 0a20 2020 2020  values())..     
-0003c980: 2020 2020 2020 2064 6566 205f 6b65 7928         def _key(
-0003c990: 6772 6f75 7029 3a0a 2020 2020 2020 2020  group):.        
-0003c9a0: 2020 2020 2020 2020 6973 5f69 646c 6520          is_idle 
-0003c9b0: 3d20 6e6f 7420 616e 7928 5b77 7773 2e70  = not any([wws.p
-0003c9c0: 726f 6365 7373 696e 6720 666f 7220 7777  rocessing for ww
-0003c9d0: 7320 696e 2067 726f 7570 735b 6772 6f75  s in groups[grou
-0003c9e0: 705d 5d29 0a20 2020 2020 2020 2020 2020  p]]).           
-0003c9f0: 2020 2020 2062 7974 6573 203d 202d 6772       bytes = -gr
-0003ca00: 6f75 705f 6279 7465 735b 6772 6f75 705d  oup_bytes[group]
-0003ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ca20: 2072 6574 7572 6e20 6973 5f69 646c 652c   return is_idle,
-0003ca30: 2062 7974 6573 0a0a 2020 2020 2020 2020   bytes..        
-0003ca40: 2020 2020 6964 6c65 203d 2073 6f72 7465      idle = sorte
-0003ca50: 6428 6772 6f75 7073 2c20 6b65 793d 5f6b  d(groups, key=_k
-0003ca60: 6579 290a 0a20 2020 2020 2020 2020 2020  ey)..           
-0003ca70: 2074 6f5f 636c 6f73 6520 3d20 5b5d 0a20   to_close = []. 
-0003ca80: 2020 2020 2020 2020 2020 206e 5f72 656d             n_rem
-0003ca90: 6169 6e20 3d20 6c65 6e28 7365 6c66 2e77  ain = len(self.w
-0003caa0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-0003cab0: 2020 2020 2077 6869 6c65 2069 646c 653a       while idle:
-0003cac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cad0: 2067 726f 7570 203d 2069 646c 652e 706f   group = idle.po
-0003cae0: 7028 290a 2020 2020 2020 2020 2020 2020  p().            
-0003caf0: 2020 2020 6966 206e 2069 7320 4e6f 6e65      if n is None
-0003cb00: 2061 6e64 2061 6e79 285b 7773 2e70 726f   and any([ws.pro
-0003cb10: 6365 7373 696e 6720 666f 7220 7773 2069  cessing for ws i
-0003cb20: 6e20 6772 6f75 7073 5b67 726f 7570 5d5d  n groups[group]]
-0003cb30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003cb40: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-0003cb50: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003cb60: 206d 696e 696d 756d 2061 6e64 206e 5f72   minimum and n_r
-0003cb70: 656d 6169 6e20 2d20 6c65 6e28 6772 6f75  emain - len(grou
-0003cb80: 7073 5b67 726f 7570 5d29 203c 206d 696e  ps[group]) < min
-0003cb90: 696d 756d 3a0a 2020 2020 2020 2020 2020  imum:.          
-0003cba0: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-0003cbb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cbc0: 206c 696d 6974 202d 3d20 6c69 6d69 745f   limit -= limit_
-0003cbd0: 6279 7465 735b 6772 6f75 705d 0a0a 2020  bytes[group]..  
-0003cbe0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003cbf0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-0003cc00: 2020 2020 2020 206e 2069 7320 6e6f 7420         n is not 
-0003cc10: 4e6f 6e65 2061 6e64 206e 5f72 656d 6169  None and n_remai
-0003cc20: 6e20 2d20 6c65 6e28 6772 6f75 7073 5b67  n - len(groups[g
-0003cc30: 726f 7570 5d29 203e 3d20 2874 6172 6765  roup]) >= (targe
-0003cc40: 7420 6f72 2030 290a 2020 2020 2020 2020  t or 0).        
-0003cc50: 2020 2020 2020 2020 2920 6f72 2028 6d65          ) or (me
-0003cc60: 6d6f 7279 5f72 6174 696f 2069 7320 6e6f  mory_ratio is no
-0003cc70: 7420 4e6f 6e65 2061 6e64 206c 696d 6974  t None and limit
-0003cc80: 203e 3d20 6d65 6d6f 7279 5f72 6174 696f   >= memory_ratio
-0003cc90: 202a 2074 6f74 616c 293a 0a20 2020 2020   * total):.     
-0003cca0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003ccb0: 6f5f 636c 6f73 652e 6170 7065 6e64 2867  o_close.append(g
-0003ccc0: 726f 7570 290a 2020 2020 2020 2020 2020  roup).          
-0003ccd0: 2020 2020 2020 2020 2020 6e5f 7265 6d61            n_rema
-0003cce0: 696e 202d 3d20 6c65 6e28 6772 6f75 7073  in -= len(groups
-0003ccf0: 5b67 726f 7570 5d29 0a0a 2020 2020 2020  [group])..      
-0003cd00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd20: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
-0003cd30: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0003cd40: 5b67 6574 6174 7472 2877 732c 2061 7474  [getattr(ws, att
-0003cd50: 7269 6275 7465 2920 666f 7220 6720 696e  ribute) for g in
-0003cd60: 2074 6f5f 636c 6f73 6520 666f 7220 7773   to_close for ws
-0003cd70: 2069 6e20 6772 6f75 7073 5b67 5d5d 0a20   in groups[g]]. 
-0003cd80: 2020 2020 2020 2020 2020 2069 6620 7265             if re
-0003cd90: 7375 6c74 3a0a 2020 2020 2020 2020 2020  sult:.          
-0003cda0: 2020 2020 2020 6c6f 6767 6572 2e64 6562        logger.deb
-0003cdb0: 7567 2822 5375 6767 6573 7420 636c 6f73  ug("Suggest clos
-0003cdc0: 696e 6720 776f 726b 6572 733a 2025 7322  ing workers: %s"
-0003cdd0: 2c20 7265 7375 6c74 290a 0a20 2020 2020  , result)..     
-0003cde0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-0003cdf0: 7375 6c74 0a0a 2020 2020 406c 6f67 5f65  sult..    @log_e
-0003ce00: 7272 6f72 730a 2020 2020 6173 796e 6320  rrors.    async 
-0003ce10: 6465 6620 7265 7469 7265 5f77 6f72 6b65  def retire_worke
-0003ce20: 7273 280a 2020 2020 2020 2020 7365 6c66  rs(.        self
-0003ce30: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
-0003ce40: 733a 206c 6973 745b 7374 725d 207c 204e  s: list[str] | N
-0003ce50: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-0003ce60: 2020 2020 2a2c 0a20 2020 2020 2020 206e      *,.        n
-0003ce70: 616d 6573 3a20 6c69 7374 207c 204e 6f6e  ames: list | Non
-0003ce80: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0003ce90: 2020 636c 6f73 655f 776f 726b 6572 733a    close_workers:
-0003cea0: 2062 6f6f 6c20 3d20 4661 6c73 652c 0a20   bool = False,. 
-0003ceb0: 2020 2020 2020 2072 656d 6f76 653a 2062         remove: b
-0003cec0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
-0003ced0: 2020 2020 7374 696d 756c 7573 5f69 643a      stimulus_id:
-0003cee0: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
-0003cef0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
-0003cf00: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
-0003cf10: 202d 3e20 6469 6374 5b73 7472 2c20 416e   -> dict[str, An
-0003cf20: 795d 3a0a 2020 2020 2020 2020 2222 2247  y]:.        """G
-0003cf30: 7261 6365 6675 6c6c 7920 7265 7469 7265  racefully retire
-0003cf40: 2077 6f72 6b65 7273 2066 726f 6d20 636c   workers from cl
-0003cf50: 7573 7465 722e 2041 6e79 206b 6579 2074  uster. Any key t
-0003cf60: 6861 7420 6973 2069 6e20 6d65 6d6f 7279  hat is in memory
-0003cf70: 2065 7863 6c75 7369 7665 6c79 0a20 2020   exclusively.   
-0003cf80: 2020 2020 206f 6e20 7468 6520 7265 7469       on the reti
-0003cf90: 7265 6420 776f 726b 6572 7320 6973 2072  red workers is r
-0003cfa0: 6570 6c69 6361 7465 6420 736f 6d65 7768  eplicated somewh
-0003cfb0: 6572 6520 656c 7365 2e0a 0a20 2020 2020  ere else...     
-0003cfc0: 2020 2050 6172 616d 6574 6572 730a 2020     Parameters.  
-0003cfd0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-0003cfe0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-0003cff0: 3a20 6c69 7374 5b73 7472 5d20 286f 7074  : list[str] (opt
-0003d000: 696f 6e61 6c29 0a20 2020 2020 2020 2020  ional).         
-0003d010: 2020 204c 6973 7420 6f66 2077 6f72 6b65     List of worke
-0003d020: 7220 6164 6472 6573 7365 7320 746f 2072  r addresses to r
-0003d030: 6574 6972 652e 0a20 2020 2020 2020 206e  etire..        n
-0003d040: 616d 6573 3a20 6c69 7374 2028 6f70 7469  ames: list (opti
-0003d050: 6f6e 616c 290a 2020 2020 2020 2020 2020  onal).          
-0003d060: 2020 4c69 7374 206f 6620 776f 726b 6572    List of worker
-0003d070: 206e 616d 6573 2074 6f20 7265 7469 7265   names to retire
-0003d080: 2e0a 2020 2020 2020 2020 2020 2020 4d75  ..            Mu
-0003d090: 7475 616c 6c79 2065 7863 6c75 7369 7665  tually exclusive
-0003d0a0: 2077 6974 6820 6060 776f 726b 6572 7360   with ``workers`
-0003d0b0: 602e 0a20 2020 2020 2020 2020 2020 2049  `..            I
-0003d0c0: 6620 6e65 6974 6865 7220 6060 776f 726b  f neither ``work
-0003d0d0: 6572 7360 6020 6e6f 7220 6060 6e61 6d65  ers`` nor ``name
-0003d0e0: 7360 6020 6172 6520 7072 6f76 6964 6564  s`` are provided
-0003d0f0: 2c20 7765 2063 616c 6c0a 2020 2020 2020  , we call.      
-0003d100: 2020 2020 2020 6060 776f 726b 6572 735f        ``workers_
-0003d110: 746f 5f63 6c6f 7365 6060 2077 6869 6368  to_close`` which
-0003d120: 2066 696e 6473 2061 2067 6f6f 6420 7365   finds a good se
-0003d130: 742e 0a20 2020 2020 2020 2063 6c6f 7365  t..        close
-0003d140: 5f77 6f72 6b65 7273 3a20 626f 6f6c 2028  _workers: bool (
-0003d150: 6465 6661 756c 7473 2074 6f20 4661 6c73  defaults to Fals
-0003d160: 6529 0a20 2020 2020 2020 2020 2020 2057  e).            W
-0003d170: 6865 7468 6572 206f 7220 6e6f 7420 746f  hether or not to
-0003d180: 2061 6374 7561 6c6c 7920 636c 6f73 6520   actually close 
-0003d190: 7468 6520 776f 726b 6572 2065 7870 6c69  the worker expli
-0003d1a0: 6369 746c 7920 6672 6f6d 2068 6572 652e  citly from here.
-0003d1b0: 0a20 2020 2020 2020 2020 2020 204f 7468  .            Oth
-0003d1c0: 6572 7769 7365 2077 6520 6578 7065 6374  erwise we expect
-0003d1d0: 2073 6f6d 6520 6578 7465 726e 616c 206a   some external j
-0003d1e0: 6f62 2073 6368 6564 756c 6572 2074 6f20  ob scheduler to 
-0003d1f0: 6669 6e69 7368 206f 6666 2074 6865 0a20  finish off the. 
-0003d200: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0003d210: 722e 0a20 2020 2020 2020 2072 656d 6f76  r..        remov
-0003d220: 653a 2062 6f6f 6c20 2864 6566 6175 6c74  e: bool (default
-0003d230: 7320 746f 2054 7275 6529 0a20 2020 2020  s to True).     
-0003d240: 2020 2020 2020 2057 6865 7468 6572 206f         Whether o
-0003d250: 7220 6e6f 7420 746f 2072 656d 6f76 6520  r not to remove 
-0003d260: 7468 6520 776f 726b 6572 206d 6574 6164  the worker metad
-0003d270: 6174 6120 696d 6d65 6469 6174 656c 7920  ata immediately 
-0003d280: 6f72 2065 6c73 650a 2020 2020 2020 2020  or else.        
-0003d290: 2020 2020 7761 6974 2066 6f72 2074 6865      wait for the
-0003d2a0: 2077 6f72 6b65 7220 746f 2063 6f6e 7461   worker to conta
-0003d2b0: 6374 2075 732e 0a0a 2020 2020 2020 2020  ct us...        
-0003d2c0: 2020 2020 4966 2063 6c6f 7365 5f77 6f72      If close_wor
-0003d2d0: 6b65 7273 3d46 616c 7365 2061 6e64 2072  kers=False and r
-0003d2e0: 656d 6f76 653d 4661 6c73 652c 2074 6869  emove=False, thi
-0003d2f0: 7320 6d65 7468 6f64 206a 7573 7420 666c  s method just fl
-0003d300: 7573 6865 7320 7468 6520 7461 736b 730a  ushes the tasks.
-0003d310: 2020 2020 2020 2020 2020 2020 696e 206d              in m
-0003d320: 656d 6f72 7920 6f75 7420 6f66 2074 6865  emory out of the
-0003d330: 2077 6f72 6b65 7273 2061 6e64 2074 6865   workers and the
-0003d340: 6e20 7265 7475 726e 732e 0a20 2020 2020  n returns..     
-0003d350: 2020 2020 2020 2049 6620 636c 6f73 655f         If close_
-0003d360: 776f 726b 6572 733d 5472 7565 2061 6e64  workers=True and
-0003d370: 2072 656d 6f76 653d 4661 6c73 652c 2074   remove=False, t
-0003d380: 6869 7320 6d65 7468 6f64 2077 696c 6c20  his method will 
-0003d390: 7265 7475 726e 2077 6869 6c65 2074 6865  return while the
-0003d3a0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-0003d3b0: 6b65 7273 2061 7265 2073 7469 6c6c 2069  kers are still i
-0003d3c0: 6e20 7468 6520 636c 7573 7465 722c 2061  n the cluster, a
-0003d3d0: 6c74 686f 7567 6820 7468 6579 2077 6f6e  lthough they won
-0003d3e0: 2774 2061 6363 6570 7420 6e65 7720 7461  't accept new ta
-0003d3f0: 736b 732e 0a20 2020 2020 2020 2020 2020  sks..           
-0003d400: 2049 6620 636c 6f73 655f 776f 726b 6572   If close_worker
-0003d410: 733d 4661 6c73 6520 6f72 2066 6f72 2077  s=False or for w
-0003d420: 6861 7465 7665 7220 7265 6173 6f6e 2061  hatever reason a
-0003d430: 2077 6f72 6b65 7220 646f 6573 6e27 7420   worker doesn't 
-0003d440: 6163 6365 7074 2074 6865 0a20 2020 2020  accept the.     
-0003d450: 2020 2020 2020 2063 6c6f 7365 2063 6f6d         close com
-0003d460: 6d61 6e64 2c20 6974 2077 696c 6c20 6265  mand, it will be
-0003d470: 206c 6566 7420 7065 726d 616e 656e 746c   left permanentl
-0003d480: 7920 756e 6162 6c65 2074 6f20 6163 6365  y unable to acce
-0003d490: 7074 206e 6577 2074 6173 6b73 2061 6e64  pt new tasks and
-0003d4a0: 0a20 2020 2020 2020 2020 2020 2069 7420  .            it 
-0003d4b0: 6973 2065 7870 6563 7465 6420 746f 2062  is expected to b
-0003d4c0: 6520 636c 6f73 6564 2069 6e20 736f 6d65  e closed in some
-0003d4d0: 206f 7468 6572 2077 6179 2e0a 0a20 2020   other way...   
-0003d4e0: 2020 2020 202a 2a6b 7761 7267 733a 2064       **kwargs: d
-0003d4f0: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
-0003d500: 4578 7472 6120 6f70 7469 6f6e 7320 746f  Extra options to
-0003d510: 2070 6173 7320 746f 2077 6f72 6b65 7273   pass to workers
-0003d520: 5f74 6f5f 636c 6f73 6520 746f 2064 6574  _to_close to det
-0003d530: 6572 6d69 6e65 2077 6869 6368 0a20 2020  ermine which.   
-0003d540: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-0003d550: 2077 6520 7368 6f75 6c64 2064 726f 700a   we should drop.
-0003d560: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0003d570: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0003d580: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-0003d590: 6172 7920 6d61 7070 696e 6720 776f 726b  ary mapping work
-0003d5a0: 6572 2049 442f 6164 6472 6573 7320 746f  er ID/address to
-0003d5b0: 2064 6963 7469 6f6e 6172 7920 6f66 2069   dictionary of i
-0003d5c0: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-0003d5d0: 0a20 2020 2020 2020 2074 6861 7420 776f  .        that wo
-0003d5e0: 726b 6572 2066 6f72 2065 6163 6820 7265  rker for each re
-0003d5f0: 7469 7265 6420 776f 726b 6572 2e0a 0a20  tired worker... 
-0003d600: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
-0003d610: 6172 6520 6b65 7973 2074 6861 7420 6578  are keys that ex
-0003d620: 6973 7420 696e 206d 656d 6f72 7920 6f6e  ist in memory on
-0003d630: 6c79 206f 6e20 7468 6520 776f 726b 6572  ly on the worker
-0003d640: 7320 6265 696e 6720 7265 7469 7265 6420  s being retired 
-0003d650: 616e 6420 6974 0a20 2020 2020 2020 2077  and it.        w
-0003d660: 6173 2069 6d70 6f73 7369 626c 6520 746f  as impossible to
-0003d670: 2072 6570 6c69 6361 7465 2074 6865 6d20   replicate them 
-0003d680: 736f 6d65 7768 6572 6520 656c 7365 2028  somewhere else (
-0003d690: 652e 672e 2062 6563 6175 7365 2074 6865  e.g. because the
-0003d6a0: 7265 2061 7265 6e27 740a 2020 2020 2020  re aren't.      
-0003d6b0: 2020 616e 7920 6f74 6865 7220 7275 6e6e    any other runn
-0003d6c0: 696e 6720 776f 726b 6572 7329 2c20 7468  ing workers), th
-0003d6d0: 6520 776f 726b 6572 7320 686f 6c64 696e  e workers holdin
-0003d6e0: 6720 7375 6368 206b 6579 7320 776f 6e27  g such keys won'
-0003d6f0: 7420 6265 2072 6574 6972 6564 2061 6e64  t be retired and
-0003d700: 0a20 2020 2020 2020 2077 6f6e 2774 2061  .        won't a
-0003d710: 7070 6561 7220 696e 2074 6865 2072 6574  ppear in the ret
-0003d720: 7572 6e65 6420 6469 6374 2e0a 0a20 2020  urned dict...   
-0003d730: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-0003d740: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0003d750: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-0003d760: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-0003d770: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-0003d780: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-0003d790: 6420 3d20 7374 696d 756c 7573 5f69 6420  d = stimulus_id 
-0003d7a0: 6f72 2066 2272 6574 6972 652d 776f 726b  or f"retire-work
-0003d7b0: 6572 732d 7b74 696d 6528 297d 220a 2020  ers-{time()}".  
-0003d7c0: 2020 2020 2020 2320 5468 6973 206c 6f63        # This loc
-0003d7d0: 6b20 6d61 6b65 7320 7265 7469 7265 5f77  k makes retire_w
-0003d7e0: 6f72 6b65 7273 2c20 7265 6261 6c61 6e63  orkers, rebalanc
-0003d7f0: 652c 2061 6e64 2072 6570 6c69 6361 7465  e, and replicate
-0003d800: 206d 7574 7561 6c6c 790a 2020 2020 2020   mutually.      
-0003d810: 2020 2320 6578 636c 7573 6976 6520 616e    # exclusive an
-0003d820: 6420 7769 6c6c 206e 6f20 6c6f 6e67 6572  d will no longer
-0003d830: 2062 6520 6e65 6365 7373 6172 7920 6f6e   be necessary on
-0003d840: 6365 2072 6562 616c 616e 6365 2061 6e64  ce rebalance and
-0003d850: 2072 6570 6c69 6361 7465 2061 7265 0a20   replicate are. 
-0003d860: 2020 2020 2020 2023 206d 6967 7261 7465         # migrate
-0003d870: 6420 746f 2074 6865 2041 6374 6976 6520  d to the Active 
-0003d880: 4d65 6d6f 7279 204d 616e 6167 6572 2e0a  Memory Manager..
-0003d890: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
-0003d8a0: 6861 742c 2069 6e63 6964 656e 7461 6c6c  hat, incidentall
-0003d8b0: 792c 2069 7420 616c 736f 2070 7265 7665  y, it also preve
-0003d8c0: 6e74 7320 6d75 6c74 6970 6c65 2063 616c  nts multiple cal
-0003d8d0: 6c73 2074 6f20 7265 7469 7265 5f77 6f72  ls to retire_wor
-0003d8e0: 6b65 7273 0a20 2020 2020 2020 2023 2066  kers.        # f
-0003d8f0: 726f 6d20 7275 6e6e 696e 6720 696e 2070  rom running in p
-0003d900: 6172 616c 6c65 6c20 2d20 7468 6973 2069  arallel - this i
-0003d910: 7320 756e 6e65 6365 7373 6172 792e 0a20  s unnecessary.. 
-0003d920: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-0003d930: 6820 7365 6c66 2e5f 6c6f 636b 3a0a 2020  h self._lock:.  
-0003d940: 2020 2020 2020 2020 2020 6966 206e 616d            if nam
-0003d950: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
-0003d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d970: 6966 2077 6f72 6b65 7273 2069 7320 6e6f  if workers is no
-0003d980: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0003d990: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0003d9a0: 6520 5479 7065 4572 726f 7228 226e 616d  e TypeError("nam
-0003d9b0: 6573 2061 6e64 2077 6f72 6b65 7273 2061  es and workers a
-0003d9c0: 7265 206d 7574 7561 6c6c 7920 6578 636c  re mutually excl
-0003d9d0: 7573 6976 6522 290a 2020 2020 2020 2020  usive").        
-0003d9e0: 2020 2020 2020 2020 6966 206e 616d 6573          if names
-0003d9f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003da00: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-0003da10: 6f28 2252 6574 6972 6520 776f 726b 6572  o("Retire worker
-0003da20: 206e 616d 6573 2025 7322 2c20 6e61 6d65   names %s", name
-0003da30: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003da40: 2020 2023 2053 7570 706f 7274 2063 6173     # Support cas
-0003da50: 6573 2077 6865 7265 206e 616d 6573 2061  es where names a
-0003da60: 7265 2070 6173 7365 6420 7468 726f 7567  re passed throug
-0003da70: 6820 6120 434c 4920 616e 6420 6265 636f  h a CLI and beco
-0003da80: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-0003da90: 2020 2023 2073 7472 696e 6773 0a20 2020     # strings.   
-0003daa0: 2020 2020 2020 2020 2020 2020 206e 616d               nam
-0003dab0: 6573 5f73 6574 203d 207b 7374 7228 6e61  es_set = {str(na
-0003dac0: 6d65 2920 666f 7220 6e61 6d65 2069 6e20  me) for name in 
-0003dad0: 6e61 6d65 737d 0a20 2020 2020 2020 2020  names}.         
-0003dae0: 2020 2020 2020 2077 7373 203d 207b 7773         wss = {ws
-0003daf0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-0003db00: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-0003db10: 2069 6620 7374 7228 7773 2e6e 616d 6529   if str(ws.name)
-0003db20: 2069 6e20 6e61 6d65 735f 7365 747d 0a20   in names_set}. 
-0003db30: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0003db40: 776f 726b 6572 7320 6973 206e 6f74 204e  workers is not N
-0003db50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003db60: 2020 2020 2077 7373 203d 207b 0a20 2020       wss = {.   
-0003db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003db80: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-0003db90: 6472 6573 735d 0a20 2020 2020 2020 2020  dress].         
-0003dba0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-0003dbb0: 6464 7265 7373 2069 6e20 776f 726b 6572  ddress in worker
-0003dbc0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003dbd0: 2020 2020 2020 6966 2061 6464 7265 7373        if address
-0003dbe0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-0003dbf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003dc00: 207d 0a20 2020 2020 2020 2020 2020 2065   }.            e
-0003dc10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003dc20: 2020 2020 2077 7373 203d 207b 0a20 2020       wss = {.   
-0003dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dc40: 2073 656c 662e 776f 726b 6572 735b 6164   self.workers[ad
-0003dc50: 6472 6573 735d 2066 6f72 2061 6464 7265  dress] for addre
-0003dc60: 7373 2069 6e20 7365 6c66 2e77 6f72 6b65  ss in self.worke
-0003dc70: 7273 5f74 6f5f 636c 6f73 6528 2a2a 6b77  rs_to_close(**kw
-0003dc80: 6172 6773 290a 2020 2020 2020 2020 2020  args).          
-0003dc90: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0003dca0: 2020 2020 6966 206e 6f74 2077 7373 3a0a      if not wss:.
-0003dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dcc0: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
-0003dcd0: 2020 2020 2020 2073 746f 705f 616d 6d20         stop_amm 
-0003dce0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-0003dcf0: 2020 2020 616d 6d3a 2041 6374 6976 654d      amm: ActiveM
-0003dd00: 656d 6f72 794d 616e 6167 6572 4578 7465  emoryManagerExte
-0003dd10: 6e73 696f 6e20 7c20 4e6f 6e65 203d 2073  nsion | None = s
-0003dd20: 656c 662e 6578 7465 6e73 696f 6e73 2e67  elf.extensions.g
-0003dd30: 6574 2822 616d 6d22 290a 2020 2020 2020  et("amm").      
-0003dd40: 2020 2020 2020 6966 206e 6f74 2061 6d6d        if not amm
-0003dd50: 206f 7220 6e6f 7420 616d 6d2e 7275 6e6e   or not amm.runn
-0003dd60: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-0003dd70: 2020 2020 2061 6d6d 203d 2041 6374 6976       amm = Activ
-0003dd80: 654d 656d 6f72 794d 616e 6167 6572 4578  eMemoryManagerEx
-0003dd90: 7465 6e73 696f 6e28 0a20 2020 2020 2020  tension(.       
-0003dda0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003ddb0: 662c 2070 6f6c 6963 6965 733d 7365 7428  f, policies=set(
-0003ddc0: 292c 2072 6567 6973 7465 723d 4661 6c73  ), register=Fals
-0003ddd0: 652c 2073 7461 7274 3d54 7275 652c 2069  e, start=True, i
-0003dde0: 6e74 6572 7661 6c3d 322e 300a 2020 2020  nterval=2.0.    
-0003ddf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003de00: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0003de10: 6f70 5f61 6d6d 203d 2054 7275 650a 0a20  op_amm = True.. 
-0003de20: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0003de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003de40: 636f 726f 7320 3d20 5b5d 0a20 2020 2020  coros = [].     
-0003de50: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0003de60: 7320 696e 2077 7373 3a0a 2020 2020 2020  s in wss:.      
-0003de70: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-0003de80: 6767 6572 2e69 6e66 6f28 2252 6574 6972  gger.info("Retir
-0003de90: 696e 6720 776f 726b 6572 2025 7322 2c20  ing worker %s", 
-0003dea0: 7773 2e61 6464 7265 7373 290a 0a20 2020  ws.address)..   
-0003deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dec0: 2070 6f6c 6963 7920 3d20 5265 7469 7265   policy = Retire
-0003ded0: 576f 726b 6572 2877 732e 6164 6472 6573  Worker(ws.addres
-0003dee0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003def0: 2020 2020 2020 2061 6d6d 2e61 6464 5f70         amm.add_p
-0003df00: 6f6c 6963 7928 706f 6c69 6379 290a 0a20  olicy(policy).. 
-0003df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003df20: 2020 2023 2043 6861 6e67 6520 576f 726b     # Change Work
-0003df30: 6572 2e73 7461 7475 7320 746f 2063 6c6f  er.status to clo
-0003df40: 7369 6e67 5f67 7261 6365 6675 6c6c 792e  sing_gracefully.
-0003df50: 2049 6d6d 6564 6961 7465 6c79 2073 6574   Immediately set
-0003df60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003df70: 2020 2020 2023 2074 6865 2073 616d 6520       # the same 
-0003df80: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-0003df90: 2074 6f20 7072 6576 656e 7420 7261 6365   to prevent race
-0003dfa0: 2063 6f6e 6469 7469 6f6e 732e 0a20 2020   conditions..   
-0003dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dfc0: 2070 7265 765f 7374 6174 7573 203d 2077   prev_status = w
-0003dfd0: 732e 7374 6174 7573 0a20 2020 2020 2020  s.status.       
-0003dfe0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0003dff0: 662e 6861 6e64 6c65 5f77 6f72 6b65 725f  f.handle_worker_
-0003e000: 7374 6174 7573 5f63 6861 6e67 6528 0a20  status_change(. 
-0003e010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e020: 2020 2020 2020 2053 7461 7475 732e 636c         Status.cl
-0003e030: 6f73 696e 675f 6772 6163 6566 756c 6c79  osing_gracefully
-0003e040: 2c20 7773 2c20 7374 696d 756c 7573 5f69  , ws, stimulus_i
-0003e050: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-0003e060: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0003e070: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
-0003e080: 584d 453a 2057 6520 7368 6f75 6c64 2073  XME: We should s
-0003e090: 656e 6420 6120 6d65 7373 6167 6520 746f  end a message to
-0003e0a0: 2074 6865 206e 616e 6e79 2066 6972 7374   the nanny first
-0003e0b0: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-0003e0c0: 2020 2020 2020 2320 6576 656e 7475 616c        # eventual
-0003e0d0: 6c79 2077 6f72 6b65 7273 2077 6f6e 2774  ly workers won't
-0003e0e0: 2062 6520 6162 6c65 2074 6f20 636c 6f73   be able to clos
-0003e0f0: 6520 7468 6569 7220 6f77 6e20 6e61 6e6e  e their own nann
-0003e100: 6965 732e 0a20 2020 2020 2020 2020 2020  ies..           
-0003e110: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-0003e120: 7265 616d 5f63 6f6d 6d73 5b77 732e 6164  ream_comms[ws.ad
-0003e130: 6472 6573 735d 2e73 656e 6428 0a20 2020  dress].send(.   
-0003e140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e150: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0003e160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e170: 2020 2022 6f70 223a 2022 776f 726b 6572     "op": "worker
-0003e180: 2d73 7461 7475 732d 6368 616e 6765 222c  -status-change",
-0003e190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e1a0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-0003e1b0: 6174 7573 223a 2077 732e 7374 6174 7573  atus": ws.status
-0003e1c0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+0003a140: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+0003a150: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003a160: 5363 6865 6475 6c65 2074 6173 6b20 666f  Schedule task fo
+0003a170: 7220 7472 616e 7366 6572 2066 726f 6d20  r transfer from 
+0003a180: 7365 6e64 6572 2074 6f20 7265 6369 7069  sender to recipi
+0003a190: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0003a1a0: 2020 2020 6d73 6773 2e61 7070 656e 6428      msgs.append(
+0003a1b0: 2873 6e64 5f77 732c 2072 6563 5f77 732c  (snd_ws, rec_ws,
+0003a1c0: 2074 7329 290a 0a20 2020 2020 2020 2020   ts))..         
+0003a1d0: 2020 2020 2020 2023 202a 5f62 7974 6573         # *_bytes
+0003a1e0: 5f6d 6178 2f6d 696e 2061 7265 2061 6c6c  _max/min are all
+0003a1f0: 206e 6567 6174 6976 6520 666f 7220 6865   negative for he
+0003a200: 6170 2073 6f72 7469 6e67 0a20 2020 2020  ap sorting.     
+0003a210: 2020 2020 2020 2020 2020 2073 6e64 5f62             snd_b
+0003a220: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
+0003a230: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0003a240: 2020 2073 6e64 5f62 7974 6573 5f6d 696e     snd_bytes_min
+0003a250: 202b 3d20 6e62 7974 6573 0a20 2020 2020   += nbytes.     
+0003a260: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
+0003a270: 7974 6573 5f6d 6178 202b 3d20 6e62 7974  ytes_max += nbyt
+0003a280: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0003a290: 2020 2072 6563 5f62 7974 6573 5f6d 696e     rec_bytes_min
+0003a2a0: 202b 3d20 6e62 7974 6573 0a0a 2020 2020   += nbytes..    
+0003a2b0: 2020 2020 2020 2020 2020 2020 2320 5374              # St
+0003a2c0: 6f70 2069 7465 7261 7469 6e67 206f 6e20  op iterating on 
+0003a2d0: 7468 6520 7461 736b 7320 6f66 2074 6869  the tasks of thi
+0003a2e0: 7320 7365 6e64 6572 2066 6f72 206e 6f77  s sender for now
+0003a2f0: 2061 6e64 2c20 6966 2069 7420 7374 696c   and, if it stil
+0003a300: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+0003a310: 2020 2320 6861 7320 6279 7465 7320 746f    # has bytes to
+0003a320: 206c 6f73 652c 2070 7573 6820 6974 2062   lose, push it b
+0003a330: 6163 6b20 696e 746f 2074 6865 2073 656e  ack into the sen
+0003a340: 6465 7273 2068 6561 703b 2069 7420 6d61  ders heap; it ma
+0003a350: 7920 6f72 206d 6179 0a20 2020 2020 2020  y or may.       
+0003a360: 2020 2020 2020 2020 2023 206e 6f74 2063           # not c
+0003a370: 6f6d 6520 6261 636b 206f 6e20 746f 7020  ome back on top 
+0003a380: 6167 6169 6e2e 0a20 2020 2020 2020 2020  again..         
+0003a390: 2020 2020 2020 2069 6620 736e 645f 6279         if snd_by
+0003a3a0: 7465 735f 6d69 6e20 3c20 303a 0a20 2020  tes_min < 0:.   
+0003a3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a3c0: 2023 2053 6565 2064 6566 696e 6974 696f   # See definitio
+0003a3d0: 6e20 6f66 2073 656e 6465 7273 2061 626f  n of senders abo
+0003a3e0: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+0003a3f0: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
+0003a400: 7072 6570 6c61 6365 280a 2020 2020 2020  preplace(.      
+0003a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a420: 2020 7365 6e64 6572 732c 0a20 2020 2020    senders,.     
+0003a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a440: 2020 2028 736e 645f 6279 7465 735f 6d61     (snd_bytes_ma
+0003a450: 782c 2073 6e64 5f62 7974 6573 5f6d 696e  x, snd_bytes_min
+0003a460: 2c20 6964 2873 6e64 5f77 7329 2c20 736e  , id(snd_ws), sn
+0003a470: 645f 7773 2c20 7473 5f69 7465 7229 2c0a  d_ws, ts_iter),.
+0003a480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a490: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0003a4a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a4c0: 6865 6170 712e 6865 6170 706f 7028 7365  heapq.heappop(se
+0003a4d0: 6e64 6572 7329 0a0a 2020 2020 2020 2020  nders)..        
+0003a4e0: 2020 2020 2020 2020 2320 4966 2072 6563          # If rec
+0003a4f0: 6970 6965 6e74 2073 7469 6c6c 2068 6173  ipient still has
+0003a500: 2062 7974 6573 2074 6f20 6761 696e 2c20   bytes to gain, 
+0003a510: 7075 7368 2069 7420 6261 636b 2069 6e74  push it back int
+0003a520: 6f20 7468 6520 7265 6369 7069 656e 7473  o the recipients
+0003a530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a540: 2023 2068 6561 703b 2069 7420 6d61 7920   # heap; it may 
+0003a550: 6f72 206d 6179 206e 6f74 2063 6f6d 6520  or may not come 
+0003a560: 6261 636b 206f 6e20 746f 7020 6167 6169  back on top agai
+0003a570: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
+0003a580: 2020 2069 6620 7265 635f 6279 7465 735f     if rec_bytes_
+0003a590: 6d69 6e20 3c20 303a 0a20 2020 2020 2020  min < 0:.       
+0003a5a0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+0003a5b0: 6565 2064 6566 696e 6974 696f 6e20 6f66  ee definition of
+0003a5c0: 2072 6563 6970 6965 6e74 7320 6162 6f76   recipients abov
+0003a5d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0003a5e0: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
+0003a5f0: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
+0003a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a610: 2072 6563 6970 6965 6e74 732c 0a20 2020   recipients,.   
+0003a620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a630: 2020 2020 2028 7265 635f 6279 7465 735f       (rec_bytes_
+0003a640: 6d61 782c 2072 6563 5f62 7974 6573 5f6d  max, rec_bytes_m
+0003a650: 696e 2c20 6964 2872 6563 5f77 7329 2c20  in, id(rec_ws), 
+0003a660: 7265 635f 7773 292c 0a20 2020 2020 2020  rec_ws),.       
+0003a670: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0003a680: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003a690: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003a6a0: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
+0003a6b0: 6561 7070 6f70 2872 6563 6970 6965 6e74  eappop(recipient
+0003a6c0: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0003a6d0: 2020 2020 2320 4d6f 7665 2074 6f20 6e65      # Move to ne
+0003a6e0: 7874 2073 656e 6465 7220 7769 7468 2074  xt sender with t
+0003a6f0: 6865 206d 6f73 7420 6461 7461 2074 6f20  he most data to 
+0003a700: 6c6f 7365 2e0a 2020 2020 2020 2020 2020  lose..          
+0003a710: 2020 2020 2020 2320 4974 206d 6179 206f        # It may o
+0003a720: 7220 6d61 7920 6e6f 7420 6265 2074 6865  r may not be the
+0003a730: 2073 616d 6520 7365 6e64 6572 2061 6761   same sender aga
+0003a740: 696e 2e0a 2020 2020 2020 2020 2020 2020  in..            
+0003a750: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+0003a760: 2020 2020 2020 2065 6c73 653a 2020 2320         else:  # 
+0003a770: 666f 7220 7473 2069 6e20 7473 5f69 7465  for ts in ts_ite
+0003a780: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0003a790: 2020 2320 4578 6861 7573 7465 6420 7461    # Exhausted ta
+0003a7a0: 736b 7320 6f6e 2074 6869 7320 7365 6e64  sks on this send
+0003a7b0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0003a7c0: 2020 2068 6561 7071 2e68 6561 7070 6f70     heapq.heappop
+0003a7d0: 2873 656e 6465 7273 290a 0a20 2020 2020  (senders)..     
+0003a7e0: 2020 2072 6574 7572 6e20 6d73 6773 0a0a     return msgs..
+0003a7f0: 2020 2020 6173 796e 6320 6465 6620 5f72      async def _r
+0003a800: 6562 616c 616e 6365 5f6d 6f76 655f 6461  ebalance_move_da
+0003a810: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
+0003a820: 2c20 6d73 6773 3a20 226c 6973 745b 7475  , msgs: "list[tu
+0003a830: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
+0003a840: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
+0003a850: 736b 5374 6174 655d 5d22 2c20 7374 696d  skState]]", stim
+0003a860: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
+0003a870: 2029 202d 3e20 6469 6374 3a0a 2020 2020   ) -> dict:.    
+0003a880: 2020 2020 2222 2250 6572 666f 726d 2074      """Perform t
+0003a890: 6865 2061 6374 7561 6c20 7472 616e 7366  he actual transf
+0003a8a0: 6572 206f 6620 6461 7461 2061 6372 6f73  er of data acros
+0003a8b0: 7320 7468 6520 6e65 7477 6f72 6b20 696e  s the network in
+0003a8c0: 2072 6562 616c 616e 6365 2829 2e0a 2020   rebalance()..  
+0003a8d0: 2020 2020 2020 5461 6b65 7320 696e 2069        Takes in i
+0003a8e0: 6e70 7574 2074 6865 206f 7574 7075 7420  nput the output 
+0003a8f0: 6f66 205f 7265 6261 6c61 6e63 655f 6669  of _rebalance_fi
+0003a900: 6e64 5f6d 7367 7328 292c 2074 6861 7420  nd_msgs(), that 
+0003a910: 6973 2061 206c 6973 7420 6f66 2074 7570  is a list of tup
+0003a920: 6c65 733a 0a0a 2020 2020 2020 2020 2d20  les:..        - 
+0003a930: 7365 6e64 6572 2077 6f72 6b65 720a 2020  sender worker.  
+0003a940: 2020 2020 2020 2d20 7265 6369 7069 656e        - recipien
+0003a950: 7420 776f 726b 6572 0a20 2020 2020 2020  t worker.       
+0003a960: 202d 2074 6173 6b20 746f 2062 6520 7472   - task to be tr
+0003a970: 616e 7366 6572 7265 640a 0a20 2020 2020  ansferred..     
+0003a980: 2020 2046 4958 4d45 2074 6869 7320 6d65     FIXME this me
+0003a990: 7468 6f64 2069 7320 6e6f 7420 726f 6275  thod is not robu
+0003a9a0: 7374 2077 6865 6e20 7468 6520 636c 7573  st when the clus
+0003a9b0: 7465 7220 6973 206e 6f74 2069 646c 652e  ter is not idle.
+0003a9c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0003a9d0: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
+0003a9e0: 7473 3a20 6465 6661 756c 7464 6963 745b  ts: defaultdict[
+0003a9f0: 7374 722c 2064 6566 6175 6c74 6469 6374  str, defaultdict
+0003aa00: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
+0003aa10: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
+0003aa20: 0a20 2020 2020 2020 2020 2020 206c 616d  .            lam
+0003aa30: 6264 613a 2064 6566 6175 6c74 6469 6374  bda: defaultdict
+0003aa40: 286c 6973 7429 0a20 2020 2020 2020 2029  (list).        )
+0003aa50: 0a20 2020 2020 2020 2066 6f72 2073 6e64  .        for snd
+0003aa60: 5f77 732c 2072 6563 5f77 732c 2074 7320  _ws, rec_ws, ts 
+0003aa70: 696e 206d 7367 733a 0a20 2020 2020 2020  in msgs:.       
+0003aa80: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
+0003aa90: 7473 5b72 6563 5f77 732e 6164 6472 6573  ts[rec_ws.addres
+0003aaa0: 735d 5b74 732e 6b65 795d 2e61 7070 656e  s][ts.key].appen
+0003aab0: 6428 736e 645f 7773 2e61 6464 7265 7373  d(snd_ws.address
+0003aac0: 290a 2020 2020 2020 2020 6661 696c 6564  ).        failed
+0003aad0: 5f6b 6579 735f 6279 5f72 6563 6970 6965  _keys_by_recipie
+0003aae0: 6e74 203d 2064 6963 7428 0a20 2020 2020  nt = dict(.     
+0003aaf0: 2020 2020 2020 207a 6970 280a 2020 2020         zip(.    
+0003ab00: 2020 2020 2020 2020 2020 2020 746f 5f72              to_r
+0003ab10: 6563 6970 6965 6e74 732c 0a20 2020 2020  ecipients,.     
+0003ab20: 2020 2020 2020 2020 2020 2061 7761 6974             await
+0003ab30: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+0003ab40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ab50: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
+0003ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ab70: 2320 4e6f 7465 3a20 7468 6973 206e 6576  # Note: this nev
+0003ab80: 6572 2072 6169 7365 7320 6578 6365 7074  er raises except
+0003ab90: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+0003aba0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0003abb0: 662e 6761 7468 6572 5f6f 6e5f 776f 726b  f.gather_on_work
+0003abc0: 6572 2877 2c20 7768 6f5f 6861 7329 0a20  er(w, who_has). 
+0003abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abe0: 2020 2020 2020 2066 6f72 2077 2c20 7768         for w, wh
+0003abf0: 6f5f 6861 7320 696e 2074 6f5f 7265 6369  o_has in to_reci
+0003ac00: 7069 656e 7473 2e69 7465 6d73 2829 0a20  pients.items(). 
+0003ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ac20: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0003ac30: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0003ac40: 2020 2020 290a 2020 2020 2020 2020 290a      ).        ).
+0003ac50: 0a20 2020 2020 2020 2074 6f5f 7365 6e64  .        to_send
+0003ac60: 6572 7320 3d20 6465 6661 756c 7464 6963  ers = defaultdic
+0003ac70: 7428 6c69 7374 290a 2020 2020 2020 2020  t(list).        
+0003ac80: 666f 7220 736e 645f 7773 2c20 7265 635f  for snd_ws, rec_
+0003ac90: 7773 2c20 7473 2069 6e20 6d73 6773 3a0a  ws, ts in msgs:.
+0003aca0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0003acb0: 732e 6b65 7920 6e6f 7420 696e 2066 6169  s.key not in fai
+0003acc0: 6c65 645f 6b65 7973 5f62 795f 7265 6369  led_keys_by_reci
+0003acd0: 7069 656e 745b 7265 635f 7773 2e61 6464  pient[rec_ws.add
+0003ace0: 7265 7373 5d3a 0a20 2020 2020 2020 2020  ress]:.         
+0003acf0: 2020 2020 2020 2074 6f5f 7365 6e64 6572         to_sender
+0003ad00: 735b 736e 645f 7773 2e61 6464 7265 7373  s[snd_ws.address
+0003ad10: 5d2e 6170 7065 6e64 2874 732e 6b65 7929  ].append(ts.key)
+0003ad20: 0a0a 2020 2020 2020 2020 2320 4e6f 7465  ..        # Note
+0003ad30: 3a20 7468 6973 206e 6576 6572 2072 6169  : this never rai
+0003ad40: 7365 7320 6578 6365 7074 696f 6e73 0a20  ses exceptions. 
+0003ad50: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+0003ad60: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+0003ad70: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
+0003ad80: 6465 6c65 7465 5f77 6f72 6b65 725f 6461  delete_worker_da
+0003ad90: 7461 2872 2c20 762c 2073 7469 6d75 6c75  ta(r, v, stimulu
+0003ada0: 735f 6964 2920 666f 7220 722c 2076 2069  s_id) for r, v i
+0003adb0: 6e20 746f 5f73 656e 6465 7273 2e69 7465  n to_senders.ite
+0003adc0: 6d73 2829 290a 2020 2020 2020 2020 290a  ms()).        ).
+0003add0: 0a20 2020 2020 2020 2066 6f72 2072 2c20  .        for r, 
+0003ade0: 7620 696e 2074 6f5f 7265 6369 7069 656e  v in to_recipien
+0003adf0: 7473 2e69 7465 6d73 2829 3a0a 2020 2020  ts.items():.    
+0003ae00: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0003ae10: 5f65 7665 6e74 2872 2c20 7b22 6163 7469  _event(r, {"acti
+0003ae20: 6f6e 223a 2022 7265 6261 6c61 6e63 6522  on": "rebalance"
+0003ae30: 2c20 2277 686f 5f68 6173 223a 2076 7d29  , "who_has": v})
+0003ae40: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0003ae50: 675f 6576 656e 7428 0a20 2020 2020 2020  g_event(.       
+0003ae60: 2020 2020 2022 616c 6c22 2c0a 2020 2020       "all",.    
+0003ae70: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003ae80: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+0003ae90: 6e22 3a20 2272 6562 616c 616e 6365 222c  n": "rebalance",
+0003aea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003aeb0: 2022 7365 6e64 6572 7322 3a20 7661 6c6d   "senders": valm
+0003aec0: 6170 286c 656e 2c20 746f 5f73 656e 6465  ap(len, to_sende
+0003aed0: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+0003aee0: 2020 2020 2022 7265 6369 7069 656e 7473       "recipients
+0003aef0: 223a 2076 616c 6d61 7028 6c65 6e2c 2074  ": valmap(len, t
+0003af00: 6f5f 7265 6369 7069 656e 7473 292c 0a20  o_recipients),. 
+0003af10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003af20: 6d6f 7665 645f 6b65 7973 223a 206c 656e  moved_keys": len
+0003af30: 286d 7367 7329 2c0a 2020 2020 2020 2020  (msgs),.        
+0003af40: 2020 2020 7d2c 0a20 2020 2020 2020 2029      },.        )
+0003af50: 0a0a 2020 2020 2020 2020 6d69 7373 696e  ..        missin
+0003af60: 675f 6b65 7973 203d 207b 6b20 666f 7220  g_keys = {k for 
+0003af70: 7220 696e 2066 6169 6c65 645f 6b65 7973  r in failed_keys
+0003af80: 5f62 795f 7265 6369 7069 656e 742e 7661  _by_recipient.va
+0003af90: 6c75 6573 2829 2066 6f72 206b 2069 6e20  lues() for k in 
+0003afa0: 727d 0a20 2020 2020 2020 2069 6620 6d69  r}.        if mi
+0003afb0: 7373 696e 675f 6b65 7973 3a0a 2020 2020  ssing_keys:.    
+0003afc0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003afd0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
+0003afe0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
+0003aff0: 3a20 6c69 7374 286d 6973 7369 6e67 5f6b  : list(missing_k
+0003b000: 6579 7329 7d0a 2020 2020 2020 2020 656c  eys)}.        el
+0003b010: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003b020: 7265 7475 726e 207b 2273 7461 7475 7322  return {"status"
+0003b030: 3a20 224f 4b22 7d0a 0a20 2020 2061 7379  : "OK"}..    asy
+0003b040: 6e63 2064 6566 2072 6570 6c69 6361 7465  nc def replicate
+0003b050: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0003b060: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
+0003b070: 652c 0a20 2020 2020 2020 206b 6579 733d  e,.        keys=
+0003b080: 4e6f 6e65 2c0a 2020 2020 2020 2020 6e3d  None,.        n=
+0003b090: 4e6f 6e65 2c0a 2020 2020 2020 2020 776f  None,.        wo
+0003b0a0: 726b 6572 733d 4e6f 6e65 2c0a 2020 2020  rkers=None,.    
+0003b0b0: 2020 2020 6272 616e 6368 696e 675f 6661      branching_fa
+0003b0c0: 6374 6f72 3d32 2c0a 2020 2020 2020 2020  ctor=2,.        
+0003b0d0: 6465 6c65 7465 3d54 7275 652c 0a20 2020  delete=True,.   
+0003b0e0: 2020 2020 206c 6f63 6b3d 5472 7565 2c0a       lock=True,.
+0003b0f0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0003b100: 5f69 643d 4e6f 6e65 2c0a 2020 2020 293a  _id=None,.    ):
+0003b110: 0a20 2020 2020 2020 2022 2222 5265 706c  .        """Repl
+0003b120: 6963 6174 6520 6461 7461 2074 6872 6f75  icate data throu
+0003b130: 6768 6f75 7420 636c 7573 7465 720a 0a20  ghout cluster.. 
+0003b140: 2020 2020 2020 2054 6869 7320 7065 7266         This perf
+0003b150: 6f72 6d73 2061 2074 7265 6520 636f 7079  orms a tree copy
+0003b160: 206f 6620 7468 6520 6461 7461 2074 6872   of the data thr
+0003b170: 6f75 6768 6f75 7420 7468 6520 6e65 7477  oughout the netw
+0003b180: 6f72 6b0a 2020 2020 2020 2020 696e 6469  ork.        indi
+0003b190: 7669 6475 616c 6c79 206f 6e20 6561 6368  vidually on each
+0003b1a0: 2070 6965 6365 206f 6620 6461 7461 2e0a   piece of data..
+0003b1b0: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+0003b1c0: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+0003b1d0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206b  ------.        k
+0003b1e0: 6579 733a 2049 7465 7261 626c 650a 2020  eys: Iterable.  
+0003b1f0: 2020 2020 2020 2020 2020 6c69 7374 206f            list o
+0003b200: 6620 6b65 7973 2074 6f20 7265 706c 6963  f keys to replic
+0003b210: 6174 650a 2020 2020 2020 2020 6e3a 2069  ate.        n: i
+0003b220: 6e74 0a20 2020 2020 2020 2020 2020 204e  nt.            N
+0003b230: 756d 6265 7220 6f66 2072 6570 6c69 6361  umber of replica
+0003b240: 7469 6f6e 7320 7765 2065 7870 6563 7420  tions we expect 
+0003b250: 746f 2073 6565 2077 6974 6869 6e20 7468  to see within th
+0003b260: 6520 636c 7573 7465 720a 2020 2020 2020  e cluster.      
+0003b270: 2020 6272 616e 6368 696e 675f 6661 6374    branching_fact
+0003b280: 6f72 3a20 696e 742c 206f 7074 696f 6e61  or: int, optiona
+0003b290: 6c0a 2020 2020 2020 2020 2020 2020 5468  l.            Th
+0003b2a0: 6520 6e75 6d62 6572 206f 6620 776f 726b  e number of work
+0003b2b0: 6572 7320 7468 6174 2063 616e 2063 6f70  ers that can cop
+0003b2c0: 7920 6461 7461 2069 6e20 6561 6368 2067  y data in each g
+0003b2d0: 656e 6572 6174 696f 6e2e 0a20 2020 2020  eneration..     
+0003b2e0: 2020 2020 2020 2054 6865 206c 6172 6765         The large
+0003b2f0: 7220 7468 6520 6272 616e 6368 696e 6720  r the branching 
+0003b300: 6661 6374 6f72 2c20 7468 6520 6d6f 7265  factor, the more
+0003b310: 2064 6174 6120 7765 2063 6f70 7920 696e   data we copy in
+0003b320: 0a20 2020 2020 2020 2020 2020 2061 2073  .            a s
+0003b330: 696e 676c 6520 7374 6570 2c20 6275 7420  ingle step, but 
+0003b340: 7468 6520 6d6f 7265 2061 2067 6976 656e  the more a given
+0003b350: 2077 6f72 6b65 7220 7269 736b 7320 6265   worker risks be
+0003b360: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
+0003b370: 7377 616d 7065 6420 6279 2064 6174 6120  swamped by data 
+0003b380: 7265 7175 6573 7473 2e0a 0a20 2020 2020  requests...     
+0003b390: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+0003b3a0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0003b3b0: 2020 2020 2053 6368 6564 756c 6572 2e72       Scheduler.r
+0003b3c0: 6562 616c 616e 6365 0a20 2020 2020 2020  ebalance.       
+0003b3d0: 2022 2222 0a20 2020 2020 2020 2073 7469   """.        sti
+0003b3e0: 6d75 6c75 735f 6964 203d 2073 7469 6d75  mulus_id = stimu
+0003b3f0: 6c75 735f 6964 206f 7220 6622 7265 706c  lus_id or f"repl
+0003b400: 6963 6174 652d 7b74 696d 6528 297d 220a  icate-{time()}".
+0003b410: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
+0003b420: 7261 6e63 6869 6e67 5f66 6163 746f 7220  ranching_factor 
+0003b430: 3e20 300a 2020 2020 2020 2020 6173 796e  > 0.        asyn
+0003b440: 6320 7769 7468 2073 656c 662e 5f6c 6f63  c with self._loc
+0003b450: 6b20 6966 206c 6f63 6b20 656c 7365 2065  k if lock else e
+0003b460: 6d70 7479 5f63 6f6e 7465 7874 3a0a 2020  mpty_context:.  
+0003b470: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
+0003b480: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
+0003b490: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b4a0: 2020 776f 726b 6572 7320 3d20 7b73 656c    workers = {sel
+0003b4b0: 662e 776f 726b 6572 735b 775d 2066 6f72  f.workers[w] for
+0003b4c0: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
+0003b4d0: 7273 5f6c 6973 7428 776f 726b 6572 7329  rs_list(workers)
+0003b4e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003b4f0: 2020 776f 726b 6572 7320 3d20 7b77 7320    workers = {ws 
+0003b500: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
+0003b510: 7320 6966 2077 732e 7374 6174 7573 203d  s if ws.status =
+0003b520: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
+0003b530: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
+0003b540: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003b550: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
+0003b560: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
+0003b570: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
+0003b580: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0003b590: 2020 2020 2020 6e20 3d20 6c65 6e28 776f        n = len(wo
+0003b5a0: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
+0003b5b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003b5c0: 2020 2020 2020 2020 206e 203d 206d 696e           n = min
+0003b5d0: 286e 2c20 6c65 6e28 776f 726b 6572 7329  (n, len(workers)
+0003b5e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0003b5f0: 206e 203d 3d20 303a 0a20 2020 2020 2020   n == 0:.       
+0003b600: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+0003b610: 616c 7565 4572 726f 7228 2243 616e 206e  alueError("Can n
+0003b620: 6f74 2075 7365 2072 6570 6c69 6361 7465  ot use replicate
+0003b630: 2074 6f20 6465 6c65 7465 2064 6174 6122   to delete data"
+0003b640: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
+0003b650: 6173 6b73 203d 207b 7365 6c66 2e74 6173  asks = {self.tas
+0003b660: 6b73 5b6b 5d20 666f 7220 6b20 696e 206b  ks[k] for k in k
+0003b670: 6579 737d 0a20 2020 2020 2020 2020 2020  eys}.           
+0003b680: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
+0003b690: 5b74 732e 6b65 7920 666f 7220 7473 2069  [ts.key for ts i
+0003b6a0: 6e20 7461 736b 7320 6966 206e 6f74 2074  n tasks if not t
+0003b6b0: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
+0003b6c0: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
+0003b6d0: 675f 6461 7461 3a0a 2020 2020 2020 2020  g_data:.        
+0003b6e0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003b6f0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
+0003b700: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
+0003b710: 3a20 6d69 7373 696e 675f 6461 7461 7d0a  : missing_data}.
+0003b720: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
+0003b730: 656c 6574 6520 6578 7472 616e 656f 7573  elete extraneous
+0003b740: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
+0003b750: 2020 6966 2064 656c 6574 653a 0a20 2020    if delete:.   
+0003b760: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0003b770: 5f77 6f72 6b65 725f 7461 736b 7320 3d20  _worker_tasks = 
+0003b780: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
+0003b790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b7a0: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
+0003b7b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003b7c0: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
+0003b7d0: 6174 6573 203d 2074 7570 6c65 2874 732e  ates = tuple(ts.
+0003b7e0: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
+0003b7f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0003b800: 2020 2020 2020 2069 6620 6c65 6e28 6465         if len(de
+0003b810: 6c5f 6361 6e64 6964 6174 6573 2920 3e20  l_candidates) > 
+0003b820: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0003b830: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
+0003b840: 7320 696e 2072 616e 646f 6d2e 7361 6d70  s in random.samp
+0003b850: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
+0003b860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b870: 6465 6c5f 6361 6e64 6964 6174 6573 2c20  del_candidates, 
+0003b880: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
+0003b890: 6573 2920 2d20 6e0a 2020 2020 2020 2020  es) - n.        
+0003b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b8b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003b8c0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003b8d0: 656c 5f77 6f72 6b65 725f 7461 736b 735b  el_worker_tasks[
+0003b8e0: 7773 5d2e 6164 6428 7473 290a 0a20 2020  ws].add(ts)..   
+0003b8f0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
+0003b900: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
+0003b910: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
+0003b920: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003b930: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0003b940: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+0003b950: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
+0003b960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b970: 2020 2020 2020 2073 656c 662e 6465 6c65         self.dele
+0003b980: 7465 5f77 6f72 6b65 725f 6461 7461 280a  te_worker_data(.
+0003b990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b9a0: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
+0003b9b0: 6464 7265 7373 2c20 5b74 2e6b 6579 2066  ddress, [t.key f
+0003b9c0: 6f72 2074 2069 6e20 7461 736b 735d 2c20  or t in tasks], 
+0003b9d0: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
+0003b9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b9f0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0003ba00: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003ba10: 7220 7773 2c20 7461 736b 7320 696e 2064  r ws, tasks in d
+0003ba20: 656c 5f77 6f72 6b65 725f 7461 736b 732e  el_worker_tasks.
+0003ba30: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+0003ba40: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+0003ba50: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003ba60: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0003ba70: 6f70 7920 6e6f 742d 7965 742d 6669 6c6c  opy not-yet-fill
+0003ba80: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
+0003ba90: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
+0003baa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bab0: 2067 6174 6865 7273 203d 2064 6566 6175   gathers = defau
+0003bac0: 6c74 6469 6374 2864 6963 7429 0a20 2020  ltdict(dict).   
+0003bad0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003bae0: 2074 7320 696e 206c 6973 7428 7461 736b   ts in list(task
+0003baf0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0003bb00: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+0003bb10: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
+0003bb20: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+0003bb30: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
+0003bb40: 736b 2069 7320 6e6f 206c 6f6e 6765 7220  sk is no longer 
+0003bb50: 6e65 6564 6564 2062 7920 616e 7920 636c  needed by any cl
+0003bb60: 6965 6e74 206f 7220 6465 7065 6e64 656e  ient or dependen
+0003bb70: 7420 7461 736b 0a20 2020 2020 2020 2020  t task.         
+0003bb80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0003bb90: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
+0003bba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bbb0: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0003bbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bbd0: 2020 2020 206e 5f6d 6973 7369 6e67 203d       n_missing =
+0003bbe0: 206e 202d 206c 656e 2874 732e 7768 6f5f   n - len(ts.who_
+0003bbf0: 6861 7320 2620 776f 726b 6572 7329 0a20  has & workers). 
+0003bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bc10: 2020 2069 6620 6e5f 6d69 7373 696e 6720     if n_missing 
+0003bc20: 3c3d 2030 3a0a 2020 2020 2020 2020 2020  <= 0:.          
+0003bc30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003bc40: 416c 7265 6164 7920 7265 706c 6963 6174  Already replicat
+0003bc50: 6564 2065 6e6f 7567 680a 2020 2020 2020  ed enough.      
+0003bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bc70: 2020 7461 736b 732e 7265 6d6f 7665 2874    tasks.remove(t
+0003bc80: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0003bc90: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0003bca0: 6e75 650a 0a20 2020 2020 2020 2020 2020  nue..           
+0003bcb0: 2020 2020 2020 2020 2063 6f75 6e74 203d           count =
+0003bcc0: 206d 696e 286e 5f6d 6973 7369 6e67 2c20   min(n_missing, 
+0003bcd0: 6272 616e 6368 696e 675f 6661 6374 6f72  branching_factor
+0003bce0: 202a 206c 656e 2874 732e 7768 6f5f 6861   * len(ts.who_ha
+0003bcf0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0003bd00: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
+0003bd10: 6f75 6e74 203e 2030 0a0a 2020 2020 2020  ount > 0..      
+0003bd20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0003bd30: 7220 7773 2069 6e20 7261 6e64 6f6d 2e73  r ws in random.s
+0003bd40: 616d 706c 6528 7475 706c 6528 776f 726b  ample(tuple(work
+0003bd50: 6572 7320 2d20 7473 2e77 686f 5f68 6173  ers - ts.who_has
+0003bd60: 292c 2063 6f75 6e74 293a 0a20 2020 2020  ), count):.     
+0003bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bd80: 2020 2067 6174 6865 7273 5b77 732e 6164     gathers[ws.ad
+0003bd90: 6472 6573 735d 5b74 732e 6b65 795d 203d  dress][ts.key] =
+0003bda0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+0003bdb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0003bdc0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
+0003bdd0: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+0003bde0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003bdf0: 2020 2020 2020 2020 205d 0a0a 2020 2020           ]..    
+0003be00: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+0003be10: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
+0003be20: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003be30: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
+0003be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003be50: 2023 204e 6f74 653a 2074 6869 7320 6e65   # Note: this ne
+0003be60: 7665 7220 7261 6973 6573 2065 7863 6570  ver raises excep
+0003be70: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+0003be80: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0003be90: 6c66 2e67 6174 6865 725f 6f6e 5f77 6f72  lf.gather_on_wor
+0003bea0: 6b65 7228 772c 2077 686f 5f68 6173 290a  ker(w, who_has).
+0003beb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bec0: 2020 2020 2020 2020 666f 7220 772c 2077          for w, w
+0003bed0: 686f 5f68 6173 2069 6e20 6761 7468 6572  ho_has in gather
+0003bee0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+0003bef0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003bf00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003bf20: 2020 666f 7220 722c 2076 2069 6e20 6761    for r, v in ga
+0003bf30: 7468 6572 732e 6974 656d 7328 293a 0a20  thers.items():. 
+0003bf40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bf50: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0003bf60: 7428 722c 207b 2261 6374 696f 6e22 3a20  t(r, {"action": 
+0003bf70: 2272 6570 6c69 6361 7465 2d61 6464 222c  "replicate-add",
+0003bf80: 2022 7768 6f5f 6861 7322 3a20 767d 290a   "who_has": v}).
+0003bf90: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0003bfa0: 662e 6c6f 675f 6576 656e 7428 0a20 2020  f.log_event(.   
+0003bfb0: 2020 2020 2020 2020 2020 2020 2022 616c               "al
+0003bfc0: 6c22 2c0a 2020 2020 2020 2020 2020 2020  l",.            
+0003bfd0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0003bfe0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+0003bff0: 6e22 3a20 2272 6570 6c69 6361 7465 222c  n": "replicate",
+0003c000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003c010: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
+0003c020: 6c69 7374 2877 6f72 6b65 7273 292c 0a20  list(workers),. 
+0003c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c040: 2020 2022 6b65 792d 636f 756e 7422 3a20     "key-count": 
+0003c050: 6c65 6e28 6b65 7973 292c 0a20 2020 2020  len(keys),.     
+0003c060: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003c070: 6272 616e 6368 696e 672d 6661 6374 6f72  branching-factor
+0003c080: 223a 2062 7261 6e63 6869 6e67 5f66 6163  ": branching_fac
+0003c090: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+0003c0a0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+0003c0b0: 2020 2020 290a 0a20 2020 2064 6566 2077      )..    def w
+0003c0c0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003c0d0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+0003c0e0: 2020 2020 2020 206d 656d 6f72 795f 7261         memory_ra
+0003c0f0: 7469 6f3a 2069 6e74 207c 2066 6c6f 6174  tio: int | float
+0003c100: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+0003c110: 2020 2020 2020 2020 6e3a 2069 6e74 207c          n: int |
+0003c120: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+0003c130: 2020 2020 2020 6b65 793a 2043 616c 6c61        key: Calla
+0003c140: 626c 655b 5b57 6f72 6b65 7253 7461 7465  ble[[WorkerState
+0003c150: 5d2c 2048 6173 6861 626c 655d 207c 2062  ], Hashable] | b
+0003c160: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
+0003c170: 6e65 2c0a 2020 2020 2020 2020 6d69 6e69  ne,.        mini
+0003c180: 6d75 6d3a 2069 6e74 207c 204e 6f6e 6520  mum: int | None 
+0003c190: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0003c1a0: 7461 7267 6574 3a20 696e 7420 7c20 4e6f  target: int | No
+0003c1b0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003c1c0: 2020 2061 7474 7269 6275 7465 3a20 7374     attribute: st
+0003c1d0: 7220 3d20 2261 6464 7265 7373 222c 0a20  r = "address",. 
+0003c1e0: 2020 2029 202d 3e20 6c69 7374 5b73 7472     ) -> list[str
+0003c1f0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+0003c200: 2020 2020 2020 2046 696e 6420 776f 726b         Find work
+0003c210: 6572 7320 7468 6174 2077 6520 6361 6e20  ers that we can 
+0003c220: 636c 6f73 6520 7769 7468 206c 6f77 2063  close with low c
+0003c230: 6f73 740a 0a20 2020 2020 2020 2054 6869  ost..        Thi
+0003c240: 7320 7265 7475 726e 7320 6120 6c69 7374  s returns a list
+0003c250: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
+0003c260: 2061 7265 2067 6f6f 6420 6361 6e64 6964   are good candid
+0003c270: 6174 6573 2074 6f20 7265 7469 7265 2e0a  ates to retire..
+0003c280: 2020 2020 2020 2020 5468 6573 6520 776f          These wo
+0003c290: 726b 6572 7320 6172 6520 6e6f 7420 7275  rkers are not ru
+0003c2a0: 6e6e 696e 6720 616e 7974 6869 6e67 2061  nning anything a
+0003c2b0: 6e64 2061 7265 2073 746f 7269 6e67 0a20  nd are storing. 
+0003c2c0: 2020 2020 2020 2072 656c 6174 6976 656c         relativel
+0003c2d0: 7920 6c69 7474 6c65 2064 6174 6120 7265  y little data re
+0003c2e0: 6c61 7469 7665 2074 6f20 7468 6569 7220  lative to their 
+0003c2f0: 7065 6572 732e 2020 4966 2061 6c6c 2077  peers.  If all w
+0003c300: 6f72 6b65 7273 2061 7265 0a20 2020 2020  orkers are.     
+0003c310: 2020 2069 646c 6520 7468 656e 2077 6520     idle then we 
+0003c320: 7374 696c 6c20 6d61 696e 7461 696e 2065  still maintain e
+0003c330: 6e6f 7567 6820 776f 726b 6572 7320 746f  nough workers to
+0003c340: 2068 6176 6520 656e 6f75 6768 2052 414d   have enough RAM
+0003c350: 2074 6f20 7374 6f72 650a 2020 2020 2020   to store.      
+0003c360: 2020 6f75 7220 6461 7461 2c20 7769 7468    our data, with
+0003c370: 2061 2063 6f6d 666f 7274 6162 6c65 2062   a comfortable b
+0003c380: 7566 6665 722e 0a0a 2020 2020 2020 2020  uffer...        
+0003c390: 5468 6973 2069 7320 666f 7220 7573 6520  This is for use 
+0003c3a0: 7769 7468 2073 7973 7465 6d73 206c 696b  with systems lik
+0003c3b0: 6520 6060 6469 7374 7269 6275 7465 642e  e ``distributed.
+0003c3c0: 6465 706c 6f79 2e61 6461 7074 6976 6560  deploy.adaptive`
+0003c3d0: 602e 0a0a 2020 2020 2020 2020 5061 7261  `...        Para
+0003c3e0: 6d65 7465 7273 0a20 2020 2020 2020 202d  meters.        -
+0003c3f0: 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020  ---------.      
+0003c400: 2020 6d65 6d6f 7279 5f72 6174 696f 203a    memory_ratio :
+0003c410: 204e 756d 6265 720a 2020 2020 2020 2020   Number.        
+0003c420: 2020 2020 416d 6f75 6e74 206f 6620 6578      Amount of ex
+0003c430: 7472 6120 7370 6163 6520 7765 2077 616e  tra space we wan
+0003c440: 7420 746f 2068 6176 6520 666f 7220 6f75  t to have for ou
+0003c450: 7220 7374 6f72 6564 2064 6174 612e 0a20  r stored data.. 
+0003c460: 2020 2020 2020 2020 2020 2044 6566 6175             Defau
+0003c470: 6c74 7320 746f 2032 2c20 6f72 2074 6861  lts to 2, or tha
+0003c480: 7420 7765 2077 616e 7420 746f 2068 6176  t we want to hav
+0003c490: 6520 7477 6963 6520 6173 206d 7563 6820  e twice as much 
+0003c4a0: 6d65 6d6f 7279 2061 7320 7765 0a20 2020  memory as we.   
+0003c4b0: 2020 2020 2020 2020 2063 7572 7265 6e74           current
+0003c4c0: 6c79 2068 6176 6520 6461 7461 2e0a 2020  ly have data..  
+0003c4d0: 2020 2020 2020 6e20 3a20 696e 740a 2020        n : int.  
+0003c4e0: 2020 2020 2020 2020 2020 4e75 6d62 6572            Number
+0003c4f0: 206f 6620 776f 726b 6572 7320 746f 2063   of workers to c
+0003c500: 6c6f 7365 0a20 2020 2020 2020 206d 696e  lose.        min
+0003c510: 696d 756d 203a 2069 6e74 0a20 2020 2020  imum : int.     
+0003c520: 2020 2020 2020 204d 696e 696d 756d 206e         Minimum n
+0003c530: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
+0003c540: 2074 6f20 6b65 6570 2061 726f 756e 640a   to keep around.
+0003c550: 2020 2020 2020 2020 6b65 7920 3a20 4361          key : Ca
+0003c560: 6c6c 6162 6c65 2857 6f72 6b65 7253 7461  llable(WorkerSta
+0003c570: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
+0003c580: 416e 206f 7074 696f 6e61 6c20 6361 6c6c  An optional call
+0003c590: 6162 6c65 206d 6170 7069 6e67 2061 2057  able mapping a W
+0003c5a0: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
+0003c5b0: 7420 746f 2061 2067 726f 7570 0a20 2020  t to a group.   
+0003c5c0: 2020 2020 2020 2020 2061 6666 696c 6961           affilia
+0003c5d0: 7469 6f6e 2e20 4772 6f75 7073 2077 696c  tion. Groups wil
+0003c5e0: 6c20 6265 2063 6c6f 7365 6420 746f 6765  l be closed toge
+0003c5f0: 7468 6572 2e20 5468 6973 2069 7320 7573  ther. This is us
+0003c600: 6566 756c 2077 6865 6e0a 2020 2020 2020  eful when.      
+0003c610: 2020 2020 2020 636c 6f73 696e 6720 776f        closing wo
+0003c620: 726b 6572 7320 6d75 7374 2062 6520 646f  rkers must be do
+0003c630: 6e65 2063 6f6c 6c65 6374 6976 656c 792c  ne collectively,
+0003c640: 2073 7563 6820 6173 2062 7920 686f 7374   such as by host
+0003c650: 6e61 6d65 2e0a 2020 2020 2020 2020 7461  name..        ta
+0003c660: 7267 6574 203a 2069 6e74 0a20 2020 2020  rget : int.     
+0003c670: 2020 2020 2020 2054 6172 6765 7420 6e75         Target nu
+0003c680: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
+0003c690: 746f 2068 6176 6520 6166 7465 7220 7765  to have after we
+0003c6a0: 2063 6c6f 7365 0a20 2020 2020 2020 2061   close.        a
+0003c6b0: 7474 7269 6275 7465 203a 2073 7472 0a20  ttribute : str. 
+0003c6c0: 2020 2020 2020 2020 2020 2054 6865 2061             The a
+0003c6d0: 7474 7269 6275 7465 206f 6620 7468 6520  ttribute of the 
+0003c6e0: 576f 726b 6572 5374 6174 6520 6f62 6a65  WorkerState obje
+0003c6f0: 6374 2074 6f20 7265 7475 726e 2c20 6c69  ct to return, li
+0003c700: 6b65 2022 6164 6472 6573 7322 0a20 2020  ke "address".   
+0003c710: 2020 2020 2020 2020 206f 7220 226e 616d           or "nam
+0003c720: 6522 2e20 2044 6566 6175 6c74 7320 746f  e".  Defaults to
+0003c730: 2022 6164 6472 6573 7322 2e0a 0a20 2020   "address"...   
+0003c740: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
+0003c750: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+0003c760: 2020 2020 2020 203e 3e3e 2073 6368 6564         >>> sched
+0003c770: 756c 6572 2e77 6f72 6b65 7273 5f74 6f5f  uler.workers_to_
+0003c780: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
+0003c790: 5b27 7463 703a 2f2f 3139 322e 3136 382e  ['tcp://192.168.
+0003c7a0: 302e 313a 3132 3334 272c 2027 7463 703a  0.1:1234', 'tcp:
+0003c7b0: 2f2f 3139 322e 3136 382e 302e 323a 3132  //192.168.0.2:12
+0003c7c0: 3334 275d 0a0a 2020 2020 2020 2020 4772  34']..        Gr
+0003c7d0: 6f75 7020 776f 726b 6572 7320 6279 2068  oup workers by h
+0003c7e0: 6f73 746e 616d 6520 7072 696f 7220 746f  ostname prior to
+0003c7f0: 2063 6c6f 7369 6e67 0a0a 2020 2020 2020   closing..      
+0003c800: 2020 3e3e 3e20 7363 6865 6475 6c65 722e    >>> scheduler.
+0003c810: 776f 726b 6572 735f 746f 5f63 6c6f 7365  workers_to_close
+0003c820: 286b 6579 3d6c 616d 6264 6120 7773 3a20  (key=lambda ws: 
+0003c830: 7773 2e68 6f73 7429 0a20 2020 2020 2020  ws.host).       
+0003c840: 205b 2774 6370 3a2f 2f31 3932 2e31 3638   ['tcp://192.168
+0003c850: 2e30 2e31 3a31 3233 3427 2c20 2774 6370  .0.1:1234', 'tcp
+0003c860: 3a2f 2f31 3932 2e31 3638 2e30 2e31 3a34  ://192.168.0.1:4
+0003c870: 3536 3727 5d0a 0a20 2020 2020 2020 2052  567']..        R
+0003c880: 656d 6f76 6520 7477 6f20 776f 726b 6572  emove two worker
+0003c890: 730a 0a20 2020 2020 2020 203e 3e3e 2073  s..        >>> s
+0003c8a0: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0003c8b0: 5f74 6f5f 636c 6f73 6528 6e3d 3229 0a0a  _to_close(n=2)..
+0003c8c0: 2020 2020 2020 2020 4b65 6570 2065 6e6f          Keep eno
+0003c8d0: 7567 6820 776f 726b 6572 7320 746f 2068  ugh workers to h
+0003c8e0: 6176 6520 7477 6963 6520 6173 206d 7563  ave twice as muc
+0003c8f0: 6820 6d65 6d6f 7279 2061 7320 7765 2077  h memory as we w
+0003c900: 6520 6e65 6564 2e0a 0a20 2020 2020 2020  e need...       
+0003c910: 203e 3e3e 2073 6368 6564 756c 6572 2e77   >>> scheduler.w
+0003c920: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
+0003c930: 6d65 6d6f 7279 5f72 6174 696f 3d32 290a  memory_ratio=2).
+0003c940: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0003c950: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0003c960: 0a20 2020 2020 2020 2074 6f5f 636c 6f73  .        to_clos
+0003c970: 653a 206c 6973 7420 6f66 2077 6f72 6b65  e: list of worke
+0003c980: 7220 6164 6472 6573 7365 7320 7468 6174  r addresses that
+0003c990: 2061 7265 204f 4b20 746f 2063 6c6f 7365   are OK to close
+0003c9a0: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
+0003c9b0: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
+0003c9c0: 2d2d 2d0a 2020 2020 2020 2020 5363 6865  ---.        Sche
+0003c9d0: 6475 6c65 722e 7265 7469 7265 5f77 6f72  duler.retire_wor
+0003c9e0: 6b65 7273 0a20 2020 2020 2020 2022 2222  kers.        """
+0003c9f0: 0a20 2020 2020 2020 2069 6620 7461 7267  .        if targ
+0003ca00: 6574 2069 7320 6e6f 7420 4e6f 6e65 2061  et is not None a
+0003ca10: 6e64 206e 2069 7320 4e6f 6e65 3a0a 2020  nd n is None:.  
+0003ca20: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
+0003ca30: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
+0003ca40: 2d20 7461 7267 6574 0a20 2020 2020 2020  - target.       
+0003ca50: 2069 6620 6e20 6973 206e 6f74 204e 6f6e   if n is not Non
+0003ca60: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0003ca70: 6620 6e20 3c20 303a 0a20 2020 2020 2020  f n < 0:.       
+0003ca80: 2020 2020 2020 2020 206e 203d 2030 0a20           n = 0. 
+0003ca90: 2020 2020 2020 2020 2020 2074 6172 6765             targe
+0003caa0: 7420 3d20 6c65 6e28 7365 6c66 2e77 6f72  t = len(self.wor
+0003cab0: 6b65 7273 2920 2d20 6e0a 0a20 2020 2020  kers) - n..     
+0003cac0: 2020 2069 6620 6e20 6973 204e 6f6e 6520     if n is None 
+0003cad0: 616e 6420 6d65 6d6f 7279 5f72 6174 696f  and memory_ratio
+0003cae0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003caf0: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
+0003cb00: 696f 203d 2032 0a0a 2020 2020 2020 2020  io = 2..        
+0003cb10: 7769 7468 206c 6f67 5f65 7272 6f72 7328  with log_errors(
+0003cb20: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0003cb30: 6620 6e6f 7420 6e20 616e 6420 616c 6c28  f not n and all(
+0003cb40: 5b77 732e 7072 6f63 6573 7369 6e67 2066  [ws.processing f
+0003cb50: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
+0003cb60: 726b 6572 732e 7661 6c75 6573 2829 5d29  rkers.values()])
+0003cb70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003cb80: 2020 7265 7475 726e 205b 5d0a 0a20 2020    return []..   
+0003cb90: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+0003cba0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0003cbb0: 2020 2020 2020 2020 206b 6579 203d 206f           key = o
+0003cbc0: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+0003cbd0: 6572 2822 6164 6472 6573 7322 290a 2020  er("address").  
+0003cbe0: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+0003cbf0: 6e73 7461 6e63 6528 6b65 792c 2062 7974  nstance(key, byt
+0003cc00: 6573 2920 616e 6420 6461 736b 2e63 6f6e  es) and dask.con
+0003cc10: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+0003cc20: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
+0003cc30: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
+0003cc40: 7069 636b 6c65 220a 2020 2020 2020 2020  pickle".        
+0003cc50: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0003cc60: 2020 2020 2020 206b 6579 203d 2070 6963         key = pic
+0003cc70: 6b6c 652e 6c6f 6164 7328 6b65 7929 0a0a  kle.loads(key)..
+0003cc80: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0003cc90: 7073 203d 2067 726f 7570 6279 286b 6579  ps = groupby(key
+0003cca0: 2c20 7365 6c66 2e77 6f72 6b65 7273 2e76  , self.workers.v
+0003ccb0: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
+0003ccc0: 2020 2020 2020 6c69 6d69 745f 6279 7465        limit_byte
+0003ccd0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
+0003cce0: 2020 2020 2020 6b3a 2073 756d 2877 732e        k: sum(ws.
+0003ccf0: 6d65 6d6f 7279 5f6c 696d 6974 2066 6f72  memory_limit for
+0003cd00: 2077 7320 696e 2076 2920 666f 7220 6b2c   ws in v) for k,
+0003cd10: 2076 2069 6e20 6772 6f75 7073 2e69 7465   v in groups.ite
+0003cd20: 6d73 2829 0a20 2020 2020 2020 2020 2020  ms().           
+0003cd30: 207d 0a20 2020 2020 2020 2020 2020 2067   }.            g
+0003cd40: 726f 7570 5f62 7974 6573 203d 207b 6b3a  roup_bytes = {k:
+0003cd50: 2073 756d 2877 732e 6e62 7974 6573 2066   sum(ws.nbytes f
+0003cd60: 6f72 2077 7320 696e 2076 2920 666f 7220  or ws in v) for 
+0003cd70: 6b2c 2076 2069 6e20 6772 6f75 7073 2e69  k, v in groups.i
+0003cd80: 7465 6d73 2829 7d0a 0a20 2020 2020 2020  tems()}..       
+0003cd90: 2020 2020 206c 696d 6974 203d 2073 756d       limit = sum
+0003cda0: 286c 696d 6974 5f62 7974 6573 2e76 616c  (limit_bytes.val
+0003cdb0: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+0003cdc0: 2020 2074 6f74 616c 203d 2073 756d 2867     total = sum(g
+0003cdd0: 726f 7570 5f62 7974 6573 2e76 616c 7565  roup_bytes.value
+0003cde0: 7328 2929 0a0a 2020 2020 2020 2020 2020  s())..          
+0003cdf0: 2020 6465 6620 5f6b 6579 2867 726f 7570    def _key(group
+0003ce00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003ce10: 2020 2069 735f 6964 6c65 203d 206e 6f74     is_idle = not
+0003ce20: 2061 6e79 285b 7777 732e 7072 6f63 6573   any([wws.proces
+0003ce30: 7369 6e67 2066 6f72 2077 7773 2069 6e20  sing for wws in 
+0003ce40: 6772 6f75 7073 5b67 726f 7570 5d5d 290a  groups[group]]).
+0003ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ce60: 6279 7465 7320 3d20 2d67 726f 7570 5f62  bytes = -group_b
+0003ce70: 7974 6573 5b67 726f 7570 5d0a 2020 2020  ytes[group].    
+0003ce80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0003ce90: 726e 2069 735f 6964 6c65 2c20 6279 7465  rn is_idle, byte
+0003cea0: 730a 0a20 2020 2020 2020 2020 2020 2069  s..            i
+0003ceb0: 646c 6520 3d20 736f 7274 6564 2867 726f  dle = sorted(gro
+0003cec0: 7570 732c 206b 6579 3d5f 6b65 7929 0a0a  ups, key=_key)..
+0003ced0: 2020 2020 2020 2020 2020 2020 746f 5f63              to_c
+0003cee0: 6c6f 7365 203d 205b 5d0a 2020 2020 2020  lose = [].      
+0003cef0: 2020 2020 2020 6e5f 7265 6d61 696e 203d        n_remain =
+0003cf00: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+0003cf10: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+0003cf20: 7768 696c 6520 6964 6c65 3a0a 2020 2020  while idle:.    
+0003cf30: 2020 2020 2020 2020 2020 2020 6772 6f75              grou
+0003cf40: 7020 3d20 6964 6c65 2e70 6f70 2829 0a20  p = idle.pop(). 
+0003cf50: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003cf60: 6620 6e20 6973 204e 6f6e 6520 616e 6420  f n is None and 
+0003cf70: 616e 7928 5b77 732e 7072 6f63 6573 7369  any([ws.processi
+0003cf80: 6e67 2066 6f72 2077 7320 696e 2067 726f  ng for ws in gro
+0003cf90: 7570 735b 6772 6f75 705d 5d29 3a0a 2020  ups[group]]):.  
+0003cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cfb0: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
+0003cfc0: 2020 2020 2020 2020 2069 6620 6d69 6e69           if mini
+0003cfd0: 6d75 6d20 616e 6420 6e5f 7265 6d61 696e  mum and n_remain
+0003cfe0: 202d 206c 656e 2867 726f 7570 735b 6772   - len(groups[gr
+0003cff0: 6f75 705d 2920 3c20 6d69 6e69 6d75 6d3a  oup]) < minimum:
+0003d000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d010: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003d020: 2020 2020 2020 2020 2020 2020 6c69 6d69              limi
+0003d030: 7420 2d3d 206c 696d 6974 5f62 7974 6573  t -= limit_bytes
+0003d040: 5b67 726f 7570 5d0a 0a20 2020 2020 2020  [group]..       
+0003d050: 2020 2020 2020 2020 2069 6620 280a 2020           if (.  
+0003d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d070: 2020 6e20 6973 206e 6f74 204e 6f6e 6520    n is not None 
+0003d080: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
+0003d090: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
+0003d0a0: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
+0003d0b0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0003d0c0: 2020 2029 206f 7220 286d 656d 6f72 795f     ) or (memory_
+0003d0d0: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
+0003d0e0: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
+0003d0f0: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
+0003d100: 7461 6c29 3a0a 2020 2020 2020 2020 2020  tal):.          
+0003d110: 2020 2020 2020 2020 2020 746f 5f63 6c6f            to_clo
+0003d120: 7365 2e61 7070 656e 6428 6772 6f75 7029  se.append(group)
+0003d130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d140: 2020 2020 206e 5f72 656d 6169 6e20 2d3d       n_remain -=
+0003d150: 206c 656e 2867 726f 7570 735b 6772 6f75   len(groups[grou
+0003d160: 705d 290a 0a20 2020 2020 2020 2020 2020  p])..           
+0003d170: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003d180: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0003d190: 7265 616b 0a0a 2020 2020 2020 2020 2020  reak..          
+0003d1a0: 2020 7265 7375 6c74 203d 205b 6765 7461    result = [geta
+0003d1b0: 7474 7228 7773 2c20 6174 7472 6962 7574  ttr(ws, attribut
+0003d1c0: 6529 2066 6f72 2067 2069 6e20 746f 5f63  e) for g in to_c
+0003d1d0: 6c6f 7365 2066 6f72 2077 7320 696e 2067  lose for ws in g
+0003d1e0: 726f 7570 735b 675d 5d0a 2020 2020 2020  roups[g]].      
+0003d1f0: 2020 2020 2020 6966 2072 6573 756c 743a        if result:
+0003d200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d210: 206c 6f67 6765 722e 6465 6275 6728 2253   logger.debug("S
+0003d220: 7567 6765 7374 2063 6c6f 7369 6e67 2077  uggest closing w
+0003d230: 6f72 6b65 7273 3a20 2573 222c 2072 6573  orkers: %s", res
+0003d240: 756c 7429 0a0a 2020 2020 2020 2020 2020  ult)..          
+0003d250: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+0003d260: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
+0003d270: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
+0003d280: 6574 6972 655f 776f 726b 6572 7328 0a20  etire_workers(. 
+0003d290: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0003d2a0: 2020 2020 2077 6f72 6b65 7273 3a20 6c69       workers: li
+0003d2b0: 7374 5b73 7472 5d20 7c20 4e6f 6e65 203d  st[str] | None =
+0003d2c0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+0003d2d0: 2c0a 2020 2020 2020 2020 6e61 6d65 733a  ,.        names:
+0003d2e0: 206c 6973 7420 7c20 4e6f 6e65 203d 204e   list | None = N
+0003d2f0: 6f6e 652c 0a20 2020 2020 2020 2063 6c6f  one,.        clo
+0003d300: 7365 5f77 6f72 6b65 7273 3a20 626f 6f6c  se_workers: bool
+0003d310: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+0003d320: 2020 7265 6d6f 7665 3a20 626f 6f6c 203d    remove: bool =
+0003d330: 2054 7275 652c 0a20 2020 2020 2020 2073   True,.        s
+0003d340: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
+0003d350: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003d360: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
+0003d370: 2041 6e79 2c0a 2020 2020 2920 2d3e 2064   Any,.    ) -> d
+0003d380: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+0003d390: 2020 2020 2020 2022 2222 4772 6163 6566         """Gracef
+0003d3a0: 756c 6c79 2072 6574 6972 6520 776f 726b  ully retire work
+0003d3b0: 6572 7320 6672 6f6d 2063 6c75 7374 6572  ers from cluster
+0003d3c0: 2e20 416e 7920 6b65 7920 7468 6174 2069  . Any key that i
+0003d3d0: 7320 696e 206d 656d 6f72 7920 6578 636c  s in memory excl
+0003d3e0: 7573 6976 656c 790a 2020 2020 2020 2020  usively.        
+0003d3f0: 6f6e 2074 6865 2072 6574 6972 6564 2077  on the retired w
+0003d400: 6f72 6b65 7273 2069 7320 7265 706c 6963  orkers is replic
+0003d410: 6174 6564 2073 6f6d 6577 6865 7265 2065  ated somewhere e
+0003d420: 6c73 652e 0a0a 2020 2020 2020 2020 5061  lse...        Pa
+0003d430: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
+0003d440: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
+0003d450: 2020 2020 776f 726b 6572 733a 206c 6973      workers: lis
+0003d460: 745b 7374 725d 2028 6f70 7469 6f6e 616c  t[str] (optional
+0003d470: 290a 2020 2020 2020 2020 2020 2020 4c69  ).            Li
+0003d480: 7374 206f 6620 776f 726b 6572 2061 6464  st of worker add
+0003d490: 7265 7373 6573 2074 6f20 7265 7469 7265  resses to retire
+0003d4a0: 2e0a 2020 2020 2020 2020 6e61 6d65 733a  ..        names:
+0003d4b0: 206c 6973 7420 286f 7074 696f 6e61 6c29   list (optional)
+0003d4c0: 0a20 2020 2020 2020 2020 2020 204c 6973  .            Lis
+0003d4d0: 7420 6f66 2077 6f72 6b65 7220 6e61 6d65  t of worker name
+0003d4e0: 7320 746f 2072 6574 6972 652e 0a20 2020  s to retire..   
+0003d4f0: 2020 2020 2020 2020 204d 7574 7561 6c6c           Mutuall
+0003d500: 7920 6578 636c 7573 6976 6520 7769 7468  y exclusive with
+0003d510: 2060 6077 6f72 6b65 7273 6060 2e0a 2020   ``workers``..  
+0003d520: 2020 2020 2020 2020 2020 4966 206e 6569            If nei
+0003d530: 7468 6572 2060 6077 6f72 6b65 7273 6060  ther ``workers``
+0003d540: 206e 6f72 2060 606e 616d 6573 6060 2061   nor ``names`` a
+0003d550: 7265 2070 726f 7669 6465 642c 2077 6520  re provided, we 
+0003d560: 6361 6c6c 0a20 2020 2020 2020 2020 2020  call.           
+0003d570: 2060 6077 6f72 6b65 7273 5f74 6f5f 636c   ``workers_to_cl
+0003d580: 6f73 6560 6020 7768 6963 6820 6669 6e64  ose`` which find
+0003d590: 7320 6120 676f 6f64 2073 6574 2e0a 2020  s a good set..  
+0003d5a0: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
+0003d5b0: 6572 733a 2062 6f6f 6c20 2864 6566 6175  ers: bool (defau
+0003d5c0: 6c74 7320 746f 2046 616c 7365 290a 2020  lts to False).  
+0003d5d0: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
+0003d5e0: 7220 6f72 206e 6f74 2074 6f20 6163 7475  r or not to actu
+0003d5f0: 616c 6c79 2063 6c6f 7365 2074 6865 2077  ally close the w
+0003d600: 6f72 6b65 7220 6578 706c 6963 6974 6c79  orker explicitly
+0003d610: 2066 726f 6d20 6865 7265 2e0a 2020 2020   from here..    
+0003d620: 2020 2020 2020 2020 4f74 6865 7277 6973          Otherwis
+0003d630: 6520 7765 2065 7870 6563 7420 736f 6d65  e we expect some
+0003d640: 2065 7874 6572 6e61 6c20 6a6f 6220 7363   external job sc
+0003d650: 6865 6475 6c65 7220 746f 2066 696e 6973  heduler to finis
+0003d660: 6820 6f66 6620 7468 650a 2020 2020 2020  h off the.      
+0003d670: 2020 2020 2020 776f 726b 6572 2e0a 2020        worker..  
+0003d680: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
+0003d690: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
+0003d6a0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0003d6b0: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
+0003d6c0: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
+0003d6d0: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
+0003d6e0: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
+0003d6f0: 7365 0a20 2020 2020 2020 2020 2020 2077  se.            w
+0003d700: 6169 7420 666f 7220 7468 6520 776f 726b  ait for the work
+0003d710: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
+0003d720: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
+0003d730: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
+0003d740: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
+0003d750: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
+0003d760: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
+0003d770: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
+0003d780: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
+0003d790: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
+0003d7a0: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
+0003d7b0: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
+0003d7c0: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
+0003d7d0: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
+0003d7e0: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
+0003d7f0: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
+0003d800: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
+0003d810: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
+0003d820: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
+0003d830: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
+0003d840: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
+0003d850: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
+0003d860: 2020 2020 2020 2020 2020 2020 4966 2063              If c
+0003d870: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
+0003d880: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
+0003d890: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
+0003d8a0: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
+0003d8b0: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
+0003d8c0: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
+0003d8d0: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
+0003d8e0: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
+0003d8f0: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
+0003d900: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
+0003d910: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
+0003d920: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
+0003d930: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
+0003d940: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
+0003d950: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
+0003d960: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
+0003d970: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
+0003d980: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
+0003d990: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
+0003d9a0: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
+0003d9b0: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
+0003d9c0: 686f 756c 6420 6472 6f70 0a0a 2020 2020  hould drop..    
+0003d9d0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
+0003d9e0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
+0003d9f0: 2020 2020 4469 6374 696f 6e61 7279 206d      Dictionary m
+0003da00: 6170 7069 6e67 2077 6f72 6b65 7220 4944  apping worker ID
+0003da10: 2f61 6464 7265 7373 2074 6f20 6469 6374  /address to dict
+0003da20: 696f 6e61 7279 206f 6620 696e 666f 726d  ionary of inform
+0003da30: 6174 696f 6e20 6162 6f75 740a 2020 2020  ation about.    
+0003da40: 2020 2020 7468 6174 2077 6f72 6b65 7220      that worker 
+0003da50: 666f 7220 6561 6368 2072 6574 6972 6564  for each retired
+0003da60: 2077 6f72 6b65 722e 0a0a 2020 2020 2020   worker...      
+0003da70: 2020 4966 2074 6865 7265 2061 7265 206b    If there are k
+0003da80: 6579 7320 7468 6174 2065 7869 7374 2069  eys that exist i
+0003da90: 6e20 6d65 6d6f 7279 206f 6e6c 7920 6f6e  n memory only on
+0003daa0: 2074 6865 2077 6f72 6b65 7273 2062 6569   the workers bei
+0003dab0: 6e67 2072 6574 6972 6564 2061 6e64 2069  ng retired and i
+0003dac0: 740a 2020 2020 2020 2020 7761 7320 696d  t.        was im
+0003dad0: 706f 7373 6962 6c65 2074 6f20 7265 706c  possible to repl
+0003dae0: 6963 6174 6520 7468 656d 2073 6f6d 6577  icate them somew
+0003daf0: 6865 7265 2065 6c73 6520 2865 2e67 2e20  here else (e.g. 
+0003db00: 6265 6361 7573 6520 7468 6572 6520 6172  because there ar
+0003db10: 656e 2774 0a20 2020 2020 2020 2061 6e79  en't.        any
+0003db20: 206f 7468 6572 2072 756e 6e69 6e67 2077   other running w
+0003db30: 6f72 6b65 7273 292c 2074 6865 2077 6f72  orkers), the wor
+0003db40: 6b65 7273 2068 6f6c 6469 6e67 2073 7563  kers holding suc
+0003db50: 6820 6b65 7973 2077 6f6e 2774 2062 6520  h keys won't be 
+0003db60: 7265 7469 7265 6420 616e 640a 2020 2020  retired and.    
+0003db70: 2020 2020 776f 6e27 7420 6170 7065 6172      won't appear
+0003db80: 2069 6e20 7468 6520 7265 7475 726e 6564   in the returned
+0003db90: 2064 6963 742e 0a0a 2020 2020 2020 2020   dict...        
+0003dba0: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+0003dbb0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0003dbc0: 2020 5363 6865 6475 6c65 722e 776f 726b    Scheduler.work
+0003dbd0: 6572 735f 746f 5f63 6c6f 7365 0a20 2020  ers_to_close.   
+0003dbe0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003dbf0: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
+0003dc00: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
+0003dc10: 7265 7469 7265 2d77 6f72 6b65 7273 2d7b  retire-workers-{
+0003dc20: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+0003dc30: 2023 2054 6869 7320 6c6f 636b 206d 616b   # This lock mak
+0003dc40: 6573 2072 6574 6972 655f 776f 726b 6572  es retire_worker
+0003dc50: 732c 2072 6562 616c 616e 6365 2c20 616e  s, rebalance, an
+0003dc60: 6420 7265 706c 6963 6174 6520 6d75 7475  d replicate mutu
+0003dc70: 616c 6c79 0a20 2020 2020 2020 2023 2065  ally.        # e
+0003dc80: 7863 6c75 7369 7665 2061 6e64 2077 696c  xclusive and wil
+0003dc90: 6c20 6e6f 206c 6f6e 6765 7220 6265 206e  l no longer be n
+0003dca0: 6563 6573 7361 7279 206f 6e63 6520 7265  ecessary once re
+0003dcb0: 6261 6c61 6e63 6520 616e 6420 7265 706c  balance and repl
+0003dcc0: 6963 6174 6520 6172 650a 2020 2020 2020  icate are.      
+0003dcd0: 2020 2320 6d69 6772 6174 6564 2074 6f20    # migrated to 
+0003dce0: 7468 6520 4163 7469 7665 204d 656d 6f72  the Active Memor
+0003dcf0: 7920 4d61 6e61 6765 722e 0a20 2020 2020  y Manager..     
+0003dd00: 2020 2023 204e 6f74 6520 7468 6174 2c20     # Note that, 
+0003dd10: 696e 6369 6465 6e74 616c 6c79 2c20 6974  incidentally, it
+0003dd20: 2061 6c73 6f20 7072 6576 656e 7473 206d   also prevents m
+0003dd30: 756c 7469 706c 6520 6361 6c6c 7320 746f  ultiple calls to
+0003dd40: 2072 6574 6972 655f 776f 726b 6572 730a   retire_workers.
+0003dd50: 2020 2020 2020 2020 2320 6672 6f6d 2072          # from r
+0003dd60: 756e 6e69 6e67 2069 6e20 7061 7261 6c6c  unning in parall
+0003dd70: 656c 202d 2074 6869 7320 6973 2075 6e6e  el - this is unn
+0003dd80: 6563 6573 7361 7279 2e0a 2020 2020 2020  ecessary..      
+0003dd90: 2020 6173 796e 6320 7769 7468 2073 656c    async with sel
+0003dda0: 662e 5f6c 6f63 6b3a 0a20 2020 2020 2020  f._lock:.       
+0003ddb0: 2020 2020 2069 6620 6e61 6d65 7320 6973       if names is
+0003ddc0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0003ddd0: 2020 2020 2020 2020 2020 2069 6620 776f             if wo
+0003dde0: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+0003ddf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003de00: 2020 2020 2020 2072 6169 7365 2054 7970         raise Typ
+0003de10: 6545 7272 6f72 2822 6e61 6d65 7320 616e  eError("names an
+0003de20: 6420 776f 726b 6572 7320 6172 6520 6d75  d workers are mu
+0003de30: 7475 616c 6c79 2065 7863 6c75 7369 7665  tually exclusive
+0003de40: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+0003de50: 2020 2069 6620 6e61 6d65 733a 0a20 2020     if names:.   
+0003de60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de70: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+0003de80: 7469 7265 2077 6f72 6b65 7220 6e61 6d65  tire worker name
+0003de90: 7320 2573 222c 206e 616d 6573 290a 2020  s %s", names).  
+0003dea0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003deb0: 5375 7070 6f72 7420 6361 7365 7320 7768  Support cases wh
+0003dec0: 6572 6520 6e61 6d65 7320 6172 6520 7061  ere names are pa
+0003ded0: 7373 6564 2074 6872 6f75 6768 2061 2043  ssed through a C
+0003dee0: 4c49 2061 6e64 2062 6563 6f6d 650a 2020  LI and become.  
+0003def0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003df00: 7374 7269 6e67 730a 2020 2020 2020 2020  strings.        
+0003df10: 2020 2020 2020 2020 6e61 6d65 735f 7365          names_se
+0003df20: 7420 3d20 7b73 7472 286e 616d 6529 2066  t = {str(name) f
+0003df30: 6f72 206e 616d 6520 696e 206e 616d 6573  or name in names
+0003df40: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0003df50: 2020 7773 7320 3d20 7b77 7320 666f 7220    wss = {ws for 
+0003df60: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+0003df70: 7273 2e76 616c 7565 7328 2920 6966 2073  rs.values() if s
+0003df80: 7472 2877 732e 6e61 6d65 2920 696e 206e  tr(ws.name) in n
+0003df90: 616d 6573 5f73 6574 7d0a 2020 2020 2020  ames_set}.      
+0003dfa0: 2020 2020 2020 656c 6966 2077 6f72 6b65        elif worke
+0003dfb0: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
+0003dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dfd0: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
+0003dfe0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003dff0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
+0003e000: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0003e010: 2020 2020 2020 666f 7220 6164 6472 6573        for addres
+0003e020: 7320 696e 2077 6f72 6b65 7273 0a20 2020  s in workers.   
+0003e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e040: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
+0003e050: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
+0003e060: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+0003e070: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0003e080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e090: 7773 7320 3d20 7b0a 2020 2020 2020 2020  wss = {.        
+0003e0a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003e0b0: 2e77 6f72 6b65 7273 5b61 6464 7265 7373  .workers[address
+0003e0c0: 5d20 666f 7220 6164 6472 6573 7320 696e  ] for address in
+0003e0d0: 2073 656c 662e 776f 726b 6572 735f 746f   self.workers_to
+0003e0e0: 5f63 6c6f 7365 282a 2a6b 7761 7267 7329  _close(**kwargs)
+0003e0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e100: 207d 0a20 2020 2020 2020 2020 2020 2069   }.            i
+0003e110: 6620 6e6f 7420 7773 733a 0a20 2020 2020  f not wss:.     
+0003e120: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003e130: 6e20 7b7d 0a0a 2020 2020 2020 2020 2020  n {}..          
+0003e140: 2020 7374 6f70 5f61 6d6d 203d 2046 616c    stop_amm = Fal
+0003e150: 7365 0a20 2020 2020 2020 2020 2020 2061  se.            a
+0003e160: 6d6d 3a20 4163 7469 7665 4d65 6d6f 7279  mm: ActiveMemory
+0003e170: 4d61 6e61 6765 7245 7874 656e 7369 6f6e  ManagerExtension
+0003e180: 207c 204e 6f6e 6520 3d20 7365 6c66 2e65   | None = self.e
+0003e190: 7874 656e 7369 6f6e 732e 6765 7428 2261  xtensions.get("a
+0003e1a0: 6d6d 2229 0a20 2020 2020 2020 2020 2020  mm").           
+0003e1b0: 2069 6620 6e6f 7420 616d 6d20 6f72 206e   if not amm or n
+0003e1c0: 6f74 2061 6d6d 2e72 756e 6e69 6e67 3a0a  ot amm.running:.
 0003e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e1e0: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-0003e1f0: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-0003e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e210: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0003e220: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0003e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e240: 2020 2020 636f 726f 732e 6170 7065 6e64      coros.append
-0003e250: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0003e260: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0003e270: 7472 6163 6b5f 7265 7469 7265 5f77 6f72  track_retire_wor
-0003e280: 6b65 7228 0a20 2020 2020 2020 2020 2020  ker(.           
-0003e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e2a0: 2077 732c 0a20 2020 2020 2020 2020 2020   ws,.           
-0003e2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e2c0: 2070 6f6c 6963 792c 0a20 2020 2020 2020   policy,.       
-0003e2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e2e0: 2020 2020 2070 7265 765f 7374 6174 7573       prev_status
-0003e2f0: 3d70 7265 765f 7374 6174 7573 2c0a 2020  =prev_status,.  
-0003e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e310: 2020 2020 2020 2020 2020 636c 6f73 653d            close=
-0003e320: 636c 6f73 655f 776f 726b 6572 732c 0a20  close_workers,. 
-0003e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e340: 2020 2020 2020 2020 2020 2072 656d 6f76             remov
-0003e350: 653d 7265 6d6f 7665 2c0a 2020 2020 2020  e=remove,.      
-0003e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e370: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-0003e380: 643d 7374 696d 756c 7573 5f69 642c 0a20  d=stimulus_id,. 
-0003e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e3a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0003e3b0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0003e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e3d0: 2320 4769 7665 2074 6865 2041 4d4d 2061  # Give the AMM a
-0003e3e0: 206b 6963 6b2c 2069 6e20 6164 6469 7469   kick, in additi
-0003e3f0: 6f6e 2074 6f20 6974 7320 7065 7269 6f64  on to its period
-0003e400: 6963 2072 756e 6e69 6e67 2e20 5468 6973  ic running. This
-0003e410: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
-0003e420: 2020 2020 2320 746f 2061 766f 6964 2075      # to avoid u
-0003e430: 6e6e 6563 6573 7361 7269 6c79 2077 6169  nnecessarily wai
-0003e440: 7469 6e67 2066 6f72 2061 2070 6f74 656e  ting for a poten
-0003e450: 7469 616c 6c79 2061 7262 6974 7261 7269  tially arbitrari
-0003e460: 6c79 206c 6f6e 670a 2020 2020 2020 2020  ly long.        
-0003e470: 2020 2020 2020 2020 2320 7469 6d65 2028          # time (
-0003e480: 6465 7065 6e64 696e 6720 6f6e 2069 6e74  depending on int
-0003e490: 6572 7661 6c20 7365 7474 696e 6773 290a  erval settings).
-0003e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e4b0: 616d 6d2e 7275 6e5f 6f6e 6365 2829 0a0a  amm.run_once()..
+0003e1e0: 616d 6d20 3d20 4163 7469 7665 4d65 6d6f  amm = ActiveMemo
+0003e1f0: 7279 4d61 6e61 6765 7245 7874 656e 7369  ryManagerExtensi
+0003e200: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+0003e210: 2020 2020 2020 2020 7365 6c66 2c20 706f          self, po
+0003e220: 6c69 6369 6573 3d73 6574 2829 2c20 7265  licies=set(), re
+0003e230: 6769 7374 6572 3d46 616c 7365 2c20 7374  gister=False, st
+0003e240: 6172 743d 5472 7565 2c20 696e 7465 7276  art=True, interv
+0003e250: 616c 3d32 2e30 0a20 2020 2020 2020 2020  al=2.0.         
+0003e260: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0003e270: 2020 2020 2020 2020 2073 746f 705f 616d           stop_am
+0003e280: 6d20 3d20 5472 7565 0a0a 2020 2020 2020  m = True..      
+0003e290: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0003e2a0: 2020 2020 2020 2020 2020 2063 6f72 6f73             coros
+0003e2b0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0003e2c0: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0003e2d0: 7773 733a 0a20 2020 2020 2020 2020 2020  wss:.           
+0003e2e0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+0003e2f0: 696e 666f 2822 5265 7469 7269 6e67 2077  info("Retiring w
+0003e300: 6f72 6b65 7220 2573 222c 2077 732e 6164  orker %s", ws.ad
+0003e310: 6472 6573 7329 0a0a 2020 2020 2020 2020  dress)..        
+0003e320: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
+0003e330: 6379 203d 2052 6574 6972 6557 6f72 6b65  cy = RetireWorke
+0003e340: 7228 7773 2e61 6464 7265 7373 290a 2020  r(ws.address).  
+0003e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e360: 2020 616d 6d2e 6164 645f 706f 6c69 6379    amm.add_policy
+0003e370: 2870 6f6c 6963 7929 0a0a 2020 2020 2020  (policy)..      
+0003e380: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003e390: 4368 616e 6765 2057 6f72 6b65 722e 7374  Change Worker.st
+0003e3a0: 6174 7573 2074 6f20 636c 6f73 696e 675f  atus to closing_
+0003e3b0: 6772 6163 6566 756c 6c79 2e20 496d 6d65  gracefully. Imme
+0003e3c0: 6469 6174 656c 7920 7365 740a 2020 2020  diately set.    
+0003e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e3e0: 2320 7468 6520 7361 6d65 206f 6e20 7468  # the same on th
+0003e3f0: 6520 7363 6865 6475 6c65 7220 746f 2070  e scheduler to p
+0003e400: 7265 7665 6e74 2072 6163 6520 636f 6e64  revent race cond
+0003e410: 6974 696f 6e73 2e0a 2020 2020 2020 2020  itions..        
+0003e420: 2020 2020 2020 2020 2020 2020 7072 6576              prev
+0003e430: 5f73 7461 7475 7320 3d20 7773 2e73 7461  _status = ws.sta
+0003e440: 7475 730a 2020 2020 2020 2020 2020 2020  tus.            
+0003e450: 2020 2020 2020 2020 7365 6c66 2e68 616e          self.han
+0003e460: 646c 655f 776f 726b 6572 5f73 7461 7475  dle_worker_statu
+0003e470: 735f 6368 616e 6765 280a 2020 2020 2020  s_change(.      
+0003e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e490: 2020 5374 6174 7573 2e63 6c6f 7369 6e67    Status.closing
+0003e4a0: 5f67 7261 6365 6675 6c6c 792c 2077 732c  _gracefully, ws,
+0003e4b0: 2073 7469 6d75 6c75 735f 6964 0a20 2020   stimulus_id.   
 0003e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e4d0: 776f 726b 6572 735f 696e 666f 203d 2064  workers_info = d
-0003e4e0: 6963 7428 6177 6169 7420 6173 796e 6369  ict(await asynci
-0003e4f0: 6f2e 6761 7468 6572 282a 636f 726f 7329  o.gather(*coros)
-0003e500: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e510: 2020 776f 726b 6572 735f 696e 666f 2e70    workers_info.p
-0003e520: 6f70 284e 6f6e 652c 204e 6f6e 6529 0a20  op(None, None). 
-0003e530: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0003e540: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-0003e550: 2020 2020 6966 2073 746f 705f 616d 6d3a      if stop_amm:
-0003e560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e570: 2020 2020 2061 6d6d 2e73 746f 7028 290a       amm.stop().
-0003e580: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-0003e590: 675f 6576 656e 7428 2261 6c6c 222c 207b  g_event("all", {
-0003e5a0: 2261 6374 696f 6e22 3a20 2272 6574 6972  "action": "retir
-0003e5b0: 652d 776f 726b 6572 7322 2c20 2277 6f72  e-workers", "wor
-0003e5c0: 6b65 7273 223a 2077 6f72 6b65 7273 5f69  kers": workers_i
-0003e5d0: 6e66 6f7d 290a 2020 2020 2020 2020 7365  nfo}).        se
-0003e5e0: 6c66 2e6c 6f67 5f65 7665 6e74 286c 6973  lf.log_event(lis
-0003e5f0: 7428 776f 726b 6572 735f 696e 666f 292c  t(workers_info),
-0003e600: 207b 2261 6374 696f 6e22 3a20 2272 6574   {"action": "ret
-0003e610: 6972 6564 227d 290a 0a20 2020 2020 2020  ired"})..       
-0003e620: 2072 6574 7572 6e20 776f 726b 6572 735f   return workers_
-0003e630: 696e 666f 0a0a 2020 2020 6173 796e 6320  info..    async 
-0003e640: 6465 6620 5f74 7261 636b 5f72 6574 6972  def _track_retir
-0003e650: 655f 776f 726b 6572 280a 2020 2020 2020  e_worker(.      
-0003e660: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0003e670: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
-0003e680: 0a20 2020 2020 2020 2070 6f6c 6963 793a  .        policy:
-0003e690: 2052 6574 6972 6557 6f72 6b65 722c 0a20   RetireWorker,. 
-0003e6a0: 2020 2020 2020 2070 7265 765f 7374 6174         prev_stat
-0003e6b0: 7573 3a20 5374 6174 7573 2c0a 2020 2020  us: Status,.    
-0003e6c0: 2020 2020 636c 6f73 653a 2062 6f6f 6c2c      close: bool,
-0003e6d0: 0a20 2020 2020 2020 2072 656d 6f76 653a  .        remove:
-0003e6e0: 2062 6f6f 6c2c 0a20 2020 2020 2020 2073   bool,.        s
-0003e6f0: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
-0003e700: 0a20 2020 2029 202d 3e20 7475 706c 653a  .    ) -> tuple:
-0003e710: 2020 2320 7475 706c 655b 7374 7220 7c20    # tuple[str | 
-0003e720: 4e6f 6e65 2c20 6469 6374 5d0a 2020 2020  None, dict].    
-0003e730: 2020 2020 7768 696c 6520 6e6f 7420 706f      while not po
-0003e740: 6c69 6379 2e64 6f6e 6528 293a 0a20 2020  licy.done():.   
-0003e750: 2020 2020 2020 2020 2023 2053 6c65 6570           # Sleep
-0003e760: 2030 2e30 3173 2077 6865 6e20 7468 6572   0.01s when ther
-0003e770: 6520 6172 6520 3420 7461 736b 7320 6f72  e are 4 tasks or
-0003e780: 206c 6573 730a 2020 2020 2020 2020 2020   less.          
-0003e790: 2020 2320 536c 6565 7020 302e 3573 2077    # Sleep 0.5s w
-0003e7a0: 6865 6e20 7468 6572 6520 6172 6520 3230  hen there are 20
-0003e7b0: 3020 6f72 206d 6f72 650a 2020 2020 2020  0 or more.      
-0003e7c0: 2020 2020 2020 706f 6c6c 5f69 6e74 6572        poll_inter
-0003e7d0: 7661 6c20 3d20 6d61 7828 302e 3031 2c20  val = max(0.01, 
-0003e7e0: 6d69 6e28 302e 352c 206c 656e 2877 732e  min(0.5, len(ws.
-0003e7f0: 6861 735f 7768 6174 2920 2f20 3430 3029  has_what) / 400)
-0003e800: 290a 2020 2020 2020 2020 2020 2020 6177  ).            aw
-0003e810: 6169 7420 6173 796e 6369 6f2e 736c 6565  ait asyncio.slee
-0003e820: 7028 706f 6c6c 5f69 6e74 6572 7661 6c29  p(poll_interval)
-0003e830: 0a0a 2020 2020 2020 2020 6966 2070 6f6c  ..        if pol
-0003e840: 6963 792e 6e6f 5f72 6563 6970 6965 6e74  icy.no_recipient
-0003e850: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-0003e860: 2041 626f 7274 2072 6574 6972 656d 656e   Abort retiremen
-0003e870: 742e 2054 6869 7320 7469 6d65 2077 6520  t. This time we 
-0003e880: 646f 6e27 7420 6e65 6564 2074 6f20 776f  don't need to wo
-0003e890: 7272 7920 6162 6f75 7420 7261 6365 0a20  rry about race. 
-0003e8a0: 2020 2020 2020 2020 2020 2023 2063 6f6e             # con
-0003e8b0: 6469 7469 6f6e 7320 616e 6420 7765 2063  ditions and we c
-0003e8c0: 616e 2077 6169 7420 666f 7220 6120 7363  an wait for a sc
-0003e8d0: 6865 6475 6c65 722d 3e77 6f72 6b65 722d  heduler->worker-
-0003e8e0: 3e73 6368 6564 756c 6572 0a20 2020 2020  >scheduler.     
-0003e8f0: 2020 2020 2020 2023 2072 6f75 6e64 2d74         # round-t
-0003e900: 7269 702e 0a20 2020 2020 2020 2020 2020  rip..           
-0003e910: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
-0003e920: 6d73 5b77 732e 6164 6472 6573 735d 2e73  ms[ws.address].s
-0003e930: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-0003e940: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-0003e950: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-0003e960: 2022 776f 726b 6572 2d73 7461 7475 732d   "worker-status-
-0003e970: 6368 616e 6765 222c 0a20 2020 2020 2020  change",.       
-0003e980: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-0003e990: 6174 7573 223a 2070 7265 765f 7374 6174  atus": prev_stat
-0003e9a0: 7573 2e6e 616d 652c 0a20 2020 2020 2020  us.name,.       
-0003e9b0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
-0003e9c0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-0003e9d0: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
-0003e9e0: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-0003e9f0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0003ea00: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-0003ea10: 2c20 7b7d 0a0a 2020 2020 2020 2020 6c6f  , {}..        lo
-0003ea20: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-0003ea30: 2020 2020 2020 2020 2241 6c6c 2075 6e69          "All uni
-0003ea40: 7175 6520 6b65 7973 206f 6e20 776f 726b  que keys on work
-0003ea50: 6572 2025 7320 6861 7665 2062 6565 6e20  er %s have been 
-0003ea60: 7265 706c 6963 6174 6564 2065 6c73 6577  replicated elsew
-0003ea70: 6865 7265 222c 2077 732e 6164 6472 6573  here", ws.addres
-0003ea80: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
-0003ea90: 2020 2020 2069 6620 7265 6d6f 7665 3a0a       if remove:.
-0003eaa0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-0003eab0: 7420 7365 6c66 2e72 656d 6f76 655f 776f  t self.remove_wo
-0003eac0: 726b 6572 280a 2020 2020 2020 2020 2020  rker(.          
-0003ead0: 2020 2020 2020 7773 2e61 6464 7265 7373        ws.address
-0003eae0: 2c20 7361 6665 3d54 7275 652c 2063 6c6f  , safe=True, clo
-0003eaf0: 7365 3d63 6c6f 7365 2c20 7374 696d 756c  se=close, stimul
-0003eb00: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
-0003eb10: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
-0003eb20: 2020 2020 2020 2020 656c 6966 2063 6c6f          elif clo
-0003eb30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003eb40: 7365 6c66 2e63 6c6f 7365 5f77 6f72 6b65  self.close_worke
-0003eb50: 7228 7773 2e61 6464 7265 7373 290a 0a20  r(ws.address).. 
-0003eb60: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0003eb70: 666f 2822 5265 7469 7265 6420 776f 726b  fo("Retired work
-0003eb80: 6572 2025 7322 2c20 7773 2e61 6464 7265  er %s", ws.addre
-0003eb90: 7373 290a 2020 2020 2020 2020 7265 7475  ss).        retu
-0003eba0: 726e 2077 732e 6164 6472 6573 732c 2077  rn ws.address, w
-0003ebb0: 732e 6964 656e 7469 7479 2829 0a0a 2020  s.identity()..  
-0003ebc0: 2020 6465 6620 6164 645f 6b65 7973 280a    def add_keys(.
-0003ebd0: 2020 2020 2020 2020 7365 6c66 2c20 776f          self, wo
-0003ebe0: 726b 6572 3a20 7374 722c 206b 6579 733a  rker: str, keys:
-0003ebf0: 2043 6f6c 6c65 6374 696f 6e5b 7374 725d   Collection[str]
-0003ec00: 203d 2028 292c 2073 7469 6d75 6c75 735f   = (), stimulus_
-0003ec10: 6964 3a20 7374 7220 7c20 4e6f 6e65 203d  id: str | None =
-0003ec20: 204e 6f6e 650a 2020 2020 2920 2d3e 204c   None.    ) -> L
-0003ec30: 6974 6572 616c 5b22 4f4b 222c 2022 6e6f  iteral["OK", "no
-0003ec40: 7420 666f 756e 6422 5d3a 0a20 2020 2020  t found"]:.     
-0003ec50: 2020 2022 2222 0a20 2020 2020 2020 204c     """.        L
-0003ec60: 6561 726e 2074 6861 7420 6120 776f 726b  earn that a work
-0003ec70: 6572 2068 6173 2063 6572 7461 696e 206b  er has certain k
-0003ec80: 6579 730a 0a20 2020 2020 2020 2054 6869  eys..        Thi
-0003ec90: 7320 7368 6f75 6c64 206e 6f74 2062 6520  s should not be 
-0003eca0: 7573 6564 2069 6e20 7072 6163 7469 6365  used in practice
-0003ecb0: 2061 6e64 2069 7320 6d6f 7374 6c79 2068   and is mostly h
-0003ecc0: 6572 6520 666f 7220 6c65 6761 6379 0a20  ere for legacy. 
-0003ecd0: 2020 2020 2020 2072 6561 736f 6e73 2e20         reasons. 
-0003ece0: 2048 6f77 6576 6572 2c20 6974 2069 7320   However, it is 
-0003ecf0: 7365 6e74 2062 7920 776f 726b 6572 7320  sent by workers 
-0003ed00: 6672 6f6d 2074 696d 6520 746f 2074 696d  from time to tim
-0003ed10: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-0003ed20: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
-0003ed30: 206e 6f74 2069 6e20 7365 6c66 2e77 6f72   not in self.wor
-0003ed40: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-0003ed50: 2020 7265 7475 726e 2022 6e6f 7420 666f    return "not fo
-0003ed60: 756e 6422 0a20 2020 2020 2020 2077 733a  und".        ws:
-0003ed70: 2057 6f72 6b65 7253 7461 7465 203d 2073   WorkerState = s
-0003ed80: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
-0003ed90: 6572 5d0a 2020 2020 2020 2020 7265 6475  er].        redu
-0003eda0: 6e64 616e 745f 7265 706c 6963 6173 203d  ndant_replicas =
-0003edb0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
-0003edc0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
-0003edd0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0003ede0: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
-0003edf0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0003ee00: 2074 7320 6973 206e 6f74 204e 6f6e 6520   ts is not None 
-0003ee10: 616e 6420 7473 2e73 7461 7465 203d 3d20  and ts.state == 
-0003ee20: 226d 656d 6f72 7922 3a0a 2020 2020 2020  "memory":.      
-0003ee30: 2020 2020 2020 2020 2020 6966 2077 7320            if ws 
-0003ee40: 6e6f 7420 696e 2074 732e 7768 6f5f 6861  not in ts.who_ha
-0003ee50: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0003ee60: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-0003ee70: 7265 706c 6963 6128 7473 2c20 7773 290a  replica(ts, ws).
-0003ee80: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003ee90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003eea0: 2020 7265 6475 6e64 616e 745f 7265 706c    redundant_repl
-0003eeb0: 6963 6173 2e61 7070 656e 6428 6b65 7929  icas.append(key)
-0003eec0: 0a0a 2020 2020 2020 2020 6966 2072 6564  ..        if red
-0003eed0: 756e 6461 6e74 5f72 6570 6c69 6361 733a  undant_replicas:
-0003eee0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003eef0: 6e6f 7420 7374 696d 756c 7573 5f69 643a  not stimulus_id:
-0003ef00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ef10: 2073 7469 6d75 6c75 735f 6964 203d 2066   stimulus_id = f
-0003ef20: 2272 6564 756e 6461 6e74 2d72 6570 6c69  "redundant-repli
-0003ef30: 6361 732d 7b74 696d 6528 297d 220a 2020  cas-{time()}".  
-0003ef40: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-0003ef50: 6f72 6b65 725f 7365 6e64 280a 2020 2020  orker_send(.    
-0003ef60: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0003ef70: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0003ef80: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0003ef90: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-0003efa0: 2272 656d 6f76 652d 7265 706c 6963 6173  "remove-replicas
-0003efb0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0003efc0: 2020 2020 2020 2022 6b65 7973 223a 2072         "keys": r
-0003efd0: 6564 756e 6461 6e74 5f72 6570 6c69 6361  edundant_replica
-0003efe0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-0003eff0: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-0003f000: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-0003f010: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
-0003f020: 2020 207d 2c0a 2020 2020 2020 2020 2020     },.          
-0003f030: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-0003f040: 7572 6e20 224f 4b22 0a0a 2020 2020 406c  urn "OK"..    @l
-0003f050: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0003f060: 6620 7570 6461 7465 5f64 6174 6128 0a20  f update_data(. 
-0003f070: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0003f080: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
-0003f090: 7768 6f5f 6861 733a 2064 6963 745b 7374  who_has: dict[st
-0003f0a0: 722c 206c 6973 745b 7374 725d 5d2c 0a20  r, list[str]],. 
-0003f0b0: 2020 2020 2020 206e 6279 7465 733a 2064         nbytes: d
-0003f0c0: 6963 745b 7374 722c 2069 6e74 5d2c 0a20  ict[str, int],. 
-0003f0d0: 2020 2020 2020 2063 6c69 656e 743a 2073         client: s
-0003f0e0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-0003f0f0: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
-0003f100: 0a20 2020 2020 2020 2022 2222 4c65 6172  .        """Lear
-0003f110: 6e20 7468 6174 206e 6577 2064 6174 6120  n that new data 
-0003f120: 6861 7320 656e 7465 7265 6420 7468 6520  has entered the 
-0003f130: 6e65 7477 6f72 6b20 6672 6f6d 2061 6e20  network from an 
-0003f140: 6578 7465 726e 616c 2073 6f75 7263 6522  external source"
-0003f150: 2222 0a20 2020 2020 2020 2077 686f 5f68  "".        who_h
-0003f160: 6173 203d 207b 6b3a 205b 7365 6c66 2e63  as = {k: [self.c
-0003f170: 6f65 7263 655f 6164 6472 6573 7328 7676  oerce_address(vv
-0003f180: 2920 666f 7220 7676 2069 6e20 765d 2066  ) for vv in v] f
-0003f190: 6f72 206b 2c20 7620 696e 2077 686f 5f68  or k, v in who_h
-0003f1a0: 6173 2e69 7465 6d73 2829 7d0a 2020 2020  as.items()}.    
-0003f1b0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
-0003f1c0: 2822 5570 6461 7465 2064 6174 6120 2573  ("Update data %s
-0003f1d0: 222c 2077 686f 5f68 6173 290a 0a20 2020  ", who_has)..   
-0003f1e0: 2020 2020 2066 6f72 206b 6579 2c20 776f       for key, wo
-0003f1f0: 726b 6572 7320 696e 2077 686f 5f68 6173  rkers in who_has
-0003f200: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0003f210: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-0003f220: 7461 736b 732e 6765 7428 6b65 7929 0a20  tasks.get(key). 
-0003f230: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0003f240: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003f250: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
-0003f260: 656c 662e 6e65 775f 7461 736b 286b 6579  elf.new_task(key
-0003f270: 2c20 4e6f 6e65 2c20 226d 656d 6f72 7922  , None, "memory"
-0003f280: 290a 2020 2020 2020 2020 2020 2020 7473  ).            ts
-0003f290: 2e73 7461 7465 203d 2022 6d65 6d6f 7279  .state = "memory
-0003f2a0: 220a 2020 2020 2020 2020 2020 2020 7473  ".            ts
-0003f2b0: 5f6e 6279 7465 7320 3d20 6e62 7974 6573  _nbytes = nbytes
-0003f2c0: 2e67 6574 286b 6579 2c20 2d31 290a 2020  .get(key, -1).  
-0003f2d0: 2020 2020 2020 2020 2020 6966 2074 735f            if ts_
-0003f2e0: 6e62 7974 6573 203e 3d20 303a 0a20 2020  nbytes >= 0:.   
-0003f2f0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0003f300: 7365 745f 6e62 7974 6573 2874 735f 6e62  set_nbytes(ts_nb
-0003f310: 7974 6573 290a 0a20 2020 2020 2020 2020  ytes)..         
-0003f320: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
-0003f330: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0003f340: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
-0003f350: 6f72 6b65 7273 5b77 5d0a 2020 2020 2020  orkers[w].      
-0003f360: 2020 2020 2020 2020 2020 6966 2077 7320            if ws 
-0003f370: 6e6f 7420 696e 2074 732e 7768 6f5f 6861  not in ts.who_ha
-0003f380: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0003f390: 2020 2020 2020 2073 656c 662e 6164 645f         self.add_
-0003f3a0: 7265 706c 6963 6128 7473 2c20 7773 290a  replica(ts, ws).
-0003f3b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0003f3c0: 2e72 6570 6f72 7428 7b22 6f70 223a 2022  .report({"op": "
-0003f3d0: 6b65 792d 696e 2d6d 656d 6f72 7922 2c20  key-in-memory", 
-0003f3e0: 226b 6579 223a 206b 6579 2c20 2277 6f72  "key": key, "wor
-0003f3f0: 6b65 7273 223a 206c 6973 7428 776f 726b  kers": list(work
-0003f400: 6572 7329 7d29 0a0a 2020 2020 2020 2020  ers)})..        
-0003f410: 6966 2063 6c69 656e 743a 0a20 2020 2020  if client:.     
-0003f420: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0003f430: 6e74 5f64 6573 6972 6573 5f6b 6579 7328  nt_desires_keys(
-0003f440: 6b65 7973 3d6c 6973 7428 7768 6f5f 6861  keys=list(who_ha
-0003f450: 7329 2c20 636c 6965 6e74 3d63 6c69 656e  s), client=clien
-0003f460: 7429 0a0a 2020 2020 406f 7665 726c 6f61  t)..    @overloa
-0003f470: 640a 2020 2020 6465 6620 7265 706f 7274  d.    def report
-0003f480: 5f6f 6e5f 6b65 7928 7365 6c66 2c20 6b65  _on_key(self, ke
-0003f490: 793a 2073 7472 2c20 2a2c 2063 6c69 656e  y: str, *, clien
-0003f4a0: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
-0003f4b0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
-0003f4c0: 2020 2020 2020 202e 2e2e 0a0a 2020 2020         .....    
-0003f4d0: 406f 7665 726c 6f61 640a 2020 2020 6465  @overload.    de
-0003f4e0: 6620 7265 706f 7274 5f6f 6e5f 6b65 7928  f report_on_key(
-0003f4f0: 7365 6c66 2c20 2a2c 2074 733a 2054 6173  self, *, ts: Tas
-0003f500: 6b53 7461 7465 2c20 636c 6965 6e74 3a20  kState, client: 
-0003f510: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0003f520: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0003f530: 2020 2020 2e2e 2e0a 0a20 2020 2064 6566      .....    def
-0003f540: 2072 6570 6f72 745f 6f6e 5f6b 6579 2873   report_on_key(s
-0003f550: 656c 662c 206b 6579 3d4e 6f6e 652c 202a  elf, key=None, *
-0003f560: 2c20 7473 3d4e 6f6e 652c 2063 6c69 656e  , ts=None, clien
-0003f570: 743d 4e6f 6e65 293a 0a20 2020 2020 2020  t=None):.       
-0003f580: 2069 6620 2874 7320 6973 204e 6f6e 6529   if (ts is None)
-0003f590: 203d 3d20 286b 6579 2069 7320 4e6f 6e65   == (key is None
-0003f5a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-0003f5b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-0003f5c0: 2020 2320 7072 6167 6d61 3a20 6e6f 636f    # pragma: noco
-0003f5d0: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
-0003f5e0: 2020 2020 6622 7473 2061 6e64 206b 6579      f"ts and key
-0003f5f0: 2061 7265 206d 7574 7561 6c6c 7920 6578   are mutually ex
-0003f600: 636c 7573 6976 653b 2072 6563 6569 7665  clusive; receive
-0003f610: 6420 7b6b 6579 3d21 727d 2c20 7b74 733d  d {key=!r}, {ts=
-0003f620: 2172 7d22 0a20 2020 2020 2020 2020 2020  !r}".           
-0003f630: 2029 0a20 2020 2020 2020 2069 6620 7473   ).        if ts
-0003f640: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0003f650: 2020 2020 2020 6173 7365 7274 206b 6579        assert key
-0003f660: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-0003f670: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0003f680: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
-0003f690: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0003f6a0: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
-0003f6b0: 3d20 7473 2e6b 6579 0a0a 2020 2020 2020  = ts.key..      
-0003f6c0: 2020 6966 2074 7320 6973 206e 6f74 204e    if ts is not N
-0003f6d0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003f6e0: 2072 6570 6f72 745f 6d73 6720 3d20 5f74   report_msg = _t
-0003f6f0: 6173 6b5f 746f 5f72 6570 6f72 745f 6d73  ask_to_report_ms
-0003f700: 6728 7473 290a 2020 2020 2020 2020 656c  g(ts).        el
-0003f710: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003f720: 7265 706f 7274 5f6d 7367 203d 207b 226f  report_msg = {"o
-0003f730: 7022 3a20 2263 616e 6365 6c6c 6564 2d6b  p": "cancelled-k
-0003f740: 6579 7322 2c20 226b 6579 7322 3a20 5b6b  eys", "keys": [k
-0003f750: 6579 5d7d 0a20 2020 2020 2020 2069 6620  ey]}.        if 
-0003f760: 7265 706f 7274 5f6d 7367 2069 7320 6e6f  report_msg is no
-0003f770: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-0003f780: 2020 2020 7365 6c66 2e72 6570 6f72 7428      self.report(
-0003f790: 7265 706f 7274 5f6d 7367 2c20 7473 3d74  report_msg, ts=t
-0003f7a0: 732c 2063 6c69 656e 743d 636c 6965 6e74  s, client=client
-0003f7b0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
-0003f7c0: 7273 0a20 2020 2061 7379 6e63 2064 6566  rs.    async def
-0003f7d0: 2066 6565 6428 0a20 2020 2020 2020 2073   feed(.        s
-0003f7e0: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
-0003f7f0: 6d3a 2043 6f6d 6d2c 0a20 2020 2020 2020  m: Comm,.       
-0003f800: 2066 756e 6374 696f 6e3a 2062 7974 6573   function: bytes
-0003f810: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003f820: 2020 2020 2020 2020 7365 7475 703a 2062          setup: b
-0003f830: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-0003f840: 6e65 2c0a 2020 2020 2020 2020 7465 6172  ne,.        tear
-0003f850: 646f 776e 3a20 6279 7465 7320 7c20 4e6f  down: bytes | No
-0003f860: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-0003f870: 2020 2069 6e74 6572 7661 6c3a 2073 7472     interval: str
-0003f880: 207c 2066 6c6f 6174 203d 2022 3173 222c   | float = "1s",
-0003f890: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-0003f8a0: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-0003f8b0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0003f8c0: 2222 0a20 2020 2020 2020 2050 726f 7669  "".        Provi
-0003f8d0: 6465 7320 6120 6461 7461 2043 6f6d 6d20  des a data Comm 
-0003f8e0: 746f 2065 7874 6572 6e61 6c20 7265 7175  to external requ
-0003f8f0: 6573 7465 720a 0a20 2020 2020 2020 2043  ester..        C
-0003f900: 6175 7469 6f6e 3a20 7468 6973 2072 756e  aution: this run
-0003f910: 7320 6172 6269 7472 6172 7920 5079 7468  s arbitrary Pyth
-0003f920: 6f6e 2063 6f64 6520 6f6e 2074 6865 2073  on code on the s
-0003f930: 6368 6564 756c 6572 2e20 2054 6869 7320  cheduler.  This 
-0003f940: 7368 6f75 6c64 0a20 2020 2020 2020 2065  should.        e
-0003f950: 7665 6e74 7561 6c6c 7920 6265 2070 6861  ventually be pha
-0003f960: 7365 6420 6f75 742e 2020 4974 2069 7320  sed out.  It is 
-0003f970: 6d6f 7374 6c79 2075 7365 6420 6279 2064  mostly used by d
-0003f980: 6961 676e 6f73 7469 6373 2e0a 2020 2020  iagnostics..    
-0003f990: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0003f9a0: 6966 206e 6f74 2064 6173 6b2e 636f 6e66  if not dask.conf
-0003f9b0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-0003f9c0: 7465 642e 7363 6865 6475 6c65 722e 7069  ted.scheduler.pi
-0003f9d0: 636b 6c65 2229 3a0a 2020 2020 2020 2020  ckle"):.        
-0003f9e0: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-0003f9f0: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-0003fa00: 2020 2020 2254 7269 6564 2074 6f20 6361      "Tried to ca
-0003fa10: 6c6c 2027 6665 6564 2720 726f 7574 6520  ll 'feed' route 
-0003fa20: 7769 7468 2063 7573 746f 6d20 6675 6e63  with custom func
-0003fa30: 7469 6f6e 732c 2062 7574 2022 0a20 2020  tions, but ".   
-0003fa40: 2020 2020 2020 2020 2020 2020 2022 7069               "pi
-0003fa50: 636b 6c65 2069 7320 6469 7361 6c6c 6f77  ckle is disallow
-0003fa60: 6564 2e20 2053 6574 2074 6865 2027 6469  ed.  Set the 'di
-0003fa70: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0003fa80: 6c65 722e 7069 636b 6c65 2722 0a20 2020  ler.pickle'".   
-0003fa90: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-0003faa0: 6e66 6967 2076 616c 7565 2074 6f20 5472  nfig value to Tr
-0003fab0: 7565 2074 6f20 7573 6520 7468 6520 2766  ue to use the 'f
-0003fac0: 6565 6427 2072 6f75 7465 2028 7468 6973  eed' route (this
-0003fad0: 2069 7320 6d6f 7374 6c79 2022 0a20 2020   is mostly ".   
-0003fae0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-0003faf0: 6d6d 6f6e 6c79 2075 7365 6420 7769 7468  mmonly used with
-0003fb00: 2070 726f 6772 6573 7320 6261 7273 2922   progress bars)"
-0003fb10: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0003fb20: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003fb30: 6e0a 0a20 2020 2020 2020 2069 6e74 6572  n..        inter
-0003fb40: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
-0003fb50: 6465 6c74 6128 696e 7465 7276 616c 290a  delta(interval).
-0003fb60: 2020 2020 2020 2020 6966 2066 756e 6374          if funct
-0003fb70: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
-0003fb80: 2066 756e 6374 696f 6e20 3d20 7069 636b   function = pick
-0003fb90: 6c65 2e6c 6f61 6473 2866 756e 6374 696f  le.loads(functio
-0003fba0: 6e29 0a20 2020 2020 2020 2069 6620 7365  n).        if se
-0003fbb0: 7475 703a 0a20 2020 2020 2020 2020 2020  tup:.           
-0003fbc0: 2073 6574 7570 203d 2070 6963 6b6c 652e   setup = pickle.
-0003fbd0: 6c6f 6164 7328 7365 7475 7029 0a0a 2020  loads(setup)..  
-0003fbe0: 2020 2020 2020 6966 2074 6561 7264 6f77        if teardow
-0003fbf0: 6e3a 0a20 2020 2020 2020 2020 2020 2074  n:.            t
-0003fc00: 6561 7264 6f77 6e20 3d20 7069 636b 6c65  eardown = pickle
-0003fc10: 2e6c 6f61 6473 2874 6561 7264 6f77 6e29  .loads(teardown)
-0003fc20: 0a20 2020 2020 2020 2073 7461 7465 203d  .        state =
-0003fc30: 2073 6574 7570 2873 656c 6629 2069 6620   setup(self) if 
-0003fc40: 7365 7475 7020 656c 7365 204e 6f6e 6520  setup else None 
-0003fc50: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0003fc60: 2020 2020 2020 2020 6966 2069 6e73 7065          if inspe
-0003fc70: 6374 2e69 7361 7761 6974 6162 6c65 2873  ct.isawaitable(s
-0003fc80: 7461 7465 293a 0a20 2020 2020 2020 2020  tate):.         
-0003fc90: 2020 2073 7461 7465 203d 2061 7761 6974     state = await
-0003fca0: 2073 7461 7465 0a20 2020 2020 2020 2074   state.        t
-0003fcb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0003fcc0: 7768 696c 6520 7365 6c66 2e73 7461 7475  while self.statu
-0003fcd0: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-0003fce0: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-0003fcf0: 2020 2020 2069 6620 7374 6174 6520 6973       if state is
-0003fd00: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0003fd10: 2020 2020 2020 2020 2020 2072 6573 706f             respo
-0003fd20: 6e73 6520 3d20 6675 6e63 7469 6f6e 2873  nse = function(s
-0003fd30: 656c 6629 2020 2320 7479 7065 3a20 6967  elf)  # type: ig
-0003fd40: 6e6f 7265 0a20 2020 2020 2020 2020 2020  nore.           
-0003fd50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003fd60: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003fd70: 6573 706f 6e73 6520 3d20 6675 6e63 7469  esponse = functi
-0003fd80: 6f6e 2873 656c 662c 2073 7461 7465 2920  on(self, state) 
-0003fd90: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0003fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fdb0: 6177 6169 7420 636f 6d6d 2e77 7269 7465  await comm.write
-0003fdc0: 2872 6573 706f 6e73 6529 0a20 2020 2020  (response).     
-0003fdd0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-0003fde0: 2061 7379 6e63 696f 2e73 6c65 6570 2869   asyncio.sleep(i
-0003fdf0: 6e74 6572 7661 6c29 0a20 2020 2020 2020  nterval).       
-0003fe00: 2065 7863 6570 7420 4f53 4572 726f 723a   except OSError:
-0003fe10: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-0003fe20: 730a 2020 2020 2020 2020 6669 6e61 6c6c  s.        finall
-0003fe30: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
-0003fe40: 6620 7465 6172 646f 776e 3a0a 2020 2020  f teardown:.    
-0003fe50: 2020 2020 2020 2020 2020 2020 7465 6172              tear
-0003fe60: 646f 776e 2873 656c 662c 2073 7461 7465  down(self, state
-0003fe70: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-0003fe80: 650a 0a20 2020 2064 6566 206c 6f67 5f77  e..    def log_w
-0003fe90: 6f72 6b65 725f 6576 656e 7428 0a20 2020  orker_event(.   
-0003fea0: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-0003feb0: 723a 2073 7472 2c20 746f 7069 633a 2073  r: str, topic: s
-0003fec0: 7472 207c 2043 6f6c 6c65 6374 696f 6e5b  tr | Collection[
-0003fed0: 7374 725d 2c20 6d73 673a 2041 6e79 0a20  str], msg: Any. 
-0003fee0: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-0003fef0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-0003ff00: 6e63 6528 6d73 672c 2064 6963 7429 3a0a  nce(msg, dict):.
-0003ff10: 2020 2020 2020 2020 2020 2020 6d73 675b              msg[
-0003ff20: 2277 6f72 6b65 7222 5d20 3d20 776f 726b  "worker"] = work
-0003ff30: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
-0003ff40: 6c6f 675f 6576 656e 7428 746f 7069 632c  log_event(topic,
-0003ff50: 206d 7367 290a 0a20 2020 2064 6566 2073   msg)..    def s
-0003ff60: 7562 7363 7269 6265 5f77 6f72 6b65 725f  ubscribe_worker_
-0003ff70: 7374 6174 7573 2873 656c 662c 2063 6f6d  status(self, com
-0003ff80: 6d3a 2043 6f6d 6d29 202d 3e20 7374 723a  m: Comm) -> str:
-0003ff90: 0a20 2020 2020 2020 2057 6f72 6b65 7253  .        WorkerS
-0003ffa0: 7461 7475 7350 6c75 6769 6e28 7365 6c66  tatusPlugin(self
-0003ffb0: 2c20 636f 6d6d 290a 2020 2020 2020 2020  , comm).        
-0003ffc0: 6964 656e 7420 3d20 7365 6c66 2e69 6465  ident = self.ide
-0003ffd0: 6e74 6974 7928 290a 2020 2020 2020 2020  ntity().        
-0003ffe0: 666f 7220 7620 696e 2069 6465 6e74 5b22  for v in ident["
-0003fff0: 776f 726b 6572 7322 5d2e 7661 6c75 6573  workers"].values
-00040000: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00040010: 6465 6c20 765b 226d 6574 7269 6373 225d  del v["metrics"]
-00040020: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-00040030: 2076 5b22 6c61 7374 5f73 6565 6e22 5d0a   v["last_seen"].
-00040040: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00040050: 6465 6e74 0a0a 2020 2020 6465 6620 6765  dent..    def ge
-00040060: 745f 7072 6f63 6573 7369 6e67 280a 2020  t_processing(.  
-00040070: 2020 2020 2020 7365 6c66 2c20 776f 726b        self, work
-00040080: 6572 733a 2049 7465 7261 626c 655b 7374  ers: Iterable[st
-00040090: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
-000400a0: 0a20 2020 2029 202d 3e20 6469 6374 5b73  .    ) -> dict[s
-000400b0: 7472 2c20 6c69 7374 5b73 7472 5d5d 3a0a  tr, list[str]]:.
-000400c0: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-000400d0: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
-000400e0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000400f0: 6572 7320 3d20 7365 7428 6d61 7028 7365  ers = set(map(se
-00040100: 6c66 2e63 6f65 7263 655f 6164 6472 6573  lf.coerce_addres
-00040110: 732c 2077 6f72 6b65 7273 2929 0a20 2020  s, workers)).   
-00040120: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00040130: 7b77 3a20 5b74 732e 6b65 7920 666f 7220  {w: [ts.key for 
-00040140: 7473 2069 6e20 7365 6c66 2e77 6f72 6b65  ts in self.worke
-00040150: 7273 5b77 5d2e 7072 6f63 6573 7369 6e67  rs[w].processing
-00040160: 5d20 666f 7220 7720 696e 2077 6f72 6b65  ] for w in worke
-00040170: 7273 7d0a 2020 2020 2020 2020 656c 7365  rs}.        else
-00040180: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00040190: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
-000401a0: 2020 2020 2020 2077 3a20 5b74 732e 6b65         w: [ts.ke
-000401b0: 7920 666f 7220 7473 2069 6e20 7773 2e70  y for ts in ws.p
-000401c0: 726f 6365 7373 696e 675d 2066 6f72 2077  rocessing] for w
-000401d0: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
-000401e0: 6b65 7273 2e69 7465 6d73 2829 0a20 2020  kers.items().   
-000401f0: 2020 2020 2020 2020 207d 0a0a 2020 2020           }..    
-00040200: 6465 6620 6765 745f 7768 6f5f 6861 7328  def get_who_has(
-00040210: 7365 6c66 2c20 6b65 7973 3a20 4974 6572  self, keys: Iter
-00040220: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
-00040230: 203d 204e 6f6e 6529 202d 3e20 6469 6374   = None) -> dict
-00040240: 5b73 7472 2c20 6c69 7374 5b73 7472 5d5d  [str, list[str]]
-00040250: 3a0a 2020 2020 2020 2020 6966 206b 6579  :.        if key
-00040260: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00040270: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00040280: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-00040290: 2020 2020 6b65 793a 205b 7773 2e61 6464      key: [ws.add
-000402a0: 7265 7373 2066 6f72 2077 7320 696e 2073  ress for ws in s
-000402b0: 656c 662e 7461 736b 735b 6b65 795d 2e77  elf.tasks[key].w
-000402c0: 686f 5f68 6173 5d0a 2020 2020 2020 2020  ho_has].        
-000402d0: 2020 2020 2020 2020 6966 206b 6579 2069          if key i
-000402e0: 6e20 7365 6c66 2e74 6173 6b73 0a20 2020  n self.tasks.   
-000402f0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00040300: 6520 5b5d 0a20 2020 2020 2020 2020 2020  e [].           
-00040310: 2020 2020 2066 6f72 206b 6579 2069 6e20       for key in 
-00040320: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
-00040330: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
-00040340: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00040350: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-00040360: 2020 2020 2020 6b65 793a 205b 7773 2e61        key: [ws.a
-00040370: 6464 7265 7373 2066 6f72 2077 7320 696e  ddress for ws in
-00040380: 2074 732e 7768 6f5f 6861 735d 2066 6f72   ts.who_has] for
-00040390: 206b 6579 2c20 7473 2069 6e20 7365 6c66   key, ts in self
-000403a0: 2e74 6173 6b73 2e69 7465 6d73 2829 0a20  .tasks.items(). 
-000403b0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-000403c0: 2020 6465 6620 6765 745f 6861 735f 7768    def get_has_wh
-000403d0: 6174 280a 2020 2020 2020 2020 7365 6c66  at(.        self
-000403e0: 2c20 776f 726b 6572 733a 2049 7465 7261  , workers: Itera
-000403f0: 626c 655b 7374 725d 207c 204e 6f6e 6520  ble[str] | None 
-00040400: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
-00040410: 6469 6374 5b73 7472 2c20 6c69 7374 5b73  dict[str, list[s
-00040420: 7472 5d5d 3a0a 2020 2020 2020 2020 6966  tr]]:.        if
-00040430: 2077 6f72 6b65 7273 2069 7320 6e6f 7420   workers is not 
-00040440: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00040450: 2020 776f 726b 6572 7320 3d20 6d61 7028    workers = map(
-00040460: 7365 6c66 2e63 6f65 7263 655f 6164 6472  self.coerce_addr
-00040470: 6573 732c 2077 6f72 6b65 7273 290a 2020  ess, workers).  
-00040480: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00040490: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000404a0: 2020 2077 3a20 5b74 732e 6b65 7920 666f     w: [ts.key fo
-000404b0: 7220 7473 2069 6e20 7365 6c66 2e77 6f72  r ts in self.wor
-000404c0: 6b65 7273 5b77 5d2e 6861 735f 7768 6174  kers[w].has_what
-000404d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000404e0: 2020 6966 2077 2069 6e20 7365 6c66 2e77    if w in self.w
-000404f0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-00040500: 2020 2020 2020 2065 6c73 6520 5b5d 0a20         else []. 
-00040510: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00040520: 6f72 2077 2069 6e20 776f 726b 6572 730a  or w in workers.
-00040530: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
-00040540: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00040550: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00040560: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
-00040570: 7320 696e 2077 732e 6861 735f 7768 6174  s in ws.has_what
-00040580: 5d20 666f 7220 772c 2077 7320 696e 2073  ] for w, ws in s
-00040590: 656c 662e 776f 726b 6572 732e 6974 656d  elf.workers.item
-000405a0: 7328 297d 0a0a 2020 2020 6465 6620 6765  s()}..    def ge
-000405b0: 745f 6e63 6f72 6573 2873 656c 662c 2077  t_ncores(self, w
-000405c0: 6f72 6b65 7273 3a20 4974 6572 6162 6c65  orkers: Iterable
-000405d0: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
-000405e0: 6f6e 6529 202d 3e20 6469 6374 5b73 7472  one) -> dict[str
-000405f0: 2c20 696e 745d 3a0a 2020 2020 2020 2020  , int]:.        
-00040600: 6966 2077 6f72 6b65 7273 2069 7320 6e6f  if workers is no
-00040610: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00040620: 2020 2020 776f 726b 6572 7320 3d20 6d61      workers = ma
-00040630: 7028 7365 6c66 2e63 6f65 7263 655f 6164  p(self.coerce_ad
-00040640: 6472 6573 732c 2077 6f72 6b65 7273 290a  dress, workers).
-00040650: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00040660: 726e 207b 773a 2073 656c 662e 776f 726b  rn {w: self.work
-00040670: 6572 735b 775d 2e6e 7468 7265 6164 7320  ers[w].nthreads 
-00040680: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
-00040690: 2069 6620 7720 696e 2073 656c 662e 776f   if w in self.wo
-000406a0: 726b 6572 737d 0a20 2020 2020 2020 2065  rkers}.        e
-000406b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000406c0: 2072 6574 7572 6e20 7b77 3a20 7773 2e6e   return {w: ws.n
-000406d0: 7468 7265 6164 7320 666f 7220 772c 2077  threads for w, w
-000406e0: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-000406f0: 732e 6974 656d 7328 297d 0a0a 2020 2020  s.items()}..    
-00040700: 6465 6620 6765 745f 6e63 6f72 6573 5f72  def get_ncores_r
-00040710: 756e 6e69 6e67 280a 2020 2020 2020 2020  unning(.        
-00040720: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
-00040730: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
-00040740: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-00040750: 202d 3e20 6469 6374 5b73 7472 2c20 696e   -> dict[str, in
-00040760: 745d 3a0a 2020 2020 2020 2020 6e63 6f72  t]:.        ncor
-00040770: 6573 203d 2073 656c 662e 6765 745f 6e63  es = self.get_nc
-00040780: 6f72 6573 2877 6f72 6b65 7273 3d77 6f72  ores(workers=wor
-00040790: 6b65 7273 290a 2020 2020 2020 2020 7265  kers).        re
-000407a0: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
-000407b0: 2020 2077 3a20 6e20 666f 7220 772c 206e     w: n for w, n
-000407c0: 2069 6e20 6e63 6f72 6573 2e69 7465 6d73   in ncores.items
-000407d0: 2829 2069 6620 7365 6c66 2e77 6f72 6b65  () if self.worke
-000407e0: 7273 5b77 5d2e 7374 6174 7573 203d 3d20  rs[w].status == 
-000407f0: 5374 6174 7573 2e72 756e 6e69 6e67 0a20  Status.running. 
-00040800: 2020 2020 2020 207d 0a0a 2020 2020 6173         }..    as
-00040810: 796e 6320 6465 6620 6765 745f 6361 6c6c  ync def get_call
-00040820: 5f73 7461 636b 2873 656c 662c 206b 6579  _stack(self, key
-00040830: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-00040840: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-00040850: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-00040860: 2077 6f72 6b65 7273 3a20 6469 6374 5b73   workers: dict[s
-00040870: 7472 2c20 6c69 7374 5b73 7472 5d20 7c20  tr, list[str] | 
-00040880: 4e6f 6e65 5d0a 2020 2020 2020 2020 6966  None].        if
-00040890: 206b 6579 7320 6973 206e 6f74 204e 6f6e   keys is not Non
-000408a0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000408b0: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
-000408c0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-000408d0: 6f63 6573 7369 6e67 203d 2073 6574 2829  ocessing = set()
-000408e0: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-000408f0: 6c65 2073 7461 636b 3a0a 2020 2020 2020  le stack:.      
-00040900: 2020 2020 2020 2020 2020 6b65 7920 3d20            key = 
-00040910: 7374 6163 6b2e 706f 7028 290a 2020 2020  stack.pop().    
-00040920: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-00040930: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00040940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040950: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
-00040960: 2277 6169 7469 6e67 223a 0a20 2020 2020  "waiting":.     
-00040970: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00040980: 7461 636b 2e65 7874 656e 6428 5b64 7473  tack.extend([dts
-00040990: 2e6b 6579 2066 6f72 2064 7473 2069 6e20  .key for dts in 
-000409a0: 7473 2e64 6570 656e 6465 6e63 6965 735d  ts.dependencies]
-000409b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000409c0: 2020 656c 6966 2074 732e 7374 6174 6520    elif ts.state 
-000409d0: 3d3d 2022 7072 6f63 6573 7369 6e67 223a  == "processing":
-000409e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000409f0: 2020 2020 2070 726f 6365 7373 696e 672e       processing.
-00040a00: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
-00040a10: 2020 2020 2077 6f72 6b65 7273 203d 2064       workers = d
-00040a20: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
-00040a30: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00040a40: 2074 7320 696e 2070 726f 6365 7373 696e   ts in processin
-00040a50: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00040a60: 2020 2069 6620 7473 2e70 726f 6365 7373     if ts.process
-00040a70: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
-00040a80: 2020 2020 2020 2020 2020 2020 776b 6579              wkey
-00040a90: 7320 3d20 776f 726b 6572 735b 7473 2e70  s = workers[ts.p
-00040aa0: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
-00040ab0: 7265 7373 5d0a 2020 2020 2020 2020 2020  ress].          
-00040ac0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00040ad0: 2077 6b65 7973 2069 7320 6e6f 7420 4e6f   wkeys is not No
-00040ae0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-00040af0: 2020 2020 2020 2077 6b65 7973 2e61 7070         wkeys.app
-00040b00: 656e 6428 7473 2e6b 6579 290a 2020 2020  end(ts.key).    
-00040b10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00040b20: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-00040b30: 7b77 3a20 4e6f 6e65 2066 6f72 2077 2069  {w: None for w i
-00040b40: 6e20 7365 6c66 2e77 6f72 6b65 7273 7d0a  n self.workers}.
-00040b50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00040b60: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-00040b70: 2020 2020 2072 6574 7572 6e20 7b7d 0a0a       return {}..
-00040b80: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
-00040b90: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-00040ba0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00040bb0: 2020 2020 2a28 7365 6c66 2e72 7063 2877      *(self.rpc(w
-00040bc0: 292e 6361 6c6c 5f73 7461 636b 286b 6579  ).call_stack(key
-00040bd0: 733d 7629 2066 6f72 2077 2c20 7620 696e  s=v) for w, v in
-00040be0: 2077 6f72 6b65 7273 2e69 7465 6d73 2829   workers.items()
-00040bf0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
-00040c00: 2020 2020 7265 7370 6f6e 7365 203d 207b      response = {
-00040c10: 773a 2072 2066 6f72 2077 2c20 7220 696e  w: r for w, r in
-00040c20: 207a 6970 2877 6f72 6b65 7273 2c20 7265   zip(workers, re
-00040c30: 7375 6c74 7329 2069 6620 727d 0a20 2020  sults) if r}.   
-00040c40: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-00040c50: 6f6e 7365 0a0a 2020 2020 6173 796e 6320  onse..    async 
-00040c60: 6465 6620 6265 6e63 686d 6172 6b5f 6861  def benchmark_ha
-00040c70: 7264 7761 7265 2873 656c 6629 202d 3e20  rdware(self) -> 
-00040c80: 2264 6963 745b 7374 722c 2064 6963 745b  "dict[str, dict[
-00040c90: 7374 722c 2066 6c6f 6174 5d5d 223a 0a20  str, float]]":. 
-00040ca0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00040cb0: 2020 2052 756e 2061 2062 656e 6368 6d61     Run a benchma
-00040cc0: 726b 206f 6e20 7468 6520 776f 726b 6572  rk on the worker
-00040cd0: 7320 666f 7220 6d65 6d6f 7279 2c20 6469  s for memory, di
-00040ce0: 736b 2c20 616e 6420 6e65 7477 6f72 6b20  sk, and network 
-00040cf0: 6261 6e64 7769 6474 6873 0a0a 2020 2020  bandwidths..    
-00040d00: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-00040d10: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-00040d20: 2020 2020 7265 7375 6c74 3a20 6469 6374      result: dict
-00040d30: 0a20 2020 2020 2020 2020 2020 2041 2064  .            A d
-00040d40: 6963 7469 6f6e 6172 7920 6d61 7070 696e  ictionary mappin
-00040d50: 6720 7468 6520 6e61 6d65 7320 2264 6973  g the names "dis
-00040d60: 6b22 2c20 226d 656d 6f72 7922 2c20 616e  k", "memory", an
-00040d70: 6420 226e 6574 776f 726b 2220 746f 0a20  d "network" to. 
-00040d80: 2020 2020 2020 2020 2020 2064 6963 7469             dicti
-00040d90: 6f6e 6172 6965 7320 6d61 7070 696e 6720  onaries mapping 
-00040da0: 7369 7a65 7320 746f 2062 616e 6477 6964  sizes to bandwid
-00040db0: 7468 732e 2020 5468 6573 6520 6261 6e64  ths.  These band
-00040dc0: 7769 6474 6873 2061 7265 0a20 2020 2020  widths are.     
-00040dd0: 2020 2020 2020 2061 7665 7261 6765 6420         averaged 
-00040de0: 6f76 6572 206d 616e 7920 776f 726b 6572  over many worker
-00040df0: 7320 7275 6e6e 696e 6720 636f 6d70 7574  s running comput
-00040e00: 6174 696f 6e73 2061 6372 6f73 7320 7468  ations across th
-00040e10: 6520 636c 7573 7465 722e 0a20 2020 2020  e cluster..     
-00040e20: 2020 2022 2222 0a20 2020 2020 2020 206f     """.        o
-00040e30: 7574 3a20 6469 6374 5b73 7472 2c20 6465  ut: dict[str, de
-00040e40: 6661 756c 7464 6963 745b 7374 722c 206c  faultdict[str, l
-00040e50: 6973 745b 666c 6f61 745d 5d5d 203d 207b  ist[float]]] = {
-00040e60: 0a20 2020 2020 2020 2020 2020 206e 616d  .            nam
-00040e70: 653a 2064 6566 6175 6c74 6469 6374 286c  e: defaultdict(l
-00040e80: 6973 7429 2066 6f72 206e 616d 6520 696e  ist) for name in
-00040e90: 205b 2264 6973 6b22 2c20 226d 656d 6f72   ["disk", "memor
-00040ea0: 7922 2c20 226e 6574 776f 726b 225d 0a20  y", "network"]. 
-00040eb0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00040ec0: 2020 2320 6469 736b 0a20 2020 2020 2020    # disk.       
-00040ed0: 2072 6573 756c 7420 3d20 6177 6169 7420   result = await 
-00040ee0: 7365 6c66 2e62 726f 6164 6361 7374 286d  self.broadcast(m
-00040ef0: 7367 3d7b 226f 7022 3a20 2262 656e 6368  sg={"op": "bench
-00040f00: 6d61 726b 5f64 6973 6b22 7d29 0a20 2020  mark_disk"}).   
-00040f10: 2020 2020 2066 6f72 2064 2069 6e20 7265       for d in re
-00040f20: 7375 6c74 2e76 616c 7565 7328 293a 0a20  sult.values():. 
-00040f30: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
-00040f40: 697a 652c 2064 7572 6174 696f 6e20 696e  ize, duration in
-00040f50: 2064 2e69 7465 6d73 2829 3a0a 2020 2020   d.items():.    
-00040f60: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
-00040f70: 2264 6973 6b22 5d5b 7369 7a65 5d2e 6170  "disk"][size].ap
-00040f80: 7065 6e64 2864 7572 6174 696f 6e29 0a0a  pend(duration)..
-00040f90: 2020 2020 2020 2020 2320 6d65 6d6f 7279          # memory
-00040fa0: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
-00040fb0: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00040fc0: 6164 6361 7374 286d 7367 3d7b 226f 7022  adcast(msg={"op"
-00040fd0: 3a20 2262 656e 6368 6d61 726b 5f6d 656d  : "benchmark_mem
-00040fe0: 6f72 7922 7d29 0a20 2020 2020 2020 2066  ory"}).        f
-00040ff0: 6f72 2064 2069 6e20 7265 7375 6c74 2e76  or d in result.v
-00041000: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-00041010: 2020 2020 2066 6f72 2073 697a 652c 2064       for size, d
-00041020: 7572 6174 696f 6e20 696e 2064 2e69 7465  uration in d.ite
-00041030: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00041040: 2020 2020 2020 6f75 745b 226d 656d 6f72        out["memor
-00041050: 7922 5d5b 7369 7a65 5d2e 6170 7065 6e64  y"][size].append
-00041060: 2864 7572 6174 696f 6e29 0a0a 2020 2020  (duration)..    
-00041070: 2020 2020 2320 6e65 7477 6f72 6b0a 2020      # network.  
-00041080: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-00041090: 6c69 7374 2873 656c 662e 776f 726b 6572  list(self.worker
-000410a0: 7329 0a20 2020 2020 2020 2023 204f 6e20  s).        # On 
-000410b0: 616e 2061 6461 7074 6976 6520 636c 7573  an adaptive clus
-000410c0: 7465 722c 2069 6620 6d75 6c74 6970 6c65  ter, if multiple
-000410d0: 2077 6f72 6b65 7273 2061 7265 2073 7461   workers are sta
-000410e0: 7274 6564 206f 6e20 7468 6520 7361 6d65  rted on the same
-000410f0: 2070 6879 7369 6361 6c20 686f 7374 2c0a   physical host,.
-00041100: 2020 2020 2020 2020 2320 7468 6579 2061          # they a
-00041110: 7265 206d 6f72 6520 6c69 6b65 6c79 2074  re more likely t
-00041120: 6f20 636f 6e6e 6563 7420 746f 2074 6865  o connect to the
-00041130: 2053 6368 6564 756c 6572 2069 6e20 7365   Scheduler in se
-00041140: 7175 656e 6365 2c20 656e 6469 6e67 2075  quence, ending u
-00041150: 7020 6e65 7874 2074 6f0a 2020 2020 2020  p next to.      
-00041160: 2020 2320 6561 6368 206f 7468 6572 2069    # each other i
-00041170: 6e20 7468 6973 206c 6973 742e 0a20 2020  n this list..   
-00041180: 2020 2020 2023 2054 6865 2074 7261 6e73       # The trans
-00041190: 6665 7220 7370 6565 6420 7769 7468 696e  fer speed within
-000411a0: 2073 7563 6820 636c 7573 7465 7273 206f   such clusters o
-000411b0: 6620 776f 726b 6572 7320 7769 6c6c 2062  f workers will b
-000411c0: 6520 6566 6665 6374 6976 656c 7920 7468  e effectively th
-000411d0: 6174 206f 660a 2020 2020 2020 2020 2320  at of.        # 
-000411e0: 6c6f 6361 6c68 6f73 742e 2054 6869 7320  localhost. This 
-000411f0: 636f 756c 6420 6861 7070 656e 2061 6372  could happen acr
-00041200: 6f73 7320 6469 6666 6572 656e 7420 564d  oss different VM
-00041210: 7320 616e 642f 6f72 2064 6f63 6b65 7220  s and/or docker 
-00041220: 696d 6167 6573 2c20 736f 0a20 2020 2020  images, so.     
-00041230: 2020 2023 2069 6d70 6c65 6d65 6e74 696e     # implementin
-00041240: 6720 6c6f 6769 6320 6261 7365 6420 6f6e  g logic based on
-00041250: 2049 5020 6164 6472 6573 7365 7320 776f   IP addresses wo
-00041260: 756c 6420 6e6f 7420 6e65 6365 7373 6172  uld not necessar
-00041270: 696c 7920 6865 6c70 2e0a 2020 2020 2020  ily help..      
-00041280: 2020 2320 5261 6e64 6f6d 697a 6520 7468    # Randomize th
-00041290: 6520 636f 6e6e 6563 7469 6f6e 7320 746f  e connections to
-000412a0: 2065 7665 6e20 6f75 7420 7468 6520 6d65   even out the me
-000412b0: 616e 206d 6561 7375 7265 732e 0a20 2020  an measures..   
-000412c0: 2020 2020 2072 616e 646f 6d2e 7368 7566       random.shuf
-000412d0: 666c 6528 776f 726b 6572 7329 0a20 2020  fle(workers).   
-000412e0: 2020 2020 2066 7574 7572 6573 203d 205b       futures = [
-000412f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00041300: 662e 7270 6328 6129 2e62 656e 6368 6d61  f.rpc(a).benchma
-00041310: 726b 5f6e 6574 776f 726b 2861 6464 7265  rk_network(addre
-00041320: 7373 3d62 2920 666f 7220 612c 2062 2069  ss=b) for a, b i
-00041330: 6e20 7061 7274 6974 696f 6e28 322c 2077  n partition(2, w
-00041340: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
-00041350: 5d0a 2020 2020 2020 2020 7265 7370 6f6e  ].        respon
-00041360: 7365 7320 3d20 6177 6169 7420 6173 796e  ses = await asyn
-00041370: 6369 6f2e 6761 7468 6572 282a 6675 7475  cio.gather(*futu
-00041380: 7265 7329 0a0a 2020 2020 2020 2020 666f  res)..        fo
-00041390: 7220 6420 696e 2072 6573 706f 6e73 6573  r d in responses
-000413a0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-000413b0: 7220 7369 7a65 2c20 6475 7261 7469 6f6e  r size, duration
-000413c0: 2069 6e20 642e 6974 656d 7328 293a 0a20   in d.items():. 
-000413d0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000413e0: 7574 5b22 6e65 7477 6f72 6b22 5d5b 7369  ut["network"][si
-000413f0: 7a65 5d2e 6170 7065 6e64 2864 7572 6174  ze].append(durat
-00041400: 696f 6e29 0a0a 2020 2020 2020 2020 7265  ion)..        re
-00041410: 7375 6c74 203d 207b 7d0a 2020 2020 2020  sult = {}.      
-00041420: 2020 666f 7220 6d6f 6465 2069 6e20 6f75    for mode in ou
-00041430: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
-00041440: 6573 756c 745b 6d6f 6465 5d20 3d20 7b0a  esult[mode] = {.
-00041450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041460: 7369 7a65 3a20 7375 6d28 6475 7261 7469  size: sum(durati
-00041470: 6f6e 7329 202f 206c 656e 2864 7572 6174  ons) / len(durat
-00041480: 696f 6e73 290a 2020 2020 2020 2020 2020  ions).          
-00041490: 2020 2020 2020 666f 7220 7369 7a65 2c20        for size, 
-000414a0: 6475 7261 7469 6f6e 7320 696e 206f 7574  durations in out
-000414b0: 5b6d 6f64 655d 2e69 7465 6d73 2829 0a20  [mode].items(). 
-000414c0: 2020 2020 2020 2020 2020 207d 0a0a 2020             }..  
-000414d0: 2020 2020 2020 7265 7475 726e 2072 6573        return res
-000414e0: 756c 740a 0a20 2020 2040 6c6f 675f 6572  ult..    @log_er
-000414f0: 726f 7273 0a20 2020 2064 6566 2067 6574  rors.    def get
-00041500: 5f6e 6279 7465 7328 0a20 2020 2020 2020  _nbytes(.       
-00041510: 2073 656c 662c 206b 6579 733a 2049 7465   self, keys: Ite
-00041520: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
-00041530: 6520 3d20 4e6f 6e65 2c20 7375 6d6d 6172  e = None, summar
-00041540: 793a 2062 6f6f 6c20 3d20 5472 7565 0a20  y: bool = True. 
-00041550: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
-00041560: 2c20 696e 745d 3a0a 2020 2020 2020 2020  , int]:.        
-00041570: 6966 206b 6579 7320 6973 206e 6f74 204e  if keys is not N
-00041580: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00041590: 2072 6573 756c 7420 3d20 7b6b 3a20 7365   result = {k: se
-000415a0: 6c66 2e74 6173 6b73 5b6b 5d2e 6e62 7974  lf.tasks[k].nbyt
-000415b0: 6573 2066 6f72 206b 2069 6e20 6b65 7973  es for k in keys
-000415c0: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-000415d0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-000415e0: 6c74 203d 207b 6b3a 2074 732e 6e62 7974  lt = {k: ts.nbyt
-000415f0: 6573 2066 6f72 206b 2c20 7473 2069 6e20  es for k, ts in 
-00041600: 7365 6c66 2e74 6173 6b73 2e69 7465 6d73  self.tasks.items
-00041610: 2829 2069 6620 7473 2e6e 6279 7465 7320  () if ts.nbytes 
-00041620: 3e3d 2030 7d0a 0a20 2020 2020 2020 2069  >= 0}..        i
-00041630: 6620 7375 6d6d 6172 793a 0a20 2020 2020  f summary:.     
-00041640: 2020 2020 2020 206f 7574 3a20 6465 6661         out: defa
-00041650: 756c 7464 6963 745b 7374 722c 2069 6e74  ultdict[str, int
-00041660: 5d20 3d20 6465 6661 756c 7464 6963 7428  ] = defaultdict(
-00041670: 6c61 6d62 6461 3a20 3029 0a20 2020 2020  lambda: 0).     
-00041680: 2020 2020 2020 2066 6f72 206b 2c20 7620         for k, v 
-00041690: 696e 2072 6573 756c 742e 6974 656d 7328  in result.items(
-000416a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000416b0: 2020 206f 7574 5b6b 6579 5f73 706c 6974     out[key_split
-000416c0: 286b 295d 202b 3d20 760a 2020 2020 2020  (k)] += v.      
-000416d0: 2020 2020 2020 7265 7375 6c74 203d 2064        result = d
-000416e0: 6963 7428 6f75 7429 0a0a 2020 2020 2020  ict(out)..      
-000416f0: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-00041700: 0a20 2020 2064 6566 2072 756e 5f66 756e  .    def run_fun
-00041710: 6374 696f 6e28 0a20 2020 2020 2020 2073  ction(.        s
-00041720: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
-00041730: 6d3a 2043 6f6d 6d2c 0a20 2020 2020 2020  m: Comm,.       
-00041740: 2066 756e 6374 696f 6e3a 2043 616c 6c61   function: Calla
-00041750: 626c 652c 0a20 2020 2020 2020 2061 7267  ble,.        arg
-00041760: 733a 2074 7570 6c65 203d 2028 292c 0a20  s: tuple = (),. 
-00041770: 2020 2020 2020 206b 7761 7267 733a 2064         kwargs: d
-00041780: 6963 7420 7c20 4e6f 6e65 203d 204e 6f6e  ict | None = Non
-00041790: 652c 0a20 2020 2020 2020 2077 6169 743a  e,.        wait:
-000417a0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
-000417b0: 2020 2920 2d3e 2041 6e79 3a0a 2020 2020    ) -> Any:.    
-000417c0: 2020 2020 2222 2252 756e 2061 2066 756e      """Run a fun
-000417d0: 6374 696f 6e20 7769 7468 696e 2074 6869  ction within thi
-000417e0: 7320 7072 6f63 6573 730a 0a20 2020 2020  s process..     
-000417f0: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
-00041800: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00041810: 2020 2020 2043 6c69 656e 742e 7275 6e5f       Client.run_
-00041820: 6f6e 5f73 6368 6564 756c 6572 0a20 2020  on_scheduler.   
-00041830: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00041840: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
-00041850: 642e 776f 726b 6572 2069 6d70 6f72 7420  d.worker import 
-00041860: 7275 6e0a 0a20 2020 2020 2020 2069 6620  run..        if 
-00041870: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
-00041880: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-00041890: 2e73 6368 6564 756c 6572 2e70 6963 6b6c  .scheduler.pickl
-000418a0: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
-000418b0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-000418c0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
-000418d0: 2020 2022 4361 6e6e 6f74 2072 756e 2066     "Cannot run f
-000418e0: 756e 6374 696f 6e20 6173 2074 6865 2073  unction as the s
-000418f0: 6368 6564 756c 6572 2068 6173 2062 6565  cheduler has bee
-00041900: 6e20 6578 706c 6963 6974 6c79 2064 6973  n explicitly dis
-00041910: 616c 6c6f 7765 6420 6672 6f6d 2022 0a20  allowed from ". 
-00041920: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00041930: 6465 7365 7269 616c 697a 696e 6720 6172  deserializing ar
-00041940: 6269 7472 6172 7920 6279 7465 7374 7269  bitrary bytestri
-00041950: 6e67 7320 7573 696e 6720 7069 636b 6c65  ngs using pickle
-00041960: 2076 6961 2074 6865 2022 0a20 2020 2020   via the ".     
-00041970: 2020 2020 2020 2020 2020 2022 2764 6973             "'dis
-00041980: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-00041990: 6572 2e70 6963 6b6c 6527 2063 6f6e 6669  er.pickle' confi
-000419a0: 6775 7261 7469 6f6e 2073 6574 7469 6e67  guration setting
-000419b0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
-000419c0: 0a20 2020 2020 2020 206b 7761 7267 7320  .        kwargs 
-000419d0: 3d20 6b77 6172 6773 206f 7220 7b7d 0a20  = kwargs or {}. 
-000419e0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-000419f0: 6576 656e 7428 2261 6c6c 222c 207b 2261  event("all", {"a
-00041a00: 6374 696f 6e22 3a20 2272 756e 2d66 756e  ction": "run-fun
-00041a10: 6374 696f 6e22 2c20 2266 756e 6374 696f  ction", "functio
-00041a20: 6e22 3a20 6675 6e63 7469 6f6e 7d29 0a20  n": function}). 
-00041a30: 2020 2020 2020 2072 6574 7572 6e20 7275         return ru
-00041a40: 6e28 7365 6c66 2c20 636f 6d6d 2c20 6675  n(self, comm, fu
-00041a50: 6e63 7469 6f6e 3d66 756e 6374 696f 6e2c  nction=function,
-00041a60: 2061 7267 733d 6172 6773 2c20 6b77 6172   args=args, kwar
-00041a70: 6773 3d6b 7761 7267 732c 2077 6169 743d  gs=kwargs, wait=
-00041a80: 7761 6974 290a 0a20 2020 2064 6566 2073  wait)..    def s
-00041a90: 6574 5f6d 6574 6164 6174 6128 7365 6c66  et_metadata(self
-00041aa0: 2c20 6b65 7973 3a20 6c69 7374 5b73 7472  , keys: list[str
-00041ab0: 5d2c 2076 616c 7565 3a20 6f62 6a65 6374  ], value: object
-00041ac0: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
-00041ad0: 3a0a 2020 2020 2020 2020 6d65 7461 6461  :.        metada
-00041ae0: 7461 203d 2073 656c 662e 7461 736b 5f6d  ta = self.task_m
-00041af0: 6574 6164 6174 610a 2020 2020 2020 2020  etadata.        
-00041b00: 666f 7220 6b65 7920 696e 206b 6579 735b  for key in keys[
-00041b10: 3a2d 315d 3a0a 2020 2020 2020 2020 2020  :-1]:.          
-00041b20: 2020 6966 206b 6579 206e 6f74 2069 6e20    if key not in 
-00041b30: 6d65 7461 6461 7461 206f 7220 6e6f 7420  metadata or not 
-00041b40: 6973 696e 7374 616e 6365 286d 6574 6164  isinstance(metad
-00041b50: 6174 615b 6b65 795d 2c20 2864 6963 742c  ata[key], (dict,
-00041b60: 206c 6973 7429 293a 0a20 2020 2020 2020   list)):.       
-00041b70: 2020 2020 2020 2020 206d 6574 6164 6174           metadat
-00041b80: 615b 6b65 795d 203d 207b 7d0a 2020 2020  a[key] = {}.    
-00041b90: 2020 2020 2020 2020 6d65 7461 6461 7461          metadata
-00041ba0: 203d 206d 6574 6164 6174 615b 6b65 795d   = metadata[key]
-00041bb0: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
-00041bc0: 615b 6b65 7973 5b2d 315d 5d20 3d20 7661  a[keys[-1]] = va
-00041bd0: 6c75 650a 0a20 2020 2064 6566 2067 6574  lue..    def get
-00041be0: 5f6d 6574 6164 6174 6128 7365 6c66 2c20  _metadata(self, 
-00041bf0: 6b65 7973 3a20 6c69 7374 5b73 7472 5d2c  keys: list[str],
-00041c00: 2064 6566 6175 6c74 3a20 416e 7920 3d20   default: Any = 
-00041c10: 6e6f 5f64 6566 6175 6c74 2920 2d3e 2041  no_default) -> A
-00041c20: 6e79 3a0a 2020 2020 2020 2020 6d65 7461  ny:.        meta
-00041c30: 6461 7461 203d 2073 656c 662e 7461 736b  data = self.task
-00041c40: 5f6d 6574 6164 6174 610a 2020 2020 2020  _metadata.      
-00041c50: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00041c60: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
-00041c70: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00041c80: 2020 2020 6d65 7461 6461 7461 203d 206d      metadata = m
-00041c90: 6574 6164 6174 615b 6b65 795d 0a20 2020  etadata[key].   
-00041ca0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00041cb0: 6d65 7461 6461 7461 0a20 2020 2020 2020  metadata.       
-00041cc0: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-00041cd0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00041ce0: 2064 6566 6175 6c74 2021 3d20 6e6f 5f64   default != no_d
-00041cf0: 6566 6175 6c74 3a0a 2020 2020 2020 2020  efault:.        
-00041d00: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00041d10: 6566 6175 6c74 0a20 2020 2020 2020 2020  efault.         
-00041d20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00041d30: 2020 2020 2020 2020 2072 6169 7365 0a0a           raise..
-00041d40: 2020 2020 6465 6620 7365 745f 7265 7374      def set_rest
-00041d50: 7269 6374 696f 6e73 2873 656c 662c 2077  rictions(self, w
-00041d60: 6f72 6b65 723a 2064 6963 745b 7374 722c  orker: dict[str,
-00041d70: 2043 6f6c 6c65 6374 696f 6e5b 7374 725d   Collection[str]
-00041d80: 207c 2073 7472 5d29 202d 3e20 4e6f 6e65   | str]) -> None
-00041d90: 3a0a 2020 2020 2020 2020 666f 7220 6b65  :.        for ke
-00041da0: 792c 2072 6573 7472 6963 7469 6f6e 7320  y, restrictions 
-00041db0: 696e 2077 6f72 6b65 722e 6974 656d 7328  in worker.items(
-00041dc0: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
-00041dd0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00041de0: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
-00041df0: 6966 2069 7369 6e73 7461 6e63 6528 7265  if isinstance(re
-00041e00: 7374 7269 6374 696f 6e73 2c20 7374 7229  strictions, str)
-00041e10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00041e20: 2020 7265 7374 7269 6374 696f 6e73 203d    restrictions =
-00041e30: 207b 7265 7374 7269 6374 696f 6e73 7d0a   {restrictions}.
-00041e40: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
-00041e50: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
-00041e60: 6e73 203d 2073 6574 2872 6573 7472 6963  ns = set(restric
-00041e70: 7469 6f6e 7329 0a0a 2020 2020 406c 6f67  tions)..    @log
-00041e80: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
-00041e90: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
-00041ea0: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
-00041eb0: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
-00041ec0: 7472 2c20 696e 745d 5d3a 0a20 2020 2020  tr, int]]:.     
-00041ed0: 2020 2073 7461 7465 203d 207b 7d0a 0a20     state = {}.. 
-00041ee0: 2020 2020 2020 2066 6f72 2074 7020 696e         for tp in
-00041ef0: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-00041f00: 7865 732e 7661 6c75 6573 2829 3a0a 2020  xes.values():.  
-00041f10: 2020 2020 2020 2020 2020 6163 7469 7665            active
-00041f20: 5f73 7461 7465 7320 3d20 7470 2e61 6374  _states = tp.act
-00041f30: 6976 655f 7374 6174 6573 0a20 2020 2020  ive_states.     
-00041f40: 2020 2020 2020 2069 6620 616e 7928 0a20         if any(. 
-00041f50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00041f60: 6374 6976 655f 7374 6174 6573 2e67 6574  ctive_states.get
-00041f70: 2873 290a 2020 2020 2020 2020 2020 2020  (s).            
-00041f80: 2020 2020 666f 7220 7320 696e 207b 226d      for s in {"m
-00041f90: 656d 6f72 7922 2c20 2265 7272 6564 222c  emory", "erred",
-00041fa0: 2022 7265 6c65 6173 6564 222c 2022 7072   "released", "pr
-00041fb0: 6f63 6573 7369 6e67 222c 2022 7761 6974  ocessing", "wait
-00041fc0: 696e 6722 7d0a 2020 2020 2020 2020 2020  ing"}.          
-00041fd0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-00041fe0: 2020 2020 2073 7461 7465 5b74 702e 6e61       state[tp.na
-00041ff0: 6d65 5d20 3d20 7b0a 2020 2020 2020 2020  me] = {.        
-00042000: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-00042010: 6f72 7922 3a20 6163 7469 7665 5f73 7461  ory": active_sta
-00042020: 7465 735b 226d 656d 6f72 7922 5d2c 0a20  tes["memory"],. 
-00042030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042040: 2020 2022 6572 7265 6422 3a20 6163 7469     "erred": acti
-00042050: 7665 5f73 7461 7465 735b 2265 7272 6564  ve_states["erred
-00042060: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
-00042070: 2020 2020 2020 2020 2272 656c 6561 7365          "release
-00042080: 6422 3a20 6163 7469 7665 5f73 7461 7465  d": active_state
-00042090: 735b 2272 656c 6561 7365 6422 5d2c 0a20  s["released"],. 
-000420a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000420b0: 2020 2022 7072 6f63 6573 7369 6e67 223a     "processing":
-000420c0: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-000420d0: 7072 6f63 6573 7369 6e67 225d 2c0a 2020  processing"],.  
-000420e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000420f0: 2020 2277 6169 7469 6e67 223a 2061 6374    "waiting": act
-00042100: 6976 655f 7374 6174 6573 5b22 7761 6974  ive_states["wait
-00042110: 696e 6722 5d2c 0a20 2020 2020 2020 2020  ing"],.         
-00042120: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-00042130: 2020 7265 7475 726e 2073 7461 7465 0a0a    return state..
-00042140: 2020 2020 6465 6620 6765 745f 7461 736b      def get_task
-00042150: 5f73 7461 7475 7328 7365 6c66 2c20 6b65  _status(self, ke
-00042160: 7973 3a20 4974 6572 6162 6c65 5b73 7472  ys: Iterable[str
-00042170: 5d29 202d 3e20 6469 6374 5b73 7472 2c20  ]) -> dict[str, 
-00042180: 5461 736b 5374 6174 6553 7461 7465 207c  TaskStateState |
-00042190: 204e 6f6e 655d 3a0a 2020 2020 2020 2020   None]:.        
-000421a0: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
-000421b0: 2020 2020 206b 6579 3a20 2873 656c 662e       key: (self.
-000421c0: 7461 736b 735b 6b65 795d 2e73 7461 7465  tasks[key].state
-000421d0: 2069 6620 6b65 7920 696e 2073 656c 662e   if key in self.
-000421e0: 7461 736b 7320 656c 7365 204e 6f6e 6529  tasks else None)
-000421f0: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
-00042200: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-00042210: 6465 6620 6765 745f 7461 736b 5f73 7472  def get_task_str
-00042220: 6561 6d28 0a20 2020 2020 2020 2073 656c  eam(.        sel
-00042230: 662c 0a20 2020 2020 2020 2073 7461 7274  f,.        start
-00042240: 3a20 7374 7220 7c20 666c 6f61 7420 7c20  : str | float | 
-00042250: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00042260: 2020 2020 2073 746f 703a 2073 7472 207c       stop: str |
-00042270: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
-00042280: 4e6f 6e65 2c0a 2020 2020 2020 2020 636f  None,.        co
-00042290: 756e 743a 2069 6e74 207c 204e 6f6e 6520  unt: int | None 
-000422a0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
-000422b0: 206c 6973 743a 0a20 2020 2020 2020 2066   list:.        f
-000422c0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-000422d0: 6469 6167 6e6f 7374 6963 732e 7461 736b  diagnostics.task
-000422e0: 5f73 7472 6561 6d20 696d 706f 7274 2054  _stream import T
-000422f0: 6173 6b53 7472 6561 6d50 6c75 6769 6e0a  askStreamPlugin.
-00042300: 0a20 2020 2020 2020 2069 6620 5461 736b  .        if Task
-00042310: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-00042320: 6520 6e6f 7420 696e 2073 656c 662e 706c  e not in self.pl
-00042330: 7567 696e 733a 0a20 2020 2020 2020 2020  ugins:.         
-00042340: 2020 2073 656c 662e 6164 645f 706c 7567     self.add_plug
-00042350: 696e 2854 6173 6b53 7472 6561 6d50 6c75  in(TaskStreamPlu
-00042360: 6769 6e28 7365 6c66 2929 0a0a 2020 2020  gin(self))..    
-00042370: 2020 2020 706c 7567 696e 203d 2063 6173      plugin = cas
-00042380: 7428 5461 736b 5374 7265 616d 506c 7567  t(TaskStreamPlug
-00042390: 696e 2c20 7365 6c66 2e70 6c75 6769 6e73  in, self.plugins
-000423a0: 5b54 6173 6b53 7472 6561 6d50 6c75 6769  [TaskStreamPlugi
-000423b0: 6e2e 6e61 6d65 5d29 0a0a 2020 2020 2020  n.name])..      
-000423c0: 2020 7265 7475 726e 2070 6c75 6769 6e2e    return plugin.
-000423d0: 636f 6c6c 6563 7428 7374 6172 743d 7374  collect(start=st
-000423e0: 6172 742c 2073 746f 703d 7374 6f70 2c20  art, stop=stop, 
-000423f0: 636f 756e 743d 636f 756e 7429 0a0a 2020  count=count)..  
-00042400: 2020 6465 6620 7374 6172 745f 7461 736b    def start_task
-00042410: 5f6d 6574 6164 6174 6128 7365 6c66 2c20  _metadata(self, 
-00042420: 6e61 6d65 3a20 7374 7229 202d 3e20 4e6f  name: str) -> No
-00042430: 6e65 3a0a 2020 2020 2020 2020 706c 7567  ne:.        plug
-00042440: 696e 203d 2043 6f6c 6c65 6374 5461 736b  in = CollectTask
-00042450: 4d65 7461 4461 7461 506c 7567 696e 2873  MetaDataPlugin(s
-00042460: 6368 6564 756c 6572 3d73 656c 662c 206e  cheduler=self, n
-00042470: 616d 653d 6e61 6d65 290a 2020 2020 2020  ame=name).      
-00042480: 2020 7365 6c66 2e61 6464 5f70 6c75 6769    self.add_plugi
-00042490: 6e28 706c 7567 696e 290a 0a20 2020 2064  n(plugin)..    d
-000424a0: 6566 2073 746f 705f 7461 736b 5f6d 6574  ef stop_task_met
-000424b0: 6164 6174 6128 7365 6c66 2c20 6e61 6d65  adata(self, name
-000424c0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-000424d0: 6f6e 6529 202d 3e20 6469 6374 3a0a 2020  one) -> dict:.  
-000424e0: 2020 2020 2020 706c 7567 696e 7320 3d20        plugins = 
-000424f0: 5b0a 2020 2020 2020 2020 2020 2020 700a  [.            p.
-00042500: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00042510: 7020 696e 206c 6973 7428 7365 6c66 2e70  p in list(self.p
-00042520: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
-00042530: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00042540: 6973 696e 7374 616e 6365 2870 2c20 436f  isinstance(p, Co
-00042550: 6c6c 6563 7454 6173 6b4d 6574 6144 6174  llectTaskMetaDat
-00042560: 6150 6c75 6769 6e29 2061 6e64 2070 2e6e  aPlugin) and p.n
-00042570: 616d 6520 3d3d 206e 616d 650a 2020 2020  ame == name.    
-00042580: 2020 2020 5d0a 2020 2020 2020 2020 6966      ].        if
-00042590: 206c 656e 2870 6c75 6769 6e73 2920 213d   len(plugins) !=
-000425a0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-000425b0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-000425c0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000425d0: 2020 2245 7870 6563 7465 6420 746f 2066    "Expected to f
-000425e0: 696e 6420 6578 6163 746c 7920 6f6e 6520  ind exactly one 
-000425f0: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
-00042600: 6174 6150 6c75 6769 6e20 220a 2020 2020  ataPlugin ".    
-00042610: 2020 2020 2020 2020 2020 2020 6622 7769              f"wi
-00042620: 7468 206e 616d 6520 7b6e 616d 657d 2062  th name {name} b
-00042630: 7574 2066 6f75 6e64 207b 6c65 6e28 706c  ut found {len(pl
-00042640: 7567 696e 7329 7d2e 220a 2020 2020 2020  ugins)}.".      
-00042650: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00042660: 2070 6c75 6769 6e20 3d20 706c 7567 696e   plugin = plugin
-00042670: 735b 305d 0a20 2020 2020 2020 2073 656c  s[0].        sel
-00042680: 662e 7265 6d6f 7665 5f70 6c75 6769 6e28  f.remove_plugin(
-00042690: 6e61 6d65 3d70 6c75 6769 6e2e 6e61 6d65  name=plugin.name
-000426a0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000426b0: 207b 226d 6574 6164 6174 6122 3a20 706c   {"metadata": pl
-000426c0: 7567 696e 2e6d 6574 6164 6174 612c 2022  ugin.metadata, "
-000426d0: 7374 6174 6522 3a20 706c 7567 696e 2e73  state": plugin.s
-000426e0: 7461 7465 7d0a 0a20 2020 2061 7379 6e63  tate}..    async
-000426f0: 2064 6566 2072 6567 6973 7465 725f 776f   def register_wo
-00042700: 726b 6572 5f70 6c75 6769 6e28 7365 6c66  rker_plugin(self
-00042710: 2c20 636f 6d6d 2c20 706c 7567 696e 2c20  , comm, plugin, 
-00042720: 6e61 6d65 3d4e 6f6e 6529 3a0a 2020 2020  name=None):.    
-00042730: 2020 2020 2222 2252 6567 6973 7465 7273      """Registers
-00042740: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
-00042750: 206f 6e20 616c 6c20 7275 6e6e 696e 6720   on all running 
-00042760: 616e 6420 6675 7475 7265 2077 6f72 6b65  and future worke
-00042770: 7273 2222 220a 2020 2020 2020 2020 7365  rs""".        se
-00042780: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
-00042790: 735b 6e61 6d65 5d20 3d20 706c 7567 696e  s[name] = plugin
-000427a0: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-000427b0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-000427c0: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
-000427d0: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
-000427e0: 286f 703d 2270 6c75 6769 6e2d 6164 6422  (op="plugin-add"
-000427f0: 2c20 706c 7567 696e 3d70 6c75 6769 6e2c  , plugin=plugin,
-00042800: 206e 616d 653d 6e61 6d65 290a 2020 2020   name=name).    
-00042810: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00042820: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
-00042830: 2020 2020 6173 796e 6320 6465 6620 756e      async def un
-00042840: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-00042850: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
-00042860: 6d2c 206e 616d 6529 3a0a 2020 2020 2020  m, name):.      
-00042870: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
-00042880: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
-00042890: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-000428a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000428b0: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
-000428c0: 2e70 6f70 286e 616d 6529 0a20 2020 2020  .pop(name).     
-000428d0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-000428e0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-000428f0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00042900: 2866 2254 6865 2077 6f72 6b65 7220 706c  (f"The worker pl
-00042910: 7567 696e 207b 6e61 6d65 7d20 646f 6573  ugin {name} does
-00042920: 206e 6f74 2065 7869 7374 2229 0a0a 2020   not exist")..  
-00042930: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
-00042940: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00042950: 6164 6361 7374 286d 7367 3d64 6963 7428  adcast(msg=dict(
-00042960: 6f70 3d22 706c 7567 696e 2d72 656d 6f76  op="plugin-remov
-00042970: 6522 2c20 6e61 6d65 3d6e 616d 6529 290a  e", name=name)).
-00042980: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00042990: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
-000429a0: 796e 6320 6465 6620 7265 6769 7374 6572  ync def register
-000429b0: 5f6e 616e 6e79 5f70 6c75 6769 6e28 7365  _nanny_plugin(se
-000429c0: 6c66 2c20 636f 6d6d 2c20 706c 7567 696e  lf, comm, plugin
-000429d0: 2c20 6e61 6d65 3d4e 6f6e 6529 3a0a 2020  , name=None):.  
-000429e0: 2020 2020 2020 2222 2252 6567 6973 7465        """Registe
-000429f0: 7273 2061 2073 6574 7570 2066 756e 6374  rs a setup funct
-00042a00: 696f 6e2c 2061 6e64 2063 616c 6c20 6974  ion, and call it
-00042a10: 206f 6e20 6576 6572 7920 776f 726b 6572   on every worker
-00042a20: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00042a30: 2e6e 616e 6e79 5f70 6c75 6769 6e73 5b6e  .nanny_plugins[n
-00042a40: 616d 655d 203d 2070 6c75 6769 6e0a 0a20  ame] = plugin.. 
-00042a50: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
-00042a60: 203d 2061 7761 6974 2073 656c 662e 6272   = await self.br
-00042a70: 6f61 6463 6173 7428 0a20 2020 2020 2020  oadcast(.       
-00042a80: 2020 2020 206d 7367 3d64 6963 7428 6f70       msg=dict(op
-00042a90: 3d22 706c 7567 696e 5f61 6464 222c 2070  ="plugin_add", p
-00042aa0: 6c75 6769 6e3d 706c 7567 696e 2c20 6e61  lugin=plugin, na
-00042ab0: 6d65 3d6e 616d 6529 2c0a 2020 2020 2020  me=name),.      
-00042ac0: 2020 2020 2020 6e61 6e6e 793d 5472 7565        nanny=True
-00042ad0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00042ae0: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
-00042af0: 6e73 6573 0a0a 2020 2020 6173 796e 6320  nses..    async 
-00042b00: 6465 6620 756e 7265 6769 7374 6572 5f6e  def unregister_n
-00042b10: 616e 6e79 5f70 6c75 6769 6e28 7365 6c66  anny_plugin(self
-00042b20: 2c20 636f 6d6d 2c20 6e61 6d65 293a 0a20  , comm, name):. 
-00042b30: 2020 2020 2020 2022 2222 556e 7265 6769         """Unregi
-00042b40: 7374 6572 7320 6120 776f 726b 6572 2070  sters a worker p
-00042b50: 6c75 6769 6e22 2222 0a20 2020 2020 2020  lugin""".       
-00042b60: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00042b70: 2020 7365 6c66 2e6e 616e 6e79 5f70 6c75    self.nanny_plu
-00042b80: 6769 6e73 2e70 6f70 286e 616d 6529 0a20  gins.pop(name). 
-00042b90: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-00042ba0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-00042bb0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
-00042bc0: 7272 6f72 2866 2254 6865 206e 616e 6e79  rror(f"The nanny
-00042bd0: 2070 6c75 6769 6e20 7b6e 616d 657d 2064   plugin {name} d
-00042be0: 6f65 7320 6e6f 7420 6578 6973 7422 290a  oes not exist").
-00042bf0: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
-00042c00: 6573 203d 2061 7761 6974 2073 656c 662e  es = await self.
-00042c10: 6272 6f61 6463 6173 7428 0a20 2020 2020  broadcast(.     
-00042c20: 2020 2020 2020 206d 7367 3d64 6963 7428         msg=dict(
-00042c30: 6f70 3d22 706c 7567 696e 5f72 656d 6f76  op="plugin_remov
-00042c40: 6522 2c20 6e61 6d65 3d6e 616d 6529 2c20  e", name=name), 
-00042c50: 6e61 6e6e 793d 5472 7565 0a20 2020 2020  nanny=True.     
-00042c60: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
-00042c70: 7572 6e20 7265 7370 6f6e 7365 730a 0a20  urn responses.. 
-00042c80: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
-00042c90: 6e28 0a20 2020 2020 2020 2073 656c 662c  n(.        self,
-00042ca0: 0a20 2020 2020 2020 206b 6579 3a20 7374  .        key: st
-00042cb0: 722c 0a20 2020 2020 2020 2066 696e 6973  r,.        finis
-00042cc0: 683a 2054 6173 6b53 7461 7465 5374 6174  h: TaskStateStat
-00042cd0: 652c 0a20 2020 2020 2020 2073 7469 6d75  e,.        stimu
-00042ce0: 6c75 735f 6964 3a20 7374 722c 0a20 2020  lus_id: str,.   
-00042cf0: 2020 2020 202a 2a6b 7761 7267 733a 2041       **kwargs: A
-00042d00: 6e79 2c0a 2020 2020 2920 2d3e 2052 6563  ny,.    ) -> Rec
-00042d10: 733a 0a20 2020 2020 2020 2022 2222 5472  s:.        """Tr
-00042d20: 616e 7369 7469 6f6e 2061 206b 6579 2066  ansition a key f
-00042d30: 726f 6d20 6974 7320 6375 7272 656e 7420  rom its current 
-00042d40: 7374 6174 6520 746f 2074 6865 2066 696e  state to the fin
-00042d50: 6973 6820 7374 6174 650a 0a20 2020 2020  ish state..     
-00042d60: 2020 2045 7861 6d70 6c65 730a 2020 2020     Examples.    
-00042d70: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00042d80: 2020 2020 203e 3e3e 2073 656c 662e 7472       >>> self.tr
-00042d90: 616e 7369 7469 6f6e 2827 7827 2c20 2777  ansition('x', 'w
-00042da0: 6169 7469 6e67 2729 0a20 2020 2020 2020  aiting').       
-00042db0: 207b 2778 273a 2027 7072 6f63 6573 7369   {'x': 'processi
-00042dc0: 6e67 277d 0a0a 2020 2020 2020 2020 5265  ng'}..        Re
-00042dd0: 7475 726e 730a 2020 2020 2020 2020 2d2d  turns.        --
-00042de0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 4469  -----.        Di
-00042df0: 6374 696f 6e61 7279 206f 6620 7265 636f  ctionary of reco
-00042e00: 6d6d 656e 6461 7469 6f6e 7320 666f 7220  mmendations for 
-00042e10: 6675 7475 7265 2074 7261 6e73 6974 696f  future transitio
-00042e20: 6e73 0a0a 2020 2020 2020 2020 5365 6520  ns..        See 
-00042e30: 416c 736f 0a20 2020 2020 2020 202d 2d2d  Also.        ---
-00042e40: 2d2d 2d2d 2d0a 2020 2020 2020 2020 5363  -----.        Sc
-00042e50: 6865 6475 6c65 722e 7472 616e 7369 7469  heduler.transiti
-00042e60: 6f6e 733a 2074 7261 6e73 6974 6976 6520  ons: transitive 
-00042e70: 7665 7273 696f 6e20 6f66 2074 6869 7320  version of this 
-00042e80: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-00042e90: 2022 2222 0a20 2020 2020 2020 2072 6563   """.        rec
-00042ea0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-00042eb0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00042ec0: 725f 6d73 6773 203d 2073 656c 662e 5f74  r_msgs = self._t
-00042ed0: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
-00042ee0: 2020 2020 2020 206b 6579 2c20 6669 6e69         key, fini
-00042ef0: 7368 2c20 7374 696d 756c 7573 5f69 642c  sh, stimulus_id,
-00042f00: 202a 2a6b 7761 7267 730a 2020 2020 2020   **kwargs.      
-00042f10: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00042f20: 2e73 656e 645f 616c 6c28 636c 6965 6e74  .send_all(client
-00042f30: 5f6d 7367 732c 2077 6f72 6b65 725f 6d73  _msgs, worker_ms
-00042f40: 6773 290a 2020 2020 2020 2020 7265 7475  gs).        retu
-00042f50: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
-00042f60: 6e73 0a0a 2020 2020 6465 6620 7472 616e  ns..    def tran
-00042f70: 7369 7469 6f6e 7328 7365 6c66 2c20 7265  sitions(self, re
-00042f80: 636f 6d6d 656e 6461 7469 6f6e 733a 2052  commendations: R
-00042f90: 6563 732c 2073 7469 6d75 6c75 735f 6964  ecs, stimulus_id
-00042fa0: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-00042fb0: 2020 2020 2020 2020 2222 2250 726f 6365          """Proce
-00042fc0: 7373 2074 7261 6e73 6974 696f 6e73 2075  ss transitions u
-00042fd0: 6e74 696c 206e 6f6e 6520 6172 6520 6c65  ntil none are le
-00042fe0: 6674 0a0a 2020 2020 2020 2020 5468 6973  ft..        This
-00042ff0: 2069 6e63 6c75 6465 7320 6665 6564 6261   includes feedba
-00043000: 636b 2066 726f 6d20 7072 6576 696f 7573  ck from previous
-00043010: 2074 7261 6e73 6974 696f 6e73 2061 6e64   transitions and
-00043020: 2063 6f6e 7469 6e75 6573 2075 6e74 696c   continues until
-00043030: 2077 650a 2020 2020 2020 2020 7265 6163   we.        reac
-00043040: 6820 6120 7374 6561 6479 2073 7461 7465  h a steady state
-00043050: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00043060: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00043070: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
-00043080: 2020 2020 776f 726b 6572 5f6d 7367 733a      worker_msgs:
-00043090: 204d 7367 7320 3d20 7b7d 0a20 2020 2020   Msgs = {}.     
-000430a0: 2020 2073 656c 662e 5f74 7261 6e73 6974     self._transit
-000430b0: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
-000430c0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-000430d0: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
-000430e0: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
-000430f0: 2020 2020 2073 656c 662e 7365 6e64 5f61       self.send_a
-00043100: 6c6c 2863 6c69 656e 745f 6d73 6773 2c20  ll(client_msgs, 
-00043110: 776f 726b 6572 5f6d 7367 7329 0a0a 2020  worker_msgs)..  
-00043120: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
-00043130: 7374 6f72 7928 7365 6c66 2c20 6b65 7973  story(self, keys
-00043140: 5f6f 725f 7374 696d 756c 693a 2049 7465  _or_stimuli: Ite
-00043150: 7261 626c 655b 7374 725d 2920 2d3e 206c  rable[str]) -> l
-00043160: 6973 745b 5472 616e 7369 7469 6f6e 5d3a  ist[Transition]:
-00043170: 0a20 2020 2020 2020 2022 2222 5250 4320  .        """RPC 
-00043180: 686f 6f6b 2066 6f72 203a 6d65 7468 3a60  hook for :meth:`
-00043190: 5363 6865 6475 6c65 7253 7461 7465 2e73  SchedulerState.s
-000431a0: 746f 7279 602e 0a0a 2020 2020 2020 2020  tory`...        
-000431b0: 4e6f 7465 2074 6861 7420 7468 6520 6d73  Note that the ms
-000431c0: 6770 6163 6b20 7365 7269 616c 697a 6174  gpack serializat
-000431d0: 696f 6e2f 6465 7365 7269 616c 697a 6174  ion/deserializat
-000431e0: 696f 6e20 726f 756e 642d 7472 6970 2077  ion round-trip w
-000431f0: 696c 6c20 7472 616e 7366 6f72 6d0a 2020  ill transform.  
-00043200: 2020 2020 2020 7468 6520 3a63 6c61 7373        the :class
-00043210: 3a60 5472 616e 7369 7469 6f6e 6020 6e61  :`Transition` na
-00043220: 6d65 6474 7570 6c65 7320 696e 746f 2072  medtuples into r
-00043230: 6567 756c 6172 2074 7570 6c65 732e 0a20  egular tuples.. 
-00043240: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00043250: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
-00043260: 746f 7279 282a 6b65 7973 5f6f 725f 7374  tory(*keys_or_st
-00043270: 696d 756c 6929 0a0a 2020 2020 6465 6620  imuli)..    def 
-00043280: 5f72 6573 6368 6564 756c 6528 0a20 2020  _reschedule(.   
-00043290: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
-000432a0: 7374 722c 2077 6f72 6b65 723a 2073 7472  str, worker: str
-000432b0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c20   | None = None, 
-000432c0: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
-000432d0: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
-000432e0: 653a 0a20 2020 2020 2020 2022 2222 5265  e:.        """Re
-000432f0: 7363 6865 6475 6c65 2061 2074 6173 6b2e  schedule a task.
-00043300: 0a0a 2020 2020 2020 2020 5468 6973 2066  ..        This f
-00043310: 756e 6374 696f 6e20 7368 6f75 6c64 206f  unction should o
-00043320: 6e6c 7920 6265 2075 7365 6420 7768 656e  nly be used when
-00043330: 2074 6865 2074 6173 6b20 6861 7320 616c   the task has al
-00043340: 7265 6164 7920 6265 656e 2072 656c 6561  ready been relea
-00043350: 7365 6420 696e 0a20 2020 2020 2020 2073  sed in.        s
-00043360: 6f6d 6520 7761 7920 6f6e 2074 6865 2077  ome way on the w
-00043370: 6f72 6b65 7220 6974 2773 2061 7373 6967  orker it's assig
-00043380: 6e65 6420 746f 20e2 8094 2065 6974 6865  ned to ... eithe
-00043390: 7220 7669 6120 6361 6e63 656c 6c61 7469  r via cancellati
-000433a0: 6f6e 206f 7220 610a 2020 2020 2020 2020  on or a.        
-000433b0: 5265 7363 6865 6475 6c65 2065 7863 6570  Reschedule excep
-000433c0: 7469 6f6e 20e2 8094 2061 6e64 2079 6f75  tion ... and you
-000433d0: 2061 7265 2063 6572 7461 696e 2074 6865   are certain the
-000433e0: 2077 6f72 6b65 7220 7769 6c6c 206e 6f74   worker will not
-000433f0: 2073 656e 6420 616e 7920 6675 7274 6865   send any furthe
-00043400: 720a 2020 2020 2020 2020 7570 6461 7465  r.        update
-00043410: 7320 6162 6f75 7420 7468 6520 7461 736b  s about the task
-00043420: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
-00043430: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
-00043440: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00043450: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00043460: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00043470: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-00043480: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00043490: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-000434a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000434b0: 2020 6622 4174 7465 6d70 7469 6e67 2074    f"Attempting t
-000434c0: 6f20 7265 7363 6865 6475 6c65 2074 6173  o reschedule tas
-000434d0: 6b20 7b6b 6579 7d2c 2077 6869 6368 2077  k {key}, which w
-000434e0: 6173 206e 6f74 2022 0a20 2020 2020 2020  as not ".       
-000434f0: 2020 2020 2020 2020 2022 666f 756e 6420           "found 
-00043500: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
-00043510: 2e20 4162 6f72 7469 6e67 2072 6573 6368  . Aborting resch
-00043520: 6564 756c 652e 220a 2020 2020 2020 2020  edule.".        
-00043530: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00043540: 2020 7265 7475 726e 0a20 2020 2020 2020    return.       
-00043550: 2069 6620 7473 2e73 7461 7465 2021 3d20   if ts.state != 
-00043560: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
-00043570: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00043580: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
-00043590: 6572 2061 6e64 2074 732e 7072 6f63 6573  er and ts.proces
-000435a0: 7369 6e67 5f6f 6e20 616e 6420 7473 2e70  sing_on and ts.p
-000435b0: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
-000435c0: 7265 7373 2021 3d20 776f 726b 6572 3a0a  ress != worker:.
-000435d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000435e0: 726e 0a20 2020 2020 2020 2023 2074 7261  rn.        # tra
-000435f0: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
-00043600: 6e67 5f72 656c 6561 7365 6420 7769 6c6c  ng_released will
-00043610: 2069 6d6d 6564 6961 7465 6c79 2073 7567   immediately sug
-00043620: 6765 7374 2061 6e20 6164 6469 7469 6f6e  gest an addition
-00043630: 616c 0a20 2020 2020 2020 2023 2074 7261  al.        # tra
-00043640: 6e73 6974 696f 6e20 746f 2077 6169 7469  nsition to waiti
-00043650: 6e67 2069 6620 7468 6520 7461 736b 2068  ng if the task h
-00043660: 6173 2061 6e79 2077 6169 7465 7273 206f  as any waiters o
-00043670: 7220 636c 6965 6e74 7320 686f 6c64 696e  r clients holdin
-00043680: 6720 6120 6675 7475 7265 2e0a 2020 2020  g a future..    
-00043690: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-000436a0: 696f 6e73 287b 6b65 793a 2022 7265 6c65  ions({key: "rele
-000436b0: 6173 6564 227d 2c20 7374 696d 756c 7573  ased"}, stimulus
-000436c0: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-000436d0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-000436e0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-000436f0: 2320 5574 696c 6974 7920 6675 6e63 7469  # Utility functi
-00043700: 6f6e 7320 230a 2020 2020 2323 2323 2323  ons #.    ######
-00043710: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
-00043720: 0a20 2020 2064 6566 2061 6464 5f72 6573  .    def add_res
-00043730: 6f75 7263 6573 280a 2020 2020 2020 2020  ources(.        
-00043740: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
-00043750: 722c 2072 6573 6f75 7263 6573 3a20 6469  r, resources: di
-00043760: 6374 207c 204e 6f6e 6520 3d20 4e6f 6e65  ct | None = None
-00043770: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-00043780: 6c5b 224f 4b22 5d3a 0a20 2020 2020 2020  l["OK"]:.       
-00043790: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
-000437a0: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
-000437b0: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-000437c0: 6966 2072 6573 6f75 7263 6573 3a0a 2020  if resources:.  
-000437d0: 2020 2020 2020 2020 2020 7773 2e72 6573            ws.res
-000437e0: 6f75 7263 6573 2e75 7064 6174 6528 7265  ources.update(re
-000437f0: 736f 7572 6365 7329 0a20 2020 2020 2020  sources).       
-00043800: 2077 732e 7573 6564 5f72 6573 6f75 7263   ws.used_resourc
-00043810: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
-00043820: 666f 7220 7265 736f 7572 6365 2c20 7175  for resource, qu
-00043830: 616e 7469 7479 2069 6e20 7773 2e72 6573  antity in ws.res
-00043840: 6f75 7263 6573 2e69 7465 6d73 2829 3a0a  ources.items():.
-00043850: 2020 2020 2020 2020 2020 2020 7773 2e75              ws.u
-00043860: 7365 645f 7265 736f 7572 6365 735b 7265  sed_resources[re
-00043870: 736f 7572 6365 5d20 3d20 300a 2020 2020  source] = 0.    
-00043880: 2020 2020 2020 2020 6472 203d 2073 656c          dr = sel
-00043890: 662e 7265 736f 7572 6365 732e 6765 7428  f.resources.get(
-000438a0: 7265 736f 7572 6365 2c20 4e6f 6e65 290a  resource, None).
-000438b0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-000438c0: 7220 6973 204e 6f6e 653a 0a20 2020 2020  r is None:.     
-000438d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000438e0: 7265 736f 7572 6365 735b 7265 736f 7572  resources[resour
-000438f0: 6365 5d20 3d20 6472 203d 207b 7d0a 2020  ce] = dr = {}.  
-00043900: 2020 2020 2020 2020 2020 6472 5b77 6f72            dr[wor
-00043910: 6b65 725d 203d 2071 7561 6e74 6974 790a  ker] = quantity.
-00043920: 2020 2020 2020 2020 7265 7475 726e 2022          return "
-00043930: 4f4b 220a 0a20 2020 2064 6566 2072 656d  OK"..    def rem
-00043940: 6f76 655f 7265 736f 7572 6365 7328 7365  ove_resources(se
-00043950: 6c66 2c20 776f 726b 6572 3a20 7374 7229  lf, worker: str)
-00043960: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00043970: 2020 7773 3a20 576f 726b 6572 5374 6174    ws: WorkerStat
-00043980: 6520 3d20 7365 6c66 2e77 6f72 6b65 7273  e = self.workers
-00043990: 5b77 6f72 6b65 725d 0a20 2020 2020 2020  [worker].       
-000439a0: 2066 6f72 2072 6573 6f75 7263 6520 696e   for resource in
-000439b0: 2077 732e 7265 736f 7572 6365 733a 0a20   ws.resources:. 
-000439c0: 2020 2020 2020 2020 2020 2064 7220 3d20             dr = 
-000439d0: 7365 6c66 2e72 6573 6f75 7263 6573 2e73  self.resources.s
-000439e0: 6574 6465 6661 756c 7428 7265 736f 7572  etdefault(resour
-000439f0: 6365 2c20 7b7d 290a 2020 2020 2020 2020  ce, {}).        
-00043a00: 2020 2020 6465 6c20 6472 5b77 6f72 6b65      del dr[worke
-00043a10: 725d 0a0a 2020 2020 6465 6620 636f 6572  r]..    def coer
-00043a20: 6365 5f61 6464 7265 7373 2873 656c 662c  ce_address(self,
-00043a30: 2061 6464 723a 2073 7472 207c 2074 7570   addr: str | tup
-00043a40: 6c65 2c20 7265 736f 6c76 653a 2062 6f6f  le, resolve: boo
-00043a50: 6c20 3d20 5472 7565 2920 2d3e 2073 7472  l = True) -> str
-00043a60: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00043a70: 2020 2020 2020 436f 6572 6365 2070 6f73        Coerce pos
-00043a80: 7369 626c 6520 696e 7075 7420 6164 6472  sible input addr
-00043a90: 6573 7365 7320 746f 2063 616e 6f6e 6963  esses to canonic
-00043aa0: 616c 2066 6f72 6d2e 0a20 2020 2020 2020  al form..       
-00043ab0: 202a 7265 736f 6c76 652a 2063 616e 2062   *resolve* can b
-00043ac0: 6520 6469 7361 626c 6564 2066 6f72 2074  e disabled for t
-00043ad0: 6573 7469 6e67 2077 6974 6820 6661 6b65  esting with fake
-00043ae0: 2068 6f73 746e 616d 6573 2e0a 0a20 2020   hostnames...   
-00043af0: 2020 2020 2048 616e 646c 6573 2073 7472       Handles str
-00043b00: 696e 6773 2c20 7475 706c 6573 2c20 6f72  ings, tuples, or
-00043b10: 2061 6c69 6173 6573 2e0a 2020 2020 2020   aliases..      
-00043b20: 2020 2222 220a 2020 2020 2020 2020 2320    """.        # 
-00043b30: 5858 5820 686f 7720 6d61 6e79 2061 6464  XXX how many add
-00043b40: 7265 7373 2d70 6172 7369 6e67 2072 6f75  ress-parsing rou
-00043b50: 7469 6e65 7320 646f 2077 6520 6861 7665  tines do we have
-00043b60: 3f0a 2020 2020 2020 2020 6966 2061 6464  ?.        if add
-00043b70: 7220 696e 2073 656c 662e 616c 6961 7365  r in self.aliase
-00043b80: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
-00043b90: 6464 7220 3d20 7365 6c66 2e61 6c69 6173  ddr = self.alias
-00043ba0: 6573 5b61 6464 725d 0a20 2020 2020 2020  es[addr].       
-00043bb0: 2069 6620 6973 696e 7374 616e 6365 2861   if isinstance(a
-00043bc0: 6464 722c 2074 7570 6c65 293a 0a20 2020  ddr, tuple):.   
-00043bd0: 2020 2020 2020 2020 2061 6464 7220 3d20           addr = 
-00043be0: 756e 7061 7273 655f 686f 7374 5f70 6f72  unparse_host_por
-00043bf0: 7428 2a61 6464 7229 0a20 2020 2020 2020  t(*addr).       
-00043c00: 2069 6620 6e6f 7420 6973 696e 7374 616e   if not isinstan
-00043c10: 6365 2861 6464 722c 2073 7472 293a 0a20  ce(addr, str):. 
-00043c20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00043c30: 2054 7970 6545 7272 6f72 2866 2261 6464   TypeError(f"add
-00043c40: 7265 7373 6573 2073 686f 756c 6420 6265  resses should be
-00043c50: 2073 7472 696e 6773 206f 7220 7475 706c   strings or tupl
-00043c60: 6573 2c20 676f 7420 7b61 6464 7221 727d  es, got {addr!r}
-00043c70: 2229 0a0a 2020 2020 2020 2020 6966 2072  ")..        if r
-00043c80: 6573 6f6c 7665 3a0a 2020 2020 2020 2020  esolve:.        
-00043c90: 2020 2020 6164 6472 203d 2072 6573 6f6c      addr = resol
-00043ca0: 7665 5f61 6464 7265 7373 2861 6464 7229  ve_address(addr)
-00043cb0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00043cc0: 2020 2020 2020 2020 2020 2061 6464 7220             addr 
-00043cd0: 3d20 6e6f 726d 616c 697a 655f 6164 6472  = normalize_addr
-00043ce0: 6573 7328 6164 6472 290a 0a20 2020 2020  ess(addr)..     
-00043cf0: 2020 2072 6574 7572 6e20 6164 6472 0a0a     return addr..
-00043d00: 2020 2020 6465 6620 776f 726b 6572 735f      def workers_
-00043d10: 6c69 7374 2873 656c 662c 2077 6f72 6b65  list(self, worke
-00043d20: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-00043d30: 5d20 7c20 4e6f 6e65 2920 2d3e 206c 6973  ] | None) -> lis
-00043d40: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
-00043d50: 2222 220a 2020 2020 2020 2020 4c69 7374  """.        List
-00043d60: 206f 6620 7175 616c 6966 7969 6e67 2077   of qualifying w
-00043d70: 6f72 6b65 7273 0a0a 2020 2020 2020 2020  orkers..        
-00043d80: 5461 6b65 7320 6120 6c69 7374 206f 6620  Takes a list of 
-00043d90: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
-00043da0: 206f 7220 686f 7374 6e61 6d65 732e 0a20   or hostnames.. 
-00043db0: 2020 2020 2020 2052 6574 7572 6e73 2061         Returns a
-00043dc0: 206c 6973 7420 6f66 2061 6c6c 2077 6f72   list of all wor
-00043dd0: 6b65 7220 6164 6472 6573 7365 7320 7468  ker addresses th
-00043de0: 6174 206d 6174 6368 0a20 2020 2020 2020  at match.       
-00043df0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00043e00: 776f 726b 6572 7320 6973 204e 6f6e 653a  workers is None:
-00043e10: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00043e20: 7572 6e20 6c69 7374 2873 656c 662e 776f  urn list(self.wo
-00043e30: 726b 6572 7329 0a0a 2020 2020 2020 2020  rkers)..        
-00043e40: 6f75 7420 3d20 7365 7428 290a 2020 2020  out = set().    
-00043e50: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-00043e60: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00043e70: 2020 6966 2022 3a22 2069 6e20 773a 0a20    if ":" in w:. 
-00043e80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00043e90: 7574 2e61 6464 2877 290a 2020 2020 2020  ut.add(w).      
-00043ea0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00043eb0: 2020 2020 2020 2020 2020 2020 6f75 742e              out.
-00043ec0: 7570 6461 7465 287b 7777 2066 6f72 2077  update({ww for w
-00043ed0: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
-00043ee0: 7320 6966 2077 2069 6e20 7777 7d29 2020  s if w in ww})  
-00043ef0: 2320 544f 444f 3a20 7175 6164 7261 7469  # TODO: quadrati
-00043f00: 630a 2020 2020 2020 2020 7265 7475 726e  c.        return
-00043f10: 206c 6973 7428 6f75 7429 0a0a 2020 2020   list(out)..    
-00043f20: 6173 796e 6320 6465 6620 6765 745f 7072  async def get_pr
-00043f30: 6f66 696c 6528 0a20 2020 2020 2020 2073  ofile(.        s
-00043f40: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
-00043f50: 6d3d 4e6f 6e65 2c0a 2020 2020 2020 2020  m=None,.        
-00043f60: 776f 726b 6572 733d 4e6f 6e65 2c0a 2020  workers=None,.  
-00043f70: 2020 2020 2020 7363 6865 6475 6c65 723d        scheduler=
-00043f80: 4661 6c73 652c 0a20 2020 2020 2020 2073  False,.        s
-00043f90: 6572 7665 723d 4661 6c73 652c 0a20 2020  erver=False,.   
-00043fa0: 2020 2020 206d 6572 6765 5f77 6f72 6b65       merge_worke
-00043fb0: 7273 3d54 7275 652c 0a20 2020 2020 2020  rs=True,.       
-00043fc0: 2073 7461 7274 3d4e 6f6e 652c 0a20 2020   start=None,.   
-00043fd0: 2020 2020 2073 746f 703d 4e6f 6e65 2c0a       stop=None,.
-00043fe0: 2020 2020 2020 2020 6b65 793d 4e6f 6e65          key=None
-00043ff0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-00044000: 2069 6620 776f 726b 6572 7320 6973 204e   if workers is N
-00044010: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00044020: 2077 6f72 6b65 7273 203d 2073 656c 662e   workers = self.
-00044030: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
-00044040: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00044050: 2020 776f 726b 6572 7320 3d20 7365 7428    workers = set(
-00044060: 7365 6c66 2e77 6f72 6b65 7273 2920 2620  self.workers) & 
-00044070: 7365 7428 776f 726b 6572 7329 0a0a 2020  set(workers)..  
-00044080: 2020 2020 2020 6966 2073 6368 6564 756c        if schedul
-00044090: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-000440a0: 7265 7475 726e 2070 726f 6669 6c65 2e67  return profile.g
-000440b0: 6574 5f70 726f 6669 6c65 2873 656c 662e  et_profile(self.
-000440c0: 696f 5f6c 6f6f 702e 7072 6f66 696c 652c  io_loop.profile,
-000440d0: 2073 7461 7274 3d73 7461 7274 2c20 7374   start=start, st
-000440e0: 6f70 3d73 746f 7029 0a0a 2020 2020 2020  op=stop)..      
-000440f0: 2020 7265 7375 6c74 7320 3d20 6177 6169    results = awai
-00044100: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-00044110: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-00044120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044130: 2073 656c 662e 7270 6328 7729 2e70 726f   self.rpc(w).pro
-00044140: 6669 6c65 2873 7461 7274 3d73 7461 7274  file(start=start
-00044150: 2c20 7374 6f70 3d73 746f 702c 206b 6579  , stop=stop, key
-00044160: 3d6b 6579 2c20 7365 7276 6572 3d73 6572  =key, server=ser
-00044170: 7665 7229 0a20 2020 2020 2020 2020 2020  ver).           
-00044180: 2020 2020 2066 6f72 2077 2069 6e20 776f       for w in wo
-00044190: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-000441a0: 2020 292c 0a20 2020 2020 2020 2020 2020    ),.           
-000441b0: 2072 6574 7572 6e5f 6578 6365 7074 696f   return_exceptio
-000441c0: 6e73 3d54 7275 652c 0a20 2020 2020 2020  ns=True,.       
-000441d0: 2029 0a0a 2020 2020 2020 2020 7265 7375   )..        resu
-000441e0: 6c74 7320 3d20 5b72 2066 6f72 2072 2069  lts = [r for r i
-000441f0: 6e20 7265 7375 6c74 7320 6966 206e 6f74  n results if not
-00044200: 2069 7369 6e73 7461 6e63 6528 722c 2045   isinstance(r, E
-00044210: 7863 6570 7469 6f6e 295d 0a0a 2020 2020  xception)]..    
-00044220: 2020 2020 6966 206d 6572 6765 5f77 6f72      if merge_wor
-00044230: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00044240: 2020 7265 7370 6f6e 7365 203d 2070 726f    response = pro
-00044250: 6669 6c65 2e6d 6572 6765 282a 7265 7375  file.merge(*resu
-00044260: 6c74 7329 0a20 2020 2020 2020 2065 6c73  lts).        els
-00044270: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00044280: 6573 706f 6e73 6520 3d20 6469 6374 287a  esponse = dict(z
-00044290: 6970 2877 6f72 6b65 7273 2c20 7265 7375  ip(workers, resu
-000442a0: 6c74 7329 290a 2020 2020 2020 2020 7265  lts)).        re
-000442b0: 7475 726e 2072 6573 706f 6e73 650a 0a20  turn response.. 
-000442c0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-000442d0: 5f70 726f 6669 6c65 5f6d 6574 6164 6174  _profile_metadat
-000442e0: 6128 0a20 2020 2020 2020 2073 656c 662c  a(.        self,
-000442f0: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
-00044300: 3a20 2249 7465 7261 626c 655b 7374 725d  : "Iterable[str]
-00044310: 207c 204e 6f6e 6522 203d 204e 6f6e 652c   | None" = None,
-00044320: 0a20 2020 2020 2020 2073 7461 7274 3a20  .        start: 
-00044330: 666c 6f61 7420 3d20 302c 0a20 2020 2020  float = 0,.     
-00044340: 2020 2073 746f 703a 2022 666c 6f61 7420     stop: "float 
-00044350: 7c20 4e6f 6e65 2220 3d20 4e6f 6e65 2c0a  | None" = None,.
-00044360: 2020 2020 2020 2020 7072 6f66 696c 655f          profile_
-00044370: 6379 636c 655f 696e 7465 7276 616c 3a20  cycle_interval: 
-00044380: 2273 7472 207c 2066 6c6f 6174 207c 204e  "str | float | N
-00044390: 6f6e 6522 203d 204e 6f6e 652c 0a20 2020  one" = None,.   
-000443a0: 2029 202d 3e20 6469 6374 3a0a 2020 2020   ) -> dict:.    
-000443b0: 2020 2020 6474 203d 2070 726f 6669 6c65      dt = profile
-000443c0: 5f63 7963 6c65 5f69 6e74 6572 7661 6c20  _cycle_interval 
-000443d0: 6f72 2064 6173 6b2e 636f 6e66 6967 2e67  or dask.config.g
-000443e0: 6574 280a 2020 2020 2020 2020 2020 2020  et(.            
-000443f0: 2264 6973 7472 6962 7574 6564 2e77 6f72  "distributed.wor
-00044400: 6b65 722e 7072 6f66 696c 652e 6379 636c  ker.profile.cycl
-00044410: 6522 0a20 2020 2020 2020 2029 0a20 2020  e".        ).   
-00044420: 2020 2020 2064 7420 3d20 7061 7273 655f       dt = parse_
-00044430: 7469 6d65 6465 6c74 6128 6474 2c20 6465  timedelta(dt, de
-00044440: 6661 756c 743d 226d 7322 290a 0a20 2020  fault="ms")..   
-00044450: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-00044460: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00044470: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-00044480: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-00044490: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000444a0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
-000444b0: 7365 7428 7365 6c66 2e77 6f72 6b65 7273  set(self.workers
-000444c0: 2920 2620 7365 7428 776f 726b 6572 7329  ) & set(workers)
-000444d0: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
-000444e0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-000444f0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
-00044500: 2020 2020 202a 2873 656c 662e 7270 6328       *(self.rpc(
-00044510: 7729 2e70 726f 6669 6c65 5f6d 6574 6164  w).profile_metad
-00044520: 6174 6128 7374 6172 743d 7374 6172 742c  ata(start=start,
-00044530: 2073 746f 703d 7374 6f70 2920 666f 7220   stop=stop) for 
-00044540: 7720 696e 2077 6f72 6b65 7273 292c 0a20  w in workers),. 
-00044550: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00044560: 6e5f 6578 6365 7074 696f 6e73 3d54 7275  n_exceptions=Tru
-00044570: 652c 0a20 2020 2020 2020 2029 0a0a 2020  e,.        )..  
-00044580: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
-00044590: 5b72 2066 6f72 2072 2069 6e20 7265 7375  [r for r in resu
-000445a0: 6c74 7320 6966 206e 6f74 2069 7369 6e73  lts if not isins
-000445b0: 7461 6e63 6528 722c 2045 7863 6570 7469  tance(r, Excepti
-000445c0: 6f6e 295d 0a20 2020 2020 2020 2063 6f75  on)].        cou
-000445d0: 6e74 7320 3d20 5b0a 2020 2020 2020 2020  nts = [.        
-000445e0: 2020 2020 2874 696d 652c 2073 756d 2870      (time, sum(p
-000445f0: 6c75 636b 2831 2c20 6772 6f75 7029 2929  luck(1, group)))
-00044600: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00044610: 2074 696d 652c 2067 726f 7570 2069 6e20   time, group in 
-00044620: 6974 6572 746f 6f6c 732e 6772 6f75 7062  itertools.groupb
-00044630: 7928 0a20 2020 2020 2020 2020 2020 2020  y(.             
-00044640: 2020 206d 6572 6765 5f73 6f72 7465 6428     merge_sorted(
-00044650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044660: 2020 2020 202a 2876 5b22 636f 756e 7473       *(v["counts
-00044670: 225d 2066 6f72 2076 2069 6e20 7265 7375  "] for v in resu
-00044680: 6c74 7329 2c0a 2020 2020 2020 2020 2020  lts),.          
-00044690: 2020 2020 2020 292c 0a20 2020 2020 2020        ),.       
-000446a0: 2020 2020 2020 2020 206c 616d 6264 6120           lambda 
-000446b0: 743a 2074 5b30 5d20 2f2f 2064 7420 2a20  t: t[0] // dt * 
-000446c0: 6474 2c0a 2020 2020 2020 2020 2020 2020  dt,.            
-000446d0: 290a 2020 2020 2020 2020 5d0a 0a20 2020  ).        ]..   
-000446e0: 2020 2020 206b 6579 733a 2064 6963 745b       keys: dict[
-000446f0: 7374 722c 206c 6973 745b 6c69 7374 5d5d  str, list[list]]
-00044700: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00044710: 206b 3a20 5b5d 2066 6f72 2076 2069 6e20   k: [] for v in 
-00044720: 7265 7375 6c74 7320 666f 7220 742c 2064  results for t, d
-00044730: 2069 6e20 765b 226b 6579 7322 5d20 666f   in v["keys"] fo
-00044740: 7220 6b20 696e 2064 0a20 2020 2020 2020  r k in d.       
-00044750: 207d 0a0a 2020 2020 2020 2020 6772 6f75   }..        grou
-00044760: 7073 3120 3d20 5b76 5b22 6b65 7973 225d  ps1 = [v["keys"]
-00044770: 2066 6f72 2076 2069 6e20 7265 7375 6c74   for v in result
-00044780: 735d 0a20 2020 2020 2020 2067 726f 7570  s].        group
-00044790: 7332 203d 206c 6973 7428 6d65 7267 655f  s2 = list(merge_
-000447a0: 736f 7274 6564 282a 6772 6f75 7073 312c  sorted(*groups1,
-000447b0: 206b 6579 3d66 6972 7374 2929 0a0a 2020   key=first))..  
-000447c0: 2020 2020 2020 6c61 7374 203d 2030 0a20        last = 0. 
-000447d0: 2020 2020 2020 2066 6f72 2074 2c20 6420         for t, d 
-000447e0: 696e 2067 726f 7570 7332 3a0a 2020 2020  in groups2:.    
-000447f0: 2020 2020 2020 2020 7474 203d 2074 202f          tt = t /
-00044800: 2f20 6474 202a 2064 740a 2020 2020 2020  / dt * dt.      
-00044810: 2020 2020 2020 6966 2074 7420 3e20 6c61        if tt > la
-00044820: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-00044830: 2020 2020 6c61 7374 203d 2074 740a 2020      last = tt.  
-00044840: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00044850: 7220 7620 696e 206b 6579 732e 7661 6c75  r v in keys.valu
-00044860: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00044870: 2020 2020 2020 2020 2020 762e 6170 7065            v.appe
-00044880: 6e64 285b 7474 2c20 305d 290a 2020 2020  nd([tt, 0]).    
-00044890: 2020 2020 2020 2020 666f 7220 6b2c 2076          for k, v
-000448a0: 2069 6e20 642e 6974 656d 7328 293a 0a20   in d.items():. 
-000448b0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-000448c0: 6579 735b 6b5d 5b2d 315d 5b31 5d20 2b3d  eys[k][-1][1] +=
-000448d0: 2076 0a0a 2020 2020 2020 2020 7265 7475   v..        retu
-000448e0: 726e 207b 2263 6f75 6e74 7322 3a20 636f  rn {"counts": co
-000448f0: 756e 7473 2c20 226b 6579 7322 3a20 6b65  unts, "keys": ke
-00044900: 7973 7d0a 0a20 2020 2061 7379 6e63 2064  ys}..    async d
-00044910: 6566 2070 6572 666f 726d 616e 6365 5f72  ef performance_r
-00044920: 6570 6f72 7428 0a20 2020 2020 2020 2073  eport(.        s
-00044930: 656c 662c 2073 7461 7274 3a20 666c 6f61  elf, start: floa
-00044940: 742c 206c 6173 745f 636f 756e 743a 2069  t, last_count: i
-00044950: 6e74 2c20 636f 6465 3a20 7374 7220 3d20  nt, code: str = 
-00044960: 2222 2c20 6d6f 6465 3a20 7374 7220 7c20  "", mode: str | 
-00044970: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-00044980: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00044990: 2020 7374 6f70 203d 2074 696d 6528 290a    stop = time().
-000449a0: 2020 2020 2020 2020 2320 5072 6f66 696c          # Profil
-000449b0: 6573 0a20 2020 2020 2020 2063 6f6d 7075  es.        compu
-000449c0: 7465 2c20 7363 6865 6475 6c65 722c 2077  te, scheduler, w
-000449d0: 6f72 6b65 7273 203d 2061 7761 6974 2061  orkers = await a
-000449e0: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-000449f0: 2020 2020 2020 2020 2020 202a 5b0a 2020             *[.  
-00044a00: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00044a10: 6c66 2e67 6574 5f70 726f 6669 6c65 2873  lf.get_profile(s
-00044a20: 7461 7274 3d73 7461 7274 292c 0a20 2020  tart=start),.   
-00044a30: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00044a40: 662e 6765 745f 7072 6f66 696c 6528 7363  f.get_profile(sc
-00044a50: 6865 6475 6c65 723d 5472 7565 2c20 7374  heduler=True, st
-00044a60: 6172 743d 7374 6172 7429 2c0a 2020 2020  art=start),.    
-00044a70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00044a80: 2e67 6574 5f70 726f 6669 6c65 2873 6572  .get_profile(ser
-00044a90: 7665 723d 5472 7565 2c20 7374 6172 743d  ver=True, start=
-00044aa0: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
-00044ab0: 2020 2020 5d0a 2020 2020 2020 2020 290a      ].        ).
-00044ac0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00044ad0: 7472 6962 7574 6564 2069 6d70 6f72 7420  tributed import 
-00044ae0: 7072 6f66 696c 650a 0a20 2020 2020 2020  profile..       
-00044af0: 2064 6566 2070 726f 6669 6c65 5f74 6f5f   def profile_to_
-00044b00: 6669 6775 7265 2873 7461 7465 293a 0a20  figure(state):. 
-00044b10: 2020 2020 2020 2020 2020 2064 6174 6120             data 
-00044b20: 3d20 7072 6f66 696c 652e 706c 6f74 5f64  = profile.plot_d
-00044b30: 6174 6128 7374 6174 6529 0a20 2020 2020  ata(state).     
-00044b40: 2020 2020 2020 2066 6967 7572 652c 2073         figure, s
-00044b50: 6f75 7263 6520 3d20 7072 6f66 696c 652e  ource = profile.
-00044b60: 706c 6f74 5f66 6967 7572 6528 6461 7461  plot_figure(data
-00044b70: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00044b80: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
-00044b90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00044ba0: 2066 6967 7572 650a 0a20 2020 2020 2020   figure..       
-00044bb0: 2063 6f6d 7075 7465 2c20 7363 6865 6475   compute, schedu
-00044bc0: 6c65 722c 2077 6f72 6b65 7273 203d 206d  ler, workers = m
-00044bd0: 6170 280a 2020 2020 2020 2020 2020 2020  ap(.            
-00044be0: 7072 6f66 696c 655f 746f 5f66 6967 7572  profile_to_figur
-00044bf0: 652c 2028 636f 6d70 7574 652c 2073 6368  e, (compute, sch
-00044c00: 6564 756c 6572 2c20 776f 726b 6572 7329  eduler, workers)
-00044c10: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00044c20: 2020 2020 2320 5461 736b 2073 7472 6561      # Task strea
-00044c30: 6d0a 2020 2020 2020 2020 7461 736b 5f73  m.        task_s
-00044c40: 7472 6561 6d20 3d20 7365 6c66 2e67 6574  tream = self.get
-00044c50: 5f74 6173 6b5f 7374 7265 616d 2873 7461  _task_stream(sta
-00044c60: 7274 3d73 7461 7274 290a 2020 2020 2020  rt=start).      
-00044c70: 2020 746f 7461 6c5f 7461 736b 7320 3d20    total_tasks = 
-00044c80: 6c65 6e28 7461 736b 5f73 7472 6561 6d29  len(task_stream)
-00044c90: 0a20 2020 2020 2020 2074 696d 6573 7065  .        timespe
-00044ca0: 6e74 3a20 6465 6661 756c 7464 6963 745b  nt: defaultdict[
-00044cb0: 7374 722c 2066 6c6f 6174 5d20 3d20 6465  str, float] = de
-00044cc0: 6661 756c 7464 6963 7428 666c 6f61 7429  faultdict(float)
-00044cd0: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
-00044ce0: 6e20 7461 736b 5f73 7472 6561 6d3a 0a20  n task_stream:. 
-00044cf0: 2020 2020 2020 2020 2020 2066 6f72 2078             for x
-00044d00: 2069 6e20 645b 2273 7461 7274 7374 6f70   in d["startstop
-00044d10: 7322 5d3a 0a20 2020 2020 2020 2020 2020  s"]:.           
-00044d20: 2020 2020 2074 696d 6573 7065 6e74 5b78       timespent[x
-00044d30: 5b22 6163 7469 6f6e 225d 5d20 2b3d 2078  ["action"]] += x
-00044d40: 5b22 7374 6f70 225d 202d 2078 5b22 7374  ["stop"] - x["st
-00044d50: 6172 7422 5d0a 2020 2020 2020 2020 7461  art"].        ta
-00044d60: 736b 735f 7469 6d69 6e67 7320 3d20 2222  sks_timings = ""
-00044d70: 0a20 2020 2020 2020 2066 6f72 206b 2069  .        for k i
-00044d80: 6e20 736f 7274 6564 2874 696d 6573 7065  n sorted(timespe
-00044d90: 6e74 2e6b 6579 7328 2929 3a0a 2020 2020  nt.keys()):.    
-00044da0: 2020 2020 2020 2020 7461 736b 735f 7469          tasks_ti
-00044db0: 6d69 6e67 7320 2b3d 2066 225c 6e3c 6c69  mings += f"\n<li
-00044dc0: 3e20 7b6b 7d20 7469 6d65 3a20 7b66 6f72  > {k} time: {for
-00044dd0: 6d61 745f 7469 6d65 2874 696d 6573 7065  mat_time(timespe
-00044de0: 6e74 5b6b 5d29 7d20 3c2f 6c69 3e22 0a0a  nt[k])} </li>"..
-00044df0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00044e00: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
-00044e10: 7264 2e63 6f6d 706f 6e65 6e74 732e 7363  rd.components.sc
-00044e20: 6865 6475 6c65 7220 696d 706f 7274 2074  heduler import t
-00044e30: 6173 6b5f 7374 7265 616d 5f66 6967 7572  ask_stream_figur
-00044e40: 650a 2020 2020 2020 2020 6672 6f6d 2064  e.        from d
-00044e50: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
-00044e60: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
-00044e70: 616d 2069 6d70 6f72 7420 7265 6374 616e  am import rectan
-00044e80: 676c 6573 0a0a 2020 2020 2020 2020 7265  gles..        re
-00044e90: 6374 7320 3d20 7265 6374 616e 676c 6573  cts = rectangles
-00044ea0: 2874 6173 6b5f 7374 7265 616d 290a 2020  (task_stream).  
-00044eb0: 2020 2020 2020 736f 7572 6365 2c20 7461        source, ta
-00044ec0: 736b 5f73 7472 6561 6d20 3d20 7461 736b  sk_stream = task
-00044ed0: 5f73 7472 6561 6d5f 6669 6775 7265 2873  _stream_figure(s
-00044ee0: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00044ef0: 7463 685f 626f 7468 2229 0a20 2020 2020  tch_both").     
-00044f00: 2020 2073 6f75 7263 652e 6461 7461 2e75     source.data.u
-00044f10: 7064 6174 6528 7265 6374 7329 0a0a 2020  pdate(rects)..  
-00044f20: 2020 2020 2020 2320 4261 6e64 7769 6474        # Bandwidt
-00044f30: 680a 2020 2020 2020 2020 6672 6f6d 2064  h.        from d
-00044f40: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-00044f50: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
-00044f60: 7363 6865 6475 6c65 7220 696d 706f 7274  scheduler import
-00044f70: 2028 0a20 2020 2020 2020 2020 2020 2042   (.            B
-00044f80: 616e 6477 6964 7468 5479 7065 732c 0a20  andwidthTypes,. 
-00044f90: 2020 2020 2020 2020 2020 2042 616e 6477             Bandw
-00044fa0: 6964 7468 576f 726b 6572 732c 0a20 2020  idthWorkers,.   
-00044fb0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00044fc0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
-00044fd0: 7320 3d20 4261 6e64 7769 6474 6857 6f72  s = BandwidthWor
-00044fe0: 6b65 7273 2873 656c 662c 2073 697a 696e  kers(self, sizin
-00044ff0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00045000: 626f 7468 2229 0a20 2020 2020 2020 2062  both").        b
-00045010: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
-00045020: 2e75 7064 6174 6528 290a 2020 2020 2020  .update().      
-00045030: 2020 6261 6e64 7769 6474 685f 7479 7065    bandwidth_type
-00045040: 7320 3d20 4261 6e64 7769 6474 6854 7970  s = BandwidthTyp
-00045050: 6573 2873 656c 662c 2073 697a 696e 675f  es(self, sizing_
-00045060: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00045070: 7468 2229 0a20 2020 2020 2020 2062 616e  th").        ban
-00045080: 6477 6964 7468 5f74 7970 6573 2e75 7064  dwidth_types.upd
-00045090: 6174 6528 290a 0a20 2020 2020 2020 2023  ate()..        #
-000450a0: 2053 7973 7465 6d20 6d6f 6e69 746f 720a   System monitor.
-000450b0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-000450c0: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
-000450d0: 7264 2e63 6f6d 706f 6e65 6e74 732e 7368  rd.components.sh
-000450e0: 6172 6564 2069 6d70 6f72 7420 5379 7374  ared import Syst
-000450f0: 656d 4d6f 6e69 746f 720a 0a20 2020 2020  emMonitor..     
-00045100: 2020 2073 7973 6d6f 6e20 3d20 5379 7374     sysmon = Syst
-00045110: 656d 4d6f 6e69 746f 7228 7365 6c66 2c20  emMonitor(self, 
-00045120: 6c61 7374 5f63 6f75 6e74 3d6c 6173 745f  last_count=last_
-00045130: 636f 756e 742c 2073 697a 696e 675f 6d6f  count, sizing_mo
-00045140: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-00045150: 2229 0a20 2020 2020 2020 2073 7973 6d6f  ").        sysmo
-00045160: 6e2e 7570 6461 7465 2829 0a0a 2020 2020  n.update()..    
-00045170: 2020 2020 2320 5363 6865 6475 6c65 7220      # Scheduler 
-00045180: 6c6f 6773 0a20 2020 2020 2020 2066 726f  logs.        fro
-00045190: 6d20 6469 7374 7269 6275 7465 642e 6461  m distributed.da
-000451a0: 7368 626f 6172 642e 636f 6d70 6f6e 656e  shboard.componen
-000451b0: 7473 2e73 6368 6564 756c 6572 2069 6d70  ts.scheduler imp
-000451c0: 6f72 7420 280a 2020 2020 2020 2020 2020  ort (.          
-000451d0: 2020 5f42 4f4b 4548 5f53 5459 4c45 535f    _BOKEH_STYLES_
-000451e0: 4b57 4152 4753 2c0a 2020 2020 2020 2020  KWARGS,.        
-000451f0: 2020 2020 5363 6865 6475 6c65 724c 6f67      SchedulerLog
-00045200: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
-00045210: 2020 2020 2020 6c6f 6773 203d 2053 6368        logs = Sch
-00045220: 6564 756c 6572 4c6f 6773 2873 656c 662c  edulerLogs(self,
-00045230: 2073 7461 7274 3d73 7461 7274 290a 0a20   start=start).. 
-00045240: 2020 2020 2020 2066 726f 6d20 626f 6b65         from boke
-00045250: 682e 6d6f 6465 6c73 2069 6d70 6f72 7420  h.models import 
-00045260: 4469 762c 2054 6162 730a 0a20 2020 2020  Div, Tabs..     
-00045270: 2020 2069 6d70 6f72 7420 6469 7374 7269     import distri
-00045280: 6275 7465 640a 2020 2020 2020 2020 6672  buted.        fr
-00045290: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
-000452a0: 6173 6862 6f61 7264 2e63 6f72 6520 696d  ashboard.core im
-000452b0: 706f 7274 2054 6162 5061 6e65 6c0a 0a20  port TabPanel.. 
-000452c0: 2020 2020 2020 2023 2048 544d 4c0a 2020         # HTML.  
-000452d0: 2020 2020 2020 6874 6d6c 203d 2022 2222        html = """
-000452e0: 0a20 2020 2020 2020 203c 6831 3e20 4461  .        <h1> Da
-000452f0: 736b 2050 6572 666f 726d 616e 6365 2052  sk Performance R
-00045300: 6570 6f72 7420 3c2f 6831 3e0a 0a20 2020  eport </h1>..   
-00045310: 2020 2020 203c 693e 2053 656c 6563 7420       <i> Select 
-00045320: 6469 6666 6572 656e 7420 7461 6273 206f  different tabs o
-00045330: 6e20 7468 6520 746f 7020 666f 7220 6164  n the top for ad
-00045340: 6469 7469 6f6e 616c 2069 6e66 6f72 6d61  ditional informa
-00045350: 7469 6f6e 203c 2f69 3e0a 0a20 2020 2020  tion </i>..     
-00045360: 2020 203c 6832 3e20 4475 7261 7469 6f6e     <h2> Duration
-00045370: 3a20 7b74 696d 657d 203c 2f68 323e 0a20  : {time} </h2>. 
-00045380: 2020 2020 2020 203c 6832 3e20 5461 736b         <h2> Task
-00045390: 7320 496e 666f 726d 6174 696f 6e20 3c2f  s Information </
-000453a0: 6832 3e0a 2020 2020 2020 2020 3c75 6c3e  h2>.        <ul>
-000453b0: 0a20 2020 2020 2020 2020 3c6c 693e 206e  .         <li> n
-000453c0: 756d 6265 7220 6f66 2074 6173 6b73 3a20  umber of tasks: 
-000453d0: 7b6e 7461 736b 737d 203c 2f6c 693e 0a20  {ntasks} </li>. 
-000453e0: 2020 2020 2020 2020 7b74 6173 6b73 5f74          {tasks_t
-000453f0: 696d 696e 6773 7d0a 2020 2020 2020 2020  imings}.        
-00045400: 3c2f 756c 3e0a 0a20 2020 2020 2020 203c  </ul>..        <
-00045410: 6832 3e20 5363 6865 6475 6c65 7220 496e  h2> Scheduler In
-00045420: 666f 726d 6174 696f 6e20 3c2f 6832 3e0a  formation </h2>.
-00045430: 2020 2020 2020 2020 3c75 6c3e 0a20 2020          <ul>.   
-00045440: 2020 2020 2020 203c 6c69 3e20 4164 6472         <li> Addr
-00045450: 6573 733a 207b 6164 6472 6573 737d 203c  ess: {address} <
-00045460: 2f6c 693e 0a20 2020 2020 2020 2020 203c  /li>.          <
-00045470: 6c69 3e20 576f 726b 6572 733a 207b 6e77  li> Workers: {nw
-00045480: 6f72 6b65 7273 7d20 3c2f 6c69 3e0a 2020  orkers} </li>.  
-00045490: 2020 2020 2020 2020 3c6c 693e 2054 6872          <li> Thr
-000454a0: 6561 6473 3a20 7b74 6872 6561 6473 7d20  eads: {threads} 
-000454b0: 3c2f 6c69 3e0a 2020 2020 2020 2020 2020  </li>.          
-000454c0: 3c6c 693e 204d 656d 6f72 793a 207b 6d65  <li> Memory: {me
-000454d0: 6d6f 7279 7d20 3c2f 6c69 3e0a 2020 2020  mory} </li>.    
-000454e0: 2020 2020 2020 3c6c 693e 2044 6173 6b20        <li> Dask 
-000454f0: 5665 7273 696f 6e3a 207b 6461 736b 5f76  Version: {dask_v
-00045500: 6572 7369 6f6e 7d20 3c2f 6c69 3e0a 2020  ersion} </li>.  
-00045510: 2020 2020 2020 2020 3c6c 693e 2044 6173          <li> Das
-00045520: 6b2e 4469 7374 7269 6275 7465 6420 5665  k.Distributed Ve
-00045530: 7273 696f 6e3a 207b 6469 7374 7269 6275  rsion: {distribu
-00045540: 7465 645f 7665 7273 696f 6e7d 203c 2f6c  ted_version} </l
-00045550: 693e 0a20 2020 2020 2020 203c 2f75 6c3e  i>.        </ul>
-00045560: 0a0a 2020 2020 2020 2020 3c68 323e 2043  ..        <h2> C
-00045570: 616c 6c69 6e67 2043 6f64 6520 3c2f 6832  alling Code </h2
-00045580: 3e0a 2020 2020 2020 2020 3c70 7265 3e0a  >.        <pre>.
-00045590: 7b63 6f64 657d 0a20 2020 2020 2020 203c  {code}.        <
-000455a0: 2f70 7265 3e0a 2020 2020 2020 2020 2222  /pre>.        ""
-000455b0: 222e 666f 726d 6174 280a 2020 2020 2020  ".format(.      
-000455c0: 2020 2020 2020 7469 6d65 3d66 6f72 6d61        time=forma
-000455d0: 745f 7469 6d65 2873 746f 7020 2d20 7374  t_time(stop - st
-000455e0: 6172 7429 2c0a 2020 2020 2020 2020 2020  art),.          
-000455f0: 2020 6e74 6173 6b73 3d74 6f74 616c 5f74    ntasks=total_t
-00045600: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00045610: 2020 7461 736b 735f 7469 6d69 6e67 733d    tasks_timings=
-00045620: 7461 736b 735f 7469 6d69 6e67 732c 0a20  tasks_timings,. 
-00045630: 2020 2020 2020 2020 2020 2061 6464 7265             addre
-00045640: 7373 3d73 656c 662e 6164 6472 6573 732c  ss=self.address,
-00045650: 0a20 2020 2020 2020 2020 2020 206e 776f  .            nwo
-00045660: 726b 6572 733d 6c65 6e28 7365 6c66 2e77  rkers=len(self.w
-00045670: 6f72 6b65 7273 292c 0a20 2020 2020 2020  orkers),.       
-00045680: 2020 2020 2074 6872 6561 6473 3d73 756d       threads=sum
-00045690: 2877 732e 6e74 6872 6561 6473 2066 6f72  (ws.nthreads for
-000456a0: 2077 7320 696e 2073 656c 662e 776f 726b   ws in self.work
-000456b0: 6572 732e 7661 6c75 6573 2829 292c 0a20  ers.values()),. 
-000456c0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
-000456d0: 793d 666f 726d 6174 5f62 7974 6573 2873  y=format_bytes(s
-000456e0: 756d 2877 732e 6d65 6d6f 7279 5f6c 696d  um(ws.memory_lim
-000456f0: 6974 2066 6f72 2077 7320 696e 2073 656c  it for ws in sel
-00045700: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-00045710: 2829 2929 2c0a 2020 2020 2020 2020 2020  ())),.          
-00045720: 2020 636f 6465 3d63 6f64 652c 0a20 2020    code=code,.   
-00045730: 2020 2020 2020 2020 2064 6173 6b5f 7665           dask_ve
-00045740: 7273 696f 6e3d 6461 736b 2e5f 5f76 6572  rsion=dask.__ver
-00045750: 7369 6f6e 5f5f 2c0a 2020 2020 2020 2020  sion__,.        
-00045760: 2020 2020 6469 7374 7269 6275 7465 645f      distributed_
-00045770: 7665 7273 696f 6e3d 6469 7374 7269 6275  version=distribu
-00045780: 7465 642e 5f5f 7665 7273 696f 6e5f 5f2c  ted.__version__,
-00045790: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-000457a0: 2020 2068 746d 6c20 3d20 4469 7628 7465     html = Div(te
-000457b0: 7874 3d68 746d 6c2c 202a 2a5f 424f 4b45  xt=html, **_BOKE
-000457c0: 485f 5354 594c 4553 5f4b 5741 5247 5329  H_STYLES_KWARGS)
-000457d0: 0a0a 2020 2020 2020 2020 6874 6d6c 203d  ..        html =
-000457e0: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
-000457f0: 6874 6d6c 2c20 7469 746c 653d 2253 756d  html, title="Sum
-00045800: 6d61 7279 2229 0a20 2020 2020 2020 2063  mary").        c
-00045810: 6f6d 7075 7465 203d 2054 6162 5061 6e65  ompute = TabPane
-00045820: 6c28 6368 696c 643d 636f 6d70 7574 652c  l(child=compute,
-00045830: 2074 6974 6c65 3d22 576f 726b 6572 2050   title="Worker P
-00045840: 726f 6669 6c65 2028 636f 6d70 7574 6529  rofile (compute)
-00045850: 2229 0a20 2020 2020 2020 2077 6f72 6b65  ").        worke
-00045860: 7273 203d 2054 6162 5061 6e65 6c28 6368  rs = TabPanel(ch
-00045870: 696c 643d 776f 726b 6572 732c 2074 6974  ild=workers, tit
-00045880: 6c65 3d22 576f 726b 6572 2050 726f 6669  le="Worker Profi
-00045890: 6c65 2028 6164 6d69 6e69 7374 7261 7469  le (administrati
-000458a0: 7665 2922 290a 2020 2020 2020 2020 7363  ve)").        sc
-000458b0: 6865 6475 6c65 7220 3d20 5461 6250 616e  heduler = TabPan
-000458c0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-000458d0: 6368 696c 643d 7363 6865 6475 6c65 722c  child=scheduler,
-000458e0: 2074 6974 6c65 3d22 5363 6865 6475 6c65   title="Schedule
-000458f0: 7220 5072 6f66 696c 6520 2861 646d 696e  r Profile (admin
-00045900: 6973 7472 6174 6976 6529 220a 2020 2020  istrative)".    
-00045910: 2020 2020 290a 2020 2020 2020 2020 7461      ).        ta
-00045920: 736b 5f73 7472 6561 6d20 3d20 5461 6250  sk_stream = TabP
-00045930: 616e 656c 2863 6869 6c64 3d74 6173 6b5f  anel(child=task_
-00045940: 7374 7265 616d 2c20 7469 746c 653d 2254  stream, title="T
-00045950: 6173 6b20 5374 7265 616d 2229 0a20 2020  ask Stream").   
-00045960: 2020 2020 2062 616e 6477 6964 7468 5f77       bandwidth_w
-00045970: 6f72 6b65 7273 203d 2054 6162 5061 6e65  orkers = TabPane
-00045980: 6c28 0a20 2020 2020 2020 2020 2020 2063  l(.            c
-00045990: 6869 6c64 3d62 616e 6477 6964 7468 5f77  hild=bandwidth_w
-000459a0: 6f72 6b65 7273 2e72 6f6f 742c 2074 6974  orkers.root, tit
-000459b0: 6c65 3d22 4261 6e64 7769 6474 6820 2857  le="Bandwidth (W
-000459c0: 6f72 6b65 7273 2922 0a20 2020 2020 2020  orkers)".       
-000459d0: 2029 0a20 2020 2020 2020 2062 616e 6477   ).        bandw
-000459e0: 6964 7468 5f74 7970 6573 203d 2054 6162  idth_types = Tab
-000459f0: 5061 6e65 6c28 0a20 2020 2020 2020 2020  Panel(.         
-00045a00: 2020 2063 6869 6c64 3d62 616e 6477 6964     child=bandwid
-00045a10: 7468 5f74 7970 6573 2e72 6f6f 742c 2074  th_types.root, t
-00045a20: 6974 6c65 3d22 4261 6e64 7769 6474 6820  itle="Bandwidth 
-00045a30: 2854 7970 6573 2922 0a20 2020 2020 2020  (Types)".       
-00045a40: 2029 0a20 2020 2020 2020 2073 7973 7465   ).        syste
-00045a50: 6d20 3d20 5461 6250 616e 656c 2863 6869  m = TabPanel(chi
-00045a60: 6c64 3d73 7973 6d6f 6e2e 726f 6f74 2c20  ld=sysmon.root, 
-00045a70: 7469 746c 653d 2253 7973 7465 6d22 290a  title="System").
-00045a80: 2020 2020 2020 2020 6c6f 6773 203d 2054          logs = T
-00045a90: 6162 5061 6e65 6c28 6368 696c 643d 6c6f  abPanel(child=lo
-00045aa0: 6773 2e72 6f6f 742c 2074 6974 6c65 3d22  gs.root, title="
-00045ab0: 5363 6865 6475 6c65 7220 4c6f 6773 2229  Scheduler Logs")
-00045ac0: 0a0a 2020 2020 2020 2020 7461 6273 203d  ..        tabs =
-00045ad0: 2054 6162 7328 0a20 2020 2020 2020 2020   Tabs(.         
-00045ae0: 2020 2074 6162 733d 5b0a 2020 2020 2020     tabs=[.      
-00045af0: 2020 2020 2020 2020 2020 6874 6d6c 2c0a            html,.
-00045b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045b10: 7461 736b 5f73 7472 6561 6d2c 0a20 2020  task_stream,.   
-00045b20: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-00045b30: 7465 6d2c 0a20 2020 2020 2020 2020 2020  tem,.           
-00045b40: 2020 2020 206c 6f67 732c 0a20 2020 2020       logs,.     
-00045b50: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
-00045b60: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
-00045b70: 2020 2020 776f 726b 6572 732c 0a20 2020      workers,.   
-00045b80: 2020 2020 2020 2020 2020 2020 2073 6368               sch
-00045b90: 6564 756c 6572 2c0a 2020 2020 2020 2020  eduler,.        
-00045ba0: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
-00045bb0: 685f 776f 726b 6572 732c 0a20 2020 2020  h_workers,.     
-00045bc0: 2020 2020 2020 2020 2020 2062 616e 6477             bandw
-00045bd0: 6964 7468 5f74 7970 6573 2c0a 2020 2020  idth_types,.    
-00045be0: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-00045bf0: 2020 2020 2020 2073 697a 696e 675f 6d6f         sizing_mo
-00045c00: 6465 3d22 7374 7265 7463 685f 626f 7468  de="stretch_both
-00045c10: 222c 0a20 2020 2020 2020 2029 0a0a 2020  ",.        )..  
-00045c20: 2020 2020 2020 6672 6f6d 2062 6f6b 6568        from bokeh
-00045c30: 2e63 6f72 652e 7465 6d70 6c61 7465 7320  .core.templates 
-00045c40: 696d 706f 7274 2067 6574 5f65 6e76 0a20  import get_env. 
-00045c50: 2020 2020 2020 2066 726f 6d20 626f 6b65         from boke
-00045c60: 682e 706c 6f74 7469 6e67 2069 6d70 6f72  h.plotting impor
-00045c70: 7420 6f75 7470 7574 5f66 696c 652c 2073  t output_file, s
-00045c80: 6176 650a 0a20 2020 2020 2020 2077 6974  ave..        wit
-00045c90: 6820 746d 7066 696c 6528 6578 7465 6e73  h tmpfile(extens
-00045ca0: 696f 6e3d 222e 6874 6d6c 2229 2061 7320  ion=".html") as 
-00045cb0: 666e 3a0a 2020 2020 2020 2020 2020 2020  fn:.            
-00045cc0: 6f75 7470 7574 5f66 696c 6528 6669 6c65  output_file(file
-00045cd0: 6e61 6d65 3d66 6e2c 2074 6974 6c65 3d22  name=fn, title="
-00045ce0: 4461 736b 2050 6572 666f 726d 616e 6365  Dask Performance
-00045cf0: 2052 6570 6f72 7422 2c20 6d6f 6465 3d6d   Report", mode=m
-00045d00: 6f64 6529 0a20 2020 2020 2020 2020 2020  ode).           
-00045d10: 2074 656d 706c 6174 655f 6469 7265 6374   template_direct
-00045d20: 6f72 7920 3d20 6f73 2e70 6174 682e 6a6f  ory = os.path.jo
-00045d30: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-00045d40: 2020 2020 6f73 2e70 6174 682e 6469 726e      os.path.dirn
-00045d50: 616d 6528 6f73 2e70 6174 682e 6162 7370  ame(os.path.absp
-00045d60: 6174 6828 5f5f 6669 6c65 5f5f 2929 2c20  ath(__file__)), 
-00045d70: 2264 6173 6862 6f61 7264 222c 2022 7465  "dashboard", "te
-00045d80: 6d70 6c61 7465 7322 0a20 2020 2020 2020  mplates".       
-00045d90: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00045da0: 2020 2074 656d 706c 6174 655f 656e 7669     template_envi
-00045db0: 726f 6e6d 656e 7420 3d20 6765 745f 656e  ronment = get_en
-00045dc0: 7628 290a 2020 2020 2020 2020 2020 2020  v().            
-00045dd0: 7465 6d70 6c61 7465 5f65 6e76 6972 6f6e  template_environ
-00045de0: 6d65 6e74 2e6c 6f61 6465 722e 7365 6172  ment.loader.sear
-00045df0: 6368 7061 7468 2e61 7070 656e 6428 7465  chpath.append(te
-00045e00: 6d70 6c61 7465 5f64 6972 6563 746f 7279  mplate_directory
-00045e10: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
-00045e20: 6d70 6c61 7465 203d 2074 656d 706c 6174  mplate = templat
-00045e30: 655f 656e 7669 726f 6e6d 656e 742e 6765  e_environment.ge
-00045e40: 745f 7465 6d70 6c61 7465 2822 7065 7266  t_template("perf
-00045e50: 6f72 6d61 6e63 655f 7265 706f 7274 2e68  ormance_report.h
-00045e60: 746d 6c22 290a 2020 2020 2020 2020 2020  tml").          
-00045e70: 2020 7361 7665 2874 6162 732c 2066 696c    save(tabs, fil
-00045e80: 656e 616d 653d 666e 2c20 7465 6d70 6c61  ename=fn, templa
-00045e90: 7465 3d74 656d 706c 6174 6529 0a0a 2020  te=template)..  
-00045ea0: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-00045eb0: 7065 6e28 666e 2920 6173 2066 3a0a 2020  pen(fn) as f:.  
-00045ec0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00045ed0: 7461 203d 2066 2e72 6561 6428 290a 0a20  ta = f.read().. 
-00045ee0: 2020 2020 2020 2072 6574 7572 6e20 6461         return da
-00045ef0: 7461 0a0a 2020 2020 6173 796e 6320 6465  ta..    async de
-00045f00: 6620 6765 745f 776f 726b 6572 5f6c 6f67  f get_worker_log
-00045f10: 7328 7365 6c66 2c20 6e3d 4e6f 6e65 2c20  s(self, n=None, 
-00045f20: 776f 726b 6572 733d 4e6f 6e65 2c20 6e61  workers=None, na
-00045f30: 6e6e 793d 4661 6c73 6529 3a0a 2020 2020  nny=False):.    
-00045f40: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
-00045f50: 6169 7420 7365 6c66 2e62 726f 6164 6361  ait self.broadca
-00045f60: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
-00045f70: 6d73 673d 7b22 6f70 223a 2022 6765 745f  msg={"op": "get_
-00045f80: 6c6f 6773 222c 2022 6e22 3a20 6e7d 2c20  logs", "n": n}, 
-00045f90: 776f 726b 6572 733d 776f 726b 6572 732c  workers=workers,
-00045fa0: 206e 616e 6e79 3d6e 616e 6e79 0a20 2020   nanny=nanny.   
-00045fb0: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
-00045fc0: 6574 7572 6e20 7265 7375 6c74 730a 0a20  eturn results.. 
-00045fd0: 2020 2064 6566 206c 6f67 5f65 7665 6e74     def log_event
-00045fe0: 2873 656c 662c 2074 6f70 6963 3a20 7374  (self, topic: st
-00045ff0: 7220 7c20 436f 6c6c 6563 7469 6f6e 5b73  r | Collection[s
-00046000: 7472 5d2c 206d 7367 3a20 416e 7929 202d  tr], msg: Any) -
-00046010: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00046020: 2222 224c 6f67 2061 6e20 6576 656e 7420  """Log an event 
-00046030: 756e 6465 7220 6120 6769 7665 6e20 746f  under a given to
-00046040: 7069 630a 0a20 2020 2020 2020 2050 6172  pic..        Par
-00046050: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-00046060: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-00046070: 2020 2074 6f70 6963 203a 2073 7472 2c20     topic : str, 
-00046080: 6c69 7374 5b73 7472 5d0a 2020 2020 2020  list[str].      
-00046090: 2020 2020 2020 4e61 6d65 206f 6620 7468        Name of th
-000460a0: 6520 746f 7069 6320 756e 6465 7220 7768  e topic under wh
-000460b0: 6963 6820 746f 206c 6f67 2061 6e20 6576  ich to log an ev
-000460c0: 656e 742e 2054 6f20 6c6f 6720 7468 6520  ent. To log the 
-000460d0: 7361 6d65 0a20 2020 2020 2020 2020 2020  same.           
-000460e0: 2065 7665 6e74 2075 6e64 6572 206d 756c   event under mul
-000460f0: 7469 706c 6520 746f 7069 6373 2c20 7061  tiple topics, pa
-00046100: 7373 2061 206c 6973 7420 6f66 2074 6f70  ss a list of top
-00046110: 6963 206e 616d 6573 2e0a 2020 2020 2020  ic names..      
-00046120: 2020 6d73 670a 2020 2020 2020 2020 2020    msg.          
-00046130: 2020 4576 656e 7420 6d65 7373 6167 6520    Event message 
-00046140: 746f 206c 6f67 2e20 4e6f 7465 2074 6869  to log. Note thi
-00046150: 7320 6d75 7374 2062 6520 6d73 6770 6163  s must be msgpac
-00046160: 6b20 7365 7269 616c 697a 6162 6c65 2e0a  k serializable..
-00046170: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-00046180: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-00046190: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
-000461a0: 742e 6c6f 675f 6576 656e 740a 2020 2020  t.log_event.    
-000461b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000461c0: 6576 656e 7420 3d20 2874 696d 6528 292c  event = (time(),
-000461d0: 206d 7367 290a 2020 2020 2020 2020 6966   msg).        if
-000461e0: 206e 6f74 2069 7369 6e73 7461 6e63 6528   not isinstance(
-000461f0: 746f 7069 632c 2073 7472 293a 0a20 2020  topic, str):.   
-00046200: 2020 2020 2020 2020 2066 6f72 2074 2069           for t i
-00046210: 6e20 746f 7069 633a 0a20 2020 2020 2020  n topic:.       
-00046220: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-00046230: 656e 7473 5b74 5d2e 6170 7065 6e64 2865  ents[t].append(e
-00046240: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
-00046250: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-00046260: 5f63 6f75 6e74 735b 745d 202b 3d20 310a  _counts[t] += 1.
-00046270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046280: 7365 6c66 2e5f 7265 706f 7274 5f65 7665  self._report_eve
-00046290: 6e74 2874 2c20 6576 656e 7429 0a20 2020  nt(t, event).   
-000462a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000462b0: 2020 2020 2020 2073 656c 662e 6576 656e         self.even
-000462c0: 7473 5b74 6f70 6963 5d2e 6170 7065 6e64  ts[topic].append
-000462d0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
-000462e0: 2020 2020 7365 6c66 2e65 7665 6e74 5f63      self.event_c
-000462f0: 6f75 6e74 735b 746f 7069 635d 202b 3d20  ounts[topic] += 
-00046300: 310a 2020 2020 2020 2020 2020 2020 7365  1.            se
-00046310: 6c66 2e5f 7265 706f 7274 5f65 7665 6e74  lf._report_event
-00046320: 2874 6f70 6963 2c20 6576 656e 7429 0a0a  (topic, event)..
-00046330: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00046340: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-00046350: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-00046360: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-00046370: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00046380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046390: 706c 7567 696e 2e6c 6f67 5f65 7665 6e74  plugin.log_event
-000463a0: 2874 6f70 6963 2c20 6d73 6729 0a20 2020  (topic, msg).   
-000463b0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-000463c0: 6570 7420 4578 6365 7074 696f 6e3a 0a20  ept Exception:. 
-000463d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000463e0: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
-000463f0: 506c 7567 696e 2066 6169 6c65 6420 7769  Plugin failed wi
-00046400: 7468 2065 7863 6570 7469 6f6e 222c 2065  th exception", e
-00046410: 7863 5f69 6e66 6f3d 5472 7565 290a 0a20  xc_info=True).. 
-00046420: 2020 2064 6566 205f 7265 706f 7274 5f65     def _report_e
-00046430: 7665 6e74 2873 656c 662c 206e 616d 652c  vent(self, name,
-00046440: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
-00046450: 206d 7367 203d 207b 0a20 2020 2020 2020   msg = {.       
-00046460: 2020 2020 2022 6f70 223a 2022 6576 656e       "op": "even
-00046470: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00046480: 2274 6f70 6963 223a 206e 616d 652c 0a20  "topic": name,. 
-00046490: 2020 2020 2020 2020 2020 2022 6576 656e             "even
-000464a0: 7422 3a20 6576 656e 742c 0a20 2020 2020  t": event,.     
-000464b0: 2020 207d 0a20 2020 2020 2020 2063 6c69     }.        cli
-000464c0: 656e 745f 6d73 6773 203d 207b 636c 6965  ent_msgs = {clie
-000464d0: 6e74 3a20 5b6d 7367 5d20 666f 7220 636c  nt: [msg] for cl
-000464e0: 6965 6e74 2069 6e20 7365 6c66 2e65 7665  ient in self.eve
-000464f0: 6e74 5f73 7562 7363 7269 6265 725b 6e61  nt_subscriber[na
-00046500: 6d65 5d7d 0a20 2020 2020 2020 2073 656c  me]}.        sel
-00046510: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
-00046520: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-00046530: 7367 733d 7b7d 290a 0a20 2020 2064 6566  sgs={})..    def
-00046540: 2073 7562 7363 7269 6265 5f74 6f70 6963   subscribe_topic
-00046550: 2873 656c 662c 2074 6f70 6963 2c20 636c  (self, topic, cl
-00046560: 6965 6e74 293a 0a20 2020 2020 2020 2073  ient):.        s
-00046570: 656c 662e 6576 656e 745f 7375 6273 6372  elf.event_subscr
-00046580: 6962 6572 5b74 6f70 6963 5d2e 6164 6428  iber[topic].add(
-00046590: 636c 6965 6e74 290a 0a20 2020 2064 6566  client)..    def
-000465a0: 2075 6e73 7562 7363 7269 6265 5f74 6f70   unsubscribe_top
-000465b0: 6963 2873 656c 662c 2074 6f70 6963 2c20  ic(self, topic, 
-000465c0: 636c 6965 6e74 293a 0a20 2020 2020 2020  client):.       
-000465d0: 2073 656c 662e 6576 656e 745f 7375 6273   self.event_subs
-000465e0: 6372 6962 6572 5b74 6f70 6963 5d2e 6469  criber[topic].di
-000465f0: 7363 6172 6428 636c 6965 6e74 290a 0a20  scard(client).. 
-00046600: 2020 2064 6566 2067 6574 5f65 7665 6e74     def get_event
-00046610: 7328 7365 6c66 2c20 746f 7069 633d 4e6f  s(self, topic=No
-00046620: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-00046630: 746f 7069 6320 6973 206e 6f74 204e 6f6e  topic is not Non
-00046640: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00046650: 6574 7572 6e20 7475 706c 6528 7365 6c66  eturn tuple(self
-00046660: 2e65 7665 6e74 735b 746f 7069 635d 290a  .events[topic]).
-00046670: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00046680: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00046690: 2076 616c 6d61 7028 7475 706c 652c 2073   valmap(tuple, s
-000466a0: 656c 662e 6576 656e 7473 290a 0a20 2020  elf.events)..   
-000466b0: 2061 7379 6e63 2064 6566 2067 6574 5f77   async def get_w
-000466c0: 6f72 6b65 725f 6d6f 6e69 746f 725f 696e  orker_monitor_in
-000466d0: 666f 2873 656c 662c 2072 6563 656e 743d  fo(self, recent=
-000466e0: 4661 6c73 652c 2073 7461 7274 733d 4e6f  False, starts=No
-000466f0: 6e65 293a 0a20 2020 2020 2020 2069 6620  ne):.        if 
-00046700: 7374 6172 7473 2069 7320 4e6f 6e65 3a0a  starts is None:.
-00046710: 2020 2020 2020 2020 2020 2020 7374 6172              star
-00046720: 7473 203d 207b 7d0a 2020 2020 2020 2020  ts = {}.        
-00046730: 7265 7375 6c74 7320 3d20 6177 6169 7420  results = await 
-00046740: 6173 796e 6369 6f2e 6761 7468 6572 280a  asyncio.gather(.
-00046750: 2020 2020 2020 2020 2020 2020 2a28 0a20              *(. 
-00046760: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00046770: 656c 662e 7270 6328 7729 2e67 6574 5f6d  elf.rpc(w).get_m
-00046780: 6f6e 6974 6f72 5f69 6e66 6f28 7265 6365  onitor_info(rece
-00046790: 6e74 3d72 6563 656e 742c 2073 7461 7274  nt=recent, start
-000467a0: 3d73 7461 7274 732e 6765 7428 772c 2030  =starts.get(w, 0
-000467b0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000467c0: 2020 2066 6f72 2077 2069 6e20 7365 6c66     for w in self
-000467d0: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
-000467e0: 2020 2020 2029 0a20 2020 2020 2020 2029       ).        )
-000467f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00046800: 6469 6374 287a 6970 2873 656c 662e 776f  dict(zip(self.wo
-00046810: 726b 6572 732c 2072 6573 756c 7473 2929  rkers, results))
-00046820: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
-00046830: 230a 2020 2020 2320 436c 6561 6e75 7020  #.    # Cleanup 
-00046840: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
-00046850: 230a 0a20 2020 2061 7379 6e63 2064 6566  #..    async def
-00046860: 2063 6865 636b 5f77 6f72 6b65 725f 7474   check_worker_tt
-00046870: 6c28 7365 6c66 293a 0a20 2020 2020 2020  l(self):.       
-00046880: 206e 6f77 203d 2074 696d 6528 290a 2020   now = time().  
-00046890: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
-000468a0: 6420 3d20 6622 6368 6563 6b2d 776f 726b  d = f"check-work
-000468b0: 6572 2d74 746c 2d7b 6e6f 777d 220a 2020  er-ttl-{now}".  
-000468c0: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-000468d0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-000468e0: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
-000468f0: 2020 2069 6620 2877 732e 6c61 7374 5f73     if (ws.last_s
-00046900: 6565 6e20 3c20 6e6f 7720 2d20 7365 6c66  een < now - self
-00046910: 2e77 6f72 6b65 725f 7474 6c29 2061 6e64  .worker_ttl) and
-00046920: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00046930: 2020 2077 732e 6c61 7374 5f73 6565 6e20     ws.last_seen 
-00046940: 3c20 6e6f 7720 2d20 3130 202a 2068 6561  < now - 10 * hea
-00046950: 7274 6265 6174 5f69 6e74 6572 7661 6c28  rtbeat_interval(
-00046960: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-00046970: 2929 0a20 2020 2020 2020 2020 2020 2029  )).            )
-00046980: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00046990: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
-000469a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000469b0: 2020 2020 2020 2257 6f72 6b65 7220 6661        "Worker fa
-000469c0: 696c 6564 2074 6f20 6865 6172 7462 6561  iled to heartbea
-000469d0: 7420 7769 7468 696e 2025 7320 7365 636f  t within %s seco
-000469e0: 6e64 732e 2043 6c6f 7369 6e67 3a20 2573  nds. Closing: %s
-000469f0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00046a00: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-00046a10: 6572 5f74 746c 2c0a 2020 2020 2020 2020  er_ttl,.        
-00046a20: 2020 2020 2020 2020 2020 2020 7773 2c0a              ws,.
-00046a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046a40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00046a50: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
-00046a60: 6f76 655f 776f 726b 6572 2861 6464 7265  ove_worker(addre
-00046a70: 7373 3d77 732e 6164 6472 6573 732c 2073  ss=ws.address, s
-00046a80: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
-00046a90: 6c75 735f 6964 290a 0a20 2020 2064 6566  lus_id)..    def
-00046aa0: 2063 6865 636b 5f69 646c 6528 7365 6c66   check_idle(self
-00046ab0: 2920 2d3e 2066 6c6f 6174 207c 204e 6f6e  ) -> float | Non
-00046ac0: 653a 0a20 2020 2020 2020 2069 6620 7365  e:.        if se
-00046ad0: 6c66 2e73 7461 7475 7320 696e 2028 5374  lf.status in (St
-00046ae0: 6174 7573 2e63 6c6f 7369 6e67 2c20 5374  atus.closing, St
-00046af0: 6174 7573 2e63 6c6f 7365 6429 3a0a 2020  atus.closed):.  
-00046b00: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00046b10: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
-00046b20: 6620 7365 6c66 2e74 7261 6e73 6974 696f  f self.transitio
-00046b30: 6e5f 636f 756e 7465 7220 213d 2073 656c  n_counter != sel
-00046b40: 662e 5f69 646c 655f 7472 616e 7369 7469  f._idle_transiti
-00046b50: 6f6e 5f63 6f75 6e74 6572 3a0a 2020 2020  on_counter:.    
-00046b60: 2020 2020 2020 2020 7365 6c66 2e5f 6964          self._id
-00046b70: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
-00046b80: 756e 7465 7220 3d20 7365 6c66 2e74 7261  unter = self.tra
-00046b90: 6e73 6974 696f 6e5f 636f 756e 7465 720a  nsition_counter.
-00046ba0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00046bb0: 2e69 646c 655f 7369 6e63 6520 3d20 4e6f  .idle_since = No
-00046bc0: 6e65 0a20 2020 2020 2020 2020 2020 2072  ne.            r
-00046bd0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00046be0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-00046bf0: 2020 2020 2073 656c 662e 7175 6575 6564       self.queued
-00046c00: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00046c10: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-00046c20: 2020 2020 2020 2020 2020 2020 6f72 2061              or a
-00046c30: 6e79 2877 732e 7072 6f63 6573 7369 6e67  ny(ws.processing
-00046c40: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00046c50: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-00046c60: 290a 2020 2020 2020 2020 293a 0a20 2020  ).        ):.   
-00046c70: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00046c80: 6c65 5f73 696e 6365 203d 204e 6f6e 650a  le_since = None.
-00046c90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00046ca0: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
-00046cb0: 2069 6620 6e6f 7420 7365 6c66 2e69 646c   if not self.idl
-00046cc0: 655f 7369 6e63 653a 0a20 2020 2020 2020  e_since:.       
-00046cd0: 2020 2020 2073 656c 662e 6964 6c65 5f73       self.idle_s
-00046ce0: 696e 6365 203d 2074 696d 6528 290a 2020  ince = time().  
-00046cf0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00046d00: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-00046d10: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00046d20: 662e 6a75 7079 7465 723a 0a20 2020 2020  f.jupyter:.     
-00046d30: 2020 2020 2020 206c 6173 745f 6163 7469         last_acti
-00046d40: 7669 7479 203d 2028 0a20 2020 2020 2020  vity = (.       
-00046d50: 2020 2020 2020 2020 2073 656c 662e 5f6a           self._j
-00046d60: 7570 7974 6572 5f73 6572 7665 725f 6170  upyter_server_ap
-00046d70: 706c 6963 6174 696f 6e2e 7765 625f 6170  plication.web_ap
-00046d80: 702e 6c61 7374 5f61 6374 6976 6974 7928  p.last_activity(
-00046d90: 292e 7469 6d65 7374 616d 7028 290a 2020  ).timestamp().  
-00046da0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00046db0: 2020 2020 2020 2020 6966 206c 6173 745f          if last_
-00046dc0: 6163 7469 7669 7479 203e 2073 656c 662e  activity > self.
-00046dd0: 6964 6c65 5f73 696e 6365 3a0a 2020 2020  idle_since:.    
-00046de0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00046df0: 2e69 646c 655f 7369 6e63 6520 3d20 6c61  .idle_since = la
-00046e00: 7374 5f61 6374 6976 6974 790a 2020 2020  st_activity.    
-00046e10: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00046e20: 726e 2073 656c 662e 6964 6c65 5f73 696e  rn self.idle_sin
-00046e30: 6365 0a0a 2020 2020 2020 2020 6966 2073  ce..        if s
-00046e40: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
-00046e50: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00046e60: 2074 696d 6528 2920 3e20 7365 6c66 2e69   time() > self.i
-00046e70: 646c 655f 7369 6e63 6520 2b20 7365 6c66  dle_since + self
-00046e80: 2e69 646c 655f 7469 6d65 6f75 743a 0a20  .idle_timeout:. 
-00046e90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00046ea0: 7373 6572 7420 7365 6c66 2e69 646c 655f  ssert self.idle_
-00046eb0: 7369 6e63 650a 2020 2020 2020 2020 2020  since.          
-00046ec0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-00046ed0: 6f28 0a20 2020 2020 2020 2020 2020 2020  o(.             
-00046ee0: 2020 2020 2020 2022 5363 6865 6475 6c65         "Schedule
-00046ef0: 7220 636c 6f73 696e 6720 6166 7465 7220  r closing after 
-00046f00: 6265 696e 6720 6964 6c65 2066 6f72 2025  being idle for %
-00046f10: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00046f20: 2020 2020 2020 2020 666f 726d 6174 5f74          format_t
-00046f30: 696d 6528 7365 6c66 2e69 646c 655f 7469  ime(self.idle_ti
-00046f40: 6d65 6f75 7429 2c0a 2020 2020 2020 2020  meout),.        
-00046f50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00046f60: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00046f70: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
-00046f80: 6e64 5f74 6173 6b73 2e63 616c 6c5f 736f  nd_tasks.call_so
-00046f90: 6f6e 2873 656c 662e 636c 6f73 6529 0a20  on(self.close). 
-00046fa0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00046fb0: 6c66 2e69 646c 655f 7369 6e63 650a 0a20  lf.idle_since.. 
-00046fc0: 2020 2064 6566 2061 6461 7074 6976 655f     def adaptive_
-00046fd0: 7461 7267 6574 2873 656c 662c 2074 6172  target(self, tar
-00046fe0: 6765 745f 6475 7261 7469 6f6e 3d4e 6f6e  get_duration=Non
-00046ff0: 6529 3a0a 2020 2020 2020 2020 2222 2244  e):.        """D
-00047000: 6573 6972 6564 206e 756d 6265 7220 6f66  esired number of
-00047010: 2077 6f72 6b65 7273 2062 6173 6564 206f   workers based o
-00047020: 6e20 7468 6520 6375 7272 656e 7420 776f  n the current wo
-00047030: 726b 6c6f 6164 0a0a 2020 2020 2020 2020  rkload..        
-00047040: 5468 6973 206c 6f6f 6b73 2061 7420 7468  This looks at th
-00047050: 6520 6375 7272 656e 7420 7275 6e6e 696e  e current runnin
-00047060: 6720 7461 736b 7320 616e 6420 6d65 6d6f  g tasks and memo
-00047070: 7279 2075 7365 2c20 616e 6420 7265 7475  ry use, and retu
-00047080: 726e 7320 610a 2020 2020 2020 2020 6e75  rns a.        nu
-00047090: 6d62 6572 206f 6620 6465 7369 7265 6420  mber of desired 
-000470a0: 776f 726b 6572 732e 2020 5468 6973 2069  workers.  This i
-000470b0: 7320 6f66 7465 6e20 7573 6564 2062 7920  s often used by 
-000470c0: 6164 6170 7469 7665 2073 6368 6564 756c  adaptive schedul
-000470d0: 696e 672e 0a0a 2020 2020 2020 2020 5061  ing...        Pa
-000470e0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-000470f0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-00047100: 2020 2020 7461 7267 6574 5f64 7572 6174      target_durat
-00047110: 696f 6e20 3a20 7374 720a 2020 2020 2020  ion : str.      
-00047120: 2020 2020 2020 4120 6465 7369 7265 6420        A desired 
-00047130: 6475 7261 7469 6f6e 206f 6620 7469 6d65  duration of time
-00047140: 2066 6f72 2063 6f6d 7075 7461 7469 6f6e   for computation
-00047150: 7320 746f 2074 616b 652e 2020 5468 6973  s to take.  This
-00047160: 2061 6666 6563 7473 0a20 2020 2020 2020   affects.       
-00047170: 2020 2020 2068 6f77 2072 6170 6964 6c79       how rapidly
-00047180: 2074 6865 2073 6368 6564 756c 6572 2077   the scheduler w
-00047190: 696c 6c20 6173 6b20 746f 2073 6361 6c65  ill ask to scale
-000471a0: 2e0a 0a20 2020 2020 2020 2053 6565 2041  ...        See A
-000471b0: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-000471c0: 2d2d 2d2d 0a20 2020 2020 2020 2064 6973  ----.        dis
-000471d0: 7472 6962 7574 6564 2e64 6570 6c6f 792e  tributed.deploy.
-000471e0: 4164 6170 7469 7665 0a20 2020 2020 2020  Adaptive.       
-000471f0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00047200: 7461 7267 6574 5f64 7572 6174 696f 6e20  target_duration 
-00047210: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00047220: 2020 2020 2074 6172 6765 745f 6475 7261       target_dura
-00047230: 7469 6f6e 203d 2064 6173 6b2e 636f 6e66  tion = dask.conf
-00047240: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
-00047250: 7465 642e 6164 6170 7469 7665 2e74 6172  ted.adaptive.tar
-00047260: 6765 742d 6475 7261 7469 6f6e 2229 0a20  get-duration"). 
-00047270: 2020 2020 2020 2074 6172 6765 745f 6475         target_du
-00047280: 7261 7469 6f6e 203d 2070 6172 7365 5f74  ration = parse_t
-00047290: 696d 6564 656c 7461 2874 6172 6765 745f  imedelta(target_
-000472a0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
-000472b0: 2020 2023 2043 5055 0a0a 2020 2020 2020     # CPU..      
-000472c0: 2020 2320 544f 444f 2063 6f6e 7369 6465    # TODO conside
-000472d0: 7220 616e 7920 7573 6572 2d73 7065 6369  r any user-speci
-000472e0: 6669 6564 2064 6566 6175 6c74 2074 6173  fied default tas
-000472f0: 6b20 6475 7261 7469 6f6e 7320 666f 7220  k durations for 
-00047300: 7175 6575 6564 2074 6173 6b73 0a20 2020  queued tasks.   
-00047310: 2020 2020 2071 7565 7565 645f 6f63 6375       queued_occu
-00047320: 7061 6e63 7920 3d20 6c65 6e28 7365 6c66  pancy = len(self
-00047330: 2e71 7565 7565 6429 202a 2073 656c 662e  .queued) * self.
-00047340: 554e 4b4e 4f57 4e5f 5441 534b 5f44 5552  UNKNOWN_TASK_DUR
-00047350: 4154 494f 4e0a 2020 2020 2020 2020 6370  ATION.        cp
-00047360: 7520 3d20 6d61 7468 2e63 6569 6c28 0a20  u = math.ceil(. 
-00047370: 2020 2020 2020 2020 2020 2028 7365 6c66             (self
-00047380: 2e74 6f74 616c 5f6f 6363 7570 616e 6379  .total_occupancy
-00047390: 202b 2071 7565 7565 645f 6f63 6375 7061   + queued_occupa
-000473a0: 6e63 7929 202f 2074 6172 6765 745f 6475  ncy) / target_du
-000473b0: 7261 7469 6f6e 0a20 2020 2020 2020 2029  ration.        )
-000473c0: 2020 2320 544f 444f 3a20 7468 7265 6164    # TODO: thread
-000473d0: 7320 7065 7220 776f 726b 6572 0a0a 2020  s per worker..  
-000473e0: 2020 2020 2020 2320 4176 6f69 6420 6120        # Avoid a 
-000473f0: 6665 7720 6c6f 6e67 2074 6173 6b73 2066  few long tasks f
-00047400: 726f 6d20 6173 6b69 6e67 2066 6f72 206d  rom asking for m
-00047410: 616e 7920 636f 7265 730a 2020 2020 2020  any cores.      
-00047420: 2020 7461 736b 735f 7265 6164 7920 3d20    tasks_ready = 
-00047430: 6c65 6e28 7365 6c66 2e71 7565 7565 6429  len(self.queued)
-00047440: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
-00047450: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-00047460: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-00047470: 2020 2020 2020 7461 736b 735f 7265 6164        tasks_read
-00047480: 7920 2b3d 206c 656e 2877 732e 7072 6f63  y += len(ws.proc
-00047490: 6573 7369 6e67 290a 0a20 2020 2020 2020  essing)..       
-000474a0: 2020 2020 2069 6620 7461 736b 735f 7265       if tasks_re
-000474b0: 6164 7920 3e20 6370 753a 0a20 2020 2020  ady > cpu:.     
-000474c0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-000474d0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000474e0: 2020 2020 2020 2020 2020 2063 7075 203d             cpu =
-000474f0: 206d 696e 2874 6173 6b73 5f72 6561 6479   min(tasks_ready
-00047500: 2c20 6370 7529 0a0a 2020 2020 2020 2020  , cpu)..        
-00047510: 6966 2028 7365 6c66 2e75 6e72 756e 6e61  if (self.unrunna
-00047520: 626c 6520 6f72 2073 656c 662e 7175 6575  ble or self.queu
-00047530: 6564 2920 616e 6420 6e6f 7420 7365 6c66  ed) and not self
-00047540: 2e77 6f72 6b65 7273 3a0a 2020 2020 2020  .workers:.      
-00047550: 2020 2020 2020 6370 7520 3d20 6d61 7828        cpu = max(
-00047560: 312c 2063 7075 290a 0a20 2020 2020 2020  1, cpu)..       
-00047570: 2023 2061 6464 206d 6f72 6520 776f 726b   # add more work
-00047580: 6572 7320 6966 206d 6f72 6520 7468 616e  ers if more than
-00047590: 2036 3025 206f 6620 6d65 6d6f 7279 2069   60% of memory i
-000475a0: 7320 7573 6564 0a20 2020 2020 2020 206c  s used.        l
-000475b0: 696d 6974 203d 2073 756d 2877 732e 6d65  imit = sum(ws.me
-000475c0: 6d6f 7279 5f6c 696d 6974 2066 6f72 2077  mory_limit for w
-000475d0: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-000475e0: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-000475f0: 2020 2020 7573 6564 203d 2073 756d 2877      used = sum(w
-00047600: 732e 6e62 7974 6573 2066 6f72 2077 7320  s.nbytes for ws 
-00047610: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
-00047620: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
-00047630: 2020 6d65 6d6f 7279 203d 2030 0a20 2020    memory = 0.   
-00047640: 2020 2020 2069 6620 7573 6564 203e 2030       if used > 0
-00047650: 2e36 202a 206c 696d 6974 2061 6e64 206c  .6 * limit and l
-00047660: 696d 6974 203e 2030 3a0a 2020 2020 2020  imit > 0:.      
-00047670: 2020 2020 2020 6d65 6d6f 7279 203d 2032        memory = 2
-00047680: 202a 206c 656e 2873 656c 662e 776f 726b   * len(self.work
-00047690: 6572 7329 0a0a 2020 2020 2020 2020 7461  ers)..        ta
-000476a0: 7267 6574 203d 206d 6178 286d 656d 6f72  rget = max(memor
-000476b0: 792c 2063 7075 290a 2020 2020 2020 2020  y, cpu).        
-000476c0: 6966 2074 6172 6765 7420 3e3d 206c 656e  if target >= len
-000476d0: 2873 656c 662e 776f 726b 6572 7329 3a0a  (self.workers):.
-000476e0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000476f0: 726e 2074 6172 6765 740a 2020 2020 2020  rn target.      
-00047700: 2020 656c 7365 3a20 2023 2053 6361 6c65    else:  # Scale
-00047710: 2064 6f77 6e3f 0a20 2020 2020 2020 2020   down?.         
-00047720: 2020 2074 6f5f 636c 6f73 6520 3d20 7365     to_close = se
-00047730: 6c66 2e77 6f72 6b65 7273 5f74 6f5f 636c  lf.workers_to_cl
-00047740: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
-00047750: 2020 7265 7475 726e 206c 656e 2873 656c    return len(sel
-00047760: 662e 776f 726b 6572 7329 202d 206c 656e  f.workers) - len
-00047770: 2874 6f5f 636c 6f73 6529 0a0a 2020 2020  (to_close)..    
-00047780: 6465 6620 7265 7175 6573 745f 6163 7175  def request_acqu
-00047790: 6972 655f 7265 706c 6963 6173 280a 2020  ire_replicas(.  
-000477a0: 2020 2020 2020 7365 6c66 2c20 6164 6472        self, addr
-000477b0: 3a20 7374 722c 206b 6579 733a 2049 7465  : str, keys: Ite
-000477c0: 7261 626c 655b 7374 725d 2c20 2a2c 2073  rable[str], *, s
-000477d0: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
-000477e0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-000477f0: 2020 2020 2020 2022 2222 4173 796e 6368         """Asynch
-00047800: 726f 6e6f 7573 6c79 2061 736b 2061 2077  ronously ask a w
-00047810: 6f72 6b65 7220 746f 2061 6371 7569 7265  orker to acquire
-00047820: 2061 2072 6570 6c69 6361 206f 6620 7468   a replica of th
-00047830: 6520 6c69 7374 6564 206b 6579 7320 6672  e listed keys fr
-00047840: 6f6d 0a20 2020 2020 2020 206f 7468 6572  om.        other
-00047850: 2077 6f72 6b65 7273 2e20 5468 6973 2069   workers. This i
-00047860: 7320 6120 6669 7265 2d61 6e64 2d66 6f72  s a fire-and-for
-00047870: 6765 7420 6f70 6572 6174 696f 6e20 7768  get operation wh
-00047880: 6963 6820 6f66 6665 7273 206e 6f20 6665  ich offers no fe
-00047890: 6564 6261 636b 2066 6f72 0a20 2020 2020  edback for.     
-000478a0: 2020 2073 7563 6365 7373 206f 7220 6661     success or fa
-000478b0: 696c 7572 652c 2061 6e64 2069 7320 696e  ilure, and is in
-000478c0: 7465 6e64 6564 2066 6f72 2068 6f75 7365  tended for house
-000478d0: 6b65 6570 696e 6720 616e 6420 6e6f 7420  keeping and not 
-000478e0: 666f 7220 636f 6d70 7574 6174 696f 6e2e  for computation.
-000478f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00047900: 2020 2020 2077 686f 5f68 6173 203d 207b       who_has = {
-00047910: 7d0a 2020 2020 2020 2020 6e62 7974 6573  }.        nbytes
-00047920: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
-00047930: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
-00047940: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00047950: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00047960: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00047970: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
-00047980: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
-00047990: 735b 6b65 795d 203d 205b 7773 2e61 6464  s[key] = [ws.add
-000479a0: 7265 7373 2066 6f72 2077 7320 696e 2074  ress for ws in t
-000479b0: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
-000479c0: 2020 2020 2020 206e 6279 7465 735b 6b65         nbytes[ke
-000479d0: 795d 203d 2074 732e 6e62 7974 6573 0a0a  y] = ts.nbytes..
-000479e0: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-000479f0: 6561 6d5f 636f 6d6d 735b 6164 6472 5d2e  eam_comms[addr].
-00047a00: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
-00047a10: 2020 7b0a 2020 2020 2020 2020 2020 2020    {.            
-00047a20: 2020 2020 226f 7022 3a20 2261 6371 7569      "op": "acqui
-00047a30: 7265 2d72 6570 6c69 6361 7322 2c0a 2020  re-replicas",.  
-00047a40: 2020 2020 2020 2020 2020 2020 2020 2277                "w
-00047a50: 686f 5f68 6173 223a 2077 686f 5f68 6173  ho_has": who_has
-00047a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00047a70: 2020 226e 6279 7465 7322 3a20 6e62 7974    "nbytes": nbyt
-00047a80: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00047a90: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-00047aa0: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-00047ab0: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-00047ac0: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00047ad0: 6620 7265 7175 6573 745f 7265 6d6f 7665  f request_remove
-00047ae0: 5f72 6570 6c69 6361 7328 0a20 2020 2020  _replicas(.     
-00047af0: 2020 2073 656c 662c 2061 6464 723a 2073     self, addr: s
-00047b00: 7472 2c20 6b65 7973 3a20 6c69 7374 5b73  tr, keys: list[s
-00047b10: 7472 5d2c 202a 2c20 7374 696d 756c 7573  tr], *, stimulus
-00047b20: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
-00047b30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00047b40: 2222 2241 7379 6e63 6872 6f6e 6f75 736c  """Asynchronousl
-00047b50: 7920 6173 6b20 6120 776f 726b 6572 2074  y ask a worker t
-00047b60: 6f20 6469 7363 6172 6420 6974 7320 7265  o discard its re
-00047b70: 706c 6963 6120 6f66 2074 6865 206c 6973  plica of the lis
-00047b80: 7465 6420 6b65 7973 2e0a 2020 2020 2020  ted keys..      
-00047b90: 2020 5468 6973 206d 7573 7420 6e65 7665    This must neve
-00047ba0: 7220 6265 2075 7365 6420 746f 2064 6573  r be used to des
-00047bb0: 7472 6f79 2074 6865 206c 6173 7420 7265  troy the last re
-00047bc0: 706c 6963 6120 6f66 2061 206b 6579 2e20  plica of a key. 
-00047bd0: 5468 6973 2069 7320 610a 2020 2020 2020  This is a.      
-00047be0: 2020 6669 7265 2d61 6e64 2d66 6f72 6765    fire-and-forge
-00047bf0: 7420 6f70 6572 6174 696f 6e2c 2069 6e74  t operation, int
-00047c00: 656e 6465 6420 666f 7220 686f 7573 656b  ended for housek
-00047c10: 6565 7069 6e67 2061 6e64 206e 6f74 2066  eeping and not f
-00047c20: 6f72 2063 6f6d 7075 7461 7469 6f6e 2e0a  or computation..
-00047c30: 0a20 2020 2020 2020 2054 6865 2072 6570  .        The rep
-00047c40: 6c69 6361 2064 6973 6170 7065 6172 7320  lica disappears 
-00047c50: 696d 6d65 6469 6174 656c 7920 6672 6f6d  immediately from
-00047c60: 2054 6173 6b53 7461 7465 2e77 686f 5f68   TaskState.who_h
-00047c70: 6173 206f 6e20 7468 6520 5363 6865 6475  as on the Schedu
-00047c80: 6c65 7220 7369 6465 3b0a 2020 2020 2020  ler side;.      
-00047c90: 2020 6966 2074 6865 2077 6f72 6b65 7220    if the worker 
-00047ca0: 7265 6675 7365 7320 746f 2064 656c 6574  refuses to delet
-00047cb0: 652c 2065 2e67 2e20 6265 6361 7573 6520  e, e.g. because 
-00047cc0: 7468 6520 7461 736b 2069 7320 6120 6465  the task is a de
-00047cd0: 7065 6e64 656e 6379 206f 660a 2020 2020  pendency of.    
-00047ce0: 2020 2020 616e 6f74 6865 7220 7461 736b      another task
-00047cf0: 2072 756e 6e69 6e67 206f 6e20 6974 2c20   running on it, 
-00047d00: 6974 2077 696c 6c20 2861 6c73 6f20 6173  it will (also as
-00047d10: 796e 6368 726f 6e6f 7573 6c79 2920 696e  ynchronously) in
-00047d20: 666f 726d 2074 6865 2073 6368 6564 756c  form the schedul
-00047d30: 6572 0a20 2020 2020 2020 2074 6f20 7265  er.        to re
-00047d40: 2d61 6464 2069 7473 656c 6620 746f 2077  -add itself to w
-00047d50: 686f 5f68 6173 2e20 4966 2074 6865 2077  ho_has. If the w
-00047d60: 6f72 6b65 7220 6167 7265 6573 2074 6f20  orker agrees to 
-00047d70: 6469 7363 6172 6420 7468 6520 7461 736b  discard the task
-00047d80: 2c20 7468 6572 6520 6973 0a20 2020 2020  , there is.     
-00047d90: 2020 206e 6f20 6665 6564 6261 636b 2e0a     no feedback..
-00047da0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00047db0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
-00047dc0: 726b 6572 735b 6164 6472 5d0a 0a20 2020  rkers[addr]..   
-00047dd0: 2020 2020 2023 2054 6865 2073 6368 6564       # The sched
-00047de0: 756c 6572 2069 6d6d 6564 6961 7465 6c79  uler immediately
-00047df0: 2066 6f72 6765 7473 2061 626f 7574 2074   forgets about t
-00047e00: 6865 2072 6570 6c69 6361 2061 6e64 2073  he replica and s
-00047e10: 7567 6765 7374 7320 7468 6520 776f 726b  uggests the work
-00047e20: 6572 2074 6f0a 2020 2020 2020 2020 2320  er to.        # 
-00047e30: 6472 6f70 2069 742e 2054 6865 2077 6f72  drop it. The wor
-00047e40: 6b65 7220 6d61 7920 7265 6675 7365 2c20  ker may refuse, 
-00047e50: 6174 2077 6869 6368 2070 6f69 6e74 2069  at which point i
-00047e60: 7420 7769 6c6c 2073 656e 6420 6261 636b  t will send back
-00047e70: 2061 6e20 6164 642d 6b65 7973 0a20 2020   an add-keys.   
-00047e80: 2020 2020 2023 206d 6573 7361 6765 2074       # message t
-00047e90: 6f20 7265 696e 7374 6174 6520 6974 2e0a  o reinstate it..
-00047ea0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00047eb0: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-00047ec0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00047ed0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-00047ee0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
-00047ef0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
-00047f00: 2020 2020 2020 2020 2320 446f 206e 6f74          # Do not
-00047f10: 2064 6573 7472 6f79 2074 6865 206c 6173   destroy the las
-00047f20: 7420 636f 7079 0a20 2020 2020 2020 2020  t copy.         
-00047f30: 2020 2020 2020 2061 7373 6572 7420 6c65         assert le
-00047f40: 6e28 7473 2e77 686f 5f68 6173 2920 3e20  n(ts.who_has) > 
-00047f50: 310a 2020 2020 2020 2020 2020 2020 7365  1.            se
-00047f60: 6c66 2e72 656d 6f76 655f 7265 706c 6963  lf.remove_replic
-00047f70: 6128 7473 2c20 7773 290a 0a20 2020 2020  a(ts, ws)..     
-00047f80: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
-00047f90: 6f6d 6d73 5b61 6464 725d 2e73 656e 6428  omms[addr].send(
-00047fa0: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
-00047fb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00047fc0: 6f70 223a 2022 7265 6d6f 7665 2d72 6570  op": "remove-rep
-00047fd0: 6c69 6361 7322 2c0a 2020 2020 2020 2020  licas",.        
-00047fe0: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-00047ff0: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-00048000: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-00048010: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-00048020: 2c0a 2020 2020 2020 2020 2020 2020 7d0a  ,.            }.
-00048030: 2020 2020 2020 2020 290a 0a0a 6465 6620          )...def 
-00048040: 5f74 6173 6b5f 746f 5f72 6570 6f72 745f  _task_to_report_
-00048050: 6d73 6728 7473 3a20 5461 736b 5374 6174  msg(ts: TaskStat
-00048060: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
-00048070: 416e 795d 207c 204e 6f6e 653a 0a20 2020  Any] | None:.   
-00048080: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
-00048090: 2266 6f72 676f 7474 656e 223a 0a20 2020  "forgotten":.   
-000480a0: 2020 2020 2072 6574 7572 6e20 7b22 6f70       return {"op
-000480b0: 223a 2022 6361 6e63 656c 6c65 642d 6b65  ": "cancelled-ke
-000480c0: 7973 222c 2022 6b65 7973 223a 205b 7473  ys", "keys": [ts
-000480d0: 2e6b 6579 5d7d 0a20 2020 2065 6c69 6620  .key]}.    elif 
-000480e0: 7473 2e73 7461 7465 203d 3d20 226d 656d  ts.state == "mem
-000480f0: 6f72 7922 3a0a 2020 2020 2020 2020 7265  ory":.        re
-00048100: 7475 726e 207b 226f 7022 3a20 226b 6579  turn {"op": "key
-00048110: 2d69 6e2d 6d65 6d6f 7279 222c 2022 6b65  -in-memory", "ke
-00048120: 7922 3a20 7473 2e6b 6579 7d0a 2020 2020  y": ts.key}.    
-00048130: 656c 6966 2074 732e 7374 6174 6520 3d3d  elif ts.state ==
-00048140: 2022 6572 7265 6422 3a0a 2020 2020 2020   "erred":.      
-00048150: 2020 6661 696c 696e 675f 7473 203d 2074    failing_ts = t
-00048160: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00048170: 650a 2020 2020 2020 2020 6173 7365 7274  e.        assert
-00048180: 2066 6169 6c69 6e67 5f74 730a 2020 2020   failing_ts.    
-00048190: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-000481a0: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
-000481b0: 7461 736b 2d65 7272 6564 222c 0a20 2020  task-erred",.   
-000481c0: 2020 2020 2020 2020 2022 6b65 7922 3a20           "key": 
-000481d0: 7473 2e6b 6579 2c0a 2020 2020 2020 2020  ts.key,.        
-000481e0: 2020 2020 2265 7863 6570 7469 6f6e 223a      "exception":
-000481f0: 2066 6169 6c69 6e67 5f74 732e 6578 6365   failing_ts.exce
-00048200: 7074 696f 6e2c 0a20 2020 2020 2020 2020  ption,.         
-00048210: 2020 2022 7472 6163 6562 6163 6b22 3a20     "traceback": 
-00048220: 6661 696c 696e 675f 7473 2e74 7261 6365  failing_ts.trace
-00048230: 6261 636b 2c0a 2020 2020 2020 2020 7d0a  back,.        }.
-00048240: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00048250: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-00048260: 6465 6620 5f74 6173 6b5f 746f 5f63 6c69  def _task_to_cli
-00048270: 656e 745f 6d73 6773 2874 733a 2054 6173  ent_msgs(ts: Tas
-00048280: 6b53 7461 7465 2920 2d3e 2064 6963 745b  kState) -> dict[
-00048290: 7374 722c 206c 6973 745b 6469 6374 5b73  str, list[dict[s
-000482a0: 7472 2c20 416e 795d 5d5d 3a0a 2020 2020  tr, Any]]]:.    
-000482b0: 6966 2074 732e 7768 6f5f 7761 6e74 733a  if ts.who_wants:
-000482c0: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
-000482d0: 6d73 6720 3d20 5f74 6173 6b5f 746f 5f72  msg = _task_to_r
-000482e0: 6570 6f72 745f 6d73 6728 7473 290a 2020  eport_msg(ts).  
-000482f0: 2020 2020 2020 6966 2072 6570 6f72 745f        if report_
-00048300: 6d73 6720 6973 206e 6f74 204e 6f6e 653a  msg is not None:
-00048310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00048320: 7572 6e20 7b63 732e 636c 6965 6e74 5f6b  urn {cs.client_k
-00048330: 6579 3a20 5b72 6570 6f72 745f 6d73 675d  ey: [report_msg]
-00048340: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
-00048350: 6f5f 7761 6e74 737d 0a20 2020 2072 6574  o_wants}.    ret
-00048360: 7572 6e20 7b7d 0a0a 0a64 6566 2064 6563  urn {}...def dec
-00048370: 6964 655f 776f 726b 6572 280a 2020 2020  ide_worker(.    
-00048380: 7473 3a20 5461 736b 5374 6174 652c 0a20  ts: TaskState,. 
-00048390: 2020 2061 6c6c 5f77 6f72 6b65 7273 3a20     all_workers: 
-000483a0: 4974 6572 6162 6c65 5b57 6f72 6b65 7253  Iterable[WorkerS
-000483b0: 7461 7465 5d2c 0a20 2020 2076 616c 6964  tate],.    valid
-000483c0: 5f77 6f72 6b65 7273 3a20 7365 745b 576f  _workers: set[Wo
-000483d0: 726b 6572 5374 6174 655d 207c 204e 6f6e  rkerState] | Non
-000483e0: 652c 0a20 2020 206f 626a 6563 7469 7665  e,.    objective
-000483f0: 3a20 4361 6c6c 6162 6c65 5b5b 576f 726b  : Callable[[Work
-00048400: 6572 5374 6174 655d 2c20 416e 795d 2c0a  erState], Any],.
-00048410: 2920 2d3e 2057 6f72 6b65 7253 7461 7465  ) -> WorkerState
-00048420: 207c 204e 6f6e 653a 0a20 2020 2022 2222   | None:.    """
-00048430: 0a20 2020 2044 6563 6964 6520 7768 6963  .    Decide whic
-00048440: 6820 776f 726b 6572 2073 686f 756c 6420  h worker should 
-00048450: 7461 6b65 2074 6173 6b20 2a74 732a 2e0a  take task *ts*..
-00048460: 0a20 2020 2057 6520 6368 6f6f 7365 2074  .    We choose t
-00048470: 6865 2077 6f72 6b65 7220 7468 6174 2068  he worker that h
-00048480: 6173 2074 6865 2064 6174 6120 6f6e 2077  as the data on w
-00048490: 6869 6368 202a 7473 2a20 6465 7065 6e64  hich *ts* depend
-000484a0: 732e 0a0a 2020 2020 4966 2073 6576 6572  s...    If sever
-000484b0: 616c 2077 6f72 6b65 7273 2068 6176 6520  al workers have 
-000484c0: 6465 7065 6e64 656e 6369 6573 2074 6865  dependencies the
-000484d0: 6e20 7765 2063 686f 6f73 6520 7468 6520  n we choose the 
-000484e0: 6c65 7373 2d62 7573 7920 776f 726b 6572  less-busy worker
-000484f0: 2e0a 0a20 2020 204f 7074 696f 6e61 6c6c  ...    Optionall
-00048500: 7920 7072 6f76 6964 6520 2a76 616c 6964  y provide *valid
-00048510: 5f77 6f72 6b65 7273 2a20 6f66 2077 6865  _workers* of whe
-00048520: 7265 206a 6f62 7320 6172 6520 616c 6c6f  re jobs are allo
-00048530: 7765 6420 746f 206f 6363 7572 0a20 2020  wed to occur.   
-00048540: 2028 6966 2061 6c6c 2077 6f72 6b65 7273   (if all workers
-00048550: 2061 7265 2061 6c6c 6f77 6564 2074 6f20   are allowed to 
-00048560: 7461 6b65 2074 6865 2074 6173 6b2c 2070  take the task, p
-00048570: 6173 7320 4e6f 6e65 2069 6e73 7465 6164  ass None instead
-00048580: 292e 0a0a 2020 2020 4966 2074 6865 2074  )...    If the t
-00048590: 6173 6b20 7265 7175 6972 6573 2064 6174  ask requires dat
-000485a0: 6120 636f 6d6d 756e 6963 6174 696f 6e20  a communication 
-000485b0: 6265 6361 7573 6520 6e6f 2065 6c69 6769  because no eligi
-000485c0: 626c 6520 776f 726b 6572 2068 6173 0a20  ble worker has. 
-000485d0: 2020 2061 6c6c 2074 6865 2064 6570 656e     all the depen
-000485e0: 6465 6e63 6965 7320 616c 7265 6164 792c  dencies already,
-000485f0: 2074 6865 6e20 7765 2063 686f 6f73 6520   then we choose 
-00048600: 746f 206d 696e 696d 697a 6520 7468 6520  to minimize the 
-00048610: 6e75 6d62 6572 0a20 2020 206f 6620 6279  number.    of by
-00048620: 7465 7320 7365 6e74 2062 6574 7765 656e  tes sent between
-00048630: 2077 6f72 6b65 7273 2e20 2054 6869 7320   workers.  This 
-00048640: 6973 2064 6574 6572 6d69 6e65 6420 6279  is determined by
-00048650: 2063 616c 6c69 6e67 2074 6865 0a20 2020   calling the.   
-00048660: 202a 6f62 6a65 6374 6976 652a 2066 756e   *objective* fun
-00048670: 6374 696f 6e2e 0a20 2020 2022 2222 0a20  ction..    """. 
-00048680: 2020 2061 7373 6572 7420 616c 6c28 6474     assert all(dt
-00048690: 732e 7768 6f5f 6861 7320 666f 7220 6474  s.who_has for dt
-000486a0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000486b0: 6369 6573 290a 2020 2020 6966 2074 732e  cies).    if ts.
-000486c0: 6163 746f 723a 0a20 2020 2020 2020 2063  actor:.        c
-000486d0: 616e 6469 6461 7465 7320 3d20 7365 7428  andidates = set(
-000486e0: 616c 6c5f 776f 726b 6572 7329 0a20 2020  all_workers).   
-000486f0: 2065 6c73 653a 0a20 2020 2020 2020 2063   else:.        c
-00048700: 616e 6469 6461 7465 7320 3d20 7b77 7773  andidates = {wws
-00048710: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
-00048720: 6570 656e 6465 6e63 6965 7320 666f 7220  ependencies for 
-00048730: 7777 7320 696e 2064 7473 2e77 686f 5f68  wws in dts.who_h
-00048740: 6173 7d0a 2020 2020 6966 2076 616c 6964  as}.    if valid
-00048750: 5f77 6f72 6b65 7273 2069 7320 4e6f 6e65  _workers is None
-00048760: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
-00048770: 2063 616e 6469 6461 7465 733a 0a20 2020   candidates:.   
-00048780: 2020 2020 2020 2020 2063 616e 6469 6461           candida
-00048790: 7465 7320 3d20 7365 7428 616c 6c5f 776f  tes = set(all_wo
-000487a0: 726b 6572 7329 0a20 2020 2065 6c73 653a  rkers).    else:
-000487b0: 0a20 2020 2020 2020 2063 616e 6469 6461  .        candida
-000487c0: 7465 7320 263d 2076 616c 6964 5f77 6f72  tes &= valid_wor
-000487d0: 6b65 7273 0a20 2020 2020 2020 2069 6620  kers.        if 
-000487e0: 6e6f 7420 6361 6e64 6964 6174 6573 3a0a  not candidates:.
-000487f0: 2020 2020 2020 2020 2020 2020 6361 6e64              cand
-00048800: 6964 6174 6573 203d 2076 616c 6964 5f77  idates = valid_w
-00048810: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-00048820: 2020 2069 6620 6e6f 7420 6361 6e64 6964     if not candid
-00048830: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
-00048840: 2020 2020 2020 6966 2074 732e 6c6f 6f73        if ts.loos
-00048850: 655f 7265 7374 7269 6374 696f 6e73 3a0a  e_restrictions:.
-00048860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048870: 2020 2020 7265 7475 726e 2064 6563 6964      return decid
-00048880: 655f 776f 726b 6572 2874 732c 2061 6c6c  e_worker(ts, all
-00048890: 5f77 6f72 6b65 7273 2c20 4e6f 6e65 2c20  _workers, None, 
-000488a0: 6f62 6a65 6374 6976 6529 0a0a 2020 2020  objective)..    
-000488b0: 6966 206e 6f74 2063 616e 6469 6461 7465  if not candidate
-000488c0: 733a 0a20 2020 2020 2020 2072 6574 7572  s:.        retur
-000488d0: 6e20 4e6f 6e65 0a20 2020 2065 6c69 6620  n None.    elif 
-000488e0: 6c65 6e28 6361 6e64 6964 6174 6573 2920  len(candidates) 
-000488f0: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-00048900: 7475 726e 206e 6578 7428 6974 6572 2863  turn next(iter(c
-00048910: 616e 6469 6461 7465 7329 290a 2020 2020  andidates)).    
-00048920: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-00048930: 7475 726e 206d 696e 2863 616e 6469 6461  turn min(candida
-00048940: 7465 732c 206b 6579 3d6f 626a 6563 7469  tes, key=objecti
-00048950: 7665 290a 0a0a 6465 6620 7661 6c69 6461  ve)...def valida
-00048960: 7465 5f74 6173 6b5f 7374 6174 6528 7473  te_task_state(ts
-00048970: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-00048980: 4e6f 6e65 3a0a 2020 2020 2222 2256 616c  None:.    """Val
-00048990: 6964 6174 6520 7468 6520 6769 7665 6e20  idate the given 
-000489a0: 5461 736b 5374 6174 6522 2222 0a20 2020  TaskState""".   
-000489b0: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
-000489c0: 2069 6e20 414c 4c5f 5441 534b 5f53 5441   in ALL_TASK_STA
-000489d0: 5445 532c 2074 730a 0a20 2020 2069 6620  TES, ts..    if 
-000489e0: 7473 2e77 6169 7469 6e67 5f6f 6e3a 0a20  ts.waiting_on:. 
-000489f0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00048a00: 2e77 6169 7469 6e67 5f6f 6e2e 6973 7375  .waiting_on.issu
-00048a10: 6273 6574 2874 732e 6465 7065 6e64 656e  bset(ts.dependen
-00048a20: 6369 6573 292c 2028 0a20 2020 2020 2020  cies), (.       
-00048a30: 2020 2020 2022 7761 6974 696e 6720 6e6f       "waiting no
-00048a40: 7420 7375 6273 6574 206f 6620 6465 7065  t subset of depe
-00048a50: 6e64 656e 6369 6573 222c 0a20 2020 2020  ndencies",.     
-00048a60: 2020 2020 2020 2073 7472 2874 732e 7761         str(ts.wa
-00048a70: 6974 696e 675f 6f6e 292c 0a20 2020 2020  iting_on),.     
-00048a80: 2020 2020 2020 2073 7472 2874 732e 6465         str(ts.de
-00048a90: 7065 6e64 656e 6369 6573 292c 0a20 2020  pendencies),.   
-00048aa0: 2020 2020 2029 0a20 2020 2069 6620 7473       ).    if ts
-00048ab0: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
-00048ac0: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
-00048ad0: 6572 732e 6973 7375 6273 6574 2874 732e  ers.issubset(ts.
-00048ae0: 6465 7065 6e64 656e 7473 292c 2028 0a20  dependents), (. 
-00048af0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
-00048b00: 6572 7320 6e6f 7420 7375 6273 6574 206f  ers not subset o
-00048b10: 6620 6465 7065 6e64 656e 7473 222c 0a20  f dependents",. 
-00048b20: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-00048b30: 732e 7761 6974 6572 7329 2c0a 2020 2020  s.waiters),.    
-00048b40: 2020 2020 2020 2020 7374 7228 7473 2e64          str(ts.d
-00048b50: 6570 656e 6465 6e74 7329 2c0a 2020 2020  ependents),.    
-00048b60: 2020 2020 290a 0a20 2020 2066 6f72 2064      )..    for d
-00048b70: 7473 2069 6e20 7473 2e77 6169 7469 6e67  ts in ts.waiting
-00048b80: 5f6f 6e3a 0a20 2020 2020 2020 2061 7373  _on:.        ass
-00048b90: 6572 7420 6e6f 7420 6474 732e 7768 6f5f  ert not dts.who_
-00048ba0: 6861 732c 2028 2277 6169 7469 6e67 206f  has, ("waiting o
-00048bb0: 6e20 696e 2d6d 656d 6f72 7920 6465 7022  n in-memory dep"
-00048bc0: 2c20 7374 7228 7473 292c 2073 7472 2864  , str(ts), str(d
-00048bd0: 7473 2929 0a20 2020 2020 2020 2061 7373  ts)).        ass
-00048be0: 6572 7420 6474 732e 7374 6174 6520 213d  ert dts.state !=
-00048bf0: 2022 7265 6c65 6173 6564 222c 2028 2277   "released", ("w
-00048c00: 6169 7469 6e67 206f 6e20 7265 6c65 6173  aiting on releas
-00048c10: 6564 2064 6570 222c 2073 7472 2874 7329  ed dep", str(ts)
-00048c20: 2c20 7374 7228 6474 7329 290a 2020 2020  , str(dts)).    
-00048c30: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00048c40: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-00048c50: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
-00048c60: 2064 7473 2e64 6570 656e 6465 6e74 732c   dts.dependents,
-00048c70: 2028 0a20 2020 2020 2020 2020 2020 2022   (.            "
-00048c80: 6e6f 7420 696e 2064 6570 656e 6465 6e63  not in dependenc
-00048c90: 7927 7320 6465 7065 6e64 656e 7473 222c  y's dependents",
-00048ca0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00048cb0: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-00048cc0: 2020 7374 7228 6474 7329 2c0a 2020 2020    str(dts),.    
-00048cd0: 2020 2020 2020 2020 7374 7228 6474 732e          str(dts.
-00048ce0: 6465 7065 6e64 656e 7473 292c 0a20 2020  dependents),.   
-00048cf0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00048d00: 6620 7473 2e73 7461 7465 2069 6e20 2822  f ts.state in ("
-00048d10: 7761 6974 696e 6722 2c20 2271 7565 7565  waiting", "queue
-00048d20: 6422 2c20 2270 726f 6365 7373 696e 6722  d", "processing"
-00048d30: 2c20 226e 6f2d 776f 726b 6572 2229 3a0a  , "no-worker"):.
-00048d40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00048d50: 7274 2064 7473 2069 6e20 7473 2e77 6169  rt dts in ts.wai
-00048d60: 7469 6e67 5f6f 6e20 6f72 2064 7473 2e77  ting_on or dts.w
-00048d70: 686f 5f68 6173 2c20 280a 2020 2020 2020  ho_has, (.      
-00048d80: 2020 2020 2020 2020 2020 2264 6570 206d            "dep m
-00048d90: 6973 7369 6e67 222c 0a20 2020 2020 2020  issing",.       
-00048da0: 2020 2020 2020 2020 2073 7472 2874 7329           str(ts)
-00048db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00048dc0: 2020 7374 7228 6474 7329 2c0a 2020 2020    str(dts),.    
-00048dd0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00048de0: 2020 6173 7365 7274 2064 7473 2e73 7461    assert dts.sta
-00048df0: 7465 2021 3d20 2266 6f72 676f 7474 656e  te != "forgotten
-00048e00: 220a 0a20 2020 2066 6f72 2064 7473 2069  "..    for dts i
-00048e10: 6e20 7473 2e77 6169 7465 7273 3a0a 2020  n ts.waiters:.  
-00048e20: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
-00048e30: 2e73 7461 7465 2069 6e20 2822 7761 6974  .state in ("wait
-00048e40: 696e 6722 2c20 2271 7565 7565 6422 2c20  ing", "queued", 
-00048e50: 2270 726f 6365 7373 696e 6722 2c20 226e  "processing", "n
-00048e60: 6f2d 776f 726b 6572 2229 2c20 280a 2020  o-worker"), (.  
-00048e70: 2020 2020 2020 2020 2020 2277 6169 7465            "waite
-00048e80: 7220 6e6f 7420 696e 2070 6c61 7922 2c0a  r not in play",.
-00048e90: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048ea0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00048eb0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
-00048ec0: 2020 2029 0a20 2020 2066 6f72 2064 7473     ).    for dts
-00048ed0: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
-00048ee0: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
-00048ef0: 7420 7473 2069 6e20 6474 732e 6465 7065  t ts in dts.depe
-00048f00: 6e64 656e 6369 6573 2c20 280a 2020 2020  ndencies, (.    
-00048f10: 2020 2020 2020 2020 226e 6f74 2069 6e20          "not in 
-00048f20: 6465 7065 6e64 656e 7427 7320 6465 7065  dependent's depe
-00048f30: 6e64 656e 6369 6573 222c 0a20 2020 2020  ndencies",.     
-00048f40: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-00048f50: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00048f60: 6474 7329 2c0a 2020 2020 2020 2020 2020  dts),.          
-00048f70: 2020 7374 7228 6474 732e 6465 7065 6e64    str(dts.depend
-00048f80: 656e 6369 6573 292c 0a20 2020 2020 2020  encies),.       
-00048f90: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-00048fa0: 7420 6474 732e 7374 6174 6520 213d 2022  t dts.state != "
-00048fb0: 666f 7267 6f74 7465 6e22 0a0a 2020 2020  forgotten"..    
-00048fc0: 6173 7365 7274 2028 7473 2e70 726f 6365  assert (ts.proce
-00048fd0: 7373 696e 675f 6f6e 2069 7320 6e6f 7420  ssing_on is not 
-00048fe0: 4e6f 6e65 2920 3d3d 2028 7473 2e73 7461  None) == (ts.sta
-00048ff0: 7465 203d 3d20 2270 726f 6365 7373 696e  te == "processin
-00049000: 6722 290a 2020 2020 6173 7365 7274 2062  g").    assert b
-00049010: 6f6f 6c28 7473 2e77 686f 5f68 6173 2920  ool(ts.who_has) 
-00049020: 3d3d 2028 7473 2e73 7461 7465 203d 3d20  == (ts.state == 
-00049030: 226d 656d 6f72 7922 292c 2028 7473 2c20  "memory"), (ts, 
-00049040: 7473 2e77 686f 5f68 6173 2c20 7473 2e73  ts.who_has, ts.s
-00049050: 7461 7465 290a 0a20 2020 2069 6620 7473  tate)..    if ts
-00049060: 2e73 7461 7465 203d 3d20 2271 7565 7565  .state == "queue
-00049070: 6422 3a0a 2020 2020 2020 2020 6173 7365  d":.        asse
-00049080: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
-00049090: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-000490a0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-000490b0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-000490c0: 7365 7274 2061 6c6c 2864 7473 2e77 686f  sert all(dts.who
-000490d0: 5f68 6173 2066 6f72 2064 7473 2069 6e20  _has for dts in 
-000490e0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
-000490f0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00049100: 2274 6173 6b20 7175 6575 6564 2077 6974  "task queued wit
-00049110: 686f 7574 2061 6c6c 2064 6570 7322 2c0a  hout all deps",.
-00049120: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-00049130: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-00049140: 2073 7472 2874 732e 6465 7065 6e64 656e   str(ts.dependen
-00049150: 6369 6573 292c 0a20 2020 2020 2020 2029  cies),.        )
-00049160: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
-00049170: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
-00049180: 223a 0a20 2020 2020 2020 2061 7373 6572  ":.        asser
-00049190: 7420 616c 6c28 6474 732e 7768 6f5f 6861  t all(dts.who_ha
-000491a0: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
-000491b0: 6465 7065 6e64 656e 6369 6573 292c 2028  dependencies), (
-000491c0: 0a20 2020 2020 2020 2020 2020 2022 7461  .            "ta
-000491d0: 736b 2070 726f 6365 7373 696e 6720 7769  sk processing wi
-000491e0: 7468 6f75 7420 616c 6c20 6465 7073 222c  thout all deps",
-000491f0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00049200: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-00049210: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
-00049220: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
-00049230: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00049240: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-00049250: 6f6e 0a0a 2020 2020 6966 2074 732e 7768  on..    if ts.wh
-00049260: 6f5f 6861 733a 0a20 2020 2020 2020 2061  o_has:.        a
-00049270: 7373 6572 7420 7473 2e77 6169 7465 7273  ssert ts.waiters
-00049280: 206f 7220 7473 2e77 686f 5f77 616e 7473   or ts.who_wants
-00049290: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-000492a0: 2275 6e6e 6565 6465 6420 7461 736b 2069  "unneeded task i
-000492b0: 6e20 6d65 6d6f 7279 222c 0a20 2020 2020  n memory",.     
-000492c0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-000492d0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
-000492e0: 7473 2e77 686f 5f68 6173 292c 0a20 2020  ts.who_has),.   
-000492f0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00049300: 6620 7473 2e72 756e 5f73 7065 633a 2020  f ts.run_spec:  
-00049310: 2320 7761 7320 636f 6d70 7574 6564 0a20  # was computed. 
-00049320: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00049330: 7420 7473 2e74 7970 650a 2020 2020 2020  t ts.type.      
-00049340: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00049350: 6e73 7461 6e63 6528 7473 2e74 7970 652c  nstance(ts.type,
-00049360: 2073 7472 290a 2020 2020 2020 2020 6173   str).        as
-00049370: 7365 7274 206e 6f74 2061 6e79 285b 7473  sert not any([ts
-00049380: 2069 6e20 6474 732e 7761 6974 696e 675f   in dts.waiting_
-00049390: 6f6e 2066 6f72 2064 7473 2069 6e20 7473  on for dts in ts
-000493a0: 2e64 6570 656e 6465 6e74 735d 290a 2020  .dependents]).  
-000493b0: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-000493c0: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-000493d0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-000493e0: 7320 696e 2077 732e 6861 735f 7768 6174  s in ws.has_what
-000493f0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-00049400: 2020 2020 226e 6f74 2069 6e20 7768 6f5f      "not in who_
-00049410: 6861 7327 2068 6173 5f77 6861 7422 2c0a  has' has_what",.
-00049420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049430: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
-00049440: 2020 2020 2020 2020 2073 7472 2877 7329           str(ws)
-00049450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00049460: 2020 7374 7228 7773 2e68 6173 5f77 6861    str(ws.has_wha
-00049470: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-00049480: 290a 0a20 2020 2066 6f72 2063 7320 696e  )..    for cs in
-00049490: 2074 732e 7768 6f5f 7761 6e74 733a 0a20   ts.who_wants:. 
-000494a0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-000494b0: 2069 6e20 6373 2e77 616e 7473 5f77 6861   in cs.wants_wha
-000494c0: 742c 2028 0a20 2020 2020 2020 2020 2020  t, (.           
-000494d0: 2022 6e6f 7420 696e 2077 686f 5f77 616e   "not in who_wan
-000494e0: 7473 2720 7761 6e74 735f 7768 6174 222c  ts' wants_what",
-000494f0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-00049500: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-00049510: 2020 7374 7228 6373 292c 0a20 2020 2020    str(cs),.     
-00049520: 2020 2020 2020 2073 7472 2863 732e 7761         str(cs.wa
-00049530: 6e74 735f 7768 6174 292c 0a20 2020 2020  nts_what),.     
-00049540: 2020 2029 0a0a 2020 2020 6966 2074 732e     )..    if ts.
-00049550: 6163 746f 723a 0a20 2020 2020 2020 2069  actor:.        i
-00049560: 6620 7473 2e73 7461 7465 203d 3d20 226d  f ts.state == "m
-00049570: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
-00049580: 2020 2020 6173 7365 7274 2073 756d 2874      assert sum(t
-00049590: 7320 696e 2077 732e 6163 746f 7273 2066  s in ws.actors f
-000495a0: 6f72 2077 7320 696e 2074 732e 7768 6f5f  or ws in ts.who_
-000495b0: 6861 7329 203d 3d20 310a 2020 2020 2020  has) == 1.      
-000495c0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
-000495d0: 2022 7072 6f63 6573 7369 6e67 223a 0a20   "processing":. 
-000495e0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000495f0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00049600: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00049610: 7373 6572 7420 7473 2069 6e20 7473 2e70  ssert ts in ts.p
-00049620: 726f 6365 7373 696e 675f 6f6e 2e61 6374  rocessing_on.act
-00049630: 6f72 730a 2020 2020 2020 2020 6173 7365  ors.        asse
-00049640: 7274 2074 732e 7374 6174 6520 213d 2022  rt ts.state != "
-00049650: 7175 6575 6564 220a 0a0a 6465 6620 7661  queued"...def va
-00049660: 6c69 6461 7465 5f77 6f72 6b65 725f 7374  lidate_worker_st
-00049670: 6174 6528 7773 3a20 576f 726b 6572 5374  ate(ws: WorkerSt
-00049680: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
-00049690: 2020 666f 7220 7473 2069 6e20 7773 2e68    for ts in ws.h
-000496a0: 6173 5f77 6861 743a 0a20 2020 2020 2020  as_what:.       
-000496b0: 2061 7373 6572 7420 7773 2069 6e20 7473   assert ws in ts
-000496c0: 2e77 686f 5f68 6173 2c20 280a 2020 2020  .who_has, (.    
-000496d0: 2020 2020 2020 2020 226e 6f74 2069 6e20          "not in 
-000496e0: 6861 735f 7768 6174 2720 7768 6f5f 6861  has_what' who_ha
-000496f0: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00049700: 7374 7228 7773 292c 0a20 2020 2020 2020  str(ws),.       
-00049710: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-00049720: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-00049730: 2e77 686f 5f68 6173 292c 0a20 2020 2020  .who_has),.     
-00049740: 2020 2029 0a0a 2020 2020 666f 7220 7473     )..    for ts
-00049750: 2069 6e20 7773 2e61 6374 6f72 733a 0a20   in ws.actors:. 
-00049760: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-00049770: 2e73 7461 7465 2069 6e20 2822 6d65 6d6f  .state in ("memo
-00049780: 7279 222c 2022 7072 6f63 6573 7369 6e67  ry", "processing
-00049790: 2229 0a0a 0a64 6566 2076 616c 6964 6174  ")...def validat
-000497a0: 655f 7374 6174 6528 0a20 2020 2074 6173  e_state(.    tas
-000497b0: 6b73 3a20 6469 6374 5b73 7472 2c20 5461  ks: dict[str, Ta
-000497c0: 736b 5374 6174 655d 2c0a 2020 2020 776f  skState],.    wo
-000497d0: 726b 6572 733a 2064 6963 745b 7374 722c  rkers: dict[str,
-000497e0: 2057 6f72 6b65 7253 7461 7465 5d2c 0a20   WorkerState],. 
-000497f0: 2020 2063 6c69 656e 7473 3a20 6469 6374     clients: dict
-00049800: 5b73 7472 2c20 436c 6965 6e74 5374 6174  [str, ClientStat
-00049810: 655d 2c0a 2920 2d3e 204e 6f6e 653a 0a20  e],.) -> None:. 
-00049820: 2020 2022 2222 5661 6c69 6461 7465 2061     """Validate a
-00049830: 2063 7572 7265 6e74 2072 756e 7469 6d65   current runtime
-00049840: 2073 7461 7465 2e0a 0a20 2020 2054 6869   state...    Thi
-00049850: 7320 7065 7266 6f72 6d73 2061 2073 6571  s performs a seq
-00049860: 7565 6e63 6520 6f66 2063 6865 636b 7320  uence of checks 
-00049870: 6f6e 2074 6865 2065 6e74 6972 6520 6772  on the entire gr
-00049880: 6170 682c 2072 756e 6e69 6e67 2069 6e20  aph, running in 
-00049890: 6162 6f75 7420 6c69 6e65 6172 0a20 2020  about linear.   
-000498a0: 2074 696d 652e 2054 6869 7320 7261 6973   time. This rais
-000498b0: 6573 2061 7373 6572 7420 6572 726f 7273  es assert errors
-000498c0: 2069 6620 616e 7974 6869 6e67 2064 6f65   if anything doe
-000498d0: 736e 2774 2063 6865 636b 206f 7574 2e0a  sn't check out..
-000498e0: 2020 2020 2222 220a 2020 2020 666f 7220      """.    for 
-000498f0: 7473 2069 6e20 7461 736b 732e 7661 6c75  ts in tasks.valu
-00049900: 6573 2829 3a0a 2020 2020 2020 2020 7661  es():.        va
-00049910: 6c69 6461 7465 5f74 6173 6b5f 7374 6174  lidate_task_stat
-00049920: 6528 7473 290a 0a20 2020 2066 6f72 2077  e(ts)..    for w
-00049930: 7320 696e 2077 6f72 6b65 7273 2e76 616c  s in workers.val
-00049940: 7565 7328 293a 0a20 2020 2020 2020 2076  ues():.        v
-00049950: 616c 6964 6174 655f 776f 726b 6572 5f73  alidate_worker_s
-00049960: 7461 7465 2877 7329 0a0a 2020 2020 666f  tate(ws)..    fo
-00049970: 7220 6373 2069 6e20 636c 6965 6e74 732e  r cs in clients.
-00049980: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-00049990: 2020 666f 7220 7473 2069 6e20 6373 2e77    for ts in cs.w
-000499a0: 616e 7473 5f77 6861 743a 0a20 2020 2020  ants_what:.     
-000499b0: 2020 2020 2020 2061 7373 6572 7420 6373         assert cs
-000499c0: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
-000499d0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-000499e0: 2020 2020 226e 6f74 2069 6e20 7761 6e74      "not in want
-000499f0: 735f 7768 6174 2720 7768 6f5f 7761 6e74  s_what' who_want
-00049a00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00049a10: 2020 2020 7374 7228 6373 292c 0a20 2020      str(cs),.   
-00049a20: 2020 2020 2020 2020 2020 2020 2073 7472               str
-00049a30: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
-00049a40: 2020 2020 2020 7374 7228 7473 2e77 686f        str(ts.who
-00049a50: 5f77 616e 7473 292c 0a20 2020 2020 2020  _wants),.       
-00049a60: 2020 2020 2029 0a0a 0a64 6566 2068 6561       )...def hea
-00049a70: 7274 6265 6174 5f69 6e74 6572 7661 6c28  rtbeat_interval(
-00049a80: 6e3a 2069 6e74 2920 2d3e 2066 6c6f 6174  n: int) -> float
-00049a90: 3a0a 2020 2020 2222 2249 6e74 6572 7661  :.    """Interva
-00049aa0: 6c20 696e 2073 6563 6f6e 6473 2074 6861  l in seconds tha
-00049ab0: 7420 7765 2064 6573 6972 6520 6865 6172  t we desire hear
-00049ac0: 7462 6561 7473 2062 6173 6564 206f 6e20  tbeats based on 
-00049ad0: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-00049ae0: 7322 2222 0a20 2020 2069 6620 6e20 3c3d  s""".    if n <=
-00049af0: 2031 303a 0a20 2020 2020 2020 2072 6574   10:.        ret
-00049b00: 7572 6e20 302e 350a 2020 2020 656c 6966  urn 0.5.    elif
-00049b10: 206e 203c 2035 303a 0a20 2020 2020 2020   n < 50:.       
-00049b20: 2072 6574 7572 6e20 310a 2020 2020 656c   return 1.    el
-00049b30: 6966 206e 203c 2032 3030 3a0a 2020 2020  if n < 200:.    
-00049b40: 2020 2020 7265 7475 726e 2032 0a20 2020      return 2.   
-00049b50: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
-00049b60: 204e 6f20 6d6f 7265 2074 6861 6e20 3230   No more than 20
-00049b70: 3020 6865 6172 7462 6561 7473 2061 2073  0 heartbeats a s
-00049b80: 6563 6f6e 6420 7363 616c 6564 2062 7920  econd scaled by 
-00049b90: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
-00049ba0: 7265 7475 726e 206e 202f 2032 3030 202b  return n / 200 +
-00049bb0: 2031 0a0a 0a64 6566 205f 7461 736b 5f73   1...def _task_s
-00049bc0: 6c6f 7473 5f61 7661 696c 6162 6c65 2877  lots_available(w
-00049bd0: 733a 2057 6f72 6b65 7253 7461 7465 2c20  s: WorkerState, 
-00049be0: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
-00049bf0: 723a 2066 6c6f 6174 2920 2d3e 2069 6e74  r: float) -> int
-00049c00: 3a0a 2020 2020 2222 224e 756d 6265 7220  :.    """Number 
-00049c10: 6f66 2074 6173 6b73 2074 6861 7420 6361  of tasks that ca
-00049c20: 6e20 6265 2073 656e 7420 746f 2074 6869  n be sent to thi
-00049c30: 7320 776f 726b 6572 2077 6974 686f 7574  s worker without
-00049c40: 206f 7665 7273 6174 7572 6174 696e 6720   oversaturating 
-00049c50: 6974 2222 220a 2020 2020 6173 7365 7274  it""".    assert
-00049c60: 206e 6f74 206d 6174 682e 6973 696e 6628   not math.isinf(
-00049c70: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
-00049c80: 7229 0a20 2020 2072 6574 7572 6e20 6d61  r).    return ma
-00049c90: 7828 6d61 7468 2e63 6569 6c28 7361 7475  x(math.ceil(satu
-00049ca0: 7261 7469 6f6e 5f66 6163 746f 7220 2a20  ration_factor * 
-00049cb0: 7773 2e6e 7468 7265 6164 7329 2c20 3129  ws.nthreads), 1)
-00049cc0: 202d 2028 0a20 2020 2020 2020 206c 656e   - (.        len
-00049cd0: 2877 732e 7072 6f63 6573 7369 6e67 2920  (ws.processing) 
-00049ce0: 2d20 6c65 6e28 7773 2e6c 6f6e 675f 7275  - len(ws.long_ru
-00049cf0: 6e6e 696e 6729 0a20 2020 2029 0a0a 0a64  nning).    )...d
-00049d00: 6566 205f 776f 726b 6572 5f66 756c 6c28  ef _worker_full(
-00049d10: 7773 3a20 576f 726b 6572 5374 6174 652c  ws: WorkerState,
-00049d20: 2073 6174 7572 6174 696f 6e5f 6661 6374   saturation_fact
-00049d30: 6f72 3a20 666c 6f61 7429 202d 3e20 626f  or: float) -> bo
-00049d40: 6f6c 3a0a 2020 2020 6966 206d 6174 682e  ol:.    if math.
-00049d50: 6973 696e 6628 7361 7475 7261 7469 6f6e  isinf(saturation
-00049d60: 5f66 6163 746f 7229 3a0a 2020 2020 2020  _factor):.      
-00049d70: 2020 7265 7475 726e 2046 616c 7365 0a20    return False. 
-00049d80: 2020 2072 6574 7572 6e20 5f74 6173 6b5f     return _task_
-00049d90: 736c 6f74 735f 6176 6169 6c61 626c 6528  slots_available(
-00049da0: 7773 2c20 7361 7475 7261 7469 6f6e 5f66  ws, saturation_f
-00049db0: 6163 746f 7229 203c 3d20 300a 0a0a 636c  actor) <= 0...cl
-00049dc0: 6173 7320 4b69 6c6c 6564 576f 726b 6572  ass KilledWorker
-00049dd0: 2845 7863 6570 7469 6f6e 293a 0a20 2020  (Exception):.   
-00049de0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
-00049df0: 6c66 2c20 7461 736b 3a20 7374 722c 206c  lf, task: str, l
-00049e00: 6173 745f 776f 726b 6572 3a20 576f 726b  ast_worker: Work
-00049e10: 6572 5374 6174 652c 2061 6c6c 6f77 6564  erState, allowed
-00049e20: 5f66 6169 6c75 7265 733a 2069 6e74 293a  _failures: int):
-00049e30: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
-00049e40: 2e5f 5f69 6e69 745f 5f28 7461 736b 2c20  .__init__(task, 
-00049e50: 6c61 7374 5f77 6f72 6b65 722c 2061 6c6c  last_worker, all
-00049e60: 6f77 6564 5f66 6169 6c75 7265 7329 0a0a  owed_failures)..
-00049e70: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00049e80: 2020 6465 6620 7461 736b 2873 656c 6629    def task(self)
-00049e90: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-00049ea0: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
-00049eb0: 735b 305d 0a0a 2020 2020 4070 726f 7065  s[0]..    @prope
-00049ec0: 7274 790a 2020 2020 6465 6620 6c61 7374  rty.    def last
-00049ed0: 5f77 6f72 6b65 7228 7365 6c66 2920 2d3e  _worker(self) ->
-00049ee0: 2057 6f72 6b65 7253 7461 7465 3a0a 2020   WorkerState:.  
-00049ef0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00049f00: 662e 6172 6773 5b31 5d0a 0a20 2020 2040  f.args[1]..    @
-00049f10: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00049f20: 2061 6c6c 6f77 6564 5f66 6169 6c75 7265   allowed_failure
-00049f30: 7328 7365 6c66 2920 2d3e 2069 6e74 3a0a  s(self) -> int:.
-00049f40: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00049f50: 656c 662e 6172 6773 5b32 5d0a 0a20 2020  elf.args[2]..   
-00049f60: 2064 6566 205f 5f73 7472 5f5f 2873 656c   def __str__(sel
-00049f70: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-00049f80: 2020 2072 6574 7572 6e20 280a 2020 2020     return (.    
-00049f90: 2020 2020 2020 2020 6622 4174 7465 6d70          f"Attemp
-00049fa0: 7465 6420 746f 2072 756e 2074 6173 6b20  ted to run task 
-00049fb0: 7b73 656c 662e 7461 736b 7d20 6f6e 207b  {self.task} on {
-00049fc0: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
-00049fd0: 6c75 7265 737d 2064 6966 6665 7265 6e74  lures} different
-00049fe0: 2022 0a20 2020 2020 2020 2020 2020 2022   ".            "
-00049ff0: 776f 726b 6572 732c 2062 7574 2061 6c6c  workers, but all
-0004a000: 2074 686f 7365 2077 6f72 6b65 7273 2064   those workers d
-0004a010: 6965 6420 7768 696c 6520 7275 6e6e 696e  ied while runnin
-0004a020: 6720 6974 2e20 220a 2020 2020 2020 2020  g it. ".        
-0004a030: 2020 2020 6622 5468 6520 6c61 7374 2077      f"The last w
-0004a040: 6f72 6b65 7220 7468 6174 2061 7474 656d  orker that attem
-0004a050: 7074 2074 6f20 7275 6e20 7468 6520 7461  pt to run the ta
-0004a060: 736b 2077 6173 207b 7365 6c66 2e6c 6173  sk was {self.las
-0004a070: 745f 776f 726b 6572 2e61 6464 7265 7373  t_worker.address
-0004a080: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0004a090: 2022 496e 7370 6563 7469 6e67 2077 6f72   "Inspecting wor
-0004a0a0: 6b65 7220 6c6f 6773 2069 7320 6f66 7465  ker logs is ofte
-0004a0b0: 6e20 6120 676f 6f64 206e 6578 7420 7374  n a good next st
-0004a0c0: 6570 2074 6f20 6469 6167 6e6f 7365 2077  ep to diagnose w
-0004a0d0: 6861 7420 7765 6e74 2077 726f 6e67 2e20  hat went wrong. 
-0004a0e0: 220a 2020 2020 2020 2020 2020 2020 2246  ".            "F
-0004a0f0: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
-0004a100: 696f 6e20 7365 6520 6874 7470 733a 2f2f  ion see https://
-0004a110: 6469 7374 7269 6275 7465 642e 6461 736b  distributed.dask
-0004a120: 2e6f 7267 2f65 6e2f 7374 6162 6c65 2f6b  .org/en/stable/k
-0004a130: 696c 6c65 642e 6874 6d6c 2e22 0a20 2020  illed.html.".   
-0004a140: 2020 2020 2029 0a0a 0a63 6c61 7373 2057       )...class W
-0004a150: 6f72 6b65 7253 7461 7475 7350 6c75 6769  orkerStatusPlugi
-0004a160: 6e28 5363 6865 6475 6c65 7250 6c75 6769  n(SchedulerPlugi
-0004a170: 6e29 3a0a 2020 2020 2222 2241 2070 6c75  n):.    """A plu
-0004a180: 6769 6e20 746f 2073 6861 7265 2077 6f72  gin to share wor
-0004a190: 6b65 7220 7374 6174 7573 2077 6974 6820  ker status with 
-0004a1a0: 6120 7265 6d6f 7465 206f 6273 6572 7665  a remote observe
-0004a1b0: 720a 0a20 2020 2054 6869 7320 6973 2075  r..    This is u
-0004a1c0: 7365 6420 696e 2063 6c75 7374 6572 206d  sed in cluster m
-0004a1d0: 616e 6167 6572 7320 746f 206b 6565 7020  anagers to keep 
-0004a1e0: 7570 6461 7465 6420 6162 6f75 7420 7468  updated about th
-0004a1f0: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
-0004a200: 7363 6865 6475 6c65 722e 0a20 2020 2022  scheduler..    "
-0004a210: 2222 0a0a 2020 2020 6e61 6d65 3a20 436c  ""..    name: Cl
-0004a220: 6173 7356 6172 5b73 7472 5d20 3d20 2277  assVar[str] = "w
-0004a230: 6f72 6b65 722d 7374 6174 7573 220a 2020  orker-status".  
-0004a240: 2020 6263 6f6d 6d3a 2042 6174 6368 6564    bcomm: Batched
-0004a250: 5365 6e64 0a0a 2020 2020 6465 6620 5f5f  Send..    def __
-0004a260: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-0004a270: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
-0004a280: 722c 2063 6f6d 6d3a 2043 6f6d 6d29 3a0a  r, comm: Comm):.
-0004a290: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
-0004a2a0: 6d6d 203d 2042 6174 6368 6564 5365 6e64  mm = BatchedSend
-0004a2b0: 2869 6e74 6572 7661 6c3d 2235 6d73 2229  (interval="5ms")
-0004a2c0: 0a20 2020 2020 2020 2073 656c 662e 6263  .        self.bc
-0004a2d0: 6f6d 6d2e 7374 6172 7428 636f 6d6d 290a  omm.start(comm).
-0004a2e0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-0004a2f0: 722e 6164 645f 706c 7567 696e 2873 656c  r.add_plugin(sel
-0004a300: 6629 0a0a 2020 2020 6465 6620 6164 645f  f)..    def add_
-0004a310: 776f 726b 6572 2873 656c 662c 2073 6368  worker(self, sch
-0004a320: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
-0004a330: 722c 2077 6f72 6b65 723a 2073 7472 2920  r, worker: str) 
-0004a340: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0004a350: 2069 6465 6e74 203d 2073 6368 6564 756c   ident = schedul
-0004a360: 6572 2e77 6f72 6b65 7273 5b77 6f72 6b65  er.workers[worke
-0004a370: 725d 2e69 6465 6e74 6974 7928 290a 2020  r].identity().  
-0004a380: 2020 2020 2020 6465 6c20 6964 656e 745b        del ident[
-0004a390: 226d 6574 7269 6373 225d 0a20 2020 2020  "metrics"].     
-0004a3a0: 2020 2064 656c 2069 6465 6e74 5b22 6c61     del ident["la
-0004a3b0: 7374 5f73 6565 6e22 5d0a 2020 2020 2020  st_seen"].      
-0004a3c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0004a3d0: 2020 2073 656c 662e 6263 6f6d 6d2e 7365     self.bcomm.se
-0004a3e0: 6e64 285b 2261 6464 222c 207b 2277 6f72  nd(["add", {"wor
-0004a3f0: 6b65 7273 223a 207b 776f 726b 6572 3a20  kers": {worker: 
-0004a400: 6964 656e 747d 7d5d 290a 2020 2020 2020  ident}}]).      
-0004a410: 2020 6578 6365 7074 2043 6f6d 6d43 6c6f    except CommClo
-0004a420: 7365 6445 7272 6f72 3a0a 2020 2020 2020  sedError:.      
-0004a430: 2020 2020 2020 7363 6865 6475 6c65 722e        scheduler.
-0004a440: 7265 6d6f 7665 5f70 6c75 6769 6e28 6e61  remove_plugin(na
-0004a450: 6d65 3d73 656c 662e 6e61 6d65 290a 0a20  me=self.name).. 
-0004a460: 2020 2064 6566 2072 656d 6f76 655f 776f     def remove_wo
-0004a470: 726b 6572 2873 656c 662c 2073 6368 6564  rker(self, sched
-0004a480: 756c 6572 3a20 5363 6865 6475 6c65 722c  uler: Scheduler,
-0004a490: 2077 6f72 6b65 723a 2073 7472 2920 2d3e   worker: str) ->
-0004a4a0: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
-0004a4b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0004a4c0: 7365 6c66 2e62 636f 6d6d 2e73 656e 6428  self.bcomm.send(
-0004a4d0: 5b22 7265 6d6f 7665 222c 2077 6f72 6b65  ["remove", worke
-0004a4e0: 725d 290a 2020 2020 2020 2020 6578 6365  r]).        exce
-0004a4f0: 7074 2043 6f6d 6d43 6c6f 7365 6445 7272  pt CommClosedErr
-0004a500: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-0004a510: 7363 6865 6475 6c65 722e 7265 6d6f 7665  scheduler.remove
-0004a520: 5f70 6c75 6769 6e28 6e61 6d65 3d73 656c  _plugin(name=sel
-0004a530: 662e 6e61 6d65 290a 0a20 2020 2064 6566  f.name)..    def
-0004a540: 2074 6561 7264 6f77 6e28 7365 6c66 2920   teardown(self) 
-0004a550: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0004a560: 2073 656c 662e 6263 6f6d 6d2e 636c 6f73   self.bcomm.clos
-0004a570: 6528 290a 0a0a 636c 6173 7320 436f 6c6c  e()...class Coll
-0004a580: 6563 7454 6173 6b4d 6574 6144 6174 6150  ectTaskMetaDataP
-0004a590: 6c75 6769 6e28 5363 6865 6475 6c65 7250  lugin(SchedulerP
-0004a5a0: 6c75 6769 6e29 3a0a 2020 2020 7363 6865  lugin):.    sche
-0004a5b0: 6475 6c65 723a 2053 6368 6564 756c 6572  duler: Scheduler
-0004a5c0: 0a20 2020 206e 616d 653a 2073 7472 0a20  .    name: str. 
-0004a5d0: 2020 206b 6579 733a 2073 6574 5b73 7472     keys: set[str
-0004a5e0: 5d0a 2020 2020 6d65 7461 6461 7461 3a20  ].    metadata: 
-0004a5f0: 6469 6374 5b73 7472 2c20 416e 795d 0a20  dict[str, Any]. 
-0004a600: 2020 2073 7461 7465 3a20 6469 6374 5b73     state: dict[s
-0004a610: 7472 2c20 7374 725d 0a0a 2020 2020 6465  tr, str]..    de
-0004a620: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
-0004a630: 2073 6368 6564 756c 6572 3a20 5363 6865   scheduler: Sche
-0004a640: 6475 6c65 722c 206e 616d 653a 2073 7472  duler, name: str
-0004a650: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0004a660: 7363 6865 6475 6c65 7220 3d20 7363 6865  scheduler = sche
-0004a670: 6475 6c65 720a 2020 2020 2020 2020 7365  duler.        se
-0004a680: 6c66 2e6e 616d 6520 3d20 6e61 6d65 0a20  lf.name = name. 
-0004a690: 2020 2020 2020 2073 656c 662e 6b65 7973         self.keys
-0004a6a0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-0004a6b0: 2073 656c 662e 6d65 7461 6461 7461 203d   self.metadata =
-0004a6c0: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0004a6d0: 2e73 7461 7465 203d 207b 7d0a 0a20 2020  .state = {}..   
-0004a6e0: 2064 6566 2075 7064 6174 655f 6772 6170   def update_grap
-0004a6f0: 6828 0a20 2020 2020 2020 2073 656c 662c  h(.        self,
-0004a700: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
-0004a710: 6572 3a20 5363 6865 6475 6c65 722c 0a20  er: Scheduler,. 
-0004a720: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
-0004a730: 2020 6b65 7973 3a20 7365 745b 7374 725d    keys: set[str]
-0004a740: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
-0004a750: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
-0004a760: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0004a770: 7365 6c66 2e6b 6579 732e 7570 6461 7465  self.keys.update
-0004a780: 286b 6579 7329 0a0a 2020 2020 6465 6620  (keys)..    def 
-0004a790: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
-0004a7a0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
-0004a7b0: 2020 6b65 793a 2073 7472 2c0a 2020 2020    key: str,.    
-0004a7c0: 2020 2020 7374 6172 743a 2054 6173 6b53      start: TaskS
-0004a7d0: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
-0004a7e0: 2020 2066 696e 6973 683a 2054 6173 6b53     finish: TaskS
-0004a7f0: 7461 7465 5374 6174 652c 0a20 2020 2020  tateState,.     
-0004a800: 2020 202a 6172 6773 3a20 416e 792c 0a20     *args: Any,. 
-0004a810: 2020 2020 2020 202a 2a6b 7761 7267 733a         **kwargs:
-0004a820: 2041 6e79 2c0a 2020 2020 2920 2d3e 204e   Any,.    ) -> N
-0004a830: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0004a840: 6669 6e69 7368 2069 6e20 2822 6d65 6d6f  finish in ("memo
-0004a850: 7279 222c 2022 6572 7265 6422 293a 0a20  ry", "erred"):. 
-0004a860: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-0004a870: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
-0004a880: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-0004a890: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-0004a8a0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-0004a8b0: 7473 2e6b 6579 2069 6e20 7365 6c66 2e6b  ts.key in self.k
-0004a8c0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-0004a8d0: 2020 2020 2073 656c 662e 6d65 7461 6461       self.metada
-0004a8e0: 7461 5b6b 6579 5d20 3d20 7473 2e6d 6574  ta[key] = ts.met
-0004a8f0: 6164 6174 610a 2020 2020 2020 2020 2020  adata.          
-0004a900: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-0004a910: 5b6b 6579 5d20 3d20 6669 6e69 7368 0a20  [key] = finish. 
-0004a920: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a930: 656c 662e 6b65 7973 2e64 6973 6361 7264  elf.keys.discard
-0004a940: 286b 6579 290a                           (key).
+0003e4d0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+0003e4e0: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
+0003e4f0: 5765 2073 686f 756c 6420 7365 6e64 2061  We should send a
+0003e500: 206d 6573 7361 6765 2074 6f20 7468 6520   message to the 
+0003e510: 6e61 6e6e 7920 6669 7273 743b 0a20 2020  nanny first;.   
+0003e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e530: 2023 2065 7665 6e74 7561 6c6c 7920 776f   # eventually wo
+0003e540: 726b 6572 7320 776f 6e27 7420 6265 2061  rkers won't be a
+0003e550: 626c 6520 746f 2063 6c6f 7365 2074 6865  ble to close the
+0003e560: 6972 206f 776e 206e 616e 6e69 6573 2e0a  ir own nannies..
+0003e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e580: 2020 2020 7365 6c66 2e73 7472 6561 6d5f      self.stream_
+0003e590: 636f 6d6d 735b 7773 2e61 6464 7265 7373  comms[ws.address
+0003e5a0: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
+0003e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e5c0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003e5d0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+0003e5e0: 7022 3a20 2277 6f72 6b65 722d 7374 6174  p": "worker-stat
+0003e5f0: 7573 2d63 6861 6e67 6522 2c0a 2020 2020  us-change",.    
+0003e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e610: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0003e620: 3a20 7773 2e73 7461 7475 732e 6e61 6d65  : ws.status.name
+0003e630: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003e640: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0003e650: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0003e660: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0003e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e680: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0003e690: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003e6a0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003e6b0: 6f72 6f73 2e61 7070 656e 6428 0a20 2020  oros.append(.   
+0003e6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e6d0: 2020 2020 2073 656c 662e 5f74 7261 636b       self._track
+0003e6e0: 5f72 6574 6972 655f 776f 726b 6572 280a  _retire_worker(.
+0003e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e700: 2020 2020 2020 2020 2020 2020 7773 2c0a              ws,.
+0003e710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e720: 2020 2020 2020 2020 2020 2020 706f 6c69              poli
+0003e730: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
+0003e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e750: 7072 6576 5f73 7461 7475 733d 7072 6576  prev_status=prev
+0003e760: 5f73 7461 7475 732c 0a20 2020 2020 2020  _status,.       
+0003e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e780: 2020 2020 2063 6c6f 7365 3d63 6c6f 7365       close=close
+0003e790: 5f77 6f72 6b65 7273 2c0a 2020 2020 2020  _workers,.      
+0003e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e7b0: 2020 2020 2020 7265 6d6f 7665 3d72 656d        remove=rem
+0003e7c0: 6f76 652c 0a20 2020 2020 2020 2020 2020  ove,.           
+0003e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e7e0: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+0003e7f0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0003e800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e810: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003e820: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0003e830: 2020 2020 2020 2020 2020 2023 2047 6976             # Giv
+0003e840: 6520 7468 6520 414d 4d20 6120 6b69 636b  e the AMM a kick
+0003e850: 2c20 696e 2061 6464 6974 696f 6e20 746f  , in addition to
+0003e860: 2069 7473 2070 6572 696f 6469 6320 7275   its periodic ru
+0003e870: 6e6e 696e 672e 2054 6869 7320 6973 0a20  nning. This is. 
+0003e880: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003e890: 2074 6f20 6176 6f69 6420 756e 6e65 6365   to avoid unnece
+0003e8a0: 7373 6172 696c 7920 7761 6974 696e 6720  ssarily waiting 
+0003e8b0: 666f 7220 6120 706f 7465 6e74 6961 6c6c  for a potentiall
+0003e8c0: 7920 6172 6269 7472 6172 696c 7920 6c6f  y arbitrarily lo
+0003e8d0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
+0003e8e0: 2020 2023 2074 696d 6520 2864 6570 656e     # time (depen
+0003e8f0: 6469 6e67 206f 6e20 696e 7465 7276 616c  ding on interval
+0003e900: 2073 6574 7469 6e67 7329 0a20 2020 2020   settings).     
+0003e910: 2020 2020 2020 2020 2020 2061 6d6d 2e72             amm.r
+0003e920: 756e 5f6f 6e63 6528 290a 0a20 2020 2020  un_once()..     
+0003e930: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+0003e940: 7273 5f69 6e66 6f20 3d20 6469 6374 2861  rs_info = dict(a
+0003e950: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+0003e960: 6865 7228 2a63 6f72 6f73 2929 0a20 2020  her(*coros)).   
+0003e970: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0003e980: 6b65 7273 5f69 6e66 6f2e 706f 7028 4e6f  kers_info.pop(No
+0003e990: 6e65 2c20 4e6f 6e65 290a 2020 2020 2020  ne, None).      
+0003e9a0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+0003e9b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003e9c0: 6620 7374 6f70 5f61 6d6d 3a0a 2020 2020  f stop_amm:.    
+0003e9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e9e0: 616d 6d2e 7374 6f70 2829 0a0a 2020 2020  amm.stop()..    
+0003e9f0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0003ea00: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
+0003ea10: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
+0003ea20: 6b65 7273 222c 2022 776f 726b 6572 7322  kers", "workers"
+0003ea30: 3a20 776f 726b 6572 735f 696e 666f 7d29  : workers_info})
+0003ea40: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0003ea50: 675f 6576 656e 7428 6c69 7374 2877 6f72  g_event(list(wor
+0003ea60: 6b65 7273 5f69 6e66 6f29 2c20 7b22 6163  kers_info), {"ac
+0003ea70: 7469 6f6e 223a 2022 7265 7469 7265 6422  tion": "retired"
+0003ea80: 7d29 0a0a 2020 2020 2020 2020 7265 7475  })..        retu
+0003ea90: 726e 2077 6f72 6b65 7273 5f69 6e66 6f0a  rn workers_info.
+0003eaa0: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+0003eab0: 7472 6163 6b5f 7265 7469 7265 5f77 6f72  track_retire_wor
+0003eac0: 6b65 7228 0a20 2020 2020 2020 2073 656c  ker(.        sel
+0003ead0: 662c 0a20 2020 2020 2020 2077 733a 2057  f,.        ws: W
+0003eae0: 6f72 6b65 7253 7461 7465 2c0a 2020 2020  orkerState,.    
+0003eaf0: 2020 2020 706f 6c69 6379 3a20 5265 7469      policy: Reti
+0003eb00: 7265 576f 726b 6572 2c0a 2020 2020 2020  reWorker,.      
+0003eb10: 2020 7072 6576 5f73 7461 7475 733a 2053    prev_status: S
+0003eb20: 7461 7475 732c 0a20 2020 2020 2020 2063  tatus,.        c
+0003eb30: 6c6f 7365 3a20 626f 6f6c 2c0a 2020 2020  lose: bool,.    
+0003eb40: 2020 2020 7265 6d6f 7665 3a20 626f 6f6c      remove: bool
+0003eb50: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+0003eb60: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
+0003eb70: 2920 2d3e 2074 7570 6c65 3a20 2023 2074  ) -> tuple:  # t
+0003eb80: 7570 6c65 5b73 7472 207c 204e 6f6e 652c  uple[str | None,
+0003eb90: 2064 6963 745d 0a20 2020 2020 2020 2077   dict].        w
+0003eba0: 6869 6c65 206e 6f74 2070 6f6c 6963 792e  hile not policy.
+0003ebb0: 646f 6e65 2829 3a0a 2020 2020 2020 2020  done():.        
+0003ebc0: 2020 2020 2320 536c 6565 7020 302e 3031      # Sleep 0.01
+0003ebd0: 7320 7768 656e 2074 6865 7265 2061 7265  s when there are
+0003ebe0: 2034 2074 6173 6b73 206f 7220 6c65 7373   4 tasks or less
+0003ebf0: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0003ec00: 6c65 6570 2030 2e35 7320 7768 656e 2074  leep 0.5s when t
+0003ec10: 6865 7265 2061 7265 2032 3030 206f 7220  here are 200 or 
+0003ec20: 6d6f 7265 0a20 2020 2020 2020 2020 2020  more.           
+0003ec30: 2070 6f6c 6c5f 696e 7465 7276 616c 203d   poll_interval =
+0003ec40: 206d 6178 2830 2e30 312c 206d 696e 2830   max(0.01, min(0
+0003ec50: 2e35 2c20 6c65 6e28 7773 2e68 6173 5f77  .5, len(ws.has_w
+0003ec60: 6861 7429 202f 2034 3030 2929 0a20 2020  hat) / 400)).   
+0003ec70: 2020 2020 2020 2020 2061 7761 6974 2061           await a
+0003ec80: 7379 6e63 696f 2e73 6c65 6570 2870 6f6c  syncio.sleep(pol
+0003ec90: 6c5f 696e 7465 7276 616c 290a 0a20 2020  l_interval)..   
+0003eca0: 2020 2020 2069 6620 706f 6c69 6379 2e6e       if policy.n
+0003ecb0: 6f5f 7265 6369 7069 656e 7473 3a0a 2020  o_recipients:.  
+0003ecc0: 2020 2020 2020 2020 2020 2320 4162 6f72            # Abor
+0003ecd0: 7420 7265 7469 7265 6d65 6e74 2e20 5468  t retirement. Th
+0003ece0: 6973 2074 696d 6520 7765 2064 6f6e 2774  is time we don't
+0003ecf0: 206e 6565 6420 746f 2077 6f72 7279 2061   need to worry a
+0003ed00: 626f 7574 2072 6163 650a 2020 2020 2020  bout race.      
+0003ed10: 2020 2020 2020 2320 636f 6e64 6974 696f        # conditio
+0003ed20: 6e73 2061 6e64 2077 6520 6361 6e20 7761  ns and we can wa
+0003ed30: 6974 2066 6f72 2061 2073 6368 6564 756c  it for a schedul
+0003ed40: 6572 2d3e 776f 726b 6572 2d3e 7363 6865  er->worker->sche
+0003ed50: 6475 6c65 720a 2020 2020 2020 2020 2020  duler.          
+0003ed60: 2020 2320 726f 756e 642d 7472 6970 2e0a    # round-trip..
+0003ed70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0003ed80: 2e73 7472 6561 6d5f 636f 6d6d 735b 7773  .stream_comms[ws
+0003ed90: 2e61 6464 7265 7373 5d2e 7365 6e64 280a  .address].send(.
+0003eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003edb0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+0003edc0: 2020 2020 2020 226f 7022 3a20 2277 6f72        "op": "wor
+0003edd0: 6b65 722d 7374 6174 7573 2d63 6861 6e67  ker-status-chang
+0003ede0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+0003edf0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+0003ee00: 3a20 7072 6576 5f73 7461 7475 732e 6e61  : prev_status.na
+0003ee10: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+0003ee20: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0003ee30: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+0003ee40: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0003ee50: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+0003ee60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003ee70: 7265 7475 726e 204e 6f6e 652c 207b 7d0a  return None, {}.
+0003ee80: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0003ee90: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+0003eea0: 2020 2022 416c 6c20 756e 6971 7565 206b     "All unique k
+0003eeb0: 6579 7320 6f6e 2077 6f72 6b65 7220 2573  eys on worker %s
+0003eec0: 2068 6176 6520 6265 656e 2072 6570 6c69   have been repli
+0003eed0: 6361 7465 6420 656c 7365 7768 6572 6522  cated elsewhere"
+0003eee0: 2c20 7773 2e61 6464 7265 7373 0a20 2020  , ws.address.   
+0003eef0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0003ef00: 6966 2072 656d 6f76 653a 0a20 2020 2020  if remove:.     
+0003ef10: 2020 2020 2020 2061 7761 6974 2073 656c         await sel
+0003ef20: 662e 7265 6d6f 7665 5f77 6f72 6b65 7228  f.remove_worker(
+0003ef30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ef40: 2077 732e 6164 6472 6573 732c 2073 6166   ws.address, saf
+0003ef50: 653d 5472 7565 2c20 636c 6f73 653d 636c  e=True, close=cl
+0003ef60: 6f73 652c 2073 7469 6d75 6c75 735f 6964  ose, stimulus_id
+0003ef70: 3d73 7469 6d75 6c75 735f 6964 0a20 2020  =stimulus_id.   
+0003ef80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0003ef90: 2020 2065 6c69 6620 636c 6f73 653a 0a20     elif close:. 
+0003efa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0003efb0: 636c 6f73 655f 776f 726b 6572 2877 732e  close_worker(ws.
+0003efc0: 6164 6472 6573 7329 0a0a 2020 2020 2020  address)..      
+0003efd0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
+0003efe0: 6574 6972 6564 2077 6f72 6b65 7220 2573  etired worker %s
+0003eff0: 222c 2077 732e 6164 6472 6573 7329 0a20  ", ws.address). 
+0003f000: 2020 2020 2020 2072 6574 7572 6e20 7773         return ws
+0003f010: 2e61 6464 7265 7373 2c20 7773 2e69 6465  .address, ws.ide
+0003f020: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
+0003f030: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
+0003f040: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
+0003f050: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
+0003f060: 6563 7469 6f6e 5b73 7472 5d20 3d20 2829  ection[str] = ()
+0003f070: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+0003f080: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+0003f090: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
+0003f0a0: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
+0003f0b0: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
+0003f0c0: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
+0003f0d0: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
+0003f0e0: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
+0003f0f0: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
+0003f100: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
+0003f110: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
+0003f120: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
+0003f130: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
+0003f140: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
+0003f150: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
+0003f160: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
+0003f170: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
+0003f180: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0003f190: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
+0003f1a0: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
+0003f1b0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0003f1c0: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
+0003f1d0: 2020 2020 2020 2020 7773 3a20 576f 726b          ws: Work
+0003f1e0: 6572 5374 6174 6520 3d20 7365 6c66 2e77  erState = self.w
+0003f1f0: 6f72 6b65 7273 5b77 6f72 6b65 725d 0a20  orkers[worker]. 
+0003f200: 2020 2020 2020 2072 6564 756e 6461 6e74         redundant
+0003f210: 5f72 6570 6c69 6361 7320 3d20 5b5d 0a20  _replicas = []. 
+0003f220: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+0003f230: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0003f240: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0003f250: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0003f260: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+0003f270: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2074  s not None and t
+0003f280: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+0003f290: 7279 223a 0a20 2020 2020 2020 2020 2020  ry":.           
+0003f2a0: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
+0003f2b0: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0003f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2d0: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
+0003f2e0: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0003f2f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003f300: 2020 2020 2020 2020 2020 2020 2072 6564               red
+0003f310: 756e 6461 6e74 5f72 6570 6c69 6361 732e  undant_replicas.
+0003f320: 6170 7065 6e64 286b 6579 290a 0a20 2020  append(key)..   
+0003f330: 2020 2020 2069 6620 7265 6475 6e64 616e       if redundan
+0003f340: 745f 7265 706c 6963 6173 3a0a 2020 2020  t_replicas:.    
+0003f350: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0003f360: 7469 6d75 6c75 735f 6964 3a0a 2020 2020  timulus_id:.    
+0003f370: 2020 2020 2020 2020 2020 2020 7374 696d              stim
+0003f380: 756c 7573 5f69 6420 3d20 6622 7265 6475  ulus_id = f"redu
+0003f390: 6e64 616e 742d 7265 706c 6963 6173 2d7b  ndant-replicas-{
+0003f3a0: 7469 6d65 2829 7d22 0a20 2020 2020 2020  time()}".       
+0003f3b0: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
+0003f3c0: 5f73 656e 6428 0a20 2020 2020 2020 2020  _send(.         
+0003f3d0: 2020 2020 2020 2077 6f72 6b65 722c 0a20         worker,. 
+0003f3e0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+0003f3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f400: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
+0003f410: 7665 2d72 6570 6c69 6361 7322 2c0a 2020  ve-replicas",.  
+0003f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f430: 2020 226b 6579 7322 3a20 7265 6475 6e64    "keys": redund
+0003f440: 616e 745f 7265 706c 6963 6173 2c0a 2020  ant_replicas,.  
+0003f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f460: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0003f470: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
+0003f480: 2020 2020 2020 2020 2020 2020 2020 7d2c                },
+0003f490: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0003f4a0: 2020 2020 2020 2020 7265 7475 726e 2022          return "
+0003f4b0: 4f4b 220a 0a20 2020 2040 6c6f 675f 6572  OK"..    @log_er
+0003f4c0: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
+0003f4d0: 6174 655f 6461 7461 280a 2020 2020 2020  ate_data(.      
+0003f4e0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0003f4f0: 2a2c 0a20 2020 2020 2020 2077 686f 5f68  *,.        who_h
+0003f500: 6173 3a20 6469 6374 5b73 7472 2c20 6c69  as: dict[str, li
+0003f510: 7374 5b73 7472 5d5d 2c0a 2020 2020 2020  st[str]],.      
+0003f520: 2020 6e62 7974 6573 3a20 6469 6374 5b73    nbytes: dict[s
+0003f530: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
+0003f540: 2020 636c 6965 6e74 3a20 7374 7220 7c20    client: str | 
+0003f550: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0003f560: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0003f570: 2020 2020 2222 224c 6561 726e 2074 6861      """Learn tha
+0003f580: 7420 6e65 7720 6461 7461 2068 6173 2065  t new data has e
+0003f590: 6e74 6572 6564 2074 6865 206e 6574 776f  ntered the netwo
+0003f5a0: 726b 2066 726f 6d20 616e 2065 7874 6572  rk from an exter
+0003f5b0: 6e61 6c20 736f 7572 6365 2222 220a 2020  nal source""".  
+0003f5c0: 2020 2020 2020 7768 6f5f 6861 7320 3d20        who_has = 
+0003f5d0: 7b6b 3a20 5b73 656c 662e 636f 6572 6365  {k: [self.coerce
+0003f5e0: 5f61 6464 7265 7373 2876 7629 2066 6f72  _address(vv) for
+0003f5f0: 2076 7620 696e 2076 5d20 666f 7220 6b2c   vv in v] for k,
+0003f600: 2076 2069 6e20 7768 6f5f 6861 732e 6974   v in who_has.it
+0003f610: 656d 7328 297d 0a20 2020 2020 2020 206c  ems()}.        l
+0003f620: 6f67 6765 722e 6465 6275 6728 2255 7064  ogger.debug("Upd
+0003f630: 6174 6520 6461 7461 2025 7322 2c20 7768  ate data %s", wh
+0003f640: 6f5f 6861 7329 0a0a 2020 2020 2020 2020  o_has)..        
+0003f650: 666f 7220 6b65 792c 2077 6f72 6b65 7273  for key, workers
+0003f660: 2069 6e20 7768 6f5f 6861 732e 6974 656d   in who_has.item
+0003f670: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0003f680: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+0003f690: 2e67 6574 286b 6579 290a 2020 2020 2020  .get(key).      
+0003f6a0: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0003f6b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003f6c0: 2020 2020 2074 7320 3d20 7365 6c66 2e6e       ts = self.n
+0003f6d0: 6577 5f74 6173 6b28 6b65 792c 204e 6f6e  ew_task(key, Non
+0003f6e0: 652c 2022 6d65 6d6f 7279 2229 0a20 2020  e, "memory").   
+0003f6f0: 2020 2020 2020 2020 2074 732e 7374 6174           ts.stat
+0003f700: 6520 3d20 226d 656d 6f72 7922 0a20 2020  e = "memory".   
+0003f710: 2020 2020 2020 2020 2074 735f 6e62 7974           ts_nbyt
+0003f720: 6573 203d 206e 6279 7465 732e 6765 7428  es = nbytes.get(
+0003f730: 6b65 792c 202d 3129 0a20 2020 2020 2020  key, -1).       
+0003f740: 2020 2020 2069 6620 7473 5f6e 6279 7465       if ts_nbyte
+0003f750: 7320 3e3d 2030 3a0a 2020 2020 2020 2020  s >= 0:.        
+0003f760: 2020 2020 2020 2020 7473 2e73 6574 5f6e          ts.set_n
+0003f770: 6279 7465 7328 7473 5f6e 6279 7465 7329  bytes(ts_nbytes)
+0003f780: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
+0003f790: 7220 7720 696e 2077 6f72 6b65 7273 3a0a  r w in workers:.
+0003f7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f7b0: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+0003f7c0: 735b 775d 0a20 2020 2020 2020 2020 2020  s[w].           
+0003f7d0: 2020 2020 2069 6620 7773 206e 6f74 2069       if ws not i
+0003f7e0: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0003f7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f800: 2020 7365 6c66 2e61 6464 5f72 6570 6c69    self.add_repli
+0003f810: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0003f820: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
+0003f830: 7274 287b 226f 7022 3a20 226b 6579 2d69  rt({"op": "key-i
+0003f840: 6e2d 6d65 6d6f 7279 222c 2022 6b65 7922  n-memory", "key"
+0003f850: 3a20 6b65 792c 2022 776f 726b 6572 7322  : key, "workers"
+0003f860: 3a20 6c69 7374 2877 6f72 6b65 7273 297d  : list(workers)}
+0003f870: 290a 0a20 2020 2020 2020 2069 6620 636c  )..        if cl
+0003f880: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
+0003f890: 2020 7365 6c66 2e63 6c69 656e 745f 6465    self.client_de
+0003f8a0: 7369 7265 735f 6b65 7973 286b 6579 733d  sires_keys(keys=
+0003f8b0: 6c69 7374 2877 686f 5f68 6173 292c 2063  list(who_has), c
+0003f8c0: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+0003f8d0: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
+0003f8e0: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
+0003f8f0: 6579 2873 656c 662c 206b 6579 3a20 7374  ey(self, key: st
+0003f900: 722c 202a 2c20 636c 6965 6e74 3a20 7374  r, *, client: st
+0003f910: 7220 7c20 4e6f 6e65 203d 204e 6f6e 6529  r | None = None)
+0003f920: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0003f930: 2020 2e2e 2e0a 0a20 2020 2040 6f76 6572    .....    @over
+0003f940: 6c6f 6164 0a20 2020 2064 6566 2072 6570  load.    def rep
+0003f950: 6f72 745f 6f6e 5f6b 6579 2873 656c 662c  ort_on_key(self,
+0003f960: 202a 2c20 7473 3a20 5461 736b 5374 6174   *, ts: TaskStat
+0003f970: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
+0003f980: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
+0003f990: 204e 6f6e 653a 0a20 2020 2020 2020 202e   None:.        .
+0003f9a0: 2e2e 0a0a 2020 2020 6465 6620 7265 706f  ....    def repo
+0003f9b0: 7274 5f6f 6e5f 6b65 7928 7365 6c66 2c20  rt_on_key(self, 
+0003f9c0: 6b65 793d 4e6f 6e65 2c20 2a2c 2074 733d  key=None, *, ts=
+0003f9d0: 4e6f 6e65 2c20 636c 6965 6e74 3d4e 6f6e  None, client=Non
+0003f9e0: 6529 3a0a 2020 2020 2020 2020 6966 2028  e):.        if (
+0003f9f0: 7473 2069 7320 4e6f 6e65 2920 3d3d 2028  ts is None) == (
+0003fa00: 6b65 7920 6973 204e 6f6e 6529 3a0a 2020  key is None):.  
+0003fa10: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0003fa20: 5661 6c75 6545 7272 6f72 2820 2023 2070  ValueError(  # p
+0003fa30: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
+0003fa40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003fa50: 2274 7320 616e 6420 6b65 7920 6172 6520  "ts and key are 
+0003fa60: 6d75 7475 616c 6c79 2065 7863 6c75 7369  mutually exclusi
+0003fa70: 7665 3b20 7265 6365 6976 6564 207b 6b65  ve; received {ke
+0003fa80: 793d 2172 7d2c 207b 7473 3d21 727d 220a  y=!r}, {ts=!r}".
+0003fa90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0003faa0: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0003fab0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0003fac0: 2061 7373 6572 7420 6b65 7920 6973 206e   assert key is n
+0003fad0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+0003fae0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0003faf0: 736b 732e 6765 7428 6b65 7929 0a20 2020  sks.get(key).   
+0003fb00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003fb10: 2020 2020 2020 206b 6579 203d 2074 732e         key = ts.
+0003fb20: 6b65 790a 0a20 2020 2020 2020 2069 6620  key..        if 
+0003fb30: 7473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ts is not None:.
+0003fb40: 2020 2020 2020 2020 2020 2020 7265 706f              repo
+0003fb50: 7274 5f6d 7367 203d 205f 7461 736b 5f74  rt_msg = _task_t
+0003fb60: 6f5f 7265 706f 7274 5f6d 7367 2874 7329  o_report_msg(ts)
+0003fb70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0003fb80: 2020 2020 2020 2020 2020 2072 6570 6f72             repor
+0003fb90: 745f 6d73 6720 3d20 7b22 6f70 223a 2022  t_msg = {"op": "
+0003fba0: 6361 6e63 656c 6c65 642d 6b65 7973 222c  cancelled-keys",
+0003fbb0: 2022 6b65 7973 223a 205b 6b65 795d 7d0a   "keys": [key]}.
+0003fbc0: 2020 2020 2020 2020 6966 2072 6570 6f72          if repor
+0003fbd0: 745f 6d73 6720 6973 206e 6f74 204e 6f6e  t_msg is not Non
+0003fbe0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0003fbf0: 656c 662e 7265 706f 7274 2872 6570 6f72  elf.report(repor
+0003fc00: 745f 6d73 672c 2074 733d 7473 2c20 636c  t_msg, ts=ts, cl
+0003fc10: 6965 6e74 3d63 6c69 656e 7429 0a0a 2020  ient=client)..  
+0003fc20: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+0003fc30: 2020 6173 796e 6320 6465 6620 6665 6564    async def feed
+0003fc40: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0003fc50: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
+0003fc60: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
+0003fc70: 7469 6f6e 3a20 6279 7465 7320 7c20 4e6f  tion: bytes | No
+0003fc80: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003fc90: 2020 2073 6574 7570 3a20 6279 7465 7320     setup: bytes 
+0003fca0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003fcb0: 2020 2020 2020 2074 6561 7264 6f77 6e3a         teardown:
+0003fcc0: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
+0003fcd0: 4e6f 6e65 2c0a 2020 2020 2020 2020 696e  None,.        in
+0003fce0: 7465 7276 616c 3a20 7374 7220 7c20 666c  terval: str | fl
+0003fcf0: 6f61 7420 3d20 2231 7322 2c0a 2020 2020  oat = "1s",.    
+0003fd00: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+0003fd10: 792c 0a20 2020 2029 202d 3e20 4e6f 6e65  y,.    ) -> None
+0003fd20: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0003fd30: 2020 2020 2020 5072 6f76 6964 6573 2061        Provides a
+0003fd40: 2064 6174 6120 436f 6d6d 2074 6f20 6578   data Comm to ex
+0003fd50: 7465 726e 616c 2072 6571 7565 7374 6572  ternal requester
+0003fd60: 0a0a 2020 2020 2020 2020 4361 7574 696f  ..        Cautio
+0003fd70: 6e3a 2074 6869 7320 7275 6e73 2061 7262  n: this runs arb
+0003fd80: 6974 7261 7279 2050 7974 686f 6e20 636f  itrary Python co
+0003fd90: 6465 206f 6e20 7468 6520 7363 6865 6475  de on the schedu
+0003fda0: 6c65 722e 2020 5468 6973 2073 686f 756c  ler.  This shoul
+0003fdb0: 640a 2020 2020 2020 2020 6576 656e 7475  d.        eventu
+0003fdc0: 616c 6c79 2062 6520 7068 6173 6564 206f  ally be phased o
+0003fdd0: 7574 2e20 2049 7420 6973 206d 6f73 746c  ut.  It is mostl
+0003fde0: 7920 7573 6564 2062 7920 6469 6167 6e6f  y used by diagno
+0003fdf0: 7374 6963 732e 0a20 2020 2020 2020 2022  stics..        "
+0003fe00: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+0003fe10: 7420 6461 736b 2e63 6f6e 6669 672e 6765  t dask.config.ge
+0003fe20: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
+0003fe30: 6368 6564 756c 6572 2e70 6963 6b6c 6522  cheduler.pickle"
+0003fe40: 293a 0a20 2020 2020 2020 2020 2020 206c  ):.            l
+0003fe50: 6f67 6765 722e 7761 726e 696e 6728 0a20  ogger.warning(. 
+0003fe60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0003fe70: 5472 6965 6420 746f 2063 616c 6c20 2766  Tried to call 'f
+0003fe80: 6565 6427 2072 6f75 7465 2077 6974 6820  eed' route with 
+0003fe90: 6375 7374 6f6d 2066 756e 6374 696f 6e73  custom functions
+0003fea0: 2c20 6275 7420 220a 2020 2020 2020 2020  , but ".        
+0003feb0: 2020 2020 2020 2020 2270 6963 6b6c 6520          "pickle 
+0003fec0: 6973 2064 6973 616c 6c6f 7765 642e 2020  is disallowed.  
+0003fed0: 5365 7420 7468 6520 2764 6973 7472 6962  Set the 'distrib
+0003fee0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0003fef0: 6963 6b6c 6527 220a 2020 2020 2020 2020  ickle'".        
+0003ff00: 2020 2020 2020 2020 2263 6f6e 6669 6720          "config 
+0003ff10: 7661 6c75 6520 746f 2054 7275 6520 746f  value to True to
+0003ff20: 2075 7365 2074 6865 2027 6665 6564 2720   use the 'feed' 
+0003ff30: 726f 7574 6520 2874 6869 7320 6973 206d  route (this is m
+0003ff40: 6f73 746c 7920 220a 2020 2020 2020 2020  ostly ".        
+0003ff50: 2020 2020 2020 2020 2263 6f6d 6d6f 6e6c          "commonl
+0003ff60: 7920 7573 6564 2077 6974 6820 7072 6f67  y used with prog
+0003ff70: 7265 7373 2062 6172 7329 220a 2020 2020  ress bars)".    
+0003ff80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0003ff90: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+0003ffa0: 2020 2020 2020 696e 7465 7276 616c 203d        interval =
+0003ffb0: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+0003ffc0: 2869 6e74 6572 7661 6c29 0a20 2020 2020  (interval).     
+0003ffd0: 2020 2069 6620 6675 6e63 7469 6f6e 3a0a     if function:.
+0003ffe0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
+0003fff0: 7469 6f6e 203d 2070 6963 6b6c 652e 6c6f  tion = pickle.lo
+00040000: 6164 7328 6675 6e63 7469 6f6e 290a 2020  ads(function).  
+00040010: 2020 2020 2020 6966 2073 6574 7570 3a0a        if setup:.
+00040020: 2020 2020 2020 2020 2020 2020 7365 7475              setu
+00040030: 7020 3d20 7069 636b 6c65 2e6c 6f61 6473  p = pickle.loads
+00040040: 2873 6574 7570 290a 0a20 2020 2020 2020  (setup)..       
+00040050: 2069 6620 7465 6172 646f 776e 3a0a 2020   if teardown:.  
+00040060: 2020 2020 2020 2020 2020 7465 6172 646f            teardo
+00040070: 776e 203d 2070 6963 6b6c 652e 6c6f 6164  wn = pickle.load
+00040080: 7328 7465 6172 646f 776e 290a 2020 2020  s(teardown).    
+00040090: 2020 2020 7374 6174 6520 3d20 7365 7475      state = setu
+000400a0: 7028 7365 6c66 2920 6966 2073 6574 7570  p(self) if setup
+000400b0: 2065 6c73 6520 4e6f 6e65 2020 2320 7479   else None  # ty
+000400c0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+000400d0: 2020 2069 6620 696e 7370 6563 742e 6973     if inspect.is
+000400e0: 6177 6169 7461 626c 6528 7374 6174 6529  awaitable(state)
+000400f0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00040100: 6174 6520 3d20 6177 6169 7420 7374 6174  ate = await stat
+00040110: 650a 2020 2020 2020 2020 7472 793a 0a20  e.        try:. 
+00040120: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+00040130: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
+00040140: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+00040150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040160: 6966 2073 7461 7465 2069 7320 4e6f 6e65  if state is None
+00040170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040180: 2020 2020 2020 7265 7370 6f6e 7365 203d        response =
+00040190: 2066 756e 6374 696f 6e28 7365 6c66 2920   function(self) 
+000401a0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
+000401b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000401c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000401d0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000401e0: 7365 203d 2066 756e 6374 696f 6e28 7365  se = function(se
+000401f0: 6c66 2c20 7374 6174 6529 2020 2320 7479  lf, state)  # ty
+00040200: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
+00040210: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00040220: 2063 6f6d 6d2e 7772 6974 6528 7265 7370   comm.write(resp
+00040230: 6f6e 7365 290a 2020 2020 2020 2020 2020  onse).          
+00040240: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+00040250: 6369 6f2e 736c 6565 7028 696e 7465 7276  cio.sleep(interv
+00040260: 616c 290a 2020 2020 2020 2020 6578 6365  al).        exce
+00040270: 7074 204f 5345 7272 6f72 3a0a 2020 2020  pt OSError:.    
+00040280: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00040290: 2020 2020 2066 696e 616c 6c79 3a0a 2020       finally:.  
+000402a0: 2020 2020 2020 2020 2020 6966 2074 6561            if tea
+000402b0: 7264 6f77 6e3a 0a20 2020 2020 2020 2020  rdown:.         
+000402c0: 2020 2020 2020 2074 6561 7264 6f77 6e28         teardown(
+000402d0: 7365 6c66 2c20 7374 6174 6529 2020 2320  self, state)  # 
+000402e0: 7479 7065 3a20 6967 6e6f 7265 0a0a 2020  type: ignore..  
+000402f0: 2020 6465 6620 6c6f 675f 776f 726b 6572    def log_worker
+00040300: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00040310: 7365 6c66 2c20 776f 726b 6572 3a20 7374  self, worker: st
+00040320: 722c 2074 6f70 6963 3a20 7374 7220 7c20  r, topic: str | 
+00040330: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
+00040340: 206d 7367 3a20 416e 790a 2020 2020 2920   msg: Any.    ) 
+00040350: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00040360: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+00040370: 7367 2c20 6469 6374 293a 0a20 2020 2020  sg, dict):.     
+00040380: 2020 2020 2020 206d 7367 5b22 776f 726b         msg["work
+00040390: 6572 225d 203d 2077 6f72 6b65 720a 2020  er"] = worker.  
+000403a0: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+000403b0: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
+000403c0: 0a0a 2020 2020 6465 6620 7375 6273 6372  ..    def subscr
+000403d0: 6962 655f 776f 726b 6572 5f73 7461 7475  ibe_worker_statu
+000403e0: 7328 7365 6c66 2c20 636f 6d6d 3a20 436f  s(self, comm: Co
+000403f0: 6d6d 2920 2d3e 2073 7472 3a0a 2020 2020  mm) -> str:.    
+00040400: 2020 2020 576f 726b 6572 5374 6174 7573      WorkerStatus
+00040410: 506c 7567 696e 2873 656c 662c 2063 6f6d  Plugin(self, com
+00040420: 6d29 0a20 2020 2020 2020 2069 6465 6e74  m).        ident
+00040430: 203d 2073 656c 662e 6964 656e 7469 7479   = self.identity
+00040440: 2829 0a20 2020 2020 2020 2066 6f72 2076  ().        for v
+00040450: 2069 6e20 6964 656e 745b 2277 6f72 6b65   in ident["worke
+00040460: 7273 225d 2e76 616c 7565 7328 293a 0a20  rs"].values():. 
+00040470: 2020 2020 2020 2020 2020 2064 656c 2076             del v
+00040480: 5b22 6d65 7472 6963 7322 5d0a 2020 2020  ["metrics"].    
+00040490: 2020 2020 2020 2020 6465 6c20 765b 226c          del v["l
+000404a0: 6173 745f 7365 656e 225d 0a20 2020 2020  ast_seen"].     
+000404b0: 2020 2072 6574 7572 6e20 6964 656e 740a     return ident.
+000404c0: 0a20 2020 2064 6566 2067 6574 5f70 726f  .    def get_pro
+000404d0: 6365 7373 696e 6728 0a20 2020 2020 2020  cessing(.       
+000404e0: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
+000404f0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+00040500: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+00040510: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
+00040520: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
+00040530: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+00040540: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00040550: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00040560: 2073 6574 286d 6170 2873 656c 662e 636f   set(map(self.co
+00040570: 6572 6365 5f61 6464 7265 7373 2c20 776f  erce_address, wo
+00040580: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
+00040590: 2020 2020 7265 7475 726e 207b 773a 205b      return {w: [
+000405a0: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+000405b0: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+000405c0: 2e70 726f 6365 7373 696e 675d 2066 6f72  .processing] for
+000405d0: 2077 2069 6e20 776f 726b 6572 737d 0a20   w in workers}. 
+000405e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000405f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00040600: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00040610: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
+00040620: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
+00040630: 7369 6e67 5d20 666f 7220 772c 2077 7320  sing] for w, ws 
+00040640: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+00040650: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+00040660: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+00040670: 6574 5f77 686f 5f68 6173 2873 656c 662c  et_who_has(self,
+00040680: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
+00040690: 7374 725d 207c 204e 6f6e 6520 3d20 4e6f  str] | None = No
+000406a0: 6e65 2920 2d3e 2064 6963 745b 7374 722c  ne) -> dict[str,
+000406b0: 206c 6973 745b 7374 725d 5d3a 0a20 2020   list[str]]:.   
+000406c0: 2020 2020 2069 6620 6b65 7973 2069 7320       if keys is 
+000406d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000406e0: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+000406f0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00040700: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
+00040710: 666f 7220 7773 2069 6e20 7365 6c66 2e74  for ws in self.t
+00040720: 6173 6b73 5b6b 6579 5d2e 7768 6f5f 6861  asks[key].who_ha
+00040730: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00040740: 2020 2069 6620 6b65 7920 696e 2073 656c     if key in sel
+00040750: 662e 7461 736b 730a 2020 2020 2020 2020  f.tasks.        
+00040760: 2020 2020 2020 2020 656c 7365 205b 5d0a          else [].
+00040770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040780: 666f 7220 6b65 7920 696e 206b 6579 730a  for key in keys.
+00040790: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+000407a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000407b0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+000407c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000407d0: 206b 6579 3a20 5b77 732e 6164 6472 6573   key: [ws.addres
+000407e0: 7320 666f 7220 7773 2069 6e20 7473 2e77  s for ws in ts.w
+000407f0: 686f 5f68 6173 5d20 666f 7220 6b65 792c  ho_has] for key,
+00040800: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
+00040810: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+00040820: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
+00040830: 2067 6574 5f68 6173 5f77 6861 7428 0a20   get_has_what(. 
+00040840: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+00040850: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
+00040860: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+00040870: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
+00040880: 7374 722c 206c 6973 745b 7374 725d 5d3a  str, list[str]]:
+00040890: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+000408a0: 6572 7320 6973 206e 6f74 204e 6f6e 653a  ers is not None:
+000408b0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+000408c0: 6b65 7273 203d 206d 6170 2873 656c 662e  kers = map(self.
+000408d0: 636f 6572 6365 5f61 6464 7265 7373 2c20  coerce_address, 
+000408e0: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+000408f0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+00040900: 2020 2020 2020 2020 2020 2020 2020 773a                w:
+00040910: 205b 7473 2e6b 6579 2066 6f72 2074 7320   [ts.key for ts 
+00040920: 696e 2073 656c 662e 776f 726b 6572 735b  in self.workers[
+00040930: 775d 2e68 6173 5f77 6861 745d 0a20 2020  w].has_what].   
+00040940: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00040950: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
+00040960: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00040970: 2020 656c 7365 205b 5d0a 2020 2020 2020    else [].      
+00040980: 2020 2020 2020 2020 2020 666f 7220 7720            for w 
+00040990: 696e 2077 6f72 6b65 7273 0a20 2020 2020  in workers.     
+000409a0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+000409b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000409c0: 2020 2072 6574 7572 6e20 7b77 3a20 5b74     return {w: [t
+000409d0: 732e 6b65 7920 666f 7220 7473 2069 6e20  s.key for ts in 
+000409e0: 7773 2e68 6173 5f77 6861 745d 2066 6f72  ws.has_what] for
+000409f0: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
+00040a00: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
+00040a10: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
+00040a20: 7265 7328 7365 6c66 2c20 776f 726b 6572  res(self, worker
+00040a30: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+00040a40: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00040a50: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
+00040a60: 5d3a 0a20 2020 2020 2020 2069 6620 776f  ]:.        if wo
+00040a70: 726b 6572 7320 6973 206e 6f74 204e 6f6e  rkers is not Non
+00040a80: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
+00040a90: 6f72 6b65 7273 203d 206d 6170 2873 656c  orkers = map(sel
+00040aa0: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+00040ab0: 2c20 776f 726b 6572 7329 0a20 2020 2020  , workers).     
+00040ac0: 2020 2020 2020 2072 6574 7572 6e20 7b77         return {w
+00040ad0: 3a20 7365 6c66 2e77 6f72 6b65 7273 5b77  : self.workers[w
+00040ae0: 5d2e 6e74 6872 6561 6473 2066 6f72 2077  ].nthreads for w
+00040af0: 2069 6e20 776f 726b 6572 7320 6966 2077   in workers if w
+00040b00: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00040b10: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
+00040b20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00040b30: 726e 207b 773a 2077 732e 6e74 6872 6561  rn {w: ws.nthrea
+00040b40: 6473 2066 6f72 2077 2c20 7773 2069 6e20  ds for w, ws in 
+00040b50: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
+00040b60: 6d73 2829 7d0a 0a20 2020 2064 6566 2067  ms()}..    def g
+00040b70: 6574 5f6e 636f 7265 735f 7275 6e6e 696e  et_ncores_runnin
+00040b80: 6728 0a20 2020 2020 2020 2073 656c 662c  g(.        self,
+00040b90: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
+00040ba0: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
+00040bb0: 204e 6f6e 650a 2020 2020 2920 2d3e 2064   None.    ) -> d
+00040bc0: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+00040bd0: 2020 2020 2020 206e 636f 7265 7320 3d20         ncores = 
+00040be0: 7365 6c66 2e67 6574 5f6e 636f 7265 7328  self.get_ncores(
+00040bf0: 776f 726b 6572 733d 776f 726b 6572 7329  workers=workers)
+00040c00: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00040c10: 7b0a 2020 2020 2020 2020 2020 2020 773a  {.            w:
+00040c20: 206e 2066 6f72 2077 2c20 6e20 696e 206e   n for w, n in n
+00040c30: 636f 7265 732e 6974 656d 7328 2920 6966  cores.items() if
+00040c40: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+00040c50: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+00040c60: 732e 7275 6e6e 696e 670a 2020 2020 2020  s.running.      
+00040c70: 2020 7d0a 0a20 2020 2061 7379 6e63 2064    }..    async d
+00040c80: 6566 2067 6574 5f63 616c 6c5f 7374 6163  ef get_call_stac
+00040c90: 6b28 7365 6c66 2c20 6b65 7973 3a20 4974  k(self, keys: It
+00040ca0: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00040cb0: 6e65 203d 204e 6f6e 6529 202d 3e20 6469  ne = None) -> di
+00040cc0: 6374 3a0a 2020 2020 2020 2020 776f 726b  ct:.        work
+00040cd0: 6572 733a 2064 6963 745b 7374 722c 206c  ers: dict[str, l
+00040ce0: 6973 745b 7374 725d 207c 204e 6f6e 655d  ist[str] | None]
+00040cf0: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
+00040d00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00040d10: 2020 2020 2020 2020 2020 7374 6163 6b20            stack 
+00040d20: 3d20 6c69 7374 286b 6579 7329 0a20 2020  = list(keys).   
+00040d30: 2020 2020 2020 2020 2070 726f 6365 7373           process
+00040d40: 696e 6720 3d20 7365 7428 290a 2020 2020  ing = set().    
+00040d50: 2020 2020 2020 2020 7768 696c 6520 7374          while st
+00040d60: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
+00040d70: 2020 2020 206b 6579 203d 2073 7461 636b       key = stack
+00040d80: 2e70 6f70 2829 0a20 2020 2020 2020 2020  .pop().         
+00040d90: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00040da0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00040db0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+00040dc0: 732e 7374 6174 6520 3d3d 2022 7761 6974  s.state == "wait
+00040dd0: 696e 6722 3a0a 2020 2020 2020 2020 2020  ing":.          
+00040de0: 2020 2020 2020 2020 2020 7374 6163 6b2e            stack.
+00040df0: 6578 7465 6e64 285b 6474 732e 6b65 7920  extend([dts.key 
+00040e00: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00040e10: 7065 6e64 656e 6369 6573 5d29 0a20 2020  pendencies]).   
+00040e20: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00040e30: 6620 7473 2e73 7461 7465 203d 3d20 2270  f ts.state == "p
+00040e40: 726f 6365 7373 696e 6722 3a0a 2020 2020  rocessing":.    
+00040e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040e60: 7072 6f63 6573 7369 6e67 2e61 6464 2874  processing.add(t
+00040e70: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
+00040e80: 776f 726b 6572 7320 3d20 6465 6661 756c  workers = defaul
+00040e90: 7464 6963 7428 6c69 7374 290a 2020 2020  tdict(list).    
+00040ea0: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+00040eb0: 6e20 7072 6f63 6573 7369 6e67 3a0a 2020  n processing:.  
+00040ec0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00040ed0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00040ee0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00040ef0: 2020 2020 2020 2077 6b65 7973 203d 2077         wkeys = w
+00040f00: 6f72 6b65 7273 5b74 732e 7072 6f63 6573  orkers[ts.proces
+00040f10: 7369 6e67 5f6f 6e2e 6164 6472 6573 735d  sing_on.address]
+00040f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00040f30: 2020 2020 2061 7373 6572 7420 776b 6579       assert wkey
+00040f40: 7320 6973 206e 6f74 204e 6f6e 650a 2020  s is not None.  
+00040f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040f60: 2020 776b 6579 732e 6170 7065 6e64 2874    wkeys.append(t
+00040f70: 732e 6b65 7929 0a20 2020 2020 2020 2065  s.key).        e
+00040f80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00040f90: 2077 6f72 6b65 7273 203d 207b 773a 204e   workers = {w: N
+00040fa0: 6f6e 6520 666f 7220 7720 696e 2073 656c  one for w in sel
+00040fb0: 662e 776f 726b 6572 737d 0a0a 2020 2020  f.workers}..    
+00040fc0: 2020 2020 6966 206e 6f74 2077 6f72 6b65      if not worke
+00040fd0: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00040fe0: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
+00040ff0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+00041000: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00041010: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00041020: 2873 656c 662e 7270 6328 7729 2e63 616c  (self.rpc(w).cal
+00041030: 6c5f 7374 6163 6b28 6b65 7973 3d76 2920  l_stack(keys=v) 
+00041040: 666f 7220 772c 2076 2069 6e20 776f 726b  for w, v in work
+00041050: 6572 732e 6974 656d 7328 2929 0a20 2020  ers.items()).   
+00041060: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00041070: 6573 706f 6e73 6520 3d20 7b77 3a20 7220  esponse = {w: r 
+00041080: 666f 7220 772c 2072 2069 6e20 7a69 7028  for w, r in zip(
+00041090: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
+000410a0: 2920 6966 2072 7d0a 2020 2020 2020 2020  ) if r}.        
+000410b0: 7265 7475 726e 2072 6573 706f 6e73 650a  return response.
+000410c0: 0a20 2020 2061 7379 6e63 2064 6566 2062  .    async def b
+000410d0: 656e 6368 6d61 726b 5f68 6172 6477 6172  enchmark_hardwar
+000410e0: 6528 7365 6c66 2920 2d3e 2022 6469 6374  e(self) -> "dict
+000410f0: 5b73 7472 2c20 6469 6374 5b73 7472 2c20  [str, dict[str, 
+00041100: 666c 6f61 745d 5d22 3a0a 2020 2020 2020  float]]":.      
+00041110: 2020 2222 220a 2020 2020 2020 2020 5275    """.        Ru
+00041120: 6e20 6120 6265 6e63 686d 6172 6b20 6f6e  n a benchmark on
+00041130: 2074 6865 2077 6f72 6b65 7273 2066 6f72   the workers for
+00041140: 206d 656d 6f72 792c 2064 6973 6b2c 2061   memory, disk, a
+00041150: 6e64 206e 6574 776f 726b 2062 616e 6477  nd network bandw
+00041160: 6964 7468 730a 0a20 2020 2020 2020 2052  idths..        R
+00041170: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+00041180: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
+00041190: 6573 756c 743a 2064 6963 740a 2020 2020  esult: dict.    
+000411a0: 2020 2020 2020 2020 4120 6469 6374 696f          A dictio
+000411b0: 6e61 7279 206d 6170 7069 6e67 2074 6865  nary mapping the
+000411c0: 206e 616d 6573 2022 6469 736b 222c 2022   names "disk", "
+000411d0: 6d65 6d6f 7279 222c 2061 6e64 2022 6e65  memory", and "ne
+000411e0: 7477 6f72 6b22 2074 6f0a 2020 2020 2020  twork" to.      
+000411f0: 2020 2020 2020 6469 6374 696f 6e61 7269        dictionari
+00041200: 6573 206d 6170 7069 6e67 2073 697a 6573  es mapping sizes
+00041210: 2074 6f20 6261 6e64 7769 6474 6873 2e20   to bandwidths. 
+00041220: 2054 6865 7365 2062 616e 6477 6964 7468   These bandwidth
+00041230: 7320 6172 650a 2020 2020 2020 2020 2020  s are.          
+00041240: 2020 6176 6572 6167 6564 206f 7665 7220    averaged over 
+00041250: 6d61 6e79 2077 6f72 6b65 7273 2072 756e  many workers run
+00041260: 6e69 6e67 2063 6f6d 7075 7461 7469 6f6e  ning computation
+00041270: 7320 6163 726f 7373 2074 6865 2063 6c75  s across the clu
+00041280: 7374 6572 2e0a 2020 2020 2020 2020 2222  ster..        ""
+00041290: 220a 2020 2020 2020 2020 6f75 743a 2064  ".        out: d
+000412a0: 6963 745b 7374 722c 2064 6566 6175 6c74  ict[str, default
+000412b0: 6469 6374 5b73 7472 2c20 6c69 7374 5b66  dict[str, list[f
+000412c0: 6c6f 6174 5d5d 5d20 3d20 7b0a 2020 2020  loat]]] = {.    
+000412d0: 2020 2020 2020 2020 6e61 6d65 3a20 6465          name: de
+000412e0: 6661 756c 7464 6963 7428 6c69 7374 2920  faultdict(list) 
+000412f0: 666f 7220 6e61 6d65 2069 6e20 5b22 6469  for name in ["di
+00041300: 736b 222c 2022 6d65 6d6f 7279 222c 2022  sk", "memory", "
+00041310: 6e65 7477 6f72 6b22 5d0a 2020 2020 2020  network"].      
+00041320: 2020 7d0a 0a20 2020 2020 2020 2023 2064    }..        # d
+00041330: 6973 6b0a 2020 2020 2020 2020 7265 7375  isk.        resu
+00041340: 6c74 203d 2061 7761 6974 2073 656c 662e  lt = await self.
+00041350: 6272 6f61 6463 6173 7428 6d73 673d 7b22  broadcast(msg={"
+00041360: 6f70 223a 2022 6265 6e63 686d 6172 6b5f  op": "benchmark_
+00041370: 6469 736b 227d 290a 2020 2020 2020 2020  disk"}).        
+00041380: 666f 7220 6420 696e 2072 6573 756c 742e  for d in result.
+00041390: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+000413a0: 2020 2020 2020 666f 7220 7369 7a65 2c20        for size, 
+000413b0: 6475 7261 7469 6f6e 2069 6e20 642e 6974  duration in d.it
+000413c0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+000413d0: 2020 2020 2020 206f 7574 5b22 6469 736b         out["disk
+000413e0: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
+000413f0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
+00041400: 2020 2023 206d 656d 6f72 790a 2020 2020     # memory.    
+00041410: 2020 2020 7265 7375 6c74 203d 2061 7761      result = awa
+00041420: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+00041430: 7428 6d73 673d 7b22 6f70 223a 2022 6265  t(msg={"op": "be
+00041440: 6e63 686d 6172 6b5f 6d65 6d6f 7279 227d  nchmark_memory"}
+00041450: 290a 2020 2020 2020 2020 666f 7220 6420  ).        for d 
+00041460: 696e 2072 6573 756c 742e 7661 6c75 6573  in result.values
+00041470: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00041480: 666f 7220 7369 7a65 2c20 6475 7261 7469  for size, durati
+00041490: 6f6e 2069 6e20 642e 6974 656d 7328 293a  on in d.items():
+000414a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000414b0: 206f 7574 5b22 6d65 6d6f 7279 225d 5b73   out["memory"][s
+000414c0: 697a 655d 2e61 7070 656e 6428 6475 7261  ize].append(dura
+000414d0: 7469 6f6e 290a 0a20 2020 2020 2020 2023  tion)..        #
+000414e0: 206e 6574 776f 726b 0a20 2020 2020 2020   network.       
+000414f0: 2077 6f72 6b65 7273 203d 206c 6973 7428   workers = list(
+00041500: 7365 6c66 2e77 6f72 6b65 7273 290a 2020  self.workers).  
+00041510: 2020 2020 2020 2320 4f6e 2061 6e20 6164        # On an ad
+00041520: 6170 7469 7665 2063 6c75 7374 6572 2c20  aptive cluster, 
+00041530: 6966 206d 756c 7469 706c 6520 776f 726b  if multiple work
+00041540: 6572 7320 6172 6520 7374 6172 7465 6420  ers are started 
+00041550: 6f6e 2074 6865 2073 616d 6520 7068 7973  on the same phys
+00041560: 6963 616c 2068 6f73 742c 0a20 2020 2020  ical host,.     
+00041570: 2020 2023 2074 6865 7920 6172 6520 6d6f     # they are mo
+00041580: 7265 206c 696b 656c 7920 746f 2063 6f6e  re likely to con
+00041590: 6e65 6374 2074 6f20 7468 6520 5363 6865  nect to the Sche
+000415a0: 6475 6c65 7220 696e 2073 6571 7565 6e63  duler in sequenc
+000415b0: 652c 2065 6e64 696e 6720 7570 206e 6578  e, ending up nex
+000415c0: 7420 746f 0a20 2020 2020 2020 2023 2065  t to.        # e
+000415d0: 6163 6820 6f74 6865 7220 696e 2074 6869  ach other in thi
+000415e0: 7320 6c69 7374 2e0a 2020 2020 2020 2020  s list..        
+000415f0: 2320 5468 6520 7472 616e 7366 6572 2073  # The transfer s
+00041600: 7065 6564 2077 6974 6869 6e20 7375 6368  peed within such
+00041610: 2063 6c75 7374 6572 7320 6f66 2077 6f72   clusters of wor
+00041620: 6b65 7273 2077 696c 6c20 6265 2065 6666  kers will be eff
+00041630: 6563 7469 7665 6c79 2074 6861 7420 6f66  ectively that of
+00041640: 0a20 2020 2020 2020 2023 206c 6f63 616c  .        # local
+00041650: 686f 7374 2e20 5468 6973 2063 6f75 6c64  host. This could
+00041660: 2068 6170 7065 6e20 6163 726f 7373 2064   happen across d
+00041670: 6966 6665 7265 6e74 2056 4d73 2061 6e64  ifferent VMs and
+00041680: 2f6f 7220 646f 636b 6572 2069 6d61 6765  /or docker image
+00041690: 732c 2073 6f0a 2020 2020 2020 2020 2320  s, so.        # 
+000416a0: 696d 706c 656d 656e 7469 6e67 206c 6f67  implementing log
+000416b0: 6963 2062 6173 6564 206f 6e20 4950 2061  ic based on IP a
+000416c0: 6464 7265 7373 6573 2077 6f75 6c64 206e  ddresses would n
+000416d0: 6f74 206e 6563 6573 7361 7269 6c79 2068  ot necessarily h
+000416e0: 656c 702e 0a20 2020 2020 2020 2023 2052  elp..        # R
+000416f0: 616e 646f 6d69 7a65 2074 6865 2063 6f6e  andomize the con
+00041700: 6e65 6374 696f 6e73 2074 6f20 6576 656e  nections to even
+00041710: 206f 7574 2074 6865 206d 6561 6e20 6d65   out the mean me
+00041720: 6173 7572 6573 2e0a 2020 2020 2020 2020  asures..        
+00041730: 7261 6e64 6f6d 2e73 6875 6666 6c65 2877  random.shuffle(w
+00041740: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
+00041750: 6675 7475 7265 7320 3d20 5b0a 2020 2020  futures = [.    
+00041760: 2020 2020 2020 2020 7365 6c66 2e72 7063          self.rpc
+00041770: 2861 292e 6265 6e63 686d 6172 6b5f 6e65  (a).benchmark_ne
+00041780: 7477 6f72 6b28 6164 6472 6573 733d 6229  twork(address=b)
+00041790: 2066 6f72 2061 2c20 6220 696e 2070 6172   for a, b in par
+000417a0: 7469 7469 6f6e 2832 2c20 776f 726b 6572  tition(2, worker
+000417b0: 7329 0a20 2020 2020 2020 205d 0a20 2020  s).        ].   
+000417c0: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
+000417d0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+000417e0: 6174 6865 7228 2a66 7574 7572 6573 290a  ather(*futures).
+000417f0: 0a20 2020 2020 2020 2066 6f72 2064 2069  .        for d i
+00041800: 6e20 7265 7370 6f6e 7365 733a 0a20 2020  n responses:.   
+00041810: 2020 2020 2020 2020 2066 6f72 2073 697a           for siz
+00041820: 652c 2064 7572 6174 696f 6e20 696e 2064  e, duration in d
+00041830: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00041840: 2020 2020 2020 2020 2020 6f75 745b 226e            out["n
+00041850: 6574 776f 726b 225d 5b73 697a 655d 2e61  etwork"][size].a
+00041860: 7070 656e 6428 6475 7261 7469 6f6e 290a  ppend(duration).
+00041870: 0a20 2020 2020 2020 2072 6573 756c 7420  .        result 
+00041880: 3d20 7b7d 0a20 2020 2020 2020 2066 6f72  = {}.        for
+00041890: 206d 6f64 6520 696e 206f 7574 3a0a 2020   mode in out:.  
+000418a0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000418b0: 5b6d 6f64 655d 203d 207b 0a20 2020 2020  [mode] = {.     
+000418c0: 2020 2020 2020 2020 2020 2073 697a 653a             size:
+000418d0: 2073 756d 2864 7572 6174 696f 6e73 2920   sum(durations) 
+000418e0: 2f20 6c65 6e28 6475 7261 7469 6f6e 7329  / len(durations)
+000418f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041900: 2066 6f72 2073 697a 652c 2064 7572 6174   for size, durat
+00041910: 696f 6e73 2069 6e20 6f75 745b 6d6f 6465  ions in out[mode
+00041920: 5d2e 6974 656d 7328 290a 2020 2020 2020  ].items().      
+00041930: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00041940: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00041950: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
+00041960: 2020 2020 6465 6620 6765 745f 6e62 7974      def get_nbyt
+00041970: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
+00041980: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+00041990: 5b73 7472 5d20 7c20 4e6f 6e65 203d 204e  [str] | None = N
+000419a0: 6f6e 652c 2073 756d 6d61 7279 3a20 626f  one, summary: bo
+000419b0: 6f6c 203d 2054 7275 650a 2020 2020 2920  ol = True.    ) 
+000419c0: 2d3e 2064 6963 745b 7374 722c 2069 6e74  -> dict[str, int
+000419d0: 5d3a 0a20 2020 2020 2020 2069 6620 6b65  ]:.        if ke
+000419e0: 7973 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ys is not None:.
+000419f0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00041a00: 6c74 203d 207b 6b3a 2073 656c 662e 7461  lt = {k: self.ta
+00041a10: 736b 735b 6b5d 2e6e 6279 7465 7320 666f  sks[k].nbytes fo
+00041a20: 7220 6b20 696e 206b 6579 737d 0a20 2020  r k in keys}.   
+00041a30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00041a40: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+00041a50: 7b6b 3a20 7473 2e6e 6279 7465 7320 666f  {k: ts.nbytes fo
+00041a60: 7220 6b2c 2074 7320 696e 2073 656c 662e  r k, ts in self.
+00041a70: 7461 736b 732e 6974 656d 7328 2920 6966  tasks.items() if
+00041a80: 2074 732e 6e62 7974 6573 203e 3d20 307d   ts.nbytes >= 0}
+00041a90: 0a0a 2020 2020 2020 2020 6966 2073 756d  ..        if sum
+00041aa0: 6d61 7279 3a0a 2020 2020 2020 2020 2020  mary:.          
+00041ab0: 2020 6f75 743a 2064 6566 6175 6c74 6469    out: defaultdi
+00041ac0: 6374 5b73 7472 2c20 696e 745d 203d 2064  ct[str, int] = d
+00041ad0: 6566 6175 6c74 6469 6374 286c 616d 6264  efaultdict(lambd
+00041ae0: 613a 2030 290a 2020 2020 2020 2020 2020  a: 0).          
+00041af0: 2020 666f 7220 6b2c 2076 2069 6e20 7265    for k, v in re
+00041b00: 7375 6c74 2e69 7465 6d73 2829 3a0a 2020  sult.items():.  
+00041b10: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00041b20: 745b 6b65 795f 7370 6c69 7428 6b29 5d20  t[key_split(k)] 
+00041b30: 2b3d 2076 0a20 2020 2020 2020 2020 2020  += v.           
+00041b40: 2072 6573 756c 7420 3d20 6469 6374 286f   result = dict(o
+00041b50: 7574 290a 0a20 2020 2020 2020 2072 6574  ut)..        ret
+00041b60: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
+00041b70: 6465 6620 7275 6e5f 6675 6e63 7469 6f6e  def run_function
+00041b80: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00041b90: 2020 2020 2020 2020 636f 6d6d 3a20 436f          comm: Co
+00041ba0: 6d6d 2c0a 2020 2020 2020 2020 6675 6e63  mm,.        func
+00041bb0: 7469 6f6e 3a20 4361 6c6c 6162 6c65 2c0a  tion: Callable,.
+00041bc0: 2020 2020 2020 2020 6172 6773 3a20 7475          args: tu
+00041bd0: 706c 6520 3d20 2829 2c0a 2020 2020 2020  ple = (),.      
+00041be0: 2020 6b77 6172 6773 3a20 6469 6374 207c    kwargs: dict |
+00041bf0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00041c00: 2020 2020 2020 7761 6974 3a20 626f 6f6c        wait: bool
+00041c10: 203d 2054 7275 652c 0a20 2020 2029 202d   = True,.    ) -
+00041c20: 3e20 416e 793a 0a20 2020 2020 2020 2022  > Any:.        "
+00041c30: 2222 5275 6e20 6120 6675 6e63 7469 6f6e  ""Run a function
+00041c40: 2077 6974 6869 6e20 7468 6973 2070 726f   within this pro
+00041c50: 6365 7373 0a0a 2020 2020 2020 2020 5365  cess..        Se
+00041c60: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+00041c70: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00041c80: 436c 6965 6e74 2e72 756e 5f6f 6e5f 7363  Client.run_on_sc
+00041c90: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+00041ca0: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
+00041cb0: 2064 6973 7472 6962 7574 6564 2e77 6f72   distributed.wor
+00041cc0: 6b65 7220 696d 706f 7274 2072 756e 0a0a  ker import run..
+00041cd0: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+00041ce0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+00041cf0: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+00041d00: 6475 6c65 722e 7069 636b 6c65 2229 3a0a  duler.pickle"):.
+00041d10: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00041d20: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00041d30: 2020 2020 2020 2020 2020 2020 2020 2243                "C
+00041d40: 616e 6e6f 7420 7275 6e20 6675 6e63 7469  annot run functi
+00041d50: 6f6e 2061 7320 7468 6520 7363 6865 6475  on as the schedu
+00041d60: 6c65 7220 6861 7320 6265 656e 2065 7870  ler has been exp
+00041d70: 6c69 6369 746c 7920 6469 7361 6c6c 6f77  licitly disallow
+00041d80: 6564 2066 726f 6d20 220a 2020 2020 2020  ed from ".      
+00041d90: 2020 2020 2020 2020 2020 2264 6573 6572            "deser
+00041da0: 6961 6c69 7a69 6e67 2061 7262 6974 7261  ializing arbitra
+00041db0: 7279 2062 7974 6573 7472 696e 6773 2075  ry bytestrings u
+00041dc0: 7369 6e67 2070 6963 6b6c 6520 7669 6120  sing pickle via 
+00041dd0: 7468 6520 220a 2020 2020 2020 2020 2020  the ".          
+00041de0: 2020 2020 2020 2227 6469 7374 7269 6275        "'distribu
+00041df0: 7465 642e 7363 6865 6475 6c65 722e 7069  ted.scheduler.pi
+00041e00: 636b 6c65 2720 636f 6e66 6967 7572 6174  ckle' configurat
+00041e10: 696f 6e20 7365 7474 696e 672e 220a 2020  ion setting.".  
+00041e20: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00041e30: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
+00041e40: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
+00041e50: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+00041e60: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
+00041e70: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
+00041e80: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
+00041e90: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
+00041ea0: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
+00041eb0: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
+00041ec0: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
+00041ed0: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
+00041ee0: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
+00041ef0: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
+00041f00: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
+00041f10: 733a 206c 6973 745b 7374 725d 2c20 7661  s: list[str], va
+00041f20: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
+00041f30: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
+00041f40: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00041f50: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
+00041f60: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
+00041f70: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
+00041f80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00041f90: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
+00041fa0: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
+00041fb0: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
+00041fc0: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
+00041fd0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+00041fe0: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+00041ff0: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
+00042000: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
+00042010: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
+00042020: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
+00042030: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
+00042040: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
+00042050: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
+00042060: 206c 6973 745b 7374 725d 2c20 6465 6661   list[str], defa
+00042070: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
+00042080: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
+00042090: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+000420a0: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
+000420b0: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
+000420c0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+000420d0: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
+000420e0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000420f0: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
+00042100: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
+00042110: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
+00042120: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
+00042130: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
+00042140: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
+00042150: 756c 7420 213d 206e 6f5f 6465 6661 756c  ult != no_defaul
+00042160: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00042170: 2020 2072 6574 7572 6e20 6465 6661 756c     return defaul
+00042180: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00042190: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000421a0: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
+000421b0: 6566 2073 6574 5f72 6573 7472 6963 7469  ef set_restricti
+000421c0: 6f6e 7328 7365 6c66 2c20 776f 726b 6572  ons(self, worker
+000421d0: 3a20 6469 6374 5b73 7472 2c20 436f 6c6c  : dict[str, Coll
+000421e0: 6563 7469 6f6e 5b73 7472 5d20 7c20 7374  ection[str] | st
+000421f0: 725d 2920 2d3e 204e 6f6e 653a 0a20 2020  r]) -> None:.   
+00042200: 2020 2020 2066 6f72 206b 6579 2c20 7265       for key, re
+00042210: 7374 7269 6374 696f 6e73 2069 6e20 776f  strictions in wo
+00042220: 726b 6572 2e69 7465 6d73 2829 3a0a 2020  rker.items():.  
+00042230: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00042240: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00042250: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00042260: 696e 7374 616e 6365 2872 6573 7472 6963  instance(restric
+00042270: 7469 6f6e 732c 2073 7472 293a 0a20 2020  tions, str):.   
+00042280: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00042290: 7472 6963 7469 6f6e 7320 3d20 7b72 6573  trictions = {res
+000422a0: 7472 6963 7469 6f6e 737d 0a20 2020 2020  trictions}.     
+000422b0: 2020 2020 2020 2074 732e 776f 726b 6572         ts.worker
+000422c0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+000422d0: 7365 7428 7265 7374 7269 6374 696f 6e73  set(restrictions
+000422e0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
+000422f0: 7273 0a20 2020 2064 6566 2067 6574 5f74  rs.    def get_t
+00042300: 6173 6b5f 7072 6566 6978 5f73 7461 7465  ask_prefix_state
+00042310: 7328 7365 6c66 2920 2d3e 2064 6963 745b  s(self) -> dict[
+00042320: 7374 722c 2064 6963 745b 7374 722c 2069  str, dict[str, i
+00042330: 6e74 5d5d 3a0a 2020 2020 2020 2020 7374  nt]]:.        st
+00042340: 6174 6520 3d20 7b7d 0a0a 2020 2020 2020  ate = {}..      
+00042350: 2020 666f 7220 7470 2069 6e20 7365 6c66    for tp in self
+00042360: 2e74 6173 6b5f 7072 6566 6978 6573 2e76  .task_prefixes.v
+00042370: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+00042380: 2020 2020 2061 6374 6976 655f 7374 6174       active_stat
+00042390: 6573 203d 2074 702e 6163 7469 7665 5f73  es = tp.active_s
+000423a0: 7461 7465 730a 2020 2020 2020 2020 2020  tates.          
+000423b0: 2020 6966 2061 6e79 280a 2020 2020 2020    if any(.      
+000423c0: 2020 2020 2020 2020 2020 6163 7469 7665            active
+000423d0: 5f73 7461 7465 732e 6765 7428 7329 0a20  _states.get(s). 
+000423e0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000423f0: 6f72 2073 2069 6e20 7b22 6d65 6d6f 7279  or s in {"memory
+00042400: 222c 2022 6572 7265 6422 2c20 2272 656c  ", "erred", "rel
+00042410: 6561 7365 6422 2c20 2270 726f 6365 7373  eased", "process
+00042420: 696e 6722 2c20 2277 6169 7469 6e67 227d  ing", "waiting"}
+00042430: 0a20 2020 2020 2020 2020 2020 2029 3a0a  .            ):.
+00042440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042450: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
+00042460: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00042470: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
+00042480: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+00042490: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
+000424a0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+000424b0: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
+000424c0: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
+000424d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000424e0: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
+000424f0: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
+00042500: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
+00042510: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+00042520: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
+00042530: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
+00042540: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
+00042550: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
+00042560: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
+00042570: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
+00042580: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00042590: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
+000425a0: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
+000425b0: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
+000425c0: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
+000425d0: 7465 7261 626c 655b 7374 725d 2920 2d3e  terable[str]) ->
+000425e0: 2064 6963 745b 7374 722c 2054 6173 6b53   dict[str, TaskS
+000425f0: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
+00042600: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
+00042610: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
+00042620: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
+00042630: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
+00042640: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+00042650: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
+00042660: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
+00042670: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+00042680: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
+00042690: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000426a0: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
+000426b0: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
+000426c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000426d0: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
+000426e0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
+000426f0: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
+00042700: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
+00042710: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
+00042720: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
+00042730: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
+00042740: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
+00042750: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
+00042760: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
+00042770: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
+00042780: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
+00042790: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
+000427a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000427b0: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
+000427c0: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
+000427d0: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
+000427e0: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
+000427f0: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
+00042800: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
+00042810: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
+00042820: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
+00042830: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
+00042840: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
+00042850: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
+00042860: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
+00042870: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
+00042880: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
+00042890: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+000428a0: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
+000428b0: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
+000428c0: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
+000428d0: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
+000428e0: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
+000428f0: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
+00042900: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
+00042910: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
+00042920: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
+00042930: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
+00042940: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
+00042950: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
+00042960: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
+00042970: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
+00042980: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00042990: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
+000429a0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+000429b0: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
+000429c0: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
+000429d0: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
+000429e0: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
+000429f0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00042a00: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
+00042a10: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00042a20: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+00042a30: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
+00042a40: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
+00042a50: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
+00042a60: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
+00042a70: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
+00042a80: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
+00042a90: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
+00042aa0: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
+00042ab0: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
+00042ac0: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
+00042ad0: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
+00042ae0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+00042af0: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
+00042b00: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
+00042b10: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
+00042b20: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
+00042b30: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
+00042b40: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
+00042b50: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+00042b60: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
+00042b70: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
+00042b80: 6d2c 2070 6c75 6769 6e2c 206e 616d 653d  m, plugin, name=
+00042b90: 4e6f 6e65 293a 0a20 2020 2020 2020 2022  None):.        "
+00042ba0: 2222 5265 6769 7374 6572 7320 6120 776f  ""Registers a wo
+00042bb0: 726b 6572 2070 6c75 6769 6e20 6f6e 2061  rker plugin on a
+00042bc0: 6c6c 2072 756e 6e69 6e67 2061 6e64 2066  ll running and f
+00042bd0: 7574 7572 6520 776f 726b 6572 7322 2222  uture workers"""
+00042be0: 0a20 2020 2020 2020 2073 656c 662e 776f  .        self.wo
+00042bf0: 726b 6572 5f70 6c75 6769 6e73 5b6e 616d  rker_plugins[nam
+00042c00: 655d 203d 2070 6c75 6769 6e0a 0a20 2020  e] = plugin..   
+00042c10: 2020 2020 2072 6573 706f 6e73 6573 203d       responses =
+00042c20: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+00042c30: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
+00042c40: 2020 206d 7367 3d64 6963 7428 6f70 3d22     msg=dict(op="
+00042c50: 706c 7567 696e 2d61 6464 222c 2070 6c75  plugin-add", plu
+00042c60: 6769 6e3d 706c 7567 696e 2c20 6e61 6d65  gin=plugin, name
+00042c70: 3d6e 616d 6529 0a20 2020 2020 2020 2029  =name).        )
+00042c80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00042c90: 7265 7370 6f6e 7365 730a 0a20 2020 2061  responses..    a
+00042ca0: 7379 6e63 2064 6566 2075 6e72 6567 6973  sync def unregis
+00042cb0: 7465 725f 776f 726b 6572 5f70 6c75 6769  ter_worker_plugi
+00042cc0: 6e28 7365 6c66 2c20 636f 6d6d 2c20 6e61  n(self, comm, na
+00042cd0: 6d65 293a 0a20 2020 2020 2020 2022 2222  me):.        """
+00042ce0: 556e 7265 6769 7374 6572 7320 6120 776f  Unregisters a wo
+00042cf0: 726b 6572 2070 6c75 6769 6e22 2222 0a20  rker plugin""". 
+00042d00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00042d10: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00042d20: 6b65 725f 706c 7567 696e 732e 706f 7028  ker_plugins.pop(
+00042d30: 6e61 6d65 290a 2020 2020 2020 2020 6578  name).        ex
+00042d40: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00042d50: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00042d60: 2056 616c 7565 4572 726f 7228 6622 5468   ValueError(f"Th
+00042d70: 6520 776f 726b 6572 2070 6c75 6769 6e20  e worker plugin 
+00042d80: 7b6e 616d 657d 2064 6f65 7320 6e6f 7420  {name} does not 
+00042d90: 6578 6973 7422 290a 0a20 2020 2020 2020  exist")..       
+00042da0: 2072 6573 706f 6e73 6573 203d 2061 7761   responses = awa
+00042db0: 6974 2073 656c 662e 6272 6f61 6463 6173  it self.broadcas
+00042dc0: 7428 6d73 673d 6469 6374 286f 703d 2270  t(msg=dict(op="p
+00042dd0: 6c75 6769 6e2d 7265 6d6f 7665 222c 206e  lugin-remove", n
+00042de0: 616d 653d 6e61 6d65 2929 0a20 2020 2020  ame=name)).     
+00042df0: 2020 2072 6574 7572 6e20 7265 7370 6f6e     return respon
+00042e00: 7365 730a 0a20 2020 2061 7379 6e63 2064  ses..    async d
+00042e10: 6566 2072 6567 6973 7465 725f 6e61 6e6e  ef register_nann
+00042e20: 795f 706c 7567 696e 2873 656c 662c 2063  y_plugin(self, c
+00042e30: 6f6d 6d2c 2070 6c75 6769 6e2c 206e 616d  omm, plugin, nam
+00042e40: 653d 4e6f 6e65 293a 0a20 2020 2020 2020  e=None):.       
+00042e50: 2022 2222 5265 6769 7374 6572 7320 6120   """Registers a 
+00042e60: 7365 7475 7020 6675 6e63 7469 6f6e 2c20  setup function, 
+00042e70: 616e 6420 6361 6c6c 2069 7420 6f6e 2065  and call it on e
+00042e80: 7665 7279 2077 6f72 6b65 7222 2222 0a20  very worker""". 
+00042e90: 2020 2020 2020 2073 656c 662e 6e61 6e6e         self.nann
+00042ea0: 795f 706c 7567 696e 735b 6e61 6d65 5d20  y_plugins[name] 
+00042eb0: 3d20 706c 7567 696e 0a0a 2020 2020 2020  = plugin..      
+00042ec0: 2020 7265 7370 6f6e 7365 7320 3d20 6177    responses = aw
+00042ed0: 6169 7420 7365 6c66 2e62 726f 6164 6361  ait self.broadca
+00042ee0: 7374 280a 2020 2020 2020 2020 2020 2020  st(.            
+00042ef0: 6d73 673d 6469 6374 286f 703d 2270 6c75  msg=dict(op="plu
+00042f00: 6769 6e5f 6164 6422 2c20 706c 7567 696e  gin_add", plugin
+00042f10: 3d70 6c75 6769 6e2c 206e 616d 653d 6e61  =plugin, name=na
+00042f20: 6d65 292c 0a20 2020 2020 2020 2020 2020  me),.           
+00042f30: 206e 616e 6e79 3d54 7275 652c 0a20 2020   nanny=True,.   
+00042f40: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00042f50: 6574 7572 6e20 7265 7370 6f6e 7365 730a  eturn responses.
+00042f60: 0a20 2020 2061 7379 6e63 2064 6566 2075  .    async def u
+00042f70: 6e72 6567 6973 7465 725f 6e61 6e6e 795f  nregister_nanny_
+00042f80: 706c 7567 696e 2873 656c 662c 2063 6f6d  plugin(self, com
+00042f90: 6d2c 206e 616d 6529 3a0a 2020 2020 2020  m, name):.      
+00042fa0: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
+00042fb0: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
+00042fc0: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
+00042fd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00042fe0: 662e 6e61 6e6e 795f 706c 7567 696e 732e  f.nanny_plugins.
+00042ff0: 706f 7028 6e61 6d65 290a 2020 2020 2020  pop(name).      
+00043000: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00043010: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
+00043020: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00043030: 6622 5468 6520 6e61 6e6e 7920 706c 7567  f"The nanny plug
+00043040: 696e 207b 6e61 6d65 7d20 646f 6573 206e  in {name} does n
+00043050: 6f74 2065 7869 7374 2229 0a0a 2020 2020  ot exist")..    
+00043060: 2020 2020 7265 7370 6f6e 7365 7320 3d20      responses = 
+00043070: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
+00043080: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
+00043090: 2020 6d73 673d 6469 6374 286f 703d 2270    msg=dict(op="p
+000430a0: 6c75 6769 6e5f 7265 6d6f 7665 222c 206e  lugin_remove", n
+000430b0: 616d 653d 6e61 6d65 292c 206e 616e 6e79  ame=name), nanny
+000430c0: 3d54 7275 650a 2020 2020 2020 2020 290a  =True.        ).
+000430d0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000430e0: 6573 706f 6e73 6573 0a0a 2020 2020 6465  esponses..    de
+000430f0: 6620 7472 616e 7369 7469 6f6e 280a 2020  f transition(.  
+00043100: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00043110: 2020 2020 6b65 793a 2073 7472 2c0a 2020      key: str,.  
+00043120: 2020 2020 2020 6669 6e69 7368 3a20 5461        finish: Ta
+00043130: 736b 5374 6174 6553 7461 7465 2c0a 2020  skStateState,.  
+00043140: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+00043150: 643a 2073 7472 2c0a 2020 2020 2020 2020  d: str,.        
+00043160: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+00043170: 2020 2029 202d 3e20 5265 6373 3a0a 2020     ) -> Recs:.  
+00043180: 2020 2020 2020 2222 2254 7261 6e73 6974        """Transit
+00043190: 696f 6e20 6120 6b65 7920 6672 6f6d 2069  ion a key from i
+000431a0: 7473 2063 7572 7265 6e74 2073 7461 7465  ts current state
+000431b0: 2074 6f20 7468 6520 6669 6e69 7368 2073   to the finish s
+000431c0: 7461 7465 0a0a 2020 2020 2020 2020 4578  tate..        Ex
+000431d0: 616d 706c 6573 0a20 2020 2020 2020 202d  amples.        -
+000431e0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+000431f0: 3e3e 3e20 7365 6c66 2e74 7261 6e73 6974  >>> self.transit
+00043200: 696f 6e28 2778 272c 2027 7761 6974 696e  ion('x', 'waitin
+00043210: 6727 290a 2020 2020 2020 2020 7b27 7827  g').        {'x'
+00043220: 3a20 2770 726f 6365 7373 696e 6727 7d0a  : 'processing'}.
+00043230: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00043240: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00043250: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
+00043260: 6172 7920 6f66 2072 6563 6f6d 6d65 6e64  ary of recommend
+00043270: 6174 696f 6e73 2066 6f72 2066 7574 7572  ations for futur
+00043280: 6520 7472 616e 7369 7469 6f6e 730a 0a20  e transitions.. 
+00043290: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
+000432a0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000432b0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+000432c0: 6572 2e74 7261 6e73 6974 696f 6e73 3a20  er.transitions: 
+000432d0: 7472 616e 7369 7469 7665 2076 6572 7369  transitive versi
+000432e0: 6f6e 206f 6620 7468 6973 2066 756e 6374  on of this funct
+000432f0: 696f 6e0a 2020 2020 2020 2020 2222 220a  ion.        """.
+00043300: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00043310: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00043320: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00043330: 7320 3d20 7365 6c66 2e5f 7472 616e 7369  s = self._transi
+00043340: 7469 6f6e 280a 2020 2020 2020 2020 2020  tion(.          
+00043350: 2020 6b65 792c 2066 696e 6973 682c 2073    key, finish, s
+00043360: 7469 6d75 6c75 735f 6964 2c20 2a2a 6b77  timulus_id, **kw
+00043370: 6172 6773 0a20 2020 2020 2020 2029 0a20  args.        ). 
+00043380: 2020 2020 2020 2073 656c 662e 7365 6e64         self.send
+00043390: 5f61 6c6c 2863 6c69 656e 745f 6d73 6773  _all(client_msgs
+000433a0: 2c20 776f 726b 6572 5f6d 7367 7329 0a20  , worker_msgs). 
+000433b0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000433c0: 636f 6d6d 656e 6461 7469 6f6e 730a 0a20  commendations.. 
+000433d0: 2020 2064 6566 2074 7261 6e73 6974 696f     def transitio
+000433e0: 6e73 2873 656c 662c 2072 6563 6f6d 6d65  ns(self, recomme
+000433f0: 6e64 6174 696f 6e73 3a20 5265 6373 2c20  ndations: Recs, 
+00043400: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00043410: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00043420: 2020 2022 2222 5072 6f63 6573 7320 7472     """Process tr
+00043430: 616e 7369 7469 6f6e 7320 756e 7469 6c20  ansitions until 
+00043440: 6e6f 6e65 2061 7265 206c 6566 740a 0a20  none are left.. 
+00043450: 2020 2020 2020 2054 6869 7320 696e 636c         This incl
+00043460: 7564 6573 2066 6565 6462 6163 6b20 6672  udes feedback fr
+00043470: 6f6d 2070 7265 7669 6f75 7320 7472 616e  om previous tran
+00043480: 7369 7469 6f6e 7320 616e 6420 636f 6e74  sitions and cont
+00043490: 696e 7565 7320 756e 7469 6c20 7765 0a20  inues until we. 
+000434a0: 2020 2020 2020 2072 6561 6368 2061 2073         reach a s
+000434b0: 7465 6164 7920 7374 6174 650a 2020 2020  teady state.    
+000434c0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000434d0: 636c 6965 6e74 5f6d 7367 733a 204d 7367  client_msgs: Msg
+000434e0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+000434f0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00043500: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
+00043510: 6c66 2e5f 7472 616e 7369 7469 6f6e 7328  lf._transitions(
+00043520: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00043530: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00043540: 726b 6572 5f6d 7367 732c 2073 7469 6d75  rker_msgs, stimu
+00043550: 6c75 735f 6964 290a 2020 2020 2020 2020  lus_id).        
+00043560: 7365 6c66 2e73 656e 645f 616c 6c28 636c  self.send_all(cl
+00043570: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00043580: 725f 6d73 6773 290a 0a20 2020 2061 7379  r_msgs)..    asy
+00043590: 6e63 2064 6566 2067 6574 5f73 746f 7279  nc def get_story
+000435a0: 2873 656c 662c 206b 6579 735f 6f72 5f73  (self, keys_or_s
+000435b0: 7469 6d75 6c69 3a20 4974 6572 6162 6c65  timuli: Iterable
+000435c0: 5b73 7472 5d29 202d 3e20 6c69 7374 5b54  [str]) -> list[T
+000435d0: 7261 6e73 6974 696f 6e5d 3a0a 2020 2020  ransition]:.    
+000435e0: 2020 2020 2222 2252 5043 2068 6f6f 6b20      """RPC hook 
+000435f0: 666f 7220 3a6d 6574 683a 6053 6368 6564  for :meth:`Sched
+00043600: 756c 6572 5374 6174 652e 7374 6f72 7960  ulerState.story`
+00043610: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
+00043620: 7468 6174 2074 6865 206d 7367 7061 636b  that the msgpack
+00043630: 2073 6572 6961 6c69 7a61 7469 6f6e 2f64   serialization/d
+00043640: 6573 6572 6961 6c69 7a61 7469 6f6e 2072  eserialization r
+00043650: 6f75 6e64 2d74 7269 7020 7769 6c6c 2074  ound-trip will t
+00043660: 7261 6e73 666f 726d 0a20 2020 2020 2020  ransform.       
+00043670: 2074 6865 203a 636c 6173 733a 6054 7261   the :class:`Tra
+00043680: 6e73 6974 696f 6e60 206e 616d 6564 7475  nsition` namedtu
+00043690: 706c 6573 2069 6e74 6f20 7265 6775 6c61  ples into regula
+000436a0: 7220 7475 706c 6573 2e0a 2020 2020 2020  r tuples..      
+000436b0: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+000436c0: 7475 726e 2073 656c 662e 7374 6f72 7928  turn self.story(
+000436d0: 2a6b 6579 735f 6f72 5f73 7469 6d75 6c69  *keys_or_stimuli
+000436e0: 290a 0a20 2020 2064 6566 205f 7265 7363  )..    def _resc
+000436f0: 6865 6475 6c65 280a 2020 2020 2020 2020  hedule(.        
+00043700: 7365 6c66 2c20 6b65 793a 2073 7472 2c20  self, key: str, 
+00043710: 776f 726b 6572 3a20 7374 7220 7c20 4e6f  worker: str | No
+00043720: 6e65 203d 204e 6f6e 652c 202a 2c20 7374  ne = None, *, st
+00043730: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+00043740: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
+00043750: 2020 2020 2020 2222 2252 6573 6368 6564        """Resched
+00043760: 756c 6520 6120 7461 736b 2e0a 0a20 2020  ule a task...   
+00043770: 2020 2020 2054 6869 7320 6675 6e63 7469       This functi
+00043780: 6f6e 2073 686f 756c 6420 6f6e 6c79 2062  on should only b
+00043790: 6520 7573 6564 2077 6865 6e20 7468 6520  e used when the 
+000437a0: 7461 736b 2068 6173 2061 6c72 6561 6479  task has already
+000437b0: 2062 6565 6e20 7265 6c65 6173 6564 2069   been released i
+000437c0: 6e0a 2020 2020 2020 2020 736f 6d65 2077  n.        some w
+000437d0: 6179 206f 6e20 7468 6520 776f 726b 6572  ay on the worker
+000437e0: 2069 7427 7320 6173 7369 676e 6564 2074   it's assigned t
+000437f0: 6f20 e280 9420 6569 7468 6572 2076 6961  o ... either via
+00043800: 2063 616e 6365 6c6c 6174 696f 6e20 6f72   cancellation or
+00043810: 2061 0a20 2020 2020 2020 2052 6573 6368   a.        Resch
+00043820: 6564 756c 6520 6578 6365 7074 696f 6e20  edule exception 
+00043830: e280 9420 616e 6420 796f 7520 6172 6520  ... and you are 
+00043840: 6365 7274 6169 6e20 7468 6520 776f 726b  certain the work
+00043850: 6572 2077 696c 6c20 6e6f 7420 7365 6e64  er will not send
+00043860: 2061 6e79 2066 7572 7468 6572 0a20 2020   any further.   
+00043870: 2020 2020 2075 7064 6174 6573 2061 626f       updates abo
+00043880: 7574 2074 6865 2074 6173 6b20 746f 2074  ut the task to t
+00043890: 6865 2073 6368 6564 756c 6572 2e0a 2020  he scheduler..  
+000438a0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000438b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000438c0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000438d0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+000438e0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+000438f0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00043900: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00043910: 2020 2020 2020 2020 2020 2020 2066 2241               f"A
+00043920: 7474 656d 7074 696e 6720 746f 2072 6573  ttempting to res
+00043930: 6368 6564 756c 6520 7461 736b 207b 6b65  chedule task {ke
+00043940: 797d 2c20 7768 6963 6820 7761 7320 6e6f  y}, which was no
+00043950: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00043960: 2020 2020 2266 6f75 6e64 206f 6e20 7468      "found on th
+00043970: 6520 7363 6865 6475 6c65 722e 2041 626f  e scheduler. Abo
+00043980: 7274 696e 6720 7265 7363 6865 6475 6c65  rting reschedule
+00043990: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+000439a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000439b0: 7572 6e0a 2020 2020 2020 2020 6966 2074  urn.        if t
+000439c0: 732e 7374 6174 6520 213d 2022 7072 6f63  s.state != "proc
+000439d0: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
+000439e0: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+000439f0: 2020 2020 6966 2077 6f72 6b65 7220 616e      if worker an
+00043a00: 6420 7473 2e70 726f 6365 7373 696e 675f  d ts.processing_
+00043a10: 6f6e 2061 6e64 2074 732e 7072 6f63 6573  on and ts.proces
+00043a20: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
+00043a30: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
+00043a40: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00043a50: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00043a60: 6f6e 5f70 726f 6365 7373 696e 675f 7265  on_processing_re
+00043a70: 6c65 6173 6564 2077 696c 6c20 696d 6d65  leased will imme
+00043a80: 6469 6174 656c 7920 7375 6767 6573 7420  diately suggest 
+00043a90: 616e 2061 6464 6974 696f 6e61 6c0a 2020  an additional.  
+00043aa0: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00043ab0: 6f6e 2074 6f20 7761 6974 696e 6720 6966  on to waiting if
+00043ac0: 2074 6865 2074 6173 6b20 6861 7320 616e   the task has an
+00043ad0: 7920 7761 6974 6572 7320 6f72 2063 6c69  y waiters or cli
+00043ae0: 656e 7473 2068 6f6c 6469 6e67 2061 2066  ents holding a f
+00043af0: 7574 7572 652e 0a20 2020 2020 2020 2073  uture..        s
+00043b00: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
+00043b10: 7b6b 6579 3a20 2272 656c 6561 7365 6422  {key: "released"
+00043b20: 7d2c 2073 7469 6d75 6c75 735f 6964 3d73  }, stimulus_id=s
+00043b30: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+00043b40: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00043b50: 2323 2323 2323 0a20 2020 2023 2055 7469  ######.    # Uti
+00043b60: 6c69 7479 2066 756e 6374 696f 6e73 2023  lity functions #
+00043b70: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00043b80: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+00043b90: 6465 6620 6164 645f 7265 736f 7572 6365  def add_resource
+00043ba0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00043bb0: 2077 6f72 6b65 723a 2073 7472 2c20 7265   worker: str, re
+00043bc0: 736f 7572 6365 733a 2064 6963 7420 7c20  sources: dict | 
+00043bd0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+00043be0: 2920 2d3e 204c 6974 6572 616c 5b22 4f4b  ) -> Literal["OK
+00043bf0: 225d 3a0a 2020 2020 2020 2020 7773 3a20  "]:.        ws: 
+00043c00: 576f 726b 6572 5374 6174 6520 3d20 7365  WorkerState = se
+00043c10: 6c66 2e77 6f72 6b65 7273 5b77 6f72 6b65  lf.workers[worke
+00043c20: 725d 0a20 2020 2020 2020 2069 6620 7265  r].        if re
+00043c30: 736f 7572 6365 733a 0a20 2020 2020 2020  sources:.       
+00043c40: 2020 2020 2077 732e 7265 736f 7572 6365       ws.resource
+00043c50: 732e 7570 6461 7465 2872 6573 6f75 7263  s.update(resourc
+00043c60: 6573 290a 2020 2020 2020 2020 7773 2e75  es).        ws.u
+00043c70: 7365 645f 7265 736f 7572 6365 7320 3d20  sed_resources = 
+00043c80: 7b7d 0a20 2020 2020 2020 2066 6f72 2072  {}.        for r
+00043c90: 6573 6f75 7263 652c 2071 7561 6e74 6974  esource, quantit
+00043ca0: 7920 696e 2077 732e 7265 736f 7572 6365  y in ws.resource
+00043cb0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+00043cc0: 2020 2020 2020 2077 732e 7573 6564 5f72         ws.used_r
+00043cd0: 6573 6f75 7263 6573 5b72 6573 6f75 7263  esources[resourc
+00043ce0: 655d 203d 2030 0a20 2020 2020 2020 2020  e] = 0.         
+00043cf0: 2020 2064 7220 3d20 7365 6c66 2e72 6573     dr = self.res
+00043d00: 6f75 7263 6573 2e67 6574 2872 6573 6f75  ources.get(resou
+00043d10: 7263 652c 204e 6f6e 6529 0a20 2020 2020  rce, None).     
+00043d20: 2020 2020 2020 2069 6620 6472 2069 7320         if dr is 
+00043d30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00043d40: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
+00043d50: 7263 6573 5b72 6573 6f75 7263 655d 203d  rces[resource] =
+00043d60: 2064 7220 3d20 7b7d 0a20 2020 2020 2020   dr = {}.       
+00043d70: 2020 2020 2064 725b 776f 726b 6572 5d20       dr[worker] 
+00043d80: 3d20 7175 616e 7469 7479 0a20 2020 2020  = quantity.     
+00043d90: 2020 2072 6574 7572 6e20 224f 4b22 0a0a     return "OK"..
+00043da0: 2020 2020 6465 6620 7265 6d6f 7665 5f72      def remove_r
+00043db0: 6573 6f75 7263 6573 2873 656c 662c 2077  esources(self, w
+00043dc0: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
+00043dd0: 6f6e 653a 0a20 2020 2020 2020 2077 733a  one:.        ws:
+00043de0: 2057 6f72 6b65 7253 7461 7465 203d 2073   WorkerState = s
+00043df0: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
+00043e00: 6572 5d0a 2020 2020 2020 2020 666f 7220  er].        for 
+00043e10: 7265 736f 7572 6365 2069 6e20 7773 2e72  resource in ws.r
+00043e20: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
+00043e30: 2020 2020 2020 6472 203d 2073 656c 662e        dr = self.
+00043e40: 7265 736f 7572 6365 732e 7365 7464 6566  resources.setdef
+00043e50: 6175 6c74 2872 6573 6f75 7263 652c 207b  ault(resource, {
+00043e60: 7d29 0a20 2020 2020 2020 2020 2020 2064  }).            d
+00043e70: 656c 2064 725b 776f 726b 6572 5d0a 0a20  el dr[worker].. 
+00043e80: 2020 2064 6566 2063 6f65 7263 655f 6164     def coerce_ad
+00043e90: 6472 6573 7328 7365 6c66 2c20 6164 6472  dress(self, addr
+00043ea0: 3a20 7374 7220 7c20 7475 706c 652c 2072  : str | tuple, r
+00043eb0: 6573 6f6c 7665 3a20 626f 6f6c 203d 2054  esolve: bool = T
+00043ec0: 7275 6529 202d 3e20 7374 723a 0a20 2020  rue) -> str:.   
+00043ed0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00043ee0: 2043 6f65 7263 6520 706f 7373 6962 6c65   Coerce possible
+00043ef0: 2069 6e70 7574 2061 6464 7265 7373 6573   input addresses
+00043f00: 2074 6f20 6361 6e6f 6e69 6361 6c20 666f   to canonical fo
+00043f10: 726d 2e0a 2020 2020 2020 2020 2a72 6573  rm..        *res
+00043f20: 6f6c 7665 2a20 6361 6e20 6265 2064 6973  olve* can be dis
+00043f30: 6162 6c65 6420 666f 7220 7465 7374 696e  abled for testin
+00043f40: 6720 7769 7468 2066 616b 6520 686f 7374  g with fake host
+00043f50: 6e61 6d65 732e 0a0a 2020 2020 2020 2020  names...        
+00043f60: 4861 6e64 6c65 7320 7374 7269 6e67 732c  Handles strings,
+00043f70: 2074 7570 6c65 732c 206f 7220 616c 6961   tuples, or alia
+00043f80: 7365 732e 0a20 2020 2020 2020 2022 2222  ses..        """
+00043f90: 0a20 2020 2020 2020 2023 2058 5858 2068  .        # XXX h
+00043fa0: 6f77 206d 616e 7920 6164 6472 6573 732d  ow many address-
+00043fb0: 7061 7273 696e 6720 726f 7574 696e 6573  parsing routines
+00043fc0: 2064 6f20 7765 2068 6176 653f 0a20 2020   do we have?.   
+00043fd0: 2020 2020 2069 6620 6164 6472 2069 6e20       if addr in 
+00043fe0: 7365 6c66 2e61 6c69 6173 6573 3a0a 2020  self.aliases:.  
+00043ff0: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+00044000: 2073 656c 662e 616c 6961 7365 735b 6164   self.aliases[ad
+00044010: 6472 5d0a 2020 2020 2020 2020 6966 2069  dr].        if i
+00044020: 7369 6e73 7461 6e63 6528 6164 6472 2c20  sinstance(addr, 
+00044030: 7475 706c 6529 3a0a 2020 2020 2020 2020  tuple):.        
+00044040: 2020 2020 6164 6472 203d 2075 6e70 6172      addr = unpar
+00044050: 7365 5f68 6f73 745f 706f 7274 282a 6164  se_host_port(*ad
+00044060: 6472 290a 2020 2020 2020 2020 6966 206e  dr).        if n
+00044070: 6f74 2069 7369 6e73 7461 6e63 6528 6164  ot isinstance(ad
+00044080: 6472 2c20 7374 7229 3a0a 2020 2020 2020  dr, str):.      
+00044090: 2020 2020 2020 7261 6973 6520 5479 7065        raise Type
+000440a0: 4572 726f 7228 6622 6164 6472 6573 7365  Error(f"addresse
+000440b0: 7320 7368 6f75 6c64 2062 6520 7374 7269  s should be stri
+000440c0: 6e67 7320 6f72 2074 7570 6c65 732c 2067  ngs or tuples, g
+000440d0: 6f74 207b 6164 6472 2172 7d22 290a 0a20  ot {addr!r}").. 
+000440e0: 2020 2020 2020 2069 6620 7265 736f 6c76         if resolv
+000440f0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00044100: 6464 7220 3d20 7265 736f 6c76 655f 6164  ddr = resolve_ad
+00044110: 6472 6573 7328 6164 6472 290a 2020 2020  dress(addr).    
+00044120: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00044130: 2020 2020 2020 6164 6472 203d 206e 6f72        addr = nor
+00044140: 6d61 6c69 7a65 5f61 6464 7265 7373 2861  malize_address(a
+00044150: 6464 7229 0a0a 2020 2020 2020 2020 7265  ddr)..        re
+00044160: 7475 726e 2061 6464 720a 0a20 2020 2064  turn addr..    d
+00044170: 6566 2077 6f72 6b65 7273 5f6c 6973 7428  ef workers_list(
+00044180: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
+00044190: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
+000441a0: 6f6e 6529 202d 3e20 6c69 7374 5b73 7472  one) -> list[str
+000441b0: 5d3a 0a20 2020 2020 2020 2022 2222 0a20  ]:.        """. 
+000441c0: 2020 2020 2020 204c 6973 7420 6f66 2071         List of q
+000441d0: 7561 6c69 6679 696e 6720 776f 726b 6572  ualifying worker
+000441e0: 730a 0a20 2020 2020 2020 2054 616b 6573  s..        Takes
+000441f0: 2061 206c 6973 7420 6f66 2077 6f72 6b65   a list of worke
+00044200: 7220 6164 6472 6573 7365 7320 6f72 2068  r addresses or h
+00044210: 6f73 746e 616d 6573 2e0a 2020 2020 2020  ostnames..      
+00044220: 2020 5265 7475 726e 7320 6120 6c69 7374    Returns a list
+00044230: 206f 6620 616c 6c20 776f 726b 6572 2061   of all worker a
+00044240: 6464 7265 7373 6573 2074 6861 7420 6d61  ddresses that ma
+00044250: 7463 680a 2020 2020 2020 2020 2222 220a  tch.        """.
+00044260: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+00044270: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
+00044280: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00044290: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
+000442a0: 290a 0a20 2020 2020 2020 206f 7574 203d  )..        out =
+000442b0: 2073 6574 2829 0a20 2020 2020 2020 2066   set().        f
+000442c0: 6f72 2077 2069 6e20 776f 726b 6572 733a  or w in workers:
+000442d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000442e0: 223a 2220 696e 2077 3a0a 2020 2020 2020  ":" in w:.      
+000442f0: 2020 2020 2020 2020 2020 6f75 742e 6164            out.ad
+00044300: 6428 7729 0a20 2020 2020 2020 2020 2020  d(w).           
+00044310: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00044320: 2020 2020 2020 206f 7574 2e75 7064 6174         out.updat
+00044330: 6528 7b77 7720 666f 7220 7777 2069 6e20  e({ww for ww in 
+00044340: 7365 6c66 2e77 6f72 6b65 7273 2069 6620  self.workers if 
+00044350: 7720 696e 2077 777d 2920 2023 2054 4f44  w in ww})  # TOD
+00044360: 4f3a 2071 7561 6472 6174 6963 0a20 2020  O: quadratic.   
+00044370: 2020 2020 2072 6574 7572 6e20 6c69 7374       return list
+00044380: 286f 7574 290a 0a20 2020 2061 7379 6e63  (out)..    async
+00044390: 2064 6566 2067 6574 5f70 726f 6669 6c65   def get_profile
+000443a0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000443b0: 2020 2020 2020 2020 636f 6d6d 3d4e 6f6e          comm=Non
+000443c0: 652c 0a20 2020 2020 2020 2077 6f72 6b65  e,.        worke
+000443d0: 7273 3d4e 6f6e 652c 0a20 2020 2020 2020  rs=None,.       
+000443e0: 2073 6368 6564 756c 6572 3d46 616c 7365   scheduler=False
+000443f0: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
+00044400: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00044410: 6d65 7267 655f 776f 726b 6572 733d 5472  merge_workers=Tr
+00044420: 7565 2c0a 2020 2020 2020 2020 7374 6172  ue,.        star
+00044430: 743d 4e6f 6e65 2c0a 2020 2020 2020 2020  t=None,.        
+00044440: 7374 6f70 3d4e 6f6e 652c 0a20 2020 2020  stop=None,.     
+00044450: 2020 206b 6579 3d4e 6f6e 652c 0a20 2020     key=None,.   
+00044460: 2029 3a0a 2020 2020 2020 2020 6966 2077   ):.        if w
+00044470: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+00044480: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00044490: 6572 7320 3d20 7365 6c66 2e77 6f72 6b65  ers = self.worke
+000444a0: 7273 0a20 2020 2020 2020 2065 6c73 653a  rs.        else:
+000444b0: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
+000444c0: 6b65 7273 203d 2073 6574 2873 656c 662e  kers = set(self.
+000444d0: 776f 726b 6572 7329 2026 2073 6574 2877  workers) & set(w
+000444e0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+000444f0: 2069 6620 7363 6865 6475 6c65 723a 0a20   if scheduler:. 
+00044500: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00044510: 6e20 7072 6f66 696c 652e 6765 745f 7072  n profile.get_pr
+00044520: 6f66 696c 6528 7365 6c66 2e69 6f5f 6c6f  ofile(self.io_lo
+00044530: 6f70 2e70 726f 6669 6c65 2c20 7374 6172  op.profile, star
+00044540: 743d 7374 6172 742c 2073 746f 703d 7374  t=start, stop=st
+00044550: 6f70 290a 0a20 2020 2020 2020 2072 6573  op)..        res
+00044560: 756c 7473 203d 2061 7761 6974 2061 7379  ults = await asy
+00044570: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+00044580: 2020 2020 2020 2020 202a 280a 2020 2020           *(.    
+00044590: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000445a0: 2e72 7063 2877 292e 7072 6f66 696c 6528  .rpc(w).profile(
+000445b0: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
+000445c0: 703d 7374 6f70 2c20 6b65 793d 6b65 792c  p=stop, key=key,
+000445d0: 2073 6572 7665 723d 7365 7276 6572 290a   server=server).
+000445e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000445f0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+00044600: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00044610: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00044620: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
+00044630: 7565 2c0a 2020 2020 2020 2020 290a 0a20  ue,.        ).. 
+00044640: 2020 2020 2020 2072 6573 756c 7473 203d         results =
+00044650: 205b 7220 666f 7220 7220 696e 2072 6573   [r for r in res
+00044660: 756c 7473 2069 6620 6e6f 7420 6973 696e  ults if not isin
+00044670: 7374 616e 6365 2872 2c20 4578 6365 7074  stance(r, Except
+00044680: 696f 6e29 5d0a 0a20 2020 2020 2020 2069  ion)]..        i
+00044690: 6620 6d65 7267 655f 776f 726b 6572 733a  f merge_workers:
+000446a0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+000446b0: 706f 6e73 6520 3d20 7072 6f66 696c 652e  ponse = profile.
+000446c0: 6d65 7267 6528 2a72 6573 756c 7473 290a  merge(*results).
+000446d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000446e0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+000446f0: 7365 203d 2064 6963 7428 7a69 7028 776f  se = dict(zip(wo
+00044700: 726b 6572 732c 2072 6573 756c 7473 2929  rkers, results))
+00044710: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00044720: 7265 7370 6f6e 7365 0a0a 2020 2020 6173  response..    as
+00044730: 796e 6320 6465 6620 6765 745f 7072 6f66  ync def get_prof
+00044740: 696c 655f 6d65 7461 6461 7461 280a 2020  ile_metadata(.  
+00044750: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00044760: 2020 2020 776f 726b 6572 733a 2022 4974      workers: "It
+00044770: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
+00044780: 6e65 2220 3d20 4e6f 6e65 2c0a 2020 2020  ne" = None,.    
+00044790: 2020 2020 7374 6172 743a 2066 6c6f 6174      start: float
+000447a0: 203d 2030 2c0a 2020 2020 2020 2020 7374   = 0,.        st
+000447b0: 6f70 3a20 2266 6c6f 6174 207c 204e 6f6e  op: "float | Non
+000447c0: 6522 203d 204e 6f6e 652c 0a20 2020 2020  e" = None,.     
+000447d0: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
+000447e0: 5f69 6e74 6572 7661 6c3a 2022 7374 7220  _interval: "str 
+000447f0: 7c20 666c 6f61 7420 7c20 4e6f 6e65 2220  | float | None" 
+00044800: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+00044810: 2064 6963 743a 0a20 2020 2020 2020 2064   dict:.        d
+00044820: 7420 3d20 7072 6f66 696c 655f 6379 636c  t = profile_cycl
+00044830: 655f 696e 7465 7276 616c 206f 7220 6461  e_interval or da
+00044840: 736b 2e63 6f6e 6669 672e 6765 7428 0a20  sk.config.get(. 
+00044850: 2020 2020 2020 2020 2020 2022 6469 7374             "dist
+00044860: 7269 6275 7465 642e 776f 726b 6572 2e70  ributed.worker.p
+00044870: 726f 6669 6c65 2e63 7963 6c65 220a 2020  rofile.cycle".  
+00044880: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00044890: 6474 203d 2070 6172 7365 5f74 696d 6564  dt = parse_timed
+000448a0: 656c 7461 2864 742c 2064 6566 6175 6c74  elta(dt, default
+000448b0: 3d22 6d73 2229 0a0a 2020 2020 2020 2020  ="ms")..        
+000448c0: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
+000448d0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000448e0: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
+000448f0: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
+00044900: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00044910: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
+00044920: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
+00044930: 6574 2877 6f72 6b65 7273 290a 2020 2020  et(workers).    
+00044940: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
+00044950: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+00044960: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00044970: 2a28 7365 6c66 2e72 7063 2877 292e 7072  *(self.rpc(w).pr
+00044980: 6f66 696c 655f 6d65 7461 6461 7461 2873  ofile_metadata(s
+00044990: 7461 7274 3d73 7461 7274 2c20 7374 6f70  tart=start, stop
+000449a0: 3d73 746f 7029 2066 6f72 2077 2069 6e20  =stop) for w in 
+000449b0: 776f 726b 6572 7329 2c0a 2020 2020 2020  workers),.      
+000449c0: 2020 2020 2020 7265 7475 726e 5f65 7863        return_exc
+000449d0: 6570 7469 6f6e 733d 5472 7565 2c0a 2020  eptions=True,.  
+000449e0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000449f0: 2072 6573 756c 7473 203d 205b 7220 666f   results = [r fo
+00044a00: 7220 7220 696e 2072 6573 756c 7473 2069  r r in results i
+00044a10: 6620 6e6f 7420 6973 696e 7374 616e 6365  f not isinstance
+00044a20: 2872 2c20 4578 6365 7074 696f 6e29 5d0a  (r, Exception)].
+00044a30: 2020 2020 2020 2020 636f 756e 7473 203d          counts =
+00044a40: 205b 0a20 2020 2020 2020 2020 2020 2028   [.            (
+00044a50: 7469 6d65 2c20 7375 6d28 706c 7563 6b28  time, sum(pluck(
+00044a60: 312c 2067 726f 7570 2929 290a 2020 2020  1, group))).    
+00044a70: 2020 2020 2020 2020 666f 7220 7469 6d65          for time
+00044a80: 2c20 6772 6f75 7020 696e 2069 7465 7274  , group in itert
+00044a90: 6f6f 6c73 2e67 726f 7570 6279 280a 2020  ools.groupby(.  
+00044aa0: 2020 2020 2020 2020 2020 2020 2020 6d65                me
+00044ab0: 7267 655f 736f 7274 6564 280a 2020 2020  rge_sorted(.    
+00044ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044ad0: 2a28 765b 2263 6f75 6e74 7322 5d20 666f  *(v["counts"] fo
+00044ae0: 7220 7620 696e 2072 6573 756c 7473 292c  r v in results),
+00044af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044b00: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
+00044b10: 2020 2020 6c61 6d62 6461 2074 3a20 745b      lambda t: t[
+00044b20: 305d 202f 2f20 6474 202a 2064 742c 0a20  0] // dt * dt,. 
+00044b30: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00044b40: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00044b50: 6b65 7973 3a20 6469 6374 5b73 7472 2c20  keys: dict[str, 
+00044b60: 6c69 7374 5b6c 6973 745d 5d20 3d20 7b0a  list[list]] = {.
+00044b70: 2020 2020 2020 2020 2020 2020 6b3a 205b              k: [
+00044b80: 5d20 666f 7220 7620 696e 2072 6573 756c  ] for v in resul
+00044b90: 7473 2066 6f72 2074 2c20 6420 696e 2076  ts for t, d in v
+00044ba0: 5b22 6b65 7973 225d 2066 6f72 206b 2069  ["keys"] for k i
+00044bb0: 6e20 640a 2020 2020 2020 2020 7d0a 0a20  n d.        }.. 
+00044bc0: 2020 2020 2020 2067 726f 7570 7331 203d         groups1 =
+00044bd0: 205b 765b 226b 6579 7322 5d20 666f 7220   [v["keys"] for 
+00044be0: 7620 696e 2072 6573 756c 7473 5d0a 2020  v in results].  
+00044bf0: 2020 2020 2020 6772 6f75 7073 3220 3d20        groups2 = 
+00044c00: 6c69 7374 286d 6572 6765 5f73 6f72 7465  list(merge_sorte
+00044c10: 6428 2a67 726f 7570 7331 2c20 6b65 793d  d(*groups1, key=
+00044c20: 6669 7273 7429 290a 0a20 2020 2020 2020  first))..       
+00044c30: 206c 6173 7420 3d20 300a 2020 2020 2020   last = 0.      
+00044c40: 2020 666f 7220 742c 2064 2069 6e20 6772    for t, d in gr
+00044c50: 6f75 7073 323a 0a20 2020 2020 2020 2020  oups2:.         
+00044c60: 2020 2074 7420 3d20 7420 2f2f 2064 7420     tt = t // dt 
+00044c70: 2a20 6474 0a20 2020 2020 2020 2020 2020  * dt.           
+00044c80: 2069 6620 7474 203e 206c 6173 743a 0a20   if tt > last:. 
+00044c90: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00044ca0: 6173 7420 3d20 7474 0a20 2020 2020 2020  ast = tt.       
+00044cb0: 2020 2020 2020 2020 2066 6f72 2076 2069           for v i
+00044cc0: 6e20 6b65 7973 2e76 616c 7565 7328 293a  n keys.values():
+00044cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044ce0: 2020 2020 2076 2e61 7070 656e 6428 5b74       v.append([t
+00044cf0: 742c 2030 5d29 0a20 2020 2020 2020 2020  t, 0]).         
+00044d00: 2020 2066 6f72 206b 2c20 7620 696e 2064     for k, v in d
+00044d10: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+00044d20: 2020 2020 2020 2020 2020 6b65 7973 5b6b            keys[k
+00044d30: 5d5b 2d31 5d5b 315d 202b 3d20 760a 0a20  ][-1][1] += v.. 
+00044d40: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00044d50: 636f 756e 7473 223a 2063 6f75 6e74 732c  counts": counts,
+00044d60: 2022 6b65 7973 223a 206b 6579 737d 0a0a   "keys": keys}..
+00044d70: 2020 2020 6173 796e 6320 6465 6620 7065      async def pe
+00044d80: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
+00044d90: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00044da0: 7374 6172 743a 2066 6c6f 6174 2c20 6c61  start: float, la
+00044db0: 7374 5f63 6f75 6e74 3a20 696e 742c 2063  st_count: int, c
+00044dc0: 6f64 653a 2073 7472 203d 2022 222c 206d  ode: str = "", m
+00044dd0: 6f64 653a 2073 7472 207c 204e 6f6e 6520  ode: str | None 
+00044de0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+00044df0: 7374 723a 0a20 2020 2020 2020 2073 746f  str:.        sto
+00044e00: 7020 3d20 7469 6d65 2829 0a20 2020 2020  p = time().     
+00044e10: 2020 2023 2050 726f 6669 6c65 730a 2020     # Profiles.  
+00044e20: 2020 2020 2020 636f 6d70 7574 652c 2073        compute, s
+00044e30: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
+00044e40: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
+00044e50: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+00044e60: 2020 2020 2020 2a5b 0a20 2020 2020 2020        *[.       
+00044e70: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
+00044e80: 745f 7072 6f66 696c 6528 7374 6172 743d  t_profile(start=
+00044e90: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
+00044ea0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+00044eb0: 5f70 726f 6669 6c65 2873 6368 6564 756c  _profile(schedul
+00044ec0: 6572 3d54 7275 652c 2073 7461 7274 3d73  er=True, start=s
+00044ed0: 7461 7274 292c 0a20 2020 2020 2020 2020  tart),.         
+00044ee0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
+00044ef0: 7072 6f66 696c 6528 7365 7276 6572 3d54  profile(server=T
+00044f00: 7275 652c 2073 7461 7274 3d73 7461 7274  rue, start=start
+00044f10: 292c 0a20 2020 2020 2020 2020 2020 205d  ),.            ]
+00044f20: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00044f30: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00044f40: 7465 6420 696d 706f 7274 2070 726f 6669  ted import profi
+00044f50: 6c65 0a0a 2020 2020 2020 2020 6465 6620  le..        def 
+00044f60: 7072 6f66 696c 655f 746f 5f66 6967 7572  profile_to_figur
+00044f70: 6528 7374 6174 6529 3a0a 2020 2020 2020  e(state):.      
+00044f80: 2020 2020 2020 6461 7461 203d 2070 726f        data = pro
+00044f90: 6669 6c65 2e70 6c6f 745f 6461 7461 2873  file.plot_data(s
+00044fa0: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
+00044fb0: 2020 6669 6775 7265 2c20 736f 7572 6365    figure, source
+00044fc0: 203d 2070 726f 6669 6c65 2e70 6c6f 745f   = profile.plot_
+00044fd0: 6669 6775 7265 2864 6174 612c 2073 697a  figure(data, siz
+00044fe0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00044ff0: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
+00045000: 2020 2020 2072 6574 7572 6e20 6669 6775       return figu
+00045010: 7265 0a0a 2020 2020 2020 2020 636f 6d70  re..        comp
+00045020: 7574 652c 2073 6368 6564 756c 6572 2c20  ute, scheduler, 
+00045030: 776f 726b 6572 7320 3d20 6d61 7028 0a20  workers = map(. 
+00045040: 2020 2020 2020 2020 2020 2070 726f 6669             profi
+00045050: 6c65 5f74 6f5f 6669 6775 7265 2c20 2863  le_to_figure, (c
+00045060: 6f6d 7075 7465 2c20 7363 6865 6475 6c65  ompute, schedule
+00045070: 722c 2077 6f72 6b65 7273 290a 2020 2020  r, workers).    
+00045080: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00045090: 2054 6173 6b20 7374 7265 616d 0a20 2020   Task stream.   
+000450a0: 2020 2020 2074 6173 6b5f 7374 7265 616d       task_stream
+000450b0: 203d 2073 656c 662e 6765 745f 7461 736b   = self.get_task
+000450c0: 5f73 7472 6561 6d28 7374 6172 743d 7374  _stream(start=st
+000450d0: 6172 7429 0a20 2020 2020 2020 2074 6f74  art).        tot
+000450e0: 616c 5f74 6173 6b73 203d 206c 656e 2874  al_tasks = len(t
+000450f0: 6173 6b5f 7374 7265 616d 290a 2020 2020  ask_stream).    
+00045100: 2020 2020 7469 6d65 7370 656e 743a 2064      timespent: d
+00045110: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+00045120: 666c 6f61 745d 203d 2064 6566 6175 6c74  float] = default
+00045130: 6469 6374 2866 6c6f 6174 290a 2020 2020  dict(float).    
+00045140: 2020 2020 666f 7220 6420 696e 2074 6173      for d in tas
+00045150: 6b5f 7374 7265 616d 3a0a 2020 2020 2020  k_stream:.      
+00045160: 2020 2020 2020 666f 7220 7820 696e 2064        for x in d
+00045170: 5b22 7374 6172 7473 746f 7073 225d 3a0a  ["startstops"]:.
+00045180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045190: 7469 6d65 7370 656e 745b 785b 2261 6374  timespent[x["act
+000451a0: 696f 6e22 5d5d 202b 3d20 785b 2273 746f  ion"]] += x["sto
+000451b0: 7022 5d20 2d20 785b 2273 7461 7274 225d  p"] - x["start"]
+000451c0: 0a20 2020 2020 2020 2074 6173 6b73 5f74  .        tasks_t
+000451d0: 696d 696e 6773 203d 2022 220a 2020 2020  imings = "".    
+000451e0: 2020 2020 666f 7220 6b20 696e 2073 6f72      for k in sor
+000451f0: 7465 6428 7469 6d65 7370 656e 742e 6b65  ted(timespent.ke
+00045200: 7973 2829 293a 0a20 2020 2020 2020 2020  ys()):.         
+00045210: 2020 2074 6173 6b73 5f74 696d 696e 6773     tasks_timings
+00045220: 202b 3d20 6622 5c6e 3c6c 693e 207b 6b7d   += f"\n<li> {k}
+00045230: 2074 696d 653a 207b 666f 726d 6174 5f74   time: {format_t
+00045240: 696d 6528 7469 6d65 7370 656e 745b 6b5d  ime(timespent[k]
+00045250: 297d 203c 2f6c 693e 220a 0a20 2020 2020  )} </li>"..     
+00045260: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00045270: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
+00045280: 6d70 6f6e 656e 7473 2e73 6368 6564 756c  mponents.schedul
+00045290: 6572 2069 6d70 6f72 7420 7461 736b 5f73  er import task_s
+000452a0: 7472 6561 6d5f 6669 6775 7265 0a20 2020  tream_figure.   
+000452b0: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
+000452c0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
+000452d0: 732e 7461 736b 5f73 7472 6561 6d20 696d  s.task_stream im
+000452e0: 706f 7274 2072 6563 7461 6e67 6c65 730a  port rectangles.
+000452f0: 0a20 2020 2020 2020 2072 6563 7473 203d  .        rects =
+00045300: 2072 6563 7461 6e67 6c65 7328 7461 736b   rectangles(task
+00045310: 5f73 7472 6561 6d29 0a20 2020 2020 2020  _stream).       
+00045320: 2073 6f75 7263 652c 2074 6173 6b5f 7374   source, task_st
+00045330: 7265 616d 203d 2074 6173 6b5f 7374 7265  ream = task_stre
+00045340: 616d 5f66 6967 7572 6528 7369 7a69 6e67  am_figure(sizing
+00045350: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+00045360: 6f74 6822 290a 2020 2020 2020 2020 736f  oth").        so
+00045370: 7572 6365 2e64 6174 612e 7570 6461 7465  urce.data.update
+00045380: 2872 6563 7473 290a 0a20 2020 2020 2020  (rects)..       
+00045390: 2023 2042 616e 6477 6964 7468 0a20 2020   # Bandwidth.   
+000453a0: 2020 2020 2066 726f 6d20 6469 7374 7269       from distri
+000453b0: 6275 7465 642e 6461 7368 626f 6172 642e  buted.dashboard.
+000453c0: 636f 6d70 6f6e 656e 7473 2e73 6368 6564  components.sched
+000453d0: 756c 6572 2069 6d70 6f72 7420 280a 2020  uler import (.  
+000453e0: 2020 2020 2020 2020 2020 4261 6e64 7769            Bandwi
+000453f0: 6474 6854 7970 6573 2c0a 2020 2020 2020  dthTypes,.      
+00045400: 2020 2020 2020 4261 6e64 7769 6474 6857        BandwidthW
+00045410: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+00045420: 290a 0a20 2020 2020 2020 2062 616e 6477  )..        bandw
+00045430: 6964 7468 5f77 6f72 6b65 7273 203d 2042  idth_workers = B
+00045440: 616e 6477 6964 7468 576f 726b 6572 7328  andwidthWorkers(
+00045450: 7365 6c66 2c20 7369 7a69 6e67 5f6d 6f64  self, sizing_mod
+00045460: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00045470: 290a 2020 2020 2020 2020 6261 6e64 7769  ).        bandwi
+00045480: 6474 685f 776f 726b 6572 732e 7570 6461  dth_workers.upda
+00045490: 7465 2829 0a20 2020 2020 2020 2062 616e  te().        ban
+000454a0: 6477 6964 7468 5f74 7970 6573 203d 2042  dwidth_types = B
+000454b0: 616e 6477 6964 7468 5479 7065 7328 7365  andwidthTypes(se
+000454c0: 6c66 2c20 7369 7a69 6e67 5f6d 6f64 653d  lf, sizing_mode=
+000454d0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+000454e0: 2020 2020 2020 2020 6261 6e64 7769 6474          bandwidt
+000454f0: 685f 7479 7065 732e 7570 6461 7465 2829  h_types.update()
+00045500: 0a0a 2020 2020 2020 2020 2320 5379 7374  ..        # Syst
+00045510: 656d 206d 6f6e 6974 6f72 0a20 2020 2020  em monitor.     
+00045520: 2020 2066 726f 6d20 6469 7374 7269 6275     from distribu
+00045530: 7465 642e 6461 7368 626f 6172 642e 636f  ted.dashboard.co
+00045540: 6d70 6f6e 656e 7473 2e73 6861 7265 6420  mponents.shared 
+00045550: 696d 706f 7274 2053 7973 7465 6d4d 6f6e  import SystemMon
+00045560: 6974 6f72 0a0a 2020 2020 2020 2020 7379  itor..        sy
+00045570: 736d 6f6e 203d 2053 7973 7465 6d4d 6f6e  smon = SystemMon
+00045580: 6974 6f72 2873 656c 662c 206c 6173 745f  itor(self, last_
+00045590: 636f 756e 743d 6c61 7374 5f63 6f75 6e74  count=last_count
+000455a0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+000455b0: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
+000455c0: 2020 2020 2020 7379 736d 6f6e 2e75 7064        sysmon.upd
+000455d0: 6174 6528 290a 0a20 2020 2020 2020 2023  ate()..        #
+000455e0: 2053 6368 6564 756c 6572 206c 6f67 730a   Scheduler logs.
+000455f0: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
+00045600: 7472 6962 7574 6564 2e64 6173 6862 6f61  tributed.dashboa
+00045610: 7264 2e63 6f6d 706f 6e65 6e74 732e 7363  rd.components.sc
+00045620: 6865 6475 6c65 7220 696d 706f 7274 2028  heduler import (
+00045630: 0a20 2020 2020 2020 2020 2020 205f 424f  .            _BO
+00045640: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
+00045650: 532c 0a20 2020 2020 2020 2020 2020 2053  S,.            S
+00045660: 6368 6564 756c 6572 4c6f 6773 2c0a 2020  chedulerLogs,.  
+00045670: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00045680: 206c 6f67 7320 3d20 5363 6865 6475 6c65   logs = Schedule
+00045690: 724c 6f67 7328 7365 6c66 2c20 7374 6172  rLogs(self, star
+000456a0: 743d 7374 6172 7429 0a0a 2020 2020 2020  t=start)..      
+000456b0: 2020 6672 6f6d 2062 6f6b 6568 2e6d 6f64    from bokeh.mod
+000456c0: 656c 7320 696d 706f 7274 2044 6976 2c20  els import Div, 
+000456d0: 5461 6273 0a0a 2020 2020 2020 2020 696d  Tabs..        im
+000456e0: 706f 7274 2064 6973 7472 6962 7574 6564  port distributed
+000456f0: 0a20 2020 2020 2020 2066 726f 6d20 6469  .        from di
+00045700: 7374 7269 6275 7465 642e 6461 7368 626f  stributed.dashbo
+00045710: 6172 642e 636f 7265 2069 6d70 6f72 7420  ard.core import 
+00045720: 5461 6250 616e 656c 0a0a 2020 2020 2020  TabPanel..      
+00045730: 2020 2320 4854 4d4c 0a20 2020 2020 2020    # HTML.       
+00045740: 2068 746d 6c20 3d20 2222 220a 2020 2020   html = """.    
+00045750: 2020 2020 3c68 313e 2044 6173 6b20 5065      <h1> Dask Pe
+00045760: 7266 6f72 6d61 6e63 6520 5265 706f 7274  rformance Report
+00045770: 203c 2f68 313e 0a0a 2020 2020 2020 2020   </h1>..        
+00045780: 3c69 3e20 5365 6c65 6374 2064 6966 6665  <i> Select diffe
+00045790: 7265 6e74 2074 6162 7320 6f6e 2074 6865  rent tabs on the
+000457a0: 2074 6f70 2066 6f72 2061 6464 6974 696f   top for additio
+000457b0: 6e61 6c20 696e 666f 726d 6174 696f 6e20  nal information 
+000457c0: 3c2f 693e 0a0a 2020 2020 2020 2020 3c68  </i>..        <h
+000457d0: 323e 2044 7572 6174 696f 6e3a 207b 7469  2> Duration: {ti
+000457e0: 6d65 7d20 3c2f 6832 3e0a 2020 2020 2020  me} </h2>.      
+000457f0: 2020 3c68 323e 2054 6173 6b73 2049 6e66    <h2> Tasks Inf
+00045800: 6f72 6d61 7469 6f6e 203c 2f68 323e 0a20  ormation </h2>. 
+00045810: 2020 2020 2020 203c 756c 3e0a 2020 2020         <ul>.    
+00045820: 2020 2020 203c 6c69 3e20 6e75 6d62 6572       <li> number
+00045830: 206f 6620 7461 736b 733a 207b 6e74 6173   of tasks: {ntas
+00045840: 6b73 7d20 3c2f 6c69 3e0a 2020 2020 2020  ks} </li>.      
+00045850: 2020 207b 7461 736b 735f 7469 6d69 6e67     {tasks_timing
+00045860: 737d 0a20 2020 2020 2020 203c 2f75 6c3e  s}.        </ul>
+00045870: 0a0a 2020 2020 2020 2020 3c68 323e 2053  ..        <h2> S
+00045880: 6368 6564 756c 6572 2049 6e66 6f72 6d61  cheduler Informa
+00045890: 7469 6f6e 203c 2f68 323e 0a20 2020 2020  tion </h2>.     
+000458a0: 2020 203c 756c 3e0a 2020 2020 2020 2020     <ul>.        
+000458b0: 2020 3c6c 693e 2041 6464 7265 7373 3a20    <li> Address: 
+000458c0: 7b61 6464 7265 7373 7d20 3c2f 6c69 3e0a  {address} </li>.
+000458d0: 2020 2020 2020 2020 2020 3c6c 693e 2057            <li> W
+000458e0: 6f72 6b65 7273 3a20 7b6e 776f 726b 6572  orkers: {nworker
+000458f0: 737d 203c 2f6c 693e 0a20 2020 2020 2020  s} </li>.       
+00045900: 2020 203c 6c69 3e20 5468 7265 6164 733a     <li> Threads:
+00045910: 207b 7468 7265 6164 737d 203c 2f6c 693e   {threads} </li>
+00045920: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
+00045930: 4d65 6d6f 7279 3a20 7b6d 656d 6f72 797d  Memory: {memory}
+00045940: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
+00045950: 203c 6c69 3e20 4461 736b 2056 6572 7369   <li> Dask Versi
+00045960: 6f6e 3a20 7b64 6173 6b5f 7665 7273 696f  on: {dask_versio
+00045970: 6e7d 203c 2f6c 693e 0a20 2020 2020 2020  n} </li>.       
+00045980: 2020 203c 6c69 3e20 4461 736b 2e44 6973     <li> Dask.Dis
+00045990: 7472 6962 7574 6564 2056 6572 7369 6f6e  tributed Version
+000459a0: 3a20 7b64 6973 7472 6962 7574 6564 5f76  : {distributed_v
+000459b0: 6572 7369 6f6e 7d20 3c2f 6c69 3e0a 2020  ersion} </li>.  
+000459c0: 2020 2020 2020 3c2f 756c 3e0a 0a20 2020        </ul>..   
+000459d0: 2020 2020 203c 6832 3e20 4361 6c6c 696e       <h2> Callin
+000459e0: 6720 436f 6465 203c 2f68 323e 0a20 2020  g Code </h2>.   
+000459f0: 2020 2020 203c 7072 653e 0a7b 636f 6465       <pre>.{code
+00045a00: 7d0a 2020 2020 2020 2020 3c2f 7072 653e  }.        </pre>
+00045a10: 0a20 2020 2020 2020 2022 2222 2e66 6f72  .        """.for
+00045a20: 6d61 7428 0a20 2020 2020 2020 2020 2020  mat(.           
+00045a30: 2074 696d 653d 666f 726d 6174 5f74 696d   time=format_tim
+00045a40: 6528 7374 6f70 202d 2073 7461 7274 292c  e(stop - start),
+00045a50: 0a20 2020 2020 2020 2020 2020 206e 7461  .            nta
+00045a60: 736b 733d 746f 7461 6c5f 7461 736b 732c  sks=total_tasks,
+00045a70: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+00045a80: 6b73 5f74 696d 696e 6773 3d74 6173 6b73  ks_timings=tasks
+00045a90: 5f74 696d 696e 6773 2c0a 2020 2020 2020  _timings,.      
+00045aa0: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
+00045ab0: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
+00045ac0: 2020 2020 2020 2020 6e77 6f72 6b65 7273          nworkers
+00045ad0: 3d6c 656e 2873 656c 662e 776f 726b 6572  =len(self.worker
+00045ae0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00045af0: 7468 7265 6164 733d 7375 6d28 7773 2e6e  threads=sum(ws.n
+00045b00: 7468 7265 6164 7320 666f 7220 7773 2069  threads for ws i
+00045b10: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+00045b20: 616c 7565 7328 2929 2c0a 2020 2020 2020  alues()),.      
+00045b30: 2020 2020 2020 6d65 6d6f 7279 3d66 6f72        memory=for
+00045b40: 6d61 745f 6279 7465 7328 7375 6d28 7773  mat_bytes(sum(ws
+00045b50: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
+00045b60: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
+00045b70: 6b65 7273 2e76 616c 7565 7328 2929 292c  kers.values())),
+00045b80: 0a20 2020 2020 2020 2020 2020 2063 6f64  .            cod
+00045b90: 653d 636f 6465 2c0a 2020 2020 2020 2020  e=code,.        
+00045ba0: 2020 2020 6461 736b 5f76 6572 7369 6f6e      dask_version
+00045bb0: 3d64 6173 6b2e 5f5f 7665 7273 696f 6e5f  =dask.__version_
+00045bc0: 5f2c 0a20 2020 2020 2020 2020 2020 2064  _,.            d
+00045bd0: 6973 7472 6962 7574 6564 5f76 6572 7369  istributed_versi
+00045be0: 6f6e 3d64 6973 7472 6962 7574 6564 2e5f  on=distributed._
+00045bf0: 5f76 6572 7369 6f6e 5f5f 2c0a 2020 2020  _version__,.    
+00045c00: 2020 2020 290a 2020 2020 2020 2020 6874      ).        ht
+00045c10: 6d6c 203d 2044 6976 2874 6578 743d 6874  ml = Div(text=ht
+00045c20: 6d6c 2c20 2a2a 5f42 4f4b 4548 5f53 5459  ml, **_BOKEH_STY
+00045c30: 4c45 535f 4b57 4152 4753 290a 0a20 2020  LES_KWARGS)..   
+00045c40: 2020 2020 2068 746d 6c20 3d20 5461 6250       html = TabP
+00045c50: 616e 656c 2863 6869 6c64 3d68 746d 6c2c  anel(child=html,
+00045c60: 2074 6974 6c65 3d22 5375 6d6d 6172 7922   title="Summary"
+00045c70: 290a 2020 2020 2020 2020 636f 6d70 7574  ).        comput
+00045c80: 6520 3d20 5461 6250 616e 656c 2863 6869  e = TabPanel(chi
+00045c90: 6c64 3d63 6f6d 7075 7465 2c20 7469 746c  ld=compute, titl
+00045ca0: 653d 2257 6f72 6b65 7220 5072 6f66 696c  e="Worker Profil
+00045cb0: 6520 2863 6f6d 7075 7465 2922 290a 2020  e (compute)").  
+00045cc0: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00045cd0: 5461 6250 616e 656c 2863 6869 6c64 3d77  TabPanel(child=w
+00045ce0: 6f72 6b65 7273 2c20 7469 746c 653d 2257  orkers, title="W
+00045cf0: 6f72 6b65 7220 5072 6f66 696c 6520 2861  orker Profile (a
+00045d00: 646d 696e 6973 7472 6174 6976 6529 2229  dministrative)")
+00045d10: 0a20 2020 2020 2020 2073 6368 6564 756c  .        schedul
+00045d20: 6572 203d 2054 6162 5061 6e65 6c28 0a20  er = TabPanel(. 
+00045d30: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+00045d40: 3d73 6368 6564 756c 6572 2c20 7469 746c  =scheduler, titl
+00045d50: 653d 2253 6368 6564 756c 6572 2050 726f  e="Scheduler Pro
+00045d60: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
+00045d70: 7469 7665 2922 0a20 2020 2020 2020 2029  tive)".        )
+00045d80: 0a20 2020 2020 2020 2074 6173 6b5f 7374  .        task_st
+00045d90: 7265 616d 203d 2054 6162 5061 6e65 6c28  ream = TabPanel(
+00045da0: 6368 696c 643d 7461 736b 5f73 7472 6561  child=task_strea
+00045db0: 6d2c 2074 6974 6c65 3d22 5461 736b 2053  m, title="Task S
+00045dc0: 7472 6561 6d22 290a 2020 2020 2020 2020  tream").        
+00045dd0: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+00045de0: 7320 3d20 5461 6250 616e 656c 280a 2020  s = TabPanel(.  
+00045df0: 2020 2020 2020 2020 2020 6368 696c 643d            child=
+00045e00: 6261 6e64 7769 6474 685f 776f 726b 6572  bandwidth_worker
+00045e10: 732e 726f 6f74 2c20 7469 746c 653d 2242  s.root, title="B
+00045e20: 616e 6477 6964 7468 2028 576f 726b 6572  andwidth (Worker
+00045e30: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
+00045e40: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+00045e50: 7479 7065 7320 3d20 5461 6250 616e 656c  types = TabPanel
+00045e60: 280a 2020 2020 2020 2020 2020 2020 6368  (.            ch
+00045e70: 696c 643d 6261 6e64 7769 6474 685f 7479  ild=bandwidth_ty
+00045e80: 7065 732e 726f 6f74 2c20 7469 746c 653d  pes.root, title=
+00045e90: 2242 616e 6477 6964 7468 2028 5479 7065  "Bandwidth (Type
+00045ea0: 7329 220a 2020 2020 2020 2020 290a 2020  s)".        ).  
+00045eb0: 2020 2020 2020 7379 7374 656d 203d 2054        system = T
+00045ec0: 6162 5061 6e65 6c28 6368 696c 643d 7379  abPanel(child=sy
+00045ed0: 736d 6f6e 2e72 6f6f 742c 2074 6974 6c65  smon.root, title
+00045ee0: 3d22 5379 7374 656d 2229 0a20 2020 2020  ="System").     
+00045ef0: 2020 206c 6f67 7320 3d20 5461 6250 616e     logs = TabPan
+00045f00: 656c 2863 6869 6c64 3d6c 6f67 732e 726f  el(child=logs.ro
+00045f10: 6f74 2c20 7469 746c 653d 2253 6368 6564  ot, title="Sched
+00045f20: 756c 6572 204c 6f67 7322 290a 0a20 2020  uler Logs")..   
+00045f30: 2020 2020 2074 6162 7320 3d20 5461 6273       tabs = Tabs
+00045f40: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
+00045f50: 6273 3d5b 0a20 2020 2020 2020 2020 2020  bs=[.           
+00045f60: 2020 2020 2068 746d 6c2c 0a20 2020 2020       html,.     
+00045f70: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
+00045f80: 7374 7265 616d 2c0a 2020 2020 2020 2020  stream,.        
+00045f90: 2020 2020 2020 2020 7379 7374 656d 2c0a          system,.
+00045fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045fb0: 6c6f 6773 2c0a 2020 2020 2020 2020 2020  logs,.          
+00045fc0: 2020 2020 2020 636f 6d70 7574 652c 0a20        compute,. 
+00045fd0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00045fe0: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
+00045ff0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00046000: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00046010: 2020 2062 616e 6477 6964 7468 5f77 6f72     bandwidth_wor
+00046020: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+00046030: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+00046040: 7479 7065 732c 0a20 2020 2020 2020 2020  types,.         
+00046050: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00046060: 2020 7369 7a69 6e67 5f6d 6f64 653d 2273    sizing_mode="s
+00046070: 7472 6574 6368 5f62 6f74 6822 2c0a 2020  tretch_both",.  
+00046080: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00046090: 2066 726f 6d20 626f 6b65 682e 636f 7265   from bokeh.core
+000460a0: 2e74 656d 706c 6174 6573 2069 6d70 6f72  .templates impor
+000460b0: 7420 6765 745f 656e 760a 2020 2020 2020  t get_env.      
+000460c0: 2020 6672 6f6d 2062 6f6b 6568 2e70 6c6f    from bokeh.plo
+000460d0: 7474 696e 6720 696d 706f 7274 206f 7574  tting import out
+000460e0: 7075 745f 6669 6c65 2c20 7361 7665 0a0a  put_file, save..
+000460f0: 2020 2020 2020 2020 7769 7468 2074 6d70          with tmp
+00046100: 6669 6c65 2865 7874 656e 7369 6f6e 3d22  file(extension="
+00046110: 2e68 746d 6c22 2920 6173 2066 6e3a 0a20  .html") as fn:. 
+00046120: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00046130: 745f 6669 6c65 2866 696c 656e 616d 653d  t_file(filename=
+00046140: 666e 2c20 7469 746c 653d 2244 6173 6b20  fn, title="Dask 
+00046150: 5065 7266 6f72 6d61 6e63 6520 5265 706f  Performance Repo
+00046160: 7274 222c 206d 6f64 653d 6d6f 6465 290a  rt", mode=mode).
+00046170: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00046180: 6c61 7465 5f64 6972 6563 746f 7279 203d  late_directory =
+00046190: 206f 732e 7061 7468 2e6a 6f69 6e28 0a20   os.path.join(. 
+000461a0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000461b0: 732e 7061 7468 2e64 6972 6e61 6d65 286f  s.path.dirname(o
+000461c0: 732e 7061 7468 2e61 6273 7061 7468 285f  s.path.abspath(_
+000461d0: 5f66 696c 655f 5f29 292c 2022 6461 7368  _file__)), "dash
+000461e0: 626f 6172 6422 2c20 2274 656d 706c 6174  board", "templat
+000461f0: 6573 220a 2020 2020 2020 2020 2020 2020  es".            
+00046200: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+00046210: 6d70 6c61 7465 5f65 6e76 6972 6f6e 6d65  mplate_environme
+00046220: 6e74 203d 2067 6574 5f65 6e76 2829 0a20  nt = get_env(). 
+00046230: 2020 2020 2020 2020 2020 2074 656d 706c             templ
+00046240: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
+00046250: 6c6f 6164 6572 2e73 6561 7263 6870 6174  loader.searchpat
+00046260: 682e 6170 7065 6e64 2874 656d 706c 6174  h.append(templat
+00046270: 655f 6469 7265 6374 6f72 7929 0a20 2020  e_directory).   
+00046280: 2020 2020 2020 2020 2074 656d 706c 6174           templat
+00046290: 6520 3d20 7465 6d70 6c61 7465 5f65 6e76  e = template_env
+000462a0: 6972 6f6e 6d65 6e74 2e67 6574 5f74 656d  ironment.get_tem
+000462b0: 706c 6174 6528 2270 6572 666f 726d 616e  plate("performan
+000462c0: 6365 5f72 6570 6f72 742e 6874 6d6c 2229  ce_report.html")
+000462d0: 0a20 2020 2020 2020 2020 2020 2073 6176  .            sav
+000462e0: 6528 7461 6273 2c20 6669 6c65 6e61 6d65  e(tabs, filename
+000462f0: 3d66 6e2c 2074 656d 706c 6174 653d 7465  =fn, template=te
+00046300: 6d70 6c61 7465 290a 0a20 2020 2020 2020  mplate)..       
+00046310: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
+00046320: 6e29 2061 7320 663a 0a20 2020 2020 2020  n) as f:.       
+00046330: 2020 2020 2020 2020 2064 6174 6120 3d20           data = 
+00046340: 662e 7265 6164 2829 0a0a 2020 2020 2020  f.read()..      
+00046350: 2020 7265 7475 726e 2064 6174 610a 0a20    return data.. 
+00046360: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
+00046370: 5f77 6f72 6b65 725f 6c6f 6773 2873 656c  _worker_logs(sel
+00046380: 662c 206e 3d4e 6f6e 652c 2077 6f72 6b65  f, n=None, worke
+00046390: 7273 3d4e 6f6e 652c 206e 616e 6e79 3d46  rs=None, nanny=F
+000463a0: 616c 7365 293a 0a20 2020 2020 2020 2072  alse):.        r
+000463b0: 6573 756c 7473 203d 2061 7761 6974 2073  esults = await s
+000463c0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
+000463d0: 2020 2020 2020 2020 2020 206d 7367 3d7b             msg={
+000463e0: 226f 7022 3a20 2267 6574 5f6c 6f67 7322  "op": "get_logs"
+000463f0: 2c20 226e 223a 206e 7d2c 2077 6f72 6b65  , "n": n}, worke
+00046400: 7273 3d77 6f72 6b65 7273 2c20 6e61 6e6e  rs=workers, nann
+00046410: 793d 6e61 6e6e 790a 2020 2020 2020 2020  y=nanny.        
+00046420: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00046430: 2072 6573 756c 7473 0a0a 2020 2020 6465   results..    de
+00046440: 6620 6c6f 675f 6576 656e 7428 7365 6c66  f log_event(self
+00046450: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
+00046460: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
+00046470: 6d73 673a 2041 6e79 2920 2d3e 204e 6f6e  msg: Any) -> Non
+00046480: 653a 0a20 2020 2020 2020 2022 2222 4c6f  e:.        """Lo
+00046490: 6720 616e 2065 7665 6e74 2075 6e64 6572  g an event under
+000464a0: 2061 2067 6976 656e 2074 6f70 6963 0a0a   a given topic..
+000464b0: 2020 2020 2020 2020 5061 7261 6d65 7465          Paramete
+000464c0: 7273 0a20 2020 2020 2020 202d 2d2d 2d2d  rs.        -----
+000464d0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 746f  -----.        to
+000464e0: 7069 6320 3a20 7374 722c 206c 6973 745b  pic : str, list[
+000464f0: 7374 725d 0a20 2020 2020 2020 2020 2020  str].           
+00046500: 204e 616d 6520 6f66 2074 6865 2074 6f70   Name of the top
+00046510: 6963 2075 6e64 6572 2077 6869 6368 2074  ic under which t
+00046520: 6f20 6c6f 6720 616e 2065 7665 6e74 2e20  o log an event. 
+00046530: 546f 206c 6f67 2074 6865 2073 616d 650a  To log the same.
+00046540: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00046550: 7420 756e 6465 7220 6d75 6c74 6970 6c65  t under multiple
+00046560: 2074 6f70 6963 732c 2070 6173 7320 6120   topics, pass a 
+00046570: 6c69 7374 206f 6620 746f 7069 6320 6e61  list of topic na
+00046580: 6d65 732e 0a20 2020 2020 2020 206d 7367  mes..        msg
+00046590: 0a20 2020 2020 2020 2020 2020 2045 7665  .            Eve
+000465a0: 6e74 206d 6573 7361 6765 2074 6f20 6c6f  nt message to lo
+000465b0: 672e 204e 6f74 6520 7468 6973 206d 7573  g. Note this mus
+000465c0: 7420 6265 206d 7367 7061 636b 2073 6572  t be msgpack ser
+000465d0: 6961 6c69 7a61 626c 652e 0a0a 2020 2020  ializable...    
+000465e0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+000465f0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00046600: 2020 2020 2020 436c 6965 6e74 2e6c 6f67        Client.log
+00046610: 5f65 7665 6e74 0a20 2020 2020 2020 2022  _event.        "
+00046620: 2222 0a20 2020 2020 2020 2065 7665 6e74  "".        event
+00046630: 203d 2028 7469 6d65 2829 2c20 6d73 6729   = (time(), msg)
+00046640: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00046650: 6973 696e 7374 616e 6365 2874 6f70 6963  isinstance(topic
+00046660: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+00046670: 2020 2020 666f 7220 7420 696e 2074 6f70      for t in top
+00046680: 6963 3a0a 2020 2020 2020 2020 2020 2020  ic:.            
+00046690: 2020 2020 7365 6c66 2e65 7665 6e74 735b      self.events[
+000466a0: 745d 2e61 7070 656e 6428 6576 656e 7429  t].append(event)
+000466b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000466c0: 2073 656c 662e 6576 656e 745f 636f 756e   self.event_coun
+000466d0: 7473 5b74 5d20 2b3d 2031 0a20 2020 2020  ts[t] += 1.     
+000466e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000466f0: 5f72 6570 6f72 745f 6576 656e 7428 742c  _report_event(t,
+00046700: 2065 7665 6e74 290a 2020 2020 2020 2020   event).        
+00046710: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00046720: 2020 7365 6c66 2e65 7665 6e74 735b 746f    self.events[to
+00046730: 7069 635d 2e61 7070 656e 6428 6576 656e  pic].append(even
+00046740: 7429 0a20 2020 2020 2020 2020 2020 2073  t).            s
+00046750: 656c 662e 6576 656e 745f 636f 756e 7473  elf.event_counts
+00046760: 5b74 6f70 6963 5d20 2b3d 2031 0a20 2020  [topic] += 1.   
+00046770: 2020 2020 2020 2020 2073 656c 662e 5f72           self._r
+00046780: 6570 6f72 745f 6576 656e 7428 746f 7069  eport_event(topi
+00046790: 632c 2065 7665 6e74 290a 0a20 2020 2020  c, event)..     
+000467a0: 2020 2020 2020 2066 6f72 2070 6c75 6769         for plugi
+000467b0: 6e20 696e 206c 6973 7428 7365 6c66 2e70  n in list(self.p
+000467c0: 6c75 6769 6e73 2e76 616c 7565 7328 2929  lugins.values())
+000467d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000467e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000467f0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+00046800: 6e2e 6c6f 675f 6576 656e 7428 746f 7069  n.log_event(topi
+00046810: 632c 206d 7367 290a 2020 2020 2020 2020  c, msg).        
+00046820: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00046830: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00046840: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00046850: 6767 6572 2e69 6e66 6f28 2250 6c75 6769  gger.info("Plugi
+00046860: 6e20 6661 696c 6564 2077 6974 6820 6578  n failed with ex
+00046870: 6365 7074 696f 6e22 2c20 6578 635f 696e  ception", exc_in
+00046880: 666f 3d54 7275 6529 0a0a 2020 2020 6465  fo=True)..    de
+00046890: 6620 5f72 6570 6f72 745f 6576 656e 7428  f _report_event(
+000468a0: 7365 6c66 2c20 6e61 6d65 2c20 6576 656e  self, name, even
+000468b0: 7429 3a0a 2020 2020 2020 2020 6d73 6720  t):.        msg 
+000468c0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000468d0: 226f 7022 3a20 2265 7665 6e74 222c 0a20  "op": "event",. 
+000468e0: 2020 2020 2020 2020 2020 2022 746f 7069             "topi
+000468f0: 6322 3a20 6e61 6d65 2c0a 2020 2020 2020  c": name,.      
+00046900: 2020 2020 2020 2265 7665 6e74 223a 2065        "event": e
+00046910: 7665 6e74 2c0a 2020 2020 2020 2020 7d0a  vent,.        }.
+00046920: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00046930: 7367 7320 3d20 7b63 6c69 656e 743a 205b  sgs = {client: [
+00046940: 6d73 675d 2066 6f72 2063 6c69 656e 7420  msg] for client 
+00046950: 696e 2073 656c 662e 6576 656e 745f 7375  in self.event_su
+00046960: 6273 6372 6962 6572 5b6e 616d 655d 7d0a  bscriber[name]}.
+00046970: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
+00046980: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
+00046990: 732c 2077 6f72 6b65 725f 6d73 6773 3d7b  s, worker_msgs={
+000469a0: 7d29 0a0a 2020 2020 6465 6620 7375 6273  })..    def subs
+000469b0: 6372 6962 655f 746f 7069 6328 7365 6c66  cribe_topic(self
+000469c0: 2c20 746f 7069 632c 2063 6c69 656e 7429  , topic, client)
+000469d0: 3a0a 2020 2020 2020 2020 7365 6c66 2e65  :.        self.e
+000469e0: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
+000469f0: 746f 7069 635d 2e61 6464 2863 6c69 656e  topic].add(clien
+00046a00: 7429 0a0a 2020 2020 6465 6620 756e 7375  t)..    def unsu
+00046a10: 6273 6372 6962 655f 746f 7069 6328 7365  bscribe_topic(se
+00046a20: 6c66 2c20 746f 7069 632c 2063 6c69 656e  lf, topic, clien
+00046a30: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
+00046a40: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
+00046a50: 725b 746f 7069 635d 2e64 6973 6361 7264  r[topic].discard
+00046a60: 2863 6c69 656e 7429 0a0a 2020 2020 6465  (client)..    de
+00046a70: 6620 6765 745f 6576 656e 7473 2873 656c  f get_events(sel
+00046a80: 662c 2074 6f70 6963 3d4e 6f6e 6529 3a0a  f, topic=None):.
+00046a90: 2020 2020 2020 2020 6966 2074 6f70 6963          if topic
+00046aa0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00046ab0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00046ac0: 2074 7570 6c65 2873 656c 662e 6576 656e   tuple(self.even
+00046ad0: 7473 5b74 6f70 6963 5d29 0a20 2020 2020  ts[topic]).     
+00046ae0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00046af0: 2020 2020 2072 6574 7572 6e20 7661 6c6d       return valm
+00046b00: 6170 2874 7570 6c65 2c20 7365 6c66 2e65  ap(tuple, self.e
+00046b10: 7665 6e74 7329 0a0a 2020 2020 6173 796e  vents)..    asyn
+00046b20: 6320 6465 6620 6765 745f 776f 726b 6572  c def get_worker
+00046b30: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7365  _monitor_info(se
+00046b40: 6c66 2c20 7265 6365 6e74 3d46 616c 7365  lf, recent=False
+00046b50: 2c20 7374 6172 7473 3d4e 6f6e 6529 3a0a  , starts=None):.
+00046b60: 2020 2020 2020 2020 6966 2073 7461 7274          if start
+00046b70: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00046b80: 2020 2020 2020 2073 7461 7274 7320 3d20         starts = 
+00046b90: 7b7d 0a20 2020 2020 2020 2072 6573 756c  {}.        resul
+00046ba0: 7473 203d 2061 7761 6974 2061 7379 6e63  ts = await async
+00046bb0: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00046bc0: 2020 2020 2020 202a 280a 2020 2020 2020         *(.      
+00046bd0: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00046be0: 7063 2877 292e 6765 745f 6d6f 6e69 746f  pc(w).get_monito
+00046bf0: 725f 696e 666f 2872 6563 656e 743d 7265  r_info(recent=re
+00046c00: 6365 6e74 2c20 7374 6172 743d 7374 6172  cent, start=star
+00046c10: 7473 2e67 6574 2877 2c20 3029 290a 2020  ts.get(w, 0)).  
+00046c20: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00046c30: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
+00046c40: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+00046c50: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+00046c60: 2020 2020 7265 7475 726e 2064 6963 7428      return dict(
+00046c70: 7a69 7028 7365 6c66 2e77 6f72 6b65 7273  zip(self.workers
+00046c80: 2c20 7265 7375 6c74 7329 290a 0a20 2020  , results))..   
+00046c90: 2023 2323 2323 2323 2323 2323 0a20 2020   ###########.   
+00046ca0: 2023 2043 6c65 616e 7570 2023 0a20 2020   # Cleanup #.   
+00046cb0: 2023 2323 2323 2323 2323 2323 0a0a 2020   ###########..  
+00046cc0: 2020 6173 796e 6320 6465 6620 6368 6563    async def chec
+00046cd0: 6b5f 776f 726b 6572 5f74 746c 2873 656c  k_worker_ttl(sel
+00046ce0: 6629 3a0a 2020 2020 2020 2020 6e6f 7720  f):.        now 
+00046cf0: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+00046d00: 2073 7469 6d75 6c75 735f 6964 203d 2066   stimulus_id = f
+00046d10: 2263 6865 636b 2d77 6f72 6b65 722d 7474  "check-worker-tt
+00046d20: 6c2d 7b6e 6f77 7d22 0a20 2020 2020 2020  l-{now}".       
+00046d30: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00046d40: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00046d50: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00046d60: 2028 7773 2e6c 6173 745f 7365 656e 203c   (ws.last_seen <
+00046d70: 206e 6f77 202d 2073 656c 662e 776f 726b   now - self.work
+00046d80: 6572 5f74 746c 2920 616e 6420 280a 2020  er_ttl) and (.  
+00046d90: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00046da0: 2e6c 6173 745f 7365 656e 203c 206e 6f77  .last_seen < now
+00046db0: 202d 2031 3020 2a20 6865 6172 7462 6561   - 10 * heartbea
+00046dc0: 745f 696e 7465 7276 616c 286c 656e 2873  t_interval(len(s
+00046dd0: 656c 662e 776f 726b 6572 7329 290a 2020  elf.workers)).  
+00046de0: 2020 2020 2020 2020 2020 293a 0a20 2020            ):.   
+00046df0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00046e00: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+00046e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046e20: 2022 576f 726b 6572 2066 6169 6c65 6420   "Worker failed 
+00046e30: 746f 2068 6561 7274 6265 6174 2077 6974  to heartbeat wit
+00046e40: 6869 6e20 2573 2073 6563 6f6e 6473 2e20  hin %s seconds. 
+00046e50: 436c 6f73 696e 673a 2025 7322 2c0a 2020  Closing: %s",.  
+00046e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046e70: 2020 7365 6c66 2e77 6f72 6b65 725f 7474    self.worker_tt
+00046e80: 6c2c 0a20 2020 2020 2020 2020 2020 2020  l,.             
+00046e90: 2020 2020 2020 2077 732c 0a20 2020 2020         ws,.     
+00046ea0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00046eb0: 2020 2020 2020 2020 2020 2020 2061 7761               awa
+00046ec0: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
+00046ed0: 6f72 6b65 7228 6164 6472 6573 733d 7773  orker(address=ws
+00046ee0: 2e61 6464 7265 7373 2c20 7374 696d 756c  .address, stimul
+00046ef0: 7573 5f69 643d 7374 696d 756c 7573 5f69  us_id=stimulus_i
+00046f00: 6429 0a0a 2020 2020 6465 6620 6368 6563  d)..    def chec
+00046f10: 6b5f 6964 6c65 2873 656c 6629 202d 3e20  k_idle(self) -> 
+00046f20: 666c 6f61 7420 7c20 4e6f 6e65 3a0a 2020  float | None:.  
+00046f30: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00046f40: 6174 7573 2069 6e20 2853 7461 7475 732e  atus in (Status.
+00046f50: 636c 6f73 696e 672c 2053 7461 7475 732e  closing, Status.
+00046f60: 636c 6f73 6564 293a 0a20 2020 2020 2020  closed):.       
+00046f70: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00046f80: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00046f90: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00046fa0: 6e74 6572 2021 3d20 7365 6c66 2e5f 6964  nter != self._id
+00046fb0: 6c65 5f74 7261 6e73 6974 696f 6e5f 636f  le_transition_co
+00046fc0: 756e 7465 723a 0a20 2020 2020 2020 2020  unter:.         
+00046fd0: 2020 2073 656c 662e 5f69 646c 655f 7472     self._idle_tr
+00046fe0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00046ff0: 203d 2073 656c 662e 7472 616e 7369 7469   = self.transiti
+00047000: 6f6e 5f63 6f75 6e74 6572 0a20 2020 2020  on_counter.     
+00047010: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00047020: 5f73 696e 6365 203d 204e 6f6e 650a 2020  _since = None.  
+00047030: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00047040: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+00047050: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
+00047060: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
+00047070: 2020 2020 2020 2020 6f72 2073 656c 662e          or self.
+00047080: 756e 7275 6e6e 6162 6c65 0a20 2020 2020  unrunnable.     
+00047090: 2020 2020 2020 206f 7220 616e 7928 7773         or any(ws
+000470a0: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
+000470b0: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+000470c0: 7273 2e76 616c 7565 7328 2929 0a20 2020  rs.values()).   
+000470d0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+000470e0: 2020 2020 7365 6c66 2e69 646c 655f 7369      self.idle_si
+000470f0: 6e63 6520 3d20 4e6f 6e65 0a20 2020 2020  nce = None.     
+00047100: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+00047110: 6e65 0a0a 2020 2020 2020 2020 6966 206e  ne..        if n
+00047120: 6f74 2073 656c 662e 6964 6c65 5f73 696e  ot self.idle_sin
+00047130: 6365 3a0a 2020 2020 2020 2020 2020 2020  ce:.            
+00047140: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+00047150: 3d20 7469 6d65 2829 0a20 2020 2020 2020  = time().       
+00047160: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00047170: 2e69 646c 655f 7369 6e63 650a 0a20 2020  .idle_since..   
+00047180: 2020 2020 2069 6620 7365 6c66 2e6a 7570       if self.jup
+00047190: 7974 6572 3a0a 2020 2020 2020 2020 2020  yter:.          
+000471a0: 2020 6c61 7374 5f61 6374 6976 6974 7920    last_activity 
+000471b0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+000471c0: 2020 2020 7365 6c66 2e5f 6a75 7079 7465      self._jupyte
+000471d0: 725f 7365 7276 6572 5f61 7070 6c69 6361  r_server_applica
+000471e0: 7469 6f6e 2e77 6562 5f61 7070 2e6c 6173  tion.web_app.las
+000471f0: 745f 6163 7469 7669 7479 2829 2e74 696d  t_activity().tim
+00047200: 6573 7461 6d70 2829 0a20 2020 2020 2020  estamp().       
+00047210: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00047220: 2020 2069 6620 6c61 7374 5f61 6374 6976     if last_activ
+00047230: 6974 7920 3e20 7365 6c66 2e69 646c 655f  ity > self.idle_
+00047240: 7369 6e63 653a 0a20 2020 2020 2020 2020  since:.         
+00047250: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00047260: 5f73 696e 6365 203d 206c 6173 745f 6163  _since = last_ac
+00047270: 7469 7669 7479 0a20 2020 2020 2020 2020  tivity.         
+00047280: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00047290: 6c66 2e69 646c 655f 7369 6e63 650a 0a20  lf.idle_since.. 
+000472a0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+000472b0: 646c 655f 7469 6d65 6f75 743a 0a20 2020  dle_timeout:.   
+000472c0: 2020 2020 2020 2020 2069 6620 7469 6d65           if time
+000472d0: 2829 203e 2073 656c 662e 6964 6c65 5f73  () > self.idle_s
+000472e0: 696e 6365 202b 2073 656c 662e 6964 6c65  ince + self.idle
+000472f0: 5f74 696d 656f 7574 3a0a 2020 2020 2020  _timeout:.      
+00047300: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00047310: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
+00047320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047330: 206c 6f67 6765 722e 696e 666f 280a 2020   logger.info(.  
+00047340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047350: 2020 2253 6368 6564 756c 6572 2063 6c6f    "Scheduler clo
+00047360: 7369 6e67 2061 6674 6572 2062 6569 6e67  sing after being
+00047370: 2069 646c 6520 666f 7220 2573 222c 0a20   idle for %s",. 
+00047380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047390: 2020 2066 6f72 6d61 745f 7469 6d65 2873     format_time(s
+000473a0: 656c 662e 6964 6c65 5f74 696d 656f 7574  elf.idle_timeout
+000473b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+000473c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000473d0: 2020 2020 2073 656c 662e 5f6f 6e67 6f69       self._ongoi
+000473e0: 6e67 5f62 6163 6b67 726f 756e 645f 7461  ng_background_ta
+000473f0: 736b 732e 6361 6c6c 5f73 6f6f 6e28 7365  sks.call_soon(se
+00047400: 6c66 2e63 6c6f 7365 290a 2020 2020 2020  lf.close).      
+00047410: 2020 7265 7475 726e 2073 656c 662e 6964    return self.id
+00047420: 6c65 5f73 696e 6365 0a0a 2020 2020 6465  le_since..    de
+00047430: 6620 6164 6170 7469 7665 5f74 6172 6765  f adaptive_targe
+00047440: 7428 7365 6c66 2c20 7461 7267 6574 5f64  t(self, target_d
+00047450: 7572 6174 696f 6e3d 4e6f 6e65 293a 0a20  uration=None):. 
+00047460: 2020 2020 2020 2022 2222 4465 7369 7265         """Desire
+00047470: 6420 6e75 6d62 6572 206f 6620 776f 726b  d number of work
+00047480: 6572 7320 6261 7365 6420 6f6e 2074 6865  ers based on the
+00047490: 2063 7572 7265 6e74 2077 6f72 6b6c 6f61   current workloa
+000474a0: 640a 0a20 2020 2020 2020 2054 6869 7320  d..        This 
+000474b0: 6c6f 6f6b 7320 6174 2074 6865 2063 7572  looks at the cur
+000474c0: 7265 6e74 2072 756e 6e69 6e67 2074 6173  rent running tas
+000474d0: 6b73 2061 6e64 206d 656d 6f72 7920 7573  ks and memory us
+000474e0: 652c 2061 6e64 2072 6574 7572 6e73 2061  e, and returns a
+000474f0: 0a20 2020 2020 2020 206e 756d 6265 7220  .        number 
+00047500: 6f66 2064 6573 6972 6564 2077 6f72 6b65  of desired worke
+00047510: 7273 2e20 2054 6869 7320 6973 206f 6674  rs.  This is oft
+00047520: 656e 2075 7365 6420 6279 2061 6461 7074  en used by adapt
+00047530: 6976 6520 7363 6865 6475 6c69 6e67 2e0a  ive scheduling..
+00047540: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00047550: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00047560: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2074  ------.        t
+00047570: 6172 6765 745f 6475 7261 7469 6f6e 203a  arget_duration :
+00047580: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
+00047590: 2041 2064 6573 6972 6564 2064 7572 6174   A desired durat
+000475a0: 696f 6e20 6f66 2074 696d 6520 666f 7220  ion of time for 
+000475b0: 636f 6d70 7574 6174 696f 6e73 2074 6f20  computations to 
+000475c0: 7461 6b65 2e20 2054 6869 7320 6166 6665  take.  This affe
+000475d0: 6374 730a 2020 2020 2020 2020 2020 2020  cts.            
+000475e0: 686f 7720 7261 7069 646c 7920 7468 6520  how rapidly the 
+000475f0: 7363 6865 6475 6c65 7220 7769 6c6c 2061  scheduler will a
+00047600: 736b 2074 6f20 7363 616c 652e 0a0a 2020  sk to scale...  
+00047610: 2020 2020 2020 5365 6520 416c 736f 0a20        See Also. 
+00047620: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+00047630: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+00047640: 7465 642e 6465 706c 6f79 2e41 6461 7074  ted.deploy.Adapt
+00047650: 6976 650a 2020 2020 2020 2020 2222 220a  ive.        """.
+00047660: 2020 2020 2020 2020 6966 2074 6172 6765          if targe
+00047670: 745f 6475 7261 7469 6f6e 2069 7320 4e6f  t_duration is No
+00047680: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00047690: 7461 7267 6574 5f64 7572 6174 696f 6e20  target_duration 
+000476a0: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
+000476b0: 7428 2264 6973 7472 6962 7574 6564 2e61  t("distributed.a
+000476c0: 6461 7074 6976 652e 7461 7267 6574 2d64  daptive.target-d
+000476d0: 7572 6174 696f 6e22 290a 2020 2020 2020  uration").      
+000476e0: 2020 7461 7267 6574 5f64 7572 6174 696f    target_duratio
+000476f0: 6e20 3d20 7061 7273 655f 7469 6d65 6465  n = parse_timede
+00047700: 6c74 6128 7461 7267 6574 5f64 7572 6174  lta(target_durat
+00047710: 696f 6e29 0a0a 2020 2020 2020 2020 2320  ion)..        # 
+00047720: 4350 550a 0a20 2020 2020 2020 2023 2054  CPU..        # T
+00047730: 4f44 4f20 636f 6e73 6964 6572 2061 6e79  ODO consider any
+00047740: 2075 7365 722d 7370 6563 6966 6965 6420   user-specified 
+00047750: 6465 6661 756c 7420 7461 736b 2064 7572  default task dur
+00047760: 6174 696f 6e73 2066 6f72 2071 7565 7565  ations for queue
+00047770: 6420 7461 736b 730a 2020 2020 2020 2020  d tasks.        
+00047780: 7175 6575 6564 5f6f 6363 7570 616e 6379  queued_occupancy
+00047790: 203d 206c 656e 2873 656c 662e 7175 6575   = len(self.queu
+000477a0: 6564 2920 2a20 7365 6c66 2e55 4e4b 4e4f  ed) * self.UNKNO
+000477b0: 574e 5f54 4153 4b5f 4455 5241 5449 4f4e  WN_TASK_DURATION
+000477c0: 0a20 2020 2020 2020 2063 7075 203d 206d  .        cpu = m
+000477d0: 6174 682e 6365 696c 280a 2020 2020 2020  ath.ceil(.      
+000477e0: 2020 2020 2020 2873 656c 662e 746f 7461        (self.tota
+000477f0: 6c5f 6f63 6375 7061 6e63 7920 2b20 7175  l_occupancy + qu
+00047800: 6575 6564 5f6f 6363 7570 616e 6379 2920  eued_occupancy) 
+00047810: 2f20 7461 7267 6574 5f64 7572 6174 696f  / target_duratio
+00047820: 6e0a 2020 2020 2020 2020 2920 2023 2054  n.        )  # T
+00047830: 4f44 4f3a 2074 6872 6561 6473 2070 6572  ODO: threads per
+00047840: 2077 6f72 6b65 720a 0a20 2020 2020 2020   worker..       
+00047850: 2023 2041 766f 6964 2061 2066 6577 206c   # Avoid a few l
+00047860: 6f6e 6720 7461 736b 7320 6672 6f6d 2061  ong tasks from a
+00047870: 736b 696e 6720 666f 7220 6d61 6e79 2063  sking for many c
+00047880: 6f72 6573 0a20 2020 2020 2020 2074 6173  ores.        tas
+00047890: 6b73 5f72 6561 6479 203d 206c 656e 2873  ks_ready = len(s
+000478a0: 656c 662e 7175 6575 6564 290a 2020 2020  elf.queued).    
+000478b0: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
+000478c0: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+000478d0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000478e0: 2074 6173 6b73 5f72 6561 6479 202b 3d20   tasks_ready += 
+000478f0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
+00047900: 6729 0a0a 2020 2020 2020 2020 2020 2020  g)..            
+00047910: 6966 2074 6173 6b73 5f72 6561 6479 203e  if tasks_ready >
+00047920: 2063 7075 3a0a 2020 2020 2020 2020 2020   cpu:.          
+00047930: 2020 2020 2020 6272 6561 6b0a 2020 2020        break.    
+00047940: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00047950: 2020 2020 2020 6370 7520 3d20 6d69 6e28        cpu = min(
+00047960: 7461 736b 735f 7265 6164 792c 2063 7075  tasks_ready, cpu
+00047970: 290a 0a20 2020 2020 2020 2069 6620 2873  )..        if (s
+00047980: 656c 662e 756e 7275 6e6e 6162 6c65 206f  elf.unrunnable o
+00047990: 7220 7365 6c66 2e71 7565 7565 6429 2061  r self.queued) a
+000479a0: 6e64 206e 6f74 2073 656c 662e 776f 726b  nd not self.work
+000479b0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000479c0: 2063 7075 203d 206d 6178 2831 2c20 6370   cpu = max(1, cp
+000479d0: 7529 0a0a 2020 2020 2020 2020 2320 6164  u)..        # ad
+000479e0: 6420 6d6f 7265 2077 6f72 6b65 7273 2069  d more workers i
+000479f0: 6620 6d6f 7265 2074 6861 6e20 3630 2520  f more than 60% 
+00047a00: 6f66 206d 656d 6f72 7920 6973 2075 7365  of memory is use
+00047a10: 640a 2020 2020 2020 2020 6c69 6d69 7420  d.        limit 
+00047a20: 3d20 7375 6d28 7773 2e6d 656d 6f72 795f  = sum(ws.memory_
+00047a30: 6c69 6d69 7420 666f 7220 7773 2069 6e20  limit for ws in 
+00047a40: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+00047a50: 7565 7328 2929 0a20 2020 2020 2020 2075  ues()).        u
+00047a60: 7365 6420 3d20 7375 6d28 7773 2e6e 6279  sed = sum(ws.nby
+00047a70: 7465 7320 666f 7220 7773 2069 6e20 7365  tes for ws in se
+00047a80: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+00047a90: 7328 2929 0a20 2020 2020 2020 206d 656d  s()).        mem
+00047aa0: 6f72 7920 3d20 300a 2020 2020 2020 2020  ory = 0.        
+00047ab0: 6966 2075 7365 6420 3e20 302e 3620 2a20  if used > 0.6 * 
+00047ac0: 6c69 6d69 7420 616e 6420 6c69 6d69 7420  limit and limit 
+00047ad0: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+00047ae0: 206d 656d 6f72 7920 3d20 3220 2a20 6c65   memory = 2 * le
+00047af0: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
+00047b00: 0a20 2020 2020 2020 2074 6172 6765 7420  .        target 
+00047b10: 3d20 6d61 7828 6d65 6d6f 7279 2c20 6370  = max(memory, cp
+00047b20: 7529 0a20 2020 2020 2020 2069 6620 7461  u).        if ta
+00047b30: 7267 6574 203e 3d20 6c65 6e28 7365 6c66  rget >= len(self
+00047b40: 2e77 6f72 6b65 7273 293a 0a20 2020 2020  .workers):.     
+00047b50: 2020 2020 2020 2072 6574 7572 6e20 7461         return ta
+00047b60: 7267 6574 0a20 2020 2020 2020 2065 6c73  rget.        els
+00047b70: 653a 2020 2320 5363 616c 6520 646f 776e  e:  # Scale down
+00047b80: 3f0a 2020 2020 2020 2020 2020 2020 746f  ?.            to
+00047b90: 5f63 6c6f 7365 203d 2073 656c 662e 776f  _close = self.wo
+00047ba0: 726b 6572 735f 746f 5f63 6c6f 7365 2829  rkers_to_close()
+00047bb0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00047bc0: 7572 6e20 6c65 6e28 7365 6c66 2e77 6f72  urn len(self.wor
+00047bd0: 6b65 7273 2920 2d20 6c65 6e28 746f 5f63  kers) - len(to_c
+00047be0: 6c6f 7365 290a 0a20 2020 2064 6566 2072  lose)..    def r
+00047bf0: 6571 7565 7374 5f61 6371 7569 7265 5f72  equest_acquire_r
+00047c00: 6570 6c69 6361 7328 0a20 2020 2020 2020  eplicas(.       
+00047c10: 2073 656c 662c 2061 6464 723a 2073 7472   self, addr: str
+00047c20: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
+00047c30: 5b73 7472 5d2c 202a 2c20 7374 696d 756c  [str], *, stimul
+00047c40: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
+00047c50: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00047c60: 2020 2222 2241 7379 6e63 6872 6f6e 6f75    """Asynchronou
+00047c70: 736c 7920 6173 6b20 6120 776f 726b 6572  sly ask a worker
+00047c80: 2074 6f20 6163 7175 6972 6520 6120 7265   to acquire a re
+00047c90: 706c 6963 6120 6f66 2074 6865 206c 6973  plica of the lis
+00047ca0: 7465 6420 6b65 7973 2066 726f 6d0a 2020  ted keys from.  
+00047cb0: 2020 2020 2020 6f74 6865 7220 776f 726b        other work
+00047cc0: 6572 732e 2054 6869 7320 6973 2061 2066  ers. This is a f
+00047cd0: 6972 652d 616e 642d 666f 7267 6574 206f  ire-and-forget o
+00047ce0: 7065 7261 7469 6f6e 2077 6869 6368 206f  peration which o
+00047cf0: 6666 6572 7320 6e6f 2066 6565 6462 6163  ffers no feedbac
+00047d00: 6b20 666f 720a 2020 2020 2020 2020 7375  k for.        su
+00047d10: 6363 6573 7320 6f72 2066 6169 6c75 7265  ccess or failure
+00047d20: 2c20 616e 6420 6973 2069 6e74 656e 6465  , and is intende
+00047d30: 6420 666f 7220 686f 7573 656b 6565 7069  d for housekeepi
+00047d40: 6e67 2061 6e64 206e 6f74 2066 6f72 2063  ng and not for c
+00047d50: 6f6d 7075 7461 7469 6f6e 2e0a 2020 2020  omputation..    
+00047d60: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00047d70: 7768 6f5f 6861 7320 3d20 7b7d 0a20 2020  who_has = {}.   
+00047d80: 2020 2020 206e 6279 7465 7320 3d20 7b7d       nbytes = {}
+00047d90: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00047da0: 2069 6e20 6b65 7973 3a0a 2020 2020 2020   in keys:.      
+00047db0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00047dc0: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00047dd0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00047de0: 2e77 686f 5f68 6173 0a20 2020 2020 2020  .who_has.       
+00047df0: 2020 2020 2077 686f 5f68 6173 5b6b 6579       who_has[key
+00047e00: 5d20 3d20 5b77 732e 6164 6472 6573 7320  ] = [ws.address 
+00047e10: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+00047e20: 5f68 6173 5d0a 2020 2020 2020 2020 2020  _has].          
+00047e30: 2020 6e62 7974 6573 5b6b 6579 5d20 3d20    nbytes[key] = 
+00047e40: 7473 2e6e 6279 7465 730a 0a20 2020 2020  ts.nbytes..     
+00047e50: 2020 2073 656c 662e 7374 7265 616d 5f63     self.stream_c
+00047e60: 6f6d 6d73 5b61 6464 725d 2e73 656e 6428  omms[addr].send(
+00047e70: 0a20 2020 2020 2020 2020 2020 207b 0a20  .            {. 
+00047e80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00047e90: 6f70 223a 2022 6163 7175 6972 652d 7265  op": "acquire-re
+00047ea0: 706c 6963 6173 222c 0a20 2020 2020 2020  plicas",.       
+00047eb0: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
+00047ec0: 7322 3a20 7768 6f5f 6861 732c 0a20 2020  s": who_has,.   
+00047ed0: 2020 2020 2020 2020 2020 2020 2022 6e62               "nb
+00047ee0: 7974 6573 223a 206e 6279 7465 732c 0a20  ytes": nbytes,. 
+00047ef0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00047f00: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+00047f10: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
+00047f20: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
+00047f30: 2020 290a 0a20 2020 2064 6566 2072 6571    )..    def req
+00047f40: 7565 7374 5f72 656d 6f76 655f 7265 706c  uest_remove_repl
+00047f50: 6963 6173 280a 2020 2020 2020 2020 7365  icas(.        se
+00047f60: 6c66 2c20 6164 6472 3a20 7374 722c 206b  lf, addr: str, k
+00047f70: 6579 733a 206c 6973 745b 7374 725d 2c20  eys: list[str], 
+00047f80: 2a2c 2073 7469 6d75 6c75 735f 6964 3a20  *, stimulus_id: 
+00047f90: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
+00047fa0: 653a 0a20 2020 2020 2020 2022 2222 4173  e:.        """As
+00047fb0: 796e 6368 726f 6e6f 7573 6c79 2061 736b  ynchronously ask
+00047fc0: 2061 2077 6f72 6b65 7220 746f 2064 6973   a worker to dis
+00047fd0: 6361 7264 2069 7473 2072 6570 6c69 6361  card its replica
+00047fe0: 206f 6620 7468 6520 6c69 7374 6564 206b   of the listed k
+00047ff0: 6579 732e 0a20 2020 2020 2020 2054 6869  eys..        Thi
+00048000: 7320 6d75 7374 206e 6576 6572 2062 6520  s must never be 
+00048010: 7573 6564 2074 6f20 6465 7374 726f 7920  used to destroy 
+00048020: 7468 6520 6c61 7374 2072 6570 6c69 6361  the last replica
+00048030: 206f 6620 6120 6b65 792e 2054 6869 7320   of a key. This 
+00048040: 6973 2061 0a20 2020 2020 2020 2066 6972  is a.        fir
+00048050: 652d 616e 642d 666f 7267 6574 206f 7065  e-and-forget ope
+00048060: 7261 7469 6f6e 2c20 696e 7465 6e64 6564  ration, intended
+00048070: 2066 6f72 2068 6f75 7365 6b65 6570 696e   for housekeepin
+00048080: 6720 616e 6420 6e6f 7420 666f 7220 636f  g and not for co
+00048090: 6d70 7574 6174 696f 6e2e 0a0a 2020 2020  mputation...    
+000480a0: 2020 2020 5468 6520 7265 706c 6963 6120      The replica 
+000480b0: 6469 7361 7070 6561 7273 2069 6d6d 6564  disappears immed
+000480c0: 6961 7465 6c79 2066 726f 6d20 5461 736b  iately from Task
+000480d0: 5374 6174 652e 7768 6f5f 6861 7320 6f6e  State.who_has on
+000480e0: 2074 6865 2053 6368 6564 756c 6572 2073   the Scheduler s
+000480f0: 6964 653b 0a20 2020 2020 2020 2069 6620  ide;.        if 
+00048100: 7468 6520 776f 726b 6572 2072 6566 7573  the worker refus
+00048110: 6573 2074 6f20 6465 6c65 7465 2c20 652e  es to delete, e.
+00048120: 672e 2062 6563 6175 7365 2074 6865 2074  g. because the t
+00048130: 6173 6b20 6973 2061 2064 6570 656e 6465  ask is a depende
+00048140: 6e63 7920 6f66 0a20 2020 2020 2020 2061  ncy of.        a
+00048150: 6e6f 7468 6572 2074 6173 6b20 7275 6e6e  nother task runn
+00048160: 696e 6720 6f6e 2069 742c 2069 7420 7769  ing on it, it wi
+00048170: 6c6c 2028 616c 736f 2061 7379 6e63 6872  ll (also asynchr
+00048180: 6f6e 6f75 736c 7929 2069 6e66 6f72 6d20  onously) inform 
+00048190: 7468 6520 7363 6865 6475 6c65 720a 2020  the scheduler.  
+000481a0: 2020 2020 2020 746f 2072 652d 6164 6420        to re-add 
+000481b0: 6974 7365 6c66 2074 6f20 7768 6f5f 6861  itself to who_ha
+000481c0: 732e 2049 6620 7468 6520 776f 726b 6572  s. If the worker
+000481d0: 2061 6772 6565 7320 746f 2064 6973 6361   agrees to disca
+000481e0: 7264 2074 6865 2074 6173 6b2c 2074 6865  rd the task, the
+000481f0: 7265 2069 730a 2020 2020 2020 2020 6e6f  re is.        no
+00048200: 2066 6565 6462 6163 6b2e 0a20 2020 2020   feedback..     
+00048210: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+00048220: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+00048230: 5b61 6464 725d 0a0a 2020 2020 2020 2020  [addr]..        
+00048240: 2320 5468 6520 7363 6865 6475 6c65 7220  # The scheduler 
+00048250: 696d 6d65 6469 6174 656c 7920 666f 7267  immediately forg
+00048260: 6574 7320 6162 6f75 7420 7468 6520 7265  ets about the re
+00048270: 706c 6963 6120 616e 6420 7375 6767 6573  plica and sugges
+00048280: 7473 2074 6865 2077 6f72 6b65 7220 746f  ts the worker to
+00048290: 0a20 2020 2020 2020 2023 2064 726f 7020  .        # drop 
+000482a0: 6974 2e20 5468 6520 776f 726b 6572 206d  it. The worker m
+000482b0: 6179 2072 6566 7573 652c 2061 7420 7768  ay refuse, at wh
+000482c0: 6963 6820 706f 696e 7420 6974 2077 696c  ich point it wil
+000482d0: 6c20 7365 6e64 2062 6163 6b20 616e 2061  l send back an a
+000482e0: 6464 2d6b 6579 730a 2020 2020 2020 2020  dd-keys.        
+000482f0: 2320 6d65 7373 6167 6520 746f 2072 6569  # message to rei
+00048300: 6e73 7461 7465 2069 742e 0a20 2020 2020  nstate it..     
+00048310: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+00048320: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
+00048330: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00048340: 6b65 795d 0a20 2020 2020 2020 2020 2020  key].           
+00048350: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00048360: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00048370: 2020 2023 2044 6f20 6e6f 7420 6465 7374     # Do not dest
+00048380: 726f 7920 7468 6520 6c61 7374 2063 6f70  roy the last cop
+00048390: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+000483a0: 2020 6173 7365 7274 206c 656e 2874 732e    assert len(ts.
+000483b0: 7768 6f5f 6861 7329 203e 2031 0a20 2020  who_has) > 1.   
+000483c0: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+000483d0: 6d6f 7665 5f72 6570 6c69 6361 2874 732c  move_replica(ts,
+000483e0: 2077 7329 0a0a 2020 2020 2020 2020 7365   ws)..        se
+000483f0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
+00048400: 6164 6472 5d2e 7365 6e64 280a 2020 2020  addr].send(.    
+00048410: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+00048420: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+00048430: 2272 656d 6f76 652d 7265 706c 6963 6173  "remove-replicas
+00048440: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00048450: 2020 2022 6b65 7973 223a 206b 6579 732c     "keys": keys,
+00048460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048470: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+00048480: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00048490: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+000484a0: 2020 2029 0a0a 0a64 6566 205f 7461 736b     )...def _task
+000484b0: 5f74 6f5f 7265 706f 7274 5f6d 7367 2874  _to_report_msg(t
+000484c0: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+000484d0: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
+000484e0: 7c20 4e6f 6e65 3a0a 2020 2020 6966 2074  | None:.    if t
+000484f0: 732e 7374 6174 6520 3d3d 2022 666f 7267  s.state == "forg
+00048500: 6f74 7465 6e22 3a0a 2020 2020 2020 2020  otten":.        
+00048510: 7265 7475 726e 207b 226f 7022 3a20 2263  return {"op": "c
+00048520: 616e 6365 6c6c 6564 2d6b 6579 7322 2c20  ancelled-keys", 
+00048530: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
+00048540: 7d0a 2020 2020 656c 6966 2074 732e 7374  }.    elif ts.st
+00048550: 6174 6520 3d3d 2022 6d65 6d6f 7279 223a  ate == "memory":
+00048560: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048570: 7b22 6f70 223a 2022 6b65 792d 696e 2d6d  {"op": "key-in-m
+00048580: 656d 6f72 7922 2c20 226b 6579 223a 2074  emory", "key": t
+00048590: 732e 6b65 797d 0a20 2020 2065 6c69 6620  s.key}.    elif 
+000485a0: 7473 2e73 7461 7465 203d 3d20 2265 7272  ts.state == "err
+000485b0: 6564 223a 0a20 2020 2020 2020 2066 6169  ed":.        fai
+000485c0: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
+000485d0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
+000485e0: 2020 2020 2061 7373 6572 7420 6661 696c       assert fail
+000485f0: 696e 675f 7473 0a20 2020 2020 2020 2072  ing_ts.        r
+00048600: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
+00048610: 2020 2020 226f 7022 3a20 2274 6173 6b2d      "op": "task-
+00048620: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+00048630: 2020 2020 226b 6579 223a 2074 732e 6b65      "key": ts.ke
+00048640: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+00048650: 6578 6365 7074 696f 6e22 3a20 6661 696c  exception": fail
+00048660: 696e 675f 7473 2e65 7863 6570 7469 6f6e  ing_ts.exception
+00048670: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+00048680: 7261 6365 6261 636b 223a 2066 6169 6c69  raceback": faili
+00048690: 6e67 5f74 732e 7472 6163 6562 6163 6b2c  ng_ts.traceback,
+000486a0: 0a20 2020 2020 2020 207d 0a20 2020 2065  .        }.    e
+000486b0: 6c73 653a 0a20 2020 2020 2020 2072 6574  lse:.        ret
+000486c0: 7572 6e20 4e6f 6e65 0a0a 0a64 6566 205f  urn None...def _
+000486d0: 7461 736b 5f74 6f5f 636c 6965 6e74 5f6d  task_to_client_m
+000486e0: 7367 7328 7473 3a20 5461 736b 5374 6174  sgs(ts: TaskStat
+000486f0: 6529 202d 3e20 6469 6374 5b73 7472 2c20  e) -> dict[str, 
+00048700: 6c69 7374 5b64 6963 745b 7374 722c 2041  list[dict[str, A
+00048710: 6e79 5d5d 5d3a 0a20 2020 2069 6620 7473  ny]]]:.    if ts
+00048720: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+00048730: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
+00048740: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
+00048750: 5f6d 7367 2874 7329 0a20 2020 2020 2020  _msg(ts).       
+00048760: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
+00048770: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00048780: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00048790: 6373 2e63 6c69 656e 745f 6b65 793a 205b  cs.client_key: [
+000487a0: 7265 706f 7274 5f6d 7367 5d20 666f 7220  report_msg] for 
+000487b0: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+000487c0: 7473 7d0a 2020 2020 7265 7475 726e 207b  ts}.    return {
+000487d0: 7d0a 0a0a 6465 6620 6465 6369 6465 5f77  }...def decide_w
+000487e0: 6f72 6b65 7228 0a20 2020 2074 733a 2054  orker(.    ts: T
+000487f0: 6173 6b53 7461 7465 2c0a 2020 2020 616c  askState,.    al
+00048800: 6c5f 776f 726b 6572 733a 2049 7465 7261  l_workers: Itera
+00048810: 626c 655b 576f 726b 6572 5374 6174 655d  ble[WorkerState]
+00048820: 2c0a 2020 2020 7661 6c69 645f 776f 726b  ,.    valid_work
+00048830: 6572 733a 2073 6574 5b57 6f72 6b65 7253  ers: set[WorkerS
+00048840: 7461 7465 5d20 7c20 4e6f 6e65 2c0a 2020  tate] | None,.  
+00048850: 2020 6f62 6a65 6374 6976 653a 2043 616c    objective: Cal
+00048860: 6c61 626c 655b 5b57 6f72 6b65 7253 7461  lable[[WorkerSta
+00048870: 7465 5d2c 2041 6e79 5d2c 0a29 202d 3e20  te], Any],.) -> 
+00048880: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00048890: 6e65 3a0a 2020 2020 2222 220a 2020 2020  ne:.    """.    
+000488a0: 4465 6369 6465 2077 6869 6368 2077 6f72  Decide which wor
+000488b0: 6b65 7220 7368 6f75 6c64 2074 616b 6520  ker should take 
+000488c0: 7461 736b 202a 7473 2a2e 0a0a 2020 2020  task *ts*...    
+000488d0: 5765 2063 686f 6f73 6520 7468 6520 776f  We choose the wo
+000488e0: 726b 6572 2074 6861 7420 6861 7320 7468  rker that has th
+000488f0: 6520 6461 7461 206f 6e20 7768 6963 6820  e data on which 
+00048900: 2a74 732a 2064 6570 656e 6473 2e0a 0a20  *ts* depends... 
+00048910: 2020 2049 6620 7365 7665 7261 6c20 776f     If several wo
+00048920: 726b 6572 7320 6861 7665 2064 6570 656e  rkers have depen
+00048930: 6465 6e63 6965 7320 7468 656e 2077 6520  dencies then we 
+00048940: 6368 6f6f 7365 2074 6865 206c 6573 732d  choose the less-
+00048950: 6275 7379 2077 6f72 6b65 722e 0a0a 2020  busy worker...  
+00048960: 2020 4f70 7469 6f6e 616c 6c79 2070 726f    Optionally pro
+00048970: 7669 6465 202a 7661 6c69 645f 776f 726b  vide *valid_work
+00048980: 6572 732a 206f 6620 7768 6572 6520 6a6f  ers* of where jo
+00048990: 6273 2061 7265 2061 6c6c 6f77 6564 2074  bs are allowed t
+000489a0: 6f20 6f63 6375 720a 2020 2020 2869 6620  o occur.    (if 
+000489b0: 616c 6c20 776f 726b 6572 7320 6172 6520  all workers are 
+000489c0: 616c 6c6f 7765 6420 746f 2074 616b 6520  allowed to take 
+000489d0: 7468 6520 7461 736b 2c20 7061 7373 204e  the task, pass N
+000489e0: 6f6e 6520 696e 7374 6561 6429 2e0a 0a20  one instead)... 
+000489f0: 2020 2049 6620 7468 6520 7461 736b 2072     If the task r
+00048a00: 6571 7569 7265 7320 6461 7461 2063 6f6d  equires data com
+00048a10: 6d75 6e69 6361 7469 6f6e 2062 6563 6175  munication becau
+00048a20: 7365 206e 6f20 656c 6967 6962 6c65 2077  se no eligible w
+00048a30: 6f72 6b65 7220 6861 730a 2020 2020 616c  orker has.    al
+00048a40: 6c20 7468 6520 6465 7065 6e64 656e 6369  l the dependenci
+00048a50: 6573 2061 6c72 6561 6479 2c20 7468 656e  es already, then
+00048a60: 2077 6520 6368 6f6f 7365 2074 6f20 6d69   we choose to mi
+00048a70: 6e69 6d69 7a65 2074 6865 206e 756d 6265  nimize the numbe
+00048a80: 720a 2020 2020 6f66 2062 7974 6573 2073  r.    of bytes s
+00048a90: 656e 7420 6265 7477 6565 6e20 776f 726b  ent between work
+00048aa0: 6572 732e 2020 5468 6973 2069 7320 6465  ers.  This is de
+00048ab0: 7465 726d 696e 6564 2062 7920 6361 6c6c  termined by call
+00048ac0: 696e 6720 7468 650a 2020 2020 2a6f 626a  ing the.    *obj
+00048ad0: 6563 7469 7665 2a20 6675 6e63 7469 6f6e  ective* function
+00048ae0: 2e0a 2020 2020 2222 220a 2020 2020 6173  ..    """.    as
+00048af0: 7365 7274 2061 6c6c 2864 7473 2e77 686f  sert all(dts.who
+00048b00: 5f68 6173 2066 6f72 2064 7473 2069 6e20  _has for dts in 
+00048b10: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00048b20: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
+00048b30: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
+00048b40: 6174 6573 203d 2073 6574 2861 6c6c 5f77  ates = set(all_w
+00048b50: 6f72 6b65 7273 290a 2020 2020 656c 7365  orkers).    else
+00048b60: 3a0a 2020 2020 2020 2020 6361 6e64 6964  :.        candid
+00048b70: 6174 6573 203d 207b 7777 7320 666f 7220  ates = {wws for 
+00048b80: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
+00048b90: 656e 6369 6573 2066 6f72 2077 7773 2069  encies for wws i
+00048ba0: 6e20 6474 732e 7768 6f5f 6861 737d 0a20  n dts.who_has}. 
+00048bb0: 2020 2069 6620 7661 6c69 645f 776f 726b     if valid_work
+00048bc0: 6572 7320 6973 204e 6f6e 653a 0a20 2020  ers is None:.   
+00048bd0: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
+00048be0: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
+00048bf0: 2020 2020 6361 6e64 6964 6174 6573 203d      candidates =
+00048c00: 2073 6574 2861 6c6c 5f77 6f72 6b65 7273   set(all_workers
+00048c10: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00048c20: 2020 2020 6361 6e64 6964 6174 6573 2026      candidates &
+00048c30: 3d20 7661 6c69 645f 776f 726b 6572 730a  = valid_workers.
+00048c40: 2020 2020 2020 2020 6966 206e 6f74 2063          if not c
+00048c50: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
+00048c60: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
+00048c70: 7320 3d20 7661 6c69 645f 776f 726b 6572  s = valid_worker
+00048c80: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+00048c90: 206e 6f74 2063 616e 6469 6461 7465 733a   not candidates:
+00048ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048cb0: 2069 6620 7473 2e6c 6f6f 7365 5f72 6573   if ts.loose_res
+00048cc0: 7472 6963 7469 6f6e 733a 0a20 2020 2020  trictions:.     
+00048cd0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00048ce0: 6574 7572 6e20 6465 6369 6465 5f77 6f72  eturn decide_wor
+00048cf0: 6b65 7228 7473 2c20 616c 6c5f 776f 726b  ker(ts, all_work
+00048d00: 6572 732c 204e 6f6e 652c 206f 626a 6563  ers, None, objec
+00048d10: 7469 7665 290a 0a20 2020 2069 6620 6e6f  tive)..    if no
+00048d20: 7420 6361 6e64 6964 6174 6573 3a0a 2020  t candidates:.  
+00048d30: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00048d40: 650a 2020 2020 656c 6966 206c 656e 2863  e.    elif len(c
+00048d50: 616e 6469 6461 7465 7329 203d 3d20 313a  andidates) == 1:
+00048d60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048d70: 6e65 7874 2869 7465 7228 6361 6e64 6964  next(iter(candid
+00048d80: 6174 6573 2929 0a20 2020 2065 6c73 653a  ates)).    else:
+00048d90: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00048da0: 6d69 6e28 6361 6e64 6964 6174 6573 2c20  min(candidates, 
+00048db0: 6b65 793d 6f62 6a65 6374 6976 6529 0a0a  key=objective)..
+00048dc0: 0a64 6566 2076 616c 6964 6174 655f 7461  .def validate_ta
+00048dd0: 736b 5f73 7461 7465 2874 733a 2054 6173  sk_state(ts: Tas
+00048de0: 6b53 7461 7465 2920 2d3e 204e 6f6e 653a  kState) -> None:
+00048df0: 0a20 2020 2022 2222 5661 6c69 6461 7465  .    """Validate
+00048e00: 2074 6865 2067 6976 656e 2054 6173 6b53   the given TaskS
+00048e10: 7461 7465 2222 220a 2020 2020 6173 7365  tate""".    asse
+00048e20: 7274 2074 732e 7374 6174 6520 696e 2041  rt ts.state in A
+00048e30: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
+00048e40: 7473 0a0a 2020 2020 6966 2074 732e 7761  ts..    if ts.wa
+00048e50: 6974 696e 675f 6f6e 3a0a 2020 2020 2020  iting_on:.      
+00048e60: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
+00048e70: 696e 675f 6f6e 2e69 7373 7562 7365 7428  ing_on.issubset(
+00048e80: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+00048e90: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+00048ea0: 2277 6169 7469 6e67 206e 6f74 2073 7562  "waiting not sub
+00048eb0: 7365 7420 6f66 2064 6570 656e 6465 6e63  set of dependenc
+00048ec0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+00048ed0: 2020 7374 7228 7473 2e77 6169 7469 6e67    str(ts.waiting
+00048ee0: 5f6f 6e29 2c0a 2020 2020 2020 2020 2020  _on),.          
+00048ef0: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
+00048f00: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
+00048f10: 290a 2020 2020 6966 2074 732e 7761 6974  ).    if ts.wait
+00048f20: 6572 733a 0a20 2020 2020 2020 2061 7373  ers:.        ass
+00048f30: 6572 7420 7473 2e77 6169 7465 7273 2e69  ert ts.waiters.i
+00048f40: 7373 7562 7365 7428 7473 2e64 6570 656e  ssubset(ts.depen
+00048f50: 6465 6e74 7329 2c20 280a 2020 2020 2020  dents), (.      
+00048f60: 2020 2020 2020 2277 6169 7465 7273 206e        "waiters n
+00048f70: 6f74 2073 7562 7365 7420 6f66 2064 6570  ot subset of dep
+00048f80: 656e 6465 6e74 7322 2c0a 2020 2020 2020  endents",.      
+00048f90: 2020 2020 2020 7374 7228 7473 2e77 6169        str(ts.wai
+00048fa0: 7465 7273 292c 0a20 2020 2020 2020 2020  ters),.         
+00048fb0: 2020 2073 7472 2874 732e 6465 7065 6e64     str(ts.depend
+00048fc0: 656e 7473 292c 0a20 2020 2020 2020 2029  ents),.        )
+00048fd0: 0a0a 2020 2020 666f 7220 6474 7320 696e  ..    for dts in
+00048fe0: 2074 732e 7761 6974 696e 675f 6f6e 3a0a   ts.waiting_on:.
+00048ff0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00049000: 6f74 2064 7473 2e77 686f 5f68 6173 2c20  ot dts.who_has, 
+00049010: 2822 7761 6974 696e 6720 6f6e 2069 6e2d  ("waiting on in-
+00049020: 6d65 6d6f 7279 2064 6570 222c 2073 7472  memory dep", str
+00049030: 2874 7329 2c20 7374 7228 6474 7329 290a  (ts), str(dts)).
+00049040: 2020 2020 2020 2020 6173 7365 7274 2064          assert d
+00049050: 7473 2e73 7461 7465 2021 3d20 2272 656c  ts.state != "rel
+00049060: 6561 7365 6422 2c20 2822 7761 6974 696e  eased", ("waitin
+00049070: 6720 6f6e 2072 656c 6561 7365 6420 6465  g on released de
+00049080: 7022 2c20 7374 7228 7473 292c 2073 7472  p", str(ts), str
+00049090: 2864 7473 2929 0a20 2020 2066 6f72 2064  (dts)).    for d
+000490a0: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
+000490b0: 6e63 6965 733a 0a20 2020 2020 2020 2061  ncies:.        a
+000490c0: 7373 6572 7420 7473 2069 6e20 6474 732e  ssert ts in dts.
+000490d0: 6465 7065 6e64 656e 7473 2c20 280a 2020  dependents, (.  
+000490e0: 2020 2020 2020 2020 2020 226e 6f74 2069            "not i
+000490f0: 6e20 6465 7065 6e64 656e 6379 2773 2064  n dependency's d
+00049100: 6570 656e 6465 6e74 7322 2c0a 2020 2020  ependents",.    
+00049110: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049120: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049130: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
+00049140: 2020 2073 7472 2864 7473 2e64 6570 656e     str(dts.depen
+00049150: 6465 6e74 7329 2c0a 2020 2020 2020 2020  dents),.        
+00049160: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
+00049170: 7374 6174 6520 696e 2028 2277 6169 7469  state in ("waiti
+00049180: 6e67 222c 2022 7175 6575 6564 222c 2022  ng", "queued", "
+00049190: 7072 6f63 6573 7369 6e67 222c 2022 6e6f  processing", "no
+000491a0: 2d77 6f72 6b65 7222 293a 0a20 2020 2020  -worker"):.     
+000491b0: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
+000491c0: 7320 696e 2074 732e 7761 6974 696e 675f  s in ts.waiting_
+000491d0: 6f6e 206f 7220 6474 732e 7768 6f5f 6861  on or dts.who_ha
+000491e0: 732c 2028 0a20 2020 2020 2020 2020 2020  s, (.           
+000491f0: 2020 2020 2022 6465 7020 6d69 7373 696e       "dep missin
+00049200: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+00049210: 2020 2020 7374 7228 7473 292c 0a20 2020      str(ts),.   
+00049220: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00049230: 2864 7473 292c 0a20 2020 2020 2020 2020  (dts),.         
+00049240: 2020 2029 0a20 2020 2020 2020 2061 7373     ).        ass
+00049250: 6572 7420 6474 732e 7374 6174 6520 213d  ert dts.state !=
+00049260: 2022 666f 7267 6f74 7465 6e22 0a0a 2020   "forgotten"..  
+00049270: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00049280: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
+00049290: 2061 7373 6572 7420 6474 732e 7374 6174   assert dts.stat
+000492a0: 6520 696e 2028 2277 6169 7469 6e67 222c  e in ("waiting",
+000492b0: 2022 7175 6575 6564 222c 2022 7072 6f63   "queued", "proc
+000492c0: 6573 7369 6e67 222c 2022 6e6f 2d77 6f72  essing", "no-wor
+000492d0: 6b65 7222 292c 2028 0a20 2020 2020 2020  ker"), (.       
+000492e0: 2020 2020 2022 7761 6974 6572 206e 6f74       "waiter not
+000492f0: 2069 6e20 706c 6179 222c 0a20 2020 2020   in play",.     
+00049300: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+00049310: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+00049320: 6474 7329 2c0a 2020 2020 2020 2020 290a  dts),.        ).
+00049330: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
+00049340: 732e 6465 7065 6e64 656e 7473 3a0a 2020  s.dependents:.  
+00049350: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00049360: 696e 2064 7473 2e64 6570 656e 6465 6e63  in dts.dependenc
+00049370: 6965 732c 2028 0a20 2020 2020 2020 2020  ies, (.         
+00049380: 2020 2022 6e6f 7420 696e 2064 6570 656e     "not in depen
+00049390: 6465 6e74 2773 2064 6570 656e 6465 6e63  dent's dependenc
+000493a0: 6965 7322 2c0a 2020 2020 2020 2020 2020  ies",.          
+000493b0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+000493c0: 2020 2020 2020 2073 7472 2864 7473 292c         str(dts),
+000493d0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+000493e0: 2864 7473 2e64 6570 656e 6465 6e63 6965  (dts.dependencie
+000493f0: 7329 2c0a 2020 2020 2020 2020 290a 2020  s),.        ).  
+00049400: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+00049410: 2e73 7461 7465 2021 3d20 2266 6f72 676f  .state != "forgo
+00049420: 7474 656e 220a 0a20 2020 2061 7373 6572  tten"..    asser
+00049430: 7420 2874 732e 7072 6f63 6573 7369 6e67  t (ts.processing
+00049440: 5f6f 6e20 6973 206e 6f74 204e 6f6e 6529  _on is not None)
+00049450: 203d 3d20 2874 732e 7374 6174 6520 3d3d   == (ts.state ==
+00049460: 2022 7072 6f63 6573 7369 6e67 2229 0a20   "processing"). 
+00049470: 2020 2061 7373 6572 7420 626f 6f6c 2874     assert bool(t
+00049480: 732e 7768 6f5f 6861 7329 203d 3d20 2874  s.who_has) == (t
+00049490: 732e 7374 6174 6520 3d3d 2022 6d65 6d6f  s.state == "memo
+000494a0: 7279 2229 2c20 2874 732c 2074 732e 7768  ry"), (ts, ts.wh
+000494b0: 6f5f 6861 732c 2074 732e 7374 6174 6529  o_has, ts.state)
+000494c0: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
+000494d0: 6520 3d3d 2022 7175 6575 6564 223a 0a20  e == "queued":. 
+000494e0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+000494f0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
+00049500: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
+00049510: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
+00049520: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00049530: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
+00049540: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+00049550: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
+00049560: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+00049570: 2071 7565 7565 6420 7769 7468 6f75 7420   queued without 
+00049580: 616c 6c20 6465 7073 222c 0a20 2020 2020  all deps",.     
+00049590: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+000495a0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+000495b0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+000495c0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000495d0: 2069 6620 7473 2e73 7461 7465 203d 3d20   if ts.state == 
+000495e0: 2270 726f 6365 7373 696e 6722 3a0a 2020  "processing":.  
+000495f0: 2020 2020 2020 6173 7365 7274 2061 6c6c        assert all
+00049600: 2864 7473 2e77 686f 5f68 6173 2066 6f72  (dts.who_has for
+00049610: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00049620: 6465 6e63 6965 7329 2c20 280a 2020 2020  dencies), (.    
+00049630: 2020 2020 2020 2020 2274 6173 6b20 7072          "task pr
+00049640: 6f63 6573 7369 6e67 2077 6974 686f 7574  ocessing without
+00049650: 2061 6c6c 2064 6570 7322 2c0a 2020 2020   all deps",.    
+00049660: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049670: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049680: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
+00049690: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+000496a0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000496b0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 0a20  ts.waiting_on.. 
+000496c0: 2020 2069 6620 7473 2e77 686f 5f68 6173     if ts.who_has
+000496d0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+000496e0: 2074 732e 7761 6974 6572 7320 6f72 2074   ts.waiters or t
+000496f0: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
+00049700: 2020 2020 2020 2020 2020 2022 756e 6e65             "unne
+00049710: 6564 6564 2074 6173 6b20 696e 206d 656d  eded task in mem
+00049720: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
+00049730: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+00049740: 2020 2020 2020 2073 7472 2874 732e 7768         str(ts.wh
+00049750: 6f5f 6861 7329 2c0a 2020 2020 2020 2020  o_has),.        
+00049760: 290a 2020 2020 2020 2020 6966 2074 732e  ).        if ts.
+00049770: 7275 6e5f 7370 6563 3a20 2023 2077 6173  run_spec:  # was
+00049780: 2063 6f6d 7075 7465 640a 2020 2020 2020   computed.      
+00049790: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+000497a0: 7479 7065 0a20 2020 2020 2020 2020 2020  type.           
+000497b0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+000497c0: 6365 2874 732e 7479 7065 2c20 7374 7229  ce(ts.type, str)
+000497d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000497e0: 6e6f 7420 616e 7928 5b74 7320 696e 2064  not any([ts in d
+000497f0: 7473 2e77 6169 7469 6e67 5f6f 6e20 666f  ts.waiting_on fo
+00049800: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00049810: 6e64 656e 7473 5d29 0a20 2020 2020 2020  ndents]).       
+00049820: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
+00049830: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+00049840: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00049850: 7773 2e68 6173 5f77 6861 742c 2028 0a20  ws.has_what, (. 
+00049860: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00049870: 6e6f 7420 696e 2077 686f 5f68 6173 2720  not in who_has' 
+00049880: 6861 735f 7768 6174 222c 0a20 2020 2020  has_what",.     
+00049890: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+000498a0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+000498b0: 2020 2020 7374 7228 7773 292c 0a20 2020      str(ws),.   
+000498c0: 2020 2020 2020 2020 2020 2020 2073 7472               str
+000498d0: 2877 732e 6861 735f 7768 6174 292c 0a20  (ws.has_what),. 
+000498e0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000498f0: 2020 666f 7220 6373 2069 6e20 7473 2e77    for cs in ts.w
+00049900: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
+00049910: 2020 6173 7365 7274 2074 7320 696e 2063    assert ts in c
+00049920: 732e 7761 6e74 735f 7768 6174 2c20 280a  s.wants_what, (.
+00049930: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
+00049940: 2069 6e20 7768 6f5f 7761 6e74 7327 2077   in who_wants' w
+00049950: 616e 7473 5f77 6861 7422 2c0a 2020 2020  ants_what",.    
+00049960: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049970: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+00049980: 2863 7329 2c0a 2020 2020 2020 2020 2020  (cs),.          
+00049990: 2020 7374 7228 6373 2e77 616e 7473 5f77    str(cs.wants_w
+000499a0: 6861 7429 2c0a 2020 2020 2020 2020 290a  hat),.        ).
+000499b0: 0a20 2020 2069 6620 7473 2e61 6374 6f72  .    if ts.actor
+000499c0: 3a0a 2020 2020 2020 2020 6966 2074 732e  :.        if ts.
+000499d0: 7374 6174 6520 3d3d 2022 6d65 6d6f 7279  state == "memory
+000499e0: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
+000499f0: 7373 6572 7420 7375 6d28 7473 2069 6e20  ssert sum(ts in 
+00049a00: 7773 2e61 6374 6f72 7320 666f 7220 7773  ws.actors for ws
+00049a10: 2069 6e20 7473 2e77 686f 5f68 6173 2920   in ts.who_has) 
+00049a20: 3d3d 2031 0a20 2020 2020 2020 2069 6620  == 1.        if 
+00049a30: 7473 2e73 7461 7465 203d 3d20 2270 726f  ts.state == "pro
+00049a40: 6365 7373 696e 6722 3a0a 2020 2020 2020  cessing":.      
+00049a50: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00049a60: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+00049a70: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00049a80: 2074 7320 696e 2074 732e 7072 6f63 6573   ts in ts.proces
+00049a90: 7369 6e67 5f6f 6e2e 6163 746f 7273 0a20  sing_on.actors. 
+00049aa0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00049ab0: 2e73 7461 7465 2021 3d20 2271 7565 7565  .state != "queue
+00049ac0: 6422 0a0a 0a64 6566 2076 616c 6964 6174  d"...def validat
+00049ad0: 655f 776f 726b 6572 5f73 7461 7465 2877  e_worker_state(w
+00049ae0: 733a 2057 6f72 6b65 7253 7461 7465 2920  s: WorkerState) 
+00049af0: 2d3e 204e 6f6e 653a 0a20 2020 2066 6f72  -> None:.    for
+00049b00: 2074 7320 696e 2077 732e 6861 735f 7768   ts in ws.has_wh
+00049b10: 6174 3a0a 2020 2020 2020 2020 6173 7365  at:.        asse
+00049b20: 7274 2077 7320 696e 2074 732e 7768 6f5f  rt ws in ts.who_
+00049b30: 6861 732c 2028 0a20 2020 2020 2020 2020  has, (.         
+00049b40: 2020 2022 6e6f 7420 696e 2068 6173 5f77     "not in has_w
+00049b50: 6861 7427 2077 686f 5f68 6173 222c 0a20  hat' who_has",. 
+00049b60: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
+00049b70: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00049b80: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
+00049b90: 2020 2020 2073 7472 2874 732e 7768 6f5f       str(ts.who_
+00049ba0: 6861 7329 2c0a 2020 2020 2020 2020 290a  has),.        ).
+00049bb0: 0a20 2020 2066 6f72 2074 7320 696e 2077  .    for ts in w
+00049bc0: 732e 6163 746f 7273 3a0a 2020 2020 2020  s.actors:.      
+00049bd0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+00049be0: 6520 696e 2028 226d 656d 6f72 7922 2c20  e in ("memory", 
+00049bf0: 2270 726f 6365 7373 696e 6722 290a 0a0a  "processing")...
+00049c00: 6465 6620 7661 6c69 6461 7465 5f73 7461  def validate_sta
+00049c10: 7465 280a 2020 2020 7461 736b 733a 2064  te(.    tasks: d
+00049c20: 6963 745b 7374 722c 2054 6173 6b53 7461  ict[str, TaskSta
+00049c30: 7465 5d2c 0a20 2020 2077 6f72 6b65 7273  te],.    workers
+00049c40: 3a20 6469 6374 5b73 7472 2c20 576f 726b  : dict[str, Work
+00049c50: 6572 5374 6174 655d 2c0a 2020 2020 636c  erState],.    cl
+00049c60: 6965 6e74 733a 2064 6963 745b 7374 722c  ients: dict[str,
+00049c70: 2043 6c69 656e 7453 7461 7465 5d2c 0a29   ClientState],.)
+00049c80: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2222   -> None:.    ""
+00049c90: 2256 616c 6964 6174 6520 6120 6375 7272  "Validate a curr
+00049ca0: 656e 7420 7275 6e74 696d 6520 7374 6174  ent runtime stat
+00049cb0: 652e 0a0a 2020 2020 5468 6973 2070 6572  e...    This per
+00049cc0: 666f 726d 7320 6120 7365 7175 656e 6365  forms a sequence
+00049cd0: 206f 6620 6368 6563 6b73 206f 6e20 7468   of checks on th
+00049ce0: 6520 656e 7469 7265 2067 7261 7068 2c20  e entire graph, 
+00049cf0: 7275 6e6e 696e 6720 696e 2061 626f 7574  running in about
+00049d00: 206c 696e 6561 720a 2020 2020 7469 6d65   linear.    time
+00049d10: 2e20 5468 6973 2072 6169 7365 7320 6173  . This raises as
+00049d20: 7365 7274 2065 7272 6f72 7320 6966 2061  sert errors if a
+00049d30: 6e79 7468 696e 6720 646f 6573 6e27 7420  nything doesn't 
+00049d40: 6368 6563 6b20 6f75 742e 0a20 2020 2022  check out..    "
+00049d50: 2222 0a20 2020 2066 6f72 2074 7320 696e  "".    for ts in
+00049d60: 2074 6173 6b73 2e76 616c 7565 7328 293a   tasks.values():
+00049d70: 0a20 2020 2020 2020 2076 616c 6964 6174  .        validat
+00049d80: 655f 7461 736b 5f73 7461 7465 2874 7329  e_task_state(ts)
+00049d90: 0a0a 2020 2020 666f 7220 7773 2069 6e20  ..    for ws in 
+00049da0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00049db0: 3a0a 2020 2020 2020 2020 7661 6c69 6461  :.        valida
+00049dc0: 7465 5f77 6f72 6b65 725f 7374 6174 6528  te_worker_state(
+00049dd0: 7773 290a 0a20 2020 2066 6f72 2063 7320  ws)..    for cs 
+00049de0: 696e 2063 6c69 656e 7473 2e76 616c 7565  in clients.value
+00049df0: 7328 293a 0a20 2020 2020 2020 2066 6f72  s():.        for
+00049e00: 2074 7320 696e 2063 732e 7761 6e74 735f   ts in cs.wants_
+00049e10: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
+00049e20: 2020 6173 7365 7274 2063 7320 696e 2074    assert cs in t
+00049e30: 732e 7768 6f5f 7761 6e74 732c 2028 0a20  s.who_wants, (. 
+00049e40: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00049e50: 6e6f 7420 696e 2077 616e 7473 5f77 6861  not in wants_wha
+00049e60: 7427 2077 686f 5f77 616e 7473 222c 0a20  t' who_wants",. 
+00049e70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00049e80: 7472 2863 7329 2c0a 2020 2020 2020 2020  tr(cs),.        
+00049e90: 2020 2020 2020 2020 7374 7228 7473 292c          str(ts),
+00049ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049eb0: 2073 7472 2874 732e 7768 6f5f 7761 6e74   str(ts.who_want
+00049ec0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+00049ed0: 290a 0a0a 6465 6620 6865 6172 7462 6561  )...def heartbea
+00049ee0: 745f 696e 7465 7276 616c 286e 3a20 696e  t_interval(n: in
+00049ef0: 7429 202d 3e20 666c 6f61 743a 0a20 2020  t) -> float:.   
+00049f00: 2022 2222 496e 7465 7276 616c 2069 6e20   """Interval in 
+00049f10: 7365 636f 6e64 7320 7468 6174 2077 6520  seconds that we 
+00049f20: 6465 7369 7265 2068 6561 7274 6265 6174  desire heartbeat
+00049f30: 7320 6261 7365 6420 6f6e 206e 756d 6265  s based on numbe
+00049f40: 7220 6f66 2077 6f72 6b65 7273 2222 220a  r of workers""".
+00049f50: 2020 2020 6966 206e 203c 3d20 3130 3a0a      if n <= 10:.
+00049f60: 2020 2020 2020 2020 7265 7475 726e 2030          return 0
+00049f70: 2e35 0a20 2020 2065 6c69 6620 6e20 3c20  .5.    elif n < 
+00049f80: 3530 3a0a 2020 2020 2020 2020 7265 7475  50:.        retu
+00049f90: 726e 2031 0a20 2020 2065 6c69 6620 6e20  rn 1.    elif n 
+00049fa0: 3c20 3230 303a 0a20 2020 2020 2020 2072  < 200:.        r
+00049fb0: 6574 7572 6e20 320a 2020 2020 656c 7365  eturn 2.    else
+00049fc0: 3a0a 2020 2020 2020 2020 2320 4e6f 206d  :.        # No m
+00049fd0: 6f72 6520 7468 616e 2032 3030 2068 6561  ore than 200 hea
+00049fe0: 7274 6265 6174 7320 6120 7365 636f 6e64  rtbeats a second
+00049ff0: 2073 6361 6c65 6420 6279 2077 6f72 6b65   scaled by worke
+0004a000: 7273 0a20 2020 2020 2020 2072 6574 7572  rs.        retur
+0004a010: 6e20 6e20 2f20 3230 3020 2b20 310a 0a0a  n n / 200 + 1...
+0004a020: 6465 6620 5f74 6173 6b5f 736c 6f74 735f  def _task_slots_
+0004a030: 6176 6169 6c61 626c 6528 7773 3a20 576f  available(ws: Wo
+0004a040: 726b 6572 5374 6174 652c 2073 6174 7572  rkerState, satur
+0004a050: 6174 696f 6e5f 6661 6374 6f72 3a20 666c  ation_factor: fl
+0004a060: 6f61 7429 202d 3e20 696e 743a 0a20 2020  oat) -> int:.   
+0004a070: 2022 2222 4e75 6d62 6572 206f 6620 7461   """Number of ta
+0004a080: 736b 7320 7468 6174 2063 616e 2062 6520  sks that can be 
+0004a090: 7365 6e74 2074 6f20 7468 6973 2077 6f72  sent to this wor
+0004a0a0: 6b65 7220 7769 7468 6f75 7420 6f76 6572  ker without over
+0004a0b0: 7361 7475 7261 7469 6e67 2069 7422 2222  saturating it"""
+0004a0c0: 0a20 2020 2061 7373 6572 7420 6e6f 7420  .    assert not 
+0004a0d0: 6d61 7468 2e69 7369 6e66 2873 6174 7572  math.isinf(satur
+0004a0e0: 6174 696f 6e5f 6661 6374 6f72 290a 2020  ation_factor).  
+0004a0f0: 2020 7265 7475 726e 206d 6178 286d 6174    return max(mat
+0004a100: 682e 6365 696c 2873 6174 7572 6174 696f  h.ceil(saturatio
+0004a110: 6e5f 6661 6374 6f72 202a 2077 732e 6e74  n_factor * ws.nt
+0004a120: 6872 6561 6473 292c 2031 2920 2d20 280a  hreads), 1) - (.
+0004a130: 2020 2020 2020 2020 6c65 6e28 7773 2e70          len(ws.p
+0004a140: 726f 6365 7373 696e 6729 202d 206c 656e  rocessing) - len
+0004a150: 2877 732e 6c6f 6e67 5f72 756e 6e69 6e67  (ws.long_running
+0004a160: 290a 2020 2020 290a 0a0a 6465 6620 5f77  ).    )...def _w
+0004a170: 6f72 6b65 725f 6675 6c6c 2877 733a 2057  orker_full(ws: W
+0004a180: 6f72 6b65 7253 7461 7465 2c20 7361 7475  orkerState, satu
+0004a190: 7261 7469 6f6e 5f66 6163 746f 723a 2066  ration_factor: f
+0004a1a0: 6c6f 6174 2920 2d3e 2062 6f6f 6c3a 0a20  loat) -> bool:. 
+0004a1b0: 2020 2069 6620 6d61 7468 2e69 7369 6e66     if math.isinf
+0004a1c0: 2873 6174 7572 6174 696f 6e5f 6661 6374  (saturation_fact
+0004a1d0: 6f72 293a 0a20 2020 2020 2020 2072 6574  or):.        ret
+0004a1e0: 7572 6e20 4661 6c73 650a 2020 2020 7265  urn False.    re
+0004a1f0: 7475 726e 205f 7461 736b 5f73 6c6f 7473  turn _task_slots
+0004a200: 5f61 7661 696c 6162 6c65 2877 732c 2073  _available(ws, s
+0004a210: 6174 7572 6174 696f 6e5f 6661 6374 6f72  aturation_factor
+0004a220: 2920 3c3d 2030 0a0a 0a63 6c61 7373 204b  ) <= 0...class K
+0004a230: 696c 6c65 6457 6f72 6b65 7228 4578 6365  illedWorker(Exce
+0004a240: 7074 696f 6e29 3a0a 2020 2020 6465 6620  ption):.    def 
+0004a250: 5f5f 696e 6974 5f5f 2873 656c 662c 2074  __init__(self, t
+0004a260: 6173 6b3a 2073 7472 2c20 6c61 7374 5f77  ask: str, last_w
+0004a270: 6f72 6b65 723a 2057 6f72 6b65 7253 7461  orker: WorkerSta
+0004a280: 7465 2c20 616c 6c6f 7765 645f 6661 696c  te, allowed_fail
+0004a290: 7572 6573 3a20 696e 7429 3a0a 2020 2020  ures: int):.    
+0004a2a0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+0004a2b0: 6974 5f5f 2874 6173 6b2c 206c 6173 745f  it__(task, last_
+0004a2c0: 776f 726b 6572 2c20 616c 6c6f 7765 645f  worker, allowed_
+0004a2d0: 6661 696c 7572 6573 290a 0a20 2020 2040  failures)..    @
+0004a2e0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+0004a2f0: 2074 6173 6b28 7365 6c66 2920 2d3e 2073   task(self) -> s
+0004a300: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+0004a310: 726e 2073 656c 662e 6172 6773 5b30 5d0a  rn self.args[0].
+0004a320: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+0004a330: 2020 2064 6566 206c 6173 745f 776f 726b     def last_work
+0004a340: 6572 2873 656c 6629 202d 3e20 576f 726b  er(self) -> Work
+0004a350: 6572 5374 6174 653a 0a20 2020 2020 2020  erState:.       
+0004a360: 2072 6574 7572 6e20 7365 6c66 2e61 7267   return self.arg
+0004a370: 735b 315d 0a0a 2020 2020 4070 726f 7065  s[1]..    @prope
+0004a380: 7274 790a 2020 2020 6465 6620 616c 6c6f  rty.    def allo
+0004a390: 7765 645f 6661 696c 7572 6573 2873 656c  wed_failures(sel
+0004a3a0: 6629 202d 3e20 696e 743a 0a20 2020 2020  f) -> int:.     
+0004a3b0: 2020 2072 6574 7572 6e20 7365 6c66 2e61     return self.a
+0004a3c0: 7267 735b 325d 0a0a 2020 2020 6465 6620  rgs[2]..    def 
+0004a3d0: 5f5f 7374 725f 5f28 7365 6c66 2920 2d3e  __str__(self) ->
+0004a3e0: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
+0004a3f0: 7475 726e 2028 0a20 2020 2020 2020 2020  turn (.         
+0004a400: 2020 2066 2241 7474 656d 7074 6564 2074     f"Attempted t
+0004a410: 6f20 7275 6e20 7461 736b 207b 7365 6c66  o run task {self
+0004a420: 2e74 6173 6b7d 206f 6e20 7b73 656c 662e  .task} on {self.
+0004a430: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
+0004a440: 7d20 6469 6666 6572 656e 7420 220a 2020  } different ".  
+0004a450: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
+0004a460: 7273 2c20 6275 7420 616c 6c20 7468 6f73  rs, but all thos
+0004a470: 6520 776f 726b 6572 7320 6469 6564 2077  e workers died w
+0004a480: 6869 6c65 2072 756e 6e69 6e67 2069 742e  hile running it.
+0004a490: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+0004a4a0: 2254 6865 206c 6173 7420 776f 726b 6572  "The last worker
+0004a4b0: 2074 6861 7420 6174 7465 6d70 7420 746f   that attempt to
+0004a4c0: 2072 756e 2074 6865 2074 6173 6b20 7761   run the task wa
+0004a4d0: 7320 7b73 656c 662e 6c61 7374 5f77 6f72  s {self.last_wor
+0004a4e0: 6b65 722e 6164 6472 6573 737d 2e20 220a  ker.address}. ".
+0004a4f0: 2020 2020 2020 2020 2020 2020 2249 6e73              "Ins
+0004a500: 7065 6374 696e 6720 776f 726b 6572 206c  pecting worker l
+0004a510: 6f67 7320 6973 206f 6674 656e 2061 2067  ogs is often a g
+0004a520: 6f6f 6420 6e65 7874 2073 7465 7020 746f  ood next step to
+0004a530: 2064 6961 676e 6f73 6520 7768 6174 2077   diagnose what w
+0004a540: 656e 7420 7772 6f6e 672e 2022 0a20 2020  ent wrong. ".   
+0004a550: 2020 2020 2020 2020 2022 466f 7220 6d6f           "For mo
+0004a560: 7265 2069 6e66 6f72 6d61 7469 6f6e 2073  re information s
+0004a570: 6565 2068 7474 7073 3a2f 2f64 6973 7472  ee https://distr
+0004a580: 6962 7574 6564 2e64 6173 6b2e 6f72 672f  ibuted.dask.org/
+0004a590: 656e 2f73 7461 626c 652f 6b69 6c6c 6564  en/stable/killed
+0004a5a0: 2e68 746d 6c2e 220a 2020 2020 2020 2020  .html.".        
+0004a5b0: 290a 0a0a 636c 6173 7320 576f 726b 6572  )...class Worker
+0004a5c0: 5374 6174 7573 506c 7567 696e 2853 6368  StatusPlugin(Sch
+0004a5d0: 6564 756c 6572 506c 7567 696e 293a 0a20  edulerPlugin):. 
+0004a5e0: 2020 2022 2222 4120 706c 7567 696e 2074     """A plugin t
+0004a5f0: 6f20 7368 6172 6520 776f 726b 6572 2073  o share worker s
+0004a600: 7461 7475 7320 7769 7468 2061 2072 656d  tatus with a rem
+0004a610: 6f74 6520 6f62 7365 7276 6572 0a0a 2020  ote observer..  
+0004a620: 2020 5468 6973 2069 7320 7573 6564 2069    This is used i
+0004a630: 6e20 636c 7573 7465 7220 6d61 6e61 6765  n cluster manage
+0004a640: 7273 2074 6f20 6b65 6570 2075 7064 6174  rs to keep updat
+0004a650: 6564 2061 626f 7574 2074 6865 2073 7461  ed about the sta
+0004a660: 7475 7320 6f66 2074 6865 2073 6368 6564  tus of the sched
+0004a670: 756c 6572 2e0a 2020 2020 2222 220a 0a20  uler..    """.. 
+0004a680: 2020 206e 616d 653a 2043 6c61 7373 5661     name: ClassVa
+0004a690: 725b 7374 725d 203d 2022 776f 726b 6572  r[str] = "worker
+0004a6a0: 2d73 7461 7475 7322 0a20 2020 2062 636f  -status".    bco
+0004a6b0: 6d6d 3a20 4261 7463 6865 6453 656e 640a  mm: BatchedSend.
+0004a6c0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0004a6d0: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+0004a6e0: 723a 2053 6368 6564 756c 6572 2c20 636f  r: Scheduler, co
+0004a6f0: 6d6d 3a20 436f 6d6d 293a 0a20 2020 2020  mm: Comm):.     
+0004a700: 2020 2073 656c 662e 6263 6f6d 6d20 3d20     self.bcomm = 
+0004a710: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
+0004a720: 7276 616c 3d22 356d 7322 290a 2020 2020  rval="5ms").    
+0004a730: 2020 2020 7365 6c66 2e62 636f 6d6d 2e73      self.bcomm.s
+0004a740: 7461 7274 2863 6f6d 6d29 0a20 2020 2020  tart(comm).     
+0004a750: 2020 2073 6368 6564 756c 6572 2e61 6464     scheduler.add
+0004a760: 5f70 6c75 6769 6e28 7365 6c66 290a 0a20  _plugin(self).. 
+0004a770: 2020 2064 6566 2061 6464 5f77 6f72 6b65     def add_worke
+0004a780: 7228 7365 6c66 2c20 7363 6865 6475 6c65  r(self, schedule
+0004a790: 723a 2053 6368 6564 756c 6572 2c20 776f  r: Scheduler, wo
+0004a7a0: 726b 6572 3a20 7374 7229 202d 3e20 4e6f  rker: str) -> No
+0004a7b0: 6e65 3a0a 2020 2020 2020 2020 6964 656e  ne:.        iden
+0004a7c0: 7420 3d20 7363 6865 6475 6c65 722e 776f  t = scheduler.wo
+0004a7d0: 726b 6572 735b 776f 726b 6572 5d2e 6964  rkers[worker].id
+0004a7e0: 656e 7469 7479 2829 0a20 2020 2020 2020  entity().       
+0004a7f0: 2064 656c 2069 6465 6e74 5b22 6d65 7472   del ident["metr
+0004a800: 6963 7322 5d0a 2020 2020 2020 2020 6465  ics"].        de
+0004a810: 6c20 6964 656e 745b 226c 6173 745f 7365  l ident["last_se
+0004a820: 656e 225d 0a20 2020 2020 2020 2074 7279  en"].        try
+0004a830: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0004a840: 6c66 2e62 636f 6d6d 2e73 656e 6428 5b22  lf.bcomm.send(["
+0004a850: 6164 6422 2c20 7b22 776f 726b 6572 7322  add", {"workers"
+0004a860: 3a20 7b77 6f72 6b65 723a 2069 6465 6e74  : {worker: ident
+0004a870: 7d7d 5d29 0a20 2020 2020 2020 2065 7863  }}]).        exc
+0004a880: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
+0004a890: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0004a8a0: 2073 6368 6564 756c 6572 2e72 656d 6f76   scheduler.remov
+0004a8b0: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
+0004a8c0: 6c66 2e6e 616d 6529 0a0a 2020 2020 6465  lf.name)..    de
+0004a8d0: 6620 7265 6d6f 7665 5f77 6f72 6b65 7228  f remove_worker(
+0004a8e0: 7365 6c66 2c20 7363 6865 6475 6c65 723a  self, scheduler:
+0004a8f0: 2053 6368 6564 756c 6572 2c20 776f 726b   Scheduler, work
+0004a900: 6572 3a20 7374 722c 202a 2a6b 7761 7267  er: str, **kwarg
+0004a910: 733a 2041 6e79 2920 2d3e 204e 6f6e 653a  s: Any) -> None:
+0004a920: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0004a930: 2020 2020 2020 2020 2020 7365 6c66 2e62            self.b
+0004a940: 636f 6d6d 2e73 656e 6428 5b22 7265 6d6f  comm.send(["remo
+0004a950: 7665 222c 2077 6f72 6b65 725d 290a 2020  ve", worker]).  
+0004a960: 2020 2020 2020 6578 6365 7074 2043 6f6d        except Com
+0004a970: 6d43 6c6f 7365 6445 7272 6f72 3a0a 2020  mClosedError:.  
+0004a980: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+0004a990: 6c65 722e 7265 6d6f 7665 5f70 6c75 6769  ler.remove_plugi
+0004a9a0: 6e28 6e61 6d65 3d73 656c 662e 6e61 6d65  n(name=self.name
+0004a9b0: 290a 0a20 2020 2064 6566 2074 6561 7264  )..    def teard
+0004a9c0: 6f77 6e28 7365 6c66 2920 2d3e 204e 6f6e  own(self) -> Non
+0004a9d0: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
+0004a9e0: 6263 6f6d 6d2e 636c 6f73 6528 290a 0a0a  bcomm.close()...
+0004a9f0: 636c 6173 7320 436f 6c6c 6563 7454 6173  class CollectTas
+0004aa00: 6b4d 6574 6144 6174 6150 6c75 6769 6e28  kMetaDataPlugin(
+0004aa10: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
+0004aa20: 3a0a 2020 2020 7363 6865 6475 6c65 723a  :.    scheduler:
+0004aa30: 2053 6368 6564 756c 6572 0a20 2020 206e   Scheduler.    n
+0004aa40: 616d 653a 2073 7472 0a20 2020 206b 6579  ame: str.    key
+0004aa50: 733a 2073 6574 5b73 7472 5d0a 2020 2020  s: set[str].    
+0004aa60: 6d65 7461 6461 7461 3a20 6469 6374 5b73  metadata: dict[s
+0004aa70: 7472 2c20 416e 795d 0a20 2020 2073 7461  tr, Any].    sta
+0004aa80: 7465 3a20 6469 6374 5b73 7472 2c20 7374  te: dict[str, st
+0004aa90: 725d 0a0a 2020 2020 6465 6620 5f5f 696e  r]..    def __in
+0004aaa0: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+0004aab0: 756c 6572 3a20 5363 6865 6475 6c65 722c  uler: Scheduler,
+0004aac0: 206e 616d 653a 2073 7472 293a 0a20 2020   name: str):.   
+0004aad0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
+0004aae0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
+0004aaf0: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
+0004ab00: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
+0004ab10: 2073 656c 662e 6b65 7973 203d 2073 6574   self.keys = set
+0004ab20: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0004ab30: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
+0004ab40: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
+0004ab50: 203d 207b 7d0a 0a20 2020 2064 6566 2075   = {}..    def u
+0004ab60: 7064 6174 655f 6772 6170 6828 0a20 2020  pdate_graph(.   
+0004ab70: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0004ab80: 2020 2073 6368 6564 756c 6572 3a20 5363     scheduler: Sc
+0004ab90: 6865 6475 6c65 722c 0a20 2020 2020 2020  heduler,.       
+0004aba0: 202a 2c0a 2020 2020 2020 2020 6b65 7973   *,.        keys
+0004abb0: 3a20 7365 745b 7374 725d 2c0a 2020 2020  : set[str],.    
+0004abc0: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
+0004abd0: 792c 0a20 2020 2029 202d 3e20 4e6f 6e65  y,.    ) -> None
+0004abe0: 3a0a 2020 2020 2020 2020 7365 6c66 2e6b  :.        self.k
+0004abf0: 6579 732e 7570 6461 7465 286b 6579 7329  eys.update(keys)
+0004ac00: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+0004ac10: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
+0004ac20: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+0004ac30: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+0004ac40: 6172 743a 2054 6173 6b53 7461 7465 5374  art: TaskStateSt
+0004ac50: 6174 652c 0a20 2020 2020 2020 2066 696e  ate,.        fin
+0004ac60: 6973 683a 2054 6173 6b53 7461 7465 5374  ish: TaskStateSt
+0004ac70: 6174 652c 0a20 2020 2020 2020 202a 6172  ate,.        *ar
+0004ac80: 6773 3a20 416e 792c 0a20 2020 2020 2020  gs: Any,.       
+0004ac90: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+0004aca0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+0004acb0: 2020 2020 2020 2069 6620 6669 6e69 7368         if finish
+0004acc0: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
+0004acd0: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
+0004ace0: 2020 2020 2074 7320 3d20 7365 6c66 2e73       ts = self.s
+0004acf0: 6368 6564 756c 6572 2e74 6173 6b73 2e67  cheduler.tasks.g
+0004ad00: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+0004ad10: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
+0004ad20: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
+0004ad30: 2069 6e20 7365 6c66 2e6b 6579 733a 0a20   in self.keys:. 
+0004ad40: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004ad50: 656c 662e 6d65 7461 6461 7461 5b6b 6579  elf.metadata[key
+0004ad60: 5d20 3d20 7473 2e6d 6574 6164 6174 610a  ] = ts.metadata.
+0004ad70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ad80: 7365 6c66 2e73 7461 7465 5b6b 6579 5d20  self.state[key] 
+0004ad90: 3d20 6669 6e69 7368 0a20 2020 2020 2020  = finish.       
+0004ada0: 2020 2020 2020 2020 2073 656c 662e 6b65           self.ke
+0004adb0: 7973 2e64 6973 6361 7264 286b 6579 290a  ys.discard(key).
```

### Comparing `distributed-2023.7.0/distributed/security.py` & `distributed-2023.7.1/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/semaphore.py` & `distributed-2023.7.1/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/shuffle/__init__.py` & `distributed-2023.7.1/distributed/shuffle/__init__.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,19 +1,19 @@
 from __future__ import annotations
 
 from distributed.shuffle._arrow import check_minimal_arrow_version
 from distributed.shuffle._merge import HashJoinP2PLayer, hash_join_p2p
 from distributed.shuffle._rechunk import rechunk_p2p
-from distributed.shuffle._scheduler_extension import ShuffleSchedulerExtension
+from distributed.shuffle._scheduler_plugin import ShuffleSchedulerPlugin
 from distributed.shuffle._shuffle import P2PShuffleLayer, rearrange_by_column_p2p
-from distributed.shuffle._worker_extension import ShuffleWorkerExtension
+from distributed.shuffle._worker_plugin import ShuffleWorkerPlugin
 
 __all__ = [
     "check_minimal_arrow_version",
     "hash_join_p2p",
     "HashJoinP2PLayer",
     "P2PShuffleLayer",
     "rearrange_by_column_p2p",
     "rechunk_p2p",
-    "ShuffleSchedulerExtension",
-    "ShuffleWorkerExtension",
+    "ShuffleSchedulerPlugin",
+    "ShuffleWorkerPlugin",
 ]
```

### Comparing `distributed-2023.7.0/distributed/shuffle/_arrow.py` & `distributed-2023.7.1/distributed/shuffle/_arrow.py`

 * *Files 3% similar despite different names*

```diff
@@ -52,15 +52,14 @@
     file = BytesIO(data)
     end = len(data)
     shards = []
     while file.tell() < end:
         sr = pa.RecordBatchStreamReader(file)
         shards.append(sr.read_all())
     table = pa.concat_tables(shards, promote=True)
-    df = table.to_pandas(self_destruct=True)
 
     def default_types_mapper(pyarrow_dtype: pa.DataType) -> object:
         # Avoid converting strings from `string[pyarrow]` to `string[python]`
         # if we have *some* `string[pyarrow]`
         if (
             pyarrow_dtype in {pa.large_string(), pa.string()}
             and pd.StringDtype("pyarrow") in meta.dtypes.values
@@ -76,22 +75,20 @@
     """Convert a list of arrow buffers and a schema to an Arrow Table"""
     import pyarrow as pa
 
     return pa.concat_tables(deserialize_table(buffer) for buffer in data)
 
 
 def serialize_table(table: pa.Table) -> bytes:
-    import io
-
     import pyarrow as pa
 
-    stream = io.BytesIO()
+    stream = pa.BufferOutputStream()
     with pa.ipc.new_stream(stream, table.schema) as writer:
         writer.write_table(table)
-    return stream.getvalue()
+    return stream.getvalue().to_pybytes()
 
 
 def deserialize_table(buffer: bytes) -> pa.Table:
     import pyarrow as pa
 
     with pa.ipc.open_stream(pa.py_buffer(buffer)) as reader:
         return reader.read_all()
```

### Comparing `distributed-2023.7.0/distributed/shuffle/_buffer.py` & `distributed-2023.7.1/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/shuffle/_comms.py` & `distributed-2023.7.1/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/shuffle/_disk.py` & `distributed-2023.7.1/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/shuffle/_limiter.py` & `distributed-2023.7.1/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/shuffle/_merge.py` & `distributed-2023.7.1/distributed/shuffle/_merge.py`

 * *Files 1% similar despite different names*

```diff
@@ -7,15 +7,15 @@
 
 from dask.base import is_dask_collection, tokenize
 from dask.highlevelgraph import HighLevelGraph
 from dask.layers import Layer
 
 from distributed.shuffle._shuffle import (
     ShuffleId,
-    _get_worker_extension,
+    _get_worker_plugin,
     barrier_key,
     shuffle_barrier,
     shuffle_transfer,
 )
 
 if TYPE_CHECKING:
     import pandas as pd
@@ -163,15 +163,15 @@
     meta_left: pd.DataFrame,
     meta_right: pd.DataFrame,
     result_meta: pd.DataFrame,
     suffixes: Suffixes,
 ):
     from dask.dataframe.multi import merge_chunk
 
-    ext = _get_worker_extension()
+    ext = _get_worker_plugin()
     # If the partition is empty, it doesn't contain the hash column name
     left = ext.get_output_partition(
         shuffle_id_left, barrier_left, output_partition, meta=meta_left
     ).drop(columns=_HASH_COLUMN_NAME, errors="ignore")
     right = ext.get_output_partition(
         shuffle_id_right, barrier_right, output_partition, meta=meta_right
     ).drop(columns=_HASH_COLUMN_NAME, errors="ignore")
```

### Comparing `distributed-2023.7.0/distributed/shuffle/_scheduler_extension.py` & `distributed-2023.7.1/distributed/shuffle/_scheduler_plugin.py`

 * *Files 4% similar despite different names*

```diff
@@ -8,21 +8,23 @@
 from collections.abc import Callable, Iterable, Sequence
 from dataclasses import dataclass
 from functools import partial
 from itertools import product
 from typing import TYPE_CHECKING, Any, ClassVar
 
 from distributed.diagnostics.plugin import SchedulerPlugin
+from distributed.protocol.pickle import dumps
 from distributed.shuffle._rechunk import ChunkedAxes, NDIndex
 from distributed.shuffle._shuffle import (
     ShuffleId,
     ShuffleType,
     barrier_key,
     id_from_key,
 )
+from distributed.shuffle._worker_plugin import ShuffleWorkerPlugin
 
 if TYPE_CHECKING:
     from distributed.scheduler import (
         Recs,
         Scheduler,
         TaskState,
         TaskStateState,
@@ -41,14 +43,17 @@
     output_workers: set[str]
     participating_workers: set[str]
 
     @abc.abstractmethod
     def to_msg(self) -> dict[str, Any]:
         """Transform the shuffle state into a JSON-serializable message"""
 
+    def __str__(self) -> str:
+        return f"{self.__class__.__name__}<{self.id}[{self.run_id}]>"
+
 
 @dataclass
 class DataFrameShuffleState(ShuffleState):
     type: ClassVar[ShuffleType] = ShuffleType.DATAFRAME
     worker_for: dict[int, str]
     column: str
 
@@ -78,24 +83,24 @@
             "worker_for": self.worker_for,
             "old": self.old,
             "new": self.new,
             "output_workers": self.output_workers,
         }
 
 
-class ShuffleSchedulerExtension(SchedulerPlugin):
+class ShuffleSchedulerPlugin(SchedulerPlugin):
     """
-    Shuffle extension for the scheduler
+    Shuffle plugin for the scheduler
 
-    Today this mostly just collects heartbeat messages for the dashboard,
-    but in the future it may be responsible for more
+    This coordinates the individual worker plugins to ensure correctness
+    and collects heartbeat messages for the dashboard.
 
     See Also
     --------
-    ShuffleWorkerExtension
+    ShuffleWorkerPlugin
     """
 
     scheduler: Scheduler
     states: dict[ShuffleId, ShuffleState]
     heartbeats: defaultdict[ShuffleId, dict]
     erred_shuffles: dict[ShuffleId, Exception]
 
@@ -108,30 +113,45 @@
                 "shuffle_get_or_create": self.get_or_create,
                 "shuffle_restrict_task": self.restrict_task,
             }
         )
         self.heartbeats = defaultdict(lambda: defaultdict(dict))
         self.states = {}
         self.erred_shuffles = {}
-        self.scheduler.add_plugin(self)
+        self.scheduler.add_plugin(self, name="shuffle")
+
+    async def start(self, scheduler: Scheduler) -> None:
+        worker_plugin = ShuffleWorkerPlugin()
+        await self.scheduler.register_worker_plugin(
+            None, dumps(worker_plugin), name="shuffle"
+        )
 
     def shuffle_ids(self) -> set[ShuffleId]:
         return set(self.states)
 
     async def barrier(self, id: ShuffleId, run_id: int) -> None:
         shuffle = self.states[id]
+        assert shuffle.run_id == run_id, f"{run_id=} does not match {shuffle}"
         msg = {"op": "shuffle_inputs_done", "shuffle_id": id, "run_id": run_id}
         await self.scheduler.broadcast(
             msg=msg, workers=list(shuffle.participating_workers)
         )
 
     def restrict_task(self, id: ShuffleId, run_id: int, key: str, worker: str) -> dict:
         shuffle = self.states[id]
-        if shuffle.run_id != run_id:
-            return {"status": "error", "message": "Stale shuffle"}
+        if shuffle.run_id > run_id:
+            return {
+                "status": "error",
+                "message": f"Request stale, expected {run_id=} for {shuffle}",
+            }
+        elif shuffle.run_id < run_id:
+            return {
+                "status": "error",
+                "message": f"Request invalid, expected {run_id=} for {shuffle}",
+            }
         ts = self.scheduler.tasks[key]
         self._set_restriction(ts, worker)
         return {"status": "OK"}
 
     def heartbeat(self, ws: WorkerState, data: dict) -> None:
         for shuffle_id, d in data.items():
             if shuffle_id in self.shuffle_ids():
@@ -285,26 +305,26 @@
         # shuffle_original_restrictions is only set if the task was first scheduled
         # on the wrong worker
         if "shuffle_original_restrictions" not in ts.annotations:
             return
         original_restrictions = ts.annotations.pop("shuffle_original_restrictions")
         self.scheduler.set_restrictions({ts.key: original_restrictions})
 
-    def remove_worker(self, scheduler: Scheduler, worker: str) -> None:
+    def remove_worker(
+        self, scheduler: Scheduler, worker: str, *, stimulus_id: str, **kwargs: Any
+    ) -> None:
         from time import time
 
         stimulus_id = f"shuffle-failed-worker-left-{time()}"
 
         recs: Recs = {}
         for shuffle_id, shuffle in self.states.items():
             if worker not in shuffle.participating_workers:
                 continue
-            exception = RuntimeError(
-                f"Worker {worker} left during active shuffle {shuffle_id}"
-            )
+            exception = RuntimeError(f"Worker {worker} left during active {shuffle}")
             self.erred_shuffles[shuffle_id] = exception
             self._fail_on_workers(shuffle, str(exception))
 
             barrier_task = self.scheduler.tasks[barrier_key(shuffle_id)]
             if barrier_task.state == "memory":
                 for dt in barrier_task.dependents:
                     if worker not in dt.worker_restrictions:
@@ -320,26 +340,27 @@
 
     def transition(
         self,
         key: str,
         start: TaskStateState,
         finish: TaskStateState,
         *args: Any,
+        stimulus_id: str,
         **kwargs: Any,
     ) -> None:
         if finish not in ("released", "forgotten"):
             return
         if not key.startswith("shuffle-barrier-"):
             return
         shuffle_id = id_from_key(key)
         try:
             shuffle = self.states[shuffle_id]
         except KeyError:
             return
-        self._fail_on_workers(shuffle, message=f"Shuffle {shuffle_id} forgotten")
+        self._fail_on_workers(shuffle, message=f"{shuffle} forgotten")
         self._clean_on_scheduler(shuffle_id)
 
     def _fail_on_workers(self, shuffle: ShuffleState, message: str) -> None:
         worker_msgs = {
             worker: [
                 {
                     "op": "shuffle-fail",
```

### Comparing `distributed-2023.7.0/distributed/shuffle/_shuffle.py` & `distributed-2023.7.1/distributed/shuffle/_shuffle.py`

 * *Files 4% similar despite different names*

```diff
@@ -18,53 +18,53 @@
 
     # TODO import from typing (requires Python >=3.10)
     from typing_extensions import TypeAlias
 
     from dask.dataframe import DataFrame
 
     # circular dependency
-    from distributed.shuffle._worker_extension import ShuffleWorkerExtension
+    from distributed.shuffle._worker_plugin import ShuffleWorkerPlugin
 
 ShuffleId = NewType("ShuffleId", str)
 
 
 class ShuffleType(Enum):
     DATAFRAME = "DataFrameShuffle"
     ARRAY_RECHUNK = "ArrayRechunk"
 
 
-def _get_worker_extension() -> ShuffleWorkerExtension:
+def _get_worker_plugin() -> ShuffleWorkerPlugin:
     from distributed import get_worker
 
     try:
         worker = get_worker()
     except ValueError as e:
         raise RuntimeError(
             "`shuffle='p2p'` requires Dask's distributed scheduler. This task is not running on a Worker; "
             "please confirm that you've created a distributed Client and are submitting this computation through it."
         ) from e
-    extension: ShuffleWorkerExtension | None = worker.extensions.get("shuffle")
-    if extension is None:
+    plugin: ShuffleWorkerPlugin | None = worker.plugins.get("shuffle")  # type: ignore
+    if plugin is None:
         raise RuntimeError(
             f"The worker {worker.address} does not have a ShuffleExtension. "
             "Is pandas installed on the worker?"
         )
-    return extension
+    return plugin
 
 
 def shuffle_transfer(
     input: pd.DataFrame,
     id: ShuffleId,
     input_partition: int,
     npartitions: int,
     column: str,
     parts_out: set[int],
 ) -> int:
     try:
-        return _get_worker_extension().add_partition(
+        return _get_worker_plugin().add_partition(
             input,
             shuffle_id=id,
             type=ShuffleType.DATAFRAME,
             partition_id=input_partition,
             npartitions=npartitions,
             column=column,
             parts_out=parts_out,
@@ -73,26 +73,26 @@
         raise RuntimeError(f"shuffle_transfer failed during shuffle {id}") from e
 
 
 def shuffle_unpack(
     id: ShuffleId, output_partition: int, barrier_run_id: int, meta: pd.DataFrame
 ) -> pd.DataFrame:
     try:
-        return _get_worker_extension().get_output_partition(
+        return _get_worker_plugin().get_output_partition(
             id, barrier_run_id, output_partition, meta=meta
         )
     except Reschedule as e:
         raise e
     except Exception as e:
         raise RuntimeError(f"shuffle_unpack failed during shuffle {id}") from e
 
 
 def shuffle_barrier(id: ShuffleId, run_ids: list[int]) -> int:
     try:
-        return _get_worker_extension().barrier(id, run_ids)
+        return _get_worker_plugin().barrier(id, run_ids)
     except Exception as e:
         raise RuntimeError(f"shuffle_barrier failed during shuffle {id}") from e
 
 
 def rearrange_by_column_p2p(
     df: DataFrame,
     column: str,
```

### Comparing `distributed-2023.7.0/distributed/shuffle/_worker_extension.py` & `distributed-2023.7.1/distributed/shuffle/_worker_plugin.py`

 * *Files 4% similar despite different names*

```diff
@@ -15,14 +15,15 @@
 
 import toolz
 
 from dask.context import thread_state
 from dask.utils import parse_bytes
 
 from distributed.core import PooledRPCCall
+from distributed.diagnostics.plugin import WorkerPlugin
 from distributed.exceptions import Reschedule
 from distributed.protocol import to_serialize
 from distributed.shuffle._arrow import (
     convert_partition,
     list_of_buffers_to_table,
     serialize_table,
 )
@@ -95,15 +96,18 @@
         self.received: set[T_transfer_shard_id] = set()
         self.total_recvd = 0
         self.start_time = time.time()
         self._exception: Exception | None = None
         self._closed_event = asyncio.Event()
 
     def __repr__(self) -> str:
-        return f"<{self.__class__.__name__} {self.id}[{self.run_id}] on {self.local_address}>"
+        return f"<{self.__class__.__name__}: id={self.id!r}, run_id={self.run_id!r}, local_address={self.local_address!r}, closed={self.closed!r}, transferred={self.transferred!r}>"
+
+    def __str__(self) -> str:
+        return f"{self.__class__.__name__}<{self.id}[{self.run_id}]> on {self.local_address}"
 
     def __hash__(self) -> int:
         return self.run_id
 
     @contextlib.contextmanager
     def time(self, name: str) -> Iterator[None]:
         start = time.time()
@@ -158,17 +162,15 @@
             {"_".join(str(i) for i in k): v for k, v in data.items()}
         )
 
     def raise_if_closed(self) -> None:
         if self.closed:
             if self._exception:
                 raise self._exception
-            raise ShuffleClosedError(
-                f"Shuffle {self.id} has been closed on {self.local_address}"
-            )
+            raise ShuffleClosedError(f"{self} has already been closed")
 
     async def inputs_done(self) -> None:
         self.raise_if_closed()
         self.transferred = True
         await self._flush_comm()
         try:
             self._comm_buffer.raise_on_exception()
@@ -342,15 +344,15 @@
         except Exception as e:
             self._exception = e
             raise
 
     async def add_partition(self, data: np.ndarray, partition_id: NDIndex) -> int:
         self.raise_if_closed()
         if self.transferred:
-            raise RuntimeError(f"Cannot add more partitions to shuffle {self}")
+            raise RuntimeError(f"Cannot add more partitions to {self}")
 
         def _() -> dict[str, list[tuple[ArrayRechunkShardID, bytes]]]:
             """Return a mapping of worker addresses to a list of tuples of shard IDs
             and shard data.
 
             As shard data, we serialize the payload together with the sub-index of the
             slice within the new chunk. To assemble the new chunk from its shards, it
@@ -507,15 +509,15 @@
         assert len(table) == sum(map(len, groups.values()))
         del data
         return {(k,): [serialize_table(v)] for k, v in groups.items()}
 
     async def add_partition(self, data: pd.DataFrame, partition_id: int) -> int:
         self.raise_if_closed()
         if self.transferred:
-            raise RuntimeError(f"Cannot add more partitions to shuffle {self}")
+            raise RuntimeError(f"Cannot add more partitions to {self}")
 
         def _() -> dict[str, list[tuple[int, bytes]]]:
             out = split_by_worker(
                 data,
                 self.column,
                 self.worker_for,
             )
@@ -547,15 +549,15 @@
             out = meta.copy()
         return out
 
     def _get_assigned_worker(self, id: int) -> str:
         return self.worker_for[id]
 
 
-class ShuffleWorkerExtension:
+class ShuffleWorkerPlugin(WorkerPlugin):
     """Interface between a Worker and a Shuffle.
 
     This extension is responsible for
 
     - Lifecycle of Shuffle instances
     - ensuring connectivity between remote shuffle instances
     - ensuring connectivity and integration with the scheduler
@@ -566,15 +568,15 @@
     worker: Worker
     shuffles: dict[ShuffleId, ShuffleRun]
     _runs: set[ShuffleRun]
     memory_limiter_comms: ResourceLimiter
     memory_limiter_disk: ResourceLimiter
     closed: bool
 
-    def __init__(self, worker: Worker) -> None:
+    def setup(self, worker: Worker) -> None:
         # Attach to worker
         worker.handlers["shuffle_receive"] = self.shuffle_receive
         worker.handlers["shuffle_inputs_done"] = self.shuffle_inputs_done
         worker.stream_handlers["shuffle-fail"] = self.shuffle_fail
         worker.extensions["shuffle"] = self
 
         # Initialize
@@ -582,14 +584,20 @@
         self.shuffles = {}
         self._runs = set()
         self.memory_limiter_comms = ResourceLimiter(parse_bytes("100 MiB"))
         self.memory_limiter_disk = ResourceLimiter(parse_bytes("1 GiB"))
         self.closed = False
         self._executor = ThreadPoolExecutor(self.worker.state.nthreads)
 
+    def __str__(self) -> str:
+        return f"ShuffleWorkerPlugin on {self.worker.address}"
+
+    def __repr__(self) -> str:
+        return f"<ShuffleWorkerPlugin, worker={self.worker.address_safe!r}, closed={self.closed}>"
+
     # Handlers
     ##########
     # NOTE: handlers are not threadsafe, but they're called from async comms, so that's okay
 
     def heartbeat(self) -> dict:
         return {id: shuffle.heartbeat() for id, shuffle in self.shuffles.items()}
 
@@ -627,15 +635,15 @@
         shuffle = self.shuffles.get(shuffle_id, None)
         if shuffle is None or shuffle.run_id != run_id:
             return
         self.shuffles.pop(shuffle_id)
         exception = RuntimeError(message)
         shuffle.fail(exception)
 
-        async def _(extension: ShuffleWorkerExtension, shuffle: ShuffleRun) -> None:
+        async def _(extension: ShuffleWorkerPlugin, shuffle: ShuffleRun) -> None:
             await shuffle.close()
             extension._runs.remove(shuffle)
 
         self.worker._ongoing_background_tasks.call_soon(_, self, shuffle)
 
     def add_partition(
         self,
@@ -691,19 +699,19 @@
             If the run_id is stale
         """
         shuffle = self.shuffles.get(shuffle_id, None)
         if shuffle is None or shuffle.run_id < run_id:
             shuffle = await self._refresh_shuffle(
                 shuffle_id=shuffle_id,
             )
-        if run_id < shuffle.run_id:
-            raise RuntimeError("Stale shuffle")
-        elif run_id > shuffle.run_id:
-            # This should never happen
-            raise RuntimeError("Invalid shuffle state")
+
+        if shuffle.run_id > run_id:
+            raise RuntimeError(f"{run_id=} stale, got {shuffle}")
+        elif shuffle.run_id < run_id:
+            raise RuntimeError(f"{run_id=} invalid, got {shuffle}")
 
         if shuffle._exception:
             raise shuffle._exception
         return shuffle
 
     async def _get_or_create_shuffle(
         self,
@@ -725,17 +733,15 @@
             shuffle = await self._refresh_shuffle(
                 shuffle_id=shuffle_id,
                 type=type,
                 kwargs=kwargs,
             )
 
         if self.closed:
-            raise ShuffleClosedError(
-                f"{self.__class__.__name__} already closed on {self.worker.address}"
-            )
+            raise ShuffleClosedError(f"{self} has already been closed")
         if shuffle._exception:
             raise shuffle._exception
         return shuffle
 
     @overload
     async def _refresh_shuffle(
         self,
@@ -786,27 +792,25 @@
         else:  # pragma: no cover
             raise TypeError(type)
         if result["status"] == "error":
             raise RuntimeError(result["message"])
         assert result["status"] == "OK"
 
         if self.closed:
-            raise ShuffleClosedError(
-                f"{self.__class__.__name__} already closed on {self.worker.address}"
-            )
+            raise ShuffleClosedError(f"{self} has already been closed")
         if shuffle_id in self.shuffles:
             existing = self.shuffles[shuffle_id]
             if existing.run_id >= result["run_id"]:
                 return existing
             else:
                 self.shuffles.pop(shuffle_id)
                 existing.fail(RuntimeError("Stale Shuffle"))
 
                 async def _(
-                    extension: ShuffleWorkerExtension, shuffle: ShuffleRun
+                    extension: ShuffleWorkerPlugin, shuffle: ShuffleRun
                 ) -> None:
                     await shuffle.close()
                     extension._runs.remove(shuffle)
 
                 self.worker._ongoing_background_tasks.call_soon(_, self, existing)
         shuffle: ShuffleRun
         if result["type"] == ShuffleType.DATAFRAME:
@@ -848,15 +852,15 @@
             )
         else:  # pragma: no cover
             raise TypeError(result["type"])
         self.shuffles[shuffle_id] = shuffle
         self._runs.add(shuffle)
         return shuffle
 
-    async def close(self) -> None:
+    async def teardown(self, worker: Worker) -> None:
         assert not self.closed
 
         self.closed = True
         while self.shuffles:
             _, shuffle = self.shuffles.popitem()
             await shuffle.close()
             self._runs.remove(shuffle)
@@ -943,15 +947,15 @@
     if not nrows:
         return {}
     # assert len(df) == nrows  # Not true if some outputs aren't wanted
     # FIXME: If we do not preserve the index something is corrupting the
     # bytestream such that it cannot be deserialized anymore
     t = pa.Table.from_pandas(df, preserve_index=True)
     t = t.sort_by("_worker")
-    codes = np.asarray(t.select(["_worker"]))[0]
+    codes = np.asarray(t["_worker"])
     t = t.drop(["_worker"])
     del df
 
     splits = np.where(codes[1:] != codes[:-1])[0] + 1
     splits = np.concatenate([[0], splits])
 
     shards = [
@@ -975,15 +979,15 @@
     """
     import numpy as np
 
     partitions = t.select([column]).to_pandas()[column].unique()
     partitions.sort()
     t = t.sort_by(column)
 
-    partition = np.asarray(t.select([column]))[0]
+    partition = np.asarray(t[column])
     splits = np.where(partition[1:] != partition[:-1])[0] + 1
     splits = np.concatenate([[0], splits])
 
     shards = [
         t.slice(offset=a, length=b - a) for a, b in toolz.sliding_window(2, splits)
     ]
     shards.append(t.slice(offset=splits[-1], length=None))
```

### Comparing `distributed-2023.7.0/distributed/sizeof.py` & `distributed-2023.7.1/distributed/sizeof.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/spans.py` & `distributed-2023.7.1/distributed/spans.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/spill.py` & `distributed-2023.7.1/distributed/spill.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/stealing.py` & `distributed-2023.7.1/distributed/stealing.py`

 * *Files 2% similar despite different names*

```diff
@@ -17,15 +17,21 @@
 from distributed.compatibility import PeriodicCallback
 from distributed.core import CommClosedError
 from distributed.diagnostics.plugin import SchedulerPlugin
 from distributed.utils import log_errors, recursive_to_dict
 
 if TYPE_CHECKING:
     # Recursive imports
-    from distributed.scheduler import Scheduler, SchedulerState, TaskState, WorkerState
+    from distributed.scheduler import (
+        Scheduler,
+        SchedulerState,
+        TaskState,
+        TaskStateState,
+        WorkerState,
+    )
 
 # Stealing requires multiple network bounces and if successful also task
 # submission which may include code serialization. Therefore, be very
 # conservative in the latency estimation to suppress too aggressive stealing
 # of small tasks
 LATENCY = 0.1
 
@@ -151,30 +157,28 @@
 
     def log(self, msg: Any) -> None:
         return self.scheduler.log_event("stealing", msg)
 
     def add_worker(self, scheduler: Any = None, worker: Any = None) -> None:
         self.stealable[worker] = tuple(set() for _ in range(15))
 
-    def remove_worker(self, scheduler: Scheduler, worker: str) -> None:
+    def remove_worker(self, scheduler: Scheduler, worker: str, **kwargs: Any) -> None:
         del self.stealable[worker]
 
     def teardown(self) -> None:
         pcs = self.scheduler.periodic_callbacks
         if "stealing" in pcs:
             pcs["stealing"].stop()
             del pcs["stealing"]
 
     def transition(
         self,
         key: str,
-        start: str,
-        finish: str,
-        compute_start: Any = None,
-        compute_stop: Any = None,
+        start: TaskStateState,
+        finish: TaskStateState,
         *args: Any,
         **kwargs: Any,
     ) -> None:
         if finish == "processing":
             ts = self.scheduler.tasks[key]
             self.put_key_in_stealable(ts)
         elif start == "processing":
```

### Comparing `distributed-2023.7.0/distributed/system.py` & `distributed-2023.7.1/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/system_monitor.py` & `distributed-2023.7.1/distributed/system_monitor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/threadpoolexecutor.py` & `distributed-2023.7.1/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/utils.py` & `distributed-2023.7.1/distributed/utils.py`

 * *Files 1% similar despite different names*

```diff
@@ -48,14 +48,17 @@
 from typing import Any as AnyType
 from typing import ClassVar, TypeVar, overload
 
 import click
 import psutil
 import tblib.pickling_support
 
+from distributed.compatibility import asyncio_run
+from distributed.config import get_loop_factory
+
 try:
     import resource
 except ImportError:
     resource = None  # type: ignore
 
 import tlz as toolz
 from tornado import gen
@@ -565,15 +568,15 @@
             loop = IOLoop.current()
             start_evt.set()
             await self._stop_event.wait()
 
         def run_loop() -> None:
             nonlocal start_exc
             try:
-                asyncio.run(amain())
+                asyncio_run(amain(), loop_factory=get_loop_factory())
             except BaseException as e:
                 if start_evt.is_set():
                     raise
                 start_exc = e
                 start_evt.set()
 
         self._loop_thread = _CollectErrorThread(
@@ -1918,7 +1921,42 @@
         async with asyncio.timeout(timeout):
             return await fut
 
 else:
 
     async def wait_for(fut: Awaitable[T], timeout: float) -> T:
         return await asyncio.wait_for(fut, timeout)
+
+
+class TupleComparable:
+    """Wrap object so that we can compare tuple, int or None
+
+    When comparing two objects of different types Python fails
+
+    >>> (1, 2) < 1
+    Traceback (most recent call last):
+        ...
+    TypeError: '<' not supported between instances of 'tuple' and 'int'
+
+    This class replaces None with 0, and wraps ints with tuples
+
+    >>> TupleComparable((1, 2)) < TupleComparable(1)
+    False
+    """
+
+    __slots__ = ("obj",)
+
+    def __init__(self, obj):
+        if obj is None:
+            self.obj = (0,)
+        elif isinstance(obj, tuple):
+            self.obj = obj
+        elif isinstance(obj, (int, float)):
+            self.obj = (obj,)
+        else:
+            raise ValueError(f"Object must be tuple, int, float or None, got {obj}")
+
+    def __eq__(self, other):
+        return self.obj == other.obj
+
+    def __lt__(self, other):
+        return self.obj < other.obj
```

### Comparing `distributed-2023.7.0/distributed/utils_comm.py` & `distributed-2023.7.1/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/utils_perf.py` & `distributed-2023.7.1/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/utils_test.py` & `distributed-2023.7.1/distributed/utils_test.py`

 * *Files 0% similar despite different names*

```diff
@@ -39,16 +39,16 @@
 
 from distributed import Event, Scheduler, system
 from distributed import versions as version_module
 from distributed.batched import BatchedSend
 from distributed.client import Client, _global_clients, default_client
 from distributed.comm import Comm
 from distributed.comm.tcp import TCP
-from distributed.compatibility import MACOS, WINDOWS
-from distributed.config import initialize_logging
+from distributed.compatibility import MACOS, WINDOWS, asyncio_run
+from distributed.config import get_loop_factory, initialize_logging
 from distributed.core import (
     CommClosedError,
     ConnectionPool,
     Status,
     clean_exception,
     connect,
     rpc,
@@ -371,15 +371,15 @@
 
     async def inner_fn():
         nonlocal tornado_loop
         tornado_loop = IOLoop.current()
         return await async_fn(*args, **kwargs)
 
     try:
-        return asyncio.run(inner_fn())
+        return asyncio_run(inner_fn(), loop_factory=get_loop_factory())
     finally:
         tornado_loop.close(all_fds=True)
 
 
 def run_scheduler(q, nputs, config, port=0, **kwargs):
     with config_for_cluster_tests(**config):
```

### Comparing `distributed-2023.7.0/distributed/variable.py` & `distributed-2023.7.1/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/versions.py` & `distributed-2023.7.1/distributed/versions.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/client.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/cluster.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/computation.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/future.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/has_what.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/log.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/process_interface.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2023.7.1/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/worker.py` & `distributed-2023.7.1/distributed/worker.py`

 * *Files 1% similar despite different names*

```diff
@@ -87,15 +87,14 @@
 from distributed.metrics import context_meter, thread_time, time
 from distributed.node import ServerNode
 from distributed.proctitle import setproctitle
 from distributed.protocol import pickle, to_serialize
 from distributed.protocol.serialize import _is_dumpable
 from distributed.pubsub import PubSubWorkerExtension
 from distributed.security import Security
-from distributed.shuffle import ShuffleWorkerExtension
 from distributed.sizeof import safe_sizeof as sizeof
 from distributed.spans import SpansWorkerExtension
 from distributed.threadpoolexecutor import ThreadPoolExecutor
 from distributed.threadpoolexecutor import secede as tpe_secede
 from distributed.utils import (
     TimeoutError,
     _maybe_complex,
@@ -168,15 +167,14 @@
 
 logger = logging.getLogger(__name__)
 
 LOG_PDB = dask.config.get("distributed.admin.pdb-on-err")
 
 DEFAULT_EXTENSIONS: dict[str, type] = {
     "pubsub": PubSubWorkerExtension,
-    "shuffle": ShuffleWorkerExtension,
     "spans": SpansWorkerExtension,
 }
 
 DEFAULT_METRICS: dict[str, Callable[[Worker], Any]] = {}
 
 DEFAULT_STARTUP_INFORMATION: dict[str, Callable[[Worker], Any]] = {}
 
@@ -2079,27 +2077,32 @@
             return GatherDepSuccessEvent(
                 worker=worker,
                 total_nbytes=total_nbytes,
                 data=response["data"],
                 stimulus_id=f"gather-dep-success-{time()}",
             )
 
-        except OSError:
+        # Note: CancelledError and asyncio.TimeoutError are rare conditions
+        # that can be raised by the network stack.
+        # See https://github.com/dask/distributed/issues/8006
+        except (OSError, asyncio.CancelledError, asyncio.TimeoutError):
             logger.exception("Worker stream died during communication: %s", worker)
             self.state.log.append(
                 ("gather-dep-failed", worker, to_gather, stimulus_id, time())
             )
             return GatherDepNetworkFailureEvent(
                 worker=worker,
                 total_nbytes=total_nbytes,
                 stimulus_id=f"gather-dep-network-failure-{time()}",
             )
 
         except Exception as e:
             # e.g. data failed to deserialize
+            # FIXME this will deadlock the cluster
+            #       https://github.com/dask/distributed/issues/6705
             logger.exception(e)
             self.state.log.append(
                 ("gather-dep-failed", worker, to_gather, stimulus_id, time())
             )
 
             if self.batched_stream and LOG_PDB:
                 import pdb
```

### Comparing `distributed-2023.7.0/distributed/worker_client.py` & `distributed-2023.7.1/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/worker_memory.py` & `distributed-2023.7.1/distributed/worker_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed/worker_state_machine.py` & `distributed-2023.7.1/distributed/worker_state_machine.py`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/distributed.egg-info/PKG-INFO` & `distributed-2023.7.1/distributed.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2023.7.0
+Version: 2023.7.1
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
```

### Comparing `distributed-2023.7.0/distributed.egg-info/SOURCES.txt` & `distributed-2023.7.1/distributed.egg-info/SOURCES.txt`

 * *Files 0% similar despite different names*

```diff
@@ -199,17 +199,17 @@
 distributed/shuffle/_arrow.py
 distributed/shuffle/_buffer.py
 distributed/shuffle/_comms.py
 distributed/shuffle/_disk.py
 distributed/shuffle/_limiter.py
 distributed/shuffle/_merge.py
 distributed/shuffle/_rechunk.py
-distributed/shuffle/_scheduler_extension.py
+distributed/shuffle/_scheduler_plugin.py
 distributed/shuffle/_shuffle.py
-distributed/shuffle/_worker_extension.py
+distributed/shuffle/_worker_plugin.py
 distributed/widgets/__init__.py
 distributed/widgets/templates/__init__.py
 distributed/widgets/templates/client.html.j2
 distributed/widgets/templates/cluster.html.j2
 distributed/widgets/templates/computation.html.j2
 distributed/widgets/templates/future.html.j2
 distributed/widgets/templates/has_what.html.j2
```

### Comparing `distributed-2023.7.0/docs/source/active_memory_manager.rst` & `distributed-2023.7.1/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/actors.rst` & `distributed-2023.7.1/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/api.rst` & `distributed-2023.7.1/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/asynchronous.rst` & `distributed-2023.7.1/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/changelog.rst` & `distributed-2023.7.1/docs/source/changelog.rst`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,47 @@
 Changelog
 =========
 
+.. _v2023.7.1:
+
+2023.7.1
+--------
+
+Released on July 20, 2023
+
+Enhancements
+^^^^^^^^^^^^
+- ``gather_dep`` should handle ``CancelledError`` (:pr:`8013`) `crusaderky`_
+- Pass ``stimulus_id`` to ``SchedulerPlugin.remove_worker`` and ``SchedulerPlugin.transition`` (:pr:`7974`) `Hendrik Makait`_
+- Log ``stimulus_id`` in ``retire_worker`` (:pr:`8003`) `crusaderky`_
+- Use ``BufferOutputStream`` in P2P (:pr:`7991`) `Florian Jetter`_
+- Add Coiled to ignored modules for code sniffing (:pr:`7986`) `Matthew Rocklin`_
+- Progress bar can group tasks by span (:pr:`7952`) `Irina Truong`_
+- Improved error messages for P2P shuffling (:pr:`7979`) `Hendrik Makait`_
+- Reduce removing comms log to debug level (:pr:`7972`) `Florian Jetter`_
+
+Bug Fixes
+^^^^^^^^^
+- Fix for ``TypeError: '<' not supported`` in graph dashboard (:pr:`8017`) `Irina Truong`_
+- Fix shuffle code to work with ``pyarrow`` 13 (:pr:`8009`) `Joris Van den Bossche`_
+
+Documentation
+^^^^^^^^^^^^^
+- Add some top-level exposition to the p2p rechunking code (:pr:`7978`) `Lawrence Mitchell`_
+
+Maintenance
+^^^^^^^^^^^
+- Add test when not ``repartitioning`` for ``p2p`` in ``set_index`` (:pr:`8016`) `Patrick Hoefler`_
+- Bump ``JamesIves/github-pages-deploy-action`` from 4.4.2 to 4.4.3 (:pr:`8008`)
+- Configure asyncio loop using ``loop_factory`` kwarg rather than using the ``set_event_loop_policy`` (:pr:`7969`) `Thomas Grainger`_
+- Fix P2P worker cleanup (:pr:`7981`) `Hendrik Makait`_
+- Skip ``click`` v8.1.4 in mypy ``pre-commit`` hook (:pr:`7989`) `Thomas Grainger`_
+- Remove accidental duplicated conversion of ``pyarrow`` ``Table`` to pandas (:pr:`7983`) `Joris Van den Bossche`_
+
+
 .. _v2023.7.0:
 
 2023.7.0
 --------
 
 Released on July 7, 2023
 
@@ -5102,7 +5139,8 @@
 .. _`Nicholas R. Knezek`: https://github.com/nknezek
 .. _`antonymayi`: https://github.com/antonymayi
 .. _`Miles`: https://github.com/milesgranger
 .. _`Eugene Druzhynin`: https://github.com/eugene-graft
 .. _`ypogorelova`: https://github.com/ypogorelova
 .. _`Patrick Hoefler`: https://github.com/phofl
 .. _`Irina Truong`: https://github.com/j-bennet
+.. _`Joris Van den Bossche`: https://github.com/jorisvandenbossche
```

### Comparing `distributed-2023.7.0/docs/source/client.rst` & `distributed-2023.7.1/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/communications.rst` & `distributed-2023.7.1/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/develop.rst` & `distributed-2023.7.1/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/diagnosing-performance.rst` & `distributed-2023.7.1/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/efficiency.rst` & `distributed-2023.7.1/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/examples/word-count.rst` & `distributed-2023.7.1/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/faq.rst` & `distributed-2023.7.1/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/fine-performance-metrics.rst` & `distributed-2023.7.1/docs/source/fine-performance-metrics.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/foundations.rst` & `distributed-2023.7.1/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/http_services.rst` & `distributed-2023.7.1/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/index.rst` & `distributed-2023.7.1/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/install.rst` & `distributed-2023.7.1/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/journey.rst` & `distributed-2023.7.1/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/killed.rst` & `distributed-2023.7.1/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/limitations.rst` & `distributed-2023.7.1/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/locality.rst` & `distributed-2023.7.1/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/logging.rst` & `distributed-2023.7.1/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/manage-computation.rst` & `distributed-2023.7.1/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/memory.rst` & `distributed-2023.7.1/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/plugins.rst` & `distributed-2023.7.1/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/priority.rst` & `distributed-2023.7.1/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/prometheus.rst` & `distributed-2023.7.1/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/protocol.rst` & `distributed-2023.7.1/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/publish.rst` & `distributed-2023.7.1/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/quickstart.rst` & `distributed-2023.7.1/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/related-work.rst` & `distributed-2023.7.1/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/resilience.rst` & `distributed-2023.7.1/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/resources.rst` & `distributed-2023.7.1/docs/source/resources.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/scheduling-policies.rst` & `distributed-2023.7.1/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/scheduling-state.rst` & `distributed-2023.7.1/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/serialization.rst` & `distributed-2023.7.1/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/spans.rst` & `distributed-2023.7.1/docs/source/spans.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/task-launch.rst` & `distributed-2023.7.1/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/tls.rst` & `distributed-2023.7.1/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/work-stealing.rst` & `distributed-2023.7.1/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/worker-memory.rst` & `distributed-2023.7.1/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/worker-state.rst` & `distributed-2023.7.1/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/docs/source/worker.rst` & `distributed-2023.7.1/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2023.7.0/pyproject.toml` & `distributed-2023.7.1/pyproject.toml`

 * *Files 0% similar despite different names*

```diff
@@ -23,15 +23,15 @@
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
 requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2023.7.0",
+    "dask == 2023.7.1",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
     "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
```

